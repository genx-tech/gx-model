{"version":3,"sources":["../../src/utils/helpers.js"],"names":["path","require","_","eachAsync_","fs","exports","throwIfFileNotExist","name","filePath","existsSync","Error","getSchemaConnectors","app","schemas","mapValues","schemaConfig","connector","getService","dataSource","getDateNamedDir","baseDir","prefix","override","now","Date","folder","getFullYear","getMonth","getDate","outputDir","join","num","folder2","toString","importDataFilesByList","migrator","dataSetPath","dataListFile","ignoreDuplicate","dataList","readFileSync","match","line","trim","length","dataFile","load_","importDataFiles","folderName","dbScriptPath","runtimeDataSetPath","stageDataSetFile","imported","process","env","STAGE_ENV","log"],"mappings":"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","sourcesContent":["const path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\n\nexports.throwIfFileNotExist = (name, filePath) => {\n    if (!fs.existsSync(filePath)) {\n        throw new Error(`Path [${name}=\"${filePath}\"] not exist.`);\n    }\n}\n\nexports.getSchemaConnectors = (app, schemas) => _.mapValues(schemas, (schemaConfig, name) => {\n    let connector = app.getService(schemaConfig.dataSource);\n    if (!connector) {\n        throw new Error(`Connector service not found for data source [${schemaConfig.dataSource}] of schema \"${name}\".`);\n    } \n    return connector;\n});\n\n/**\n * Get default reverse output path.\n * @param {string} prefix \n * @param {bool} override \n * @returns {string} Output path of oolong generated files.\n */\nexports.getDateNamedDir = (baseDir, prefix, override) => {\n    let now = new Date();\n\n    (prefix == null) && (prefix = '');\n\n    let folder = `${prefix}${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;\n    let outputDir = path.join(baseDir, folder);\n\n    if (override) return outputDir;\n\n    let num = 1;\n\n    while (fs.existsSync(outputDir)) {\n        let folder2 = folder + '_' + (++num).toString();\n        outputDir = path.join(baseDir, folder2);\n    }\n\n    return outputDir;\n};\n\nasync function importDataFilesByList(migrator, dataSetPath, dataListFile, ignoreDuplicate) {\n    let dataList = fs.readFileSync(dataListFile).toString().match(/^.+$/gm);\n\n    if (!dataList) {\n        return;\n    }\n\n    return eachAsync_(dataList, async line => {\n        line = line.trim();\n\n        if (line.length > 0 && line[0] !== '#') {            \n            let dataFile = path.join(dataSetPath, line);\n            if (!fs.existsSync(dataFile)) {\n                throw new Error(`Data file \"${dataFile}\" not found.`);\n            }\n\n            await migrator.load_(dataFile, ignoreDuplicate);\n        }\n    }); \n}\n\nexports.importDataFiles = async function (migrator, folderName, ignoreDuplicate) {\n    let dataSetPath = path.join(migrator.dbScriptPath, 'data', folderName);\n    if (!fs.existsSync(dataSetPath)) return;\n\n    let dataListFile = path.join(dataSetPath, 'index.list');\n\n    let runtimeDataSetPath, stageDataSetFile, imported = false;    \n\n    if (process.env.STAGE_ENV) {\n        runtimeDataSetPath = path.join(dataSetPath, process.env.STAGE_ENV);        \n        stageDataSetFile = path.join(runtimeDataSetPath, 'index.list');\n    }    \n\n    if (fs.existsSync(dataListFile)) {\n        await importDataFilesByList(migrator, dataSetPath, dataListFile, ignoreDuplicate);      \n        imported = true;  \n    } else {\n        migrator.app.log('warn', `Dataset index file \"${dataListFile}\" not exist.`)\n    }\n    \n    if (stageDataSetFile && fs.existsSync(stageDataSetFile)) {\n        await importDataFilesByList(migrator, runtimeDataSetPath, stageDataSetFile, ignoreDuplicate);    \n        imported = true;      \n    } else if (process.env.STAGE_ENV) {\n        migrator.app.log(imported ? 'info' : 'warn', `Dataset index file of \"${process.env.STAGE_ENV}\" stage env \"${stageDataSetFile}\" not exist.`)\n    }\n    \n    if (!imported) {\n        throw new Error(`Entry file of dataset \"${folderName}\" not found.`);\n    }    \n }"],"file":"helpers.js"}
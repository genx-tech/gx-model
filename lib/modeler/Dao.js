"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  pascalCase,
  replaceAll,
  putIntoBucket
} = require('rk-utils');

const swig = require('swig-templates');

const GemlTypes = require('../lang/GemlTypes');

const JsLang = require('./util/ast.js');

const GemlToAst = require('./util/gemlToAst.js');

const Snippets = require('./dao/snippets');

const ChainableType = [GemlToAst.AST_BLK_VALIDATOR_CALL, GemlToAst.AST_BLK_PROCESSOR_CALL, GemlToAst.AST_BLK_ACTIVATOR_CALL];

const getFieldName = t => t.split('.').pop();

const isChainable = (current, next) => ChainableType.indexOf(current.type) > -1 && current.target === next.target && next.type === current.type;

const chainCall = (lastBlock, lastType, currentBlock, currentType) => {
  if (lastBlock) {
    if (lastType === 'ValidatorCall') {
      currentBlock = JsLang.astBinExp(lastBlock, '&&', currentBlock);
    } else {
      currentBlock.arguments[0] = lastBlock;
    }
  }

  return currentBlock;
};

const asyncMethodNaming = name => name + '_';

const indentLines = (lines, indentation) => lines.split('\n').map((line, i) => i === 0 ? line : _.repeat(' ', indentation) + line).join('\n');

const OOL_MODIFIER_RETURN = {
  [GemlTypes.Modifier.VALIDATOR]: () => [JsLang.astReturn(true)],
  [GemlTypes.Modifier.PROCESSOR]: args => [JsLang.astReturn(JsLang.astId(args[0]))],
  [GemlTypes.Modifier.ACTIVATOR]: () => [JsLang.astReturn(JsLang.astId("undefined"))]
};

class DaoModeler {
  constructor(context, linker, connector) {
    this.linker = linker;
    this.outputPath = context.modelPath;
    this.manifestPath = context.manifestPath;
    this.connector = connector;
  }

  modeling_(schema) {
    this.linker.log('info', 'Generating entity models for schema "' + schema.name + '"...');

    this._generateSchemaModel(schema);

    this._generateEntityModel(schema);

    if (this.manifestPath) {
      this._generateEntityManifest(schema);
    }
  }

  _generateSchemaModel(schema) {
    let capitalized = pascalCase(schema.name);
    let locals = {
      driver: this.connector.driver,
      className: capitalized,
      schemaName: schema.name,
      entities: JSON.stringify(Object.keys(schema.entities))
    };
    let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'Database.js.swig');
    let classCode = swig.renderFile(classTemplate, locals);
    let modelFilePath = path.resolve(this.outputPath, capitalized + '.js');
    fs.ensureFileSync(modelFilePath);
    fs.writeFileSync(modelFilePath, classCode);
    this.linker.log('info', 'Generated database model: ' + modelFilePath);
  }

  _generateEnumTypes(schema) {
    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      _.forOwn(entity.fields, (field, fieldName) => {
        if (field.type === 'enum') {}
      });
    });
  }

  _generateEntityModel(schema) {
    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      let capitalized = pascalCase(entityInstanceName);
      let sharedContext = {
        mapOfFunctorToFile: {},
        newFunctorFiles: []
      };

      let {
        ast: astClassMain,
        fieldReferences
      } = this._processFieldModifiers(entity, sharedContext);

      astClassMain = [astClassMain];
      let uniqueKeys = [_.castArray(entity.key)];

      if (entity.indexes) {
        entity.indexes.forEach(index => {
          if (index.unique) {
            uniqueKeys.push(index.fields);
          }
        });
      }

      let modelMeta = {
        schemaName: schema.name,
        name: entityInstanceName,
        keyField: entity.key,
        fields: _.mapValues(entity.fields, f => _.omit(f.toJSON(), 'modifiers')),
        features: entity.features || {},
        uniqueKeys
      };

      if (entity.baseClasses) {
        modelMeta.baseClasses = entity.baseClasses;
      }

      if (!_.isEmpty(entity.indexes)) {
        modelMeta.indexes = entity.indexes;
      }

      if (!_.isEmpty(entity.features)) {
        modelMeta.features = entity.features;
      }

      if (!_.isEmpty(entity.associations)) {
        modelMeta.associations = entity.associations;
      }

      if (!_.isEmpty(fieldReferences)) {
        modelMeta.fieldDependencies = fieldReferences;
      }

      if (entity.interfaces) {
        let astInterfaces = this._buildInterfaces(entity, modelMeta, sharedContext);

        astClassMain = astClassMain.concat(astInterfaces);
      }

      let importLines = [];

      if (!_.isEmpty(sharedContext.mapOfFunctorToFile)) {
        _.forOwn(sharedContext.mapOfFunctorToFile, (fileName, functionName) => {
          importLines.push(JsLang.astToCode(JsLang.astRequire(functionName, '.' + fileName)));
        });
      }

      if (!_.isEmpty(sharedContext.newFunctorFiles)) {
        _.each(sharedContext.newFunctorFiles, entry => {
          this._generateFunctionTemplateFile(schema, entry);
        });
      }

      let locals = {
        imports: importLines.join('\n'),
        className: capitalized,
        entityMeta: indentLines(JSON.stringify(modelMeta, null, 4), 4),
        classBody: indentLines(astClassMain.map(block => JsLang.astToCode(block)).join('\n\n'), 8),
        functors: indentLines(JsLang.astToCode(JsLang.astValue(_.reduce(sharedContext.newFunctorFiles, (result, functor) => {
          result['$' + functor.functionName] = JsLang.astId(functor.functionName);
          return result;
        }, {}))), 4)
      };
      let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'EntityModel.js.swig');
      let classCode = swig.renderFile(classTemplate, locals);
      let modelFilePath = path.resolve(this.outputPath, schema.name, 'base', capitalized + '.js');
      fs.ensureFileSync(modelFilePath);
      fs.writeFileSync(modelFilePath, classCode);
      this.linker.log('info', 'Generated entity model: ' + modelFilePath);
    });
  }

  _generateEntityManifest(schema) {
    let entities = Object.keys(schema.entities).sort().reduce((result, v) => {
      result[v] = {};
      return result;
    }, {});

    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      let validationSchema = {};

      _.forOwn(entity.fields, (field, fieldName) => {
        let fieldSchema = {
          type: field.type
        };

        if (field.type === 'enum') {
          fieldSchema.values = field.values;
        }

        if (field.optional) {
          fieldSchema.optional = true;
        }

        validationSchema[fieldName] = fieldSchema;
      });

      let entityOutputFilePath = path.resolve(this.manifestPath, schema.name, 'validation', entityInstanceName + '.manifest.json');
      fs.ensureFileSync(entityOutputFilePath);
      fs.writeFileSync(entityOutputFilePath, JSON.stringify(validationSchema, null, 4));
      this.linker.log('info', 'Generated entity manifest: ' + entityOutputFilePath);
    });
  }

  _processFieldModifiers(entity, sharedContext) {
    let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);
    compileContext.variables['raw'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['i18n'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['connector'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['latest'] = {
      source: 'context'
    };
    const allFinished = GemlToAst.createTopoId(compileContext, 'done.');
    let fieldReferences = {};

    _.forOwn(entity.fields, (field, fieldName) => {
      let topoId = GemlToAst.compileField(fieldName, field, compileContext);
      GemlToAst.dependsOn(compileContext, topoId, allFinished);

      if (field.writeOnce || field.freezeAfterNonDefault) {
        putIntoBucket(fieldReferences, fieldName, {
          reference: fieldName,
          writeProtect: true
        });
      }
    });

    let deps = compileContext.topoSort.sort();
    deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));
    let methodBodyValidateAndFill = [],
        lastFieldsGroup,
        methodBodyCache = [],
        lastBlock,
        lastAstType;

    const _mergeDoValidateAndFillCode = function (fieldName, references, astCache, requireTargetField) {
      let fields = [fieldName].concat(references);
      let checker = fields.join(',');

      if (lastFieldsGroup && lastFieldsGroup.checker !== checker) {
        methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
        methodBodyCache = [];
      }

      methodBodyCache = methodBodyCache.concat(astCache);
      lastFieldsGroup = {
        fieldName,
        references,
        requireTargetField,
        checker
      };
    };

    _.each(deps, (dep, i) => {
      let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
      let astBlock = compileContext.astMap[dep];
      let targetFieldName = getFieldName(sourceMap.target);

      if (sourceMap.references && sourceMap.references.length > 0) {
        let fieldReference = fieldReferences[targetFieldName];

        if (!fieldReference) {
          fieldReferences[targetFieldName] = fieldReference = [];
        }

        if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {
          sourceMap.references.forEach(ref => {
            fieldReference.push({
              reference: ref,
              whenNull: true
            });
          });
        } else {
          sourceMap.references.forEach(ref => {
            if (fieldReference.indexOf(ref) === -1) fieldReference.push(ref);
          });
        }
      }

      if (lastBlock) {
        astBlock = chainCall(lastBlock, lastAstType, astBlock, sourceMap.type);
        lastBlock = undefined;
      }

      if (i < deps.length - 1) {
        let nextType = compileContext.mapOfTokenToMeta.get(deps[i + 1]);

        if (isChainable(sourceMap, nextType)) {
          lastBlock = astBlock;
          lastAstType = sourceMap.type;
          return;
        }
      }

      if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {
        let astCache = Snippets._validateCheck(targetFieldName, astBlock);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {
        let astCache = Snippets._checkAndAssign(astBlock, JsLang.astVarRef(sourceMap.target, true), `Activating "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, false);
      } else {
        throw new Error('To be implemented.');
      }
    });

    if (!_.isEmpty(methodBodyCache)) {
      methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
    }

    return {
      ast: JsLang.astMemberMethod(asyncMethodNaming('applyModifiers'), ['context', 'isUpdating'], Snippets._applyModifiersHeader.concat(methodBodyValidateAndFill).concat([JsLang.astReturn(JsLang.astId('context'))]), false, true, true, 'Applying predefined modifiers to entity fields.'),
      fieldReferences
    };
  }

  _generateFunctionTemplateFile(schema, {
    functionName,
    functorType,
    fileName,
    args
  }) {
    let filePath = path.resolve(this.outputPath, schema.name, fileName);

    if (fs.existsSync(filePath)) {
      this.linker.log('info', `${_.upperFirst(functorType)} "${fileName}" exists. File generating skipped.`);
      return;
    }

    let ast = JsLang.astProgram();
    JsLang.astPushInBody(ast, JsLang.astFunction(functionName, args, OOL_MODIFIER_RETURN[functorType](args)));
    JsLang.astPushInBody(ast, JsLang.astAssign('module.exports', JsLang.astVarRef(functionName)));
    fs.ensureFileSync(filePath);
    fs.writeFileSync(filePath, JsLang.astToCode(ast));
    this.linker.log('info', `Generated ${functorType} file: ${filePath}`);
  }

  _buildInterfaces(entity, modelMetaInit, sharedContext) {
    let ast = [];

    _.forOwn(entity.interfaces, (method, name) => {
      this.linker.info('Building interface: ' + name);
      let astBody = [JsLang.astVarDeclare('$meta', JsLang.astVarRef('this.meta.interfaces.' + name), true, false, 'Retrieving the meta data')];
      let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);
      let paramMeta;

      if (method.accept) {
        paramMeta = this._processParams(method.accept, compileContext);
      }

      modelMetaInit['interfaces'] || (modelMetaInit['interfaces'] = {});
      modelMetaInit['interfaces'][name] = {
        params: Object.values(paramMeta)
      };

      _.each(method.implementation, (operation, index) => {
        GemlToAst.compileDbOperation(index, operation, compileContext, compileContext.mainStartId);
      });

      if (method.return) {
        GemlToAst.compileExceptionalReturn(method.return, compileContext);
      }

      let deps = compileContext.topoSort.sort();
      deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));

      _.each(deps, dep => {
        let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
        let astBlock = compileContext.astMap[dep];
        let targetFieldName = sourceMap.target;

        if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {
          astBlock = Snippets._validateCheck(targetFieldName, astBlock);
        } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);
          }
        } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);
          }
        }

        astBody = astBody.concat(_.castArray(astBlock));
      });

      ast.push(JsLang.astMemberMethod(asyncMethodNaming(name), Object.keys(paramMeta), astBody, false, true, true, replaceAll(_.kebabCase(name), '-', ' ')));
    });

    return ast;
  }

  _processParams(acceptParams, compileContext) {
    let paramMeta = {};
    acceptParams.forEach((param, i) => {
      GemlToAst.compileParam(i, param, compileContext);
      paramMeta[param.name] = param;
      compileContext.variables[param.name] = {
        source: 'argument'
      };
    });
    return paramMeta;
  }

}

module.exports = DaoModeler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlbGVyL0Rhby5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsInBhc2NhbENhc2UiLCJyZXBsYWNlQWxsIiwicHV0SW50b0J1Y2tldCIsInN3aWciLCJHZW1sVHlwZXMiLCJKc0xhbmciLCJHZW1sVG9Bc3QiLCJTbmlwcGV0cyIsIkNoYWluYWJsZVR5cGUiLCJBU1RfQkxLX1ZBTElEQVRPUl9DQUxMIiwiQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCIsIkFTVF9CTEtfQUNUSVZBVE9SX0NBTEwiLCJnZXRGaWVsZE5hbWUiLCJ0Iiwic3BsaXQiLCJwb3AiLCJpc0NoYWluYWJsZSIsImN1cnJlbnQiLCJuZXh0IiwiaW5kZXhPZiIsInR5cGUiLCJ0YXJnZXQiLCJjaGFpbkNhbGwiLCJsYXN0QmxvY2siLCJsYXN0VHlwZSIsImN1cnJlbnRCbG9jayIsImN1cnJlbnRUeXBlIiwiYXN0QmluRXhwIiwiYXJndW1lbnRzIiwiYXN5bmNNZXRob2ROYW1pbmciLCJuYW1lIiwiaW5kZW50TGluZXMiLCJsaW5lcyIsImluZGVudGF0aW9uIiwibWFwIiwibGluZSIsImkiLCJyZXBlYXQiLCJqb2luIiwiT09MX01PRElGSUVSX1JFVFVSTiIsIk1vZGlmaWVyIiwiVkFMSURBVE9SIiwiYXN0UmV0dXJuIiwiUFJPQ0VTU09SIiwiYXJncyIsImFzdElkIiwiQUNUSVZBVE9SIiwiRGFvTW9kZWxlciIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImxpbmtlciIsImNvbm5lY3RvciIsIm91dHB1dFBhdGgiLCJtb2RlbFBhdGgiLCJtYW5pZmVzdFBhdGgiLCJtb2RlbGluZ18iLCJzY2hlbWEiLCJsb2ciLCJfZ2VuZXJhdGVTY2hlbWFNb2RlbCIsIl9nZW5lcmF0ZUVudGl0eU1vZGVsIiwiX2dlbmVyYXRlRW50aXR5TWFuaWZlc3QiLCJjYXBpdGFsaXplZCIsImxvY2FscyIsImRyaXZlciIsImNsYXNzTmFtZSIsInNjaGVtYU5hbWUiLCJlbnRpdGllcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJPYmplY3QiLCJrZXlzIiwiY2xhc3NUZW1wbGF0ZSIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJjbGFzc0NvZGUiLCJyZW5kZXJGaWxlIiwibW9kZWxGaWxlUGF0aCIsImVuc3VyZUZpbGVTeW5jIiwid3JpdGVGaWxlU3luYyIsIl9nZW5lcmF0ZUVudW1UeXBlcyIsImZvck93biIsImVudGl0eSIsImVudGl0eUluc3RhbmNlTmFtZSIsImZpZWxkcyIsImZpZWxkIiwiZmllbGROYW1lIiwic2hhcmVkQ29udGV4dCIsIm1hcE9mRnVuY3RvclRvRmlsZSIsIm5ld0Z1bmN0b3JGaWxlcyIsImFzdCIsImFzdENsYXNzTWFpbiIsImZpZWxkUmVmZXJlbmNlcyIsIl9wcm9jZXNzRmllbGRNb2RpZmllcnMiLCJ1bmlxdWVLZXlzIiwiY2FzdEFycmF5Iiwia2V5IiwiaW5kZXhlcyIsImZvckVhY2giLCJpbmRleCIsInVuaXF1ZSIsInB1c2giLCJtb2RlbE1ldGEiLCJrZXlGaWVsZCIsIm1hcFZhbHVlcyIsImYiLCJvbWl0IiwidG9KU09OIiwiZmVhdHVyZXMiLCJiYXNlQ2xhc3NlcyIsImlzRW1wdHkiLCJhc3NvY2lhdGlvbnMiLCJmaWVsZERlcGVuZGVuY2llcyIsImludGVyZmFjZXMiLCJhc3RJbnRlcmZhY2VzIiwiX2J1aWxkSW50ZXJmYWNlcyIsImNvbmNhdCIsImltcG9ydExpbmVzIiwiZmlsZU5hbWUiLCJmdW5jdGlvbk5hbWUiLCJhc3RUb0NvZGUiLCJhc3RSZXF1aXJlIiwiZWFjaCIsImVudHJ5IiwiX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUiLCJpbXBvcnRzIiwiZW50aXR5TWV0YSIsImNsYXNzQm9keSIsImJsb2NrIiwiZnVuY3RvcnMiLCJhc3RWYWx1ZSIsInJlZHVjZSIsInJlc3VsdCIsImZ1bmN0b3IiLCJzb3J0IiwidiIsInZhbGlkYXRpb25TY2hlbWEiLCJmaWVsZFNjaGVtYSIsInZhbHVlcyIsIm9wdGlvbmFsIiwiZW50aXR5T3V0cHV0RmlsZVBhdGgiLCJjb21waWxlQ29udGV4dCIsImNyZWF0ZUNvbXBpbGVDb250ZXh0IiwiZ2VtbE1vZHVsZSIsInZhcmlhYmxlcyIsInNvdXJjZSIsImZpbmFsaXplZCIsImFsbEZpbmlzaGVkIiwiY3JlYXRlVG9wb0lkIiwidG9wb0lkIiwiY29tcGlsZUZpZWxkIiwiZGVwZW5kc09uIiwid3JpdGVPbmNlIiwiZnJlZXplQWZ0ZXJOb25EZWZhdWx0IiwicmVmZXJlbmNlIiwid3JpdGVQcm90ZWN0IiwiZGVwcyIsInRvcG9Tb3J0IiwiZmlsdGVyIiwiZGVwIiwibWFwT2ZUb2tlblRvTWV0YSIsImhhcyIsIm1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwiLCJsYXN0RmllbGRzR3JvdXAiLCJtZXRob2RCb2R5Q2FjaGUiLCJsYXN0QXN0VHlwZSIsIl9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSIsInJlZmVyZW5jZXMiLCJhc3RDYWNoZSIsInJlcXVpcmVUYXJnZXRGaWVsZCIsImNoZWNrZXIiLCJfZmllbGRSZXF1aXJlbWVudENoZWNrIiwic291cmNlTWFwIiwiZ2V0IiwiYXN0QmxvY2siLCJhc3RNYXAiLCJ0YXJnZXRGaWVsZE5hbWUiLCJsZW5ndGgiLCJmaWVsZFJlZmVyZW5jZSIsInJlZiIsIndoZW5OdWxsIiwidW5kZWZpbmVkIiwibmV4dFR5cGUiLCJfdmFsaWRhdGVDaGVjayIsImFzdEFzc2lnbiIsImFzdFZhclJlZiIsIl9jaGVja0FuZEFzc2lnbiIsIkVycm9yIiwiYXN0TWVtYmVyTWV0aG9kIiwiX2FwcGx5TW9kaWZpZXJzSGVhZGVyIiwiZnVuY3RvclR5cGUiLCJmaWxlUGF0aCIsImV4aXN0c1N5bmMiLCJ1cHBlckZpcnN0IiwiYXN0UHJvZ3JhbSIsImFzdFB1c2hJbkJvZHkiLCJhc3RGdW5jdGlvbiIsIm1vZGVsTWV0YUluaXQiLCJtZXRob2QiLCJpbmZvIiwiYXN0Qm9keSIsImFzdFZhckRlY2xhcmUiLCJwYXJhbU1ldGEiLCJhY2NlcHQiLCJfcHJvY2Vzc1BhcmFtcyIsInBhcmFtcyIsImltcGxlbWVudGF0aW9uIiwib3BlcmF0aW9uIiwiY29tcGlsZURiT3BlcmF0aW9uIiwibWFpblN0YXJ0SWQiLCJyZXR1cm4iLCJjb21waWxlRXhjZXB0aW9uYWxSZXR1cm4iLCJuZWVkRGVjbGFyZSIsImtlYmFiQ2FzZSIsImFjY2VwdFBhcmFtcyIsInBhcmFtIiwiY29tcGlsZVBhcmFtIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLFVBQVQ7QUFBcUJDLEVBQUFBLFVBQXJCO0FBQWlDQyxFQUFBQTtBQUFqQyxJQUFvREwsT0FBTyxDQUFDLFVBQUQsQ0FBakU7O0FBQ0EsTUFBTU0sSUFBSSxHQUFJTixPQUFPLENBQUMsZ0JBQUQsQ0FBckI7O0FBRUEsTUFBTU8sU0FBUyxHQUFHUCxPQUFPLENBQUMsbUJBQUQsQ0FBekI7O0FBQ0EsTUFBTVEsTUFBTSxHQUFHUixPQUFPLENBQUMsZUFBRCxDQUF0Qjs7QUFDQSxNQUFNUyxTQUFTLEdBQUdULE9BQU8sQ0FBQyxxQkFBRCxDQUF6Qjs7QUFDQSxNQUFNVSxRQUFRLEdBQUdWLE9BQU8sQ0FBQyxnQkFBRCxDQUF4Qjs7QUFFQSxNQUFNVyxhQUFhLEdBQUcsQ0FDbEJGLFNBQVMsQ0FBQ0csc0JBRFEsRUFFbEJILFNBQVMsQ0FBQ0ksc0JBRlEsRUFHbEJKLFNBQVMsQ0FBQ0ssc0JBSFEsQ0FBdEI7O0FBTUEsTUFBTUMsWUFBWSxHQUFHQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsS0FBRixDQUFRLEdBQVIsRUFBYUMsR0FBYixFQUExQjs7QUFDQSxNQUFNQyxXQUFXLEdBQUcsQ0FBQ0MsT0FBRCxFQUFVQyxJQUFWLEtBQW1CVixhQUFhLENBQUNXLE9BQWQsQ0FBc0JGLE9BQU8sQ0FBQ0csSUFBOUIsSUFBc0MsQ0FBQyxDQUF2QyxJQUNoQ0gsT0FBTyxDQUFD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QUN6QyxRQUFJNkQsU0FBUyxHQUFHLEVBQWhCO0FBRUFZLElBQUFBLFlBQVksQ0FBQ3BILE9BQWIsQ0FBcUIsQ0FBQ3FILEtBQUQsRUFBUWxMLENBQVIsS0FBYztBQUMvQjlCLE1BQUFBLFNBQVMsQ0FBQ2lOLFlBQVYsQ0FBdUJuTCxDQUF2QixFQUEwQmtMLEtBQTFCLEVBQWlDMUUsY0FBakM7QUFDQTZELE1BQUFBLFNBQVMsQ0FBQ2EsS0FBSyxDQUFDeEwsSUFBUCxDQUFULEdBQXdCd0wsS0FBeEI7QUFDQTFFLE1BQUFBLGNBQWMsQ0FBQ0csU0FBZixDQUF5QnVFLEtBQUssQ0FBQ3hMLElBQS9CLElBQXVDO0FBQUVrSCxRQUFBQSxNQUFNLEVBQUU7QUFBVixPQUF2QztBQUNILEtBSkQ7QUFNQSxXQUFPeUQsU0FBUDtBQUNIOztBQTFuQlk7O0FBNm5CakJlLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjFLLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBwYXNjYWxDYXNlLCByZXBsYWNlQWxsLCBwdXRJbnRvQnVja2V0IH0gID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHN3aWcgID0gcmVxdWlyZSgnc3dpZy10ZW1wbGF0ZXMnKTtcblxuY29uc3QgR2VtbFR5cGVzID0gcmVxdWlyZSgnLi4vbGFuZy9HZW1sVHlwZXMnKTtcbmNvbnN0IEpzTGFuZyA9IHJlcXVpcmUoJy4vdXRpbC9hc3QuanMnKTtcbmNvbnN0IEdlbWxUb0FzdCA9IHJlcXVpcmUoJy4vdXRpbC9nZW1sVG9Bc3QuanMnKTtcbmNvbnN0IFNuaXBwZXRzID0gcmVxdWlyZSgnLi9kYW8vc25pcHBldHMnKTtcblxuY29uc3QgQ2hhaW5hYmxlVHlwZSA9IFtcbiAgICBHZW1sVG9Bc3QuQVNUX0JMS19WQUxJREFUT1JfQ0FMTCwgXG4gICAgR2VtbFRvQXN0LkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwsXG4gICAgR2VtbFRvQXN0LkFTVF9CTEtfQUNUSVZBVE9SX0NBTExcbl07XG5cbmNvbnN0IGdldEZpZWxkTmFtZSA9IHQgPT4gdC5zcGxpdCgnLicpLnBvcCgpO1xuY29uc3QgaXNDaGFpbmFibGUgPSAoY3VycmVudCwgbmV4dCkgPT4gQ2hhaW5hYmxlVHlwZS5pbmRleE9mKGN1cnJlbnQudHlwZSkgPiAtMVxuICAgICYmIGN1cnJlbnQudGFyZ2V0ID09PSBuZXh0LnRhcmdldFxuICAgICYmIG5leHQudHlwZSA9PT0gY3VycmVudC50eXBlO1xuY29uc3QgY2hhaW5DYWxsID0gKGxhc3RCbG9jaywgbGFzdFR5cGUsIGN1cnJlbnRCbG9jaywgY3VycmVudFR5cGUpID0+IHtcbiAgICBpZiAobGFzdEJsb2NrKSB7XG4gICAgICAgIGlmIChsYXN0VHlwZSA9PT0gJ1ZhbGlkYXRvckNhbGwnKSB7XG4gICAgICAgICAgICBhc3NlcnQ6IGN1cnJlbnRUeXBlID09PSAnVmFsaWRhdG9yQ2FsbCcsICdVbmV4cGVjdGVkIGN1cnJlbnRUeXBlJztcblxuICAgICAgICAgICAgY3VycmVudEJsb2NrID0gSnNMYW5nLmFzdEJpbkV4cChsYXN0QmxvY2ssICcmJicsIGN1cnJlbnRCbG9jayk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhc3NlcnQ6IGN1cnJlbnRUeXBlID09PSAnUHJvY2Vzc29yQ2FsbCcsICdVbmV4cGVjdGVkIGN1cnJlbnRUeXBlOiAnICsgY3VycmVudFR5cGUgKyAnIGxhc3Q6ICcgKyBsYXN0VHlwZTtcblxuICAgICAgICAgICAgY3VycmVudEJsb2NrLmFyZ3VtZW50c1swXSA9IGxhc3RCbG9jaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjdXJyZW50QmxvY2s7XG59O1xuY29uc3QgYXN5bmNNZXRob2ROYW1pbmcgPSAobmFtZSkgPT4gbmFtZSArICdfJztcblxuY29uc3QgaW5kZW50TGluZXMgPSAobGluZXMsIGluZGVudGF0aW9uKSA9PiBsaW5lcy5zcGxpdCgnXFxuJykubWFwKChsaW5lLCBpKSA9PiBpID09PSAwID8gbGluZSA6IChfLnJlcGVhdCgnICcsIGluZGVudGF0aW9uKSArIGxpbmUpKS5qb2luKCdcXG4nKTtcblxuY29uc3QgT09MX01PRElGSUVSX1JFVFVSTiA9IHtcbiAgICBbR2VtbFR5cGVzLk1vZGlmaWVyLlZBTElEQVRPUl06ICgpID0+IFsgSnNMYW5nLmFzdFJldHVybih0cnVlKSBdLFxuICAgIFtHZW1sVHlwZXMuTW9kaWZpZXIuUFJPQ0VTU09SXTogYXJncyA9PiBbIEpzTGFuZy5hc3RSZXR1cm4oSnNMYW5nLmFzdElkKGFyZ3NbMF0pKSBdLFxuICAgIFtHZW1sVHlwZXMuTW9kaWZpZXIuQUNUSVZBVE9SXTogKCkgPT4gWyBKc0xhbmcuYXN0UmV0dXJuKEpzTGFuZy5hc3RJZChcInVuZGVmaW5lZFwiKSkgXVxufTtcblxuLyoqXG4gKiBPb2xvbmcgZGF0YWJhc2UgYWNjZXNzIG9iamVjdCAoREFPKSBtb2RlbGVyLlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIERhb01vZGVsZXIge1xuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHQgICBcbiAgICAgKiBAcHJvcGVydHkge0dlbWxMaW5rZXJ9IGNvbnRleHQubGlua2VyIC0gR2VtbCBsaW5rZXJcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5tb2RlbFBhdGggLSBHZW5lcmF0ZWQgbW9kZWwgb3V0cHV0IHBhdGhcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5tYW5pZmVzdFBhdGggLSBFbnRpdGllcyBtYW5pZmVzdCBvdXRwdXQgcGF0aFxuICAgICAqIEBwYXJhbSB7Q29ubmVjdG9yfSBjb25uZWN0b3IgICAgICBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBsaW5rZXIsIGNvbm5lY3RvcikgeyAgICAgICBcbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG4gICAgICAgIHRoaXMub3V0cHV0UGF0aCA9IGNvbnRleHQubW9kZWxQYXRoO1xuICAgICAgICB0aGlzLm1hbmlmZXN0UGF0aCA9IGNvbnRleHQubWFuaWZlc3RQYXRoO1xuXG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yOyAgICAgICAgXG4gICAgfVxuXG4gICAgbW9kZWxpbmdfKHNjaGVtYSkge1xuICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2luZm8nLCAnR2VuZXJhdGluZyBlbnRpdHkgbW9kZWxzIGZvciBzY2hlbWEgXCInICsgc2NoZW1hLm5hbWUgKyAnXCIuLi4nKTtcblxuICAgICAgICB0aGlzLl9nZW5lcmF0ZVNjaGVtYU1vZGVsKHNjaGVtYSk7ICAgICAgICBcbiAgICAgICAgdGhpcy5fZ2VuZXJhdGVFbnRpdHlNb2RlbChzY2hlbWEpO1xuICAgICAgICAvL3RoaXMuX2dlbmVyYXRlRW51bVR5cGVzKHNjaGVtYSk7XG4gICAgICAgIC8vdGhpcy5fZ2VuZXJhdGVWaWV3TW9kZWwoKTtcblxuICAgICAgICBpZiAodGhpcy5tYW5pZmVzdFBhdGgpIHtcbiAgICAgICAgICAgIHRoaXMuX2dlbmVyYXRlRW50aXR5TWFuaWZlc3Qoc2NoZW1hKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9nZW5lcmF0ZVNjaGVtYU1vZGVsKHNjaGVtYSkge1xuICAgICAgICBsZXQgY2FwaXRhbGl6ZWQgPSBwYXNjYWxDYXNlKHNjaGVtYS5uYW1lKTtcblxuICAgICAgICBsZXQgbG9jYWxzID0ge1xuICAgICAgICAgICAgZHJpdmVyOiB0aGlzLmNvbm5lY3Rvci5kcml2ZXIsXG4gICAgICAgICAgICBjbGFzc05hbWU6IGNhcGl0YWxpemVkLFxuICAgICAgICAgICAgc2NoZW1hTmFtZTogc2NoZW1hLm5hbWUsXG4gICAgICAgICAgICBlbnRpdGllczogSlNPTi5zdHJpbmdpZnkoT2JqZWN0LmtleXMoc2NoZW1hLmVudGl0aWVzKSlcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgY2xhc3NUZW1wbGF0ZSA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdkYXRhYmFzZScsIHRoaXMuY29ubmVjdG9yLmRyaXZlciwgJ0RhdGFiYXNlLmpzLnN3aWcnKTtcbiAgICAgICAgbGV0IGNsYXNzQ29kZSA9IHN3aWcucmVuZGVyRmlsZShjbGFzc1RlbXBsYXRlLCBsb2NhbHMpO1xuXG4gICAgICAgIGxldCBtb2RlbEZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMub3V0cHV0UGF0aCwgY2FwaXRhbGl6ZWQgKyAnLmpzJyk7XG4gICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgsIGNsYXNzQ29kZSk7XG5cbiAgICAgICAgdGhpcy5saW5rZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRlZCBkYXRhYmFzZSBtb2RlbDogJyArIG1vZGVsRmlsZVBhdGgpO1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZUVudW1UeXBlcyhzY2hlbWEpIHtcbiAgICAgICAgXy5mb3JPd24oc2NoZW1hLmVudGl0aWVzLCAoZW50aXR5LCBlbnRpdHlJbnN0YW5jZU5hbWUpID0+IHtcbiAgICAgICAgICAgIF8uZm9yT3duKGVudGl0eS5maWVsZHMsIChmaWVsZCwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkLnR5cGUgPT09ICdlbnVtJykge1xuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZUVudGl0eU1vZGVsKHNjaGVtYSkge1xuICAgICAgICBfLmZvck93bihzY2hlbWEuZW50aXRpZXMsIChlbnRpdHksIGVudGl0eUluc3RhbmNlTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhcGl0YWxpemVkID0gcGFzY2FsQ2FzZShlbnRpdHlJbnN0YW5jZU5hbWUpOyAgICAgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL3NoYXJlZCBpbmZvcm1hdGlvbiB3aXRoIG1vZGVsIENSVUQgYW5kIGN1c3RvbWl6ZWQgaW50ZXJmYWNlc1xuICAgICAgICAgICAgbGV0IHNoYXJlZENvbnRleHQgPSB7XG4gICAgICAgICAgICAgICAgbWFwT2ZGdW5jdG9yVG9GaWxlOiB7fSxcbiAgICAgICAgICAgICAgICBuZXdGdW5jdG9yRmlsZXM6IFtdXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgeyBhc3Q6IGFzdENsYXNzTWFpbiwgZmllbGRSZWZlcmVuY2VzIH0gPSB0aGlzLl9wcm9jZXNzRmllbGRNb2RpZmllcnMoZW50aXR5LCBzaGFyZWRDb250ZXh0KTtcbiAgICAgICAgICAgIGFzdENsYXNzTWFpbiA9IFsgYXN0Q2xhc3NNYWluIF07XG5cbiAgICAgICAgICAgIC8vcHJlcGFyZSBtZXRhIGRhdGFcbiAgICAgICAgICAgIGxldCB1bmlxdWVLZXlzID0gWyBfLmNhc3RBcnJheShlbnRpdHkua2V5KSBdO1xuXG4gICAgICAgICAgICBpZiAoZW50aXR5LmluZGV4ZXMpIHtcbiAgICAgICAgICAgICAgICBlbnRpdHkuaW5kZXhlcy5mb3JFYWNoKGluZGV4ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4LnVuaXF1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdW5pcXVlS2V5cy5wdXNoKGluZGV4LmZpZWxkcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IG1vZGVsTWV0YSA9IHtcbiAgICAgICAgICAgICAgICBzY2hlbWFOYW1lOiBzY2hlbWEubmFtZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBlbnRpdHlJbnN0YW5jZU5hbWUsXG4gICAgICAgICAgICAgICAga2V5RmllbGQ6IGVudGl0eS5rZXksICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGZpZWxkczogXy5tYXBWYWx1ZXMoZW50aXR5LmZpZWxkcywgZiA9PiBfLm9taXQoZi50b0pTT04oKSwgJ21vZGlmaWVycycpKSxcbiAgICAgICAgICAgICAgICBmZWF0dXJlczogZW50aXR5LmZlYXR1cmVzIHx8IHt9LFxuICAgICAgICAgICAgICAgIHVuaXF1ZUtleXNcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChlbnRpdHkuYmFzZUNsYXNzZXMpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuYmFzZUNsYXNzZXMgPSBlbnRpdHkuYmFzZUNsYXNzZXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5pbmRleGVzKSkge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5pbmRleGVzID0gZW50aXR5LmluZGV4ZXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5mZWF0dXJlcykpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuZmVhdHVyZXMgPSBlbnRpdHkuZmVhdHVyZXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5hc3NvY2lhdGlvbnMpKSB7XG4gICAgICAgICAgICAgICAgbW9kZWxNZXRhLmFzc29jaWF0aW9ucyA9IGVudGl0eS5hc3NvY2lhdGlvbnM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGZpZWxkUmVmZXJlbmNlcykpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuZmllbGREZXBlbmRlbmNpZXMgPSBmaWVsZFJlZmVyZW5jZXM7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vYnVpbGQgY3VzdG9taXplZCBpbnRlcmZhY2VzICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZW50aXR5LmludGVyZmFjZXMpIHtcbiAgICAgICAgICAgICAgICBsZXQgYXN0SW50ZXJmYWNlcyA9IHRoaXMuX2J1aWxkSW50ZXJmYWNlcyhlbnRpdHksIG1vZGVsTWV0YSwgc2hhcmVkQ29udGV4dCk7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhhc3RJbnRlcmZhY2VzKTtcbiAgICAgICAgICAgICAgICAvL2xldCBhc3RDbGFzcyA9IGFzdENsYXNzTWFpblthc3RDbGFzc01haW4ubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICAgICAgLy9Kc0xhbmcuYXN0UHVzaEluQm9keShhc3RDbGFzcywgYXN0SW50ZXJmYWNlcyk7XG4gICAgICAgICAgICAgICAgYXN0Q2xhc3NNYWluID0gYXN0Q2xhc3NNYWluLmNvbmNhdChhc3RJbnRlcmZhY2VzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGltcG9ydExpbmVzID0gW107XG5cbiAgICAgICAgICAgIC8vZ2VuZXJhdGUgZnVuY3RvcnMgaWYgYW55XG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShzaGFyZWRDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSkpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihzaGFyZWRDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSwgKGZpbGVOYW1lLCBmdW5jdGlvbk5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0TGluZXMucHVzaChKc0xhbmcuYXN0VG9Db2RlKEpzTGFuZy5hc3RSZXF1aXJlKGZ1bmN0aW9uTmFtZSwgJy4nICsgZmlsZU5hbWUpKSlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoc2hhcmVkQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMpKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHNoYXJlZENvbnRleHQubmV3RnVuY3RvckZpbGVzLCBlbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUoc2NoZW1hLCBlbnRyeSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLypcbiAgICAgICAgICAgIGxldCBtaXhpbnMgPSBbXTtcblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmluZm8ubWl4aW5zKSkge1xuICAgICAgICAgICAgICAgIGxldCBtaXhpbnNEaXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMub3V0cHV0UGF0aCwgc2NoZW1hLm5hbWUsICdtaXhpbnMnKTtcbiAgICAgICAgICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKG1peGluc0RpclBhdGgpO1xuXG4gICAgICAgICAgICAgICAgZW50aXR5LmluZm8ubWl4aW5zLmZvckVhY2gobSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBtaXhpbk5hbWUgPSBwYXNjYWxDYXNlKG0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBtaXhpbkZpbGVQYXRoID0gcGF0aC5qb2luKG1peGluc0RpclBhdGgsIG1peGluTmFtZSArICcuanMnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmcy5wYXRoRXhpc3RzU3luYyhtaXhpbkZpbGVQYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhtaXhpbkZpbGVQYXRoLCBgY29uc3Qge1xuICAgIEVycm9yczogeyBWYWxpZGF0aW9uRXJyb3IsIERhdGFiYXNlRXJyb3IgfSxcbiAgICBQcm9jZXNzb3JzLFxuICAgIFZhbGlkYXRvcnNcbn0gPSByZXF1aXJlKFwiQGdlbngvZGF0YVwiKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZShcInJrLXV0aWxzXCIpO1xuXG5tb2R1bGUuZXhwb3J0cyA9ICR7Y2FwaXRhbGl6ZWR9ID0+IGNsYXNzIGV4dGVuZHMgJHtjYXBpdGFsaXplZH0ge1xuICAgIC8vdG9kbzogYWRkIHN0YWljIG1ldGhvZHNcbn07YCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBsZXQgbWl4aW5WYXJOYW1lID0gJ21peGluJyArIG1peGluTmFtZTtcbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0TGluZXMucHVzaChKc0xhbmcuYXN0VG9Db2RlKEpzTGFuZy5hc3RSZXF1aXJlKG1peGluVmFyTmFtZSwgJy4vbWl4aW5zLycgKyBtaXhpbk5hbWUpKSk7XG4gICAgICAgICAgICAgICAgICAgIG1peGlucy5wdXNoKG1peGluVmFyTmFtZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9Ki9cblxuICAgICAgICAgICAgLy9hc3NlbWJsZSB0aGUgc291cmNlIGNvZGUgZmlsZVxuICAgICAgICAgICAgLy9Kc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIGFzdENsYXNzTWFpbik7XG5cbiAgICAgICAgICAgIC8vSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBlbnRpdHkuZmllbGRzLm1hcCgodiwgaykgPT4gSnNMYW5nLmFzdEFzc2lnbihjYXBpdGFsaXplZCArICcuRl8nICsgXy5zbmFrZUNhc2UoaykudG9VcHBlckNhc2UoKSwgaykpKTsgICBcblxuICAgICAgICAgICAgbGV0IGxvY2FscyA9IHtcbiAgICAgICAgICAgICAgICBpbXBvcnRzOiBpbXBvcnRMaW5lcy5qb2luKCdcXG4nKSxcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU6IGNhcGl0YWxpemVkLFxuICAgICAgICAgICAgICAgIGVudGl0eU1ldGE6IGluZGVudExpbmVzKEpTT04uc3RyaW5naWZ5KG1vZGVsTWV0YSwgbnVsbCwgNCksIDQpLFxuICAgICAgICAgICAgICAgIGNsYXNzQm9keTogaW5kZW50TGluZXMoYXN0Q2xhc3NNYWluLm1hcChibG9jayA9PiBKc0xhbmcuYXN0VG9Db2RlKGJsb2NrKSkuam9pbignXFxuXFxuJyksIDgpLFxuICAgICAgICAgICAgICAgIGZ1bmN0b3JzOiBpbmRlbnRMaW5lcyhKc0xhbmcuYXN0VG9Db2RlKEpzTGFuZy5hc3RWYWx1ZShfLnJlZHVjZShzaGFyZWRDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcywgKHJlc3VsdCwgZnVuY3RvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbJyQnICsgZnVuY3Rvci5mdW5jdGlvbk5hbWVdID0gSnNMYW5nLmFzdElkKGZ1bmN0b3IuZnVuY3Rpb25OYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9LCB7fSkpKSwgNCksXG4gICAgICAgICAgICAgICAgLy9taXhpbnMgXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgY2xhc3NUZW1wbGF0ZSA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdkYXRhYmFzZScsIHRoaXMuY29ubmVjdG9yLmRyaXZlciwgJ0VudGl0eU1vZGVsLmpzLnN3aWcnKTtcbiAgICAgICAgICAgIGxldCBjbGFzc0NvZGUgPSBzd2lnLnJlbmRlckZpbGUoY2xhc3NUZW1wbGF0ZSwgbG9jYWxzKTtcblxuICAgICAgICAgICAgbGV0IG1vZGVsRmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXRQYXRoLCBzY2hlbWEubmFtZSwgJ2Jhc2UnLCBjYXBpdGFsaXplZCArICcuanMnKTtcbiAgICAgICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhtb2RlbEZpbGVQYXRoLCBjbGFzc0NvZGUpO1xuXG4gICAgICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIGVudGl0eSBtb2RlbDogJyArIG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZ2VuZXJhdGVFbnRpdHlNYW5pZmVzdChzY2hlbWEpIHtcbiAgICAgICAgbGV0IGVudGl0aWVzID0gT2JqZWN0LmtleXMoc2NoZW1hLmVudGl0aWVzKS5zb3J0KCkucmVkdWNlKChyZXN1bHQsIHYpID0+IHsgcmVzdWx0W3ZdID0ge307IHJldHVybiByZXN1bHQ7IH0sIHt9KTtcbiAgICAgICAgLypcbiAgICAgICAgbGV0IG1hbmlmZXN0ID0ge307XG5cbiAgICAgICAgXy5lYWNoKHNjaGVtYS5lbnRpdGllcywgKGVudGl0eSwgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKGVudGl0eS5pbmZvLnJlc3RmdWwpIHtcbiAgICAgICAgICAgICAgICBfLmVhY2goZW50aXR5LmluZm8ucmVzdGZ1bCwgKHsgdHlwZSwgbWV0aG9kcyB9LCByZWxhdGl2ZVVyaSkgPT4geyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBhcGlJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHM6IHt9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2VudGl0eScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaUluZm8uZW50aXR5ID0gZW50aXR5TmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaUluZm8uZGlzcGxheU5hbWUgPSBlbnRpdHkuZGlzcGxheU5hbWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuY29tbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaUluZm8uZGVzY3JpcHRpb24gPSBlbnRpdHkuY29tbWVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChtZXRob2RzLCAobWV0YSwgbWV0aG9kTmFtZSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1ldGhvZE5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjcmVhdGUnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcGlJbmZvLm1ldGhvZHNbJ3Bvc3Q6JyArIHJlbGF0aXZlVXJpXSA9IG1ldGE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdmaW5kT25lJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ZpbmVBbGwnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndXBkYXRlT25lJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3VwZGF0ZU1hbnknOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZGVsZXRlT25lJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2RlbGV0ZU1hbnknOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgKi9cbiAgICAgICAvKlxuICAgICAgICBsZXQgb3V0cHV0RmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5tYW5pZmVzdFBhdGgsIHNjaGVtYS5uYW1lICsgJy5tYW5pZmVzdC5qc29uJyk7XG4gICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG91dHB1dEZpbGVQYXRoKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhvdXRwdXRGaWxlUGF0aCwgSlNPTi5zdHJpbmdpZnkoZW50aXRpZXMsIG51bGwsIDQpKTtcblxuICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIHNjaGVtYSBtYW5pZmVzdDogJyArIG91dHB1dEZpbGVQYXRoKTtcbiAgICAgICAgKi9cblxuICAgICAgICAvL2dlbmVyYXRlIHZhbGlkYXRvciBjb25maWdcbiAgICAgICAgXy5mb3JPd24oc2NoZW1hLmVudGl0aWVzLCAoZW50aXR5LCBlbnRpdHlJbnN0YW5jZU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCB2YWxpZGF0aW9uU2NoZW1hID0ge307XG5cbiAgICAgICAgICAgIF8uZm9yT3duKGVudGl0eS5maWVsZHMsIChmaWVsZCwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGZpZWxkU2NoZW1hID0ge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiBmaWVsZC50eXBlXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChmaWVsZC50eXBlID09PSAnZW51bScpIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGRTY2hlbWEudmFsdWVzID0gZmllbGQudmFsdWVzO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChmaWVsZC5vcHRpb25hbCkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFNjaGVtYS5vcHRpb25hbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmFsaWRhdGlvblNjaGVtYVtmaWVsZE5hbWVdID0gZmllbGRTY2hlbWE7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGVudGl0eU91dHB1dEZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMubWFuaWZlc3RQYXRoLCBzY2hlbWEubmFtZSwgJ3ZhbGlkYXRpb24nLCBlbnRpdHlJbnN0YW5jZU5hbWUgKyAnLm1hbmlmZXN0Lmpzb24nKTtcbiAgICAgICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKGVudGl0eU91dHB1dEZpbGVQYXRoKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZW50aXR5T3V0cHV0RmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KHZhbGlkYXRpb25TY2hlbWEsIG51bGwsIDQpKTtcblxuICAgICAgICAgICAgdGhpcy5saW5rZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRlZCBlbnRpdHkgbWFuaWZlc3Q6ICcgKyBlbnRpdHlPdXRwdXRGaWxlUGF0aCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qXG4gICAgX2dlbmVyYXRlVmlld01vZGVsKHNjaGVtYSwgZGJTZXJ2aWNlKSB7ICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oc2NoZW1hLnZpZXdzLCAodmlld0luZm8sIHZpZXdOYW1lKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxpbmtlci5pbmZvKCdCdWlsZGluZyB2aWV3OiAnICsgdmlld05hbWUpO1xuXG4gICAgICAgICAgICBsZXQgY2FwaXRhbGl6ZWQgPSBfLnVwcGVyRmlyc3Qodmlld05hbWUpO1xuXG4gICAgICAgICAgICBsZXQgYXN0ID0gSnNMYW5nLmFzdFByb2dyYW0oKTtcblxuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0UmVxdWlyZSgnTW93YScsICdtb3dhJykpO1xuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnVXRpbCcsIEpzTGFuZy5hc3RWYXJSZWYoJ01vd2EuVXRpbCcpLCB0cnVlKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RWYXJEZWNsYXJlKCdfJywgSnNMYW5nLmFzdFZhclJlZignVXRpbC5fJyksIHRydWUpKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFJlcXVpcmUoJ1ZpZXcnLCAnbW93YS9saWIvb29sb25nL3J1bnRpbWUvdmlldycpKTtcblxuICAgICAgICAgICAgbGV0IGNvbXBpbGVDb250ZXh0ID0gT29sVG9Bc3QuY3JlYXRlQ29tcGlsZUNvbnRleHQodmlld05hbWUsIGRiU2VydmljZS5zZXJ2aWNlSWQsIHRoaXMubGlua2VyKTtcblxuICAgICAgICAgICAgY29tcGlsZUNvbnRleHQubW9kZWxWYXJzLmFkZCh2aWV3SW5mby5lbnRpdHkpO1xuXG4gICAgICAgICAgICBsZXQgcGFyYW1NZXRhO1xuXG4gICAgICAgICAgICBpZiAodmlld0luZm8ucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1NZXRhID0gdGhpcy5fcHJvY2Vzc1BhcmFtcyh2aWV3SW5mby5wYXJhbXMsIGNvbXBpbGVDb250ZXh0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHZpZXdNZXRhID0ge1xuICAgICAgICAgICAgICAgIGlzTGlzdDogdmlld0luZm8uaXNMaXN0LFxuICAgICAgICAgICAgICAgIHBhcmFtczogcGFyYW1NZXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgdmlld0JvZHlUb3BvSWQgPSBPb2xUb0FzdC5jcmVhdGVUb3BvSWQoY29tcGlsZUNvbnRleHQsICckdmlldycpO1xuICAgICAgICAgICAgT29sVG9Bc3QuZGVwZW5kc09uKGNvbXBpbGVDb250ZXh0LCBjb21waWxlQ29udGV4dC5tYWluU3RhcnRJZCwgdmlld0JvZHlUb3BvSWQpO1xuXG4gICAgICAgICAgICBsZXQgdmlld01vZGVsZXIgPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL2Rhby92aWV3JywgZGJTZXJ2aWNlLmRiVHlwZSArICcuanMnKSk7XG4gICAgICAgICAgICBjb21waWxlQ29udGV4dC5hc3RNYXBbdmlld0JvZHlUb3BvSWRdID0gdmlld01vZGVsZXIoZGJTZXJ2aWNlLCB2aWV3TmFtZSwgdmlld0luZm8pO1xuICAgICAgICAgICAgT29sVG9Bc3QuYWRkQ29kZUJsb2NrKGNvbXBpbGVDb250ZXh0LCB2aWV3Qm9keVRvcG9JZCwge1xuICAgICAgICAgICAgICAgIHR5cGU6IE9vbFRvQXN0LkFTVF9CTEtfVklFV19PUEVSQVRJT05cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgcmV0dXJuVG9wb0lkID0gT29sVG9Bc3QuY3JlYXRlVG9wb0lkKGNvbXBpbGVDb250ZXh0LCAnJHJldHVybjp2YWx1ZScpO1xuICAgICAgICAgICAgT29sVG9Bc3QuZGVwZW5kc09uKGNvbXBpbGVDb250ZXh0LCB2aWV3Qm9keVRvcG9JZCwgcmV0dXJuVG9wb0lkKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmNvbXBpbGVSZXR1cm4ocmV0dXJuVG9wb0lkLCB7XG4gICAgICAgICAgICAgICAgXCJvb2xUeXBlXCI6IFwiT2JqZWN0UmVmZXJlbmNlXCIsXG4gICAgICAgICAgICAgICAgXCJuYW1lXCI6IFwidmlld0RhdGFcIlxuICAgICAgICAgICAgfSwgY29tcGlsZUNvbnRleHQpO1xuXG4gICAgICAgICAgICBsZXQgZGVwcyA9IGNvbXBpbGVDb250ZXh0LnRvcG9Tb3J0LnNvcnQoKTtcbiAgICAgICAgICAgIHRoaXMubGlua2VyLnZlcmJvc2UoJ0FsbCBkZXBlbmRlbmNpZXM6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgZGVwcyA9IGRlcHMuZmlsdGVyKGRlcCA9PiBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmhhcyhkZXApKTtcbiAgICAgICAgICAgIHRoaXMubGlua2VyLnZlcmJvc2UoJ0FsbCBuZWNlc3Nhcnkgc291cmNlIGNvZGU6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgbGV0IGFzdERvTG9hZE1haW4gPSBbXG4gICAgICAgICAgICAgICAgSnNMYW5nLmFzdFZhckRlY2xhcmUoJyRtZXRhJywgSnNMYW5nLmFzdFZhclJlZigndGhpcy5tZXRhJyksIHRydWUsIGZhbHNlLCAnUmV0cmlldmluZyB0aGUgbWV0YSBkYXRhJylcbiAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgIF8uZWFjaChkZXBzLCBkZXAgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBhc3RNZXRhID0gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5nZXQoZGVwKTtcblxuICAgICAgICAgICAgICAgIGxldCBhc3RCbG9jayA9IGNvbXBpbGVDb250ZXh0LmFzdE1hcFtkZXBdO1xuICAgICAgICAgICAgICAgIGFzc2VydDogYXN0QmxvY2ssICdFbXB0eSBhc3QgYmxvY2snO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFzdE1ldGEudHlwZSA9PT0gJ01vZGlmaWVyQ2FsbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpZWxkTmFtZSA9IGdldEZpZWxkTmFtZShhc3RNZXRhLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBhc3RDYWNoZSA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihhc3RNZXRhLnRhcmdldCksIGFzdEJsb2NrLCBgTW9kaWZ5aW5nICR7ZmllbGROYW1lfWApO1xuICAgICAgICAgICAgICAgICAgICBhc3REb0xvYWRNYWluLnB1c2goYXN0Q2FjaGUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXN0RG9Mb2FkTWFpbiA9IGFzdERvTG9hZE1haW4uY29uY2F0KF8uY2FzdEFycmF5KGNvbXBpbGVDb250ZXh0LmFzdE1hcFtkZXBdKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29tcGlsZUNvbnRleHQubWFwT2ZGdW5jdG9yVG9GaWxlKSkge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKGNvbXBpbGVDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSwgKGZpbGVOYW1lLCBmdW5jdGlvbk5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0UmVxdWlyZShmdW5jdGlvbk5hbWUsICcuJyArIGZpbGVOYW1lKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbXBpbGVDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcykpIHtcbiAgICAgICAgICAgICAgICBfLmVhY2goY29tcGlsZUNvbnRleHQubmV3RnVuY3RvckZpbGVzLCBlbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUoZGJTZXJ2aWNlLCBlbnRyeSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdENsYXNzRGVjbGFyZShjYXBpdGFsaXplZCwgJ1ZpZXcnLCBbXG4gICAgICAgICAgICAgICAgSnNMYW5nLmFzdE1lbWJlck1ldGhvZCgnX2RvTG9hZCcsIE9iamVjdC5rZXlzKHBhcmFtTWV0YSksXG4gICAgICAgICAgICAgICAgICAgIGFzdERvTG9hZE1haW4sXG4gICAgICAgICAgICAgICAgICAgIGZhbHNlLCB0cnVlLCBmYWxzZSwgJ1BvcHVsYXRlIHZpZXcgZGF0YSdcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICBdLCBgJHtjYXBpdGFsaXplZH0gdmlld2ApKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdEFzc2lnbihjYXBpdGFsaXplZCArICcubWV0YScsIEpzTGFuZy5hc3RWYWx1ZSh2aWV3TWV0YSkpKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdEFzc2lnbignbW9kdWxlLmV4cG9ydHMnLCBKc0xhbmcuYXN0VmFyUmVmKGNhcGl0YWxpemVkKSkpO1xuXG4gICAgICAgICAgICBsZXQgbW9kZWxGaWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLm91dHB1dFBhdGgsIGRiU2VydmljZS5kYlR5cGUsIGRiU2VydmljZS5uYW1lLCAndmlld3MnLCB2aWV3TmFtZSArICcuanMnKTtcbiAgICAgICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhtb2RlbEZpbGVQYXRoICsgJy5qc29uJywgSlNPTi5zdHJpbmdpZnkoYXN0LCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIERhb01vZGVsZXIuX2V4cG9ydFNvdXJjZUNvZGUoYXN0LCBtb2RlbEZpbGVQYXRoKTtcblxuICAgICAgICAgICAgdGhpcy5saW5rZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRlZCB2aWV3IG1vZGVsOiAnICsgbW9kZWxGaWxlUGF0aCk7XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgKi9cblxuICAgIF9wcm9jZXNzRmllbGRNb2RpZmllcnMoZW50aXR5LCBzaGFyZWRDb250ZXh0KSB7XG4gICAgICAgIGxldCBjb21waWxlQ29udGV4dCA9IEdlbWxUb0FzdC5jcmVhdGVDb21waWxlQ29udGV4dChlbnRpdHkuZ2VtbE1vZHVsZS5uYW1lLCB0aGlzLmxpbmtlciwgc2hhcmVkQ29udGV4dCk7XG4gICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1sncmF3J10gPSB7IHNvdXJjZTogJ2NvbnRleHQnLCBmaW5hbGl6ZWQ6IHRydWUgfTtcbiAgICAgICAgY29tcGlsZUNvbnRleHQudmFyaWFibGVzWydpMThuJ10gPSB7IHNvdXJjZTogJ2NvbnRleHQnLCBmaW5hbGl6ZWQ6IHRydWUgfTtcbiAgICAgICAgY29tcGlsZUNvbnRleHQudmFyaWFibGVzWydjb25uZWN0b3InXSA9IHsgc291cmNlOiAnY29udGV4dCcsIGZpbmFsaXplZDogdHJ1ZSB9O1xuICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbJ2xhdGVzdCddID0geyBzb3VyY2U6ICdjb250ZXh0JyB9O1xuXG4gICAgICAgIGNvbnN0IGFsbEZpbmlzaGVkID0gR2VtbFRvQXN0LmNyZWF0ZVRvcG9JZChjb21waWxlQ29udGV4dCwgJ2RvbmUuJyk7XG5cbiAgICAgICAgLy9tYXAgb2YgZmllbGQgbmFtZSB0byBkZXBlbmRlbmNpZXNcbiAgICAgICAgbGV0IGZpZWxkUmVmZXJlbmNlcyA9IHt9O1xuXG4gICAgICAgIF8uZm9yT3duKGVudGl0eS5maWVsZHMsIChmaWVsZCwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgdG9wb0lkID0gR2VtbFRvQXN0LmNvbXBpbGVGaWVsZChmaWVsZE5hbWUsIGZpZWxkLCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICBHZW1sVG9Bc3QuZGVwZW5kc09uKGNvbXBpbGVDb250ZXh0LCB0b3BvSWQsIGFsbEZpbmlzaGVkKTtcblxuICAgICAgICAgICAgaWYgKGZpZWxkLndyaXRlT25jZSB8fCBmaWVsZC5mcmVlemVBZnRlck5vbkRlZmF1bHQpIHtcbiAgICAgICAgICAgICAgICBwdXRJbnRvQnVja2V0KGZpZWxkUmVmZXJlbmNlcywgZmllbGROYW1lLCB7IHJlZmVyZW5jZTogZmllbGROYW1lLCB3cml0ZVByb3RlY3Q6IHRydWUgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBkZXBzID0gY29tcGlsZUNvbnRleHQudG9wb1NvcnQuc29ydCgpO1xuICAgICAgICAvL3RoaXMubGlua2VyLnZlcmJvc2UoJ0FsbCBkZXBlbmRlbmNpZXM6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICBkZXBzID0gZGVwcy5maWx0ZXIoZGVwID0+IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuaGFzKGRlcCkpO1xuICAgICAgICAvL3RoaXMubGlua2VyLnZlcmJvc2UoJ0FsbCBuZWNlc3Nhcnkgc291cmNlIGNvZGU6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICBsZXQgbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCA9IFtdLCBsYXN0RmllbGRzR3JvdXAsIFxuICAgICAgICAgICAgbWV0aG9kQm9keUNhY2hlID0gW10sIFxuICAgICAgICAgICAgbGFzdEJsb2NrLCBsYXN0QXN0VHlwZTsvLywgaGFzVmFsaWRhdG9yID0gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlID0gZnVuY3Rpb24gKGZpZWxkTmFtZSwgcmVmZXJlbmNlcywgYXN0Q2FjaGUsIHJlcXVpcmVUYXJnZXRGaWVsZCkgeyBcbiAgICAgICAgICAgIGxldCBmaWVsZHMgPSBbIGZpZWxkTmFtZSBdLmNvbmNhdChyZWZlcmVuY2VzKTtcbiAgICAgICAgICAgIGxldCBjaGVja2VyID0gZmllbGRzLmpvaW4oJywnKTtcblxuICAgICAgICAgICAgaWYgKGxhc3RGaWVsZHNHcm91cCAmJiBsYXN0RmllbGRzR3JvdXAuY2hlY2tlciAhPT0gY2hlY2tlcikge1xuICAgICAgICAgICAgICAgIG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwgPSBtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsLmNvbmNhdChcbiAgICAgICAgICAgICAgICAgICAgU25pcHBldHMuX2ZpZWxkUmVxdWlyZW1lbnRDaGVjayhsYXN0RmllbGRzR3JvdXAuZmllbGROYW1lLCBsYXN0RmllbGRzR3JvdXAucmVmZXJlbmNlcywgbWV0aG9kQm9keUNhY2hlLCBsYXN0RmllbGRzR3JvdXAucmVxdWlyZVRhcmdldEZpZWxkKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgbWV0aG9kQm9keUNhY2hlID0gW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG1ldGhvZEJvZHlDYWNoZSA9IG1ldGhvZEJvZHlDYWNoZS5jb25jYXQoYXN0Q2FjaGUpO1xuICAgICAgICAgICAgbGFzdEZpZWxkc0dyb3VwID0ge1xuICAgICAgICAgICAgICAgIGZpZWxkTmFtZSxcbiAgICAgICAgICAgICAgICByZWZlcmVuY2VzLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVUYXJnZXRGaWVsZCwgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY2hlY2tlcixcbiAgICAgICAgICAgIH07XG4gICAgICAgIH07XG5cbiAgICAgICAgLy9jb25zb2xlLmRpcihjb21waWxlQ29udGV4dC5hc3RNYXBbJ21vYmlsZX5pc01vYmlsZVBob25lOmFyZ1sxXXw+c3RyaW5nRGFzaGVyaXplJ10sIHsgZGVwdGg6IDggfSk7IFxuXG4gICAgICAgIF8uZWFjaChkZXBzLCAoZGVwLCBpKSA9PiB7XG4gICAgICAgICAgICAvL2dldCBtZXRhZGF0YSBvZiBzb3VyY2UgY29kZSBibG9ja1xuICAgICAgICAgICAgbGV0IHNvdXJjZU1hcCA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcCk7XG5cbiAgICAgICAgICAgIC8vZ2V0IHNvdXJjZSBjb2RlIGJsb2NrXG4gICAgICAgICAgICBsZXQgYXN0QmxvY2sgPSBjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXTtcblxuICAgICAgICAgICAgbGV0IHRhcmdldEZpZWxkTmFtZSA9IGdldEZpZWxkTmFtZShzb3VyY2VNYXAudGFyZ2V0KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC5yZWZlcmVuY2VzICYmIHNvdXJjZU1hcC5yZWZlcmVuY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBsZXQgZmllbGRSZWZlcmVuY2UgPSBmaWVsZFJlZmVyZW5jZXNbdGFyZ2V0RmllbGROYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAoIWZpZWxkUmVmZXJlbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkUmVmZXJlbmNlc1t0YXJnZXRGaWVsZE5hbWVdID0gZmllbGRSZWZlcmVuY2UgPSBbXTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoc291cmNlTWFwLnR5cGUgPT09IEdlbWxUb0FzdC5BU1RfQkxLX0FDVElWQVRPUl9DQUxMKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZU1hcC5yZWZlcmVuY2VzLmZvckVhY2gocmVmID0+IHsgZmllbGRSZWZlcmVuY2UucHVzaCh7IHJlZmVyZW5jZTogcmVmLCB3aGVuTnVsbDogdHJ1ZSB9KTsgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlTWFwLnJlZmVyZW5jZXMuZm9yRWFjaChyZWYgPT4geyBpZiAoZmllbGRSZWZlcmVuY2UuaW5kZXhPZihyZWYpID09PSAtMSkgZmllbGRSZWZlcmVuY2UucHVzaChyZWYpOyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChsYXN0QmxvY2spIHtcbiAgICAgICAgICAgICAgICBhc3RCbG9jayA9IGNoYWluQ2FsbChsYXN0QmxvY2ssIGxhc3RBc3RUeXBlLCBhc3RCbG9jaywgc291cmNlTWFwLnR5cGUpO1xuICAgICAgICAgICAgICAgIGxhc3RCbG9jayA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGkgPCBkZXBzLmxlbmd0aC0xKSB7XG4gICAgICAgICAgICAgICAgbGV0IG5leHRUeXBlID0gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5nZXQoZGVwc1tpKzFdKTtcblxuICAgICAgICAgICAgICAgIGlmIChpc0NoYWluYWJsZShzb3VyY2VNYXAsIG5leHRUeXBlKSkge1xuICAgICAgICAgICAgICAgICAgICBsYXN0QmxvY2sgPSBhc3RCbG9jaztcbiAgICAgICAgICAgICAgICAgICAgbGFzdEFzdFR5cGUgPSBzb3VyY2VNYXAudHlwZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC50eXBlID09PSBHZW1sVG9Bc3QuQVNUX0JMS19WQUxJREFUT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgIC8vaGFzVmFsaWRhdG9yID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBsZXQgYXN0Q2FjaGUgPSBTbmlwcGV0cy5fdmFsaWRhdGVDaGVjayh0YXJnZXRGaWVsZE5hbWUsIGFzdEJsb2NrKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIHRydWUpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZU1hcC50eXBlID09PSBHZW1sVG9Bc3QuQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgIGxldCBhc3RDYWNoZSA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBQcm9jZXNzaW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gR2VtbFRvQXN0LkFTVF9CTEtfQUNUSVZBVE9SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICBsZXQgYXN0Q2FjaGUgPSBTbmlwcGV0cy5fY2hlY2tBbmRBc3NpZ24oYXN0QmxvY2ssIEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCwgdHJ1ZSksIGBBY3RpdmF0aW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIGZhbHNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUbyBiZSBpbXBsZW1lbnRlZC4nKTtcbiAgICAgICAgICAgICAgICAvL2FzdEJsb2NrID0gXy5jYXN0QXJyYXkoYXN0QmxvY2spOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvL19tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSh0YXJnZXRGaWVsZE5hbWUsIFtdLCBhc3RCbG9jayk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyogQ2hhbmdlZCB0byB0aHJvdyBlcnJvciBpbnN0ZWFkIG9mIHJldHVybmluZyBhIGVycm9yIG9iamVjdFxuICAgICAgICBpZiAoaGFzVmFsaWRhdG9yKSB7XG4gICAgICAgICAgICBsZXQgZGVjbGFyZSA9IEpzTGFuZy5hc3RWYXJEZWNsYXJlKHZhbGlkU3RhdGVOYW1lLCBmYWxzZSk7XG4gICAgICAgICAgICBtZXRob2RCb2R5Q3JlYXRlLnVuc2hpZnQoZGVjbGFyZSk7XG4gICAgICAgICAgICBtZXRob2RCb2R5VXBkYXRlLnVuc2hpZnQoZGVjbGFyZSk7XG4gICAgICAgIH1cbiAgICAgICAgKi9cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShtZXRob2RCb2R5Q2FjaGUpKSB7XG4gICAgICAgICAgICBtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsID0gbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbC5jb25jYXQoXG4gICAgICAgICAgICAgICAgU25pcHBldHMuX2ZpZWxkUmVxdWlyZW1lbnRDaGVjayhsYXN0RmllbGRzR3JvdXAuZmllbGROYW1lLCBcbiAgICAgICAgICAgICAgICAgICAgbGFzdEZpZWxkc0dyb3VwLnJlZmVyZW5jZXMsIFxuICAgICAgICAgICAgICAgICAgICBtZXRob2RCb2R5Q2FjaGUsIFxuICAgICAgICAgICAgICAgICAgICBsYXN0RmllbGRzR3JvdXAucmVxdWlyZVRhcmdldEZpZWxkXG4gICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICB9ICAgICAgXG4gICAgICAgIFxuICAgICAgICAvKlxuICAgICAgICBsZXQgYXN0ID0gSnNMYW5nLmFzdFByb2dyYW0oZmFsc2UpO1xuICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RDbGFzc0RlY2xhcmUoJ0FiYycsICdNb2RlbCcsIFtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoYXN5bmNNZXRob2ROYW1pbmcoJ3ByZXBhcmVFbnRpdHlEYXRhXycpLCBbICdjb250ZXh0JyBdLFxuICAgICAgICAgICAgU25pcHBldHMuX2RvVmFsaWRhdGVBbmRGaWxsSGVhZGVyLmNvbmNhdChtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsKS5jb25jYXQoWyBKc0xhbmcuYXN0UmV0dXJuKEpzTGFuZy5hc3RJZCgnY29udGV4dCcpKSBdKSxcbiAgICAgICAgICAgIGZhbHNlLCB0cnVlLCB0cnVlXG4gICAgICAgICldLCAnY29tbWVudCcpKTtcbiAgICAgICAgKi9cblxuICAgICAgICByZXR1cm4geyBhc3Q6IEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoYXN5bmNNZXRob2ROYW1pbmcoJ2FwcGx5TW9kaWZpZXJzJyksIFsgJ2NvbnRleHQnLCAnaXNVcGRhdGluZycgXSxcbiAgICAgICAgICAgIFNuaXBwZXRzLl9hcHBseU1vZGlmaWVyc0hlYWRlci5jb25jYXQobWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCkuY29uY2F0KFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoJ2NvbnRleHQnKSkgXSksXG4gICAgICAgICAgICBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgJ0FwcGx5aW5nIHByZWRlZmluZWQgbW9kaWZpZXJzIHRvIGVudGl0eSBmaWVsZHMuJ1xuICAgICAgICApLCBmaWVsZFJlZmVyZW5jZXMgfTtcbiAgICB9XG5cbiAgICBfZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZShzY2hlbWEsIHsgZnVuY3Rpb25OYW1lLCBmdW5jdG9yVHlwZSwgZmlsZU5hbWUsIGFyZ3MgfSkge1xuICAgICAgICBsZXQgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoXG4gICAgICAgICAgICB0aGlzLm91dHB1dFBhdGgsXG4gICAgICAgICAgICBzY2hlbWEubmFtZSxcbiAgICAgICAgICAgIGZpbGVOYW1lXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICAvL3RvZG86IGFuYWx5c2UgY29kZSwgY29tcGFyZSBhcmd1bWVudHNcbiAgICAgICAgICAgIHRoaXMubGlua2VyLmxvZygnaW5mbycsIGAkeyBfLnVwcGVyRmlyc3QoZnVuY3RvclR5cGUpIH0gXCIke2ZpbGVOYW1lfVwiIGV4aXN0cy4gRmlsZSBnZW5lcmF0aW5nIHNraXBwZWQuYCk7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3QgPSBKc0xhbmcuYXN0UHJvZ3JhbSgpO1xuICAgICAgICBcbiAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0RnVuY3Rpb24oZnVuY3Rpb25OYW1lLCBhcmdzLCBPT0xfTU9ESUZJRVJfUkVUVVJOW2Z1bmN0b3JUeXBlXShhcmdzKSkpO1xuICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RBc3NpZ24oJ21vZHVsZS5leHBvcnRzJywgSnNMYW5nLmFzdFZhclJlZihmdW5jdGlvbk5hbWUpKSk7XG5cbiAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMoZmlsZVBhdGgpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBKc0xhbmcuYXN0VG9Db2RlKGFzdCkpO1xuICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2luZm8nLCBgR2VuZXJhdGVkICR7IGZ1bmN0b3JUeXBlIH0gZmlsZTogJHtmaWxlUGF0aH1gKTtcbiAgICB9XG5cbiAgICBfYnVpbGRJbnRlcmZhY2VzKGVudGl0eSwgbW9kZWxNZXRhSW5pdCwgc2hhcmVkQ29udGV4dCkge1xuICAgICAgICBsZXQgYXN0ID0gW107XG5cbiAgICAgICAgXy5mb3JPd24oZW50aXR5LmludGVyZmFjZXMsIChtZXRob2QsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubGlua2VyLmluZm8oJ0J1aWxkaW5nIGludGVyZmFjZTogJyArIG5hbWUpO1xuXG4gICAgICAgICAgICBsZXQgYXN0Qm9keSA9IFtcbiAgICAgICAgICAgICAgICBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnJG1ldGEnLCBKc0xhbmcuYXN0VmFyUmVmKCd0aGlzLm1ldGEuaW50ZXJmYWNlcy4nICsgbmFtZSksIHRydWUsIGZhbHNlLCAnUmV0cmlldmluZyB0aGUgbWV0YSBkYXRhJylcbiAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgIGxldCBjb21waWxlQ29udGV4dCA9IEdlbWxUb0FzdC5jcmVhdGVDb21waWxlQ29udGV4dChlbnRpdHkuZ2VtbE1vZHVsZS5uYW1lLCB0aGlzLmxpbmtlciwgc2hhcmVkQ29udGV4dCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBwYXJhbU1ldGE7XG5cbiAgICAgICAgICAgIGlmIChtZXRob2QuYWNjZXB0KSB7XG4gICAgICAgICAgICAgICAgcGFyYW1NZXRhID0gdGhpcy5fcHJvY2Vzc1BhcmFtcyhtZXRob2QuYWNjZXB0LCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vbWV0YWRhdGFcbiAgICAgICAgICAgIG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXSB8fCAobW9kZWxNZXRhSW5pdFsnaW50ZXJmYWNlcyddID0ge30pO1xuICAgICAgICAgICAgbW9kZWxNZXRhSW5pdFsnaW50ZXJmYWNlcyddW25hbWVdID0geyBwYXJhbXM6IE9iamVjdC52YWx1ZXMocGFyYW1NZXRhKSB9O1xuXG4gICAgICAgICAgICBfLmVhY2gobWV0aG9kLmltcGxlbWVudGF0aW9uLCAob3BlcmF0aW9uLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vbGV0IGxhc3RUb3BvSWQgPSBcbiAgICAgICAgICAgICAgICBHZW1sVG9Bc3QuY29tcGlsZURiT3BlcmF0aW9uKGluZGV4LCBvcGVyYXRpb24sIGNvbXBpbGVDb250ZXh0LCBjb21waWxlQ29udGV4dC5tYWluU3RhcnRJZCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChtZXRob2QucmV0dXJuKSB7XG4gICAgICAgICAgICAgICAgR2VtbFRvQXN0LmNvbXBpbGVFeGNlcHRpb25hbFJldHVybihtZXRob2QucmV0dXJuLCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkZXBzID0gY29tcGlsZUNvbnRleHQudG9wb1NvcnQuc29ydCgpO1xuICAgICAgICAgICAgLy90aGlzLmxpbmtlci52ZXJib3NlKCdBbGwgZGVwZW5kZW5jaWVzOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIGRlcHMgPSBkZXBzLmZpbHRlcihkZXAgPT4gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5oYXMoZGVwKSk7XG4gICAgICAgICAgICAvL3RoaXMubGlua2VyLnZlcmJvc2UoJ0FsbCBuZWNlc3Nhcnkgc291cmNlIGNvZGU6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgXy5lYWNoKGRlcHMsIGRlcCA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHNvdXJjZU1hcCA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcCk7XG4gICAgICAgICAgICAgICAgbGV0IGFzdEJsb2NrID0gY29tcGlsZUNvbnRleHQuYXN0TWFwW2RlcF07XG5cbiAgICAgICAgICAgICAgICAvL3RoaXMubGlua2VyLnZlcmJvc2UoJ0NvZGUgcG9pbnQgXCInICsgZGVwICsgJ1wiOlxcbicgKyBKU09OLnN0cmluZ2lmeShzb3VyY2VNYXAsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgICAgIGxldCB0YXJnZXRGaWVsZE5hbWUgPSBzb3VyY2VNYXAudGFyZ2V0OyAvL2dldEZpZWxkTmFtZShzb3VyY2VNYXAudGFyZ2V0KTsgICAgICBcblxuICAgICAgICAgICAgICAgIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gR2VtbFRvQXN0LkFTVF9CTEtfVkFMSURBVE9SX0NBTEwpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IFNuaXBwZXRzLl92YWxpZGF0ZUNoZWNrKHRhcmdldEZpZWxkTmFtZSwgYXN0QmxvY2spO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gR2VtbFRvQXN0LkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC5uZWVkRGVjbGFyZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBKc0xhbmcuYXN0VmFyRGVjbGFyZShKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQpLCBhc3RCbG9jaywgZmFsc2UsIGZhbHNlLCBgUHJvY2Vzc2luZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gSnNMYW5nLmFzdEFzc2lnbihKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQsIHRydWUpLCBhc3RCbG9jaywgYFByb2Nlc3NpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gR2VtbFRvQXN0LkFTVF9CTEtfQUNUSVZBVE9SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC5uZWVkRGVjbGFyZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBKc0xhbmcuYXN0VmFyRGVjbGFyZShKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQpLCBhc3RCbG9jaywgZmFsc2UsIGZhbHNlLCBgUHJvY2Vzc2luZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gSnNMYW5nLmFzdEFzc2lnbihKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQsIHRydWUpLCBhc3RCbG9jaywgYEFjdGl2YXRpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFzdEJvZHkgPSBhc3RCb2R5LmNvbmNhdChfLmNhc3RBcnJheShhc3RCbG9jaykpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGFzdC5wdXNoKEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoYXN5bmNNZXRob2ROYW1pbmcobmFtZSksIE9iamVjdC5rZXlzKHBhcmFtTWV0YSksIGFzdEJvZHksIGZhbHNlLCB0cnVlLCB0cnVlLCByZXBsYWNlQWxsKF8ua2ViYWJDYXNlKG5hbWUpLCAnLScsICcgJykpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFzdDtcbiAgICB9O1xuXG4gICAgX3Byb2Nlc3NQYXJhbXMoYWNjZXB0UGFyYW1zLCBjb21waWxlQ29udGV4dCkge1xuICAgICAgICBsZXQgcGFyYW1NZXRhID0ge307XG5cbiAgICAgICAgYWNjZXB0UGFyYW1zLmZvckVhY2goKHBhcmFtLCBpKSA9PiB7XG4gICAgICAgICAgICBHZW1sVG9Bc3QuY29tcGlsZVBhcmFtKGksIHBhcmFtLCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICBwYXJhbU1ldGFbcGFyYW0ubmFtZV0gPSBwYXJhbTtcbiAgICAgICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1twYXJhbS5uYW1lXSA9IHsgc291cmNlOiAnYXJndW1lbnQnIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBwYXJhbU1ldGE7XG4gICAgfTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEYW9Nb2RlbGVyOyJdfQ==
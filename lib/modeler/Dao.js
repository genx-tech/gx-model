"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  pascalCase,
  replaceAll,
  putIntoBucket
} = require('rk-utils');

const swig = require('swig-templates');

const GemlTypes = require('../lang/GemlTypes');

const JsLang = require('./util/ast.js');

const GemlToAst = require('./util/gemlToAst.js');

const Snippets = require('./dao/snippets');

const ChainableType = [GemlToAst.AST_BLK_VALIDATOR_CALL, GemlToAst.AST_BLK_PROCESSOR_CALL, GemlToAst.AST_BLK_ACTIVATOR_CALL];

const getFieldName = t => t.split('.').pop();

const isChainable = (current, next) => ChainableType.indexOf(current.type) > -1 && current.target === next.target && next.type === current.type;

const chainCall = (lastBlock, lastType, currentBlock, currentType) => {
  if (lastBlock) {
    if (lastType === 'ValidatorCall') {
      if (!(currentType === 'ValidatorCall')) {
        throw new Error('Unexpected currentType');
      }

      currentBlock = JsLang.astBinExp(lastBlock, '&&', currentBlock);
    } else {
      if (!(currentType === 'ProcessorCall')) {
        throw new Error('Unexpected currentType: ' + currentType + ' last: ' + lastType);
      }

      currentBlock.arguments[0] = lastBlock;
    }
  }

  return currentBlock;
};

const asyncMethodNaming = name => name + '_';

const indentLines = (lines, indentation) => lines.split('\n').map((line, i) => i === 0 ? line : _.repeat(' ', indentation) + line).join('\n');

const OOL_MODIFIER_RETURN = {
  [GemlTypes.Modifier.VALIDATOR]: () => [JsLang.astReturn(true)],
  [GemlTypes.Modifier.PROCESSOR]: args => [JsLang.astReturn(JsLang.astId(args[0]))],
  [GemlTypes.Modifier.ACTIVATOR]: () => [JsLang.astReturn(JsLang.astId("undefined"))]
};

class DaoModeler {
  constructor(context, connector) {
    this.linker = context.linker;
    this.outputPath = context.modelPath;
    this.manifestPath = context.manifestPath;
    this.connector = connector;
  }

  modeling_(schema) {
    this.linker.log('info', 'Generating entity models for schema "' + schema.name + '"...');

    this._generateSchemaModel(schema);

    this._generateEntityModel(schema);

    if (this.manifestPath) {
      this._generateEntityManifest(schema);
    }
  }

  _generateSchemaModel(schema) {
    let capitalized = pascalCase(schema.name);
    let locals = {
      driver: this.connector.driver,
      className: capitalized,
      schemaName: schema.name,
      entities: JSON.stringify(Object.keys(schema.entities))
    };
    let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'Database.js.swig');
    let classCode = swig.renderFile(classTemplate, locals);
    let modelFilePath = path.resolve(this.outputPath, capitalized + '.js');
    fs.ensureFileSync(modelFilePath);
    fs.writeFileSync(modelFilePath, classCode);
    this.linker.log('info', 'Generated database model: ' + modelFilePath);
  }

  _generateEnumTypes(schema) {
    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      _.forOwn(entity.fields, (field, fieldName) => {
        if (field.type === 'enum') {}
      });
    });
  }

  _generateEntityModel(schema) {
    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      let capitalized = pascalCase(entityInstanceName);
      let sharedContext = {
        mapOfFunctorToFile: {},
        newFunctorFiles: []
      };

      let {
        ast: astClassMain,
        fieldReferences
      } = this._processFieldModifiers(entity, sharedContext);

      astClassMain = [astClassMain];
      let uniqueKeys = [_.castArray(entity.key)];

      if (entity.indexes) {
        entity.indexes.forEach(index => {
          if (index.unique) {
            uniqueKeys.push(index.fields);
          }
        });
      }

      let modelMeta = {
        schemaName: schema.name,
        name: entityInstanceName,
        keyField: entity.key,
        fields: _.mapValues(entity.fields, f => _.omit(f.toJSON(), 'modifiers')),
        features: entity.features || {},
        uniqueKeys
      };

      if (entity.baseClasses) {
        modelMeta.baseClasses = entity.baseClasses;
      }

      if (!_.isEmpty(entity.indexes)) {
        modelMeta.indexes = entity.indexes;
      }

      if (!_.isEmpty(entity.features)) {
        modelMeta.features = entity.features;
      }

      if (!_.isEmpty(entity.associations)) {
        modelMeta.associations = entity.associations;
      }

      if (!_.isEmpty(fieldReferences)) {
        modelMeta.fieldDependencies = fieldReferences;
      }

      if (entity.interfaces) {
        let astInterfaces = this._buildInterfaces(entity, modelMeta, sharedContext);

        astClassMain = astClassMain.concat(astInterfaces);
      }

      let importLines = [];

      if (!_.isEmpty(sharedContext.mapOfFunctorToFile)) {
        _.forOwn(sharedContext.mapOfFunctorToFile, (fileName, functionName) => {
          importLines.push(JsLang.astToCode(JsLang.astRequire(functionName, '.' + fileName)));
        });
      }

      if (!_.isEmpty(sharedContext.newFunctorFiles)) {
        _.each(sharedContext.newFunctorFiles, entry => {
          this._generateFunctionTemplateFile(schema, entry);
        });
      }

      let locals = {
        imports: importLines.join('\n'),
        className: capitalized,
        entityMeta: indentLines(JSON.stringify(modelMeta, null, 4), 4),
        classBody: indentLines(astClassMain.map(block => JsLang.astToCode(block)).join('\n\n'), 8),
        functors: indentLines(JsLang.astToCode(JsLang.astValue(_.reduce(sharedContext.newFunctorFiles, (result, functor) => {
          result['$' + functor.functionName] = JsLang.astId(functor.functionName);
          return result;
        }, {}))), 4)
      };
      let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'EntityModel.js.swig');
      let classCode = swig.renderFile(classTemplate, locals);
      let modelFilePath = path.resolve(this.outputPath, schema.name, 'base', capitalized + '.js');
      fs.ensureFileSync(modelFilePath);
      fs.writeFileSync(modelFilePath, classCode);
      this.linker.log('info', 'Generated entity model: ' + modelFilePath);
    });
  }

  _generateEntityManifest(schema) {
    let entities = Object.keys(schema.entities).sort().reduce((result, v) => {
      result[v] = {};
      return result;
    }, {});
    let outputFilePath = path.resolve(this.manifestPath, schema.name + '.manifest.json');
    fs.ensureFileSync(outputFilePath);
    fs.writeFileSync(outputFilePath, JSON.stringify(entities, null, 4));
    this.linker.log('info', 'Generated schema manifest: ' + outputFilePath);
  }

  _processFieldModifiers(entity, sharedContext) {
    let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);
    compileContext.variables['raw'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['i18n'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['connector'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['latest'] = {
      source: 'context'
    };
    const allFinished = GemlToAst.createTopoId(compileContext, 'done.');
    let fieldReferences = {};

    _.forOwn(entity.fields, (field, fieldName) => {
      let topoId = GemlToAst.compileField(fieldName, field, compileContext);
      GemlToAst.dependsOn(compileContext, topoId, allFinished);

      if (field.writeOnce || field.freezeAfterNonDefault) {
        putIntoBucket(fieldReferences, fieldName, {
          reference: fieldName,
          writeProtect: true
        });
      }
    });

    let deps = compileContext.topoSort.sort();
    deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));
    let methodBodyValidateAndFill = [],
        lastFieldsGroup,
        methodBodyCache = [],
        lastBlock,
        lastAstType;

    const _mergeDoValidateAndFillCode = function (fieldName, references, astCache, requireTargetField) {
      let fields = [fieldName].concat(references);
      let checker = fields.join(',');

      if (lastFieldsGroup && lastFieldsGroup.checker !== checker) {
        methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
        methodBodyCache = [];
      }

      methodBodyCache = methodBodyCache.concat(astCache);
      lastFieldsGroup = {
        fieldName,
        references,
        requireTargetField,
        checker
      };
    };

    _.each(deps, (dep, i) => {
      let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
      let astBlock = compileContext.astMap[dep];
      let targetFieldName = getFieldName(sourceMap.target);

      if (sourceMap.references && sourceMap.references.length > 0) {
        let fieldReference = fieldReferences[targetFieldName];

        if (!fieldReference) {
          fieldReferences[targetFieldName] = fieldReference = [];
        }

        if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {
          sourceMap.references.forEach(ref => {
            fieldReference.push({
              reference: ref,
              whenNull: true
            });
          });
        } else {
          sourceMap.references.forEach(ref => {
            if (fieldReference.indexOf(ref) === -1) fieldReference.push(ref);
          });
        }
      }

      if (lastBlock) {
        astBlock = chainCall(lastBlock, lastAstType, astBlock, sourceMap.type);
        lastBlock = undefined;
      }

      if (i < deps.length - 1) {
        let nextType = compileContext.mapOfTokenToMeta.get(deps[i + 1]);

        if (isChainable(sourceMap, nextType)) {
          lastBlock = astBlock;
          lastAstType = sourceMap.type;
          return;
        }
      }

      if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {
        let astCache = Snippets._validateCheck(targetFieldName, astBlock);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {
        let astCache = Snippets._checkAndAssign(astBlock, JsLang.astVarRef(sourceMap.target, true), `Activating "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, false);
      } else {
        throw new Error('To be implemented.');
      }
    });

    if (!_.isEmpty(methodBodyCache)) {
      methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
    }

    return {
      ast: JsLang.astMemberMethod(asyncMethodNaming('applyModifiers'), ['context', 'isUpdating'], Snippets._applyModifiersHeader.concat(methodBodyValidateAndFill).concat([JsLang.astReturn(JsLang.astId('context'))]), false, true, true, 'Applying predefined modifiers to entity fields.'),
      fieldReferences
    };
  }

  _generateFunctionTemplateFile(schema, {
    functionName,
    functorType,
    fileName,
    args
  }) {
    let filePath = path.resolve(this.outputPath, schema.name, fileName);

    if (fs.existsSync(filePath)) {
      this.linker.log('info', `${_.upperFirst(functorType)} "${fileName}" exists. File generating skipped.`);
      return;
    }

    let ast = JsLang.astProgram();
    JsLang.astPushInBody(ast, JsLang.astFunction(functionName, args, OOL_MODIFIER_RETURN[functorType](args)));
    JsLang.astPushInBody(ast, JsLang.astAssign('module.exports', JsLang.astVarRef(functionName)));
    fs.ensureFileSync(filePath);
    fs.writeFileSync(filePath, JsLang.astToCode(ast));
    this.linker.log('info', `Generated ${functorType} file: ${filePath}`);
  }

  _buildInterfaces(entity, modelMetaInit, sharedContext) {
    let ast = [];

    _.forOwn(entity.interfaces, (method, name) => {
      this.linker.info('Building interface: ' + name);
      let astBody = [JsLang.astVarDeclare('$meta', JsLang.astVarRef('this.meta.interfaces.' + name), true, false, 'Retrieving the meta data')];
      let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);
      let paramMeta;

      if (method.accept) {
        paramMeta = this._processParams(method.accept, compileContext);
      }

      modelMetaInit['interfaces'] || (modelMetaInit['interfaces'] = {});
      modelMetaInit['interfaces'][name] = {
        params: Object.values(paramMeta)
      };

      _.each(method.implementation, (operation, index) => {
        GemlToAst.compileDbOperation(index, operation, compileContext, compileContext.mainStartId);
      });

      if (method.return) {
        GemlToAst.compileExceptionalReturn(method.return, compileContext);
      }

      let deps = compileContext.topoSort.sort();
      deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));

      _.each(deps, dep => {
        let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
        let astBlock = compileContext.astMap[dep];
        let targetFieldName = sourceMap.target;

        if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {
          astBlock = Snippets._validateCheck(targetFieldName, astBlock);
        } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);
          }
        } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);
          }
        }

        astBody = astBody.concat(_.castArray(astBlock));
      });

      ast.push(JsLang.astMemberMethod(asyncMethodNaming(name), Object.keys(paramMeta), astBody, false, true, true, replaceAll(_.kebabCase(name), '-', ' ')));
    });

    return ast;
  }

  _processParams(acceptParams, compileContext) {
    let paramMeta = {};
    acceptParams.forEach((param, i) => {
      GemlToAst.compileParam(i, param, compileContext);
      paramMeta[param.name] = param;
      compileContext.variables[param.name] = {
        source: 'argument'
      };
    });
    return paramMeta;
  }

}

module.exports = DaoModeler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlbGVyL0Rhby5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsInBhc2NhbENhc2UiLCJyZXBsYWNlQWxsIiwicHV0SW50b0J1Y2tldCIsInN3aWciLCJHZW1sVHlwZXMiLCJKc0xhbmciLCJHZW1sVG9Bc3QiLCJTbmlwcGV0cyIsIkNoYWluYWJsZVR5cGUiLCJBU1RfQkxLX1ZBTElEQVRPUl9DQUxMIiwiQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCIsIkFTVF9CTEtfQUNUSVZBVE9SX0NBTEwiLCJnZXRGaWVsZE5hbWUiLCJ0Iiwic3BsaXQiLCJwb3AiLCJpc0NoYWluYWJsZSIsImN1cnJlbnQiLCJuZXh0IiwiaW5kZXhPZiIsInR5cGUiLCJ0YXJnZXQiLCJjaGFpbkNhbGwiLCJsYXN0QmxvY2siLCJsYXN0VHlwZSIsImN1cnJlbnRCbG9jayIsImN1cnJlbnRUeXBlIiwiYXN0QmluRXhwIiwiYXJndW1lbnRzIiwiYXN5bmNNZXRob2ROYW1pbmciLCJuYW1lIiwiaW5kZW50TGluZXMiLCJsaW5lcyIsImluZGVudGF0aW9uIiwibWFwIiwibGluZSIsImkiLCJyZXBlYXQiLCJqb2luIiwiT09MX01PRElGSUVSX1JFVFVSTiIsIk1vZGlmaWVyIiwiVkFMSURBVE9SIiwiYXN0UmV0dXJuIiwiUFJPQ0VTU09SIiwiYXJncyIsImFzdElkIiwiQUNUSVZBVE9SIiwiRGFvTW9kZWxlciIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImNvbm5lY3RvciIsImxpbmtlciIsIm91dHB1dFBhdGgiLCJtb2RlbFBhdGgiLCJtYW5pZmVzdFBhdGgiLCJtb2RlbGluZ18iLCJzY2hlbWEiLCJsb2ciLCJfZ2VuZXJhdGVTY2hlbWFNb2RlbCIsIl9nZW5lcmF0ZUVudGl0eU1vZGVsIiwiX2dlbmVyYXRlRW50aXR5TWFuaWZlc3QiLCJjYXBpdGFsaXplZCIsImxvY2FscyIsImRyaXZlciIsImNsYXNzTmFtZSIsInNjaGVtYU5hbWUiLCJlbnRpdGllcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJPYmplY3QiLCJrZXlzIiwiY2xhc3NUZW1wbGF0ZSIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJjbGFzc0NvZGUiLCJyZW5kZXJGaWxlIiwibW9kZWxGaWxlUGF0aCIsImVuc3VyZUZpbGVTeW5jIiwid3JpdGVGaWxlU3luYyIsIl9nZW5lcmF0ZUVudW1UeXBlcyIsImZvck93biIsImVudGl0eSIsImVudGl0eUluc3RhbmNlTmFtZSIsImZpZWxkcyIsImZpZWxkIiwiZmllbGROYW1lIiwic2hhcmVkQ29udGV4dCIsIm1hcE9mRnVuY3RvclRvRmlsZSIsIm5ld0Z1bmN0b3JGaWxlcyIsImFzdCIsImFzdENsYXNzTWFpbiIsImZpZWxkUmVmZXJlbmNlcyIsIl9wcm9jZXNzRmllbGRNb2RpZmllcnMiLCJ1bmlxdWVLZXlzIiwiY2FzdEFycmF5Iiwia2V5IiwiaW5kZXhlcyIsImZvckVhY2giLCJpbmRleCIsInVuaXF1ZSIsInB1c2giLCJtb2RlbE1ldGEiLCJrZXlGaWVsZCIsIm1hcFZhbHVlcyIsImYiLCJvbWl0IiwidG9KU09OIiwiZmVhdHVyZXMiLCJiYXNlQ2xhc3NlcyIsImlzRW1wdHkiLCJhc3NvY2lhdGlvbnMiLCJmaWVsZERlcGVuZGVuY2llcyIsImludGVyZmFjZXMiLCJhc3RJbnRlcmZhY2VzIiwiX2J1aWxkSW50ZXJmYWNlcyIsImNvbmNhdCIsImltcG9ydExpbmVzIiwiZmlsZU5hbWUiLCJmdW5jdGlvbk5hbWUiLCJhc3RUb0NvZGUiLCJhc3RSZXF1aXJlIiwiZWFjaCIsImVudHJ5IiwiX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUiLCJpbXBvcnRzIiwiZW50aXR5TWV0YSIsImNsYXNzQm9keSIsImJsb2NrIiwiZnVuY3RvcnMiLCJhc3RWYWx1ZSIsInJlZHVjZSIsInJlc3VsdCIsImZ1bmN0b3IiLCJzb3J0IiwidiIsIm91dHB1dEZpbGVQYXRoIiwiY29tcGlsZUNvbnRleHQiLCJjcmVhdGVDb21waWxlQ29udGV4dCIsImdlbWxNb2R1bGUiLCJ2YXJpYWJsZXMiLCJzb3VyY2UiLCJmaW5hbGl6ZWQiLCJhbGxGaW5pc2hlZCIsImNyZWF0ZVRvcG9JZCIsInRvcG9JZCIsImNvbXBpbGVGaWVsZCIsImRlcGVuZHNPbiIsIndyaXRlT25jZSIsImZyZWV6ZUFmdGVyTm9uRGVmYXVsdCIsInJlZmVyZW5jZSIsIndyaXRlUHJvdGVjdCIsImRlcHMiLCJ0b3BvU29ydCIsImZpbHRlciIsImRlcCIsIm1hcE9mVG9rZW5Ub01ldGEiLCJoYXMiLCJtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsIiwibGFzdEZpZWxkc0dyb3VwIiwibWV0aG9kQm9keUNhY2hlIiwibGFzdEFzdFR5cGUiLCJfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUiLCJyZWZlcmVuY2VzIiwiYXN0Q2FjaGUiLCJyZXF1aXJlVGFyZ2V0RmllbGQiLCJjaGVja2VyIiwiX2ZpZWxkUmVxdWlyZW1lbnRDaGVjayIsInNvdXJjZU1hcCIsImdldCIsImFzdEJsb2NrIiwiYXN0TWFwIiwidGFyZ2V0RmllbGROYW1lIiwibGVuZ3RoIiwiZmllbGRSZWZlcmVuY2UiLCJyZWYiLCJ3aGVuTnVsbCIsInVuZGVmaW5lZCIsIm5leHRUeXBlIiwiX3ZhbGlkYXRlQ2hlY2siLCJhc3RBc3NpZ24iLCJhc3RWYXJSZWYiLCJfY2hlY2tBbmRBc3NpZ24iLCJFcnJvciIsImFzdE1lbWJlck1ldGhvZCIsIl9hcHBseU1vZGlmaWVyc0hlYWRlciIsImZ1bmN0b3JUeXBlIiwiZmlsZVBhdGgiLCJleGlzdHNTeW5jIiwidXBwZXJGaXJzdCIsImFzdFByb2dyYW0iLCJhc3RQdXNoSW5Cb2R5IiwiYXN0RnVuY3Rpb24iLCJtb2RlbE1ldGFJbml0IiwibWV0aG9kIiwiaW5mbyIsImFzdEJvZHkiLCJhc3RWYXJEZWNsYXJlIiwicGFyYW1NZXRhIiwiYWNjZXB0IiwiX3Byb2Nlc3NQYXJhbXMiLCJwYXJhbXMiLCJ2YWx1ZXMiLCJpbXBsZW1lbnRhdGlvbiIsIm9wZXJhdGlvbiIsImNvbXBpbGVEYk9wZXJhdGlvbiIsIm1haW5TdGFydElkIiwicmV0dXJuIiwiY29tcGlsZUV4Y2VwdGlvbmFsUmV0dXJuIiwibmVlZERlY2xhcmUiLCJrZWJhYkNhc2UiLCJhY2NlcHRQYXJhbXMiLCJwYXJhbSIsImNvbXBpbGVQYXJhbSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxVQUFUO0FBQXFCQyxFQUFBQSxVQUFyQjtBQUFpQ0MsRUFBQUE7QUFBakMsSUFBb0RMLE9BQU8sQ0FBQyxVQUFELENBQWpFOztBQUNBLE1BQU1NLElBQUksR0FBSU4sT0FBTyxDQUFDLGdCQUFELENBQXJCOztBQUVBLE1BQU1PLFNBQVMsR0FBR1AsT0FBTyxDQUFDLG1CQUFELENBQXpCOztBQUNBLE1BQU1RLE1BQU0sR0FBR1IsT0FBTyxDQUFDLGVBQUQsQ0FBdEI7O0FBQ0EsTUFBTVMsU0FBUyxHQUFHVCxPQUFPLENBQUMscUJBQUQsQ0FBekI7O0FBQ0EsTUFBTVUsUUFBUSxHQUFHVixPQUFPLENBQUMsZ0JBQUQsQ0FBeEI7O0FBRUEsTUFBTVcsYUFBYSxHQUFHLENBQ2xCRixTQUFTLENBQUNHLHNCQURRLEVBRWxCSCxTQUFTLENBQUNJLHNCQUZRLEVBR2xCSixTQUFTLENBQUNLLHNCQUhRLENBQXRCOztBQU1BLE1BQU1DLFlBQVksR0FBR0MsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLEtBQUYsQ0FBUSxHQUFSLEVBQWFDLEdBQWIsRUFBMUI7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHLENBQUNDLE9BQUQsRUFBVUMsSUFBVixLQUFtQlYsYUFBYSxDQUFDVyxPQUFkLENBQXNCRixPQUFPLENBQUNHLElBQTlCLElBQXNDLENBQUMsQ0FBdkMsSUFDaENILE9BQU8sQ0FBQ0ksTUFBUixLQUFtQkgsSUFBSSxDQUFDRyxNQURRLElBRWhDSCxJQUFJLENBQUNFLElB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Q0FBQyxDQUFDZ0csU0FBRixDQUFZMkUsUUFBWixDQUFmLENBQVY7QUFDSCxPQTNCRDs7QUE2QkFoRixNQUFBQSxHQUFHLENBQUNXLElBQUosQ0FBUy9GLE1BQU0sQ0FBQ2tMLGVBQVAsQ0FBdUIxSixpQkFBaUIsQ0FBQ0MsSUFBRCxDQUF4QyxFQUFnRHVDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZK0gsU0FBWixDQUFoRCxFQUF3RUYsT0FBeEUsRUFBaUYsS0FBakYsRUFBd0YsSUFBeEYsRUFBOEYsSUFBOUYsRUFBb0dsTSxVQUFVLENBQUNILENBQUMsQ0FBQ21OLFNBQUYsQ0FBWW5MLElBQVosQ0FBRCxFQUFvQixHQUFwQixFQUF5QixHQUF6QixDQUE5RyxDQUFUO0FBQ0gsS0FoRUQ7O0FBa0VBLFdBQU8yRCxHQUFQO0FBQ0g7O0FBRUQ4RyxFQUFBQSxjQUFjLENBQUNXLFlBQUQsRUFBZTFFLGNBQWYsRUFBK0I7QUFDekMsUUFBSTZELFNBQVMsR0FBRyxFQUFoQjtBQUVBYSxJQUFBQSxZQUFZLENBQUNqSCxPQUFiLENBQXFCLENBQUNrSCxLQUFELEVBQVEvSyxDQUFSLEtBQWM7QUFDL0I5QixNQUFBQSxTQUFTLENBQUM4TSxZQUFWLENBQXVCaEwsQ0FBdkIsRUFBMEIrSyxLQUExQixFQUFpQzNFLGNBQWpDO0FBQ0E2RCxNQUFBQSxTQUFTLENBQUNjLEtBQUssQ0FBQ3JMLElBQVAsQ0FBVCxHQUF3QnFMLEtBQXhCO0FBQ0EzRSxNQUFBQSxjQUFjLENBQUNHLFNBQWYsQ0FBeUJ3RSxLQUFLLENBQUNyTCxJQUEvQixJQUF1QztBQUFFOEcsUUFBQUEsTUFBTSxFQUFFO0FBQVYsT0FBdkM7QUFDSCxLQUpEO0FBTUEsV0FBT3lELFNBQVA7QUFDSDs7QUE3bEJZOztBQWdtQmpCZ0IsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdkssVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIHBhc2NhbENhc2UsIHJlcGxhY2VBbGwsIHB1dEludG9CdWNrZXQgfSAgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3Qgc3dpZyAgPSByZXF1aXJlKCdzd2lnLXRlbXBsYXRlcycpO1xuXG5jb25zdCBHZW1sVHlwZXMgPSByZXF1aXJlKCcuLi9sYW5nL0dlbWxUeXBlcycpO1xuY29uc3QgSnNMYW5nID0gcmVxdWlyZSgnLi91dGlsL2FzdC5qcycpO1xuY29uc3QgR2VtbFRvQXN0ID0gcmVxdWlyZSgnLi91dGlsL2dlbWxUb0FzdC5qcycpO1xuY29uc3QgU25pcHBldHMgPSByZXF1aXJlKCcuL2Rhby9zbmlwcGV0cycpO1xuXG5jb25zdCBDaGFpbmFibGVUeXBlID0gW1xuICAgIEdlbWxUb0FzdC5BU1RfQkxLX1ZBTElEQVRPUl9DQUxMLCBcbiAgICBHZW1sVG9Bc3QuQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCxcbiAgICBHZW1sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTFxuXTtcblxuY29uc3QgZ2V0RmllbGROYW1lID0gdCA9PiB0LnNwbGl0KCcuJykucG9wKCk7XG5jb25zdCBpc0NoYWluYWJsZSA9IChjdXJyZW50LCBuZXh0KSA9PiBDaGFpbmFibGVUeXBlLmluZGV4T2YoY3VycmVudC50eXBlKSA+IC0xXG4gICAgJiYgY3VycmVudC50YXJnZXQgPT09IG5leHQudGFyZ2V0XG4gICAgJiYgbmV4dC50eXBlID09PSBjdXJyZW50LnR5cGU7XG5jb25zdCBjaGFpbkNhbGwgPSAobGFzdEJsb2NrLCBsYXN0VHlwZSwgY3VycmVudEJsb2NrLCBjdXJyZW50VHlwZSkgPT4ge1xuICAgIGlmIChsYXN0QmxvY2spIHtcbiAgICAgICAgaWYgKGxhc3RUeXBlID09PSAnVmFsaWRhdG9yQ2FsbCcpIHtcbiAgICAgICAgICAgIGFzc2VydDogY3VycmVudFR5cGUgPT09ICdWYWxpZGF0b3JDYWxsJywgJ1VuZXhwZWN0ZWQgY3VycmVudFR5cGUnO1xuXG4gICAgICAgICAgICBjdXJyZW50QmxvY2sgPSBKc0xhbmcuYXN0QmluRXhwKGxhc3RCbG9jaywgJyYmJywgY3VycmVudEJsb2NrKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydDogY3VycmVudFR5cGUgPT09ICdQcm9jZXNzb3JDYWxsJywgJ1VuZXhwZWN0ZWQgY3VycmVudFR5cGU6ICcgKyBjdXJyZW50VHlwZSArICcgbGFzdDogJyArIGxhc3RUeXBlO1xuXG4gICAgICAgICAgICBjdXJyZW50QmxvY2suYXJndW1lbnRzWzBdID0gbGFzdEJsb2NrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnRCbG9jaztcbn07XG5jb25zdCBhc3luY01ldGhvZE5hbWluZyA9IChuYW1lKSA9PiBuYW1lICsgJ18nO1xuXG5jb25zdCBpbmRlbnRMaW5lcyA9IChsaW5lcywgaW5kZW50YXRpb24pID0+IGxpbmVzLnNwbGl0KCdcXG4nKS5tYXAoKGxpbmUsIGkpID0+IGkgPT09IDAgPyBsaW5lIDogKF8ucmVwZWF0KCcgJywgaW5kZW50YXRpb24pICsgbGluZSkpLmpvaW4oJ1xcbicpO1xuXG5jb25zdCBPT0xfTU9ESUZJRVJfUkVUVVJOID0ge1xuICAgIFtHZW1sVHlwZXMuTW9kaWZpZXIuVkFMSURBVE9SXTogKCkgPT4gWyBKc0xhbmcuYXN0UmV0dXJuKHRydWUpIF0sXG4gICAgW0dlbWxUeXBlcy5Nb2RpZmllci5QUk9DRVNTT1JdOiBhcmdzID0+IFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoYXJnc1swXSkpIF0sXG4gICAgW0dlbWxUeXBlcy5Nb2RpZmllci5BQ1RJVkFUT1JdOiAoKSA9PiBbIEpzTGFuZy5hc3RSZXR1cm4oSnNMYW5nLmFzdElkKFwidW5kZWZpbmVkXCIpKSBdXG59O1xuXG4vKipcbiAqIE9vbG9uZyBkYXRhYmFzZSBhY2Nlc3Mgb2JqZWN0IChEQU8pIG1vZGVsZXIuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgRGFvTW9kZWxlciB7XG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29udGV4dCAgIFxuICAgICAqIEBwcm9wZXJ0eSB7R2VtbExpbmtlcn0gY29udGV4dC5saW5rZXIgLSBHZW1sIGxpbmtlclxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb250ZXh0Lm1vZGVsUGF0aCAtIEdlbmVyYXRlZCBtb2RlbCBvdXRwdXQgcGF0aFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb250ZXh0Lm1hbmlmZXN0UGF0aCAtIEVudGl0aWVzIG1hbmlmZXN0IG91dHB1dCBwYXRoXG4gICAgICogQHBhcmFtIHtDb25uZWN0b3J9IGNvbm5lY3RvciAgICAgIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbnRleHQsIGNvbm5lY3RvcikgeyAgICAgICBcbiAgICAgICAgdGhpcy5saW5rZXIgPSBjb250ZXh0LmxpbmtlcjtcbiAgICAgICAgdGhpcy5vdXRwdXRQYXRoID0gY29udGV4dC5tb2RlbFBhdGg7XG4gICAgICAgIHRoaXMubWFuaWZlc3RQYXRoID0gY29udGV4dC5tYW5pZmVzdFBhdGg7XG5cbiAgICAgICAgdGhpcy5jb25uZWN0b3IgPSBjb25uZWN0b3I7ICAgICAgICBcbiAgICB9XG5cbiAgICBtb2RlbGluZ18oc2NoZW1hKSB7XG4gICAgICAgIHRoaXMubGlua2VyLmxvZygnaW5mbycsICdHZW5lcmF0aW5nIGVudGl0eSBtb2RlbHMgZm9yIHNjaGVtYSBcIicgKyBzY2hlbWEubmFtZSArICdcIi4uLicpO1xuXG4gICAgICAgIHRoaXMuX2dlbmVyYXRlU2NoZW1hTW9kZWwoc2NoZW1hKTsgICAgICAgIFxuICAgICAgICB0aGlzLl9nZW5lcmF0ZUVudGl0eU1vZGVsKHNjaGVtYSk7XG4gICAgICAgIC8vdGhpcy5fZ2VuZXJhdGVFbnVtVHlwZXMoc2NoZW1hKTtcbiAgICAgICAgLy90aGlzLl9nZW5lcmF0ZVZpZXdNb2RlbCgpO1xuXG4gICAgICAgIGlmICh0aGlzLm1hbmlmZXN0UGF0aCkge1xuICAgICAgICAgICAgdGhpcy5fZ2VuZXJhdGVFbnRpdHlNYW5pZmVzdChzY2hlbWEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2dlbmVyYXRlU2NoZW1hTW9kZWwoc2NoZW1hKSB7XG4gICAgICAgIGxldCBjYXBpdGFsaXplZCA9IHBhc2NhbENhc2Uoc2NoZW1hLm5hbWUpO1xuXG4gICAgICAgIGxldCBsb2NhbHMgPSB7XG4gICAgICAgICAgICBkcml2ZXI6IHRoaXMuY29ubmVjdG9yLmRyaXZlcixcbiAgICAgICAgICAgIGNsYXNzTmFtZTogY2FwaXRhbGl6ZWQsXG4gICAgICAgICAgICBzY2hlbWFOYW1lOiBzY2hlbWEubmFtZSxcbiAgICAgICAgICAgIGVudGl0aWVzOiBKU09OLnN0cmluZ2lmeShPYmplY3Qua2V5cyhzY2hlbWEuZW50aXRpZXMpKVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBjbGFzc1RlbXBsYXRlID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2RhdGFiYXNlJywgdGhpcy5jb25uZWN0b3IuZHJpdmVyLCAnRGF0YWJhc2UuanMuc3dpZycpO1xuICAgICAgICBsZXQgY2xhc3NDb2RlID0gc3dpZy5yZW5kZXJGaWxlKGNsYXNzVGVtcGxhdGUsIGxvY2Fscyk7XG5cbiAgICAgICAgbGV0IG1vZGVsRmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXRQYXRoLCBjYXBpdGFsaXplZCArICcuanMnKTtcbiAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCwgY2xhc3NDb2RlKTtcblxuICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIGRhdGFiYXNlIG1vZGVsOiAnICsgbW9kZWxGaWxlUGF0aCk7XG4gICAgfVxuXG4gICAgX2dlbmVyYXRlRW51bVR5cGVzKHNjaGVtYSkge1xuICAgICAgICBfLmZvck93bihzY2hlbWEuZW50aXRpZXMsIChlbnRpdHksIGVudGl0eUluc3RhbmNlTmFtZSkgPT4ge1xuICAgICAgICAgICAgXy5mb3JPd24oZW50aXR5LmZpZWxkcywgKGZpZWxkLCBmaWVsZE5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gJ2VudW0nKSB7XG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2dlbmVyYXRlRW50aXR5TW9kZWwoc2NoZW1hKSB7XG4gICAgICAgIF8uZm9yT3duKHNjaGVtYS5lbnRpdGllcywgKGVudGl0eSwgZW50aXR5SW5zdGFuY2VOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgY2FwaXRhbGl6ZWQgPSBwYXNjYWxDYXNlKGVudGl0eUluc3RhbmNlTmFtZSk7ICAgICAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vc2hhcmVkIGluZm9ybWF0aW9uIHdpdGggbW9kZWwgQ1JVRCBhbmQgY3VzdG9taXplZCBpbnRlcmZhY2VzXG4gICAgICAgICAgICBsZXQgc2hhcmVkQ29udGV4dCA9IHtcbiAgICAgICAgICAgICAgICBtYXBPZkZ1bmN0b3JUb0ZpbGU6IHt9LFxuICAgICAgICAgICAgICAgIG5ld0Z1bmN0b3JGaWxlczogW11cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCB7IGFzdDogYXN0Q2xhc3NNYWluLCBmaWVsZFJlZmVyZW5jZXMgfSA9IHRoaXMuX3Byb2Nlc3NGaWVsZE1vZGlmaWVycyhlbnRpdHksIHNoYXJlZENvbnRleHQpO1xuICAgICAgICAgICAgYXN0Q2xhc3NNYWluID0gWyBhc3RDbGFzc01haW4gXTtcblxuICAgICAgICAgICAgLy9wcmVwYXJlIG1ldGEgZGF0YVxuICAgICAgICAgICAgbGV0IHVuaXF1ZUtleXMgPSBbIF8uY2FzdEFycmF5KGVudGl0eS5rZXkpIF07XG5cbiAgICAgICAgICAgIGlmIChlbnRpdHkuaW5kZXhlcykge1xuICAgICAgICAgICAgICAgIGVudGl0eS5pbmRleGVzLmZvckVhY2goaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgudW5pcXVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWVLZXlzLnB1c2goaW5kZXguZmllbGRzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgbW9kZWxNZXRhID0ge1xuICAgICAgICAgICAgICAgIHNjaGVtYU5hbWU6IHNjaGVtYS5uYW1lLFxuICAgICAgICAgICAgICAgIG5hbWU6IGVudGl0eUluc3RhbmNlTmFtZSxcbiAgICAgICAgICAgICAgICBrZXlGaWVsZDogZW50aXR5LmtleSwgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZmllbGRzOiBfLm1hcFZhbHVlcyhlbnRpdHkuZmllbGRzLCBmID0+IF8ub21pdChmLnRvSlNPTigpLCAnbW9kaWZpZXJzJykpLFxuICAgICAgICAgICAgICAgIGZlYXR1cmVzOiBlbnRpdHkuZmVhdHVyZXMgfHwge30sXG4gICAgICAgICAgICAgICAgdW5pcXVlS2V5c1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKGVudGl0eS5iYXNlQ2xhc3Nlcykge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5iYXNlQ2xhc3NlcyA9IGVudGl0eS5iYXNlQ2xhc3NlcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmluZGV4ZXMpKSB7XG4gICAgICAgICAgICAgICAgbW9kZWxNZXRhLmluZGV4ZXMgPSBlbnRpdHkuaW5kZXhlcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmZlYXR1cmVzKSkge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5mZWF0dXJlcyA9IGVudGl0eS5mZWF0dXJlcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmFzc29jaWF0aW9ucykpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuYXNzb2NpYXRpb25zID0gZW50aXR5LmFzc29jaWF0aW9ucztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZmllbGRSZWZlcmVuY2VzKSkge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5maWVsZERlcGVuZGVuY2llcyA9IGZpZWxkUmVmZXJlbmNlcztcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgLy9idWlsZCBjdXN0b21pemVkIGludGVyZmFjZXMgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChlbnRpdHkuaW50ZXJmYWNlcykge1xuICAgICAgICAgICAgICAgIGxldCBhc3RJbnRlcmZhY2VzID0gdGhpcy5fYnVpbGRJbnRlcmZhY2VzKGVudGl0eSwgbW9kZWxNZXRhLCBzaGFyZWRDb250ZXh0KTtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGFzdEludGVyZmFjZXMpO1xuICAgICAgICAgICAgICAgIC8vbGV0IGFzdENsYXNzID0gYXN0Q2xhc3NNYWluW2FzdENsYXNzTWFpbi5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgICAgICAvL0pzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdENsYXNzLCBhc3RJbnRlcmZhY2VzKTtcbiAgICAgICAgICAgICAgICBhc3RDbGFzc01haW4gPSBhc3RDbGFzc01haW4uY29uY2F0KGFzdEludGVyZmFjZXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgaW1wb3J0TGluZXMgPSBbXTtcblxuICAgICAgICAgICAgLy9nZW5lcmF0ZSBmdW5jdG9ycyBpZiBhbnlcbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KHNoYXJlZENvbnRleHQubWFwT2ZGdW5jdG9yVG9GaWxlKSkge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKHNoYXJlZENvbnRleHQubWFwT2ZGdW5jdG9yVG9GaWxlLCAoZmlsZU5hbWUsIGZ1bmN0aW9uTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpbXBvcnRMaW5lcy5wdXNoKEpzTGFuZy5hc3RUb0NvZGUoSnNMYW5nLmFzdFJlcXVpcmUoZnVuY3Rpb25OYW1lLCAnLicgKyBmaWxlTmFtZSkpKVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShzaGFyZWRDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcykpIHtcbiAgICAgICAgICAgICAgICBfLmVhY2goc2hhcmVkQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMsIGVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZShzY2hlbWEsIGVudHJ5KTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvKlxuICAgICAgICAgICAgbGV0IG1peGlucyA9IFtdO1xuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShlbnRpdHkuaW5mby5taXhpbnMpKSB7XG4gICAgICAgICAgICAgICAgbGV0IG1peGluc0RpclBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXRQYXRoLCBzY2hlbWEubmFtZSwgJ21peGlucycpO1xuICAgICAgICAgICAgICAgIGZzLmVuc3VyZURpclN5bmMobWl4aW5zRGlyUGF0aCk7XG5cbiAgICAgICAgICAgICAgICBlbnRpdHkuaW5mby5taXhpbnMuZm9yRWFjaChtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1peGluTmFtZSA9IHBhc2NhbENhc2UobSk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG1peGluRmlsZVBhdGggPSBwYXRoLmpvaW4obWl4aW5zRGlyUGF0aCwgbWl4aW5OYW1lICsgJy5qcycpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWZzLnBhdGhFeGlzdHNTeW5jKG1peGluRmlsZVBhdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG1peGluRmlsZVBhdGgsIGBjb25zdCB7XG4gICAgRXJyb3JzOiB7IFZhbGlkYXRpb25FcnJvciwgRGF0YWJhc2VFcnJvciB9LFxuICAgIFByb2Nlc3NvcnMsXG4gICAgVmFsaWRhdG9yc1xufSA9IHJlcXVpcmUoXCJAZ2VueC9kYXRhXCIpO1xuY29uc3QgeyBfIH0gPSByZXF1aXJlKFwicmstdXRpbHNcIik7XG5cbm1vZHVsZS5leHBvcnRzID0gJHtjYXBpdGFsaXplZH0gPT4gY2xhc3MgZXh0ZW5kcyAke2NhcGl0YWxpemVkfSB7XG4gICAgLy90b2RvOiBhZGQgc3RhaWMgbWV0aG9kc1xufTtgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBtaXhpblZhck5hbWUgPSAnbWl4aW4nICsgbWl4aW5OYW1lO1xuICAgICAgICAgICAgICAgICAgICBpbXBvcnRMaW5lcy5wdXNoKEpzTGFuZy5hc3RUb0NvZGUoSnNMYW5nLmFzdFJlcXVpcmUobWl4aW5WYXJOYW1lLCAnLi9taXhpbnMvJyArIG1peGluTmFtZSkpKTtcbiAgICAgICAgICAgICAgICAgICAgbWl4aW5zLnB1c2gobWl4aW5WYXJOYW1lKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0qL1xuXG4gICAgICAgICAgICAvL2Fzc2VtYmxlIHRoZSBzb3VyY2UgY29kZSBmaWxlXG4gICAgICAgICAgICAvL0pzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgYXN0Q2xhc3NNYWluKTtcblxuICAgICAgICAgICAgLy9Kc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIGVudGl0eS5maWVsZHMubWFwKCh2LCBrKSA9PiBKc0xhbmcuYXN0QXNzaWduKGNhcGl0YWxpemVkICsgJy5GXycgKyBfLnNuYWtlQ2FzZShrKS50b1VwcGVyQ2FzZSgpLCBrKSkpOyAgIFxuXG4gICAgICAgICAgICBsZXQgbG9jYWxzID0ge1xuICAgICAgICAgICAgICAgIGltcG9ydHM6IGltcG9ydExpbmVzLmpvaW4oJ1xcbicpLFxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogY2FwaXRhbGl6ZWQsXG4gICAgICAgICAgICAgICAgZW50aXR5TWV0YTogaW5kZW50TGluZXMoSlNPTi5zdHJpbmdpZnkobW9kZWxNZXRhLCBudWxsLCA0KSwgNCksXG4gICAgICAgICAgICAgICAgY2xhc3NCb2R5OiBpbmRlbnRMaW5lcyhhc3RDbGFzc01haW4ubWFwKGJsb2NrID0+IEpzTGFuZy5hc3RUb0NvZGUoYmxvY2spKS5qb2luKCdcXG5cXG4nKSwgOCksXG4gICAgICAgICAgICAgICAgZnVuY3RvcnM6IGluZGVudExpbmVzKEpzTGFuZy5hc3RUb0NvZGUoSnNMYW5nLmFzdFZhbHVlKF8ucmVkdWNlKHNoYXJlZENvbnRleHQubmV3RnVuY3RvckZpbGVzLCAocmVzdWx0LCBmdW5jdG9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFsnJCcgKyBmdW5jdG9yLmZ1bmN0aW9uTmFtZV0gPSBKc0xhbmcuYXN0SWQoZnVuY3Rvci5mdW5jdGlvbk5hbWUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgIH0sIHt9KSkpLCA0KSxcbiAgICAgICAgICAgICAgICAvL21peGlucyBcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCBjbGFzc1RlbXBsYXRlID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2RhdGFiYXNlJywgdGhpcy5jb25uZWN0b3IuZHJpdmVyLCAnRW50aXR5TW9kZWwuanMuc3dpZycpO1xuICAgICAgICAgICAgbGV0IGNsYXNzQ29kZSA9IHN3aWcucmVuZGVyRmlsZShjbGFzc1RlbXBsYXRlLCBsb2NhbHMpO1xuXG4gICAgICAgICAgICBsZXQgbW9kZWxGaWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLm91dHB1dFBhdGgsIHNjaGVtYS5uYW1lLCAnYmFzZScsIGNhcGl0YWxpemVkICsgJy5qcycpO1xuICAgICAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCk7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgsIGNsYXNzQ29kZSk7XG5cbiAgICAgICAgICAgIHRoaXMubGlua2VyLmxvZygnaW5mbycsICdHZW5lcmF0ZWQgZW50aXR5IG1vZGVsOiAnICsgbW9kZWxGaWxlUGF0aCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZUVudGl0eU1hbmlmZXN0KHNjaGVtYSkge1xuICAgICAgICBsZXQgZW50aXRpZXMgPSBPYmplY3Qua2V5cyhzY2hlbWEuZW50aXRpZXMpLnNvcnQoKS5yZWR1Y2UoKHJlc3VsdCwgdikgPT4geyByZXN1bHRbdl0gPSB7fTsgcmV0dXJuIHJlc3VsdDsgfSwge30pO1xuICAgICAgICAvKlxuICAgICAgICBsZXQgbWFuaWZlc3QgPSB7fTtcblxuICAgICAgICBfLmVhY2goc2NoZW1hLmVudGl0aWVzLCAoZW50aXR5LCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoZW50aXR5LmluZm8ucmVzdGZ1bCkge1xuICAgICAgICAgICAgICAgIF8uZWFjaChlbnRpdHkuaW5mby5yZXN0ZnVsLCAoeyB0eXBlLCBtZXRob2RzIH0sIHJlbGF0aXZlVXJpKSA9PiB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IGFwaUluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kczoge30gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnZW50aXR5Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBpSW5mby5lbnRpdHkgPSBlbnRpdHlOYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBpSW5mby5kaXNwbGF5TmFtZSA9IGVudGl0eS5kaXNwbGF5TmFtZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5jb21tZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpSW5mby5kZXNjcmlwdGlvbiA9IGVudGl0eS5jb21tZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKG1ldGhvZHMsIChtZXRhLCBtZXRob2ROYW1lKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobWV0aG9kTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NyZWF0ZSc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaUluZm8ubWV0aG9kc1sncG9zdDonICsgcmVsYXRpdmVVcmldID0gbWV0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ZpbmRPbmUnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmluZUFsbCc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd1cGRhdGVPbmUnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndXBkYXRlTWFueSc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkZWxldGVPbmUnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZGVsZXRlTWFueSc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAqL1xuICAgICAgICBsZXQgb3V0cHV0RmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5tYW5pZmVzdFBhdGgsIHNjaGVtYS5uYW1lICsgJy5tYW5pZmVzdC5qc29uJyk7XG4gICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG91dHB1dEZpbGVQYXRoKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhvdXRwdXRGaWxlUGF0aCwgSlNPTi5zdHJpbmdpZnkoZW50aXRpZXMsIG51bGwsIDQpKTtcblxuICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIHNjaGVtYSBtYW5pZmVzdDogJyArIG91dHB1dEZpbGVQYXRoKTtcbiAgICB9XG5cbiAgICAvKlxuICAgIF9nZW5lcmF0ZVZpZXdNb2RlbChzY2hlbWEsIGRiU2VydmljZSkgeyAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKHNjaGVtYS52aWV3cywgKHZpZXdJbmZvLCB2aWV3TmFtZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5saW5rZXIuaW5mbygnQnVpbGRpbmcgdmlldzogJyArIHZpZXdOYW1lKTtcblxuICAgICAgICAgICAgbGV0IGNhcGl0YWxpemVkID0gXy51cHBlckZpcnN0KHZpZXdOYW1lKTtcblxuICAgICAgICAgICAgbGV0IGFzdCA9IEpzTGFuZy5hc3RQcm9ncmFtKCk7XG5cbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFJlcXVpcmUoJ01vd2EnLCAnbW93YScpKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFZhckRlY2xhcmUoJ1V0aWwnLCBKc0xhbmcuYXN0VmFyUmVmKCdNb3dhLlV0aWwnKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnXycsIEpzTGFuZy5hc3RWYXJSZWYoJ1V0aWwuXycpLCB0cnVlKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RSZXF1aXJlKCdWaWV3JywgJ21vd2EvbGliL29vbG9uZy9ydW50aW1lL3ZpZXcnKSk7XG5cbiAgICAgICAgICAgIGxldCBjb21waWxlQ29udGV4dCA9IE9vbFRvQXN0LmNyZWF0ZUNvbXBpbGVDb250ZXh0KHZpZXdOYW1lLCBkYlNlcnZpY2Uuc2VydmljZUlkLCB0aGlzLmxpbmtlcik7XG5cbiAgICAgICAgICAgIGNvbXBpbGVDb250ZXh0Lm1vZGVsVmFycy5hZGQodmlld0luZm8uZW50aXR5KTtcblxuICAgICAgICAgICAgbGV0IHBhcmFtTWV0YTtcblxuICAgICAgICAgICAgaWYgKHZpZXdJbmZvLnBhcmFtcykge1xuICAgICAgICAgICAgICAgIHBhcmFtTWV0YSA9IHRoaXMuX3Byb2Nlc3NQYXJhbXModmlld0luZm8ucGFyYW1zLCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCB2aWV3TWV0YSA9IHtcbiAgICAgICAgICAgICAgICBpc0xpc3Q6IHZpZXdJbmZvLmlzTGlzdCxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHBhcmFtTWV0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IHZpZXdCb2R5VG9wb0lkID0gT29sVG9Bc3QuY3JlYXRlVG9wb0lkKGNvbXBpbGVDb250ZXh0LCAnJHZpZXcnKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmRlcGVuZHNPbihjb21waWxlQ29udGV4dCwgY29tcGlsZUNvbnRleHQubWFpblN0YXJ0SWQsIHZpZXdCb2R5VG9wb0lkKTtcblxuICAgICAgICAgICAgbGV0IHZpZXdNb2RlbGVyID0gcmVxdWlyZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi9kYW8vdmlldycsIGRiU2VydmljZS5kYlR5cGUgKyAnLmpzJykpO1xuICAgICAgICAgICAgY29tcGlsZUNvbnRleHQuYXN0TWFwW3ZpZXdCb2R5VG9wb0lkXSA9IHZpZXdNb2RlbGVyKGRiU2VydmljZSwgdmlld05hbWUsIHZpZXdJbmZvKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmFkZENvZGVCbG9jayhjb21waWxlQ29udGV4dCwgdmlld0JvZHlUb3BvSWQsIHtcbiAgICAgICAgICAgICAgICB0eXBlOiBPb2xUb0FzdC5BU1RfQkxLX1ZJRVdfT1BFUkFUSU9OXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IHJldHVyblRvcG9JZCA9IE9vbFRvQXN0LmNyZWF0ZVRvcG9JZChjb21waWxlQ29udGV4dCwgJyRyZXR1cm46dmFsdWUnKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmRlcGVuZHNPbihjb21waWxlQ29udGV4dCwgdmlld0JvZHlUb3BvSWQsIHJldHVyblRvcG9JZCk7XG4gICAgICAgICAgICBPb2xUb0FzdC5jb21waWxlUmV0dXJuKHJldHVyblRvcG9JZCwge1xuICAgICAgICAgICAgICAgIFwib29sVHlwZVwiOiBcIk9iamVjdFJlZmVyZW5jZVwiLFxuICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcInZpZXdEYXRhXCJcbiAgICAgICAgICAgIH0sIGNvbXBpbGVDb250ZXh0KTtcblxuICAgICAgICAgICAgbGV0IGRlcHMgPSBjb21waWxlQ29udGV4dC50b3BvU29ydC5zb3J0KCk7XG4gICAgICAgICAgICB0aGlzLmxpbmtlci52ZXJib3NlKCdBbGwgZGVwZW5kZW5jaWVzOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIGRlcHMgPSBkZXBzLmZpbHRlcihkZXAgPT4gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5oYXMoZGVwKSk7XG4gICAgICAgICAgICB0aGlzLmxpbmtlci52ZXJib3NlKCdBbGwgbmVjZXNzYXJ5IHNvdXJjZSBjb2RlOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIGxldCBhc3REb0xvYWRNYWluID0gW1xuICAgICAgICAgICAgICAgIEpzTGFuZy5hc3RWYXJEZWNsYXJlKCckbWV0YScsIEpzTGFuZy5hc3RWYXJSZWYoJ3RoaXMubWV0YScpLCB0cnVlLCBmYWxzZSwgJ1JldHJpZXZpbmcgdGhlIG1ldGEgZGF0YScpXG4gICAgICAgICAgICBdO1xuXG4gICAgICAgICAgICBfLmVhY2goZGVwcywgZGVwID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYXN0TWV0YSA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcCk7XG5cbiAgICAgICAgICAgICAgICBsZXQgYXN0QmxvY2sgPSBjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXTtcbiAgICAgICAgICAgICAgICBhc3NlcnQ6IGFzdEJsb2NrLCAnRW1wdHkgYXN0IGJsb2NrJztcblxuICAgICAgICAgICAgICAgIGlmIChhc3RNZXRhLnR5cGUgPT09ICdNb2RpZmllckNhbGwnKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZE5hbWUgPSBnZXRGaWVsZE5hbWUoYXN0TWV0YS50YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgYXN0Q2FjaGUgPSBKc0xhbmcuYXN0QXNzaWduKEpzTGFuZy5hc3RWYXJSZWYoYXN0TWV0YS50YXJnZXQpLCBhc3RCbG9jaywgYE1vZGlmeWluZyAke2ZpZWxkTmFtZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgYXN0RG9Mb2FkTWFpbi5wdXNoKGFzdENhY2hlKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFzdERvTG9hZE1haW4gPSBhc3REb0xvYWRNYWluLmNvbmNhdChfLmNhc3RBcnJheShjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXSkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbXBpbGVDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSkpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihjb21waWxlQ29udGV4dC5tYXBPZkZ1bmN0b3JUb0ZpbGUsIChmaWxlTmFtZSwgZnVuY3Rpb25OYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFJlcXVpcmUoZnVuY3Rpb25OYW1lLCAnLicgKyBmaWxlTmFtZSkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb21waWxlQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMpKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKGNvbXBpbGVDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcywgZW50cnkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZW5lcmF0ZUZ1bmN0aW9uVGVtcGxhdGVGaWxlKGRiU2VydmljZSwgZW50cnkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RDbGFzc0RlY2xhcmUoY2FwaXRhbGl6ZWQsICdWaWV3JywgW1xuICAgICAgICAgICAgICAgIEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoJ19kb0xvYWQnLCBPYmplY3Qua2V5cyhwYXJhbU1ldGEpLFxuICAgICAgICAgICAgICAgICAgICBhc3REb0xvYWRNYWluLFxuICAgICAgICAgICAgICAgICAgICBmYWxzZSwgdHJ1ZSwgZmFsc2UsICdQb3B1bGF0ZSB2aWV3IGRhdGEnXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgXSwgYCR7Y2FwaXRhbGl6ZWR9IHZpZXdgKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RBc3NpZ24oY2FwaXRhbGl6ZWQgKyAnLm1ldGEnLCBKc0xhbmcuYXN0VmFsdWUodmlld01ldGEpKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RBc3NpZ24oJ21vZHVsZS5leHBvcnRzJywgSnNMYW5nLmFzdFZhclJlZihjYXBpdGFsaXplZCkpKTtcblxuICAgICAgICAgICAgbGV0IG1vZGVsRmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXRQYXRoLCBkYlNlcnZpY2UuZGJUeXBlLCBkYlNlcnZpY2UubmFtZSwgJ3ZpZXdzJywgdmlld05hbWUgKyAnLmpzJyk7XG4gICAgICAgICAgICBmcy5lbnN1cmVGaWxlU3luYyhtb2RlbEZpbGVQYXRoKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCArICcuanNvbicsIEpTT04uc3RyaW5naWZ5KGFzdCwgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBEYW9Nb2RlbGVyLl9leHBvcnRTb3VyY2VDb2RlKGFzdCwgbW9kZWxGaWxlUGF0aCk7XG5cbiAgICAgICAgICAgIHRoaXMubGlua2VyLmxvZygnaW5mbycsICdHZW5lcmF0ZWQgdmlldyBtb2RlbDogJyArIG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgICovXG5cbiAgICBfcHJvY2Vzc0ZpZWxkTW9kaWZpZXJzKGVudGl0eSwgc2hhcmVkQ29udGV4dCkge1xuICAgICAgICBsZXQgY29tcGlsZUNvbnRleHQgPSBHZW1sVG9Bc3QuY3JlYXRlQ29tcGlsZUNvbnRleHQoZW50aXR5LmdlbWxNb2R1bGUubmFtZSwgdGhpcy5saW5rZXIsIHNoYXJlZENvbnRleHQpO1xuICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbJ3JhdyddID0geyBzb3VyY2U6ICdjb250ZXh0JywgZmluYWxpemVkOiB0cnVlIH07XG4gICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1snaTE4biddID0geyBzb3VyY2U6ICdjb250ZXh0JywgZmluYWxpemVkOiB0cnVlIH07XG4gICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1snY29ubmVjdG9yJ10gPSB7IHNvdXJjZTogJ2NvbnRleHQnLCBmaW5hbGl6ZWQ6IHRydWUgfTtcbiAgICAgICAgY29tcGlsZUNvbnRleHQudmFyaWFibGVzWydsYXRlc3QnXSA9IHsgc291cmNlOiAnY29udGV4dCcgfTtcblxuICAgICAgICBjb25zdCBhbGxGaW5pc2hlZCA9IEdlbWxUb0FzdC5jcmVhdGVUb3BvSWQoY29tcGlsZUNvbnRleHQsICdkb25lLicpO1xuXG4gICAgICAgIC8vbWFwIG9mIGZpZWxkIG5hbWUgdG8gZGVwZW5kZW5jaWVzXG4gICAgICAgIGxldCBmaWVsZFJlZmVyZW5jZXMgPSB7fTtcblxuICAgICAgICBfLmZvck93bihlbnRpdHkuZmllbGRzLCAoZmllbGQsIGZpZWxkTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHRvcG9JZCA9IEdlbWxUb0FzdC5jb21waWxlRmllbGQoZmllbGROYW1lLCBmaWVsZCwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgR2VtbFRvQXN0LmRlcGVuZHNPbihjb21waWxlQ29udGV4dCwgdG9wb0lkLCBhbGxGaW5pc2hlZCk7XG5cbiAgICAgICAgICAgIGlmIChmaWVsZC53cml0ZU9uY2UgfHwgZmllbGQuZnJlZXplQWZ0ZXJOb25EZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgcHV0SW50b0J1Y2tldChmaWVsZFJlZmVyZW5jZXMsIGZpZWxkTmFtZSwgeyByZWZlcmVuY2U6IGZpZWxkTmFtZSwgd3JpdGVQcm90ZWN0OiB0cnVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgZGVwcyA9IGNvbXBpbGVDb250ZXh0LnRvcG9Tb3J0LnNvcnQoKTtcbiAgICAgICAgLy90aGlzLmxpbmtlci52ZXJib3NlKCdBbGwgZGVwZW5kZW5jaWVzOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgZGVwcyA9IGRlcHMuZmlsdGVyKGRlcCA9PiBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmhhcyhkZXApKTtcbiAgICAgICAgLy90aGlzLmxpbmtlci52ZXJib3NlKCdBbGwgbmVjZXNzYXJ5IHNvdXJjZSBjb2RlOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgbGV0IG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwgPSBbXSwgbGFzdEZpZWxkc0dyb3VwLCBcbiAgICAgICAgICAgIG1ldGhvZEJvZHlDYWNoZSA9IFtdLCBcbiAgICAgICAgICAgIGxhc3RCbG9jaywgbGFzdEFzdFR5cGU7Ly8sIGhhc1ZhbGlkYXRvciA9IGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IF9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSA9IGZ1bmN0aW9uIChmaWVsZE5hbWUsIHJlZmVyZW5jZXMsIGFzdENhY2hlLCByZXF1aXJlVGFyZ2V0RmllbGQpIHsgXG4gICAgICAgICAgICBsZXQgZmllbGRzID0gWyBmaWVsZE5hbWUgXS5jb25jYXQocmVmZXJlbmNlcyk7XG4gICAgICAgICAgICBsZXQgY2hlY2tlciA9IGZpZWxkcy5qb2luKCcsJyk7XG5cbiAgICAgICAgICAgIGlmIChsYXN0RmllbGRzR3JvdXAgJiYgbGFzdEZpZWxkc0dyb3VwLmNoZWNrZXIgIT09IGNoZWNrZXIpIHtcbiAgICAgICAgICAgICAgICBtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsID0gbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbC5jb25jYXQoXG4gICAgICAgICAgICAgICAgICAgIFNuaXBwZXRzLl9maWVsZFJlcXVpcmVtZW50Q2hlY2sobGFzdEZpZWxkc0dyb3VwLmZpZWxkTmFtZSwgbGFzdEZpZWxkc0dyb3VwLnJlZmVyZW5jZXMsIG1ldGhvZEJvZHlDYWNoZSwgbGFzdEZpZWxkc0dyb3VwLnJlcXVpcmVUYXJnZXRGaWVsZClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIG1ldGhvZEJvZHlDYWNoZSA9IFtdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBtZXRob2RCb2R5Q2FjaGUgPSBtZXRob2RCb2R5Q2FjaGUuY29uY2F0KGFzdENhY2hlKTtcbiAgICAgICAgICAgIGxhc3RGaWVsZHNHcm91cCA9IHtcbiAgICAgICAgICAgICAgICBmaWVsZE5hbWUsXG4gICAgICAgICAgICAgICAgcmVmZXJlbmNlcyxcbiAgICAgICAgICAgICAgICByZXF1aXJlVGFyZ2V0RmllbGQsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNoZWNrZXIsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9O1xuXG4gICAgICAgIC8vY29uc29sZS5kaXIoY29tcGlsZUNvbnRleHQuYXN0TWFwWydtb2JpbGV+aXNNb2JpbGVQaG9uZTphcmdbMV18PnN0cmluZ0Rhc2hlcml6ZSddLCB7IGRlcHRoOiA4IH0pOyBcblxuICAgICAgICBfLmVhY2goZGVwcywgKGRlcCwgaSkgPT4ge1xuICAgICAgICAgICAgLy9nZXQgbWV0YWRhdGEgb2Ygc291cmNlIGNvZGUgYmxvY2tcbiAgICAgICAgICAgIGxldCBzb3VyY2VNYXAgPSBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmdldChkZXApO1xuXG4gICAgICAgICAgICAvL2dldCBzb3VyY2UgY29kZSBibG9ja1xuICAgICAgICAgICAgbGV0IGFzdEJsb2NrID0gY29tcGlsZUNvbnRleHQuYXN0TWFwW2RlcF07XG5cbiAgICAgICAgICAgIGxldCB0YXJnZXRGaWVsZE5hbWUgPSBnZXRGaWVsZE5hbWUoc291cmNlTWFwLnRhcmdldCk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChzb3VyY2VNYXAucmVmZXJlbmNlcyAmJiBzb3VyY2VNYXAucmVmZXJlbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZpZWxkUmVmZXJlbmNlID0gZmllbGRSZWZlcmVuY2VzW3RhcmdldEZpZWxkTmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKCFmaWVsZFJlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFJlZmVyZW5jZXNbdGFyZ2V0RmllbGROYW1lXSA9IGZpZWxkUmVmZXJlbmNlID0gW107XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC50eXBlID09PSBHZW1sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2VNYXAucmVmZXJlbmNlcy5mb3JFYWNoKHJlZiA9PiB7IGZpZWxkUmVmZXJlbmNlLnB1c2goeyByZWZlcmVuY2U6IHJlZiwgd2hlbk51bGw6IHRydWUgfSk7IH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZU1hcC5yZWZlcmVuY2VzLmZvckVhY2gocmVmID0+IHsgaWYgKGZpZWxkUmVmZXJlbmNlLmluZGV4T2YocmVmKSA9PT0gLTEpIGZpZWxkUmVmZXJlbmNlLnB1c2gocmVmKTsgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobGFzdEJsb2NrKSB7XG4gICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBjaGFpbkNhbGwobGFzdEJsb2NrLCBsYXN0QXN0VHlwZSwgYXN0QmxvY2ssIHNvdXJjZU1hcC50eXBlKTtcbiAgICAgICAgICAgICAgICBsYXN0QmxvY2sgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpIDwgZGVwcy5sZW5ndGgtMSkge1xuICAgICAgICAgICAgICAgIGxldCBuZXh0VHlwZSA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcHNbaSsxXSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaXNDaGFpbmFibGUoc291cmNlTWFwLCBuZXh0VHlwZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFzdEJsb2NrID0gYXN0QmxvY2s7XG4gICAgICAgICAgICAgICAgICAgIGxhc3RBc3RUeXBlID0gc291cmNlTWFwLnR5cGU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gR2VtbFRvQXN0LkFTVF9CTEtfVkFMSURBVE9SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICAvL2hhc1ZhbGlkYXRvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgbGV0IGFzdENhY2hlID0gU25pcHBldHMuX3ZhbGlkYXRlQ2hlY2sodGFyZ2V0RmllbGROYW1lLCBhc3RCbG9jayk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlKHRhcmdldEZpZWxkTmFtZSwgc291cmNlTWFwLnJlZmVyZW5jZXMsIGFzdENhY2hlLCB0cnVlKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gR2VtbFRvQXN0LkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICBsZXQgYXN0Q2FjaGUgPSBKc0xhbmcuYXN0QXNzaWduKEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCwgdHJ1ZSksIGFzdEJsb2NrLCBgUHJvY2Vzc2luZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlKHRhcmdldEZpZWxkTmFtZSwgc291cmNlTWFwLnJlZmVyZW5jZXMsIGFzdENhY2hlLCB0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlTWFwLnR5cGUgPT09IEdlbWxUb0FzdC5BU1RfQkxLX0FDVElWQVRPUl9DQUxMKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFzdENhY2hlID0gU25pcHBldHMuX2NoZWNrQW5kQXNzaWduKGFzdEJsb2NrLCBKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQsIHRydWUpLCBgQWN0aXZhdGluZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlKHRhcmdldEZpZWxkTmFtZSwgc291cmNlTWFwLnJlZmVyZW5jZXMsIGFzdENhY2hlLCBmYWxzZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVG8gYmUgaW1wbGVtZW50ZWQuJyk7XG4gICAgICAgICAgICAgICAgLy9hc3RCbG9jayA9IF8uY2FzdEFycmF5KGFzdEJsb2NrKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy9fbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBbXSwgYXN0QmxvY2spOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8qIENoYW5nZWQgdG8gdGhyb3cgZXJyb3IgaW5zdGVhZCBvZiByZXR1cm5pbmcgYSBlcnJvciBvYmplY3RcbiAgICAgICAgaWYgKGhhc1ZhbGlkYXRvcikge1xuICAgICAgICAgICAgbGV0IGRlY2xhcmUgPSBKc0xhbmcuYXN0VmFyRGVjbGFyZSh2YWxpZFN0YXRlTmFtZSwgZmFsc2UpO1xuICAgICAgICAgICAgbWV0aG9kQm9keUNyZWF0ZS51bnNoaWZ0KGRlY2xhcmUpO1xuICAgICAgICAgICAgbWV0aG9kQm9keVVwZGF0ZS51bnNoaWZ0KGRlY2xhcmUpO1xuICAgICAgICB9XG4gICAgICAgICovXG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkobWV0aG9kQm9keUNhY2hlKSkge1xuICAgICAgICAgICAgbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCA9IG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwuY29uY2F0KFxuICAgICAgICAgICAgICAgIFNuaXBwZXRzLl9maWVsZFJlcXVpcmVtZW50Q2hlY2sobGFzdEZpZWxkc0dyb3VwLmZpZWxkTmFtZSwgXG4gICAgICAgICAgICAgICAgICAgIGxhc3RGaWVsZHNHcm91cC5yZWZlcmVuY2VzLCBcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kQm9keUNhY2hlLCBcbiAgICAgICAgICAgICAgICAgICAgbGFzdEZpZWxkc0dyb3VwLnJlcXVpcmVUYXJnZXRGaWVsZFxuICAgICAgICAgICAgICAgICAgICApKTtcbiAgICAgICAgfSAgICAgIFxuICAgICAgICBcbiAgICAgICAgLypcbiAgICAgICAgbGV0IGFzdCA9IEpzTGFuZy5hc3RQcm9ncmFtKGZhbHNlKTtcbiAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0Q2xhc3NEZWNsYXJlKCdBYmMnLCAnTW9kZWwnLCBbXG4gICAgICAgICAgICBKc0xhbmcuYXN0TWVtYmVyTWV0aG9kKGFzeW5jTWV0aG9kTmFtaW5nKCdwcmVwYXJlRW50aXR5RGF0YV8nKSwgWyAnY29udGV4dCcgXSxcbiAgICAgICAgICAgIFNuaXBwZXRzLl9kb1ZhbGlkYXRlQW5kRmlsbEhlYWRlci5jb25jYXQobWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCkuY29uY2F0KFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoJ2NvbnRleHQnKSkgXSksXG4gICAgICAgICAgICBmYWxzZSwgdHJ1ZSwgdHJ1ZVxuICAgICAgICApXSwgJ2NvbW1lbnQnKSk7XG4gICAgICAgICovXG5cbiAgICAgICAgcmV0dXJuIHsgYXN0OiBKc0xhbmcuYXN0TWVtYmVyTWV0aG9kKGFzeW5jTWV0aG9kTmFtaW5nKCdhcHBseU1vZGlmaWVycycpLCBbICdjb250ZXh0JywgJ2lzVXBkYXRpbmcnIF0sXG4gICAgICAgICAgICBTbmlwcGV0cy5fYXBwbHlNb2RpZmllcnNIZWFkZXIuY29uY2F0KG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwpLmNvbmNhdChbIEpzTGFuZy5hc3RSZXR1cm4oSnNMYW5nLmFzdElkKCdjb250ZXh0JykpIF0pLFxuICAgICAgICAgICAgZmFsc2UsIHRydWUsIHRydWUsICdBcHBseWluZyBwcmVkZWZpbmVkIG1vZGlmaWVycyB0byBlbnRpdHkgZmllbGRzLidcbiAgICAgICAgKSwgZmllbGRSZWZlcmVuY2VzIH07XG4gICAgfVxuXG4gICAgX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUoc2NoZW1hLCB7IGZ1bmN0aW9uTmFtZSwgZnVuY3RvclR5cGUsIGZpbGVOYW1lLCBhcmdzIH0pIHtcbiAgICAgICAgbGV0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKFxuICAgICAgICAgICAgdGhpcy5vdXRwdXRQYXRoLFxuICAgICAgICAgICAgc2NoZW1hLm5hbWUsXG4gICAgICAgICAgICBmaWxlTmFtZVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgICAgICAgICAgLy90b2RvOiBhbmFseXNlIGNvZGUsIGNvbXBhcmUgYXJndW1lbnRzXG4gICAgICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2luZm8nLCBgJHsgXy51cHBlckZpcnN0KGZ1bmN0b3JUeXBlKSB9IFwiJHtmaWxlTmFtZX1cIiBleGlzdHMuIEZpbGUgZ2VuZXJhdGluZyBza2lwcGVkLmApO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXN0ID0gSnNMYW5nLmFzdFByb2dyYW0oKTtcbiAgICAgICAgXG4gICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdEZ1bmN0aW9uKGZ1bmN0aW9uTmFtZSwgYXJncywgT09MX01PRElGSUVSX1JFVFVSTltmdW5jdG9yVHlwZV0oYXJncykpKTtcbiAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0QXNzaWduKCdtb2R1bGUuZXhwb3J0cycsIEpzTGFuZy5hc3RWYXJSZWYoZnVuY3Rpb25OYW1lKSkpO1xuXG4gICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKGZpbGVQYXRoKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgSnNMYW5nLmFzdFRvQ29kZShhc3QpKTtcbiAgICAgICAgdGhpcy5saW5rZXIubG9nKCdpbmZvJywgYEdlbmVyYXRlZCAkeyBmdW5jdG9yVHlwZSB9IGZpbGU6ICR7ZmlsZVBhdGh9YCk7XG4gICAgfVxuXG4gICAgX2J1aWxkSW50ZXJmYWNlcyhlbnRpdHksIG1vZGVsTWV0YUluaXQsIHNoYXJlZENvbnRleHQpIHtcbiAgICAgICAgbGV0IGFzdCA9IFtdO1xuXG4gICAgICAgIF8uZm9yT3duKGVudGl0eS5pbnRlcmZhY2VzLCAobWV0aG9kLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxpbmtlci5pbmZvKCdCdWlsZGluZyBpbnRlcmZhY2U6ICcgKyBuYW1lKTtcblxuICAgICAgICAgICAgbGV0IGFzdEJvZHkgPSBbXG4gICAgICAgICAgICAgICAgSnNMYW5nLmFzdFZhckRlY2xhcmUoJyRtZXRhJywgSnNMYW5nLmFzdFZhclJlZigndGhpcy5tZXRhLmludGVyZmFjZXMuJyArIG5hbWUpLCB0cnVlLCBmYWxzZSwgJ1JldHJpZXZpbmcgdGhlIG1ldGEgZGF0YScpXG4gICAgICAgICAgICBdO1xuXG4gICAgICAgICAgICBsZXQgY29tcGlsZUNvbnRleHQgPSBHZW1sVG9Bc3QuY3JlYXRlQ29tcGlsZUNvbnRleHQoZW50aXR5LmdlbWxNb2R1bGUubmFtZSwgdGhpcy5saW5rZXIsIHNoYXJlZENvbnRleHQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcGFyYW1NZXRhO1xuXG4gICAgICAgICAgICBpZiAobWV0aG9kLmFjY2VwdCkge1xuICAgICAgICAgICAgICAgIHBhcmFtTWV0YSA9IHRoaXMuX3Byb2Nlc3NQYXJhbXMobWV0aG9kLmFjY2VwdCwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL21ldGFkYXRhXG4gICAgICAgICAgICBtb2RlbE1ldGFJbml0WydpbnRlcmZhY2VzJ10gfHwgKG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXSA9IHt9KTtcbiAgICAgICAgICAgIG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXVtuYW1lXSA9IHsgcGFyYW1zOiBPYmplY3QudmFsdWVzKHBhcmFtTWV0YSkgfTtcblxuICAgICAgICAgICAgXy5lYWNoKG1ldGhvZC5pbXBsZW1lbnRhdGlvbiwgKG9wZXJhdGlvbiwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICAvL2xldCBsYXN0VG9wb0lkID0gXG4gICAgICAgICAgICAgICAgR2VtbFRvQXN0LmNvbXBpbGVEYk9wZXJhdGlvbihpbmRleCwgb3BlcmF0aW9uLCBjb21waWxlQ29udGV4dCwgY29tcGlsZUNvbnRleHQubWFpblN0YXJ0SWQpOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAobWV0aG9kLnJldHVybikge1xuICAgICAgICAgICAgICAgIEdlbWxUb0FzdC5jb21waWxlRXhjZXB0aW9uYWxSZXR1cm4obWV0aG9kLnJldHVybiwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZGVwcyA9IGNvbXBpbGVDb250ZXh0LnRvcG9Tb3J0LnNvcnQoKTtcbiAgICAgICAgICAgIC8vdGhpcy5saW5rZXIudmVyYm9zZSgnQWxsIGRlcGVuZGVuY2llczpcXG4nICsgSlNPTi5zdHJpbmdpZnkoZGVwcywgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBkZXBzID0gZGVwcy5maWx0ZXIoZGVwID0+IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuaGFzKGRlcCkpO1xuICAgICAgICAgICAgLy90aGlzLmxpbmtlci52ZXJib3NlKCdBbGwgbmVjZXNzYXJ5IHNvdXJjZSBjb2RlOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIF8uZWFjaChkZXBzLCBkZXAgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBzb3VyY2VNYXAgPSBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmdldChkZXApO1xuICAgICAgICAgICAgICAgIGxldCBhc3RCbG9jayA9IGNvbXBpbGVDb250ZXh0LmFzdE1hcFtkZXBdO1xuXG4gICAgICAgICAgICAgICAgLy90aGlzLmxpbmtlci52ZXJib3NlKCdDb2RlIHBvaW50IFwiJyArIGRlcCArICdcIjpcXG4nICsgSlNPTi5zdHJpbmdpZnkoc291cmNlTWFwLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0RmllbGROYW1lID0gc291cmNlTWFwLnRhcmdldDsgLy9nZXRGaWVsZE5hbWUoc291cmNlTWFwLnRhcmdldCk7ICAgICAgXG5cbiAgICAgICAgICAgICAgICBpZiAoc291cmNlTWFwLnR5cGUgPT09IEdlbWxUb0FzdC5BU1RfQkxLX1ZBTElEQVRPUl9DQUxMKSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBTbmlwcGV0cy5fdmFsaWRhdGVDaGVjayh0YXJnZXRGaWVsZE5hbWUsIGFzdEJsb2NrKTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlTWFwLnR5cGUgPT09IEdlbWxUb0FzdC5BU1RfQkxLX1BST0NFU1NPUl9DQUxMKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzb3VyY2VNYXAubmVlZERlY2xhcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gSnNMYW5nLmFzdFZhckRlY2xhcmUoSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0KSwgYXN0QmxvY2ssIGZhbHNlLCBmYWxzZSwgYFByb2Nlc3NpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBQcm9jZXNzaW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlTWFwLnR5cGUgPT09IEdlbWxUb0FzdC5BU1RfQkxLX0FDVElWQVRPUl9DQUxMKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzb3VyY2VNYXAubmVlZERlY2xhcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gSnNMYW5nLmFzdFZhckRlY2xhcmUoSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0KSwgYXN0QmxvY2ssIGZhbHNlLCBmYWxzZSwgYFByb2Nlc3NpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBBY3RpdmF0aW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBhc3RCb2R5ID0gYXN0Qm9keS5jb25jYXQoXy5jYXN0QXJyYXkoYXN0QmxvY2spKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBhc3QucHVzaChKc0xhbmcuYXN0TWVtYmVyTWV0aG9kKGFzeW5jTWV0aG9kTmFtaW5nKG5hbWUpLCBPYmplY3Qua2V5cyhwYXJhbU1ldGEpLCBhc3RCb2R5LCBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgcmVwbGFjZUFsbChfLmtlYmFiQ2FzZShuYW1lKSwgJy0nLCAnICcpKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhc3Q7XG4gICAgfTtcblxuICAgIF9wcm9jZXNzUGFyYW1zKGFjY2VwdFBhcmFtcywgY29tcGlsZUNvbnRleHQpIHtcbiAgICAgICAgbGV0IHBhcmFtTWV0YSA9IHt9O1xuXG4gICAgICAgIGFjY2VwdFBhcmFtcy5mb3JFYWNoKChwYXJhbSwgaSkgPT4ge1xuICAgICAgICAgICAgR2VtbFRvQXN0LmNvbXBpbGVQYXJhbShpLCBwYXJhbSwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgcGFyYW1NZXRhW3BhcmFtLm5hbWVdID0gcGFyYW07XG4gICAgICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbcGFyYW0ubmFtZV0gPSB7IHNvdXJjZTogJ2FyZ3VtZW50JyB9O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcGFyYW1NZXRhO1xuICAgIH07XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGFvTW9kZWxlcjsiXX0=
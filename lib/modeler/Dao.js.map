{"version":3,"file":"Dao.js","names":["path","require","_","naming","text","pushIntoBucket","fs","swig","GemlTypes","JsLang","GemlToAst","Snippets","Types","ChainableType","AST_BLK_VALIDATOR_CALL","AST_BLK_PROCESSOR_CALL","AST_BLK_ACTIVATOR_CALL","getFieldName","t","split","pop","isChainable","current","next","indexOf","type","target","chainCall","lastBlock","lastType","currentBlock","currentType","assert","astBinExp","arguments","asyncMethodNaming","name","indentLines","lines","indentation","map","line","i","repeat","join","OOL_MODIFIER_RETURN","Modifier","VALIDATOR","astThrow","astReturn","PROCESSOR","args","astId","ACTIVATOR","DaoModeler","constructor","context","linker","connector","outputPath","modelPath","manifestPath","modeling_","schema","log","_generateSchemaModel","_generateEntityModel","_generateEnumTypes","_generateEntityInputSchema","_generateEntityManifest","capitalized","pascalCase","locals","driver","className","schemaName","entities","JSON","stringify","Object","keys","classTemplate","resolve","__dirname","classCode","renderFile","modelFilePath","ensureFileSync","writeFileSync","forOwn","types","location","typeInfo","getTypeInfo","ENUM","content","values","val","snakeCase","toUpperCase","entity","entityInstanceName","sharedContext","mapOfFunctorToFile","newFunctorFiles","ast","astClassMain","fieldReferences","_processFieldModifiers","uniqueKeys","castArray","key","indexes","forEach","index","unique","push","fields","modelMeta","keyField","mapValues","f","omit","toJSON","features","baseClasses","isEmpty","associations","fieldDependencies","interfaces","astInterfaces","_buildInterfaces","concat","importLines","fileName","functionName","astToCode","astRequire","each","entry","_generateFunctionTemplateFile","packageName","gemlModule","fromPackage","packagePath","app","settings","geml","dependencies","imports","entityMeta","classBody","block","functors","astValue","reduce","result","functor","inputs","inputSetName","validationSchema","Set","astProgram","input","startsWith","assoc","substr","assocMeta","Error","spec","dep","add","list","elementSchema","astCall","camelCase","pick","field","exportBody","Array","from","astPushInBody","astAssign","astVarRef","astAnonymousFunction","inputSchemaFilePath","diagram","diagramOutputFilePath","compileContext","createCompileContext","variables","source","finalized","allFinished","createTopoId","fieldName","topoId","compileField","dependsOn","writeOnce","freezeAfterNonDefault","reference","writeProtect","deps","topoSort","sort","filter","mapOfTokenToMeta","has","methodBodyValidateAndFill","lastFieldsGroup","methodBodyCache","lastAstType","_mergeDoValidateAndFillCode","references","astCache","requireTargetField","checker","_fieldRequirementCheck","sourceMap","get","astBlock","astMap","targetFieldName","length","fieldReference","ref","whenNull","undefined","nextType","_validateCheck","_checkAndAssign","astMemberMethod","_applyModifiersHeader","functorType","filePath","existsSync","upperFirst","astFunction","modelMetaInit","method","info","astBody","astVarDeclare","paramMeta","accept","_processParams","params","implementation","operation","compileDbOperation","mainStartId","return","compileExceptionalReturn","needDeclare","replaceAll","kebabCase","acceptParams","param","compileParam","module","exports"],"sources":["../../src/modeler/Dao.js"],"sourcesContent":["const path = require(\"path\");\nconst { _, naming, text, pushIntoBucket } = require(\"@genx/july\");\nconst { fs } = require(\"@genx/sys\");\nconst swig = require(\"swig-templates\");\n\nconst GemlTypes = require(\"../lang/GemlTypes\");\nconst JsLang = require(\"./util/ast.js\");\nconst GemlToAst = require(\"./util/gemlToAst.js\");\nconst Snippets = require(\"./dao/snippets\");\nconst { Types } = require(\"@genx/data\");\n\nconst ChainableType = [\n    GemlToAst.AST_BLK_VALIDATOR_CALL,\n    GemlToAst.AST_BLK_PROCESSOR_CALL,\n    GemlToAst.AST_BLK_ACTIVATOR_CALL,\n];\n\nconst getFieldName = (t) => t.split(\".\").pop();\nconst isChainable = (current, next) =>\n    ChainableType.indexOf(current.type) > -1 && current.target === next.target && next.type === current.type;\nconst chainCall = (lastBlock, lastType, currentBlock, currentType) => {\n    if (lastBlock) {\n        if (lastType === \"ValidatorCall\") {\n            assert: currentType === \"ValidatorCall\", \"Unexpected currentType\";\n\n            currentBlock = JsLang.astBinExp(lastBlock, \"&&\", currentBlock);\n        } else {\n            assert: currentType === \"ProcessorCall\", \"Unexpected currentType: \" + currentType + \" last: \" + lastType;\n\n            currentBlock.arguments[0] = lastBlock;\n        }\n    }\n\n    return currentBlock;\n};\nconst asyncMethodNaming = (name) => name + \"_\";\n\nconst indentLines = (lines, indentation) =>\n    lines\n        .split(\"\\n\")\n        .map((line, i) => (i === 0 ? line : _.repeat(\" \", indentation) + line))\n        .join(\"\\n\");\n\nconst OOL_MODIFIER_RETURN = {\n    [GemlTypes.Modifier.VALIDATOR]: () => [JsLang.astThrow('Error', ['To be implemented!']), JsLang.astReturn(true)],\n    [GemlTypes.Modifier.PROCESSOR]: (args) => [JsLang.astThrow('Error', ['To be implemented!']), JsLang.astReturn(JsLang.astId(args[0]))],\n    [GemlTypes.Modifier.ACTIVATOR]: () => [JsLang.astThrow('Error', ['To be implemented!']), JsLang.astReturn(JsLang.astId(\"undefined\"))],\n};\n\n/**\n * Geml database access object (DAO) modeler.\n * @class\n */\nclass DaoModeler {\n    /**\n     * @param {object} context\n     * @property {GemlLinker} context.linker - Geml linker\n     * @property {object} context.modelPath - Generated model output path\n     * @property {object} context.manifestPath - Entities manifest output path\n     * @param {Connector} connector\n     */\n    constructor(context, linker, connector) {\n        this.linker = linker;\n        this.outputPath = context.modelPath;\n        this.manifestPath = context.manifestPath;\n\n        this.connector = connector;\n    }\n\n    modeling_(schema) {\n        this.linker.log(\"info\", 'Generating entity models for schema \"' + schema.name + '\"...');\n\n        this._generateSchemaModel(schema);\n        this._generateEntityModel(schema);\n        this._generateEnumTypes(schema);\n        this._generateEntityInputSchema(schema);\n        //\n        //this._generateViewModel();\n\n        if (this.manifestPath) {\n            this._generateEntityManifest(schema);\n        }\n    }\n\n    _generateSchemaModel(schema) {\n        let capitalized = naming.pascalCase(schema.name);\n\n        let locals = {\n            driver: this.connector.driver,\n            className: capitalized,\n            schemaName: schema.name,\n            entities: JSON.stringify(Object.keys(schema.entities)),\n        };\n\n        let classTemplate = path.resolve(__dirname, \"database\", this.connector.driver, \"Database.js.swig\");\n        let classCode = swig.renderFile(classTemplate, locals);\n\n        let modelFilePath = path.resolve(this.outputPath, capitalized + \".js\");\n        fs.ensureFileSync(modelFilePath);\n        fs.writeFileSync(modelFilePath, classCode);\n\n        this.linker.log(\"info\", \"Generated database model: \" + modelFilePath);\n    }\n\n    _generateEnumTypes(schema) {\n        //build types defined outside of entity\n        _.forOwn(schema.types, (location, type) => {\n            const typeInfo = schema.linker.getTypeInfo(type, location);\n            if (typeInfo.type === Types.ENUM.name) {\n                const capitalized = naming.pascalCase(type);\n\n                const content = `module.exports = {\n    ${typeInfo.values\n        .map((val) => `${naming.snakeCase(val).toUpperCase()}: '${val}'`)\n        .join(\",\\n    \")}                    \n};`;\n\n                const modelFilePath = path.resolve(this.outputPath, schema.name, \"types\", capitalized + \".js\");\n                fs.ensureFileSync(modelFilePath);\n                fs.writeFileSync(modelFilePath, content);\n\n                this.linker.log(\"info\", \"Generated enum type definition: \" + modelFilePath);\n            }\n        });\n    }\n\n    _generateEntityModel(schema) {\n        _.forOwn(schema.entities, (entity, entityInstanceName) => {\n            let capitalized = naming.pascalCase(entityInstanceName);\n\n            //shared information with model CRUD and customized interfaces\n            let sharedContext = {\n                mapOfFunctorToFile: {},\n                newFunctorFiles: [],\n            };\n\n            let { ast: astClassMain, fieldReferences } = this._processFieldModifiers(entity, sharedContext);\n            astClassMain = [astClassMain];\n\n            //prepare meta data\n            let uniqueKeys = [_.castArray(entity.key)];\n\n            if (entity.indexes) {\n                entity.indexes.forEach((index) => {\n                    if (index.unique) {\n                        uniqueKeys.push(index.fields);\n                    }\n                });\n            }\n\n            let modelMeta = {\n                schemaName: schema.name,\n                name: entityInstanceName,\n                keyField: entity.key,\n                fields: _.mapValues(entity.fields, (f) => _.omit(f.toJSON(), \"modifiers\")),\n                features: entity.features || {},\n                uniqueKeys,\n            };\n\n            if (entity.baseClasses) {\n                modelMeta.baseClasses = entity.baseClasses;\n            }\n\n            if (!_.isEmpty(entity.indexes)) {\n                modelMeta.indexes = entity.indexes;\n            }\n\n            if (!_.isEmpty(entity.features)) {\n                modelMeta.features = entity.features;\n            }\n\n            if (!_.isEmpty(entity.associations)) {\n                modelMeta.associations = entity.associations;\n            }\n\n            if (!_.isEmpty(fieldReferences)) {\n                modelMeta.fieldDependencies = fieldReferences;\n            }\n\n            //build customized interfaces\n            if (entity.interfaces) {\n                let astInterfaces = this._buildInterfaces(entity, modelMeta, sharedContext);\n                //console.log(astInterfaces);\n                //let astClass = astClassMain[astClassMain.length - 1];\n                //JsLang.astPushInBody(astClass, astInterfaces);\n                astClassMain = astClassMain.concat(astInterfaces);\n            }\n\n            let importLines = [];\n\n            //generate functors if any\n            if (!_.isEmpty(sharedContext.mapOfFunctorToFile)) {\n                _.forOwn(sharedContext.mapOfFunctorToFile, (fileName, functionName) => {\n                    importLines.push(JsLang.astToCode(JsLang.astRequire(functionName, \".\" + fileName)));\n                });\n            }\n\n            if (!_.isEmpty(sharedContext.newFunctorFiles)) {\n                _.each(sharedContext.newFunctorFiles, (entry) => {\n                    this._generateFunctionTemplateFile(schema, entry);\n                });\n            }\n\n            //add package path\n            const packageName = entity.gemlModule.packageName;\n            if (packageName) {                \n                modelMeta.fromPackage = packageName;                \n                modelMeta.packagePath = this.linker.app.settings.geml.dependencies[packageName]; //path.relative(this.linker.dependencies[packageName], this.linker.app.workingPath);\n            }\n\n            let locals = {\n                imports: importLines.join(\"\\n\"),\n                className: capitalized,\n                entityMeta: indentLines(JSON.stringify(modelMeta, null, 4), 4),\n                classBody: indentLines(astClassMain.map((block) => JsLang.astToCode(block)).join(\"\\n\\n\"), 8),\n                functors: indentLines(\n                    JsLang.astToCode(\n                        JsLang.astValue(\n                            _.reduce(\n                                sharedContext.newFunctorFiles,\n                                (result, functor) => {\n                                    result[\"$\" + functor.functionName] = JsLang.astId(functor.functionName);\n                                    return result;\n                                },\n                                {}\n                            )\n                        )\n                    ),\n                    4\n                ),\n                //mixins\n            };\n\n            let classTemplate = path.resolve(__dirname, \"database\", this.connector.driver, \"EntityModel.js.swig\");\n            let classCode = swig.renderFile(classTemplate, locals);\n\n            let modelFilePath = path.resolve(this.outputPath, schema.name, \"base\", capitalized + \".js\");\n            fs.ensureFileSync(modelFilePath);\n            fs.writeFileSync(modelFilePath, classCode);\n\n            this.linker.log(\"info\", \"Generated entity model: \" + modelFilePath);\n        });\n    }\n\n    _generateEntityInputSchema(schema) {\n        //generate validator config\n        _.forOwn(schema.entities, (entity, entityInstanceName) => {\n            _.each(entity.inputs, (inputs, inputSetName) => {\n                const validationSchema = {};\n                const dependencies = new Set();\n                const ast = JsLang.astProgram();\n\n                inputs.forEach((input) => {\n                    //:address\n                    if (input.name.startsWith(\":\")) {\n                        const assoc = input.name.substr(1);\n                        const assocMeta = entity.associations[assoc];\n\n                        if (!assocMeta) {\n                            throw new Error(`Association \"${assoc}\" not found in entity [${entityInstanceName}].`);\n                        }\n\n                        if (!input.spec) {\n                            throw new Error(\n                                `Input \"spec\" is required for entity reference. Input set: ${inputSetName}, entity: ${entityInstanceName}, local: ${assoc}, referencedEntity: ${assocMeta.entity}`\n                            );\n                        }\n\n                        const dep = `${assocMeta.entity}-${input.spec}`;\n                        dependencies.add(dep);\n\n                        if (assocMeta.list) {\n                            validationSchema[input.name] = JsLang.astValue({\n                                type: \"array\",\n                                elementSchema: {\n                                    type: \"object\",\n                                    schema: JsLang.astCall(_.camelCase(dep), []),\n                                },\n                                ..._.pick(input, [\"optional\"]),\n                            });\n                        } else {\n                            validationSchema[input.name] = JsLang.astValue({\n                                type: \"object\",\n                                schema: JsLang.astCall(_.camelCase(dep), []),\n                                ..._.pick(input, [\"optional\"]),\n                            });\n                        }\n                    } else {\n                        const field = entity.fields[input.name];\n\n                        if (!field) {\n                            throw new Error(`Field \"${input.name}\" not found in entity [${entityInstanceName}].`);\n                        }\n\n                        validationSchema[input.name] = JsLang.astValue({\n                            ..._.pick(field, [\"type\", \"values\"]),\n                            ..._.pick(input, [\"optional\"]),\n                        });\n                    }\n                });\n\n                //console.dir(JsLang.astValue(validationSchema), {depth: 20});\n\n                const exportBody = Array.from(dependencies).map((dep) =>\n                    JsLang.astRequire(_.camelCase(dep), `./${dep}`)\n                );\n\n                JsLang.astPushInBody(\n                    ast,\n                    JsLang.astAssign(\n                        JsLang.astVarRef(\"module.exports\"),\n                        JsLang.astAnonymousFunction([], exportBody.concat(JsLang.astReturn(validationSchema)))\n                    )\n                );\n\n                let inputSchemaFilePath = path.resolve(\n                    this.outputPath,\n                    schema.name,\n                    \"inputs\",\n                    entityInstanceName + \"-\" + inputSetName + \".js\"\n                );\n                fs.ensureFileSync(inputSchemaFilePath);\n                fs.writeFileSync(inputSchemaFilePath, JsLang.astToCode(ast));\n\n                this.linker.log(\"info\", \"Generated entity input schema: \" + inputSchemaFilePath);\n            });\n        });\n    }\n\n    _generateEntityManifest(schema) {\n        /*\n        let manifest = {};\n\n        _.each(schema.entities, (entity, entityName) => {\n            if (entity.info.restful) {\n                _.each(entity.info.restful, ({ type, methods }, relativeUri) => {                    \n                    let apiInfo = {\n                        type,\n                        methods: {}                                            \n                    };\n\n                    if (type === 'entity') {\n                        apiInfo.entity = entityName;\n                        apiInfo.displayName = entity.displayName;\n\n                        if (entity.comment) {\n                            apiInfo.description = entity.comment;\n                        }\n                    }\n\n                    _.each(methods, (meta, methodName) => {\n\n                        switch (methodName) {\n                            case 'create':\n                                apiInfo.methods['post:' + relativeUri] = meta;\n                            break;\n\n                            case 'findOne':\n                            break;\n\n                            case 'fineAll':\n                            break;\n\n                            case 'updateOne':\n                            break;\n\n                            case 'updateMany':\n                            break;\n\n                            case 'deleteOne':\n                            break;\n\n                            case 'deleteMany':\n                            break;\n                        }\n\n                    });\n                });\n            }\n        });\n        */\n\n        /*\n        let outputFilePath = path.resolve(this.manifestPath, schema.name + '.manifest.json');\n        fs.ensureFileSync(outputFilePath);\n        fs.writeFileSync(outputFilePath, JSON.stringify(entities, null, 4));\n\n        this.linker.log('info', 'Generated schema manifest: ' + outputFilePath);\n        */\n\n        const diagram = {};\n\n        //generate validator config\n        _.forOwn(schema.entities, (entity, entityInstanceName) => {\n            /*\n            let validationSchema = {};\n\n            _.forOwn(entity.fields, (field, fieldName) => {\n                if (field.readOnly) return;\n\n                let fieldSchema = {\n                    type: field.type,\n                };\n\n                if (field.type === \"enum\") {\n                    fieldSchema.values = field.values;\n                }\n\n                if (field.optional) {\n                    fieldSchema.optional = true;\n                }\n\n                validationSchema[fieldName] = fieldSchema;\n            });\n            */\n\n            diagram[entityInstanceName] = entity.toJSON();\n\n            /*\n            let entityOutputFilePath = path.resolve(\n                this.manifestPath,\n                schema.name,\n                \"validation\",\n                entityInstanceName + \".manifest.json\"\n            );\n            fs.ensureFileSync(entityOutputFilePath);\n            fs.writeFileSync(entityOutputFilePath, JSON.stringify(validationSchema, null, 4));\n\n            this.linker.log(\"info\", \"Generated entity manifest: \" + entityOutputFilePath);\n            */\n        });\n\n        let diagramOutputFilePath = path.resolve(this.manifestPath, schema.name, \"diagram.json\");\n        fs.ensureFileSync(diagramOutputFilePath);\n        fs.writeFileSync(diagramOutputFilePath, JSON.stringify(diagram, null, 4));\n\n        this.linker.log(\"info\", \"Generated schema manifest: \" + diagramOutputFilePath);\n    }\n\n    /*\n    _generateViewModel(schema, dbService) {        \n        _.forOwn(schema.views, (viewInfo, viewName) => {\n            this.linker.info('Building view: ' + viewName);\n\n            let capitalized = _.upperFirst(viewName);\n\n            let ast = JsLang.astProgram();\n\n            JsLang.astPushInBody(ast, JsLang.astRequire('Mowa', 'mowa'));\n            JsLang.astPushInBody(ast, JsLang.astVarDeclare('Util', JsLang.astVarRef('Mowa.Util'), true));\n            JsLang.astPushInBody(ast, JsLang.astVarDeclare('_', JsLang.astVarRef('Util._'), true));\n            JsLang.astPushInBody(ast, JsLang.astRequire('View', 'mowa/lib/oolong/runtime/view'));\n\n            let compileContext = OolToAst.createCompileContext(viewName, dbService.serviceId, this.linker);\n\n            compileContext.modelVars.add(viewInfo.entity);\n\n            let paramMeta;\n\n            if (viewInfo.params) {\n                paramMeta = this._processParams(viewInfo.params, compileContext);\n            }\n\n            let viewMeta = {\n                isList: viewInfo.isList,\n                params: paramMeta\n            };\n\n            let viewBodyTopoId = OolToAst.createTopoId(compileContext, '$view');\n            OolToAst.dependsOn(compileContext, compileContext.mainStartId, viewBodyTopoId);\n\n            let viewModeler = require(path.resolve(__dirname, './dao/view', dbService.dbType + '.js'));\n            compileContext.astMap[viewBodyTopoId] = viewModeler(dbService, viewName, viewInfo);\n            OolToAst.addCodeBlock(compileContext, viewBodyTopoId, {\n                type: OolToAst.AST_BLK_VIEW_OPERATION\n            });\n\n            let returnTopoId = OolToAst.createTopoId(compileContext, '$return:value');\n            OolToAst.dependsOn(compileContext, viewBodyTopoId, returnTopoId);\n            OolToAst.compileReturn(returnTopoId, {\n                \"oolType\": \"ObjectReference\",\n                \"name\": \"viewData\"\n            }, compileContext);\n\n            let deps = compileContext.topoSort.sort();\n            this.linker.verbose('All dependencies:\\n' + JSON.stringify(deps, null, 2));\n\n            deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));\n            this.linker.verbose('All necessary source code:\\n' + JSON.stringify(deps, null, 2));\n\n            let astDoLoadMain = [\n                JsLang.astVarDeclare('$meta', JsLang.astVarRef('this.meta'), true, false, 'Retrieving the meta data')\n            ];\n\n            _.each(deps, dep => {\n                let astMeta = compileContext.mapOfTokenToMeta.get(dep);\n\n                let astBlock = compileContext.astMap[dep];\n                assert: astBlock, 'Empty ast block';\n\n                if (astMeta.type === 'ModifierCall') {\n                    let fieldName = getFieldName(astMeta.target);\n                    let astCache = JsLang.astAssign(JsLang.astVarRef(astMeta.target), astBlock, `Modifying ${fieldName}`);\n                    astDoLoadMain.push(astCache);\n                    return;\n                }\n\n                astDoLoadMain = astDoLoadMain.concat(_.castArray(compileContext.astMap[dep]));\n            });\n\n            if (!_.isEmpty(compileContext.mapOfFunctorToFile)) {\n                _.forOwn(compileContext.mapOfFunctorToFile, (fileName, functionName) => {\n                    JsLang.astPushInBody(ast, JsLang.astRequire(functionName, '.' + fileName));\n                });\n            }\n\n            if (!_.isEmpty(compileContext.newFunctorFiles)) {\n                _.each(compileContext.newFunctorFiles, entry => {\n                    this._generateFunctionTemplateFile(dbService, entry);\n                });\n            }\n\n            JsLang.astPushInBody(ast, JsLang.astClassDeclare(capitalized, 'View', [\n                JsLang.astMemberMethod('_doLoad', Object.keys(paramMeta),\n                    astDoLoadMain,\n                    false, true, false, 'Populate view data'\n                )\n            ], `${capitalized} view`));\n            JsLang.astPushInBody(ast, JsLang.astAssign(capitalized + '.meta', JsLang.astValue(viewMeta)));\n            JsLang.astPushInBody(ast, JsLang.astAssign('module.exports', JsLang.astVarRef(capitalized)));\n\n            let modelFilePath = path.resolve(this.outputPath, dbService.dbType, dbService.name, 'views', viewName + '.js');\n            fs.ensureFileSync(modelFilePath);\n            fs.writeFileSync(modelFilePath + '.json', JSON.stringify(ast, null, 2));\n\n            DaoModeler._exportSourceCode(ast, modelFilePath);\n\n            this.linker.log('info', 'Generated view model: ' + modelFilePath);\n        });\n    };\n    */\n\n    _processFieldModifiers(entity, sharedContext) {\n        let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);\n        compileContext.variables[\"raw\"] = { source: \"context\", finalized: true };\n        compileContext.variables[\"i18n\"] = { source: \"context\", finalized: true };\n        compileContext.variables[\"connector\"] = { source: \"context\", finalized: true };\n        compileContext.variables[\"latest\"] = { source: \"context\" };\n\n        const allFinished = GemlToAst.createTopoId(compileContext, \"done.\");\n\n        //map of field name to dependencies\n        let fieldReferences = {};\n\n        _.forOwn(entity.fields, (field, fieldName) => {\n            let topoId = GemlToAst.compileField(fieldName, field, compileContext);\n            GemlToAst.dependsOn(compileContext, topoId, allFinished);\n\n            if (field.writeOnce || field.freezeAfterNonDefault) {\n                pushIntoBucket(fieldReferences, fieldName, { reference: fieldName, writeProtect: true });\n            }\n        });\n\n        let deps = compileContext.topoSort.sort();\n        //this.linker.verbose('All dependencies:\\n' + JSON.stringify(deps, null, 2));\n\n        deps = deps.filter((dep) => compileContext.mapOfTokenToMeta.has(dep));\n        //this.linker.verbose('All necessary source code:\\n' + JSON.stringify(deps, null, 2));\n\n        let methodBodyValidateAndFill = [],\n            lastFieldsGroup,\n            methodBodyCache = [],\n            lastBlock,\n            lastAstType; //, hasValidator = false;\n\n        const _mergeDoValidateAndFillCode = function (fieldName, references, astCache, requireTargetField) {\n            let fields = [fieldName].concat(references);\n            let checker = fields.join(\",\");\n\n            if (lastFieldsGroup && lastFieldsGroup.checker !== checker) {\n                methodBodyValidateAndFill = methodBodyValidateAndFill.concat(\n                    Snippets._fieldRequirementCheck(\n                        lastFieldsGroup.fieldName,\n                        lastFieldsGroup.references,\n                        methodBodyCache,\n                        lastFieldsGroup.requireTargetField\n                    )\n                );\n                methodBodyCache = [];\n            }\n\n            methodBodyCache = methodBodyCache.concat(astCache);\n            lastFieldsGroup = {\n                fieldName,\n                references,\n                requireTargetField,\n                checker,\n            };\n        };\n\n        //console.dir(compileContext.astMap['mobile~isMobilePhone:arg[1]|>stringDasherize'], { depth: 8 });\n\n        _.each(deps, (dep, i) => {\n            //get metadata of source code block\n            let sourceMap = compileContext.mapOfTokenToMeta.get(dep);\n\n            //get source code block\n            let astBlock = compileContext.astMap[dep];\n\n            let targetFieldName = getFieldName(sourceMap.target);\n\n            if (sourceMap.references && sourceMap.references.length > 0) {\n                let fieldReference = fieldReferences[targetFieldName];\n                if (!fieldReference) {\n                    fieldReferences[targetFieldName] = fieldReference = [];\n                }\n\n                if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {\n                    sourceMap.references.forEach((ref) => {\n                        fieldReference.push({ reference: ref, whenNull: true });\n                    });\n                } else {\n                    sourceMap.references.forEach((ref) => {\n                        if (fieldReference.indexOf(ref) === -1) fieldReference.push(ref);\n                    });\n                }\n            }\n\n            if (lastBlock) {\n                astBlock = chainCall(lastBlock, lastAstType, astBlock, sourceMap.type);\n                lastBlock = undefined;\n            }\n\n            if (i < deps.length - 1) {\n                let nextType = compileContext.mapOfTokenToMeta.get(deps[i + 1]);\n\n                if (isChainable(sourceMap, nextType)) {\n                    lastBlock = astBlock;\n                    lastAstType = sourceMap.type;\n                    return;\n                }\n            }\n\n            if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {\n                //hasValidator = true;\n                let astCache = Snippets._validateCheck(targetFieldName, astBlock);\n\n                _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);\n            } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {\n                let astCache = JsLang.astAssign(\n                    JsLang.astVarRef(sourceMap.target, true),\n                    astBlock,\n                    `Processing \"${targetFieldName}\"`\n                );\n\n                _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);\n            } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {\n                let astCache = Snippets._checkAndAssign(\n                    astBlock,\n                    JsLang.astVarRef(sourceMap.target, true),\n                    `Activating \"${targetFieldName}\"`\n                );\n\n                _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, false);\n            } else {\n                throw new Error(\"To be implemented.\");\n                //astBlock = _.castArray(astBlock);\n                //_mergeDoValidateAndFillCode(targetFieldName, [], astBlock);\n            }\n        });\n\n        /* Changed to throw error instead of returning a error object\n        if (hasValidator) {\n            let declare = JsLang.astVarDeclare(validStateName, false);\n            methodBodyCreate.unshift(declare);\n            methodBodyUpdate.unshift(declare);\n        }\n        */\n\n        if (!_.isEmpty(methodBodyCache)) {\n            methodBodyValidateAndFill = methodBodyValidateAndFill.concat(\n                Snippets._fieldRequirementCheck(\n                    lastFieldsGroup.fieldName,\n                    lastFieldsGroup.references,\n                    methodBodyCache,\n                    lastFieldsGroup.requireTargetField\n                )\n            );\n        }\n\n        /*\n        let ast = JsLang.astProgram(false);\n        JsLang.astPushInBody(ast, JsLang.astClassDeclare('Abc', 'Model', [\n            JsLang.astMemberMethod(asyncMethodNaming('prepareEntityData_'), [ 'context' ],\n            Snippets._doValidateAndFillHeader.concat(methodBodyValidateAndFill).concat([ JsLang.astReturn(JsLang.astId('context')) ]),\n            false, true, true\n        )], 'comment'));\n        */\n\n        return {\n            ast: JsLang.astMemberMethod(\n                asyncMethodNaming(\"applyModifiers\"),\n                [\"context\", \"isUpdating\"],\n                Snippets._applyModifiersHeader\n                    .concat(methodBodyValidateAndFill)\n                    .concat([JsLang.astReturn(JsLang.astId(\"context\"))]),\n                false,\n                true,\n                true,\n                \"Applying predefined modifiers to entity fields.\"\n            ),\n            fieldReferences,\n        };\n    }\n\n    _generateFunctionTemplateFile(schema, { functionName, functorType, fileName, args }) {\n        let filePath = path.resolve(this.outputPath, schema.name, fileName);\n\n        if (fs.existsSync(filePath)) {\n            //todo: analyse code, compare arguments\n            this.linker.log(\"info\", `${_.upperFirst(functorType)} \"${fileName}\" exists. File generating skipped.`);\n\n            return;\n        }\n\n        let ast = JsLang.astProgram();\n\n        JsLang.astPushInBody(ast, JsLang.astFunction(functionName, args, OOL_MODIFIER_RETURN[functorType](args)));\n        JsLang.astPushInBody(ast, JsLang.astAssign(\"module.exports\", JsLang.astVarRef(functionName)));\n\n        fs.ensureFileSync(filePath);\n        fs.writeFileSync(filePath, JsLang.astToCode(ast));\n        this.linker.log(\"info\", `Generated ${functorType} file: ${filePath}`);\n    }\n\n    _buildInterfaces(entity, modelMetaInit, sharedContext) {\n        let ast = [];\n\n        _.forOwn(entity.interfaces, (method, name) => {\n            this.linker.info(\"Building interface: \" + name);\n\n            let astBody = [\n                JsLang.astVarDeclare(\n                    \"$meta\",\n                    JsLang.astVarRef(\"this.meta.interfaces.\" + name),\n                    true,\n                    false,\n                    \"Retrieving the meta data\"\n                ),\n            ];\n\n            let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);\n\n            let paramMeta;\n\n            if (method.accept) {\n                paramMeta = this._processParams(method.accept, compileContext);\n            }\n\n            //metadata\n            modelMetaInit[\"interfaces\"] || (modelMetaInit[\"interfaces\"] = {});\n            modelMetaInit[\"interfaces\"][name] = { params: Object.values(paramMeta) };\n\n            _.each(method.implementation, (operation, index) => {\n                //let lastTopoId =\n                GemlToAst.compileDbOperation(index, operation, compileContext, compileContext.mainStartId);\n            });\n\n            if (method.return) {\n                GemlToAst.compileExceptionalReturn(method.return, compileContext);\n            }\n\n            let deps = compileContext.topoSort.sort();\n            //this.linker.verbose('All dependencies:\\n' + JSON.stringify(deps, null, 2));\n\n            deps = deps.filter((dep) => compileContext.mapOfTokenToMeta.has(dep));\n            //this.linker.verbose('All necessary source code:\\n' + JSON.stringify(deps, null, 2));\n\n            _.each(deps, (dep) => {\n                let sourceMap = compileContext.mapOfTokenToMeta.get(dep);\n                let astBlock = compileContext.astMap[dep];\n\n                //this.linker.verbose('Code point \"' + dep + '\":\\n' + JSON.stringify(sourceMap, null, 2));\n\n                let targetFieldName = sourceMap.target; //getFieldName(sourceMap.target);\n\n                if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {\n                    astBlock = Snippets._validateCheck(targetFieldName, astBlock);\n                } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {\n                    if (sourceMap.needDeclare) {\n                        astBlock = JsLang.astVarDeclare(\n                            JsLang.astVarRef(sourceMap.target),\n                            astBlock,\n                            false,\n                            false,\n                            `Processing \"${targetFieldName}\"`\n                        );\n                    } else {\n                        astBlock = JsLang.astAssign(\n                            JsLang.astVarRef(sourceMap.target, true),\n                            astBlock,\n                            `Processing \"${targetFieldName}\"`\n                        );\n                    }\n                } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {\n                    if (sourceMap.needDeclare) {\n                        astBlock = JsLang.astVarDeclare(\n                            JsLang.astVarRef(sourceMap.target),\n                            astBlock,\n                            false,\n                            false,\n                            `Processing \"${targetFieldName}\"`\n                        );\n                    } else {\n                        astBlock = JsLang.astAssign(\n                            JsLang.astVarRef(sourceMap.target, true),\n                            astBlock,\n                            `Activating \"${targetFieldName}\"`\n                        );\n                    }\n                }\n\n                astBody = astBody.concat(_.castArray(astBlock));\n            });\n\n            ast.push(\n                JsLang.astMemberMethod(\n                    asyncMethodNaming(name),\n                    Object.keys(paramMeta),\n                    astBody,\n                    false,\n                    true,\n                    true,\n                    text.replaceAll(_.kebabCase(name), \"-\", \" \")\n                )\n            );\n        });\n\n        return ast;\n    }\n\n    _processParams(acceptParams, compileContext) {\n        let paramMeta = {};\n\n        acceptParams.forEach((param, i) => {\n            GemlToAst.compileParam(i, param, compileContext);\n            paramMeta[param.name] = param;\n            compileContext.variables[param.name] = { source: \"argument\" };\n        });\n\n        return paramMeta;\n    }\n}\n\nmodule.exports = DaoModeler;\n"],"mappings":";;;;AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;EAAEC,CAAF;EAAKC,MAAL;EAAaC,IAAb;EAAmBC;AAAnB,IAAsCJ,OAAO,CAAC,YAAD,CAAnD;;AACA,MAAM;EAAEK;AAAF,IAASL,OAAO,CAAC,WAAD,CAAtB;;AACA,MAAMM,IAAI,GAAGN,OAAO,CAAC,gBAAD,CAApB;;AAEA,MAAMO,SAAS,GAAGP,OAAO,CAAC,mBAAD,CAAzB;;AACA,MAAMQ,MAAM,GAAGR,OAAO,CAAC,eAAD,CAAtB;;AACA,MAAMS,SAAS,GAAGT,OAAO,CAAC,qBAAD,CAAzB;;AACA,MAAMU,QAAQ,GAAGV,OAAO,CAAC,gBAAD,CAAxB;;AACA,MAAM;EAAEW;AAAF,IAAYX,OAAO,CAAC,YAAD,CAAzB;;AAEA,MAAMY,aAAa,GAAG,CAClBH,SAAS,CAACI,sBADQ,EAElBJ,SAAS,CAACK,sBAFQ,EAGlBL,SAAS,CAACM,sBAHQ,CAAtB;;AAMA,MAAMC,YAAY,GAAIC,CAAD,IAAOA,CAAC,CAACC,KAAF,CAAQ,GAAR,EAAaC,GAAb,EAA5B;;AACA,MAAMC,WAAW,GAAG,CAACC,OAAD,EAAUC,IAAV,KAChBV,aAAa,CAACW,OAAd,CAAsBF,OAAO,CAACG,IAA9B,IAAsC,CAAC,CAAvC,IAA4CH,OAAO,CAACI,MAAR,KAAmBH,IAAI,CAACG,MAApE,IAA8EH,IAAI,CAACE,IAAL,KAAcH,OAAO,CAACG,IADxG;;AAEA,MAAME,SAAS,GAAG,CAACC,SAAD,EAAYC,QAAZ,EAAsBC,YAAtB,EAAoCC,WAApC,KAAoD;EAClE,IAAIH,SAAJ,EAAe;IACX,IAAIC,QAAQ,KAAK,eAAjB,EAAkC;MAC9BG,MAAM,EAAED,WAAW,KAAK,eAAhB,EAAiC,wBAAjC;;MAERD,YAAY,GAAGrB,MAAM,CAACwB,SAAP,CAAiBL,SAAjB,EAA4B,IAA5B,EAAkCE,YAAlC,CAAf;IACH,CAJD,MAIO;MACHE,MAAM,EAAED,WAAW,KAAK,eAAhB,EAAiC,6BAA6BA,WAA7B,GAA2C,SAA3C,GAAuDF,QAAxF;;MAERC,YAAY,CAACI,SAAb,CAAuB,CAAvB,IAA4BN,SAA5B;IACH;EACJ;;EAED,OAAOE,YAAP;AACH,CAdD;;AAeA,MAAMK,iBAAiB,GAAIC,IAAD,IAAUA,IAAI,GAAG,GAA3C;;AAEA,MAAMC,WAAW,GAAG,CAACC,KAAD,EAAQC,WAAR,KAChBD,KAAK,CACAnB,KADL,CACW,IADX,EAEKqB,GAFL,CAES,CAACC,IAAD,EAAOC,CAAP,KAAcA,CAAC,KAAK,CAAN,GAAUD,IAAV,GAAiBvC,CAAC,CAACyC,MAAF,CAAS,GAAT,EAAcJ,WAAd,IAA6BE,IAFrE,EAGKG,IAHL,CAGU,IAHV,CADJ;;AAMA,MAAMC,mBAAmB,GAAG;EACxB,CAACrC,SAAS,CAACsC,QAAV,CAAmBC,SAApB,GAAgC,MAAM,CAACtC,MAAM,CAACuC,QAAP,CAAgB,OAAhB,EAAyB,CAAC,oBAAD,CAAzB,CAAD,EAAmDvC,MAAM,CAACwC,SAAP,CAAiB,IAAjB,CAAnD,CADd;EAExB,CAACzC,SAAS,CAACsC,QAAV,CAAmBI,SAApB,GAAiCC,IAAD,IAAU,CAAC1C,MAAM,CAACuC,QAAP,CAAgB,OAAhB,EAAyB,CAAC,oBAAD,CAAzB,CAAD,EAAmDvC,MAAM,CAACwC,SAAP,CAAiBxC,MAAM,CAAC2C,KAAP,CAAaD,IAAI,CAAC,CAAD,CAAjB,CAAjB,CAAnD,CAFlB;EAGxB,CAAC3C,SAAS,CAACsC,QAAV,CAAmBO,SAApB,GAAgC,MAAM,CAAC5C,MAAM,CAACuC,QAAP,CAAgB,OAAhB,EAAyB,CAAC,oBAAD,CAAzB,CAAD,EAAmDvC,MAAM,CAACwC,SAAP,CAAiBxC,MAAM,CAAC2C,KAAP,CAAa,WAAb,CAAjB,CAAnD;AAHd,CAA5B;;AAUA,MAAME,UAAN,CAAiB;EAQbC,WAAW,CAACC,OAAD,EAAUC,MAAV,EAAkBC,SAAlB,EAA6B;IACpC,KAAKD,MAAL,GAAcA,MAAd;IACA,KAAKE,UAAL,GAAkBH,OAAO,CAACI,SAA1B;IACA,KAAKC,YAAL,GAAoBL,OAAO,CAACK,YAA5B;IAEA,KAAKH,SAAL,GAAiBA,SAAjB;EACH;;EAEDI,SAAS,CAACC,MAAD,EAAS;IACd,KAAKN,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAwB,0CAA0CD,MAAM,CAAC3B,IAAjD,GAAwD,MAAhF;;IAEA,KAAK6B,oBAAL,CAA0BF,MAA1B;;IACA,KAAKG,oBAAL,CAA0BH,MAA1B;;IACA,KAAKI,kBAAL,CAAwBJ,MAAxB;;IACA,KAAKK,0BAAL,CAAgCL,MAAhC;;IAIA,IAAI,KAAKF,YAAT,EAAuB;MACnB,KAAKQ,uBAAL,CAA6BN,MAA7B;IACH;EACJ;;EAEDE,oBAAoB,CAACF,MAAD,EAAS;IACzB,IAAIO,WAAW,GAAGnE,MAAM,CAACoE,UAAP,CAAkBR,MAAM,CAAC3B,IAAzB,CAAlB;IAEA,IAAIoC,MAAM,GAAG;MACTC,MAAM,EAAE,KAAKf,SAAL,CAAee,MADd;MAETC,SAAS,EAAEJ,WAFF;MAGTK,UAAU,EAAEZ,MAAM,CAAC3B,IAHV;MAITwC,QAAQ,EAAEC,IAAI,CAACC,SAAL,CAAeC,MAAM,CAACC,IAAP,CAAYjB,MAAM,CAACa,QAAnB,CAAf;IAJD,CAAb;IAOA,IAAIK,aAAa,GAAGjF,IAAI,CAACkF,OAAL,CAAaC,SAAb,EAAwB,UAAxB,EAAoC,KAAKzB,SAAL,CAAee,MAAnD,EAA2D,kBAA3D,CAApB;IACA,IAAIW,SAAS,GAAG7E,IAAI,CAAC8E,UAAL,CAAgBJ,aAAhB,EAA+BT,MAA/B,CAAhB;IAEA,IAAIc,aAAa,GAAGtF,IAAI,CAACkF,OAAL,CAAa,KAAKvB,UAAlB,EAA8BW,WAAW,GAAG,KAA5C,CAApB;IACAhE,EAAE,CAACiF,cAAH,CAAkBD,aAAlB;IACAhF,EAAE,CAACkF,aAAH,CAAiBF,aAAjB,EAAgCF,SAAhC;IAEA,KAAK3B,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAwB,+BAA+BsB,aAAvD;EACH;;EAEDnB,kBAAkB,CAACJ,MAAD,EAAS;IAEvB7D,CAAC,CAACuF,MAAF,CAAS1B,MAAM,CAAC2B,KAAhB,EAAuB,CAACC,QAAD,EAAWlE,IAAX,KAAoB;MACvC,MAAMmE,QAAQ,GAAG7B,MAAM,CAACN,MAAP,CAAcoC,WAAd,CAA0BpE,IAA1B,EAAgCkE,QAAhC,CAAjB;;MACA,IAAIC,QAAQ,CAACnE,IAAT,KAAkBb,KAAK,CAACkF,IAAN,CAAW1D,IAAjC,EAAuC;QACnC,MAAMkC,WAAW,GAAGnE,MAAM,CAACoE,UAAP,CAAkB9C,IAAlB,CAApB;QAEA,MAAMsE,OAAO,GAAI;AACjC,MAAMH,QAAQ,CAACI,MAAT,CACGxD,GADH,CACQyD,GAAD,IAAU,GAAE9F,MAAM,CAAC+F,SAAP,CAAiBD,GAAjB,EAAsBE,WAAtB,EAAoC,MAAKF,GAAI,GADhE,EAEGrD,IAFH,CAEQ,SAFR,CAEmB;AACzB,GAJgB;QAMA,MAAM0C,aAAa,GAAGtF,IAAI,CAACkF,OAAL,CAAa,KAAKvB,UAAlB,EAA8BI,MAAM,CAAC3B,IAArC,EAA2C,OAA3C,EAAoDkC,WAAW,GAAG,KAAlE,CAAtB;QACAhE,EAAE,CAACiF,cAAH,CAAkBD,aAAlB;QACAhF,EAAE,CAACkF,aAAH,CAAiBF,aAAjB,EAAgCS,OAAhC;QAEA,KAAKtC,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAwB,qCAAqCsB,aAA7D;MACH;IACJ,CAjBD;EAkBH;;EAEDpB,oBAAoB,CAACH,MAAD,EAAS;IACzB7D,CAAC,CAACuF,MAAF,CAAS1B,MAAM,CAACa,QAAhB,EAA0B,CAACwB,MAAD,EAASC,kBAAT,KAAgC;MACtD,IAAI/B,WAAW,GAAGnE,MAAM,CAACoE,UAAP,CAAkB8B,kBAAlB,CAAlB;MAGA,IAAIC,aAAa,GAAG;QAChBC,kBAAkB,EAAE,EADJ;QAEhBC,eAAe,EAAE;MAFD,CAApB;;MAKA,IAAI;QAAEC,GAAG,EAAEC,YAAP;QAAqBC;MAArB,IAAyC,KAAKC,sBAAL,CAA4BR,MAA5B,EAAoCE,aAApC,CAA7C;;MACAI,YAAY,GAAG,CAACA,YAAD,CAAf;MAGA,IAAIG,UAAU,GAAG,CAAC3G,CAAC,CAAC4G,SAAF,CAAYV,MAAM,CAACW,GAAnB,CAAD,CAAjB;;MAEA,IAAIX,MAAM,CAACY,OAAX,EAAoB;QAChBZ,MAAM,CAACY,OAAP,CAAeC,OAAf,CAAwBC,KAAD,IAAW;UAC9B,IAAIA,KAAK,CAACC,MAAV,EAAkB;YACdN,UAAU,CAACO,IAAX,CAAgBF,KAAK,CAACG,MAAtB;UACH;QACJ,CAJD;MAKH;;MAED,IAAIC,SAAS,GAAG;QACZ3C,UAAU,EAAEZ,MAAM,CAAC3B,IADP;QAEZA,IAAI,EAAEiE,kBAFM;QAGZkB,QAAQ,EAAEnB,MAAM,CAACW,GAHL;QAIZM,MAAM,EAAEnH,CAAC,CAACsH,SAAF,CAAYpB,MAAM,CAACiB,MAAnB,EAA4BI,CAAD,IAAOvH,CAAC,CAACwH,IAAF,CAAOD,CAAC,CAACE,MAAF,EAAP,EAAmB,WAAnB,CAAlC,CAJI;QAKZC,QAAQ,EAAExB,MAAM,CAACwB,QAAP,IAAmB,EALjB;QAMZf;MANY,CAAhB;;MASA,IAAIT,MAAM,CAACyB,WAAX,EAAwB;QACpBP,SAAS,CAACO,WAAV,GAAwBzB,MAAM,CAACyB,WAA/B;MACH;;MAED,IAAI,CAAC3H,CAAC,CAAC4H,OAAF,CAAU1B,MAAM,CAACY,OAAjB,CAAL,EAAgC;QAC5BM,SAAS,CAACN,OAAV,GAAoBZ,MAAM,CAACY,OAA3B;MACH;;MAED,IAAI,CAAC9G,CAAC,CAAC4H,OAAF,CAAU1B,MAAM,CAACwB,QAAjB,CAAL,EAAiC;QAC7BN,SAAS,CAACM,QAAV,GAAqBxB,MAAM,CAACwB,QAA5B;MACH;;MAED,IAAI,CAAC1H,CAAC,CAAC4H,OAAF,CAAU1B,MAAM,CAAC2B,YAAjB,CAAL,EAAqC;QACjCT,SAAS,CAACS,YAAV,GAAyB3B,MAAM,CAAC2B,YAAhC;MACH;;MAED,IAAI,CAAC7H,CAAC,CAAC4H,OAAF,CAAUnB,eAAV,CAAL,EAAiC;QAC7BW,SAAS,CAACU,iBAAV,GAA8BrB,eAA9B;MACH;;MAGD,IAAIP,MAAM,CAAC6B,UAAX,EAAuB;QACnB,IAAIC,aAAa,GAAG,KAAKC,gBAAL,CAAsB/B,MAAtB,EAA8BkB,SAA9B,EAAyChB,aAAzC,CAApB;;QAIAI,YAAY,GAAGA,YAAY,CAAC0B,MAAb,CAAoBF,aAApB,CAAf;MACH;;MAED,IAAIG,WAAW,GAAG,EAAlB;;MAGA,IAAI,CAACnI,CAAC,CAAC4H,OAAF,CAAUxB,aAAa,CAACC,kBAAxB,CAAL,EAAkD;QAC9CrG,CAAC,CAACuF,MAAF,CAASa,aAAa,CAACC,kBAAvB,EAA2C,CAAC+B,QAAD,EAAWC,YAAX,KAA4B;UACnEF,WAAW,CAACjB,IAAZ,CAAiB3G,MAAM,CAAC+H,SAAP,CAAiB/H,MAAM,CAACgI,UAAP,CAAkBF,YAAlB,EAAgC,MAAMD,QAAtC,CAAjB,CAAjB;QACH,CAFD;MAGH;;MAED,IAAI,CAACpI,CAAC,CAAC4H,OAAF,CAAUxB,aAAa,CAACE,eAAxB,CAAL,EAA+C;QAC3CtG,CAAC,CAACwI,IAAF,CAAOpC,aAAa,CAACE,eAArB,EAAuCmC,KAAD,IAAW;UAC7C,KAAKC,6BAAL,CAAmC7E,MAAnC,EAA2C4E,KAA3C;QACH,CAFD;MAGH;;MAGD,MAAME,WAAW,GAAGzC,MAAM,CAAC0C,UAAP,CAAkBD,WAAtC;;MACA,IAAIA,WAAJ,EAAiB;QACbvB,SAAS,CAACyB,WAAV,GAAwBF,WAAxB;QACAvB,SAAS,CAAC0B,WAAV,GAAwB,KAAKvF,MAAL,CAAYwF,GAAZ,CAAgBC,QAAhB,CAAyBC,IAAzB,CAA8BC,YAA9B,CAA2CP,WAA3C,CAAxB;MACH;;MAED,IAAIrE,MAAM,GAAG;QACT6E,OAAO,EAAEhB,WAAW,CAACzF,IAAZ,CAAiB,IAAjB,CADA;QAET8B,SAAS,EAAEJ,WAFF;QAGTgF,UAAU,EAAEjH,WAAW,CAACwC,IAAI,CAACC,SAAL,CAAewC,SAAf,EAA0B,IAA1B,EAAgC,CAAhC,CAAD,EAAqC,CAArC,CAHd;QAITiC,SAAS,EAAElH,WAAW,CAACqE,YAAY,CAAClE,GAAb,CAAkBgH,KAAD,IAAW/I,MAAM,CAAC+H,SAAP,CAAiBgB,KAAjB,CAA5B,EAAqD5G,IAArD,CAA0D,MAA1D,CAAD,EAAoE,CAApE,CAJb;QAKT6G,QAAQ,EAAEpH,WAAW,CACjB5B,MAAM,CAAC+H,SAAP,CACI/H,MAAM,CAACiJ,QAAP,CACIxJ,CAAC,CAACyJ,MAAF,CACIrD,aAAa,CAACE,eADlB,EAEI,CAACoD,MAAD,EAASC,OAAT,KAAqB;UACjBD,MAAM,CAAC,MAAMC,OAAO,CAACtB,YAAf,CAAN,GAAqC9H,MAAM,CAAC2C,KAAP,CAAayG,OAAO,CAACtB,YAArB,CAArC;UACA,OAAOqB,MAAP;QACH,CALL,EAMI,EANJ,CADJ,CADJ,CADiB,EAajB,CAbiB;MALZ,CAAb;MAuBA,IAAI3E,aAAa,GAAGjF,IAAI,CAACkF,OAAL,CAAaC,SAAb,EAAwB,UAAxB,EAAoC,KAAKzB,SAAL,CAAee,MAAnD,EAA2D,qBAA3D,CAApB;MACA,IAAIW,SAAS,GAAG7E,IAAI,CAAC8E,UAAL,CAAgBJ,aAAhB,EAA+BT,MAA/B,CAAhB;MAEA,IAAIc,aAAa,GAAGtF,IAAI,CAACkF,OAAL,CAAa,KAAKvB,UAAlB,EAA8BI,MAAM,CAAC3B,IAArC,EAA2C,MAA3C,EAAmDkC,WAAW,GAAG,KAAjE,CAApB;MACAhE,EAAE,CAACiF,cAAH,CAAkBD,aAAlB;MACAhF,EAAE,CAACkF,aAAH,CAAiBF,aAAjB,EAAgCF,SAAhC;MAEA,KAAK3B,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAwB,6BAA6BsB,aAArD;IACH,CAlHD;EAmHH;;EAEDlB,0BAA0B,CAACL,MAAD,EAAS;IAE/B7D,CAAC,CAACuF,MAAF,CAAS1B,MAAM,CAACa,QAAhB,EAA0B,CAACwB,MAAD,EAASC,kBAAT,KAAgC;MACtDnG,CAAC,CAACwI,IAAF,CAAOtC,MAAM,CAAC0D,MAAd,EAAsB,CAACA,MAAD,EAASC,YAAT,KAA0B;QAC5C,MAAMC,gBAAgB,GAAG,EAAzB;QACA,MAAMZ,YAAY,GAAG,IAAIa,GAAJ,EAArB;QACA,MAAMxD,GAAG,GAAGhG,MAAM,CAACyJ,UAAP,EAAZ;QAEAJ,MAAM,CAAC7C,OAAP,CAAgBkD,KAAD,IAAW;UAEtB,IAAIA,KAAK,CAAC/H,IAAN,CAAWgI,UAAX,CAAsB,GAAtB,CAAJ,EAAgC;YAC5B,MAAMC,KAAK,GAAGF,KAAK,CAAC/H,IAAN,CAAWkI,MAAX,CAAkB,CAAlB,CAAd;YACA,MAAMC,SAAS,GAAGnE,MAAM,CAAC2B,YAAP,CAAoBsC,KAApB,CAAlB;;YAEA,IAAI,CAACE,SAAL,EAAgB;cACZ,MAAM,IAAIC,KAAJ,CAAW,gBAAeH,KAAM,0BAAyBhE,kBAAmB,IAA5E,CAAN;YACH;;YAED,IAAI,CAAC8D,KAAK,CAACM,IAAX,EAAiB;cACb,MAAM,IAAID,KAAJ,CACD,6DAA4DT,YAAa,aAAY1D,kBAAmB,YAAWgE,KAAM,uBAAsBE,SAAS,CAACnE,MAAO,EAD/J,CAAN;YAGH;;YAED,MAAMsE,GAAG,GAAI,GAAEH,SAAS,CAACnE,MAAO,IAAG+D,KAAK,CAACM,IAAK,EAA9C;YACArB,YAAY,CAACuB,GAAb,CAAiBD,GAAjB;;YAEA,IAAIH,SAAS,CAACK,IAAd,EAAoB;cAChBZ,gBAAgB,CAACG,KAAK,CAAC/H,IAAP,CAAhB,GAA+B3B,MAAM,CAACiJ,QAAP,CAAgB;gBAC3CjI,IAAI,EAAE,OADqC;gBAE3CoJ,aAAa,EAAE;kBACXpJ,IAAI,EAAE,QADK;kBAEXsC,MAAM,EAAEtD,MAAM,CAACqK,OAAP,CAAe5K,CAAC,CAAC6K,SAAF,CAAYL,GAAZ,CAAf,EAAiC,EAAjC;gBAFG,CAF4B;gBAM3C,GAAGxK,CAAC,CAAC8K,IAAF,CAAOb,KAAP,EAAc,CAAC,UAAD,CAAd;cANwC,CAAhB,CAA/B;YAQH,CATD,MASO;cACHH,gBAAgB,CAACG,KAAK,CAAC/H,IAAP,CAAhB,GAA+B3B,MAAM,CAACiJ,QAAP,CAAgB;gBAC3CjI,IAAI,EAAE,QADqC;gBAE3CsC,MAAM,EAAEtD,MAAM,CAACqK,OAAP,CAAe5K,CAAC,CAAC6K,SAAF,CAAYL,GAAZ,CAAf,EAAiC,EAAjC,CAFmC;gBAG3C,GAAGxK,CAAC,CAAC8K,IAAF,CAAOb,KAAP,EAAc,CAAC,UAAD,CAAd;cAHwC,CAAhB,CAA/B;YAKH;UACJ,CAjCD,MAiCO;YACH,MAAMc,KAAK,GAAG7E,MAAM,CAACiB,MAAP,CAAc8C,KAAK,CAAC/H,IAApB,CAAd;;YAEA,IAAI,CAAC6I,KAAL,EAAY;cACR,MAAM,IAAIT,KAAJ,CAAW,UAASL,KAAK,CAAC/H,IAAK,0BAAyBiE,kBAAmB,IAA3E,CAAN;YACH;;YAED2D,gBAAgB,CAACG,KAAK,CAAC/H,IAAP,CAAhB,GAA+B3B,MAAM,CAACiJ,QAAP,CAAgB,EAC3C,GAAGxJ,CAAC,CAAC8K,IAAF,CAAOC,KAAP,EAAc,CAAC,MAAD,EAAS,QAAT,CAAd,CADwC;cAE3C,GAAG/K,CAAC,CAAC8K,IAAF,CAAOb,KAAP,EAAc,CAAC,UAAD,CAAd;YAFwC,CAAhB,CAA/B;UAIH;QACJ,CA/CD;QAmDA,MAAMe,UAAU,GAAGC,KAAK,CAACC,IAAN,CAAWhC,YAAX,EAAyB5G,GAAzB,CAA8BkI,GAAD,IAC5CjK,MAAM,CAACgI,UAAP,CAAkBvI,CAAC,CAAC6K,SAAF,CAAYL,GAAZ,CAAlB,EAAqC,KAAIA,GAAI,EAA7C,CADe,CAAnB;QAIAjK,MAAM,CAAC4K,aAAP,CACI5E,GADJ,EAEIhG,MAAM,CAAC6K,SAAP,CACI7K,MAAM,CAAC8K,SAAP,CAAiB,gBAAjB,CADJ,EAEI9K,MAAM,CAAC+K,oBAAP,CAA4B,EAA5B,EAAgCN,UAAU,CAAC9C,MAAX,CAAkB3H,MAAM,CAACwC,SAAP,CAAiB+G,gBAAjB,CAAlB,CAAhC,CAFJ,CAFJ;QAQA,IAAIyB,mBAAmB,GAAGzL,IAAI,CAACkF,OAAL,CACtB,KAAKvB,UADiB,EAEtBI,MAAM,CAAC3B,IAFe,EAGtB,QAHsB,EAItBiE,kBAAkB,GAAG,GAArB,GAA2B0D,YAA3B,GAA0C,KAJpB,CAA1B;QAMAzJ,EAAE,CAACiF,cAAH,CAAkBkG,mBAAlB;QACAnL,EAAE,CAACkF,aAAH,CAAiBiG,mBAAjB,EAAsChL,MAAM,CAAC+H,SAAP,CAAiB/B,GAAjB,CAAtC;QAEA,KAAKhD,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAwB,oCAAoCyH,mBAA5D;MACH,CA9ED;IA+EH,CAhFD;EAiFH;;EAEDpH,uBAAuB,CAACN,MAAD,EAAS;IA6D5B,MAAM2H,OAAO,GAAG,EAAhB;;IAGAxL,CAAC,CAACuF,MAAF,CAAS1B,MAAM,CAACa,QAAhB,EAA0B,CAACwB,MAAD,EAASC,kBAAT,KAAgC;MAuBtDqF,OAAO,CAACrF,kBAAD,CAAP,GAA8BD,MAAM,CAACuB,MAAP,EAA9B;IAcH,CArCD;;IAuCA,IAAIgE,qBAAqB,GAAG3L,IAAI,CAACkF,OAAL,CAAa,KAAKrB,YAAlB,EAAgCE,MAAM,CAAC3B,IAAvC,EAA6C,cAA7C,CAA5B;IACA9B,EAAE,CAACiF,cAAH,CAAkBoG,qBAAlB;IACArL,EAAE,CAACkF,aAAH,CAAiBmG,qBAAjB,EAAwC9G,IAAI,CAACC,SAAL,CAAe4G,OAAf,EAAwB,IAAxB,EAA8B,CAA9B,CAAxC;IAEA,KAAKjI,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAwB,gCAAgC2H,qBAAxD;EACH;;EAyGD/E,sBAAsB,CAACR,MAAD,EAASE,aAAT,EAAwB;IAC1C,IAAIsF,cAAc,GAAGlL,SAAS,CAACmL,oBAAV,CAA+BzF,MAAM,CAAC0C,UAAP,CAAkB1G,IAAjD,EAAuD,KAAKqB,MAA5D,EAAoE6C,aAApE,CAArB;IACAsF,cAAc,CAACE,SAAf,CAAyB,KAAzB,IAAkC;MAAEC,MAAM,EAAE,SAAV;MAAqBC,SAAS,EAAE;IAAhC,CAAlC;IACAJ,cAAc,CAACE,SAAf,CAAyB,MAAzB,IAAmC;MAAEC,MAAM,EAAE,SAAV;MAAqBC,SAAS,EAAE;IAAhC,CAAnC;IACAJ,cAAc,CAACE,SAAf,CAAyB,WAAzB,IAAwC;MAAEC,MAAM,EAAE,SAAV;MAAqBC,SAAS,EAAE;IAAhC,CAAxC;IACAJ,cAAc,CAACE,SAAf,CAAyB,QAAzB,IAAqC;MAAEC,MAAM,EAAE;IAAV,CAArC;IAEA,MAAME,WAAW,GAAGvL,SAAS,CAACwL,YAAV,CAAuBN,cAAvB,EAAuC,OAAvC,CAApB;IAGA,IAAIjF,eAAe,GAAG,EAAtB;;IAEAzG,CAAC,CAACuF,MAAF,CAASW,MAAM,CAACiB,MAAhB,EAAwB,CAAC4D,KAAD,EAAQkB,SAAR,KAAsB;MAC1C,IAAIC,MAAM,GAAG1L,SAAS,CAAC2L,YAAV,CAAuBF,SAAvB,EAAkClB,KAAlC,EAAyCW,cAAzC,CAAb;MACAlL,SAAS,CAAC4L,SAAV,CAAoBV,cAApB,EAAoCQ,MAApC,EAA4CH,WAA5C;;MAEA,IAAIhB,KAAK,CAACsB,SAAN,IAAmBtB,KAAK,CAACuB,qBAA7B,EAAoD;QAChDnM,cAAc,CAACsG,eAAD,EAAkBwF,SAAlB,EAA6B;UAAEM,SAAS,EAAEN,SAAb;UAAwBO,YAAY,EAAE;QAAtC,CAA7B,CAAd;MACH;IACJ,CAPD;;IASA,IAAIC,IAAI,GAAGf,cAAc,CAACgB,QAAf,CAAwBC,IAAxB,EAAX;IAGAF,IAAI,GAAGA,IAAI,CAACG,MAAL,CAAapC,GAAD,IAASkB,cAAc,CAACmB,gBAAf,CAAgCC,GAAhC,CAAoCtC,GAApC,CAArB,CAAP;IAGA,IAAIuC,yBAAyB,GAAG,EAAhC;IAAA,IACIC,eADJ;IAAA,IAEIC,eAAe,GAAG,EAFtB;IAAA,IAGIvL,SAHJ;IAAA,IAIIwL,WAJJ;;IAMA,MAAMC,2BAA2B,GAAG,UAAUlB,SAAV,EAAqBmB,UAArB,EAAiCC,QAAjC,EAA2CC,kBAA3C,EAA+D;MAC/F,IAAInG,MAAM,GAAG,CAAC8E,SAAD,EAAY/D,MAAZ,CAAmBkF,UAAnB,CAAb;MACA,IAAIG,OAAO,GAAGpG,MAAM,CAACzE,IAAP,CAAY,GAAZ,CAAd;;MAEA,IAAIsK,eAAe,IAAIA,eAAe,CAACO,OAAhB,KAA4BA,OAAnD,EAA4D;QACxDR,yBAAyB,GAAGA,yBAAyB,CAAC7E,MAA1B,CACxBzH,QAAQ,CAAC+M,sBAAT,CACIR,eAAe,CAACf,SADpB,EAEIe,eAAe,CAACI,UAFpB,EAGIH,eAHJ,EAIID,eAAe,CAACM,kBAJpB,CADwB,CAA5B;QAQAL,eAAe,GAAG,EAAlB;MACH;;MAEDA,eAAe,GAAGA,eAAe,CAAC/E,MAAhB,CAAuBmF,QAAvB,CAAlB;MACAL,eAAe,GAAG;QACdf,SADc;QAEdmB,UAFc;QAGdE,kBAHc;QAIdC;MAJc,CAAlB;IAMH,CAvBD;;IA2BAvN,CAAC,CAACwI,IAAF,CAAOiE,IAAP,EAAa,CAACjC,GAAD,EAAMhI,CAAN,KAAY;MAErB,IAAIiL,SAAS,GAAG/B,cAAc,CAACmB,gBAAf,CAAgCa,GAAhC,CAAoClD,GAApC,CAAhB;MAGA,IAAImD,QAAQ,GAAGjC,cAAc,CAACkC,MAAf,CAAsBpD,GAAtB,CAAf;MAEA,IAAIqD,eAAe,GAAG9M,YAAY,CAAC0M,SAAS,CAACjM,MAAX,CAAlC;;MAEA,IAAIiM,SAAS,CAACL,UAAV,IAAwBK,SAAS,CAACL,UAAV,CAAqBU,MAArB,GAA8B,CAA1D,EAA6D;QACzD,IAAIC,cAAc,GAAGtH,eAAe,CAACoH,eAAD,CAApC;;QACA,IAAI,CAACE,cAAL,EAAqB;UACjBtH,eAAe,CAACoH,eAAD,CAAf,GAAmCE,cAAc,GAAG,EAApD;QACH;;QAED,IAAIN,SAAS,CAAClM,IAAV,KAAmBf,SAAS,CAACM,sBAAjC,EAAyD;UACrD2M,SAAS,CAACL,UAAV,CAAqBrG,OAArB,CAA8BiH,GAAD,IAAS;YAClCD,cAAc,CAAC7G,IAAf,CAAoB;cAAEqF,SAAS,EAAEyB,GAAb;cAAkBC,QAAQ,EAAE;YAA5B,CAApB;UACH,CAFD;QAGH,CAJD,MAIO;UACHR,SAAS,CAACL,UAAV,CAAqBrG,OAArB,CAA8BiH,GAAD,IAAS;YAClC,IAAID,cAAc,CAACzM,OAAf,CAAuB0M,GAAvB,MAAgC,CAAC,CAArC,EAAwCD,cAAc,CAAC7G,IAAf,CAAoB8G,GAApB;UAC3C,CAFD;QAGH;MACJ;;MAED,IAAItM,SAAJ,EAAe;QACXiM,QAAQ,GAAGlM,SAAS,CAACC,SAAD,EAAYwL,WAAZ,EAAyBS,QAAzB,EAAmCF,SAAS,CAAClM,IAA7C,CAApB;QACAG,SAAS,GAAGwM,SAAZ;MACH;;MAED,IAAI1L,CAAC,GAAGiK,IAAI,CAACqB,MAAL,GAAc,CAAtB,EAAyB;QACrB,IAAIK,QAAQ,GAAGzC,cAAc,CAACmB,gBAAf,CAAgCa,GAAhC,CAAoCjB,IAAI,CAACjK,CAAC,GAAG,CAAL,CAAxC,CAAf;;QAEA,IAAIrB,WAAW,CAACsM,SAAD,EAAYU,QAAZ,CAAf,EAAsC;UAClCzM,SAAS,GAAGiM,QAAZ;UACAT,WAAW,GAAGO,SAAS,CAAClM,IAAxB;UACA;QACH;MACJ;;MAED,IAAIkM,SAAS,CAAClM,IAAV,KAAmBf,SAAS,CAACI,sBAAjC,EAAyD;QAErD,IAAIyM,QAAQ,GAAG5M,QAAQ,CAAC2N,cAAT,CAAwBP,eAAxB,EAAyCF,QAAzC,CAAf;;QAEAR,2BAA2B,CAACU,eAAD,EAAkBJ,SAAS,CAACL,UAA5B,EAAwCC,QAAxC,EAAkD,IAAlD,CAA3B;MACH,CALD,MAKO,IAAII,SAAS,CAAClM,IAAV,KAAmBf,SAAS,CAACK,sBAAjC,EAAyD;QAC5D,IAAIwM,QAAQ,GAAG9M,MAAM,CAAC6K,SAAP,CACX7K,MAAM,CAAC8K,SAAP,CAAiBoC,SAAS,CAACjM,MAA3B,EAAmC,IAAnC,CADW,EAEXmM,QAFW,EAGV,eAAcE,eAAgB,GAHpB,CAAf;;QAMAV,2BAA2B,CAACU,eAAD,EAAkBJ,SAAS,CAACL,UAA5B,EAAwCC,QAAxC,EAAkD,IAAlD,CAA3B;MACH,CARM,MAQA,IAAII,SAAS,CAAClM,IAAV,KAAmBf,SAAS,CAACM,sBAAjC,EAAyD;QAC5D,IAAIuM,QAAQ,GAAG5M,QAAQ,CAAC4N,eAAT,CACXV,QADW,EAEXpN,MAAM,CAAC8K,SAAP,CAAiBoC,SAAS,CAACjM,MAA3B,EAAmC,IAAnC,CAFW,EAGV,eAAcqM,eAAgB,GAHpB,CAAf;;QAMAV,2BAA2B,CAACU,eAAD,EAAkBJ,SAAS,CAACL,UAA5B,EAAwCC,QAAxC,EAAkD,KAAlD,CAA3B;MACH,CARM,MAQA;QACH,MAAM,IAAI/C,KAAJ,CAAU,oBAAV,CAAN;MAGH;IACJ,CAnED;;IA6EA,IAAI,CAACtK,CAAC,CAAC4H,OAAF,CAAUqF,eAAV,CAAL,EAAiC;MAC7BF,yBAAyB,GAAGA,yBAAyB,CAAC7E,MAA1B,CACxBzH,QAAQ,CAAC+M,sBAAT,CACIR,eAAe,CAACf,SADpB,EAEIe,eAAe,CAACI,UAFpB,EAGIH,eAHJ,EAIID,eAAe,CAACM,kBAJpB,CADwB,CAA5B;IAQH;;IAWD,OAAO;MACH/G,GAAG,EAAEhG,MAAM,CAAC+N,eAAP,CACDrM,iBAAiB,CAAC,gBAAD,CADhB,EAED,CAAC,SAAD,EAAY,YAAZ,CAFC,EAGDxB,QAAQ,CAAC8N,qBAAT,CACKrG,MADL,CACY6E,yBADZ,EAEK7E,MAFL,CAEY,CAAC3H,MAAM,CAACwC,SAAP,CAAiBxC,MAAM,CAAC2C,KAAP,CAAa,SAAb,CAAjB,CAAD,CAFZ,CAHC,EAMD,KANC,EAOD,IAPC,EAQD,IARC,EASD,iDATC,CADF;MAYHuD;IAZG,CAAP;EAcH;;EAEDiC,6BAA6B,CAAC7E,MAAD,EAAS;IAAEwE,YAAF;IAAgBmG,WAAhB;IAA6BpG,QAA7B;IAAuCnF;EAAvC,CAAT,EAAwD;IACjF,IAAIwL,QAAQ,GAAG3O,IAAI,CAACkF,OAAL,CAAa,KAAKvB,UAAlB,EAA8BI,MAAM,CAAC3B,IAArC,EAA2CkG,QAA3C,CAAf;;IAEA,IAAIhI,EAAE,CAACsO,UAAH,CAAcD,QAAd,CAAJ,EAA6B;MAEzB,KAAKlL,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAyB,GAAE9D,CAAC,CAAC2O,UAAF,CAAaH,WAAb,CAA0B,KAAIpG,QAAS,oCAAlE;MAEA;IACH;;IAED,IAAI7B,GAAG,GAAGhG,MAAM,CAACyJ,UAAP,EAAV;IAEAzJ,MAAM,CAAC4K,aAAP,CAAqB5E,GAArB,EAA0BhG,MAAM,CAACqO,WAAP,CAAmBvG,YAAnB,EAAiCpF,IAAjC,EAAuCN,mBAAmB,CAAC6L,WAAD,CAAnB,CAAiCvL,IAAjC,CAAvC,CAA1B;IACA1C,MAAM,CAAC4K,aAAP,CAAqB5E,GAArB,EAA0BhG,MAAM,CAAC6K,SAAP,CAAiB,gBAAjB,EAAmC7K,MAAM,CAAC8K,SAAP,CAAiBhD,YAAjB,CAAnC,CAA1B;IAEAjI,EAAE,CAACiF,cAAH,CAAkBoJ,QAAlB;IACArO,EAAE,CAACkF,aAAH,CAAiBmJ,QAAjB,EAA2BlO,MAAM,CAAC+H,SAAP,CAAiB/B,GAAjB,CAA3B;IACA,KAAKhD,MAAL,CAAYO,GAAZ,CAAgB,MAAhB,EAAyB,aAAY0K,WAAY,UAASC,QAAS,EAAnE;EACH;;EAEDxG,gBAAgB,CAAC/B,MAAD,EAAS2I,aAAT,EAAwBzI,aAAxB,EAAuC;IACnD,IAAIG,GAAG,GAAG,EAAV;;IAEAvG,CAAC,CAACuF,MAAF,CAASW,MAAM,CAAC6B,UAAhB,EAA4B,CAAC+G,MAAD,EAAS5M,IAAT,KAAkB;MAC1C,KAAKqB,MAAL,CAAYwL,IAAZ,CAAiB,yBAAyB7M,IAA1C;MAEA,IAAI8M,OAAO,GAAG,CACVzO,MAAM,CAAC0O,aAAP,CACI,OADJ,EAEI1O,MAAM,CAAC8K,SAAP,CAAiB,0BAA0BnJ,IAA3C,CAFJ,EAGI,IAHJ,EAII,KAJJ,EAKI,0BALJ,CADU,CAAd;MAUA,IAAIwJ,cAAc,GAAGlL,SAAS,CAACmL,oBAAV,CAA+BzF,MAAM,CAAC0C,UAAP,CAAkB1G,IAAjD,EAAuD,KAAKqB,MAA5D,EAAoE6C,aAApE,CAArB;MAEA,IAAI8I,SAAJ;;MAEA,IAAIJ,MAAM,CAACK,MAAX,EAAmB;QACfD,SAAS,GAAG,KAAKE,cAAL,CAAoBN,MAAM,CAACK,MAA3B,EAAmCzD,cAAnC,CAAZ;MACH;;MAGDmD,aAAa,CAAC,YAAD,CAAb,KAAgCA,aAAa,CAAC,YAAD,CAAb,GAA8B,EAA9D;MACAA,aAAa,CAAC,YAAD,CAAb,CAA4B3M,IAA5B,IAAoC;QAAEmN,MAAM,EAAExK,MAAM,CAACiB,MAAP,CAAcoJ,SAAd;MAAV,CAApC;;MAEAlP,CAAC,CAACwI,IAAF,CAAOsG,MAAM,CAACQ,cAAd,EAA8B,CAACC,SAAD,EAAYvI,KAAZ,KAAsB;QAEhDxG,SAAS,CAACgP,kBAAV,CAA6BxI,KAA7B,EAAoCuI,SAApC,EAA+C7D,cAA/C,EAA+DA,cAAc,CAAC+D,WAA9E;MACH,CAHD;;MAKA,IAAIX,MAAM,CAACY,MAAX,EAAmB;QACflP,SAAS,CAACmP,wBAAV,CAAmCb,MAAM,CAACY,MAA1C,EAAkDhE,cAAlD;MACH;;MAED,IAAIe,IAAI,GAAGf,cAAc,CAACgB,QAAf,CAAwBC,IAAxB,EAAX;MAGAF,IAAI,GAAGA,IAAI,CAACG,MAAL,CAAapC,GAAD,IAASkB,cAAc,CAACmB,gBAAf,CAAgCC,GAAhC,CAAoCtC,GAApC,CAArB,CAAP;;MAGAxK,CAAC,CAACwI,IAAF,CAAOiE,IAAP,EAAcjC,GAAD,IAAS;QAClB,IAAIiD,SAAS,GAAG/B,cAAc,CAACmB,gBAAf,CAAgCa,GAAhC,CAAoClD,GAApC,CAAhB;QACA,IAAImD,QAAQ,GAAGjC,cAAc,CAACkC,MAAf,CAAsBpD,GAAtB,CAAf;QAIA,IAAIqD,eAAe,GAAGJ,SAAS,CAACjM,MAAhC;;QAEA,IAAIiM,SAAS,CAAClM,IAAV,KAAmBf,SAAS,CAACI,sBAAjC,EAAyD;UACrD+M,QAAQ,GAAGlN,QAAQ,CAAC2N,cAAT,CAAwBP,eAAxB,EAAyCF,QAAzC,CAAX;QACH,CAFD,MAEO,IAAIF,SAAS,CAAClM,IAAV,KAAmBf,SAAS,CAACK,sBAAjC,EAAyD;UAC5D,IAAI4M,SAAS,CAACmC,WAAd,EAA2B;YACvBjC,QAAQ,GAAGpN,MAAM,CAAC0O,aAAP,CACP1O,MAAM,CAAC8K,SAAP,CAAiBoC,SAAS,CAACjM,MAA3B,CADO,EAEPmM,QAFO,EAGP,KAHO,EAIP,KAJO,EAKN,eAAcE,eAAgB,GALxB,CAAX;UAOH,CARD,MAQO;YACHF,QAAQ,GAAGpN,MAAM,CAAC6K,SAAP,CACP7K,MAAM,CAAC8K,SAAP,CAAiBoC,SAAS,CAACjM,MAA3B,EAAmC,IAAnC,CADO,EAEPmM,QAFO,EAGN,eAAcE,eAAgB,GAHxB,CAAX;UAKH;QACJ,CAhBM,MAgBA,IAAIJ,SAAS,CAAClM,IAAV,KAAmBf,SAAS,CAACM,sBAAjC,EAAyD;UAC5D,IAAI2M,SAAS,CAACmC,WAAd,EAA2B;YACvBjC,QAAQ,GAAGpN,MAAM,CAAC0O,aAAP,CACP1O,MAAM,CAAC8K,SAAP,CAAiBoC,SAAS,CAACjM,MAA3B,CADO,EAEPmM,QAFO,EAGP,KAHO,EAIP,KAJO,EAKN,eAAcE,eAAgB,GALxB,CAAX;UAOH,CARD,MAQO;YACHF,QAAQ,GAAGpN,MAAM,CAAC6K,SAAP,CACP7K,MAAM,CAAC8K,SAAP,CAAiBoC,SAAS,CAACjM,MAA3B,EAAmC,IAAnC,CADO,EAEPmM,QAFO,EAGN,eAAcE,eAAgB,GAHxB,CAAX;UAKH;QACJ;;QAEDmB,OAAO,GAAGA,OAAO,CAAC9G,MAAR,CAAelI,CAAC,CAAC4G,SAAF,CAAY+G,QAAZ,CAAf,CAAV;MACH,CA7CD;;MA+CApH,GAAG,CAACW,IAAJ,CACI3G,MAAM,CAAC+N,eAAP,CACIrM,iBAAiB,CAACC,IAAD,CADrB,EAEI2C,MAAM,CAACC,IAAP,CAAYoK,SAAZ,CAFJ,EAGIF,OAHJ,EAII,KAJJ,EAKI,IALJ,EAMI,IANJ,EAOI9O,IAAI,CAAC2P,UAAL,CAAgB7P,CAAC,CAAC8P,SAAF,CAAY5N,IAAZ,CAAhB,EAAmC,GAAnC,EAAwC,GAAxC,CAPJ,CADJ;IAWH,CAlGD;;IAoGA,OAAOqE,GAAP;EACH;;EAED6I,cAAc,CAACW,YAAD,EAAerE,cAAf,EAA+B;IACzC,IAAIwD,SAAS,GAAG,EAAhB;IAEAa,YAAY,CAAChJ,OAAb,CAAqB,CAACiJ,KAAD,EAAQxN,CAAR,KAAc;MAC/BhC,SAAS,CAACyP,YAAV,CAAuBzN,CAAvB,EAA0BwN,KAA1B,EAAiCtE,cAAjC;MACAwD,SAAS,CAACc,KAAK,CAAC9N,IAAP,CAAT,GAAwB8N,KAAxB;MACAtE,cAAc,CAACE,SAAf,CAAyBoE,KAAK,CAAC9N,IAA/B,IAAuC;QAAE2J,MAAM,EAAE;MAAV,CAAvC;IACH,CAJD;IAMA,OAAOqD,SAAP;EACH;;AA9xBY;;AAiyBjBgB,MAAM,CAACC,OAAP,GAAiB/M,UAAjB"}
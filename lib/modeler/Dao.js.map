{"version":3,"sources":["../../src/modeler/Dao.js"],"names":["path","require","_","naming","text","putIntoBucket","fs","swig","GemlTypes","JsLang","GemlToAst","Snippets","ChainableType","AST_BLK_VALIDATOR_CALL","AST_BLK_PROCESSOR_CALL","AST_BLK_ACTIVATOR_CALL","getFieldName","t","split","pop","isChainable","current","next","indexOf","type","target","chainCall","lastBlock","lastType","currentBlock","currentType","assert","astBinExp","arguments","asyncMethodNaming","name","indentLines","lines","indentation","map","line","i","repeat","join","OOL_MODIFIER_RETURN","Modifier","VALIDATOR","astReturn","PROCESSOR","args","astId","ACTIVATOR","DaoModeler","constructor","context","linker","connector","outputPath","modelPath","manifestPath","modeling_","schema","log","_generateSchemaModel","_generateEntityModel","_generateEntityInputSchema","_generateEntityManifest","capitalized","pascalCase","locals","driver","className","schemaName","entities","JSON","stringify","Object","keys","classTemplate","resolve","__dirname","classCode","renderFile","modelFilePath","ensureFileSync","writeFileSync","_generateEnumTypes","forOwn","entity","entityInstanceName","fields","field","fieldName","sharedContext","mapOfFunctorToFile","newFunctorFiles","ast","astClassMain","fieldReferences","_processFieldModifiers","uniqueKeys","castArray","key","indexes","forEach","index","unique","push","modelMeta","keyField","mapValues","f","omit","toJSON","features","baseClasses","isEmpty","associations","fieldDependencies","interfaces","astInterfaces","_buildInterfaces","concat","importLines","fileName","functionName","astToCode","astRequire","each","entry","_generateFunctionTemplateFile","imports","entityMeta","classBody","block","functors","astValue","reduce","result","functor","inputs","inputSetName","validationSchema","dependencies","Set","astProgram","input","startsWith","assoc","substr","assocMeta","Error","spec","dep","add","list","elementSchema","astCall","camelCase","pick","exportBody","Array","from","astPushInBody","astAssign","astVarRef","astAnonymousFunction","inputSchemaFilePath","diagram","readOnly","fieldSchema","values","optional","entityOutputFilePath","diagramOutputFilePath","compileContext","createCompileContext","gemlModule","variables","source","finalized","allFinished","createTopoId","topoId","compileField","dependsOn","writeOnce","freezeAfterNonDefault","reference","writeProtect","deps","topoSort","sort","filter","mapOfTokenToMeta","has","methodBodyValidateAndFill","lastFieldsGroup","methodBodyCache","lastAstType","_mergeDoValidateAndFillCode","references","astCache","requireTargetField","checker","_fieldRequirementCheck","sourceMap","get","astBlock","astMap","targetFieldName","length","fieldReference","ref","whenNull","undefined","nextType","_validateCheck","_checkAndAssign","astMemberMethod","_applyModifiersHeader","functorType","filePath","existsSync","upperFirst","astFunction","modelMetaInit","method","info","astBody","astVarDeclare","paramMeta","accept","_processParams","params","implementation","operation","compileDbOperation","mainStartId","return","compileExceptionalReturn","needDeclare","replaceAll","kebabCase","acceptParams","param","compileParam","module","exports"],"mappings":"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","sourcesContent":["const path = require(\"path\");\nconst { _, naming, text, putIntoBucket } = require(\"@genx/july\");\nconst { fs } = require(\"@genx/sys\");\nconst swig = require(\"swig-templates\");\n\nconst GemlTypes = require(\"../lang/GemlTypes\");\nconst JsLang = require(\"./util/ast.js\");\nconst GemlToAst = require(\"./util/gemlToAst.js\");\nconst Snippets = require(\"./dao/snippets\");\n\nconst ChainableType = [\n    GemlToAst.AST_BLK_VALIDATOR_CALL,\n    GemlToAst.AST_BLK_PROCESSOR_CALL,\n    GemlToAst.AST_BLK_ACTIVATOR_CALL,\n];\n\nconst getFieldName = (t) => t.split(\".\").pop();\nconst isChainable = (current, next) =>\n    ChainableType.indexOf(current.type) > -1 && current.target === next.target && next.type === current.type;\nconst chainCall = (lastBlock, lastType, currentBlock, currentType) => {\n    if (lastBlock) {\n        if (lastType === \"ValidatorCall\") {\n            assert: currentType === \"ValidatorCall\", \"Unexpected currentType\";\n\n            currentBlock = JsLang.astBinExp(lastBlock, \"&&\", currentBlock);\n        } else {\n            assert: currentType === \"ProcessorCall\", \"Unexpected currentType: \" + currentType + \" last: \" + lastType;\n\n            currentBlock.arguments[0] = lastBlock;\n        }\n    }\n\n    return currentBlock;\n};\nconst asyncMethodNaming = (name) => name + \"_\";\n\nconst indentLines = (lines, indentation) =>\n    lines\n        .split(\"\\n\")\n        .map((line, i) => (i === 0 ? line : _.repeat(\" \", indentation) + line))\n        .join(\"\\n\");\n\nconst OOL_MODIFIER_RETURN = {\n    [GemlTypes.Modifier.VALIDATOR]: () => [JsLang.astReturn(true)],\n    [GemlTypes.Modifier.PROCESSOR]: (args) => [JsLang.astReturn(JsLang.astId(args[0]))],\n    [GemlTypes.Modifier.ACTIVATOR]: () => [JsLang.astReturn(JsLang.astId(\"undefined\"))],\n};\n\n/**\n * Oolong database access object (DAO) modeler.\n * @class\n */\nclass DaoModeler {\n    /**\n     * @param {object} context\n     * @property {GemlLinker} context.linker - Geml linker\n     * @property {object} context.modelPath - Generated model output path\n     * @property {object} context.manifestPath - Entities manifest output path\n     * @param {Connector} connector\n     */\n    constructor(context, linker, connector) {\n        this.linker = linker;\n        this.outputPath = context.modelPath;\n        this.manifestPath = context.manifestPath;\n\n        this.connector = connector;\n    }\n\n    modeling_(schema) {\n        this.linker.log(\"info\", 'Generating entity models for schema \"' + schema.name + '\"...');\n\n        this._generateSchemaModel(schema);\n        this._generateEntityModel(schema);\n        //this._generateEntityEnumTypes(schema);\n        this._generateEntityInputSchema(schema);\n        //this._generateEnumTypes(schema);\n        //this._generateViewModel();\n\n        if (this.manifestPath) {\n            this._generateEntityManifest(schema);\n        }\n    }\n\n    _generateSchemaModel(schema) {\n        let capitalized = naming.pascalCase(schema.name);\n\n        let locals = {\n            driver: this.connector.driver,\n            className: capitalized,\n            schemaName: schema.name,\n            entities: JSON.stringify(Object.keys(schema.entities)),\n        };\n\n        let classTemplate = path.resolve(__dirname, \"database\", this.connector.driver, \"Database.js.swig\");\n        let classCode = swig.renderFile(classTemplate, locals);\n\n        let modelFilePath = path.resolve(this.outputPath, capitalized + \".js\");\n        fs.ensureFileSync(modelFilePath);\n        fs.writeFileSync(modelFilePath, classCode);\n\n        this.linker.log(\"info\", \"Generated database model: \" + modelFilePath);\n    }\n\n    _generateEnumTypes(schema) {\n        _.forOwn(schema.entities, (entity, entityInstanceName) => {\n            _.forOwn(entity.fields, (field, fieldName) => {\n                if (field.type === \"enum\") {\n                }\n            });\n        });\n    }\n\n    _generateEntityModel(schema) {\n        _.forOwn(schema.entities, (entity, entityInstanceName) => {\n            let capitalized = naming.pascalCase(entityInstanceName);\n\n            //shared information with model CRUD and customized interfaces\n            let sharedContext = {\n                mapOfFunctorToFile: {},\n                newFunctorFiles: [],\n            };\n\n            let { ast: astClassMain, fieldReferences } = this._processFieldModifiers(entity, sharedContext);\n            astClassMain = [astClassMain];\n\n            //prepare meta data\n            let uniqueKeys = [_.castArray(entity.key)];\n\n            if (entity.indexes) {\n                entity.indexes.forEach((index) => {\n                    if (index.unique) {\n                        uniqueKeys.push(index.fields);\n                    }\n                });\n            }\n\n            let modelMeta = {\n                schemaName: schema.name,\n                name: entityInstanceName,\n                keyField: entity.key,\n                fields: _.mapValues(entity.fields, (f) => _.omit(f.toJSON(), \"modifiers\")),\n                features: entity.features || {},\n                uniqueKeys,\n            };\n\n            if (entity.baseClasses) {\n                modelMeta.baseClasses = entity.baseClasses;\n            }\n\n            if (!_.isEmpty(entity.indexes)) {\n                modelMeta.indexes = entity.indexes;\n            }\n\n            if (!_.isEmpty(entity.features)) {\n                modelMeta.features = entity.features;\n            }\n\n            if (!_.isEmpty(entity.associations)) {\n                modelMeta.associations = entity.associations;\n            }\n\n            if (!_.isEmpty(fieldReferences)) {\n                modelMeta.fieldDependencies = fieldReferences;\n            }\n\n            //build customized interfaces\n            if (entity.interfaces) {\n                let astInterfaces = this._buildInterfaces(entity, modelMeta, sharedContext);\n                //console.log(astInterfaces);\n                //let astClass = astClassMain[astClassMain.length - 1];\n                //JsLang.astPushInBody(astClass, astInterfaces);\n                astClassMain = astClassMain.concat(astInterfaces);\n            }\n\n            let importLines = [];\n\n            //generate functors if any\n            if (!_.isEmpty(sharedContext.mapOfFunctorToFile)) {\n                _.forOwn(sharedContext.mapOfFunctorToFile, (fileName, functionName) => {\n                    importLines.push(JsLang.astToCode(JsLang.astRequire(functionName, \".\" + fileName)));\n                });\n            }\n\n            if (!_.isEmpty(sharedContext.newFunctorFiles)) {\n                _.each(sharedContext.newFunctorFiles, (entry) => {\n                    this._generateFunctionTemplateFile(schema, entry);\n                });\n            }\n\n            let locals = {\n                imports: importLines.join(\"\\n\"),\n                className: capitalized,\n                entityMeta: indentLines(JSON.stringify(modelMeta, null, 4), 4),\n                classBody: indentLines(astClassMain.map((block) => JsLang.astToCode(block)).join(\"\\n\\n\"), 8),\n                functors: indentLines(\n                    JsLang.astToCode(\n                        JsLang.astValue(\n                            _.reduce(\n                                sharedContext.newFunctorFiles,\n                                (result, functor) => {\n                                    result[\"$\" + functor.functionName] = JsLang.astId(functor.functionName);\n                                    return result;\n                                },\n                                {}\n                            )\n                        )\n                    ),\n                    4\n                ),\n                //mixins\n            };\n\n            let classTemplate = path.resolve(__dirname, \"database\", this.connector.driver, \"EntityModel.js.swig\");\n            let classCode = swig.renderFile(classTemplate, locals);\n\n            let modelFilePath = path.resolve(this.outputPath, schema.name, \"base\", capitalized + \".js\");\n            fs.ensureFileSync(modelFilePath);\n            fs.writeFileSync(modelFilePath, classCode);\n\n            this.linker.log(\"info\", \"Generated entity model: \" + modelFilePath);\n        });\n    }\n\n    _generateEntityInputSchema(schema) {\n        //generate validator config\n        _.forOwn(schema.entities, (entity, entityInstanceName) => {\n            _.each(entity.inputs, (inputs, inputSetName) => {\n                const validationSchema = {};\n                const dependencies = new Set();\n                const ast = JsLang.astProgram();\n\n                inputs.forEach((input) => {\n                    //:address\n                    if (input.name.startsWith(\":\")) {\n                        const assoc = input.name.substr(1);\n                        const assocMeta = entity.associations[assoc];\n\n                        if (!assocMeta) {\n                            throw new Error(`Association \"${assoc}\" not found in entity [${entityInstanceName}].`);\n                        }\n\n                        if (!input.spec) {\n                            throw new Error(\n                                `Input \"spec\" is required for entity reference. Input set: ${inputSetName}, entity: ${entityInstanceName}, local: ${assoc}, referencedEntity: ${assocMeta.entity}`\n                            );\n                        }\n\n                        const dep = `${assocMeta.entity}-${input.spec}`;\n                        dependencies.add(dep);\n\n                        if (assocMeta.list) {\n                            validationSchema[input.name] = JsLang.astValue({\n                                type: \"array\",\n                                elementSchema: {\n                                    type: \"object\",\n                                    schema: JsLang.astCall(_.camelCase(dep), []),\n                                },\n                                ..._.pick(input, [\"optional\"]),\n                            });\n                        } else {\n                            validationSchema[input.name] = JsLang.astValue({\n                                type: \"object\",\n                                schema: JsLang.astCall(_.camelCase(dep), []),\n                                ..._.pick(input, [\"optional\"]),\n                            });\n                        }\n                    } else {\n                        const field = entity.fields[input.name];\n\n                        if (!field) {\n                            throw new Error(`Field \"${input.name}\" not found in entity [${entityInstanceName}].`);\n                        }\n\n                        validationSchema[input.name] = JsLang.astValue({\n                            ..._.pick(field, [\"type\", \"values\"]),\n                            ..._.pick(input, [\"optional\"]),\n                        });\n                    }\n                });\n\n                //console.dir(JsLang.astValue(validationSchema), {depth: 20});\n\n                const exportBody = Array.from(dependencies).map((dep) =>\n                    JsLang.astRequire(_.camelCase(dep), `./${dep}`)\n                );\n\n                JsLang.astPushInBody(\n                    ast,\n                    JsLang.astAssign(\n                        JsLang.astVarRef(\"module.exports\"),\n                        JsLang.astAnonymousFunction([], exportBody.concat(JsLang.astReturn(validationSchema)))\n                    )\n                );\n\n                let inputSchemaFilePath = path.resolve(\n                    this.outputPath,\n                    schema.name,\n                    \"inputs\",\n                    entityInstanceName + \"-\" + inputSetName + \".js\"\n                );\n                fs.ensureFileSync(inputSchemaFilePath);\n                fs.writeFileSync(inputSchemaFilePath, JsLang.astToCode(ast));\n\n                this.linker.log(\"info\", \"Generated entity input schema: \" + inputSchemaFilePath);\n            });\n        });\n    }\n\n    _generateEntityManifest(schema) {        \n        /*\n        let manifest = {};\n\n        _.each(schema.entities, (entity, entityName) => {\n            if (entity.info.restful) {\n                _.each(entity.info.restful, ({ type, methods }, relativeUri) => {                    \n                    let apiInfo = {\n                        type,\n                        methods: {}                                            \n                    };\n\n                    if (type === 'entity') {\n                        apiInfo.entity = entityName;\n                        apiInfo.displayName = entity.displayName;\n\n                        if (entity.comment) {\n                            apiInfo.description = entity.comment;\n                        }\n                    }\n\n                    _.each(methods, (meta, methodName) => {\n\n                        switch (methodName) {\n                            case 'create':\n                                apiInfo.methods['post:' + relativeUri] = meta;\n                            break;\n\n                            case 'findOne':\n                            break;\n\n                            case 'fineAll':\n                            break;\n\n                            case 'updateOne':\n                            break;\n\n                            case 'updateMany':\n                            break;\n\n                            case 'deleteOne':\n                            break;\n\n                            case 'deleteMany':\n                            break;\n                        }\n\n                    });\n                });\n            }\n        });\n        */\n        \n        /*\n        let outputFilePath = path.resolve(this.manifestPath, schema.name + '.manifest.json');\n        fs.ensureFileSync(outputFilePath);\n        fs.writeFileSync(outputFilePath, JSON.stringify(entities, null, 4));\n\n        this.linker.log('info', 'Generated schema manifest: ' + outputFilePath);\n        */\n\n        const diagram = {};\n\n        //generate validator config\n        _.forOwn(schema.entities, (entity, entityInstanceName) => {\n            let validationSchema = {};\n\n            _.forOwn(entity.fields, (field, fieldName) => {\n                if (field.readOnly) return;\n\n                let fieldSchema = {\n                    type: field.type,\n                };\n\n                if (field.type === \"enum\") {\n                    fieldSchema.values = field.values;\n                }\n\n                if (field.optional) {\n                    fieldSchema.optional = true;\n                }\n\n                validationSchema[fieldName] = fieldSchema;\n            });\n\n            diagram[entityInstanceName] = entity.toJSON();\n\n            let entityOutputFilePath = path.resolve(\n                this.manifestPath,\n                schema.name,\n                \"validation\",\n                entityInstanceName + \".manifest.json\"\n            );\n            fs.ensureFileSync(entityOutputFilePath);\n            fs.writeFileSync(entityOutputFilePath, JSON.stringify(validationSchema, null, 4));\n\n            this.linker.log(\"info\", \"Generated entity manifest: \" + entityOutputFilePath);\n        });\n\n        let diagramOutputFilePath = path.resolve(\n            this.manifestPath,\n            schema.name,\n            \"diagram.json\"\n        );\n        fs.ensureFileSync(diagramOutputFilePath);\n        fs.writeFileSync(diagramOutputFilePath, JSON.stringify(diagram, null, 4));\n    \n        this.linker.log(\"info\", \"Generated schema manifest: \" + diagramOutputFilePath);\n    }    \n\n    /*\n    _generateViewModel(schema, dbService) {        \n        _.forOwn(schema.views, (viewInfo, viewName) => {\n            this.linker.info('Building view: ' + viewName);\n\n            let capitalized = _.upperFirst(viewName);\n\n            let ast = JsLang.astProgram();\n\n            JsLang.astPushInBody(ast, JsLang.astRequire('Mowa', 'mowa'));\n            JsLang.astPushInBody(ast, JsLang.astVarDeclare('Util', JsLang.astVarRef('Mowa.Util'), true));\n            JsLang.astPushInBody(ast, JsLang.astVarDeclare('_', JsLang.astVarRef('Util._'), true));\n            JsLang.astPushInBody(ast, JsLang.astRequire('View', 'mowa/lib/oolong/runtime/view'));\n\n            let compileContext = OolToAst.createCompileContext(viewName, dbService.serviceId, this.linker);\n\n            compileContext.modelVars.add(viewInfo.entity);\n\n            let paramMeta;\n\n            if (viewInfo.params) {\n                paramMeta = this._processParams(viewInfo.params, compileContext);\n            }\n\n            let viewMeta = {\n                isList: viewInfo.isList,\n                params: paramMeta\n            };\n\n            let viewBodyTopoId = OolToAst.createTopoId(compileContext, '$view');\n            OolToAst.dependsOn(compileContext, compileContext.mainStartId, viewBodyTopoId);\n\n            let viewModeler = require(path.resolve(__dirname, './dao/view', dbService.dbType + '.js'));\n            compileContext.astMap[viewBodyTopoId] = viewModeler(dbService, viewName, viewInfo);\n            OolToAst.addCodeBlock(compileContext, viewBodyTopoId, {\n                type: OolToAst.AST_BLK_VIEW_OPERATION\n            });\n\n            let returnTopoId = OolToAst.createTopoId(compileContext, '$return:value');\n            OolToAst.dependsOn(compileContext, viewBodyTopoId, returnTopoId);\n            OolToAst.compileReturn(returnTopoId, {\n                \"oolType\": \"ObjectReference\",\n                \"name\": \"viewData\"\n            }, compileContext);\n\n            let deps = compileContext.topoSort.sort();\n            this.linker.verbose('All dependencies:\\n' + JSON.stringify(deps, null, 2));\n\n            deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));\n            this.linker.verbose('All necessary source code:\\n' + JSON.stringify(deps, null, 2));\n\n            let astDoLoadMain = [\n                JsLang.astVarDeclare('$meta', JsLang.astVarRef('this.meta'), true, false, 'Retrieving the meta data')\n            ];\n\n            _.each(deps, dep => {\n                let astMeta = compileContext.mapOfTokenToMeta.get(dep);\n\n                let astBlock = compileContext.astMap[dep];\n                assert: astBlock, 'Empty ast block';\n\n                if (astMeta.type === 'ModifierCall') {\n                    let fieldName = getFieldName(astMeta.target);\n                    let astCache = JsLang.astAssign(JsLang.astVarRef(astMeta.target), astBlock, `Modifying ${fieldName}`);\n                    astDoLoadMain.push(astCache);\n                    return;\n                }\n\n                astDoLoadMain = astDoLoadMain.concat(_.castArray(compileContext.astMap[dep]));\n            });\n\n            if (!_.isEmpty(compileContext.mapOfFunctorToFile)) {\n                _.forOwn(compileContext.mapOfFunctorToFile, (fileName, functionName) => {\n                    JsLang.astPushInBody(ast, JsLang.astRequire(functionName, '.' + fileName));\n                });\n            }\n\n            if (!_.isEmpty(compileContext.newFunctorFiles)) {\n                _.each(compileContext.newFunctorFiles, entry => {\n                    this._generateFunctionTemplateFile(dbService, entry);\n                });\n            }\n\n            JsLang.astPushInBody(ast, JsLang.astClassDeclare(capitalized, 'View', [\n                JsLang.astMemberMethod('_doLoad', Object.keys(paramMeta),\n                    astDoLoadMain,\n                    false, true, false, 'Populate view data'\n                )\n            ], `${capitalized} view`));\n            JsLang.astPushInBody(ast, JsLang.astAssign(capitalized + '.meta', JsLang.astValue(viewMeta)));\n            JsLang.astPushInBody(ast, JsLang.astAssign('module.exports', JsLang.astVarRef(capitalized)));\n\n            let modelFilePath = path.resolve(this.outputPath, dbService.dbType, dbService.name, 'views', viewName + '.js');\n            fs.ensureFileSync(modelFilePath);\n            fs.writeFileSync(modelFilePath + '.json', JSON.stringify(ast, null, 2));\n\n            DaoModeler._exportSourceCode(ast, modelFilePath);\n\n            this.linker.log('info', 'Generated view model: ' + modelFilePath);\n        });\n    };\n    */\n\n    _processFieldModifiers(entity, sharedContext) {\n        let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);\n        compileContext.variables[\"raw\"] = { source: \"context\", finalized: true };\n        compileContext.variables[\"i18n\"] = { source: \"context\", finalized: true };\n        compileContext.variables[\"connector\"] = { source: \"context\", finalized: true };\n        compileContext.variables[\"latest\"] = { source: \"context\" };\n\n        const allFinished = GemlToAst.createTopoId(compileContext, \"done.\");\n\n        //map of field name to dependencies\n        let fieldReferences = {};\n\n        _.forOwn(entity.fields, (field, fieldName) => {\n            let topoId = GemlToAst.compileField(fieldName, field, compileContext);\n            GemlToAst.dependsOn(compileContext, topoId, allFinished);\n\n            if (field.writeOnce || field.freezeAfterNonDefault) {\n                putIntoBucket(fieldReferences, fieldName, { reference: fieldName, writeProtect: true });\n            }\n        });\n\n        let deps = compileContext.topoSort.sort();\n        //this.linker.verbose('All dependencies:\\n' + JSON.stringify(deps, null, 2));\n\n        deps = deps.filter((dep) => compileContext.mapOfTokenToMeta.has(dep));\n        //this.linker.verbose('All necessary source code:\\n' + JSON.stringify(deps, null, 2));\n\n        let methodBodyValidateAndFill = [],\n            lastFieldsGroup,\n            methodBodyCache = [],\n            lastBlock,\n            lastAstType; //, hasValidator = false;\n\n        const _mergeDoValidateAndFillCode = function (fieldName, references, astCache, requireTargetField) {\n            let fields = [fieldName].concat(references);\n            let checker = fields.join(\",\");\n\n            if (lastFieldsGroup && lastFieldsGroup.checker !== checker) {\n                methodBodyValidateAndFill = methodBodyValidateAndFill.concat(\n                    Snippets._fieldRequirementCheck(\n                        lastFieldsGroup.fieldName,\n                        lastFieldsGroup.references,\n                        methodBodyCache,\n                        lastFieldsGroup.requireTargetField\n                    )\n                );\n                methodBodyCache = [];\n            }\n\n            methodBodyCache = methodBodyCache.concat(astCache);\n            lastFieldsGroup = {\n                fieldName,\n                references,\n                requireTargetField,\n                checker,\n            };\n        };\n\n        //console.dir(compileContext.astMap['mobile~isMobilePhone:arg[1]|>stringDasherize'], { depth: 8 });\n\n        _.each(deps, (dep, i) => {\n            //get metadata of source code block\n            let sourceMap = compileContext.mapOfTokenToMeta.get(dep);\n\n            //get source code block\n            let astBlock = compileContext.astMap[dep];\n\n            let targetFieldName = getFieldName(sourceMap.target);\n\n            if (sourceMap.references && sourceMap.references.length > 0) {\n                let fieldReference = fieldReferences[targetFieldName];\n                if (!fieldReference) {\n                    fieldReferences[targetFieldName] = fieldReference = [];\n                }\n\n                if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {\n                    sourceMap.references.forEach((ref) => {\n                        fieldReference.push({ reference: ref, whenNull: true });\n                    });\n                } else {\n                    sourceMap.references.forEach((ref) => {\n                        if (fieldReference.indexOf(ref) === -1) fieldReference.push(ref);\n                    });\n                }\n            }\n\n            if (lastBlock) {\n                astBlock = chainCall(lastBlock, lastAstType, astBlock, sourceMap.type);\n                lastBlock = undefined;\n            }\n\n            if (i < deps.length - 1) {\n                let nextType = compileContext.mapOfTokenToMeta.get(deps[i + 1]);\n\n                if (isChainable(sourceMap, nextType)) {\n                    lastBlock = astBlock;\n                    lastAstType = sourceMap.type;\n                    return;\n                }\n            }\n\n            if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {\n                //hasValidator = true;\n                let astCache = Snippets._validateCheck(targetFieldName, astBlock);\n\n                _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);\n            } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {\n                let astCache = JsLang.astAssign(\n                    JsLang.astVarRef(sourceMap.target, true),\n                    astBlock,\n                    `Processing \"${targetFieldName}\"`\n                );\n\n                _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);\n            } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {\n                let astCache = Snippets._checkAndAssign(\n                    astBlock,\n                    JsLang.astVarRef(sourceMap.target, true),\n                    `Activating \"${targetFieldName}\"`\n                );\n\n                _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, false);\n            } else {\n                throw new Error(\"To be implemented.\");\n                //astBlock = _.castArray(astBlock);\n                //_mergeDoValidateAndFillCode(targetFieldName, [], astBlock);\n            }\n        });\n\n        /* Changed to throw error instead of returning a error object\n        if (hasValidator) {\n            let declare = JsLang.astVarDeclare(validStateName, false);\n            methodBodyCreate.unshift(declare);\n            methodBodyUpdate.unshift(declare);\n        }\n        */\n\n        if (!_.isEmpty(methodBodyCache)) {\n            methodBodyValidateAndFill = methodBodyValidateAndFill.concat(\n                Snippets._fieldRequirementCheck(\n                    lastFieldsGroup.fieldName,\n                    lastFieldsGroup.references,\n                    methodBodyCache,\n                    lastFieldsGroup.requireTargetField\n                )\n            );\n        }\n\n        /*\n        let ast = JsLang.astProgram(false);\n        JsLang.astPushInBody(ast, JsLang.astClassDeclare('Abc', 'Model', [\n            JsLang.astMemberMethod(asyncMethodNaming('prepareEntityData_'), [ 'context' ],\n            Snippets._doValidateAndFillHeader.concat(methodBodyValidateAndFill).concat([ JsLang.astReturn(JsLang.astId('context')) ]),\n            false, true, true\n        )], 'comment'));\n        */\n\n        return {\n            ast: JsLang.astMemberMethod(\n                asyncMethodNaming(\"applyModifiers\"),\n                [\"context\", \"isUpdating\"],\n                Snippets._applyModifiersHeader\n                    .concat(methodBodyValidateAndFill)\n                    .concat([JsLang.astReturn(JsLang.astId(\"context\"))]),\n                false,\n                true,\n                true,\n                \"Applying predefined modifiers to entity fields.\"\n            ),\n            fieldReferences,\n        };\n    }\n\n    _generateFunctionTemplateFile(schema, { functionName, functorType, fileName, args }) {\n        let filePath = path.resolve(this.outputPath, schema.name, fileName);\n\n        if (fs.existsSync(filePath)) {\n            //todo: analyse code, compare arguments\n            this.linker.log(\"info\", `${_.upperFirst(functorType)} \"${fileName}\" exists. File generating skipped.`);\n\n            return;\n        }\n\n        let ast = JsLang.astProgram();\n\n        JsLang.astPushInBody(ast, JsLang.astFunction(functionName, args, OOL_MODIFIER_RETURN[functorType](args)));\n        JsLang.astPushInBody(ast, JsLang.astAssign(\"module.exports\", JsLang.astVarRef(functionName)));\n\n        fs.ensureFileSync(filePath);\n        fs.writeFileSync(filePath, JsLang.astToCode(ast));\n        this.linker.log(\"info\", `Generated ${functorType} file: ${filePath}`);\n    }\n\n    _buildInterfaces(entity, modelMetaInit, sharedContext) {\n        let ast = [];\n\n        _.forOwn(entity.interfaces, (method, name) => {\n            this.linker.info(\"Building interface: \" + name);\n\n            let astBody = [\n                JsLang.astVarDeclare(\n                    \"$meta\",\n                    JsLang.astVarRef(\"this.meta.interfaces.\" + name),\n                    true,\n                    false,\n                    \"Retrieving the meta data\"\n                ),\n            ];\n\n            let compileContext = GemlToAst.createCompileContext(entity.gemlModule.name, this.linker, sharedContext);\n\n            let paramMeta;\n\n            if (method.accept) {\n                paramMeta = this._processParams(method.accept, compileContext);\n            }\n\n            //metadata\n            modelMetaInit[\"interfaces\"] || (modelMetaInit[\"interfaces\"] = {});\n            modelMetaInit[\"interfaces\"][name] = { params: Object.values(paramMeta) };\n\n            _.each(method.implementation, (operation, index) => {\n                //let lastTopoId =\n                GemlToAst.compileDbOperation(index, operation, compileContext, compileContext.mainStartId);\n            });\n\n            if (method.return) {\n                GemlToAst.compileExceptionalReturn(method.return, compileContext);\n            }\n\n            let deps = compileContext.topoSort.sort();\n            //this.linker.verbose('All dependencies:\\n' + JSON.stringify(deps, null, 2));\n\n            deps = deps.filter((dep) => compileContext.mapOfTokenToMeta.has(dep));\n            //this.linker.verbose('All necessary source code:\\n' + JSON.stringify(deps, null, 2));\n\n            _.each(deps, (dep) => {\n                let sourceMap = compileContext.mapOfTokenToMeta.get(dep);\n                let astBlock = compileContext.astMap[dep];\n\n                //this.linker.verbose('Code point \"' + dep + '\":\\n' + JSON.stringify(sourceMap, null, 2));\n\n                let targetFieldName = sourceMap.target; //getFieldName(sourceMap.target);\n\n                if (sourceMap.type === GemlToAst.AST_BLK_VALIDATOR_CALL) {\n                    astBlock = Snippets._validateCheck(targetFieldName, astBlock);\n                } else if (sourceMap.type === GemlToAst.AST_BLK_PROCESSOR_CALL) {\n                    if (sourceMap.needDeclare) {\n                        astBlock = JsLang.astVarDeclare(\n                            JsLang.astVarRef(sourceMap.target),\n                            astBlock,\n                            false,\n                            false,\n                            `Processing \"${targetFieldName}\"`\n                        );\n                    } else {\n                        astBlock = JsLang.astAssign(\n                            JsLang.astVarRef(sourceMap.target, true),\n                            astBlock,\n                            `Processing \"${targetFieldName}\"`\n                        );\n                    }\n                } else if (sourceMap.type === GemlToAst.AST_BLK_ACTIVATOR_CALL) {\n                    if (sourceMap.needDeclare) {\n                        astBlock = JsLang.astVarDeclare(\n                            JsLang.astVarRef(sourceMap.target),\n                            astBlock,\n                            false,\n                            false,\n                            `Processing \"${targetFieldName}\"`\n                        );\n                    } else {\n                        astBlock = JsLang.astAssign(\n                            JsLang.astVarRef(sourceMap.target, true),\n                            astBlock,\n                            `Activating \"${targetFieldName}\"`\n                        );\n                    }\n                }\n\n                astBody = astBody.concat(_.castArray(astBlock));\n            });\n\n            ast.push(\n                JsLang.astMemberMethod(\n                    asyncMethodNaming(name),\n                    Object.keys(paramMeta),\n                    astBody,\n                    false,\n                    true,\n                    true,\n                    text.replaceAll(_.kebabCase(name), \"-\", \" \")\n                )\n            );\n        });\n\n        return ast;\n    }\n\n    _processParams(acceptParams, compileContext) {\n        let paramMeta = {};\n\n        acceptParams.forEach((param, i) => {\n            GemlToAst.compileParam(i, param, compileContext);\n            paramMeta[param.name] = param;\n            compileContext.variables[param.name] = { source: \"argument\" };\n        });\n\n        return paramMeta;\n    }\n}\n\nmodule.exports = DaoModeler;\n"],"file":"Dao.js"}
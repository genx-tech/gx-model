{"version":3,"sources":["../../src/migration/mongodb.js"],"names":["path","require","_","eachAsync_","fs","MongoDbMigration","constructor","context","schemaName","connector","appModule","logger","modelPath","scriptSourcePath","dbScriptPath","join","driver","database","reset_","execute_","db","dropDatabase","create_","extraOptions","load_","dataFile","ext","extname","log","collection","basename","docs","readJsonSync","encoding","_loadData_","executor","Error","doc","insertOne_","module","exports"],"mappings":"AAAA;;;;AAEA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;AAAEC,EAAAA,CAAF;AAAKC,EAAAA;AAAL,IAAoBF,OAAO,CAAC,YAAD,CAAjC;;AACA,MAAM;AAAEG,EAAAA;AAAF,IAASH,OAAO,CAAC,WAAD,CAAtB;;AAMA,MAAMI,gBAAN,CAAuB;AAKnBC,EAAAA,WAAW,CAACC,OAAD,EAAUC,UAAV,EAAsBC,SAAtB,EAAiC;AACxC,SAAKC,SAAL,GAAiBH,OAAO,CAACG,SAAzB;AACA,SAAKC,MAAL,GAAcJ,OAAO,CAACI,MAAtB;AACA,SAAKC,SAAL,GAAiBL,OAAO,CAACK,SAAzB;AACA,SAAKC,gBAAL,GAAwBN,OAAO,CAACM,gBAAhC;AACA,SAAKL,UAAL,GAAkBA,UAAlB;AACA,SAAKC,SAAL,GAAiBA,SAAjB;AAEA,SAAKK,YAAL,GAAoBd,IAAI,CAACe,IAAL,CAAU,KAAKF,gBAAf,EAAiC,KAAKJ,SAAL,CAAeO,MAAhD,EAAwD,KAAKP,SAAL,CAAeQ,QAAvE,CAApB;AACH;;AAEW,QAANC,MAAM,GAAG;AACX,WAAO,KAAKT,SAAL,CAAeU,QAAf,CAAwBC,EAAE,IAAIA,EAAE,CAACC,YAAH,EAA9B,CAAP;AACH;;AAEY,QAAPC,OAAO,CAACC,YAAD,EAAe,CAE3B;;AAEU,QAALC,KAAK,CAACC,QAAD,EAAW;AAClB,QAAIC,GAAG,GAAG1B,IAAI,CAAC2B,OAAL,CAAaF,QAAb,CAAV;AACA,SAAKd,MAAL,CAAYiB,GAAZ,CAAgB,SAAhB,EAA4B,sBAAqBH,QAAS,OAA1D;AAEA,QAAII,UAAU,GAAG7B,IAAI,CAAC8B,QAAL,CAAcL,QAAd,EAAwBC,GAAxB,CAAjB;;AAEA,QAAIA,GAAG,KAAK,OAAZ,EAAqB;AACjB,UAAIK,IAAI,GAAG3B,EAAE,CAAC4B,YAAH,CAAgBP,QAAhB,EAA0B;AAACQ,QAAAA,QAAQ,EAAE;AAAX,OAA1B,CAAX;AAEA,YAAM,KAAKC,UAAL,CAAgBL,UAAhB,EAA4BE,IAA5B,CAAN;AACH,KAJD,MAIO,IAAIL,GAAG,KAAK,KAAZ,EAAmB;AACtB,UAAIS,QAAQ,GAAGlC,OAAO,CAACwB,QAAD,CAAtB;;AACA,YAAMU,QAAQ,CAAC,KAAKzB,SAAN,EAAiB,KAAKD,SAAtB,CAAd;AACH,KAHM,MAGA;AACH,YAAM,IAAI2B,KAAJ,CAAU,+BAAV,CAAN;AACH;AACJ;;AAEe,QAAVF,UAAU,CAACL,UAAD,EAAaE,IAAb,EAAmB;AAC/B,UAAM5B,UAAU,CAAC4B,IAAD,EAAOM,GAAG,IAAI,KAAK5B,SAAL,CAAe6B,UAAf,CAA0BT,UAA1B,EAAsCQ,GAAtC,CAAd,CAAhB;AACH;;AA5CkB;;AA+CvBE,MAAM,CAACC,OAAP,GAAiBnC,gBAAjB","sourcesContent":["\"use strict\";\n\nconst path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\n\n/**\n * MySQL migration.\n * @class\n */\nclass MongoDbMigration {\n    /**     \n     * @param {object} context\n     * @param {Connector} connector\n     */\n    constructor(context, schemaName, connector) {\n        this.appModule = context.appModule;\n        this.logger = context.logger;\n        this.modelPath = context.modelPath;\n        this.scriptSourcePath = context.scriptSourcePath;\n        this.schemaName = schemaName;\n        this.connector = connector;\n\n        this.dbScriptPath = path.join(this.scriptSourcePath, this.connector.driver, this.connector.database);\n    }\n\n    async reset_() {\n        return this.connector.execute_(db => db.dropDatabase());\n    }\n\n    async create_(extraOptions) {        \n        \n    }\n\n    async load_(dataFile) {\n        let ext = path.extname(dataFile);\n        this.logger.log('verbose', `Loading data file \"${dataFile}\" ...`);\n        \n        let collection = path.basename(dataFile, ext);\n\n        if (ext === '.json') {\n            let docs = fs.readJsonSync(dataFile, {encoding: 'utf8'});\n\n            await this._loadData_(collection, docs);\n        } else if (ext === '.js') {           \n            let executor = require(dataFile);\n            await executor(this.appModule, this.connector);\n        } else {\n            throw new Error('Unsupported data file format.');\n        }\n    }\n\n    async _loadData_(collection, docs) { \n        await eachAsync_(docs, doc => this.connector.insertOne_(collection, doc));\n    }\n}\n\nmodule.exports = MongoDbMigration;"],"file":"mongodb.js"}
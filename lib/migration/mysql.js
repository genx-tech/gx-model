"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  eachAsync_,
  quote
} = require('rk-utils');

class MySQLMigration {
  constructor(app, context, db) {
    this.app = app;
    this.modelPath = context.modelPath;
    this.scriptPath = context.scriptPath;
    this.db = db;
    this.dbScriptPath = path.join(this.scriptPath, this.db.driver, this.db.connector.database);
  }

  async reset_() {
    return this.db.connector.execute_(`DROP DATABASE IF EXISTS ??`, [this.db.connector.database], {
      createDatabase: true
    });
  }

  async create_(extraOptions) {
    let sqlFiles = ['entities.sql', 'relations.sql', 'procedures.sql'];
    let sqlCreate = 'CREATE DATABASE IF NOT EXISTS ??';

    if (extraOptions && !_.isEmpty(extraOptions.db)) {
      sqlCreate += ' ' + _.reduce(extraOptions.db, (r, v, k) => {
        return r + ' ' + _.upperCase(k) + ' ' + quote(v.toString(), '"');
      }, '');
    }

    let result = await this.db.connector.execute_(sqlCreate, [this.db.connector.database], {
      createDatabase: true
    });

    if (result.warningStatus == 0) {
      this.app.log('info', `Created database "${this.db.connector.database}".`);
    } else {
      this.app.log('warn', `Database "${this.db.connector.database}" exists.`);
    }

    return eachAsync_(sqlFiles, async file => {
      let sqlFile = path.join(this.dbScriptPath, file);

      if (!fs.existsSync(sqlFile)) {
        throw new Error(`Database script "${sqlFile}" not found. Try run "oolong build" first.`);
      }

      let sql = _.trim(fs.readFileSync(sqlFile, {
        encoding: 'utf8'
      }));

      if (sql) {
        result = _.castArray((await this.db.connector.execute_(sql, null, {
          multipleStatements: 1
        })));

        let warningRows = _.reduce(result, (sum, row) => {
          sum += row.warningStatus;
          return sum;
        }, 0);

        if (warningRows > 0) {
          this.app.log('warn', `${warningRows} warning(s) reported while running "${file}".`);
        } else {
          this.app.log('info', `Database scripts "${sqlFile}" run successfully.`);
        }
      }
    });
  }

  async load_(dataFile, ignoreDuplicate) {
    let ext = path.extname(dataFile);
    this.app.log('verbose', `Loading data file "${dataFile}" ...`);

    if (ext === '.json') {
      let data = fs.readJsonSync(dataFile, {
        encoding: 'utf8'
      });

      if (Array.isArray(data)) {
        let entityName = path.basename(dataFile, ext);
        await this._loadSingleEntityRecords_(entityName, data, ignoreDuplicate);
      } else {
        await this._loadMultiEntityRecords_(data, ignoreDuplicate);
      }

      this.app.log('info', `Loaded JSON data file: ${dataFile}`);
    } else if (ext === '.sql') {
      let sql = fs.readFileSync(dataFile, {
        encoding: 'utf8'
      });
      let result = await this.db.connector.execute_(sql, null, {
        multipleStatements: 1
      });
      this.app.log('info', `Executed SQL file: ${dataFile}`, result);
    } else if (ext === '.xlsx') {
      const Excel = require('exceljs');

      let workbook = new Excel.Workbook();
      await workbook.xlsx.readFile(dataFile);
      let data = {};
      workbook.eachSheet((worksheet, sheetId) => {
        let colKeys;
        let entityName = worksheet.name;
        let entityData = [];
        data[entityName] = entityData;
        worksheet.eachRow(function (row, rowNumber) {
          if (!colKeys) {
            colKeys = _.drop(row.values);
          } else {
            let record = _.fromPairs(_.zip(colKeys, _.drop(row.values)));

            entityData.push(record);
          }
        });
      });
      await this._loadMultiEntityRecords_(data);
      this.app.log('info', `Imported excel data file: ${dataFile}`);
    } else if (ext === '.js') {
      let executor = require(dataFile);

      await executor(this.app, this.db.connector);
      this.app.log('info', `Ran data script: ${dataFile}`);
    } else {
      throw new Error('Unsupported data file format.');
    }
  }

  writeIndexFile(outputDir, items) {
    const indexFile = path.join(outputDir, 'index.list');
    fs.writeFileSync(indexFile, items.join('\n'), 'utf8');
    this.app.log('info', 'Generated data files list: ' + indexFile);
  }

  async export_(entitiesToExport, outputDir, skipIndexFile) {
    fs.ensureDirSync(outputDir);
    const items = [];
    await eachAsync_(entitiesToExport, async (exportConfig, dataFileName) => {
      const entityName = exportConfig.entityName || dataFileName;
      this.app.log('verbose', 'Exporting data of entity: ' + entityName);
      const Entity = this.db.model(entityName);
      const data = await Entity.findAll_(exportConfig.dataset);

      _.forOwn(exportConfig.rules, (enabled, name) => {
        if (enabled) {
          const processRule = require(`./rules/${name}.js`);

          data.forEach(entity => processRule(this.db, Entity, entity));
        }
      });

      const baseFileName = `${dataFileName}.json`;
      items.push(baseFileName);
      const dataFile = path.join(outputDir, baseFileName);
      fs.writeJsonSync(dataFile, {
        [Entity.meta.name]: data
      }, {
        spaces: 4
      });
      this.app.log('info', 'Generated entity data file: ' + dataFile);
    });

    if (!skipIndexFile) {
      this.writeIndexFile(outputDir, items);
    }

    return items;
  }

  async _loadMultiEntityRecords_(data, ignoreDuplicate) {
    try {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, async (records, entityName) => {
        let items = Array.isArray(records) ? records : [records];
        return this._loadRecordsByModel_(entityName, items, ignoreDuplicate);
      });
    } catch (error) {
      throw error;
    } finally {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    }
  }

  async _loadSingleEntityRecords_(entityName, data, ignoreDuplicate) {
    try {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await this._loadRecordsByModel_(entityName, data, ignoreDuplicate);
    } catch (error) {
      throw error;
    } finally {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    }
  }

  async _loadRecordsByModel_(entityName, items, ignoreDuplicate) {
    const connOptions = {};

    if (ignoreDuplicate) {
      connOptions.insertIgnore = true;
    }

    const Entity = this.db.model(entityName);
    return eachAsync_(items, async ({
      $skipModifiers,
      $update,
      ...item
    }) => {
      const opts = {
        $migration: true,
        $skipModifiers,
        $retrieveDbResult: true
      };

      if ($update) {
        await Entity.updateOne_(item, undefined, connOptions);
      } else {
        const processed = await Entity.create_(item, opts, connOptions);

        if (opts.$result.affectedRows === 0) {
          const key = Entity.getUniqueKeyValuePairsFrom(processed);
          this.app.log('info', `Duplicate record ${JSON.stringify(key)} is ignored.`);
        }
      }
    });
  }

}

module.exports = MySQLMigration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWdyYXRpb24vbXlzcWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwicXVvdGUiLCJNeVNRTE1pZ3JhdGlvbiIsImNvbnN0cnVjdG9yIiwiYXBwIiwiY29udGV4dCIsImRiIiwibW9kZWxQYXRoIiwic2NyaXB0UGF0aCIsImRiU2NyaXB0UGF0aCIsImpvaW4iLCJkcml2ZXIiLCJjb25uZWN0b3IiLCJkYXRhYmFzZSIsInJlc2V0XyIsImV4ZWN1dGVfIiwiY3JlYXRlRGF0YWJhc2UiLCJjcmVhdGVfIiwiZXh0cmFPcHRpb25zIiwic3FsRmlsZXMiLCJzcWxDcmVhdGUiLCJpc0VtcHR5IiwicmVkdWNlIiwiciIsInYiLCJrIiwidXBwZXJDYXNlIiwidG9TdHJpbmciLCJyZXN1bHQiLCJ3YXJuaW5nU3RhdHVzIiwibG9nIiwiZmlsZSIsInNxbEZpbGUiLCJleGlzdHNTeW5jIiwiRXJyb3IiLCJzcWwiLCJ0cmltIiwicmVhZEZpbGVTeW5jIiwiZW5jb2RpbmciLCJjYXN0QXJyYXkiLCJtdWx0aXBsZVN0YXRlbWVudHMiLCJ3YXJuaW5nUm93cyIsInN1bSIsInJvdyIsImxvYWRfIiwiZGF0YUZpbGUiLCJpZ25vcmVEdXBsaWNhdGUiLCJleHQiLCJleHRuYW1lIiwiZGF0YSIsInJlYWRKc29uU3luYyIsIkFycmF5IiwiaXNBcnJheSIsImVudGl0eU5hbWUiLCJiYXNlbmFtZSIsIl9sb2FkU2luZ2xlRW50aXR5UmVjb3Jkc18iLCJfbG9hZE11bHRpRW50aXR5UmVjb3Jkc18iLCJFeGNlbCIsIndvcmtib29rIiwiV29ya2Jvb2siLCJ4bHN4IiwicmVhZEZpbGUiLCJlYWNoU2hlZXQiLCJ3b3Jrc2hlZXQiLCJzaGVldElkIiwiY29sS2V5cyIsIm5hbWUiLCJlbnRpdHlEYXRhIiwiZWFjaFJvdyIsInJvd051bWJlciIsImRyb3AiLCJ2YWx1ZXMiLCJyZWNvcmQiLCJmcm9tUGFpcnMiLCJ6aXAiLCJwdXNoIiwiZXhlY3V0b3IiLCJ3cml0ZUluZGV4RmlsZSIsIm91dHB1dERpciIsIml0ZW1zIiwiaW5kZXhGaWxlIiwid3JpdGVGaWxlU3luYyIsImV4cG9ydF8iLCJlbnRpdGllc1RvRXhwb3J0Iiwic2tpcEluZGV4RmlsZSIsImVuc3VyZURpclN5bmMiLCJleHBvcnRDb25maWciLCJkYXRhRmlsZU5hbWUiLCJFbnRpdHkiLCJtb2RlbCIsImZpbmRBbGxfIiwiZGF0YXNldCIsImZvck93biIsInJ1bGVzIiwiZW5hYmxlZCIsInByb2Nlc3NSdWxlIiwiZm9yRWFjaCIsImVudGl0eSIsImJhc2VGaWxlTmFtZSIsIndyaXRlSnNvblN5bmMiLCJtZXRhIiwic3BhY2VzIiwicmVjb3JkcyIsIl9sb2FkUmVjb3Jkc0J5TW9kZWxfIiwiZXJyb3IiLCJjb25uT3B0aW9ucyIsImluc2VydElnbm9yZSIsIiRza2lwTW9kaWZpZXJzIiwiJHVwZGF0ZSIsIml0ZW0iLCJvcHRzIiwiJG1pZ3JhdGlvbiIsIiRyZXRyaWV2ZURiUmVzdWx0IiwidXBkYXRlT25lXyIsInVuZGVmaW5lZCIsInByb2Nlc3NlZCIsIiRyZXN1bHQiLCJhZmZlY3RlZFJvd3MiLCJrZXkiLCJnZXRVbmlxdWVLZXlWYWx1ZVBhaXJzRnJvbSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsVUFBVDtBQUFzQkMsRUFBQUE7QUFBdEIsSUFBZ0NKLE9BQU8sQ0FBQyxVQUFELENBQTdDOztBQU1BLE1BQU1LLGNBQU4sQ0FBcUI7QUFNakJDLEVBQUFBLFdBQVcsQ0FBQ0MsR0FBRCxFQUFNQyxPQUFOLEVBQWVDLEVBQWYsRUFBbUI7QUFDMUIsU0FBS0YsR0FBTCxHQUFXQSxHQUFYO0FBQ0EsU0FBS0csU0FBTCxHQUFpQkYs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QUVBLFVBQUlKLE9BQUosRUFBYTtBQUNULGNBQU1wQixNQUFNLENBQUN5QixVQUFQLENBQWtCSixJQUFsQixFQUF3QkssU0FBeEIsRUFBbUNULFdBQW5DLENBQU47QUFDSCxPQUZELE1BRU87QUFDSCxjQUFNVSxTQUFTLEdBQUcsTUFBTTNCLE1BQU0sQ0FBQ3ZFLE9BQVAsQ0FBZTRGLElBQWYsRUFBcUJDLElBQXJCLEVBQTJCTCxXQUEzQixDQUF4Qjs7QUFDQSxZQUFJSyxJQUFJLENBQUNNLE9BQUwsQ0FBYUMsWUFBYixLQUE4QixDQUFsQyxFQUFxQztBQUNqQyxnQkFBTUMsR0FBRyxHQUFHOUIsTUFBTSxDQUFDK0IsMEJBQVAsQ0FBa0NKLFNBQWxDLENBQVo7QUFDQSxlQUFLL0csR0FBTCxDQUFTMEIsR0FBVCxDQUFhLE1BQWIsRUFBc0Isb0JBQW1CMEYsSUFBSSxDQUFDQyxTQUFMLENBQWVILEdBQWYsQ0FBb0IsY0FBN0Q7QUFDSDtBQUNKO0FBQ0osS0FaZ0IsQ0FBakI7QUFhSDs7QUF4TmdCOztBQTJOckJJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnpILGNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCAgcXVvdGUgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbi8qKlxuICogTXlTUUwgbWlncmF0aW9uLlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIE15U1FMTWlncmF0aW9uIHtcbiAgICAvKiogXG4gICAgICogQHBhcmFtIHtTZXJ2aWNlQ29udGFpbmVyfSBhcHAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAgICAgKiBAcGFyYW0ge0RifSBkYlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGFwcCwgY29udGV4dCwgZGIpIHtcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7ICAgICAgICBcbiAgICAgICAgdGhpcy5tb2RlbFBhdGggPSBjb250ZXh0Lm1vZGVsUGF0aDtcbiAgICAgICAgdGhpcy5zY3JpcHRQYXRoID0gY29udGV4dC5zY3JpcHRQYXRoOyAgICAgICAgXG4gICAgICAgIHRoaXMuZGIgPSBkYjtcblxuICAgICAgICB0aGlzLmRiU2NyaXB0UGF0aCA9IHBhdGguam9pbih0aGlzLnNjcmlwdFBhdGgsIHRoaXMuZGIuZHJpdmVyLCB0aGlzLmRiLmNvbm5lY3Rvci5kYXRhYmFzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVzZXRfKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5jb25uZWN0b3IuZXhlY3V0ZV8oYERST1AgREFUQUJBU0UgSUYgRVhJU1RTID8/YCwgWyB0aGlzLmRiLmNvbm5lY3Rvci5kYXRhYmFzZSBdLCB7IGNyZWF0ZURhdGFiYXNlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGNyZWF0ZV8oZXh0cmFPcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgbGV0IHNxbEZpbGVzID0gWyAnZW50aXRpZXMuc3FsJywgJ3JlbGF0aW9ucy5zcWwnLCAncHJvY2VkdXJlcy5zcWwnIF07XG5cbiAgICAgICAgbGV0IHNxbENyZWF0ZSA9ICdDUkVBVEUgREFUQUJBU0UgSUYgTk9UIEVYSVNUUyA/Pyc7XG5cbiAgICAgICAgaWYgKGV4dHJhT3B0aW9ucyAmJiAhXy5pc0VtcHR5KGV4dHJhT3B0aW9ucy5kYikpIHtcbiAgICAgICAgICAgIHNxbENyZWF0ZSArPSAnICcgKyBfLnJlZHVjZShleHRyYU9wdGlvbnMuZGIsIChyLCB2LCBrKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHIgKyAnICcgKyBfLnVwcGVyQ2FzZShrKSArICcgJyArIHF1b3RlKHYudG9TdHJpbmcoKSwgJ1wiJyk7XG4gICAgICAgICAgICB9LCAnJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5leGVjdXRlXyhzcWxDcmVhdGUsIFxuICAgICAgICAgICAgWyB0aGlzLmRiLmNvbm5lY3Rvci5kYXRhYmFzZSBdLCBcbiAgICAgICAgICAgIHsgY3JlYXRlRGF0YWJhc2U6IHRydWUgfVxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgaWYgKHJlc3VsdC53YXJuaW5nU3RhdHVzID09IDApIHtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBDcmVhdGVkIGRhdGFiYXNlIFwiJHt0aGlzLmRiLmNvbm5lY3Rvci5kYXRhYmFzZX1cIi5gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnd2FybicsIGBEYXRhYmFzZSBcIiR7dGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2V9XCIgZXhpc3RzLmApO1xuICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oc3FsRmlsZXMsIGFzeW5jIChmaWxlKSA9PiB7XG4gICAgICAgICAgICBsZXQgc3FsRmlsZSA9IHBhdGguam9pbih0aGlzLmRiU2NyaXB0UGF0aCwgZmlsZSk7XG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc3FsRmlsZSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGFiYXNlIHNjcmlwdCBcIiR7c3FsRmlsZX1cIiBub3QgZm91bmQuIFRyeSBydW4gXCJvb2xvbmcgYnVpbGRcIiBmaXJzdC5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHNxbCA9IF8udHJpbShmcy5yZWFkRmlsZVN5bmMoc3FsRmlsZSwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pKTtcbiAgICAgICAgICAgIGlmIChzcWwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBfLmNhc3RBcnJheShhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5leGVjdXRlXyhzcWwsIG51bGwsIHsgbXVsdGlwbGVTdGF0ZW1lbnRzOiAxIH0pKTtcblxuICAgICAgICAgICAgICAgIGxldCB3YXJuaW5nUm93cyA9IF8ucmVkdWNlKHJlc3VsdCwgKHN1bSwgcm93KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN1bSArPSByb3cud2FybmluZ1N0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bTtcbiAgICAgICAgICAgICAgICB9LCAwKTtcblxuICAgICAgICAgICAgICAgIGlmICh3YXJuaW5nUm93cyA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHAubG9nKCd3YXJuJywgYCR7d2FybmluZ1Jvd3N9IHdhcm5pbmcocykgcmVwb3J0ZWQgd2hpbGUgcnVubmluZyBcIiR7ZmlsZX1cIi5gKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgRGF0YWJhc2Ugc2NyaXB0cyBcIiR7c3FsRmlsZX1cIiBydW4gc3VjY2Vzc2Z1bGx5LmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgbG9hZF8oZGF0YUZpbGUsIGlnbm9yZUR1cGxpY2F0ZSkge1xuICAgICAgICBsZXQgZXh0ID0gcGF0aC5leHRuYW1lKGRhdGFGaWxlKTtcbiAgICAgICAgdGhpcy5hcHAubG9nKCd2ZXJib3NlJywgYExvYWRpbmcgZGF0YSBmaWxlIFwiJHtkYXRhRmlsZX1cIiAuLi5gKTtcblxuICAgICAgICBpZiAoZXh0ID09PSAnLmpzb24nKSB7XG4gICAgICAgICAgICBsZXQgZGF0YSA9IGZzLnJlYWRKc29uU3luYyhkYXRhRmlsZSwge2VuY29kaW5nOiAndXRmOCd9KTtcblxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IHBhdGguYmFzZW5hbWUoZGF0YUZpbGUsIGV4dCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZFNpbmdsZUVudGl0eVJlY29yZHNfKGVudGl0eU5hbWUsIGRhdGEsIGlnbm9yZUR1cGxpY2F0ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRNdWx0aUVudGl0eVJlY29yZHNfKGRhdGEsIGlnbm9yZUR1cGxpY2F0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgTG9hZGVkIEpTT04gZGF0YSBmaWxlOiAke2RhdGFGaWxlfWApO1xuICAgICAgICB9IGVsc2UgaWYgKGV4dCA9PT0gJy5zcWwnKSB7XG4gICAgICAgICAgICBsZXQgc3FsID0gZnMucmVhZEZpbGVTeW5jKGRhdGFGaWxlLCB7ZW5jb2Rpbmc6ICd1dGY4J30pO1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKHNxbCwgbnVsbCwgeyBtdWx0aXBsZVN0YXRlbWVudHM6IDEgfSk7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgRXhlY3V0ZWQgU1FMIGZpbGU6ICR7ZGF0YUZpbGV9YCwgcmVzdWx0KTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcueGxzeCcpIHtcblxuICAgICAgICAgICAgY29uc3QgRXhjZWwgPSByZXF1aXJlKCdleGNlbGpzJyk7XG4gICAgICAgICAgICBsZXQgd29ya2Jvb2sgPSBuZXcgRXhjZWwuV29ya2Jvb2soKTtcbiAgICAgICAgICAgIGF3YWl0IHdvcmtib29rLnhsc3gucmVhZEZpbGUoZGF0YUZpbGUpOyAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBkYXRhID0ge307XG5cbiAgICAgICAgICAgIHdvcmtib29rLmVhY2hTaGVldCgod29ya3NoZWV0LCBzaGVldElkKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbEtleXM7XG5cbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IHdvcmtzaGVldC5uYW1lO1xuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlEYXRhID0gW107XG4gICAgICAgICAgICAgICAgZGF0YVtlbnRpdHlOYW1lXSA9IGVudGl0eURhdGE7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgd29ya3NoZWV0LmVhY2hSb3coZnVuY3Rpb24ocm93LCByb3dOdW1iZXIpIHsgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbEtleXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbEtleXMgPSBfLmRyb3Aocm93LnZhbHVlcyk7ICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlY29yZCA9IF8uZnJvbVBhaXJzKF8uemlwKGNvbEtleXMsIF8uZHJvcChyb3cudmFsdWVzKSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5RGF0YS5wdXNoKHJlY29yZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkTXVsdGlFbnRpdHlSZWNvcmRzXyhkYXRhKTtcblxuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYEltcG9ydGVkIGV4Y2VsIGRhdGEgZmlsZTogJHtkYXRhRmlsZX1gKTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcuanMnKSB7ICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBleGVjdXRvciA9IHJlcXVpcmUoZGF0YUZpbGUpO1xuICAgICAgICAgICAgYXdhaXQgZXhlY3V0b3IodGhpcy5hcHAsIHRoaXMuZGIuY29ubmVjdG9yKTtcblxuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYFJhbiBkYXRhIHNjcmlwdDogJHtkYXRhRmlsZX1gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgZGF0YSBmaWxlIGZvcm1hdC4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHdyaXRlSW5kZXhGaWxlKG91dHB1dERpciwgaXRlbXMpIHtcbiAgICAgICAgY29uc3QgaW5kZXhGaWxlID0gcGF0aC5qb2luKG91dHB1dERpciwgJ2luZGV4Lmxpc3QnKTtcblxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGluZGV4RmlsZSwgaXRlbXMuam9pbignXFxuJyksICd1dGY4Jyk7XG4gICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsICdHZW5lcmF0ZWQgZGF0YSBmaWxlcyBsaXN0OiAnICsgaW5kZXhGaWxlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleHBvcnRfKGVudGl0aWVzVG9FeHBvcnQsIG91dHB1dERpciwgc2tpcEluZGV4RmlsZSkge1xuICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKG91dHB1dERpcik7XG5cbiAgICAgICAgY29uc3QgaXRlbXMgPSBbXTtcblxuICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKGVudGl0aWVzVG9FeHBvcnQsIGFzeW5jIChleHBvcnRDb25maWcsIGRhdGFGaWxlTmFtZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZW50aXR5TmFtZSA9IGV4cG9ydENvbmZpZy5lbnRpdHlOYW1lIHx8IGRhdGFGaWxlTmFtZTtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygndmVyYm9zZScsICdFeHBvcnRpbmcgZGF0YSBvZiBlbnRpdHk6ICcgKyBlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgY29uc3QgRW50aXR5ID0gdGhpcy5kYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBFbnRpdHkuZmluZEFsbF8oZXhwb3J0Q29uZmlnLmRhdGFzZXQpO1xuXG4gICAgICAgICAgICBfLmZvck93bihleHBvcnRDb25maWcucnVsZXMsIChlbmFibGVkLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1J1bGUgPSByZXF1aXJlKGAuL3J1bGVzLyR7bmFtZX0uanNgKTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5mb3JFYWNoKGVudGl0eSA9PiBwcm9jZXNzUnVsZSh0aGlzLmRiLCBFbnRpdHksIGVudGl0eSkpO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGJhc2VGaWxlTmFtZSA9IGAke2RhdGFGaWxlTmFtZX0uanNvbmA7XG4gICAgICAgICAgICBpdGVtcy5wdXNoKGJhc2VGaWxlTmFtZSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGRhdGFGaWxlID0gcGF0aC5qb2luKG91dHB1dERpciwgYmFzZUZpbGVOYW1lKTtcblxuICAgICAgICAgICAgZnMud3JpdGVKc29uU3luYyhkYXRhRmlsZSwge1xuICAgICAgICAgICAgICAgIFtFbnRpdHkubWV0YS5uYW1lXTogZGF0YVxuICAgICAgICAgICAgfSwgeyBzcGFjZXM6IDQgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsICdHZW5lcmF0ZWQgZW50aXR5IGRhdGEgZmlsZTogJyArIGRhdGFGaWxlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFza2lwSW5kZXhGaWxlKSB7XG4gICAgICAgICAgICB0aGlzLndyaXRlSW5kZXhGaWxlKG91dHB1dERpciwgaXRlbXMpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gaXRlbXM7XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWRNdWx0aUVudGl0eVJlY29yZHNfKGRhdGEsIGlnbm9yZUR1cGxpY2F0ZSkgeyAgICAgICAgXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTA7Jyk7XG5cbiAgICAgICAgICAgIGF3YWl0IGVhY2hBc3luY18oZGF0YSwgYXN5bmMgKHJlY29yZHMsIGVudGl0eU5hbWUpID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW1zID0gQXJyYXkuaXNBcnJheShyZWNvcmRzKSA/IHJlY29yZHMgOiBbIHJlY29yZHMgXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9hZFJlY29yZHNCeU1vZGVsXyhlbnRpdHlOYW1lLCBpdGVtcywgaWdub3JlRHVwbGljYXRlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5leGVjdXRlXygnU0VUIEZPUkVJR05fS0VZX0NIRUNLUz0xOycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWRTaW5nbGVFbnRpdHlSZWNvcmRzXyhlbnRpdHlOYW1lLCBkYXRhLCBpZ25vcmVEdXBsaWNhdGUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTA7Jyk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRSZWNvcmRzQnlNb2RlbF8oZW50aXR5TmFtZSwgZGF0YSwgaWdub3JlRHVwbGljYXRlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuZXhlY3V0ZV8oJ1NFVCBGT1JFSUdOX0tFWV9DSEVDS1M9MTsnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkUmVjb3Jkc0J5TW9kZWxfKGVudGl0eU5hbWUsIGl0ZW1zLCBpZ25vcmVEdXBsaWNhdGUpIHtcbiAgICAgICAgY29uc3QgY29ubk9wdGlvbnMgPSB7fTtcbiAgICAgICAgaWYgKGlnbm9yZUR1cGxpY2F0ZSkge1xuICAgICAgICAgICAgY29ubk9wdGlvbnMuaW5zZXJ0SWdub3JlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IEVudGl0eSA9IHRoaXMuZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oaXRlbXMsIGFzeW5jICh7ICRza2lwTW9kaWZpZXJzLCAkdXBkYXRlLCAuLi5pdGVtIH0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7ICRtaWdyYXRpb246IHRydWUsICRza2lwTW9kaWZpZXJzLCAkcmV0cmlldmVEYlJlc3VsdDogdHJ1ZSB9O1xuXG4gICAgICAgICAgICBpZiAoJHVwZGF0ZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IEVudGl0eS51cGRhdGVPbmVfKGl0ZW0sIHVuZGVmaW5lZCwgY29ubk9wdGlvbnMpO1xuICAgICAgICAgICAgfSBlbHNlIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvY2Vzc2VkID0gYXdhaXQgRW50aXR5LmNyZWF0ZV8oaXRlbSwgb3B0cywgY29ubk9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIGlmIChvcHRzLiRyZXN1bHQuYWZmZWN0ZWRSb3dzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IEVudGl0eS5nZXRVbmlxdWVLZXlWYWx1ZVBhaXJzRnJvbShwcm9jZXNzZWQpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgRHVwbGljYXRlIHJlY29yZCAke0pTT04uc3RyaW5naWZ5KGtleSl9IGlzIGlnbm9yZWQuYCk7XG4gICAgICAgICAgICAgICAgfSAgICAgICBcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgIFxuICAgICAgICB9KTsgIFxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTE1pZ3JhdGlvbjsiXX0=
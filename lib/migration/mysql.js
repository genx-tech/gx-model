"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  eachAsync_,
  quote
} = require('rk-utils');

class MySQLMigration {
  constructor(app, context, db) {
    this.app = app;
    this.modelPath = context.modelPath;
    this.scriptPath = context.scriptPath;
    this.db = db;
    this.dbScriptPath = path.join(this.scriptPath, this.db.driver, this.db.connector.database);
  }

  async reset_() {
    return this.db.connector.execute_(`DROP DATABASE IF EXISTS ??`, [this.db.connector.database], {
      createDatabase: true
    });
  }

  async create_(extraOptions) {
    let sqlFiles = ['entities.sql', 'relations.sql', 'procedures.sql'];
    let sqlCreate = 'CREATE DATABASE IF NOT EXISTS ??';

    if (extraOptions && !_.isEmpty(extraOptions.db)) {
      sqlCreate += ' ' + _.reduce(extraOptions.db, (r, v, k) => {
        return r + ' ' + _.upperCase(k) + ' ' + quote(v.toString(), '"');
      }, '');
    }

    let result = await this.db.connector.execute_(sqlCreate, [this.db.connector.database], {
      createDatabase: true
    });

    if (result.warningStatus == 0) {
      this.app.log('info', `Created database "${this.db.connector.database}".`);
    } else {
      this.app.log('warn', `Database "${this.db.connector.database}" exists.`);
    }

    return eachAsync_(sqlFiles, async file => {
      let sqlFile = path.join(this.dbScriptPath, file);

      if (!fs.existsSync(sqlFile)) {
        throw new Error(`Database script "${sqlFile}" not found. Try run "oolong build" first.`);
      }

      let sql = _.trim(fs.readFileSync(sqlFile, {
        encoding: 'utf8'
      }));

      if (sql) {
        result = _.castArray((await this.db.connector.execute_(sql, null, {
          multipleStatements: 1
        })));

        let warningRows = _.reduce(result, (sum, row) => {
          sum += row.warningStatus;
          return sum;
        }, 0);

        if (warningRows > 0) {
          this.app.log('warn', `${warningRows} warning(s) reported while running "${file}".`);
        } else {
          this.app.log('info', `Database scripts "${sqlFile}" run successfully.`);
        }
      }
    });
  }

  async load_(dataFile) {
    let ext = path.extname(dataFile);
    this.app.log('verbose', `Loading data file "${dataFile}" ...`);

    if (ext === '.json') {
      let data = fs.readJsonSync(dataFile, {
        encoding: 'utf8'
      });

      if (Array.isArray(data)) {
        let entityName = path.basename(dataFile, ext);
        await this._loadSingleEntityRecords_(entityName, data);
      } else {
        await this._loadMultiEntityRecords_(data);
      }

      this.app.log('info', `Loaded JSON data file: ${dataFile}`);
    } else if (ext === '.sql') {
      let sql = fs.readFileSync(dataFile, {
        encoding: 'utf8'
      });
      let result = await this.db.connector.execute_(sql, null, {
        multipleStatements: 1
      });
      this.app.log('info', `Executed SQL file: ${dataFile}`, result);
    } else if (ext === '.xlsx') {
      const Excel = require('exceljs');

      let workbook = new Excel.Workbook();
      await workbook.xlsx.readFile(dataFile);
      let data = {};
      workbook.eachSheet((worksheet, sheetId) => {
        let colKeys;
        let entityName = worksheet.name;
        let entityData = [];
        data[entityName] = entityData;
        worksheet.eachRow(function (row, rowNumber) {
          if (!colKeys) {
            colKeys = _.drop(row.values);
          } else {
            let record = _.fromPairs(_.zip(colKeys, _.drop(row.values)));

            entityData.push(record);
          }
        });
      });
      await this._loadMultiEntityRecords_(data);
      this.app.log('info', `Imported excel data file: ${dataFile}`);
    } else if (ext === '.js') {
      let executor = require(dataFile);

      await executor(this.app, this.db.connector);
      this.app.log('info', `Ran data script: ${dataFile}`);
    } else {
      throw new Error('Unsupported data file format.');
    }
  }

  async _loadMultiEntityRecords_(data) {
    try {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, async (records, entityName) => {
        let items = Array.isArray(records) ? records : [records];
        return eachAsync_(items, item => this.db.model(entityName).create_(item, {
          $migration: true
        }));
      });
    } catch (error) {
      throw error;
    } finally {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    }
  }

  async _loadSingleEntityRecords_(entityName, data) {
    try {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, item => this.db.model(entityName).create_(item, {
        $migration: true
      }));
    } catch (error) {
      throw error;
    } finally {
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    }
  }

}

module.exports = MySQLMigration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWdyYXRpb24vbXlzcWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwicXVvdGUiLCJNeVNRTE1pZ3JhdGlvbiIsImNvbnN0cnVjdG9yIiwiYXBwIiwiY29udGV4dCIsImRiIiwibW9kZWxQYXRoIiwic2NyaXB0UGF0aCIsImRiU2NyaXB0UGF0aCIsImpvaW4iLCJkcml2ZXIiLCJjb25uZWN0b3IiLCJkYXRhYmFzZSIsInJlc2V0XyIsImV4ZWN1dGVfIiwiY3JlYXRlRGF0YWJhc2UiLCJjcmVhdGVfIiwiZXh0cmFPcHRpb25zIiwic3FsRmlsZXMiLCJzcWxDcmVhdGUiLCJpc0VtcHR5IiwicmVkdWNlIiwiciIsInYiLCJrIiwidXBwZXJDYXNlIiwidG9TdHJpbmciLCJyZXN1bHQiLCJ3YXJuaW5nU3RhdHVzIiwibG9nIiwiZmlsZSIsInNxbEZpbGUiLCJleGlzdHNTeW5jIiwiRXJyb3IiLCJzcWwiLCJ0cmltIiwicmVhZEZpbGVTeW5jIiwiZW5jb2RpbmciLCJjYXN0QXJyYXkiLCJtdWx0aXBsZVN0YXRlbWVudHMiLCJ3YXJuaW5nUm93cyIsInN1bSIsInJvdyIsImxvYWRfIiwiZGF0YUZpbGUiLCJleHQiLCJleHRuYW1lIiwiZGF0YSIsInJlYWRKc29uU3luYyIsIkFycmF5IiwiaXNBcnJheSIsImVudGl0eU5hbWUiLCJiYXNlbmFtZSIsIl9sb2FkU2luZ2xlRW50aXR5UmVjb3Jkc18iLCJfbG9hZE11bHRpRW50aXR5UmVjb3Jkc18iLCJFeGNlbCIsIndvcmtib29rIiwiV29ya2Jvb2siLCJ4bHN4IiwicmVhZEZpbGUiLCJlYWNoU2hlZXQiLCJ3b3Jrc2hlZXQiLCJzaGVldElkIiwiY29sS2V5cyIsIm5hbWUiLCJlbnRpdHlEYXRhIiwiZWFjaFJvdyIsInJvd051bWJlciIsImRyb3AiLCJ2YWx1ZXMiLCJyZWNvcmQiLCJmcm9tUGFpcnMiLCJ6aXAiLCJwdXNoIiwiZXhlY3V0b3IiLCJyZWNvcmRzIiwiaXRlbXMiLCJpdGVtIiwibW9kZWwiLCIkbWlncmF0aW9uIiwiZXJyb3IiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsVUFBVDtBQUFzQkMsRUFBQUE7QUFBdEIsSUFBZ0NKLE9BQU8sQ0FBQyxVQUFELENBQTdDOztBQU1BLE1BQU1LLGNBQU4sQ0FBcUI7QUFNakJDLEVBQUFBLFdBQVcsQ0FBQ0MsR0FBRCxFQUFNQyxPQUFOLEVBQWVDLEVBQWYsRUFBbUI7QUFDMUIsU0FBS0YsR0FBTCxHQUFXQSxHQUFYO0FBQ0EsU0FBS0csU0FBTCxHQUFpQkYsT0FBTyxDQUFDRSxTQUF6QjtBQUNBLFNBQUtDLFVBQUwsR0FBa0JILE9BQU8sQ0FBQ0csVUFBMUI7QUFDQSxTQUFLRixFQUFMLEdBQVVBLEVBQVY7QUFFQSxTQUFLRyxZQUFMLEdBQW9CYixJQUFJLENBQUNjLElBQUwsQ0FBVSxLQUFLRixVQUFmLEVBQTJCLEtBQUtGLEVBQUwsQ0FBUUssTUFBbkMsRUFBMkMsS0FBS0wsRUFBTCxDQUFRTSxTQUFSLENBQWtCQyxRQUE3RCxDQUFwQjtBQUNIOztBQUVELFFBQU1DLE1BQU4sR0FBZTtBQUNYLFdBQU8sS0FBS1IsRUFBTCxDQUFRTSxTQUFSLENBQWtCRyxRQUFsQixDQUE0Qiw0QkFBNUIsRUFBeUQsQ0FBRSxLQUFLVCxFQUFMLENBQVFNLFNBQVIsQ0FBa0JDLFFBQXBCLENBQXpELEVBQXlGO0FBQUVHLE1BQUFBLGNBQWMsRUFBRTtBQUFsQixLQUF6RixDQUFQO0FBQ0g7O0FBRUQsUUFBTUMsT0FBTixDQUFjQyxZQUFkLEVBQTRCO0FBQ3hCLFFBQUlDLFFBQVEsR0FBRyxDQUFFLGNBQUYsRUFBa0IsZUFBbEIsRUFBbUMsZ0JBQW5DLENBQWY7QUFFQSxRQUFJQyxTQUFTLEdBQUcsa0NBQWhC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O0FBQ0EsWUFBTSxLQUFLMUMsRUFBTCxDQUFRTSxTQUFSLENBQWtCRyxRQUFsQixDQUEyQiwyQkFBM0IsQ0FBTjtBQUVBLFlBQU1mLFVBQVUsQ0FBQ2dELElBQUQsRUFBTzhCLElBQUksSUFBSSxLQUFLeEUsRUFBTCxDQUFReUUsS0FBUixDQUFjM0IsVUFBZCxFQUEwQm5DLE9BQTFCLENBQWtDNkQsSUFBbEMsRUFBd0M7QUFBRUUsUUFBQUEsVUFBVSxFQUFFO0FBQWQsT0FBeEMsQ0FBZixDQUFoQjtBQUNILEtBSkQsQ0FJRSxPQUFPQyxLQUFQLEVBQWM7QUFDWixZQUFNQSxLQUFOO0FBQ0gsS0FORCxTQU1VO0FBQ04sWUFBTTNFLEVBQUUsQ0FBQ00sU0FBSCxDQUFhRyxRQUFiLENBQXNCLDJCQUF0QixDQUFOO0FBQ0g7QUFDSjs7QUFwSmdCOztBQXVKckJtRSxNQUFNLENBQUNDLE9BQVAsR0FBaUJqRixjQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcywgZWFjaEFzeW5jXywgIHF1b3RlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG4vKipcbiAqIE15U1FMIG1pZ3JhdGlvbi5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBNeVNRTE1pZ3JhdGlvbiB7XG4gICAgLyoqIFxuICAgICAqIEBwYXJhbSB7U2VydmljZUNvbnRhaW5lcn0gYXBwICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHBhcmFtIHtEYn0gZGJcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihhcHAsIGNvbnRleHQsIGRiKSB7XG4gICAgICAgIHRoaXMuYXBwID0gYXBwOyAgICAgICAgXG4gICAgICAgIHRoaXMubW9kZWxQYXRoID0gY29udGV4dC5tb2RlbFBhdGg7XG4gICAgICAgIHRoaXMuc2NyaXB0UGF0aCA9IGNvbnRleHQuc2NyaXB0UGF0aDsgICAgICAgIFxuICAgICAgICB0aGlzLmRiID0gZGI7XG5cbiAgICAgICAgdGhpcy5kYlNjcmlwdFBhdGggPSBwYXRoLmpvaW4odGhpcy5zY3JpcHRQYXRoLCB0aGlzLmRiLmRyaXZlciwgdGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2V0XygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKGBEUk9QIERBVEFCQVNFIElGIEVYSVNUUyA/P2AsIFsgdGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2UgXSwgeyBjcmVhdGVEYXRhYmFzZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjcmVhdGVfKGV4dHJhT3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGxldCBzcWxGaWxlcyA9IFsgJ2VudGl0aWVzLnNxbCcsICdyZWxhdGlvbnMuc3FsJywgJ3Byb2NlZHVyZXMuc3FsJyBdO1xuXG4gICAgICAgIGxldCBzcWxDcmVhdGUgPSAnQ1JFQVRFIERBVEFCQVNFIElGIE5PVCBFWElTVFMgPz8nO1xuXG4gICAgICAgIGlmIChleHRyYU9wdGlvbnMgJiYgIV8uaXNFbXB0eShleHRyYU9wdGlvbnMuZGIpKSB7XG4gICAgICAgICAgICBzcWxDcmVhdGUgKz0gJyAnICsgXy5yZWR1Y2UoZXh0cmFPcHRpb25zLmRiLCAociwgdiwgaykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByICsgJyAnICsgXy51cHBlckNhc2UoaykgKyAnICcgKyBxdW90ZSh2LnRvU3RyaW5nKCksICdcIicpO1xuICAgICAgICAgICAgfSwgJycpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuZXhlY3V0ZV8oc3FsQ3JlYXRlLCBcbiAgICAgICAgICAgIFsgdGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2UgXSwgXG4gICAgICAgICAgICB7IGNyZWF0ZURhdGFiYXNlOiB0cnVlIH1cbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChyZXN1bHQud2FybmluZ1N0YXR1cyA9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgQ3JlYXRlZCBkYXRhYmFzZSBcIiR7dGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2V9XCIuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ3dhcm4nLCBgRGF0YWJhc2UgXCIke3RoaXMuZGIuY29ubmVjdG9yLmRhdGFiYXNlfVwiIGV4aXN0cy5gKTtcbiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIHJldHVybiBlYWNoQXN5bmNfKHNxbEZpbGVzLCBhc3luYyAoZmlsZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHNxbEZpbGUgPSBwYXRoLmpvaW4odGhpcy5kYlNjcmlwdFBhdGgsIGZpbGUpO1xuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHNxbEZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEYXRhYmFzZSBzY3JpcHQgXCIke3NxbEZpbGV9XCIgbm90IGZvdW5kLiBUcnkgcnVuIFwib29sb25nIGJ1aWxkXCIgZmlyc3QuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBzcWwgPSBfLnRyaW0oZnMucmVhZEZpbGVTeW5jKHNxbEZpbGUsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSk7XG4gICAgICAgICAgICBpZiAoc3FsKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXy5jYXN0QXJyYXkoYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuZXhlY3V0ZV8oc3FsLCBudWxsLCB7IG11bHRpcGxlU3RhdGVtZW50czogMSB9KSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgd2FybmluZ1Jvd3MgPSBfLnJlZHVjZShyZXN1bHQsIChzdW0sIHJvdykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzdW0gKz0gcm93Lndhcm5pbmdTdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzdW07XG4gICAgICAgICAgICAgICAgfSwgMCk7XG5cbiAgICAgICAgICAgICAgICBpZiAod2FybmluZ1Jvd3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnd2FybicsIGAke3dhcm5pbmdSb3dzfSB3YXJuaW5nKHMpIHJlcG9ydGVkIHdoaWxlIHJ1bm5pbmcgXCIke2ZpbGV9XCIuYCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYERhdGFiYXNlIHNjcmlwdHMgXCIke3NxbEZpbGV9XCIgcnVuIHN1Y2Nlc3NmdWxseS5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRfKGRhdGFGaWxlKSB7XG4gICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZGF0YUZpbGUpO1xuICAgICAgICB0aGlzLmFwcC5sb2coJ3ZlcmJvc2UnLCBgTG9hZGluZyBkYXRhIGZpbGUgXCIke2RhdGFGaWxlfVwiIC4uLmApO1xuXG4gICAgICAgIGlmIChleHQgPT09ICcuanNvbicpIHtcbiAgICAgICAgICAgIGxldCBkYXRhID0gZnMucmVhZEpzb25TeW5jKGRhdGFGaWxlLCB7ZW5jb2Rpbmc6ICd1dGY4J30pO1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gcGF0aC5iYXNlbmFtZShkYXRhRmlsZSwgZXh0KTtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkU2luZ2xlRW50aXR5UmVjb3Jkc18oZW50aXR5TmFtZSwgZGF0YSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRNdWx0aUVudGl0eVJlY29yZHNfKGRhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYExvYWRlZCBKU09OIGRhdGEgZmlsZTogJHtkYXRhRmlsZX1gKTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcuc3FsJykge1xuICAgICAgICAgICAgbGV0IHNxbCA9IGZzLnJlYWRGaWxlU3luYyhkYXRhRmlsZSwge2VuY29kaW5nOiAndXRmOCd9KTtcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5leGVjdXRlXyhzcWwsIG51bGwsIHsgbXVsdGlwbGVTdGF0ZW1lbnRzOiAxIH0pO1xuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYEV4ZWN1dGVkIFNRTCBmaWxlOiAke2RhdGFGaWxlfWAsIHJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXh0ID09PSAnLnhsc3gnKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IEV4Y2VsID0gcmVxdWlyZSgnZXhjZWxqcycpO1xuICAgICAgICAgICAgbGV0IHdvcmtib29rID0gbmV3IEV4Y2VsLldvcmtib29rKCk7XG4gICAgICAgICAgICBhd2FpdCB3b3JrYm9vay54bHN4LnJlYWRGaWxlKGRhdGFGaWxlKTsgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZGF0YSA9IHt9O1xuXG4gICAgICAgICAgICB3b3JrYm9vay5lYWNoU2hlZXQoKHdvcmtzaGVldCwgc2hlZXRJZCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb2xLZXlzO1xuXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSB3b3Jrc2hlZXQubmFtZTtcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5RGF0YSA9IFtdO1xuICAgICAgICAgICAgICAgIGRhdGFbZW50aXR5TmFtZV0gPSBlbnRpdHlEYXRhO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHdvcmtzaGVldC5lYWNoUm93KGZ1bmN0aW9uKHJvdywgcm93TnVtYmVyKSB7ICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb2xLZXlzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xLZXlzID0gXy5kcm9wKHJvdy52YWx1ZXMpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZWNvcmQgPSBfLmZyb21QYWlycyhfLnppcChjb2xLZXlzLCBfLmRyb3Aocm93LnZhbHVlcykpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eURhdGEucHVzaChyZWNvcmQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZE11bHRpRW50aXR5UmVjb3Jkc18oZGF0YSk7XG5cbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBJbXBvcnRlZCBleGNlbCBkYXRhIGZpbGU6ICR7ZGF0YUZpbGV9YCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXh0ID09PSAnLmpzJykgeyAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZXhlY3V0b3IgPSByZXF1aXJlKGRhdGFGaWxlKTtcbiAgICAgICAgICAgIGF3YWl0IGV4ZWN1dG9yKHRoaXMuYXBwLCB0aGlzLmRiLmNvbm5lY3Rvcik7XG5cbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBSYW4gZGF0YSBzY3JpcHQ6ICR7ZGF0YUZpbGV9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIGRhdGEgZmlsZSBmb3JtYXQuJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfbG9hZE11bHRpRW50aXR5UmVjb3Jkc18oZGF0YSkgeyAgICAgICAgXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTA7Jyk7XG5cbiAgICAgICAgICAgIGF3YWl0IGVhY2hBc3luY18oZGF0YSwgYXN5bmMgKHJlY29yZHMsIGVudGl0eU5hbWUpID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW1zID0gQXJyYXkuaXNBcnJheShyZWNvcmRzKSA/IHJlY29yZHMgOiBbIHJlY29yZHMgXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhpdGVtcywgaXRlbSA9PiB0aGlzLmRiLm1vZGVsKGVudGl0eU5hbWUpLmNyZWF0ZV8oaXRlbSwgeyAkbWlncmF0aW9uOiB0cnVlIH0pKTsgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTE7Jyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfbG9hZFNpbmdsZUVudGl0eVJlY29yZHNfKGVudGl0eU5hbWUsIGRhdGEpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTA7Jyk7XG5cbiAgICAgICAgICAgIGF3YWl0IGVhY2hBc3luY18oZGF0YSwgaXRlbSA9PiB0aGlzLmRiLm1vZGVsKGVudGl0eU5hbWUpLmNyZWF0ZV8oaXRlbSwgeyAkbWlncmF0aW9uOiB0cnVlIH0pKTsgIFxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBhd2FpdCBkYi5jb25uZWN0b3IuZXhlY3V0ZV8oJ1NFVCBGT1JFSUdOX0tFWV9DSEVDS1M9MTsnKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTE1pZ3JhdGlvbjsiXX0=
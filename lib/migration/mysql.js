"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  eachAsync_,
  quote
} = require('rk-utils');

class MySQLMigration {
  constructor(app, context, db) {
    this.app = app;
    this.modelPath = context.modelPath;
    this.scriptPath = context.scriptPath;
    this.db = db;
    this.dbScriptPath = path.join(this.scriptPath, this.db.driver, this.db.connector.database);
  }

  async reset_() {
    return this.db.connector.execute_(`DROP DATABASE IF EXISTS ??`, [this.db.connector.database], {
      createDatabase: true
    });
  }

  async create_(extraOptions) {
    let sqlFiles = ['entities.sql', 'relations.sql', 'procedures.sql'];
    let sqlCreate = 'CREATE DATABASE IF NOT EXISTS ??';

    if (extraOptions && !_.isEmpty(extraOptions.db)) {
      sqlCreate += ' ' + _.reduce(extraOptions.db, (r, v, k) => {
        return r + ' ' + _.upperCase(k) + ' ' + quote(v.toString(), '"');
      }, '');
    }

    let result = await this.db.connector.execute_(sqlCreate, [this.db.connector.database], {
      createDatabase: true
    });

    if (result.warningStatus == 0) {
      this.app.log('info', `Created database "${this.db.connector.database}".`);
    } else {
      this.app.log('warn', `Database "${this.db.connector.database}" exists.`);
    }

    return eachAsync_(sqlFiles, async file => {
      let sqlFile = path.join(this.dbScriptPath, file);

      if (!fs.existsSync(sqlFile)) {
        throw new Error(`Database script "${sqlFile}" not found. Try run "oolong build" first.`);
      }

      let sql = _.trim(fs.readFileSync(sqlFile, {
        encoding: 'utf8'
      }));

      if (sql) {
        result = _.castArray((await this.db.connector.execute_(sql, null, {
          multipleStatements: 1
        })));

        let warningRows = _.reduce(result, (sum, row) => {
          sum += row.warningStatus;
          return sum;
        }, 0);

        if (warningRows > 0) {
          this.app.log('warn', `${warningRows} warning(s) reported while running "${file}".`);
        } else {
          this.app.log('info', `Database scripts "${sqlFile}" run successfully.`);
        }
      }
    });
  }

  async load_(dataFile, ignoreDuplicate) {
    let ext = path.extname(dataFile);
    this.app.log('verbose', `Loading data file "${dataFile}" ...`);

    if (ext === '.json') {
      let data = fs.readJsonSync(dataFile, {
        encoding: 'utf8'
      });

      if (Array.isArray(data)) {
        let entityName = path.basename(dataFile, ext);
        await this._loadSingleEntityRecords_(entityName, data, ignoreDuplicate);
      } else {
        await this._loadMultiEntityRecords_(data, ignoreDuplicate);
      }

      this.app.log('info', `Loaded JSON data file: ${dataFile}`);
    } else if (ext === '.sql') {
      let sql = fs.readFileSync(dataFile, {
        encoding: 'utf8'
      });
      let result = await this.db.connector.execute_(sql, null, {
        multipleStatements: 1
      });
      this.app.log('info', `Executed SQL file: ${dataFile}`, result);
    } else if (ext === '.xlsx') {
      const Excel = require('exceljs');

      let workbook = new Excel.Workbook();
      await workbook.xlsx.readFile(dataFile);
      let data = {};
      workbook.eachSheet((worksheet, sheetId) => {
        let colKeys;
        let entityName = worksheet.name;
        let entityData = [];
        data[entityName] = entityData;
        worksheet.eachRow(function (row, rowNumber) {
          if (!colKeys) {
            colKeys = _.drop(row.values);
          } else {
            let record = _.fromPairs(_.zip(colKeys, _.drop(row.values)));

            entityData.push(record);
          }
        });
      });
      await this._loadMultiEntityRecords_(data);
      this.app.log('info', `Imported excel data file: ${dataFile}`);
    } else if (ext === '.js') {
      let executor = require(dataFile);

      await executor(this.app, this.db.connector);
      this.app.log('info', `Ran data script: ${dataFile}`);
    } else {
      throw new Error('Unsupported data file format.');
    }
  }

  async export_(entitiesToExport, outputDir) {
    fs.ensureDirSync(outputDir);
    const items = [];
    await eachAsync_(entitiesToExport, async (exportConfig, entityName) => {
      this.app.log('verbose', 'Exporting data of entity: ' + entityName);
      const Entity = this.db.model(entityName);
      const data = await Entity.findAll_(exportConfig.dataset);

      _.forOwn(exportConfig.rules, (enabled, name) => {
        if (enabled) {
          const processRule = require(`./rules/${name}.js`);

          data.forEach(entity => processRule(this.db, Entity, entity));
        }
      });

      const baseFileName = `${Entity.meta.name}.json`;
      items.push(baseFileName);
      const dataFile = path.join(outputDir, baseFileName);
      fs.writeJsonSync(dataFile, {
        [Entity.meta.name]: data
      }, {
        spaces: 4
      });
      this.app.log('info', 'Generated entity data file: ' + dataFile);
    });
    const indexFile = path.join(outputDir, 'index.list');
    fs.writeFileSync(indexFile, items.join('\n'), 'utf8');
    this.app.log('info', 'Generated data files list: ' + indexFile);
  }

  async _loadMultiEntityRecords_(data, ignoreDuplicate) {
    try {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, async (records, entityName) => {
        let items = Array.isArray(records) ? records : [records];
        return this._loadRecordsByModel_(entityName, items, ignoreDuplicate);
      });
    } catch (error) {
      throw error;
    } finally {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    }
  }

  async _loadSingleEntityRecords_(entityName, data, ignoreDuplicate) {
    try {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await this._loadRecordsByModel_(entityName, data, ignoreDuplicate);
    } catch (error) {
      throw error;
    } finally {
      await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    }
  }

  async _loadRecordsByModel_(entityName, items, ignoreDuplicate) {
    const connOptions = {};

    if (ignoreDuplicate) {
      connOptions.insertIgnore = true;
    }

    const Entity = this.db.model(entityName);
    return eachAsync_(items, async ({
      $skipModifiers,
      ...item
    }) => {
      const opts = {
        $migration: true,
        $skipModifiers,
        $retrieveDbResult: true
      };
      const processed = await Entity.create_(item, opts, connOptions);

      if (opts.$result.affectedRows === 0) {
        const key = Entity.getUniqueKeyValuePairsFrom(processed);
        this.app.log('info', `Duplicate record ${JSON.stringify(key)} is ignored.`);
      }
    });
  }

}

module.exports = MySQLMigration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWdyYXRpb24vbXlzcWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwicXVvdGUiLCJNeVNRTE1pZ3JhdGlvbiIsImNvbnN0cnVjdG9yIiwiYXBwIiwiY29udGV4dCIsImRiIiwibW9kZWxQYXRoIiwic2NyaXB0UGF0aCIsImRiU2NyaXB0UGF0aCIsImpvaW4iLCJkcml2ZXIiLCJjb25uZWN0b3IiLCJkYXRhYmFzZSIsInJlc2V0XyIsImV4ZWN1dGVfIiwiY3JlYXRlRGF0YWJhc2UiLCJjcmVhdGVfIiwiZXh0cmFPcHRpb25zIiwic3FsRmlsZXMiLCJzcWxDcmVhdGUiLCJpc0VtcHR5IiwicmVkdWNlIiwiciIsInYiLCJrIiwidXBwZXJDYXNlIiwidG9TdHJpbmciLCJyZXN1bHQiLCJ3YXJuaW5nU3RhdHVzIiwibG9nIiwiZmlsZSIsInNxbEZpbGUiLCJleGlzdHNTeW5jIiwiRXJyb3IiLCJzcWwiLCJ0cmltIiwicmVhZEZpbGVTeW5jIiwiZW5jb2RpbmciLCJjYXN0QXJyYXkiLCJtdWx0aXBsZVN0YXRlbWVudHMiLCJ3YXJuaW5nUm93cyIsInN1bSIsInJvdyIsImxvYWRfIiwiZGF0YUZpbGUiLCJpZ25vcmVEdXBsaWNhdGUiLCJleHQiLCJleHRuYW1lIiwiZGF0YSIsInJlYWRKc29uU3luYyIsIkFycmF5IiwiaXNBcnJheSIsImVudGl0eU5hbWUiLCJiYXNlbmFtZSIsIl9sb2FkU2luZ2xlRW50aXR5UmVjb3Jkc18iLCJfbG9hZE11bHRpRW50aXR5UmVjb3Jkc18iLCJFeGNlbCIsIndvcmtib29rIiwiV29ya2Jvb2siLCJ4bHN4IiwicmVhZEZpbGUiLCJlYWNoU2hlZXQiLCJ3b3Jrc2hlZXQiLCJzaGVldElkIiwiY29sS2V5cyIsIm5hbWUiLCJlbnRpdHlEYXRhIiwiZWFjaFJvdyIsInJvd051bWJlciIsImRyb3AiLCJ2YWx1ZXMiLCJyZWNvcmQiLCJmcm9tUGFpcnMiLCJ6aXAiLCJwdXNoIiwiZXhlY3V0b3IiLCJleHBvcnRfIiwiZW50aXRpZXNUb0V4cG9ydCIsIm91dHB1dERpciIsImVuc3VyZURpclN5bmMiLCJpdGVtcyIsImV4cG9ydENvbmZpZyIsIkVudGl0eSIsIm1vZGVsIiwiZmluZEFsbF8iLCJkYXRhc2V0IiwiZm9yT3duIiwicnVsZXMiLCJlbmFibGVkIiwicHJvY2Vzc1J1bGUiLCJmb3JFYWNoIiwiZW50aXR5IiwiYmFzZUZpbGVOYW1lIiwibWV0YSIsIndyaXRlSnNvblN5bmMiLCJzcGFjZXMiLCJpbmRleEZpbGUiLCJ3cml0ZUZpbGVTeW5jIiwicmVjb3JkcyIsIl9sb2FkUmVjb3Jkc0J5TW9kZWxfIiwiZXJyb3IiLCJjb25uT3B0aW9ucyIsImluc2VydElnbm9yZSIsIiRza2lwTW9kaWZpZXJzIiwiaXRlbSIsIm9wdHMiLCIkbWlncmF0aW9uIiwiJHJldHJpZXZlRGJSZXN1bHQiLCJwcm9jZXNzZWQiLCIkcmVzdWx0IiwiYWZmZWN0ZWRSb3dzIiwia2V5IiwiZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20iLCJKU09OIiwic3RyaW5naWZ5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLFVBQVQ7QUFBc0JDLEVBQUFBO0FBQXRCLElBQWdDSixPQUFPLENBQUMsVUFBRCxDQUE3Qzs7QUFNQSxNQUFNSyxjQUFOLENBQXFCO0FBTWpCQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBTUMsT0FBTixFQUFlQyxFQUFmLEVBQW1CO0FBQzFCLFNBQUtGLEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtHLFNBQUwsR0FBaUJGLE9BQU8sQ0FBQ0UsU0FBekI7QUFDQSxTQUFLQyxVQUFMLEdBQWtCSCxPQUFPLENBQUNHLFVBQTFCO0FBQ0EsU0FBS0YsRUFBTCxHQUFVQSxFQUFW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Y0FBN0Q7QUFDSDtBQUNKLEtBUGdCLENBQWpCO0FBUUg7O0FBMU1nQjs7QUE2TXJCSSxNQUFNLENBQUNDLE9BQVAsR0FBaUJuSCxjQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcywgZWFjaEFzeW5jXywgIHF1b3RlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG4vKipcbiAqIE15U1FMIG1pZ3JhdGlvbi5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBNeVNRTE1pZ3JhdGlvbiB7XG4gICAgLyoqIFxuICAgICAqIEBwYXJhbSB7U2VydmljZUNvbnRhaW5lcn0gYXBwICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHBhcmFtIHtEYn0gZGJcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihhcHAsIGNvbnRleHQsIGRiKSB7XG4gICAgICAgIHRoaXMuYXBwID0gYXBwOyAgICAgICAgXG4gICAgICAgIHRoaXMubW9kZWxQYXRoID0gY29udGV4dC5tb2RlbFBhdGg7XG4gICAgICAgIHRoaXMuc2NyaXB0UGF0aCA9IGNvbnRleHQuc2NyaXB0UGF0aDsgICAgICAgIFxuICAgICAgICB0aGlzLmRiID0gZGI7XG5cbiAgICAgICAgdGhpcy5kYlNjcmlwdFBhdGggPSBwYXRoLmpvaW4odGhpcy5zY3JpcHRQYXRoLCB0aGlzLmRiLmRyaXZlciwgdGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2V0XygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKGBEUk9QIERBVEFCQVNFIElGIEVYSVNUUyA/P2AsIFsgdGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2UgXSwgeyBjcmVhdGVEYXRhYmFzZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjcmVhdGVfKGV4dHJhT3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGxldCBzcWxGaWxlcyA9IFsgJ2VudGl0aWVzLnNxbCcsICdyZWxhdGlvbnMuc3FsJywgJ3Byb2NlZHVyZXMuc3FsJyBdO1xuXG4gICAgICAgIGxldCBzcWxDcmVhdGUgPSAnQ1JFQVRFIERBVEFCQVNFIElGIE5PVCBFWElTVFMgPz8nO1xuXG4gICAgICAgIGlmIChleHRyYU9wdGlvbnMgJiYgIV8uaXNFbXB0eShleHRyYU9wdGlvbnMuZGIpKSB7XG4gICAgICAgICAgICBzcWxDcmVhdGUgKz0gJyAnICsgXy5yZWR1Y2UoZXh0cmFPcHRpb25zLmRiLCAociwgdiwgaykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByICsgJyAnICsgXy51cHBlckNhc2UoaykgKyAnICcgKyBxdW90ZSh2LnRvU3RyaW5nKCksICdcIicpO1xuICAgICAgICAgICAgfSwgJycpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuZXhlY3V0ZV8oc3FsQ3JlYXRlLCBcbiAgICAgICAgICAgIFsgdGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2UgXSwgXG4gICAgICAgICAgICB7IGNyZWF0ZURhdGFiYXNlOiB0cnVlIH1cbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChyZXN1bHQud2FybmluZ1N0YXR1cyA9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgQ3JlYXRlZCBkYXRhYmFzZSBcIiR7dGhpcy5kYi5jb25uZWN0b3IuZGF0YWJhc2V9XCIuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ3dhcm4nLCBgRGF0YWJhc2UgXCIke3RoaXMuZGIuY29ubmVjdG9yLmRhdGFiYXNlfVwiIGV4aXN0cy5gKTtcbiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIHJldHVybiBlYWNoQXN5bmNfKHNxbEZpbGVzLCBhc3luYyAoZmlsZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHNxbEZpbGUgPSBwYXRoLmpvaW4odGhpcy5kYlNjcmlwdFBhdGgsIGZpbGUpO1xuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHNxbEZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEYXRhYmFzZSBzY3JpcHQgXCIke3NxbEZpbGV9XCIgbm90IGZvdW5kLiBUcnkgcnVuIFwib29sb25nIGJ1aWxkXCIgZmlyc3QuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBzcWwgPSBfLnRyaW0oZnMucmVhZEZpbGVTeW5jKHNxbEZpbGUsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSk7XG4gICAgICAgICAgICBpZiAoc3FsKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXy5jYXN0QXJyYXkoYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuZXhlY3V0ZV8oc3FsLCBudWxsLCB7IG11bHRpcGxlU3RhdGVtZW50czogMSB9KSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgd2FybmluZ1Jvd3MgPSBfLnJlZHVjZShyZXN1bHQsIChzdW0sIHJvdykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzdW0gKz0gcm93Lndhcm5pbmdTdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzdW07XG4gICAgICAgICAgICAgICAgfSwgMCk7XG5cbiAgICAgICAgICAgICAgICBpZiAod2FybmluZ1Jvd3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnd2FybicsIGAke3dhcm5pbmdSb3dzfSB3YXJuaW5nKHMpIHJlcG9ydGVkIHdoaWxlIHJ1bm5pbmcgXCIke2ZpbGV9XCIuYCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYERhdGFiYXNlIHNjcmlwdHMgXCIke3NxbEZpbGV9XCIgcnVuIHN1Y2Nlc3NmdWxseS5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRfKGRhdGFGaWxlLCBpZ25vcmVEdXBsaWNhdGUpIHtcbiAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShkYXRhRmlsZSk7XG4gICAgICAgIHRoaXMuYXBwLmxvZygndmVyYm9zZScsIGBMb2FkaW5nIGRhdGEgZmlsZSBcIiR7ZGF0YUZpbGV9XCIgLi4uYCk7XG5cbiAgICAgICAgaWYgKGV4dCA9PT0gJy5qc29uJykge1xuICAgICAgICAgICAgbGV0IGRhdGEgPSBmcy5yZWFkSnNvblN5bmMoZGF0YUZpbGUsIHtlbmNvZGluZzogJ3V0ZjgnfSk7XG5cbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBwYXRoLmJhc2VuYW1lKGRhdGFGaWxlLCBleHQpO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRTaW5nbGVFbnRpdHlSZWNvcmRzXyhlbnRpdHlOYW1lLCBkYXRhLCBpZ25vcmVEdXBsaWNhdGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkTXVsdGlFbnRpdHlSZWNvcmRzXyhkYXRhLCBpZ25vcmVEdXBsaWNhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYExvYWRlZCBKU09OIGRhdGEgZmlsZTogJHtkYXRhRmlsZX1gKTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcuc3FsJykge1xuICAgICAgICAgICAgbGV0IHNxbCA9IGZzLnJlYWRGaWxlU3luYyhkYXRhRmlsZSwge2VuY29kaW5nOiAndXRmOCd9KTtcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5leGVjdXRlXyhzcWwsIG51bGwsIHsgbXVsdGlwbGVTdGF0ZW1lbnRzOiAxIH0pO1xuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYEV4ZWN1dGVkIFNRTCBmaWxlOiAke2RhdGFGaWxlfWAsIHJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXh0ID09PSAnLnhsc3gnKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IEV4Y2VsID0gcmVxdWlyZSgnZXhjZWxqcycpO1xuICAgICAgICAgICAgbGV0IHdvcmtib29rID0gbmV3IEV4Y2VsLldvcmtib29rKCk7XG4gICAgICAgICAgICBhd2FpdCB3b3JrYm9vay54bHN4LnJlYWRGaWxlKGRhdGFGaWxlKTsgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZGF0YSA9IHt9O1xuXG4gICAgICAgICAgICB3b3JrYm9vay5lYWNoU2hlZXQoKHdvcmtzaGVldCwgc2hlZXRJZCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb2xLZXlzO1xuXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSB3b3Jrc2hlZXQubmFtZTtcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5RGF0YSA9IFtdO1xuICAgICAgICAgICAgICAgIGRhdGFbZW50aXR5TmFtZV0gPSBlbnRpdHlEYXRhO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHdvcmtzaGVldC5lYWNoUm93KGZ1bmN0aW9uKHJvdywgcm93TnVtYmVyKSB7ICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb2xLZXlzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xLZXlzID0gXy5kcm9wKHJvdy52YWx1ZXMpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZWNvcmQgPSBfLmZyb21QYWlycyhfLnppcChjb2xLZXlzLCBfLmRyb3Aocm93LnZhbHVlcykpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eURhdGEucHVzaChyZWNvcmQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZE11bHRpRW50aXR5UmVjb3Jkc18oZGF0YSk7XG5cbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBJbXBvcnRlZCBleGNlbCBkYXRhIGZpbGU6ICR7ZGF0YUZpbGV9YCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXh0ID09PSAnLmpzJykgeyAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZXhlY3V0b3IgPSByZXF1aXJlKGRhdGFGaWxlKTtcbiAgICAgICAgICAgIGF3YWl0IGV4ZWN1dG9yKHRoaXMuYXBwLCB0aGlzLmRiLmNvbm5lY3Rvcik7XG5cbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBSYW4gZGF0YSBzY3JpcHQ6ICR7ZGF0YUZpbGV9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIGRhdGEgZmlsZSBmb3JtYXQuJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBleHBvcnRfKGVudGl0aWVzVG9FeHBvcnQsIG91dHB1dERpcikge1xuICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKG91dHB1dERpcik7XG5cbiAgICAgICAgY29uc3QgaXRlbXMgPSBbXTtcblxuICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKGVudGl0aWVzVG9FeHBvcnQsIGFzeW5jIChleHBvcnRDb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygndmVyYm9zZScsICdFeHBvcnRpbmcgZGF0YSBvZiBlbnRpdHk6ICcgKyBlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgY29uc3QgRW50aXR5ID0gdGhpcy5kYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBFbnRpdHkuZmluZEFsbF8oZXhwb3J0Q29uZmlnLmRhdGFzZXQpO1xuXG4gICAgICAgICAgICBfLmZvck93bihleHBvcnRDb25maWcucnVsZXMsIChlbmFibGVkLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1J1bGUgPSByZXF1aXJlKGAuL3J1bGVzLyR7bmFtZX0uanNgKTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5mb3JFYWNoKGVudGl0eSA9PiBwcm9jZXNzUnVsZSh0aGlzLmRiLCBFbnRpdHksIGVudGl0eSkpO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGJhc2VGaWxlTmFtZSA9IGAke0VudGl0eS5tZXRhLm5hbWV9Lmpzb25gO1xuICAgICAgICAgICAgaXRlbXMucHVzaChiYXNlRmlsZU5hbWUpO1xuXG4gICAgICAgICAgICBjb25zdCBkYXRhRmlsZSA9IHBhdGguam9pbihvdXRwdXREaXIsIGJhc2VGaWxlTmFtZSk7XG5cbiAgICAgICAgICAgIGZzLndyaXRlSnNvblN5bmMoZGF0YUZpbGUsIHtcbiAgICAgICAgICAgICAgICBbRW50aXR5Lm1ldGEubmFtZV06IGRhdGFcbiAgICAgICAgICAgIH0sIHsgc3BhY2VzOiA0IH0pO1xuXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIGVudGl0eSBkYXRhIGZpbGU6ICcgKyBkYXRhRmlsZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGluZGV4RmlsZSA9IHBhdGguam9pbihvdXRwdXREaXIsICdpbmRleC5saXN0Jyk7XG5cbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhpbmRleEZpbGUsIGl0ZW1zLmpvaW4oJ1xcbicpLCAndXRmOCcpO1xuICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIGRhdGEgZmlsZXMgbGlzdDogJyArIGluZGV4RmlsZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWRNdWx0aUVudGl0eVJlY29yZHNfKGRhdGEsIGlnbm9yZUR1cGxpY2F0ZSkgeyAgICAgICAgXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTA7Jyk7XG5cbiAgICAgICAgICAgIGF3YWl0IGVhY2hBc3luY18oZGF0YSwgYXN5bmMgKHJlY29yZHMsIGVudGl0eU5hbWUpID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW1zID0gQXJyYXkuaXNBcnJheShyZWNvcmRzKSA/IHJlY29yZHMgOiBbIHJlY29yZHMgXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9hZFJlY29yZHNCeU1vZGVsXyhlbnRpdHlOYW1lLCBpdGVtcywgaWdub3JlRHVwbGljYXRlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5leGVjdXRlXygnU0VUIEZPUkVJR05fS0VZX0NIRUNLUz0xOycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWRTaW5nbGVFbnRpdHlSZWNvcmRzXyhlbnRpdHlOYW1lLCBkYXRhLCBpZ25vcmVEdXBsaWNhdGUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTA7Jyk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRSZWNvcmRzQnlNb2RlbF8oZW50aXR5TmFtZSwgZGF0YSwgaWdub3JlRHVwbGljYXRlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuZXhlY3V0ZV8oJ1NFVCBGT1JFSUdOX0tFWV9DSEVDS1M9MTsnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkUmVjb3Jkc0J5TW9kZWxfKGVudGl0eU5hbWUsIGl0ZW1zLCBpZ25vcmVEdXBsaWNhdGUpIHtcbiAgICAgICAgY29uc3QgY29ubk9wdGlvbnMgPSB7fTtcbiAgICAgICAgaWYgKGlnbm9yZUR1cGxpY2F0ZSkge1xuICAgICAgICAgICAgY29ubk9wdGlvbnMuaW5zZXJ0SWdub3JlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IEVudGl0eSA9IHRoaXMuZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oaXRlbXMsIGFzeW5jICh7ICRza2lwTW9kaWZpZXJzLCAuLi5pdGVtIH0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7ICRtaWdyYXRpb246IHRydWUsICRza2lwTW9kaWZpZXJzLCAkcmV0cmlldmVEYlJlc3VsdDogdHJ1ZSB9O1xuICAgICAgICAgICAgY29uc3QgcHJvY2Vzc2VkID0gYXdhaXQgRW50aXR5LmNyZWF0ZV8oaXRlbSwgb3B0cywgY29ubk9wdGlvbnMpO1xuICAgICAgICAgICAgaWYgKG9wdHMuJHJlc3VsdC5hZmZlY3RlZFJvd3MgPT09IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBFbnRpdHkuZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20ocHJvY2Vzc2VkKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgRHVwbGljYXRlIHJlY29yZCAke0pTT04uc3RyaW5naWZ5KGtleSl9IGlzIGlnbm9yZWQuYCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgXG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMTWlncmF0aW9uOyJdfQ==
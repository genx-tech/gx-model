"use strict";

require("source-map-support/register");

const {
  auto
} = require("async");

const {
  _
} = require('rk-utils');

function applyRule(db, Entity, entity) {
  const associations = Entity.meta.associations;
  associations && _.forOwn(associations, (assoc, anchor) => {
    const key = ':' + anchor;
    const subEntity = entity[key];

    if (subEntity) {
      if (assoc.list) {
        const SubEntity = db.model(assoc.entity);
        subEntity.forEach(item => applyRule(db, SubEntity, item));
      } else {
        const SubEntity = db.model(assoc.entity);
        applyRule(db, SubEntity, subEntity);
        delete entity[anchor];
      }
    }
  });
  const autoId = Entity.meta.features.autoId;

  if (autoId) {
    delete entity[autoId.field];
  }
}

;
module.exports = applyRule;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9taWdyYXRpb24vcnVsZXMvb21pdEF1dG9JZC5qcyJdLCJuYW1lcyI6WyJhdXRvIiwicmVxdWlyZSIsIl8iLCJhcHBseVJ1bGUiLCJkYiIsIkVudGl0eSIsImVudGl0eSIsImFzc29jaWF0aW9ucyIsIm1ldGEiLCJmb3JPd24iLCJhc3NvYyIsImFuY2hvciIsImtleSIsInN1YkVudGl0eSIsImxpc3QiLCJTdWJFbnRpdHkiLCJtb2RlbCIsImZvckVhY2giLCJpdGVtIiwiYXV0b0lkIiwiZmVhdHVyZXMiLCJmaWVsZCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBV0MsT0FBTyxDQUFDLE9BQUQsQ0FBeEI7O0FBRUEsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUVBLFNBQVNFLFNBQVQsQ0FBbUJDLEVBQW5CLEVBQXVCQyxNQUF2QixFQUErQkMsTUFBL0IsRUFBdUM7QUFDbkMsUUFBTUMsWUFBWSxHQUFHRixNQUFNLENBQUNHLElBQVAsQ0FBWUQsWUFBakM7QUFDQUEsRUFBQUEsWUFBWSxJQUFJTCxDQUFDLENBQUNPLE1BQUYsQ0FBU0YsWUFBVCxFQUF1QixDQUFDRyxLQUFELEVBQVFDLE1BQVIsS0FBbUI7QUFDdEQsVUFBTUMsR0FBRyxHQUFHLE1BQU1ELE1BQWxCO0FBRUEsVUFBTUUsU0FBUyxHQUFHUCxNQUFNLENBQUNNLEdBQUQsQ0FBeEI7O0FBQ0EsUUFBSUMsU0FBSixFQUFlO0FBQ1gsVUFBSUgsS0FBSyxDQUFDSSxJQUFWLEVBQWdCO0FBRVosY0FBTUMsU0FBUyxHQUFHWCxFQUFFLENBQUNZLEtBQUgsQ0FBU04sS0FBSyxDQUFDSixNQUFmLENBQWxCO0FBQ0FPLFFBQUFBLFNBQVMsQ0FBQ0ksT0FBVixDQUFrQkMsSUFBSSxJQUFJZixTQUFTLENBQUNDLEVBQUQsRUFBS1csU0FBTCxFQUFnQkcsSUFBaEIsQ0FBbkM7QUFDSCxPQUpELE1BSU87QUFFSCxjQUFNSCxTQUFTLEdBQUdYLEVBQUUsQ0FBQ1ksS0FBSCxDQUFTTixLQUFLLENBQUNKLE1BQWYsQ0FBbEI7QUFDQUgsUUFBQUEsU0FBUyxDQUFDQyxFQUFELEVBQUtXLFNBQUwsRUFBZ0JGLFNBQWhCLENBQVQ7QUFFQSxlQUFPUCxNQUFNLENBQUNLLE1BQUQsQ0FBYjtBQUNIO0FBQ0o7QUFDSixHQWpCZSxDQUFoQjtBQW1CQSxRQUFNUSxNQUFNLEdBQUdkLE1BQU0sQ0FBQ0csSUFBUCxDQUFZWSxRQUFaLENBQXFCRCxNQUFwQzs7QUFFQSxNQUFJQSxNQUFKLEVBQVk7QUFDUixXQUFPYixNQUFNLENBQUNhLE1BQU0sQ0FBQ0UsS0FBUixDQUFiO0FBQ0g7QUFDSjs7QUFBQTtBQUVEQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJwQixTQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgYXV0byB9ID0gcmVxdWlyZShcImFzeW5jXCIpO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbmZ1bmN0aW9uIGFwcGx5UnVsZShkYiwgRW50aXR5LCBlbnRpdHkpIHtcbiAgICBjb25zdCBhc3NvY2lhdGlvbnMgPSBFbnRpdHkubWV0YS5hc3NvY2lhdGlvbnM7XG4gICAgYXNzb2NpYXRpb25zICYmIF8uZm9yT3duKGFzc29jaWF0aW9ucywgKGFzc29jLCBhbmNob3IpID0+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gJzonICsgYW5jaG9yO1xuXG4gICAgICAgIGNvbnN0IHN1YkVudGl0eSA9IGVudGl0eVtrZXldO1xuICAgICAgICBpZiAoc3ViRW50aXR5KSB7XG4gICAgICAgICAgICBpZiAoYXNzb2MubGlzdCkge1xuICAgICAgICAgICAgICAgIC8vYXJyYXkgb2Ygb2JqZWN0c1xuICAgICAgICAgICAgICAgIGNvbnN0IFN1YkVudGl0eSA9IGRiLm1vZGVsKGFzc29jLmVudGl0eSk7XG4gICAgICAgICAgICAgICAgc3ViRW50aXR5LmZvckVhY2goaXRlbSA9PiBhcHBseVJ1bGUoZGIsIFN1YkVudGl0eSwgaXRlbSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvL29iamVjdFxuICAgICAgICAgICAgICAgIGNvbnN0IFN1YkVudGl0eSA9IGRiLm1vZGVsKGFzc29jLmVudGl0eSk7XG4gICAgICAgICAgICAgICAgYXBwbHlSdWxlKGRiLCBTdWJFbnRpdHksIHN1YkVudGl0eSk7XG5cbiAgICAgICAgICAgICAgICBkZWxldGUgZW50aXR5W2FuY2hvcl07XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0gXG4gICAgfSk7XG5cbiAgICBjb25zdCBhdXRvSWQgPSBFbnRpdHkubWV0YS5mZWF0dXJlcy5hdXRvSWQ7XG5cbiAgICBpZiAoYXV0b0lkKSB7XG4gICAgICAgIGRlbGV0ZSBlbnRpdHlbYXV0b0lkLmZpZWxkXTtcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IGFwcGx5UnVsZTsiXX0=
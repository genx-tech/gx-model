"use strict";

require("source-map-support/register");

const {
  auto
} = require("async");

const {
  _
} = require('rk-utils');

function applyRule(db, Entity, entity) {
  const associations = Entity.meta.associations;
  associations && _.forOwn(associations, (assoc, anchor) => {
    const key = ':' + anchor;
    const subEntity = entity[key];

    if (subEntity) {
      if (assoc.list) {
        const SubEntity = db.model(assoc.entity);
        subEntity.forEach(item => {
          delete item[assoc.field];
          applyRule(db, SubEntity, item);
        });
      }
    }
  });
}

;
module.exports = applyRule;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9taWdyYXRpb24vcnVsZXMvZGVmYXVsdC5qcyJdLCJuYW1lcyI6WyJhdXRvIiwicmVxdWlyZSIsIl8iLCJhcHBseVJ1bGUiLCJkYiIsIkVudGl0eSIsImVudGl0eSIsImFzc29jaWF0aW9ucyIsIm1ldGEiLCJmb3JPd24iLCJhc3NvYyIsImFuY2hvciIsImtleSIsInN1YkVudGl0eSIsImxpc3QiLCJTdWJFbnRpdHkiLCJtb2RlbCIsImZvckVhY2giLCJpdGVtIiwiZmllbGQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVdDLE9BQU8sQ0FBQyxPQUFELENBQXhCOztBQUVBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFRRCxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFFQSxTQUFTRSxTQUFULENBQW1CQyxFQUFuQixFQUF1QkMsTUFBdkIsRUFBK0JDLE1BQS9CLEVBQXVDO0FBR25DLFFBQU1DLFlBQVksR0FBR0YsTUFBTSxDQUFDRyxJQUFQLENBQVlELFlBQWpDO0FBQ0FBLEVBQUFBLFlBQVksSUFBSUwsQ0FBQyxDQUFDTyxNQUFGLENBQVNGLFlBQVQsRUFBdUIsQ0FBQ0csS0FBRCxFQUFRQyxNQUFSLEtBQW1CO0FBQ3RELFVBQU1DLEdBQUcsR0FBRyxNQUFNRCxNQUFsQjtBQUVBLFVBQU1FLFNBQVMsR0FBR1AsTUFBTSxDQUFDTSxHQUFELENBQXhCOztBQUNBLFFBQUlDLFNBQUosRUFBZTtBQUNYLFVBQUlILEtBQUssQ0FBQ0ksSUFBVixFQUFnQjtBQUVaLGNBQU1DLFNBQVMsR0FBR1gsRUFBRSxDQUFDWSxLQUFILENBQVNOLEtBQUssQ0FBQ0osTUFBZixDQUFsQjtBQUNBTyxRQUFBQSxTQUFTLENBQUNJLE9BQVYsQ0FBa0JDLElBQUksSUFBSTtBQUN0QixpQkFBT0EsSUFBSSxDQUFDUixLQUFLLENBQUNTLEtBQVAsQ0FBWDtBQUNBaEIsVUFBQUEsU0FBUyxDQUFDQyxFQUFELEVBQUtXLFNBQUwsRUFBZ0JHLElBQWhCLENBQVQ7QUFDSCxTQUhEO0FBSUg7QUFDSjtBQUNKLEdBZGUsQ0FBaEI7QUFlSDs7QUFBQTtBQUVERSxNQUFNLENBQUNDLE9BQVAsR0FBaUJsQixTQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgYXV0byB9ID0gcmVxdWlyZShcImFzeW5jXCIpO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbmZ1bmN0aW9uIGFwcGx5UnVsZShkYiwgRW50aXR5LCBlbnRpdHkpIHtcbiAgICAvL3JlbW92ZSBiYWNrIHJlZmVyZW5jZVxuXG4gICAgY29uc3QgYXNzb2NpYXRpb25zID0gRW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zO1xuICAgIGFzc29jaWF0aW9ucyAmJiBfLmZvck93bihhc3NvY2lhdGlvbnMsIChhc3NvYywgYW5jaG9yKSA9PiB7XG4gICAgICAgIGNvbnN0IGtleSA9ICc6JyArIGFuY2hvcjtcblxuICAgICAgICBjb25zdCBzdWJFbnRpdHkgPSBlbnRpdHlba2V5XTtcbiAgICAgICAgaWYgKHN1YkVudGl0eSkge1xuICAgICAgICAgICAgaWYgKGFzc29jLmxpc3QpIHtcbiAgICAgICAgICAgICAgICAvL2FycmF5IG9mIG9iamVjdHNcbiAgICAgICAgICAgICAgICBjb25zdCBTdWJFbnRpdHkgPSBkYi5tb2RlbChhc3NvYy5lbnRpdHkpO1xuICAgICAgICAgICAgICAgIHN1YkVudGl0eS5mb3JFYWNoKGl0ZW0gPT4geyBcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGl0ZW1bYXNzb2MuZmllbGRdO1xuICAgICAgICAgICAgICAgICAgICBhcHBseVJ1bGUoZGIsIFN1YkVudGl0eSwgaXRlbSk7IFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBcbiAgICAgICAgfSBcbiAgICB9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gYXBwbHlSdWxlOyJdfQ==
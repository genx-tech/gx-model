"use strict";

require("source-map-support/register");

const {
  auto
} = require("async");

const {
  _
} = require('rk-utils');

function applyRule(db, Entity, entity) {
  const associations = Entity.meta.associations;
  associations && _.forOwn(associations, (assoc, anchor) => {
    const key = ':' + anchor;
    const subEntity = entity[key];

    if (subEntity) {
      if (assoc.list) {
        const SubEntity = db.model(assoc.entity);
        subEntity.forEach(item => applyRule(db, SubEntity, item));
      } else {
        const SubEntity = db.model(assoc.entity);
        applyRule(db, SubEntity, subEntity);
        delete entity[anchor];
      }
    }
  });
  const autoId = Entity.meta.features.autoId;

  if (autoId) {
    delete entity[autoId.field];
  }
}

;
module.exports = applyRule;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9taWdyYXRpb24vcnVsZXMvcmVtb3ZlQXV0b0lkLmpzIl0sIm5hbWVzIjpbImF1dG8iLCJyZXF1aXJlIiwiXyIsImFwcGx5UnVsZSIsImRiIiwiRW50aXR5IiwiZW50aXR5IiwiYXNzb2NpYXRpb25zIiwibWV0YSIsImZvck93biIsImFzc29jIiwiYW5jaG9yIiwia2V5Iiwic3ViRW50aXR5IiwibGlzdCIsIlN1YkVudGl0eSIsIm1vZGVsIiwiZm9yRWFjaCIsIml0ZW0iLCJhdXRvSWQiLCJmZWF0dXJlcyIsImZpZWxkIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFXQyxPQUFPLENBQUMsT0FBRCxDQUF4Qjs7QUFFQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUQsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBRUEsU0FBU0UsU0FBVCxDQUFtQkMsRUFBbkIsRUFBdUJDLE1BQXZCLEVBQStCQyxNQUEvQixFQUF1QztBQUNuQyxRQUFNQyxZQUFZLEdBQUdGLE1BQU0sQ0FBQ0csSUFBUCxDQUFZRCxZQUFqQztBQUNBQSxFQUFBQSxZQUFZLElBQUlMLENBQUMsQ0FBQ08sTUFBRixDQUFTRixZQUFULEVBQXVCLENBQUNHLEtBQUQsRUFBUUMsTUFBUixLQUFtQjtBQUN0RCxVQUFNQyxHQUFHLEdBQUcsTUFBTUQsTUFBbEI7QUFFQSxVQUFNRSxTQUFTLEdBQUdQLE1BQU0sQ0FBQ00sR0FBRCxDQUF4Qjs7QUFDQSxRQUFJQyxTQUFKLEVBQWU7QUFDWCxVQUFJSCxLQUFLLENBQUNJLElBQVYsRUFBZ0I7QUFFWixjQUFNQyxTQUFTLEdBQUdYLEVBQUUsQ0FBQ1ksS0FBSCxDQUFTTixLQUFLLENBQUNKLE1BQWYsQ0FBbEI7QUFDQU8sUUFBQUEsU0FBUyxDQUFDSSxPQUFWLENBQWtCQyxJQUFJLElBQUlmLFNBQVMsQ0FBQ0MsRUFBRCxFQUFLVyxTQUFMLEVBQWdCRyxJQUFoQixDQUFuQztBQUNILE9BSkQsTUFJTztBQUVILGNBQU1ILFNBQVMsR0FBR1gsRUFBRSxDQUFDWSxLQUFILENBQVNOLEtBQUssQ0FBQ0osTUFBZixDQUFsQjtBQUNBSCxRQUFBQSxTQUFTLENBQUNDLEVBQUQsRUFBS1csU0FBTCxFQUFnQkYsU0FBaEIsQ0FBVDtBQUVBLGVBQU9QLE1BQU0sQ0FBQ0ssTUFBRCxDQUFiO0FBQ0g7QUFDSjtBQUNKLEdBakJlLENBQWhCO0FBbUJBLFFBQU1RLE1BQU0sR0FBR2QsTUFBTSxDQUFDRyxJQUFQLENBQVlZLFFBQVosQ0FBcUJELE1BQXBDOztBQUVBLE1BQUlBLE1BQUosRUFBWTtBQUNSLFdBQU9iLE1BQU0sQ0FBQ2EsTUFBTSxDQUFDRSxLQUFSLENBQWI7QUFDSDtBQUNKOztBQUFBO0FBRURDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBCLFNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBhdXRvIH0gPSByZXF1aXJlKFwiYXN5bmNcIik7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuZnVuY3Rpb24gYXBwbHlSdWxlKGRiLCBFbnRpdHksIGVudGl0eSkge1xuICAgIGNvbnN0IGFzc29jaWF0aW9ucyA9IEVudGl0eS5tZXRhLmFzc29jaWF0aW9ucztcbiAgICBhc3NvY2lhdGlvbnMgJiYgXy5mb3JPd24oYXNzb2NpYXRpb25zLCAoYXNzb2MsIGFuY2hvcikgPT4ge1xuICAgICAgICBjb25zdCBrZXkgPSAnOicgKyBhbmNob3I7XG5cbiAgICAgICAgY29uc3Qgc3ViRW50aXR5ID0gZW50aXR5W2tleV07XG4gICAgICAgIGlmIChzdWJFbnRpdHkpIHtcbiAgICAgICAgICAgIGlmIChhc3NvYy5saXN0KSB7XG4gICAgICAgICAgICAgICAgLy9hcnJheSBvZiBvYmplY3RzXG4gICAgICAgICAgICAgICAgY29uc3QgU3ViRW50aXR5ID0gZGIubW9kZWwoYXNzb2MuZW50aXR5KTtcbiAgICAgICAgICAgICAgICBzdWJFbnRpdHkuZm9yRWFjaChpdGVtID0+IGFwcGx5UnVsZShkYiwgU3ViRW50aXR5LCBpdGVtKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vb2JqZWN0XG4gICAgICAgICAgICAgICAgY29uc3QgU3ViRW50aXR5ID0gZGIubW9kZWwoYXNzb2MuZW50aXR5KTtcbiAgICAgICAgICAgICAgICBhcHBseVJ1bGUoZGIsIFN1YkVudGl0eSwgc3ViRW50aXR5KTtcblxuICAgICAgICAgICAgICAgIGRlbGV0ZSBlbnRpdHlbYW5jaG9yXTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSBcbiAgICB9KTtcblxuICAgIGNvbnN0IGF1dG9JZCA9IEVudGl0eS5tZXRhLmZlYXR1cmVzLmF1dG9JZDtcblxuICAgIGlmIChhdXRvSWQpIHtcbiAgICAgICAgZGVsZXRlIGVudGl0eVthdXRvSWQuZmllbGRdO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gYXBwbHlSdWxlOyJdfQ==
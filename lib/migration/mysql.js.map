{"version":3,"sources":["../../src/migration/mysql.js"],"names":["path","require","_","eachAsync_","quote","fs","MySQLMigration","constructor","app","context","db","modelPath","scriptPath","dbScriptPath","join","driver","connector","database","reset_","execute_","createDatabase","create_","extraOptions","sqlFiles","sqlCreate","isEmpty","reduce","r","v","k","upperCase","toString","result","warningStatus","log","file","sqlFile","existsSync","Error","sql","trim","readFileSync","encoding","castArray","multipleStatements","warningRows","sum","row","load_","dataFile","ignoreDuplicate","ext","extname","data","readJsonSync","Array","isArray","entityName","basename","_loadSingleEntityRecords_","_loadMultiEntityRecords_","Excel","workbook","Workbook","xlsx","readFile","eachSheet","worksheet","sheetId","colKeys","name","entityData","eachRow","rowNumber","drop","values","record","fromPairs","zip","push","executor","writeIndexFile","outputDir","items","indexFile","writeFileSync","export_","entitiesToExport","skipIndexFile","ensureDirSync","exportConfig","dataFileName","Entity","model","findAll_","dataset","forOwn","rules","enabled","processRule","forEach","entity","baseFileName","writeJsonSync","meta","spaces","records","_loadRecordsByModel_","error","connOptions","insertIgnore","$skipModifiers","$update","item","opts","$migration","$retrieveDbResult","updateOne_","undefined","processed","$result","affectedRows","key","getUniqueKeyValuePairsFrom","JSON","stringify","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nconst path = require('path');\nconst { _, eachAsync_, quote } = require('@genx/july');\nconst { fs } = require('@genx/sys');\n\n/**\n * MySQL migration.\n * @class\n */\nclass MySQLMigration {\n    /** \n     * @param {ServiceContainer} app    \n     * @param {object} context\n     * @param {Db} db\n     */\n    constructor(app, context, db) {\n        this.app = app;        \n        this.modelPath = context.modelPath;\n        this.scriptPath = context.scriptPath;        \n        this.db = db;\n\n        this.dbScriptPath = path.join(this.scriptPath, this.db.driver, this.db.connector.database);\n    }\n\n    async reset_() {\n        return this.db.connector.execute_(`DROP DATABASE IF EXISTS ??`, [ this.db.connector.database ], { createDatabase: true });\n    }\n\n    async create_(extraOptions) {        \n        let sqlFiles = [ 'entities.sql', 'relations.sql', 'procedures.sql' ];\n\n        let sqlCreate = 'CREATE DATABASE IF NOT EXISTS ??';\n\n        if (extraOptions && !_.isEmpty(extraOptions.db)) {\n            sqlCreate += ' ' + _.reduce(extraOptions.db, (r, v, k) => {\n                return r + ' ' + _.upperCase(k) + ' ' + quote(v.toString(), '\"');\n            }, '');\n        }\n        \n        let result = await this.db.connector.execute_(sqlCreate, \n            [ this.db.connector.database ], \n            { createDatabase: true }\n        );\n        \n        if (result.warningStatus == 0) {\n            this.app.log('info', `Created database \"${this.db.connector.database}\".`);\n        } else {\n            this.app.log('warn', `Database \"${this.db.connector.database}\" exists.`);\n        }                        \n\n        return eachAsync_(sqlFiles, async (file) => {\n            let sqlFile = path.join(this.dbScriptPath, file);\n            if (!fs.existsSync(sqlFile)) {\n                throw new Error(`Database script \"${sqlFile}\" not found. Try run \"oolong build\" first.`);\n            }\n\n            let sql = _.trim(fs.readFileSync(sqlFile, { encoding: 'utf8' }));\n            if (sql) {\n                result = _.castArray(await this.db.connector.execute_(sql, null, { multipleStatements: 1 }));\n\n                let warningRows = _.reduce(result, (sum, row) => {\n                    sum += row.warningStatus;\n                    return sum;\n                }, 0);\n\n                if (warningRows > 0) {\n                    this.app.log('warn', `${warningRows} warning(s) reported while running \"${file}\".`);\n                } else {\n                    this.app.log('info', `Database scripts \"${sqlFile}\" run successfully.`);\n                }\n            }\n        });\n    }\n\n    async load_(dataFile, ignoreDuplicate) {\n        let ext = path.extname(dataFile);\n        this.app.log('verbose', `Loading data file \"${dataFile}\" ...`);\n\n        if (ext === '.json') {\n            let data = fs.readJsonSync(dataFile, {encoding: 'utf8'});\n\n            if (Array.isArray(data)) {\n                let entityName = path.basename(dataFile, ext);\n                await this._loadSingleEntityRecords_(entityName, data, ignoreDuplicate);\n            } else {\n                await this._loadMultiEntityRecords_(data, ignoreDuplicate);\n            }\n            this.app.log('info', `Loaded JSON data file: ${dataFile}`);\n        } else if (ext === '.sql') {\n            let sql = fs.readFileSync(dataFile, {encoding: 'utf8'});\n            let result = await this.db.connector.execute_(sql, null, { multipleStatements: 1 });\n            this.app.log('info', `Executed SQL file: ${dataFile}`, result);\n        } else if (ext === '.xlsx') {\n\n            const Excel = require('exceljs');\n            let workbook = new Excel.Workbook();\n            await workbook.xlsx.readFile(dataFile);     \n            \n            let data = {};\n\n            workbook.eachSheet((worksheet, sheetId) => {\n                let colKeys;\n\n                let entityName = worksheet.name;\n                let entityData = [];\n                data[entityName] = entityData;\n                \n                worksheet.eachRow(function(row, rowNumber) {                   \n                    \n                    if (!colKeys) {\n                        colKeys = _.drop(row.values);    \n                    } else {\n                        let record = _.fromPairs(_.zip(colKeys, _.drop(row.values)));\n                        entityData.push(record);\n                    }\n                });\n            });\n\n            await this._loadMultiEntityRecords_(data);\n\n            this.app.log('info', `Imported excel data file: ${dataFile}`);\n        } else if (ext === '.js') {           \n            let executor = require(dataFile);\n            await executor(this.app, this.db.connector);\n\n            this.app.log('info', `Ran data script: ${dataFile}`);\n        } else {\n            throw new Error('Unsupported data file format.');\n        }\n    }\n\n    writeIndexFile(outputDir, items) {\n        const indexFile = path.join(outputDir, 'index.list');\n\n        fs.writeFileSync(indexFile, items.join('\\n'), 'utf8');\n        this.app.log('info', 'Generated data files list: ' + indexFile);\n    }\n\n    async export_(entitiesToExport, outputDir, skipIndexFile) {\n        fs.ensureDirSync(outputDir);\n\n        const items = [];\n\n        await eachAsync_(entitiesToExport, async (exportConfig, dataFileName) => {\n            const entityName = exportConfig.entityName || dataFileName;\n            this.app.log('verbose', 'Exporting data of entity: ' + entityName);\n\n            const Entity = this.db.model(entityName);\n            const data = await Entity.findAll_(exportConfig.dataset);\n\n            _.forOwn(exportConfig.rules, (enabled, name) => {\n                if (enabled) {\n                    const processRule = require(`./rules/${name}.js`);\n                    data.forEach(entity => processRule(this.db, Entity, entity));\n                }                    \n            });\n\n            const baseFileName = `${dataFileName}.json`;\n            items.push(baseFileName);\n\n            const dataFile = path.join(outputDir, baseFileName);\n\n            fs.writeJsonSync(dataFile, {\n                [Entity.meta.name]: data\n            }, { spaces: 4 });\n\n            this.app.log('info', 'Generated entity data file: ' + dataFile);\n        });\n\n        if (!skipIndexFile) {\n            this.writeIndexFile(outputDir, items);\n        }\n        \n        return items;\n    }\n\n    async _loadMultiEntityRecords_(data, ignoreDuplicate) {        \n\n        try {\n            await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');\n\n            await eachAsync_(data, async (records, entityName) => {                \n                let items = Array.isArray(records) ? records : [ records ];\n                return this._loadRecordsByModel_(entityName, items, ignoreDuplicate);\n            });\n        } catch (error) {\n            throw error;\n        } finally {\n            await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');\n        }\n    }\n\n    async _loadSingleEntityRecords_(entityName, data, ignoreDuplicate) {\n        try {\n            await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');\n\n            await this._loadRecordsByModel_(entityName, data, ignoreDuplicate);\n        } catch (error) {\n            throw error;\n        } finally {\n            await this.db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');\n        }\n    }\n\n    async _loadRecordsByModel_(entityName, items, ignoreDuplicate) {\n        const connOptions = {};\n        if (ignoreDuplicate) {\n            connOptions.insertIgnore = true;\n        }\n\n        const Entity = this.db.model(entityName);\n\n        return eachAsync_(items, async ({ $skipModifiers, $update, ...item }) => {\n            const opts = { $migration: true, $skipModifiers, $retrieveDbResult: true };\n\n            if ($update) {\n                await Entity.updateOne_(item, undefined, connOptions);\n            } else {                \n                const processed = await Entity.create_(item, opts, connOptions);\n                if (opts.$result.affectedRows === 0) {\n                    const key = Entity.getUniqueKeyValuePairsFrom(processed);\n                    this.app.log('info', `Duplicate record ${JSON.stringify(key)} is ignored.`);\n                }       \n            }                 \n        });  \n    }\n}\n\nmodule.exports = MySQLMigration;"],"file":"mysql.js"}
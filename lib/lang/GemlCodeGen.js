"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _
} = Util;

const {
  generateDisplayName
} = require('./GemlUtils');

const {
  isNothing,
  isQuotedWith
} = require('../utils/lang');

const KW_NAMESPACE = 'import';
const KW_SCHEMA = 'schema';
const KW_ENTITIES = 'entities';
const KW_ENTITY_AS_ALIAS = 'as';
const KW_TYPE_DEFINE = 'type';
const KW_ENTITY = 'entity';
const KW_CODE = 'code';
const KW_COMMENT = '--';
const KW_WITH_FEATURE = 'with';
const KW_FIELDS = 'has';
const KW_ASSOCIATIONS = 'associations';
const KW_KEY = 'key';
const KW_INDEXES = 'index';

const {
  Types
} = require('@genx/data');

const GemlTypes = require('./GemlTypes');

class GemlCodeGen {
  static transform(json, options) {
    let codeGen = new GemlCodeGen(options);
    return codeGen.generate(json);
  }

  constructor(options) {
    this.indented = 0;
    this.content = '';
    this.options = options;
  }

  generate(json) {
    this.generateObject(json);
    return this.content;
  }

  appendLine(line) {
    if (line) {
      if (arguments.length > 1) {
        line = [...arguments].join(' ');
      }

      this.content += (this.indented > 0 ? _.repeat(' ', this.indented) : '') + line + '\n';
    } else {
      this.content += '\n';
    }

    return this;
  }

  indent() {
    this.indented += 2;
    return this;
  }

  dedent() {
    this.indented -= 2;
    return this;
  }

  generateObject(obj) {
    _.forOwn(obj, (v, k) => {
      let generateMethod = 'generate_' + k;

      if (generateMethod in this) {
        return this[generateMethod](v);
      }

      throw new Error('to be implemented, object: ' + k);
    });
  }

  generate_namespace(namespaces) {
    if (namespaces.length > 0) {
      this.appendLine(KW_NAMESPACE).indent();
      namespaces.forEach(ns => {
        this.appendLine(Util.quote(ns, "'"));
      });
      this.dedent().appendLine();
    }
  }

  generate_schema(schema) {
    _.forOwn(schema, (schemaInfo, name) => {
      this.appendLine(KW_SCHEMA, Util.quote(name, "'")).indent();

      if (schemaInfo.entities) {
        this.appendLine(KW_ENTITIES).indent();
        schemaInfo.entities.forEach(entityEntry => {
          if (entityEntry.alias) {
            this.appendLine(entityEntry.entity, KW_ENTITY_AS_ALIAS, entityEntry.alias);
          } else {
            this.appendLine(entityEntry.entity);
          }
        });
        this.dedent().appendLine();
      }

      this.dedent();
    });
  }

  generate_type(types) {
    if (!_.isEmpty(types)) {
      this.appendLine(KW_TYPE_DEFINE).indent();

      _.forOwn(types, (type, name) => {
        let lineInfo = [name, ':', type.type];

        this._translateType(type, lineInfo);

        this.appendLine(...lineInfo);
      });

      this.dedent().appendLine();
    }
  }

  generate_field_comment(entityName, colName) {
    let colNameFullSnake = _.trimStart(_.snakeCase(colName), '_');

    let [colNameFirstWord, colNameRest] = colNameFullSnake.split('_', 2);
    let result;

    let entityNameFullSnake = _.trim(_.snakeCase(entityName), '_');

    if (_.endsWith(entityNameFullSnake, colNameFirstWord)) {
      result = entityNameFullSnake + '_' + colNameRest;
    } else {
      result = entityNameFullSnake + '_' + colNameFullSnake;
    }

    return generateDisplayName(result);
  }

  generate_entity(entities) {
    _.forOwn(entities, (entity, enityName) => {
      this.appendLine(KW_ENTITY, enityName).indent();

      if (entity.source) {
        this.appendLine(KW_CODE, Util.quote(entity.source));
      }

      this.appendLine(KW_COMMENT, Util.quote(entity.comment || generateDisplayName(enityName)));
      let hasAutoId = false;

      if (!_.isEmpty(entity.features)) {
        this.appendLine(KW_WITH_FEATURE).indent();
        entity.features.forEach(feature => {
          if (typeof feature === 'string') {
            feature = {
              name: feature
            };
          }

          if (feature.name === 'autoId') {
            hasAutoId = true;
          }

          if (feature.args) {
            this.appendLine(feature.name + '(' + feature.args.map(a => JSON.stringify(a)).join(', ') + ')');
          } else {
            this.appendLine(feature.name);
          }
        });
        this.dedent();
      }

      if (!_.isEmpty(entity.fields)) {
        this.appendLine().appendLine(KW_FIELDS).indent();

        _.forOwn(entity.fields, (field, name) => {
          let lineInfo = [];
          lineInfo.push(Types.Builtin.has(name) ? Util.quote(name) : name);

          if (field.type !== name) {
            lineInfo.push(':');
            lineInfo.push(field.type);
          }

          this._translateType(field, lineInfo);

          lineInfo.push(KW_COMMENT + ' ' + Util.quote(field.comment || this.generate_field_comment(enityName, name)));
          this.appendLine(...lineInfo);
        });

        this.dedent();
      }

      if (!_.isEmpty(entity.associations)) {
        this.appendLine().appendLine(KW_ASSOCIATIONS).indent();
        entity.associations.forEach(({
          type,
          srcField,
          destEntity,
          connectedBy
        }) => {
          if (srcField) {
            this.appendLine(type, Util.quote(destEntity, "'"), 'as', Util.quote(srcField, "'"));
          } else if (connectedBy) {
            this.appendLine(type, Util.quote(destEntity, "'"), 'connectedBy', Util.quote(connectedBy, "'"));
          } else {
            this.appendLine(type, Util.quote(destEntity, "'"));
          }
        });
        this.dedent();
      }

      if (entity.key && !hasAutoId) {
        let key = Array.isArray(entity.key) && entity.key.length === 1 ? entity.key[0] : entity.key;

        if (Array.isArray(key)) {
          this.appendLine().appendLine(KW_KEY, '[ ' + key.join(', ') + ' ]');
        } else {
          this.appendLine().appendLine(KW_KEY, key);
        }
      }

      if (!_.isEmpty(entity.indexes)) {
        this.appendLine().appendLine(KW_INDEXES).indent();
        entity.indexes.forEach(i => {
          let indexInfo = [];

          if (Array.isArray(i.fields)) {
            indexInfo.push('[' + i.fields.join(', ') + ']');
          } else {
            indexInfo.push(i.fields);
          }

          if (i.unique) {
            indexInfo.push('is');
            indexInfo.push('unique');
          }

          this.appendLine(...indexInfo);
        });
        this.dedent();
      }

      this.dedent();
    });
  }

  _translateType(field, lineInfo) {
    let extraTypeInfo = _.omit(field, ['type', 'modifiers', 'name']);

    _.forOwn(extraTypeInfo, (v, k) => {
      if (k === 'comment') return;

      if (typeof v === 'boolean' || isNothing(v)) {
        if (v) {
          lineInfo.push(k);
        }
      } else {
        v = _.castArray(v);
        lineInfo.push(k + '(' + this._translateArgs(v) + ')');
      }
    });

    if (field.modifiers) {
      this._translatePipedValue(lineInfo, field);
    }
  }

  _translatePipedValue(lineInfo, value) {
    if (value.modifiers) {
      value.modifiers.forEach(v => {
        switch (v.oolType) {
          case GemlTypes.Lang.VALIDATOR:
            lineInfo.push('|~' + this._translateModifier(v));
            break;

          case GemlTypes.Lang.PROCESSOR:
            lineInfo.push('|>' + this._translateModifier(v));
            break;

          case GemlTypes.Lang.ACTIVATOR:
            lineInfo.push('|=' + this._translateModifier(v));
            break;

          default:
            throw new Error(`Unknown modifier type: "${v.oolType}"!`);
        }
      });
    }
  }

  _translateModifier(f) {
    let r = f.name;

    if (!_.isEmpty(f.args)) {
      r += '(';
      r += this._translateArgs(f.args);
      r += ')';
    }

    return r;
  }

  _translateArgs(args) {
    return args.map(a => this._translateArg(a)).join(', ');
  }

  _translateArg(a) {
    if (_.isPlainObject(a) && a.hasOwnProperty('oolType')) {
      if (a.oolType === 'PipedValue') {
        let pipeline = [this._translateArg(a.value)];

        if (a.modifiers) {
          this._translatePipedValue(pipeline, a);
        }

        return pipeline.join(' ');
      } else if (a.oolType === 'ObjectReference') {
        return '@' + a.name;
      } else {
        throw new Error('Not supported oolType: ' + a.oolType);
      }
    }

    if (typeof a === 'string' && isQuotedWith(a, '/')) return a;
    return JSON.stringify(a);
  }

}

module.exports = GemlCodeGen;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0dlbWxDb2RlR2VuLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsImdlbmVyYXRlRGlzcGxheU5hbWUiLCJpc05vdGhpbmciLCJpc1F1b3RlZFdpdGgiLCJLV19OQU1FU1BBQ0UiLCJLV19TQ0hFTUEiLCJLV19FTlRJVElFUyIsIktXX0VOVElUWV9BU19BTElBUyIsIktXX1RZUEVfREVGSU5FIiwiS1dfRU5USVRZIiwiS1dfQ09ERSIsIktXX0NPTU1FTlQiLCJLV19XSVRIX0ZFQVRVUkUiLCJLV19GSUVMRFMiLCJLV19BU1NPQ0lBVElPTlMiLCJLV19LRVkiLCJLV19JTkRFWEVTIiwiVHlwZXMiLCJHZW1sVHlwZXMiLCJHZW1sQ29kZUdlbiIsInRyYW5zZm9ybSIsImpzb24iLCJvcHRpb25zIiwiY29kZUdlbiIsImdlbmVyYXRlIiwiY29uc3RydWN0b3IiLCJpbmRlbnRlZCIsImNvbnRlbnQiLCJnZW5lcmF0ZU9iamVjdCIsImFwcGVuZExpbmUiLCJsaW5lIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiam9pbiIsInJlcGVhdCIsImluZGVudCIsImRlZGVudCIsIm9iaiIsImZvck93biIsInYiLCJrIiwiZ2VuZXJhdGVNZXRob2QiLCJFcnJvciIsImdlbmVyYXRlX25hbWVzcGFjZSIsIm5hbWVzcGFjZXMiLCJmb3JFYWNoIiwibnMiLCJxdW90ZSIsImdlbmVyYXRlX3NjaGVtYSIsInNjaGVtYSIsInNjaGVtYUluZm8iLCJuYW1lIiwiZW50aXRpZXMiLCJlbnRpdHlFbnRyeSIsImFsaWFzIiwiZW50aXR5IiwiZ2VuZXJhdGVfdHlwZSIsInR5cGVzIiwiaXNFbXB0eSIsInR5cGUiLCJsaW5lSW5mbyIsIl90cmFuc2xhdGVUeXBlIiwiZ2VuZXJhdGVfZmllbGRfY29tbWVudCIsImVudGl0eU5hbWUiLCJjb2xOYW1lIiwiY29sTmFtZUZ1bGxTbmFrZSIsInRyaW1TdGFydCIsInNuYWtlQ2FzZSIsImNvbE5hbWVGaXJzdFdvcmQiLCJjb2xOYW1lUmVzdCIsInNwbGl0IiwicmVzdWx0IiwiZW50aXR5TmFtZUZ1bGxTbmFrZSIsInRyaW0iLCJlbmRzV2l0aCIsImdlbmVyYXRlX2VudGl0eSIsImVuaXR5TmFtZSIsInNvdXJjZSIsImNvbW1lbnQiLCJoYXNBdXRvSWQiLCJmZWF0dXJlcyIsImZlYXR1cmUiLCJhcmdzIiwibWFwIiwiYSIsIkpTT04iLCJzdHJpbmdpZnkiLCJmaWVsZHMiLCJmaWVsZCIsInB1c2giLCJCdWlsdGluIiwiaGFzIiwiYXNzb2NpYXRpb25zIiwic3JjRmllbGQiLCJkZXN0RW50aXR5IiwiY29ubmVjdGVkQnkiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJpbmRleGVzIiwiaSIsImluZGV4SW5mbyIsInVuaXF1ZSIsImV4dHJhVHlwZUluZm8iLCJvbWl0IiwiY2FzdEFycmF5IiwiX3RyYW5zbGF0ZUFyZ3MiLCJtb2RpZmllcnMiLCJfdHJhbnNsYXRlUGlwZWRWYWx1ZSIsInZhbHVlIiwib29sVHlwZSIsIkxhbmciLCJWQUxJREFUT1IiLCJfdHJhbnNsYXRlTW9kaWZpZXIiLCJQUk9DRVNTT1IiLCJBQ1RJVkFUT1IiLCJmIiwiciIsIl90cmFuc2xhdGVBcmciLCJpc1BsYWluT2JqZWN0IiwiaGFzT3duUHJvcGVydHkiLCJwaXBlbGluZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUYsSUFBZDs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBMEJGLE9BQU8sQ0FBQyxhQUFELENBQXZDOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsU0FBRjtBQUFhQyxFQUFBQTtBQUFiLElBQThCSixPQUFPLENBQUMsZUFBRCxDQUEzQzs7QUFFQSxNQUFNSyxZQUFZLEdBQUcsUUFBckI7QUFDQSxNQUFNQyxTQUFTLEdBQUcsUUFBbEI7QUFDQSxNQUFNQyxX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a0MsYUFBTCxDQUFtQmxDLENBQW5CLENBQWQsRUFBcUNuRCxJQUFyQyxDQUEwQyxJQUExQyxDQUFQO0FBQ0g7O0FBRURxRixFQUFBQSxhQUFhLENBQUNsQyxDQUFELEVBQUk7QUFDYixRQUFJcEYsQ0FBQyxDQUFDdUgsYUFBRixDQUFnQm5DLENBQWhCLEtBQXNCQSxDQUFDLENBQUNvQyxjQUFGLENBQWlCLFNBQWpCLENBQTFCLEVBQXVEO0FBQ25ELFVBQUlwQyxDQUFDLENBQUMwQixPQUFGLEtBQWMsWUFBbEIsRUFBZ0M7QUFDNUIsWUFBSVcsUUFBUSxHQUFHLENBQUUsS0FBS0gsYUFBTCxDQUFtQmxDLENBQUMsQ0FBQ3lCLEtBQXJCLENBQUYsQ0FBZjs7QUFFQSxZQUFJekIsQ0FBQyxDQUFDdUIsU0FBTixFQUFpQjtBQUNiLGVBQUtDLG9CQUFMLENBQTBCYSxRQUExQixFQUFvQ3JDLENBQXBDO0FBQ0g7O0FBRUQsZUFBT3FDLFFBQVEsQ0FBQ3hGLElBQVQsQ0FBYyxHQUFkLENBQVA7QUFDSCxPQVJELE1BUU8sSUFBSW1ELENBQUMsQ0FBQzBCLE9BQUYsS0FBYyxpQkFBbEIsRUFBcUM7QUFDeEMsZUFBTyxNQUFNMUIsQ0FBQyxDQUFDakMsSUFBZjtBQUNILE9BRk0sTUFFQTtBQUNILGNBQU0sSUFBSVQsS0FBSixDQUFVLDRCQUE0QjBDLENBQUMsQ0FBQzBCLE9BQXhDLENBQU47QUFDSDtBQUNKOztBQUVELFFBQUksT0FBTzFCLENBQVAsS0FBYSxRQUFiLElBQXlCakYsWUFBWSxDQUFDaUYsQ0FBRCxFQUFJLEdBQUosQ0FBekMsRUFBbUQsT0FBT0EsQ0FBUDtBQUVuRCxXQUFPQyxJQUFJLENBQUNDLFNBQUwsQ0FBZUYsQ0FBZixDQUFQO0FBQ0g7O0FBdlZhOztBQTBWbEJzQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ4RyxXQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXyB9ID0gVXRpbDtcbmNvbnN0IHsgZ2VuZXJhdGVEaXNwbGF5TmFtZSB9ID0gcmVxdWlyZSgnLi9HZW1sVXRpbHMnKTtcbmNvbnN0IHsgaXNOb3RoaW5nLCBpc1F1b3RlZFdpdGggfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcblxuY29uc3QgS1dfTkFNRVNQQUNFID0gJ2ltcG9ydCc7XG5jb25zdCBLV19TQ0hFTUEgPSAnc2NoZW1hJztcbmNvbnN0IEtXX0VOVElUSUVTID0gJ2VudGl0aWVzJztcbmNvbnN0IEtXX0VOVElUWV9BU19BTElBUyA9ICdhcyc7XG5jb25zdCBLV19UWVBFX0RFRklORSA9ICd0eXBlJztcbmNvbnN0IEtXX0VOVElUWSA9ICdlbnRpdHknO1xuY29uc3QgS1dfQ09ERSA9ICdjb2RlJztcbmNvbnN0IEtXX0NPTU1FTlQgPSAnLS0nO1xuY29uc3QgS1dfV0lUSF9GRUFUVVJFID0gJ3dpdGgnO1xuY29uc3QgS1dfRklFTERTID0gJ2hhcyc7XG5jb25zdCBLV19BU1NPQ0lBVElPTlMgPSAnYXNzb2NpYXRpb25zJztcbmNvbnN0IEtXX0tFWSA9ICdrZXknO1xuY29uc3QgS1dfSU5ERVhFUyA9ICdpbmRleCc7XG5cbmNvbnN0IHsgVHlwZXMgfSA9IHJlcXVpcmUoJ0BnZW54L2RhdGEnKTtcbmNvbnN0IEdlbWxUeXBlcyA9IHJlcXVpcmUoJy4vR2VtbFR5cGVzJyk7XG5cbmNsYXNzIEdlbWxDb2RlR2VuIHtcbiAgICBzdGF0aWMgdHJhbnNmb3JtKGpzb24sIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGNvZGVHZW4gPSBuZXcgR2VtbENvZGVHZW4ob3B0aW9ucyk7XG4gICAgICAgIHJldHVybiBjb2RlR2VuLmdlbmVyYXRlKGpzb24pO1xuICAgIH1cblxuICAgIGluZGVudGVkID0gMDtcbiAgICBjb250ZW50ID0gJyc7XG5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGUoanNvbikge1xuICAgICAgICB0aGlzLmdlbmVyYXRlT2JqZWN0KGpzb24pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnQ7XG4gICAgfVxuXG4gICAgYXBwZW5kTGluZShsaW5lKSB7XG4gICAgICAgIGlmIChsaW5lKSB7XG4gICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICBsaW5lID0gWyAuLi5hcmd1bWVudHNdLmpvaW4oJyAnKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5jb250ZW50ICs9ICh0aGlzLmluZGVudGVkID4gMCA/IF8ucmVwZWF0KCcgJywgdGhpcy5pbmRlbnRlZCkgOiAnJykgKyBsaW5lICsgJ1xcbic7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQgKz0gJ1xcbic7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgaW5kZW50KCkge1xuICAgICAgICB0aGlzLmluZGVudGVkICs9IDI7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGRlZGVudCgpIHtcbiAgICAgICAgdGhpcy5pbmRlbnRlZCAtPSAyO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgcG9zdDogdGhpcy5pbmRlbnRlZCA+PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgIH1cblxuICAgIGdlbmVyYXRlT2JqZWN0KG9iaikge1xuICAgICAgICBfLmZvck93bihvYmosICh2LGspID0+IHtcbiAgICAgICAgICAgIGxldCBnZW5lcmF0ZU1ldGhvZCA9ICdnZW5lcmF0ZV8nICsgaztcblxuICAgICAgICAgICAgaWYgKGdlbmVyYXRlTWV0aG9kIGluIHRoaXMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tnZW5lcmF0ZU1ldGhvZF0odik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndG8gYmUgaW1wbGVtZW50ZWQsIG9iamVjdDogJyArIGspO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZW5lcmF0ZV9uYW1lc3BhY2UobmFtZXNwYWNlcykge1xuICAgICAgICBwcmU6IHtcbiAgICAgICAgICAgIEFycmF5LmlzQXJyYXkobmFtZXNwYWNlcyksICdJbnZhbGlkIG5hbWVzcGFjZXMuJztcbiAgICAgICAgICAgIHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuYW1lc3BhY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19OQU1FU1BBQ0UpLmluZGVudCgpO1xuXG4gICAgICAgICAgICBuYW1lc3BhY2VzLmZvckVhY2gobnMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShVdGlsLnF1b3RlKG5zLCBcIidcIikpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuZGVkZW50KCkuYXBwZW5kTGluZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcG9zdDogdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgIH1cblxuICAgIGdlbmVyYXRlX3NjaGVtYShzY2hlbWEpIHtcbiAgICAgICAgcHJlOiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgICAgIH1cblxuICAgICAgICBfLmZvck93bihzY2hlbWEsIChzY2hlbWFJbmZvLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfU0NIRU1BLCBVdGlsLnF1b3RlKG5hbWUsIFwiJ1wiKSkuaW5kZW50KCk7XG5cbiAgICAgICAgICAgIGlmIChzY2hlbWFJbmZvLmVudGl0aWVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX0VOVElUSUVTKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgICAgIHNjaGVtYUluZm8uZW50aXRpZXMuZm9yRWFjaChlbnRpdHlFbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHlFbnRyeS5hbGlhcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKGVudGl0eUVudHJ5LmVudGl0eSwgS1dfRU5USVRZX0FTX0FMSUFTLCBlbnRpdHlFbnRyeS5hbGlhcyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoZW50aXR5RW50cnkuZW50aXR5KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5kZWRlbnQoKS5hcHBlbmRMaW5lKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgcG9zdDogdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgIH1cblxuICAgIGdlbmVyYXRlX3R5cGUodHlwZXMpIHtcbiAgICAgICAgcHJlOiB7XG4gICAgICAgICAgICBfLmlzUGxhaW5PYmplY3QodHlwZXMpLCAnSW52YWxpZCB0eXBlcy4nO1xuICAgICAgICAgICAgdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodHlwZXMpKSB7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfVFlQRV9ERUZJTkUpLmluZGVudCgpO1xuXG4gICAgICAgICAgICBfLmZvck93bih0eXBlcywgKHR5cGUsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbGluZUluZm8gPSBbIG5hbWUsICc6JywgdHlwZS50eXBlIF07XG5cbiAgICAgICAgICAgICAgICB0aGlzLl90cmFuc2xhdGVUeXBlKHR5cGUsIGxpbmVJbmZvKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSguLi5saW5lSW5mbyk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5kZWRlbnQoKS5hcHBlbmRMaW5lKCk7XG4gICAgICAgIH1cblxuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVfZmllbGRfY29tbWVudChlbnRpdHlOYW1lLCBjb2xOYW1lKSB7XG4gICAgICAgIGxldCBjb2xOYW1lRnVsbFNuYWtlID0gXy50cmltU3RhcnQoXy5zbmFrZUNhc2UoY29sTmFtZSksICdfJyk7XG4gICAgICAgIGxldCAgWyBjb2xOYW1lRmlyc3RXb3JkLCBjb2xOYW1lUmVzdCBdID0gY29sTmFtZUZ1bGxTbmFrZS5zcGxpdCgnXycsIDIpO1xuXG4gICAgICAgIGxldCByZXN1bHQ7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWVGdWxsU25ha2UgPSBfLnRyaW0oXy5zbmFrZUNhc2UoZW50aXR5TmFtZSksICdfJyk7XG4gICAgICAgIGlmIChfLmVuZHNXaXRoKGVudGl0eU5hbWVGdWxsU25ha2UsIGNvbE5hbWVGaXJzdFdvcmQpKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBlbnRpdHlOYW1lRnVsbFNuYWtlICsgJ18nICsgY29sTmFtZVJlc3Q7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQgPSBlbnRpdHlOYW1lRnVsbFNuYWtlICsgJ18nICsgY29sTmFtZUZ1bGxTbmFrZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBnZW5lcmF0ZURpc3BsYXlOYW1lKHJlc3VsdCk7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVfZW50aXR5KGVudGl0aWVzKSB7XG4gICAgICAgIHByZToge1xuICAgICAgICAgICAgXy5pc1BsYWluT2JqZWN0KGVudGl0aWVzKSwgJ0ludmFsaWQgZW50aXRpZXMuJztcbiAgICAgICAgICAgIHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICAgICAgfVxuXG4gICAgICAgIF8uZm9yT3duKGVudGl0aWVzLCAoZW50aXR5LCBlbml0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19FTlRJVFksIGVuaXR5TmFtZSkuaW5kZW50KCk7XG5cbiAgICAgICAgICAgIGlmIChlbnRpdHkuc291cmNlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX0NPREUsIFV0aWwucXVvdGUoZW50aXR5LnNvdXJjZSkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfQ09NTUVOVCwgVXRpbC5xdW90ZShlbnRpdHkuY29tbWVudCB8fCBnZW5lcmF0ZURpc3BsYXlOYW1lKGVuaXR5TmFtZSkpKTtcblxuICAgICAgICAgICAgbGV0IGhhc0F1dG9JZCA9IGZhbHNlO1xuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShlbnRpdHkuZmVhdHVyZXMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX1dJVEhfRkVBVFVSRSkuaW5kZW50KCk7XG5cbiAgICAgICAgICAgICAgICBlbnRpdHkuZmVhdHVyZXMuZm9yRWFjaChmZWF0dXJlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmZWF0dXJlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZSA9IHsgbmFtZTogZmVhdHVyZSB9O1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZlYXR1cmUubmFtZSA9PT0gJ2F1dG9JZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc0F1dG9JZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoZmVhdHVyZS5hcmdzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoZmVhdHVyZS5uYW1lICsgJygnICsgZmVhdHVyZS5hcmdzLm1hcChhID0+IEpTT04uc3RyaW5naWZ5KGEpKS5qb2luKCcsICcpICsgJyknKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShmZWF0dXJlLm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmRlZGVudCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShlbnRpdHkuZmllbGRzKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSgpLmFwcGVuZExpbmUoS1dfRklFTERTKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgICAgIF8uZm9yT3duKGVudGl0eS5maWVsZHMsIChmaWVsZCwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IGZpZWxkLnR5cGU7ICAgICAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgICAgICBsZXQgbGluZUluZm8gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaChUeXBlcy5CdWlsdGluLmhhcyhuYW1lKSA/IFV0aWwucXVvdGUobmFtZSkgOiBuYW1lKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkLnR5cGUgIT09IG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goJzonKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goZmllbGQudHlwZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLl90cmFuc2xhdGVUeXBlKGZpZWxkLCBsaW5lSW5mbyk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaChLV19DT01NRU5UICsgJyAnICsgVXRpbC5xdW90ZShmaWVsZC5jb21tZW50IHx8IHRoaXMuZ2VuZXJhdGVfZmllbGRfY29tbWVudChlbml0eU5hbWUsIG5hbWUpKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKC4uLmxpbmVJbmZvKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5hc3NvY2lhdGlvbnMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19BU1NPQ0lBVElPTlMpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgZW50aXR5LmFzc29jaWF0aW9ucy5mb3JFYWNoKCh7IHR5cGUsIHNyY0ZpZWxkLCBkZXN0RW50aXR5LCBjb25uZWN0ZWRCeSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzcmNGaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKHR5cGUsIFV0aWwucXVvdGUoZGVzdEVudGl0eSwgXCInXCIpLCAnYXMnLCBVdGlsLnF1b3RlKHNyY0ZpZWxkLCBcIidcIikpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbm5lY3RlZEJ5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUodHlwZSwgVXRpbC5xdW90ZShkZXN0RW50aXR5LCBcIidcIiksICdjb25uZWN0ZWRCeScsIFV0aWwucXVvdGUoY29ubmVjdGVkQnksIFwiJ1wiKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUodHlwZSwgVXRpbC5xdW90ZShkZXN0RW50aXR5LCBcIidcIikpO1xuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChlbnRpdHkua2V5ICYmICFoYXNBdXRvSWQpIHtcbiAgICAgICAgICAgICAgICBsZXQga2V5ID0gKEFycmF5LmlzQXJyYXkoZW50aXR5LmtleSkgJiYgZW50aXR5LmtleS5sZW5ndGggPT09IDEpID8gZW50aXR5LmtleVswXSA6IGVudGl0eS5rZXk7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoKS5hcHBlbmRMaW5lKEtXX0tFWSwgJ1sgJyArIGtleS5qb2luKCcsICcpICsgJyBdJyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19LRVksIGtleSk7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmluZGV4ZXMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19JTkRFWEVTKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgICAgIGVudGl0eS5pbmRleGVzLmZvckVhY2goaSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBpbmRleEluZm8gPSBbXTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpLmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4SW5mby5wdXNoKCdbJyArIGkuZmllbGRzLmpvaW4oJywgJykgKyAnXScpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhJbmZvLnB1c2goaS5maWVsZHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGkudW5pcXVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleEluZm8ucHVzaCgnaXMnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4SW5mby5wdXNoKCd1bmlxdWUnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSguLi5pbmRleEluZm8pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcG9zdDogdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVUeXBlKGZpZWxkLCBsaW5lSW5mbykge1xuICAgICAgICBsZXQgZXh0cmFUeXBlSW5mbyA9IF8ub21pdChmaWVsZCwgWyd0eXBlJywgJ21vZGlmaWVycycsICduYW1lJ10pO1xuICAgICAgICAvL2xldCB0eXBlTWV0YSA9IFR5cGVzW2ZpZWxkLnR5cGVdO1xuICAgICAgICBfLmZvck93bihleHRyYVR5cGVJbmZvLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgLy9pZiAoIXR5cGVNZXRhLnF1YWxpZmllcnMuaW5jbHVkZXMoaykpIHtcbiAgICAgICAgICAgIC8vICAgIHRocm93IG5ldyBFcnJvcihgXCIke2t9XCIgaXMgbm90IGEgdmFsaWQgcXVhbGlmaWVyIGZvciB0eXBlIFwiJHtmaWVsZC50eXBlfVwiLmApO1xuICAgICAgICAgICAgLy99XG4gICAgICAgICAgICBpZiAoayA9PT0gJ2NvbW1lbnQnKSByZXR1cm47XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ2Jvb2xlYW4nIHx8IGlzTm90aGluZyh2KSkge1xuICAgICAgICAgICAgICAgIGlmICh2KSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goayk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2ID0gXy5jYXN0QXJyYXkodik7XG4gICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaChrICsgJygnICsgdGhpcy5fdHJhbnNsYXRlQXJncyh2KSArICcpJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChmaWVsZC5tb2RpZmllcnMpIHtcbiAgICAgICAgICAgIHRoaXMuX3RyYW5zbGF0ZVBpcGVkVmFsdWUobGluZUluZm8sIGZpZWxkKTtcbiAgICAgICAgfSAgICAgICAgXG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZVBpcGVkVmFsdWUobGluZUluZm8sIHZhbHVlKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHZhbHVlLm1vZGlmaWVycykge1xuICAgICAgICAgICAgdmFsdWUubW9kaWZpZXJzLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICAgICAgc3dpdGNoICh2Lm9vbFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBHZW1sVHlwZXMuTGFuZy5WQUxJREFUT1I6XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goJ3x+JyArIHRoaXMuX3RyYW5zbGF0ZU1vZGlmaWVyKHYpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FzZSBHZW1sVHlwZXMuTGFuZy5QUk9DRVNTT1I6XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goJ3w+JyArIHRoaXMuX3RyYW5zbGF0ZU1vZGlmaWVyKHYpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FzZSBHZW1sVHlwZXMuTGFuZy5BQ1RJVkFUT1I6XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goJ3w9JyArIHRoaXMuX3RyYW5zbGF0ZU1vZGlmaWVyKHYpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBtb2RpZmllciB0eXBlOiBcIiR7di5vb2xUeXBlfVwiIWApO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gXG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZU1vZGlmaWVyKGYpIHtcbiAgICAgICAgbGV0IHIgPSBmLm5hbWU7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoZi5hcmdzKSkge1xuICAgICAgICAgICAgciArPSAnKCc7XG5cbiAgICAgICAgICAgIHIgKz0gdGhpcy5fdHJhbnNsYXRlQXJncyhmLmFyZ3MpO1xuXG4gICAgICAgICAgICByICs9ICcpJztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVBcmdzKGFyZ3MpIHtcbiAgICAgICAgcmV0dXJuIGFyZ3MubWFwKGEgPT4gdGhpcy5fdHJhbnNsYXRlQXJnKGEpKS5qb2luKCcsICcpO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVBcmcoYSkge1xuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGEpICYmIGEuaGFzT3duUHJvcGVydHkoJ29vbFR5cGUnKSkge1xuICAgICAgICAgICAgaWYgKGEub29sVHlwZSA9PT0gJ1BpcGVkVmFsdWUnKSB7XG4gICAgICAgICAgICAgICAgbGV0IHBpcGVsaW5lID0gWyB0aGlzLl90cmFuc2xhdGVBcmcoYS52YWx1ZSkgXTtcblxuICAgICAgICAgICAgICAgIGlmIChhLm1vZGlmaWVycykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl90cmFuc2xhdGVQaXBlZFZhbHVlKHBpcGVsaW5lLCBhKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcGlwZWxpbmUuam9pbignICcpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhLm9vbFR5cGUgPT09ICdPYmplY3RSZWZlcmVuY2UnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdAJyArIGEubmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb3Qgc3VwcG9ydGVkIG9vbFR5cGU6ICcgKyBhLm9vbFR5cGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IFxuXG4gICAgICAgIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycgJiYgaXNRdW90ZWRXaXRoKGEsICcvJykpIHJldHVybiBhO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGEpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBHZW1sQ29kZUdlbjsiXX0=
"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable
} = require('./GemlUtils');

const Dataset = require('./Dataset');

class View extends Clonable {
  constructor(linker, name, gemlModule, info) {
    this.linker = linker;
    this.name = name;
    this.gemlModule = gemlModule;
    this.info = info;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    if (this.info.dataset) {
      this.dataset = this.linker.loadDoc(this.gemlModule, this.info.dataset);
    } else {
      if (!this.info.entity) {
        throw new Error('Invalid view syntax!');
      }

      let mainEntity = this.linker.getReferencedEntity(this.gemlModule, this.info.entity);
      this.dataset = new Dataset(this.linker, mainEntity.name, this.gemlModule, {
        mainEntity: mainEntity.name
      });
      this.dataset.link();
    }

    if (this.info.isList) {
      this.isList = true;
    }

    if (!_.isEmpty(this.info.accept)) {
      this.params = this.info.accept.concat();
    }

    if (!_.isEmpty(this.info.selectBy)) {
      this.selectBy = this.info.selectBy.concat();
    }

    if (!_.isEmpty(this.info.groupBy)) {
      this.groupBy = this.info.groupBy.concat();
    }

    if (!_.isEmpty(this.info.orderBy)) {
      this.orderBy = this.info.orderBy.concat();
    }

    if (this.info.skip) {
      this.skip = _.isPlainObject(this.info.skip) ? Object.assign({}, this.info.skip) : this.info.skip;
    }

    if (this.info.limit) {
      this.limit = _.isPlainObject(this.info.limit) ? Object.assign({}, this.info.limit) : this.info.limit;
    }

    this.linked = true;
    return this;
  }

  inferTypeInfo(inSchema) {
    if (!_.isEmpty(this.params)) {
      let inferredParams = [];
      this.params.forEach(param => {
        if (GemlUtils.isMemberAccess(param.type)) {
          let [entityName, fieldName] = param.type.split('.');

          if (!inSchema.hasEntity(entityName)) {
            throw new Error(`Parameter "${param.name}" references to an entity "${entityName}" which is not belong to the schema.`);
          }

          let entity = inSchema.entities[entityName];
          let field = entity.getEntityAttribute(fieldName);
          inferredParams.push(Object.assign(_.omit(_.toPlainObject(field), ['isReference', 'optional', 'displayName']), {
            name: param.name
          }));
        } else {
          inferredParams.push(this.linker.trackBackType(this.gemlModule, param));
        }
      });
      this.params = inferredParams;
    }
  }

  getDocumentHierarchy(inSchema) {
    return inSchema.getDocumentHierachy(this.gemlModule, this.dataset.name);
  }

  clone() {
    super.clone();
    let view = new View(this.linker, this.name, this.gemlModule, this.info);
    deepCloneField(this, view, 'dataset');
    deepCloneField(this, view, 'params');
    deepCloneField(this, view, 'selectBy');
    deepCloneField(this, view, 'groupBy');
    deepCloneField(this, view, 'orderBy');
    deepCloneField(this, view, 'skip');
    deepCloneField(this, view, 'limit');
    view.isList = this.isList;
    view.linked = true;
    return view;
  }

  toJSON() {
    return {
      name: this.name,
      dataset: this.dataset.toJSON(),
      isList: this.isList,
      params: this.params,
      selectBy: this.selectBy,
      groupBy: this.groupBy,
      orderBy: this.orderBy,
      skip: this.skip,
      limit: this.limit
    };
  }

}

module.exports = View;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL1ZpZXcuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJDbG9uYWJsZSIsIkRhdGFzZXQiLCJWaWV3IiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwiZ2VtbE1vZHVsZSIsImluZm8iLCJsaW5rIiwibGlua2VkIiwiZGF0YXNldCIsImxvYWREb2MiLCJlbnRpdHkiLCJtYWluRW50aXR5IiwiZ2V0UmVmZXJlbmNlZEVudGl0eSIsImlzTGlzdCIsImlzRW1wdHkiLCJhY2NlcHQiLCJwYXJhbXMiLCJjb25jYXQiLCJzZWxlY3RCeSIsImdyb3VwQnkiLCJvcmRlckJ5Iiwic2tpcCIsImlzUGxhaW5PYmplY3QiLCJPYmplY3QiLCJhc3NpZ24iLCJsaW1pdCIsImluZmVyVHlwZUluZm8iLCJpblNjaGVtYSIsImluZmVycmVkUGFyYW1zIiwiZm9yRWFjaCIsInBhcmFtIiwiR2VtbFV0aWxzIiwiaXNNZW1iZXJBY2Nlc3MiLCJ0eXBlIiwiZW50aXR5TmFtZSIsImZpZWxkTmFtZSIsInNwbGl0IiwiaGFzRW50aXR5IiwiRXJyb3IiLCJlbnRpdGllcyIsImZpZWxkIiwiZ2V0RW50aXR5QXR0cmlidXRlIiwicHVzaCIsIm9taXQiLCJ0b1BsYWluT2JqZWN0IiwidHJhY2tCYWNrVHlwZSIsImdldERvY3VtZW50SGllcmFyY2h5IiwiZ2V0RG9jdW1lbnRIaWVyYWNoeSIsImNsb25lIiwidmlldyIsInRvSlNPTiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsbUJBQUY7QUFBdUJDLEVBQUFBLGNBQXZCO0FBQXVDQyxFQUFBQTtBQUF2QyxJQUFvREgsT0FBTyxDQUFDLGFBQUQsQ0FBakU7O0FBRUEsTUFB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b0MsSUFBQUEsSUFBSSxDQUFDMUMsTUFBTCxHQUFjLElBQWQ7QUFFQSxXQUFPMEMsSUFBUDtBQUNIOztBQU1EQyxFQUFBQSxNQUFNLEdBQUc7QUFDTCxXQUFPO0FBQ0gvQyxNQUFBQSxJQUFJLEVBQUUsS0FBS0EsSUFEUjtBQUVISyxNQUFBQSxPQUFPLEVBQUUsS0FBS0EsT0FBTCxDQUFhMEMsTUFBYixFQUZOO0FBR0hyQyxNQUFBQSxNQUFNLEVBQUUsS0FBS0EsTUFIVjtBQUlIRyxNQUFBQSxNQUFNLEVBQUUsS0FBS0EsTUFKVjtBQUtIRSxNQUFBQSxRQUFRLEVBQUUsS0FBS0EsUUFMWjtBQU1IQyxNQUFBQSxPQUFPLEVBQUUsS0FBS0EsT0FOWDtBQU9IQyxNQUFBQSxPQUFPLEVBQUUsS0FBS0EsT0FQWDtBQVFIQyxNQUFBQSxJQUFJLEVBQUUsS0FBS0EsSUFSUjtBQVNISSxNQUFBQSxLQUFLLEVBQUUsS0FBS0E7QUFUVCxLQUFQO0FBV0g7O0FBNUp1Qjs7QUErSjVCMEIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEQsSUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBnZW5lcmF0ZURpc3BsYXlOYW1lLCBkZWVwQ2xvbmVGaWVsZCwgQ2xvbmFibGUgfSA9IHJlcXVpcmUoJy4vR2VtbFV0aWxzJyk7XG5cbmNvbnN0IERhdGFzZXQgPSByZXF1aXJlKCcuL0RhdGFzZXQnKTtcblxuLyoqXG4gKiBPb2xvbmcgdmlldyBjbGFzcy5cbiAqIEBjbGFzcyBPb2xvbmdWaWV3XG4gKi9cbmNsYXNzIFZpZXcgZXh0ZW5kcyBDbG9uYWJsZSB7XG5cbiAgICBpc0xpc3QgPSBmYWxzZTtcblxuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0xpbmtlcn0gbGlua2VyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBWaWV3IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZ2VtbE1vZHVsZSAtIFNvdXJjZSBvb2wgbW9kdWxlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGluZm8gLSBWaWV3IGluZm9cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihsaW5rZXIsIG5hbWUsIGdlbWxNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgdmlld1xuICAgICAgICAgKiBAbWVtYmVyIHtPb2xvbmdMaW5rZXJ9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmxpbmtlciA9IGxpbmtlcjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTmFtZSBvZiB0aGlzIHZpZXdcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgZ2VtbCBtb2R1bGVcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5nZW1sTW9kdWxlID0gZ2VtbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIHRoaXMgdmlld1xuICAgICAqIEByZXR1cm5zIHtPb2xvbmdWaWV3fVxuICAgICAqL1xuICAgIGxpbmsoKSB7XG4gICAgICAgIHByZTogIXRoaXMubGlua2VkO1xuXG4gICAgICAgIGlmICh0aGlzLmluZm8uZGF0YXNldCkge1xuICAgICAgICAgICAgdGhpcy5kYXRhc2V0ID0gdGhpcy5saW5rZXIubG9hZERvYyh0aGlzLmdlbWxNb2R1bGUsIHRoaXMuaW5mby5kYXRhc2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydDogdGhpcy5pbmZvLmVudGl0eSwgJ0ludmFsaWQgdmlldyBzeW50YXghJztcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IG1haW5FbnRpdHkgPSB0aGlzLmxpbmtlci5nZXRSZWZlcmVuY2VkRW50aXR5KHRoaXMuZ2VtbE1vZHVsZSwgdGhpcy5pbmZvLmVudGl0eSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuZGF0YXNldCA9IG5ldyBEYXRhc2V0KHRoaXMubGlua2VyLCBtYWluRW50aXR5Lm5hbWUsIHRoaXMuZ2VtbE1vZHVsZSwgeyBtYWluRW50aXR5OiBtYWluRW50aXR5Lm5hbWUgfSk7XG4gICAgICAgICAgICB0aGlzLmRhdGFzZXQubGluaygpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5pc0xpc3QpIHtcbiAgICAgICAgICAgIHRoaXMuaXNMaXN0ID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5hY2NlcHQpKSB7XG4gICAgICAgICAgICB0aGlzLnBhcmFtcyA9IHRoaXMuaW5mby5hY2NlcHQuY29uY2F0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uc2VsZWN0QnkpKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdEJ5ID0gdGhpcy5pbmZvLnNlbGVjdEJ5LmNvbmNhdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5pbmZvLmdyb3VwQnkpKSB7XG4gICAgICAgICAgICB0aGlzLmdyb3VwQnkgPSB0aGlzLmluZm8uZ3JvdXBCeS5jb25jYXQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5vcmRlckJ5KSkge1xuICAgICAgICAgICAgdGhpcy5vcmRlckJ5ID0gdGhpcy5pbmZvLm9yZGVyQnkuY29uY2F0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbmZvLnNraXApIHtcbiAgICAgICAgICAgIHRoaXMuc2tpcCA9IF8uaXNQbGFpbk9iamVjdCh0aGlzLmluZm8uc2tpcCkgPyBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmluZm8uc2tpcCkgOiB0aGlzLmluZm8uc2tpcDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8ubGltaXQpIHtcbiAgICAgICAgICAgIHRoaXMubGltaXQgPSBfLmlzUGxhaW5PYmplY3QodGhpcy5pbmZvLmxpbWl0KSA/IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuaW5mby5saW1pdCkgOiB0aGlzLmluZm8ubGltaXQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgaW5mZXJUeXBlSW5mbyhpblNjaGVtYSkge1xuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLnBhcmFtcykpIHtcbiAgICAgICAgICAgIGxldCBpbmZlcnJlZFBhcmFtcyA9IFtdO1xuXG4gICAgICAgICAgICB0aGlzLnBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoR2VtbFV0aWxzLmlzTWVtYmVyQWNjZXNzKHBhcmFtLnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBbIGVudGl0eU5hbWUsIGZpZWxkTmFtZSBdID0gcGFyYW0udHlwZS5zcGxpdCgnLicpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghaW5TY2hlbWEuaGFzRW50aXR5KGVudGl0eU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhcmFtZXRlciBcIiR7cGFyYW0ubmFtZX1cIiByZWZlcmVuY2VzIHRvIGFuIGVudGl0eSBcIiR7ZW50aXR5TmFtZX1cIiB3aGljaCBpcyBub3QgYmVsb25nIHRvIHRoZSBzY2hlbWEuYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBsZXQgZW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5kaXIoZW50aXR5LnRvSlNPTigpLCB7ZGVwdGg6IDgsIGNvbG9yczogdHJ1ZX0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUoZmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgaW5mZXJyZWRQYXJhbXMucHVzaChPYmplY3QuYXNzaWduKF8ub21pdChfLnRvUGxhaW5PYmplY3QoZmllbGQpLCBbJ2lzUmVmZXJlbmNlJywgJ29wdGlvbmFsJywgJ2Rpc3BsYXlOYW1lJ10pLCB7bmFtZTogcGFyYW0ubmFtZX0pKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpbmZlcnJlZFBhcmFtcy5wdXNoKHRoaXMubGlua2VyLnRyYWNrQmFja1R5cGUodGhpcy5nZW1sTW9kdWxlLCBwYXJhbSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLnBhcmFtcyA9IGluZmVycmVkUGFyYW1zO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0RG9jdW1lbnRIaWVyYXJjaHkoaW5TY2hlbWEpIHtcbiAgICAgICAgcmV0dXJuIGluU2NoZW1hLmdldERvY3VtZW50SGllcmFjaHkodGhpcy5nZW1sTW9kdWxlLCB0aGlzLmRhdGFzZXQubmFtZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvbmUgdGhlIHZpZXcgICAgIFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdWaWV3fVxuICAgICAqL1xuICAgIGNsb25lKCkge1xuICAgICAgICBzdXBlci5jbG9uZSgpO1xuICAgICAgICBcbiAgICAgICAgbGV0IHZpZXcgPSBuZXcgVmlldyh0aGlzLmxpbmtlciwgdGhpcy5uYW1lLCB0aGlzLmdlbWxNb2R1bGUsIHRoaXMuaW5mbyk7XG5cbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ2RhdGFzZXQnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ3BhcmFtcycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAnc2VsZWN0QnknKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ2dyb3VwQnknKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ29yZGVyQnknKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ3NraXAnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ2xpbWl0Jyk7XG5cbiAgICAgICAgdmlldy5pc0xpc3QgPSB0aGlzLmlzTGlzdDtcbiAgICAgICAgdmlldy5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB2aWV3O1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgdGhlIHZpZXcgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgICAgICBkYXRhc2V0OiB0aGlzLmRhdGFzZXQudG9KU09OKCksXG4gICAgICAgICAgICBpc0xpc3Q6IHRoaXMuaXNMaXN0LFxuICAgICAgICAgICAgcGFyYW1zOiB0aGlzLnBhcmFtcyxcbiAgICAgICAgICAgIHNlbGVjdEJ5OiB0aGlzLnNlbGVjdEJ5LFxuICAgICAgICAgICAgZ3JvdXBCeTogdGhpcy5ncm91cEJ5LFxuICAgICAgICAgICAgb3JkZXJCeTogdGhpcy5vcmRlckJ5LFxuICAgICAgICAgICAgc2tpcDogdGhpcy5za2lwLFxuICAgICAgICAgICAgbGltaXQ6IHRoaXMubGltaXRcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gVmlldzsiXX0=
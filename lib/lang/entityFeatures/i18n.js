"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const _ = Util._;
const FEATURE_NAME = 'i18n';

function feature(entity, args = []) {
  let [options] = args;

  if (!options) {
    throw new Error('Missing feature options!');
  }

  if (!_.isPlainObject(options)) {
    throw new Error('Invalid feature options. Plain object expected!');
  }

  if (!options.field) {
    throw new Error('Missing field name in options!');
  }

  if (!options.locales) {
    throw new Error('Missing locale mapping in options!');
  }

  if (!_.isPlainObject(options.locales)) {
    throw new Error('Invalid locale mapping. Plain object expected!');
  }

  entity.addFeature(FEATURE_NAME, options, true).once('afterAddingFields', () => {
    if (!entity.hasField(options.field)) {
      throw new Error('Field "' + options.field + '" does not exist!');
    }

    let fieldInfo = entity.fields[options.field];
    let suffixSet = new Set(Object.values(options.locales));

    for (let suffix of suffixSet) {
      if (suffix === 'default') continue;
      let fieldName = options.field + '_' + suffix;
      entity.addField(fieldName, fieldInfo);
    }
  });
}

module.exports = feature;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW5nL2VudGl0eUZlYXR1cmVzL2kxOG4uanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiRkVBVFVSRV9OQU1FIiwiZmVhdHVyZSIsImVudGl0eSIsImFyZ3MiLCJvcHRpb25zIiwiRXJyb3IiLCJpc1BsYWluT2JqZWN0IiwiZmllbGQiLCJsb2NhbGVzIiwiYWRkRmVhdHVyZSIsIm9uY2UiLCJoYXNGaWVsZCIsImZpZWxkSW5mbyIsImZpZWxkcyIsInN1ZmZpeFNldCIsIlNldCIsIk9iamVjdCIsInZhbHVlcyIsInN1ZmZpeCIsImZpZWxkTmFtZSIsImFkZEZpZWxkIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1DLENBQUMsR0FBR0YsSUFBSSxDQUFDRSxDQUFmO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLE1BQXJCOztBQWNBLFNBQVNDLE9BQVQsQ0FBaUJDLE1BQWpCLEVBQXlCQyxJQUFJLEdBQUcsRUFBaEMsRUFBb0M7QUFDaEMsTUFBSSxDQUFFQyxPQUFGLElBQWNELElBQWxCOztBQUVBLE1BQUksQ0FBQ0MsT0FBTCxFQUFjO0FBQ1YsVUFBTSxJQUFJQyxLQUFKLENBQVUsMEJBQVYsQ0FBTjtBQUNIOztBQUVELE1BQUksQ0FBQ04sQ0FBQyxDQUFDTyxhQUFGLENBQWdCRixPQUFoQixDQUFMLEVBQStCO0FBQzNCLFVBQU0sSUFBSUMsS0FBSixDQUFVLGlEQUFWLENBQU47QUFDSDs7QUFFRCxNQUFJLENBQUNELE9BQU8sQ0FBQ0csS0FBYixFQUFvQjtBQUNoQixVQUFNLElBQUlGLEtBQUosQ0FBVSxnQ0FBVixDQUFOO0FBQ0g7O0FBRUQsTUFBSSxDQUFDRCxPQUFPLENBQUNJLE9BQWIsRUFBc0I7QUFDbEIsVUFBTSxJQUFJSCxLQUFKLENBQVUsb0NBQVYsQ0FBTjtBQUNIOztBQUVELE1BQUksQ0FBQ04sQ0FBQyxDQUFDTyxhQUFGLENBQWdCRixPQUFPLENBQUNJLE9BQXhCLENBQUwsRUFBdUM7QUFDbkMsVUFBTSxJQUFJSCxLQUFKLENBQVUsZ0RBQVYsQ0FBTjtBQUNIOztBQUVESCxFQUFBQSxNQUFNLENBQUNPLFVBQVAsQ0FBa0JULFlBQWxCLEVBQWdDSSxPQUFoQyxFQUF5QyxJQUF6QyxFQUErQ00sSUFBL0MsQ0FBb0QsbUJBQXBELEVBQXlFLE1BQU07QUFDM0UsUUFBSSxDQUFDUixNQUFNLENBQUNTLFFBQVAsQ0FBZ0JQLE9BQU8sQ0FBQ0csS0FBeEIsQ0FBTCxFQUFxQztBQUNqQyxZQUFNLElBQUlGLEtBQUosQ0FBVSxZQUFZRCxPQUFPLENBQUNHLEtBQXBCLEdBQTRCLG1CQUF0QyxDQUFOO0FBQ0g7O0FBRUQsUUFBSUssU0FBUyxHQUFHVixNQUFNLENBQUNXLE1BQVAsQ0FBY1QsT0FBTyxDQUFDRyxLQUF0QixDQUFoQjtBQUNBLFFBQUlPLFNBQVMsR0FBRyxJQUFJQyxHQUFKLENBQVFDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjYixPQUFPLENBQUNJLE9BQXRCLENBQVIsQ0FBaEI7O0FBRUEsU0FBSyxJQUFJVSxNQUFULElBQW1CSixTQUFuQixFQUE4QjtBQUMxQixVQUFJSSxNQUFNLEtBQUssU0FBZixFQUEwQjtBQUUxQixVQUFJQyxTQUFTLEdBQUdmLE9BQU8sQ0FBQ0csS0FBUixHQUFnQixHQUFoQixHQUFzQlcsTUFBdEM7QUFDQWhCLE1BQUFBLE1BQU0sQ0FBQ2tCLFFBQVAsQ0FBZ0JELFNBQWhCLEVBQTJCUCxTQUEzQjtBQUNIO0FBQ0osR0FkRDtBQWdCSDs7QUFFRFMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckIsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBfID0gVXRpbC5fO1xuY29uc3QgRkVBVFVSRV9OQU1FID0gJ2kxOG4nO1xuXG4vKipcbiAqIEEgcnVsZSBzcGVjaWZpZXMgaW50ZXJuYXRpb25hbGl6YXRpb24uXG4gKiBAbW9kdWxlIEVudGl0eUZlYXR1cmVfSTE4blxuICovXG5cbi8qKlxuICogSW5pdGlhbGl6ZSB0aGUgZmVhdHVyZVxuICogQHBhcmFtIHtPb2xvbmdFbnRpdHl9IGVudGl0eSAtIEVudGl0eSB0byBhcHBseSB0aGlzIGZlYXR1cmVcbiAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gVHJhY2tpbmcgZmllbGQgb3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IG9wdGlvbnMuZmllbGQgLSBTdGF0ZSBmaWVsZCB0byBhcHBseSB0aGlzIGZlYXR1cmVcbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5sb2NhbGVzXSAtIFNwZWNpZnkgdGhlIGxvY2FsZSBtYXBwaW5nIHJ1bGVcbiAqL1xuZnVuY3Rpb24gZmVhdHVyZShlbnRpdHksIGFyZ3MgPSBbXSkge1xuICAgIGxldCBbIG9wdGlvbnMgXSA9IGFyZ3M7XG4gICAgXG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBmZWF0dXJlIG9wdGlvbnMhJyk7XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3Qob3B0aW9ucykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGZlYXR1cmUgb3B0aW9ucy4gUGxhaW4gb2JqZWN0IGV4cGVjdGVkIScpO1xuICAgIH1cblxuICAgIGlmICghb3B0aW9ucy5maWVsZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgZmllbGQgbmFtZSBpbiBvcHRpb25zIScpO1xuICAgIH1cblxuICAgIGlmICghb3B0aW9ucy5sb2NhbGVzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBsb2NhbGUgbWFwcGluZyBpbiBvcHRpb25zIScpO1xuICAgIH1cblxuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG9wdGlvbnMubG9jYWxlcykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGxvY2FsZSBtYXBwaW5nLiBQbGFpbiBvYmplY3QgZXhwZWN0ZWQhJyk7XG4gICAgfVxuXG4gICAgZW50aXR5LmFkZEZlYXR1cmUoRkVBVFVSRV9OQU1FLCBvcHRpb25zLCB0cnVlKS5vbmNlKCdhZnRlckFkZGluZ0ZpZWxkcycsICgpID0+IHtcbiAgICAgICAgaWYgKCFlbnRpdHkuaGFzRmllbGQob3B0aW9ucy5maWVsZCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmllbGQgXCInICsgb3B0aW9ucy5maWVsZCArICdcIiBkb2VzIG5vdCBleGlzdCEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmaWVsZEluZm8gPSBlbnRpdHkuZmllbGRzW29wdGlvbnMuZmllbGRdO1xuICAgICAgICBsZXQgc3VmZml4U2V0ID0gbmV3IFNldChPYmplY3QudmFsdWVzKG9wdGlvbnMubG9jYWxlcykpO1xuXG4gICAgICAgIGZvciAobGV0IHN1ZmZpeCBvZiBzdWZmaXhTZXQpIHtcbiAgICAgICAgICAgIGlmIChzdWZmaXggPT09ICdkZWZhdWx0JykgY29udGludWU7XG5cbiAgICAgICAgICAgIGxldCBmaWVsZE5hbWUgPSBvcHRpb25zLmZpZWxkICsgJ18nICsgc3VmZml4O1xuICAgICAgICAgICAgZW50aXR5LmFkZEZpZWxkKGZpZWxkTmFtZSwgZmllbGRJbmZvKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG59XG5cbm1vZHVsZS5leHBvcnRzID0gZmVhdHVyZTsiXX0=
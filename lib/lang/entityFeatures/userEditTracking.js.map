{"version":3,"sources":["../../../src/lang/entityFeatures/userEditTracking.js"],"names":["FEATURE_NAME","feature","entity","option","options","userEntity","uidSource","trackCreate","trackUpdate","revisionField","addFieldsOnly","userEntityName","migrationUser","linker","log","fields","info","associations","push","type","destEntity","srcField","fieldProps","readOnly","writeOnce","once","addField","default","optional","addFeature","module","exports"],"mappings":"AAAA;;;;AAEA,MAAMA,YAAY,GAAG,kBAArB;;AAYA,SAASC,OAAT,CAAiBC,MAAjB,EAAyB,CAACC,MAAD,CAAzB,EAAmC;AAC/B,QAAMC,OAAO,GAAG;AACZC,IAAAA,UAAU,EAAE,MADA;AAEZC,IAAAA,SAAS,EAAE,eAFC;AAGZC,IAAAA,WAAW,EAAE,WAHD;AAIZC,IAAAA,WAAW,EAAE,WAJD;AAKZC,IAAAA,aAAa,EAAE,UALH;AAMZC,IAAAA,aAAa,EAAE,KANH;AAOZ,OAAGP;AAPS,GAAhB;AAUA,QAAM;AACFE,IAAAA,UAAU,EAAEM,cADV;AAEFL,IAAAA,SAFE;AAGFC,IAAAA,WAHE;AAIFC,IAAAA,WAJE;AAKFC,IAAAA,aALE;AAMFC,IAAAA,aANE;AAOFE,IAAAA;AAPE,MAQFR,OARJ;;AAUA,MAAI,CAACG,WAAD,IAAgB,CAACC,WAArB,EAAkC;AAC9BN,IAAAA,MAAM,CAACW,MAAP,CAAcC,GAAd,CACI,MADJ,EAEI,mHAFJ;AAIA;AACH;;AAGD,QAAMC,MAAM,GAAG,EAAf;;AAEA,MAAIR,WAAJ,EAAiB;AACbQ,IAAAA,MAAM,CAAC,WAAD,CAAN,GAAsBR,WAAtB;AAEAL,IAAAA,MAAM,CAACc,IAAP,CAAYC,YAAZ,KAA6Bf,MAAM,CAACc,IAAP,CAAYC,YAAZ,GAA2B,EAAxD;AACAf,IAAAA,MAAM,CAACc,IAAP,CAAYC,YAAZ,CAAyBC,IAAzB,CAA8B;AAC1BC,MAAAA,IAAI,EAAE,UADoB;AAE1BC,MAAAA,UAAU,EAAET,cAFc;AAG1BU,MAAAA,QAAQ,EAAEd,WAHgB;AAI1Be,MAAAA,UAAU,EAAE;AACRC,QAAAA,QAAQ,EAAE,IADF;AAERC,QAAAA,SAAS,EAAE;AAFH;AAJc,KAA9B;AASH;;AAED,MAAIhB,WAAJ,EAAiB;AACbN,IAAAA,MAAM,CAACuB,IAAP,CAAY,mBAAZ,EAAiC,MAAM;AACnCvB,MAAAA,MAAM,CAACwB,QAAP,CAAgBjB,aAAhB,EAA+B;AAC3BU,QAAAA,IAAI,EAAE,SADqB;AAE3BQ,QAAAA,OAAO,EAAE;AAFkB,OAA/B;AAIH,KALD;AAOAZ,IAAAA,MAAM,CAAC,WAAD,CAAN,GAAsBP,WAAtB;AACAO,IAAAA,MAAM,CAAC,UAAD,CAAN,GAAqBN,aAArB;AAEAP,IAAAA,MAAM,CAACc,IAAP,CAAYC,YAAZ,KAA6Bf,MAAM,CAACc,IAAP,CAAYC,YAAZ,GAA2B,EAAxD;AACAf,IAAAA,MAAM,CAACc,IAAP,CAAYC,YAAZ,CAAyBC,IAAzB,CAA8B;AAC1BC,MAAAA,IAAI,EAAE,UADoB;AAE1BC,MAAAA,UAAU,EAAET,cAFc;AAG1BU,MAAAA,QAAQ,EAAEb,WAHgB;AAI1Bc,MAAAA,UAAU,EAAE;AACRC,QAAAA,QAAQ,EAAE,IADF;AAERK,QAAAA,QAAQ,EAAE;AAFF;AAJc,KAA9B;AASH;;AAED,MAAI,CAAClB,aAAL,EAAoB;AAChBR,IAAAA,MAAM,CAAC2B,UAAP,CAAkB7B,YAAlB,EAAgC;AAC5Be,MAAAA,MAD4B;AAE5BT,MAAAA,SAF4B;AAG5BM,MAAAA;AAH4B,KAAhC;AAKH;AACJ;;AAEDkB,MAAM,CAACC,OAAP,GAAiB9B,OAAjB","sourcesContent":["\"use strict\";\n\nconst FEATURE_NAME = \"userEditTracking\";\n\n/**\n * A rule specifies the entity to automatically record the creation time\n * @module EntityFeature_UserEditTracking\n */\n\n/**\n * Initialize the feature\n * @param {Entity} entity - Entity to apply this feature\n * @param {array} options - Field options\n */\nfunction feature(entity, [option]) {\n    const options = {\n        userEntity: \"user\",\n        uidSource: \"state.user.id\",\n        trackCreate: \"createdBy\",\n        trackUpdate: \"updatedBy\",\n        revisionField: \"revision\",\n        addFieldsOnly: false,\n        ...option,\n    };\n\n    const {\n        userEntity: userEntityName,\n        uidSource,\n        trackCreate,\n        trackUpdate,\n        revisionField,\n        addFieldsOnly,\n        migrationUser,\n    } = options;\n\n    if (!trackCreate && !trackUpdate) {\n        entity.linker.log(\n            \"warn\",\n            'Since both \"trackCreate\" and \"trackUpdate\" are disabled, the \"userEditTracking\" feature will not take any effect.'\n        );\n        return;\n    }\n\n    //todo: cross scheam support\n    const fields = {};\n\n    if (trackCreate) {\n        fields[\"createdBy\"] = trackCreate;\n\n        entity.info.associations || (entity.info.associations = []);\n        entity.info.associations.push({\n            type: \"refersTo\",\n            destEntity: userEntityName,\n            srcField: trackCreate,\n            fieldProps: {\n                readOnly: true,\n                writeOnce: true,\n            },\n        });\n    }\n\n    if (trackUpdate) {\n        entity.once(\"afterAddingFields\", () => {\n            entity.addField(revisionField, {\n                type: \"integer\",\n                default: 0,\n            });\n        });\n\n        fields[\"updatedBy\"] = trackUpdate;\n        fields[\"revision\"] = revisionField;\n\n        entity.info.associations || (entity.info.associations = []);\n        entity.info.associations.push({\n            type: \"refersTo\",\n            destEntity: userEntityName,\n            srcField: trackUpdate,\n            fieldProps: {\n                readOnly: true,\n                optional: true,\n            },\n        });\n    }\n\n    if (!addFieldsOnly) {\n        entity.addFeature(FEATURE_NAME, {\n            fields,\n            uidSource,\n            migrationUser,\n        });\n    }\n}\n\nmodule.exports = feature;\n"],"file":"userEditTracking.js"}
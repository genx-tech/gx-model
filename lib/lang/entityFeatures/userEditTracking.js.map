{"version":3,"file":"userEditTracking.js","names":["FEATURE_NAME","feature","entity","option","options","userEntity","uidSource","trackCreate","trackUpdate","revisionField","addFieldsOnly","userEntityName","migrationUser","linker","log","fields","info","associations","push","type","destEntity","srcField","fieldProps","readOnly","writeOnce","once","addField","default","optional","addFeature","module","exports"],"sources":["../../../src/lang/entityFeatures/userEditTracking.js"],"sourcesContent":["\"use strict\";\n\nconst FEATURE_NAME = \"userEditTracking\";\n\n/**\n * A rule specifies the entity to automatically record the creation time\n * @module EntityFeature_UserEditTracking\n */\n\n/**\n * Initialize the feature\n * @param {Entity} entity - Entity to apply this feature\n * @param {array} options - Field options\n */\nfunction feature(entity, [option]) {\n    const options = {\n        userEntity: \"user\",\n        uidSource: \"state.user.id\",\n        trackCreate: \"createdBy\",\n        trackUpdate: \"updatedBy\",\n        revisionField: \"revision\",\n        addFieldsOnly: false,\n        ...option,\n    };\n\n    const {\n        userEntity: userEntityName,\n        uidSource,\n        trackCreate,\n        trackUpdate,\n        revisionField,\n        addFieldsOnly,\n        migrationUser,\n    } = options;\n\n    if (!trackCreate && !trackUpdate) {\n        entity.linker.log(\n            \"warn\",\n            'Since both \"trackCreate\" and \"trackUpdate\" are disabled, the \"userEditTracking\" feature will not take any effect.'\n        );\n        return;\n    }\n\n    //todo: cross scheam support\n    const fields = {};\n\n    if (trackCreate) {\n        fields[\"createdBy\"] = trackCreate;\n\n        entity.info.associations || (entity.info.associations = []);\n        entity.info.associations.push({\n            type: \"refersTo\",\n            destEntity: userEntityName,\n            srcField: trackCreate,\n            fieldProps: {\n                readOnly: true,\n                writeOnce: true,\n            },\n        });\n    }\n\n    if (trackUpdate) {\n        entity.once(\"afterAddingFields\", () => {\n            entity.addField(revisionField, {\n                type: \"integer\",\n                default: 0,\n            });\n        });\n\n        fields[\"updatedBy\"] = trackUpdate;\n        fields[\"revision\"] = revisionField;\n\n        entity.info.associations || (entity.info.associations = []);\n        entity.info.associations.push({\n            type: \"refersTo\",\n            destEntity: userEntityName,\n            srcField: trackUpdate,\n            fieldProps: {\n                readOnly: true,\n                optional: true,\n            },\n        });\n    }\n\n    if (!addFieldsOnly) {\n        entity.addFeature(FEATURE_NAME, {\n            fields,\n            uidSource,\n            migrationUser,\n        });\n    }\n}\n\nmodule.exports = feature;\n"],"mappings":"AAAA;;;;AAEA,MAAMA,YAAY,GAAG,kBAArB;;AAYA,SAASC,OAAT,CAAiBC,MAAjB,EAAyB,CAACC,MAAD,CAAzB,EAAmC;EAC/B,MAAMC,OAAO,GAAG;IACZC,UAAU,EAAE,MADA;IAEZC,SAAS,EAAE,eAFC;IAGZC,WAAW,EAAE,WAHD;IAIZC,WAAW,EAAE,WAJD;IAKZC,aAAa,EAAE,UALH;IAMZC,aAAa,EAAE,KANH;IAOZ,GAAGP;EAPS,CAAhB;EAUA,MAAM;IACFE,UAAU,EAAEM,cADV;IAEFL,SAFE;IAGFC,WAHE;IAIFC,WAJE;IAKFC,aALE;IAMFC,aANE;IAOFE;EAPE,IAQFR,OARJ;;EAUA,IAAI,CAACG,WAAD,IAAgB,CAACC,WAArB,EAAkC;IAC9BN,MAAM,CAACW,MAAP,CAAcC,GAAd,CACI,MADJ,EAEI,mHAFJ;IAIA;EACH;;EAGD,MAAMC,MAAM,GAAG,EAAf;;EAEA,IAAIR,WAAJ,EAAiB;IACbQ,MAAM,CAAC,WAAD,CAAN,GAAsBR,WAAtB;IAEAL,MAAM,CAACc,IAAP,CAAYC,YAAZ,KAA6Bf,MAAM,CAACc,IAAP,CAAYC,YAAZ,GAA2B,EAAxD;IACAf,MAAM,CAACc,IAAP,CAAYC,YAAZ,CAAyBC,IAAzB,CAA8B;MAC1BC,IAAI,EAAE,UADoB;MAE1BC,UAAU,EAAET,cAFc;MAG1BU,QAAQ,EAAEd,WAHgB;MAI1Be,UAAU,EAAE;QACRC,QAAQ,EAAE,IADF;QAERC,SAAS,EAAE;MAFH;IAJc,CAA9B;EASH;;EAED,IAAIhB,WAAJ,EAAiB;IACbN,MAAM,CAACuB,IAAP,CAAY,mBAAZ,EAAiC,MAAM;MACnCvB,MAAM,CAACwB,QAAP,CAAgBjB,aAAhB,EAA+B;QAC3BU,IAAI,EAAE,SADqB;QAE3BQ,OAAO,EAAE;MAFkB,CAA/B;IAIH,CALD;IAOAZ,MAAM,CAAC,WAAD,CAAN,GAAsBP,WAAtB;IACAO,MAAM,CAAC,UAAD,CAAN,GAAqBN,aAArB;IAEAP,MAAM,CAACc,IAAP,CAAYC,YAAZ,KAA6Bf,MAAM,CAACc,IAAP,CAAYC,YAAZ,GAA2B,EAAxD;IACAf,MAAM,CAACc,IAAP,CAAYC,YAAZ,CAAyBC,IAAzB,CAA8B;MAC1BC,IAAI,EAAE,UADoB;MAE1BC,UAAU,EAAET,cAFc;MAG1BU,QAAQ,EAAEb,WAHgB;MAI1Bc,UAAU,EAAE;QACRC,QAAQ,EAAE,IADF;QAERK,QAAQ,EAAE;MAFF;IAJc,CAA9B;EASH;;EAED,IAAI,CAAClB,aAAL,EAAoB;IAChBR,MAAM,CAAC2B,UAAP,CAAkB7B,YAAlB,EAAgC;MAC5Be,MAD4B;MAE5BT,SAF4B;MAG5BM;IAH4B,CAAhC;EAKH;AACJ;;AAEDkB,MAAM,CAACC,OAAP,GAAiB9B,OAAjB"}
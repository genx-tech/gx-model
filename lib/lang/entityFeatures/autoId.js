"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const FEATURE_NAME = 'autoId';

function feature(entity, args = []) {
  let typeInfo = {
    name: 'id',
    type: 'integer',
    auto: true,
    writeOnce: true
  };
  let [options] = args;
  let featureExtra = {};

  if (options) {
    if (typeof options === 'string') {
      options = {
        name: options
      };
    }

    if (options.type) {
      switch (options.type) {
        case 'integer':
          if (options.startFrom) {
            featureExtra.startFrom = options.startFrom;
          }

          break;

        case 'uuid':
          typeInfo['type'] = 'text';
          typeInfo['fixedLength'] = 36;
          typeInfo['generator'] = 'uuid';
          break;

        case 'shortid':
          typeInfo['type'] = 'text';
          typeInfo['maxLength'] = 20;
          typeInfo['generator'] = 'shortid';
          break;

        case 'uniqid':
          typeInfo['type'] = 'text';

          if (options.prefix) {
            if (typeof options.prefix !== 'string') {
              throw new Error(`"prefix" option should be a string. Entity: ${entity.name}, feature: autoId`);
            }

            typeInfo['fixedLength'] = 17 + options.prefix.length;
            typeInfo['generator'] = ['uniqid', options.prefix];
          } else {
            typeInfo['fixedLength'] = 17;
            typeInfo['generator'] = 'uniqid';
          }

          break;

        case 'hyperid':
          typeInfo['type'] = 'text';
          typeInfo['fixedLength'] = 33;
          let args = ['hyperid'];
          let opt = {};

          if (options.fixedLength) {
            opt.fixedLength = options.fixedLength;
          }

          if (options.urlSafe) {
            opt.urlSafe = options.urlSafe;
          }

          if (!_.isEmpty(opt)) {
            args.push(opt);
          }

          typeInfo['generator'] = args.length > 1 ? args : args[0];
          break;

        default:
          throw new Error(`Unsupported autoId type: ${options.type}. Entity: ${entity.name}`);
      }
    } else {
      if (options.startFrom) {
        featureExtra.startFrom = options.startFrom;
      }
    }

    if (options.name) {
      typeInfo.name = options.name;
    }
  }

  let fieldName = typeInfo.name;
  entity.addFeature(FEATURE_NAME, {
    field: fieldName,
    ...featureExtra
  }).once('beforeAddingFields', () => {
    entity.addField(fieldName, typeInfo).setKey(fieldName);
  });
}

module.exports = feature;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW5nL2VudGl0eUZlYXR1cmVzL2F1dG9JZC5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkZFQVRVUkVfTkFNRSIsImZlYXR1cmUiLCJlbnRpdHkiLCJhcmdzIiwidHlwZUluZm8iLCJuYW1lIiwidHlwZSIsImF1dG8iLCJ3cml0ZU9uY2UiLCJvcHRpb25zIiwiZmVhdHVyZUV4dHJhIiwic3RhcnRGcm9tIiwicHJlZml4IiwiRXJyb3IiLCJsZW5ndGgiLCJvcHQiLCJmaXhlZExlbmd0aCIsInVybFNhZmUiLCJpc0VtcHR5IiwicHVzaCIsImZpZWxkTmFtZSIsImFkZEZlYXR1cmUiLCJmaWVsZCIsIm9uY2UiLCJhZGRGaWVsZCIsInNldEtleSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUVBLE1BQU1DLFlBQVksR0FBRyxRQUFyQjs7QUFjQSxTQUFTQyxPQUFULENBQWlCQyxNQUFqQixFQUF5QkMsSUFBSSxHQUFHLEVBQWhDLEVBQW9DO0FBQ2hDLE1BQUlDLFFBQVEsR0FBRztBQUNYQyxJQUFBQSxJQUFJLEVBQUUsSUFESztBQUVYQyxJQUFBQSxJQUFJLEVBQUUsU0FGSztBQUdYQyxJQUFBQSxJQUFJLEVBQUUsSUFISztBQUlYQyxJQUFBQSxTQUFTLEVBQUU7QUFKQSxHQUFmO0FBT0EsTUFBSSxDQUFFQyxPQUFGLElBQWNOLElBQWxCO0FBRUEsTUFBSU8sWUFBWSxHQUFHLEVBQW5COztBQUVBLE1BQUlELE9BQUosRUFBYTtBQUNULFFBQUksT0FBT0EsT0FBUCxLQUFtQixRQUF2QixFQUFpQztBQUM3QkEsTUFBQUEsT0FBTyxHQUFHO0FBQUVKLFFBQUFBLElBQUksRUFBRUk7QUFBUixPQUFWO0FBQ0g7O0FBRUQsUUFBSUEsT0FBTyxDQUFDSCxJQUFaLEVBQWtCO0FBQ2QsY0FBUUcsT0FBTyxDQUFD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QUFRLENBQUNDLElBQXpCO0FBRUFILEVBQUFBLE1BQU0sQ0FBQ21CLFVBQVAsQ0FBa0JyQixZQUFsQixFQUFnQztBQUM1QnNCLElBQUFBLEtBQUssRUFBRUYsU0FEcUI7QUFFNUIsT0FBR1Y7QUFGeUIsR0FBaEMsRUFHR2EsSUFISCxDQUdRLG9CQUhSLEVBRzhCLE1BQU07QUFDaENyQixJQUFBQSxNQUFNLENBQUNzQixRQUFQLENBQWdCSixTQUFoQixFQUEyQmhCLFFBQTNCLEVBQ0txQixNQURMLENBQ1lMLFNBRFo7QUFFSCxHQU5EO0FBT0g7O0FBRURNLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjFCLE9BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuY29uc3QgRkVBVFVSRV9OQU1FID0gJ2F1dG9JZCc7XG5cbi8qKlxuICogQSBydWxlIHNwZWNpZmllcyB0aGUgaWQgb2YgZW50aXR5IGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkLlxuICogQG1vZHVsZSBFbnRpdHlGZWF0dXJlX0F1dG9JZFxuICovXG5cbi8qKlxuICogSW5pdGlhbGl6ZSB0aGUgZmVhdHVyZVxuICogQHBhcmFtIHtPb2xvbmdFbnRpdHl9IGVudGl0eSAtIEVudGl0eSB0byBhcHBseSB0aGlzIGZlYXR1cmVcbiAqIEBwYXJhbSB7YXJyYXl9IG9wdGlvbnMgLSBBdXRvIGlkIGZpZWxkIG9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5uYW1lPSdpZCddIC0gRmllbGQgbmFtZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnR5cGU9J2ludGVnZXInXSAtIEZpZWxkIHR5cGVcbiAqL1xuZnVuY3Rpb24gZmVhdHVyZShlbnRpdHksIGFyZ3MgPSBbXSkge1xuICAgIGxldCB0eXBlSW5mbyA9IHtcbiAgICAgICAgbmFtZTogJ2lkJyxcbiAgICAgICAgdHlwZTogJ2ludGVnZXInLFxuICAgICAgICBhdXRvOiB0cnVlLCAgICAgICAgXG4gICAgICAgIHdyaXRlT25jZTogdHJ1ZVxuICAgIH07XG5cbiAgICBsZXQgWyBvcHRpb25zIF0gPSBhcmdzO1xuXG4gICAgbGV0IGZlYXR1cmVFeHRyYSA9IHt9O1xuXG4gICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgb3B0aW9ucyA9IHsgbmFtZTogb3B0aW9ucyB9O1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBpZiAob3B0aW9ucy50eXBlKSB7XG4gICAgICAgICAgICBzd2l0Y2ggKG9wdGlvbnMudHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ2ludGVnZXInOlxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdGFydEZyb20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmVFeHRyYS5zdGFydEZyb20gPSBvcHRpb25zLnN0YXJ0RnJvbTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAndXVpZCc6XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWyd0eXBlJ10gPSAndGV4dCc7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWydmaXhlZExlbmd0aCddID0gMzY7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWydnZW5lcmF0b3InXSA9ICd1dWlkJztcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgIGNhc2UgJ3Nob3J0aWQnOlxuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mb1sndHlwZSddID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mb1snbWF4TGVuZ3RoJ10gPSAyMDtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ2dlbmVyYXRvciddID0gJ3Nob3J0aWQnO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAndW5pcWlkJzpcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ3R5cGUnXSA9ICd0ZXh0JzsgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnByZWZpeCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFwicHJlZml4XCIgb3B0aW9uIHNob3VsZCBiZSBhIHN0cmluZy4gRW50aXR5OiAke2VudGl0eS5uYW1lfSwgZmVhdHVyZTogYXV0b0lkYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9ICAgIFxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlSW5mb1snZml4ZWRMZW5ndGgnXSA9IDE3ICsgb3B0aW9ucy5wcmVmaXgubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ2dlbmVyYXRvciddID0gWyAndW5pcWlkJywgb3B0aW9ucy5wcmVmaXggXTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWydmaXhlZExlbmd0aCddID0gMTc7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlSW5mb1snZ2VuZXJhdG9yJ10gPSAndW5pcWlkJztcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICBjYXNlICdoeXBlcmlkJzpcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ3R5cGUnXSA9ICd0ZXh0JzsgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mb1snZml4ZWRMZW5ndGgnXSA9IDMzO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBhcmdzID0gWyAnaHlwZXJpZCcgXTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9wdCA9IHt9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmZpeGVkTGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHQuZml4ZWRMZW5ndGggPSBvcHRpb25zLmZpeGVkTGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMudXJsU2FmZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LnVybFNhZmUgPSBvcHRpb25zLnVybFNhZmU7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShvcHQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2gob3B0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWydnZW5lcmF0b3InXSA9IGFyZ3MubGVuZ3RoID4gMSA/IGFyZ3MgOiBhcmdzWzBdO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBhdXRvSWQgdHlwZTogJHtvcHRpb25zLnR5cGV9LiBFbnRpdHk6ICR7ZW50aXR5Lm5hbWV9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5zdGFydEZyb20pIHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlRXh0cmEuc3RhcnRGcm9tID0gb3B0aW9ucy5zdGFydEZyb207XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICBpZiAob3B0aW9ucy5uYW1lKSB7XG4gICAgICAgICAgICB0eXBlSW5mby5uYW1lID0gb3B0aW9ucy5uYW1lO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGZpZWxkTmFtZSA9IHR5cGVJbmZvLm5hbWU7XG5cbiAgICBlbnRpdHkuYWRkRmVhdHVyZShGRUFUVVJFX05BTUUsIHtcbiAgICAgICAgZmllbGQ6IGZpZWxkTmFtZSxcbiAgICAgICAgLi4uZmVhdHVyZUV4dHJhICAgICAgICBcbiAgICB9KS5vbmNlKCdiZWZvcmVBZGRpbmdGaWVsZHMnLCAoKSA9PiB7XG4gICAgICAgIGVudGl0eS5hZGRGaWVsZChmaWVsZE5hbWUsIHR5cGVJbmZvKVxuICAgICAgICAgICAgLnNldEtleShmaWVsZE5hbWUpO1xuICAgIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGZlYXR1cmU7Il19
{"version":3,"file":"logicalDeletion.js","names":["_","require","FEATURE_NAME","feature","entity","args","newField","fieldInfo","name","type","readOnly","fieldName","featureSetting","options","isPlainObject","keys","Object","length","Error","field","value","assign","timestampFieldName","deletedTimestamp","optional","writeOnce","auto","addFeature","timestampField","once","addField","hasField","module","exports"],"sources":["../../../src/lang/entityFeatures/logicalDeletion.js"],"sourcesContent":["\"use strict\";\n\nconst { _ } = require('@genx/july')\n\nconst FEATURE_NAME = 'logicalDeletion';\n\n/**\n * A rule specifies the entity will not be deleted physically.\n * @module EntityFeature_LogicalDeletion\n */\n\n/**\n * Initialize the feature\n * @param {Entity} entity - Entity to apply this feature\n * @param {object} options - Field options, can be a string as a new status field or an object reference to a certain status of an existing field\n */\nfunction feature(entity, args = []) {\n    let newField = true, fieldInfo = {\n        name: 'isDeleted',\n        type: 'boolean',\n        'default': false,\n        readOnly: true\n    }, fieldName, featureSetting;\n\n    let [ options ] = args;\n\n    if (options) {\n        if (_.isPlainObject(options)) {\n            newField = false;\n\n            let keys = Object.keys(options);\n            if (keys.length !== 1) {\n                throw new Error(`Invalid options for feature \"${FEATURE_NAME}\".`);\n            }\n\n            let fieldName = keys[0];\n\n            featureSetting = {\n                field: fieldName,\n                value: options[fieldName]\n            };\n\n        } else if (typeof options === 'string') {\n            Object.assign(fieldInfo, { name: options });\n        } else {\n            throw new Error(`Invalid options for feature \"${FEATURE_NAME}\".`);\n        }\n    }\n\n    if (newField) {\n        fieldName = fieldInfo.name;\n\n        let timestampFieldName = 'deletedAt';\n        let deletedTimestamp = {\n            type: 'datetime',\n            readOnly: true,\n            optional: true,\n            writeOnce: true,\n            auto: true\n        };\n\n        entity.addFeature(FEATURE_NAME, {\n            field: fieldName,\n            value: true,\n            timestampField: timestampFieldName\n        });\n\n        entity.once('afterAddingFields', () => {\n            entity.addField(fieldName, fieldInfo);\n            entity.addField(timestampFieldName, deletedTimestamp);\n        });\n    } else {\n        entity.addFeature(FEATURE_NAME, featureSetting);\n\n        entity.once('afterAddingFields', () => {\n            if (!entity.hasField(featureSetting.field)) {\n                throw new Error(`Field \"${featureSetting.field}\" used by feature \"${FEATURE_NAME}\" is not found in entity \"${entity.name}\".`);\n            }\n        });\n    }\n}\n\nmodule.exports = feature;"],"mappings":"AAAA;;;;AAEA,MAAM;EAAEA;AAAF,IAAQC,OAAO,CAAC,YAAD,CAArB;;AAEA,MAAMC,YAAY,GAAG,iBAArB;;AAYA,SAASC,OAAT,CAAiBC,MAAjB,EAAyBC,IAAI,GAAG,EAAhC,EAAoC;EAChC,IAAIC,QAAQ,GAAG,IAAf;EAAA,IAAqBC,SAAS,GAAG;IAC7BC,IAAI,EAAE,WADuB;IAE7BC,IAAI,EAAE,SAFuB;IAG7B,WAAW,KAHkB;IAI7BC,QAAQ,EAAE;EAJmB,CAAjC;EAAA,IAKGC,SALH;EAAA,IAKcC,cALd;EAOA,IAAI,CAAEC,OAAF,IAAcR,IAAlB;;EAEA,IAAIQ,OAAJ,EAAa;IACT,IAAIb,CAAC,CAACc,aAAF,CAAgBD,OAAhB,CAAJ,EAA8B;MAC1BP,QAAQ,GAAG,KAAX;MAEA,IAAIS,IAAI,GAAGC,MAAM,CAACD,IAAP,CAAYF,OAAZ,CAAX;;MACA,IAAIE,IAAI,CAACE,MAAL,KAAgB,CAApB,EAAuB;QACnB,MAAM,IAAIC,KAAJ,CAAW,gCAA+BhB,YAAa,IAAvD,CAAN;MACH;;MAED,IAAIS,SAAS,GAAGI,IAAI,CAAC,CAAD,CAApB;MAEAH,cAAc,GAAG;QACbO,KAAK,EAAER,SADM;QAEbS,KAAK,EAAEP,OAAO,CAACF,SAAD;MAFD,CAAjB;IAKH,CAfD,MAeO,IAAI,OAAOE,OAAP,KAAmB,QAAvB,EAAiC;MACpCG,MAAM,CAACK,MAAP,CAAcd,SAAd,EAAyB;QAAEC,IAAI,EAAEK;MAAR,CAAzB;IACH,CAFM,MAEA;MACH,MAAM,IAAIK,KAAJ,CAAW,gCAA+BhB,YAAa,IAAvD,CAAN;IACH;EACJ;;EAED,IAAII,QAAJ,EAAc;IACVK,SAAS,GAAGJ,SAAS,CAACC,IAAtB;IAEA,IAAIc,kBAAkB,GAAG,WAAzB;IACA,IAAIC,gBAAgB,GAAG;MACnBd,IAAI,EAAE,UADa;MAEnBC,QAAQ,EAAE,IAFS;MAGnBc,QAAQ,EAAE,IAHS;MAInBC,SAAS,EAAE,IAJQ;MAKnBC,IAAI,EAAE;IALa,CAAvB;IAQAtB,MAAM,CAACuB,UAAP,CAAkBzB,YAAlB,EAAgC;MAC5BiB,KAAK,EAAER,SADqB;MAE5BS,KAAK,EAAE,IAFqB;MAG5BQ,cAAc,EAAEN;IAHY,CAAhC;IAMAlB,MAAM,CAACyB,IAAP,CAAY,mBAAZ,EAAiC,MAAM;MACnCzB,MAAM,CAAC0B,QAAP,CAAgBnB,SAAhB,EAA2BJ,SAA3B;MACAH,MAAM,CAAC0B,QAAP,CAAgBR,kBAAhB,EAAoCC,gBAApC;IACH,CAHD;EAIH,CAtBD,MAsBO;IACHnB,MAAM,CAACuB,UAAP,CAAkBzB,YAAlB,EAAgCU,cAAhC;IAEAR,MAAM,CAACyB,IAAP,CAAY,mBAAZ,EAAiC,MAAM;MACnC,IAAI,CAACzB,MAAM,CAAC2B,QAAP,CAAgBnB,cAAc,CAACO,KAA/B,CAAL,EAA4C;QACxC,MAAM,IAAID,KAAJ,CAAW,UAASN,cAAc,CAACO,KAAM,sBAAqBjB,YAAa,6BAA4BE,MAAM,CAACI,IAAK,IAAnH,CAAN;MACH;IACJ,CAJD;EAKH;AACJ;;AAEDwB,MAAM,CAACC,OAAP,GAAiB9B,OAAjB"}
{"version":3,"sources":["../../../src/lang/entityFeatures/stateTracking.js"],"names":["naming","require","FEATURE_NAME","FIELD_NAME_SUFFIX","timestampFieldNaming","field","state","pascalCase","feature","entity","args","options","Error","stateSetTimestamp","type","optional","auto","reversible","writeOnce","once","hasField","fieldInfo","fields","stateMapping","values","forEach","fieldName","addField","addFeature","module","exports"],"mappings":"AAAA;;;;AAEA,MAAM;AAAEA,EAAAA;AAAF,IAAaC,OAAO,CAAC,YAAD,CAA1B;;AAEA,MAAMC,YAAY,GAAG,eAArB;AAEA,MAAMC,iBAAiB,GAAG,WAA1B;;AAEA,SAASC,oBAAT,CAA8BC,KAA9B,EAAqCC,KAArC,EAA4C;AACxC,SAAOD,KAAK,GAAGL,MAAM,CAACO,UAAP,CAAkBD,KAAlB,CAAR,GAAmCH,iBAA1C;AACH;;AAcD,SAASK,OAAT,CAAiBC,MAAjB,EAAyBC,IAAI,GAAG,EAAhC,EAAoC;AAChC,MAAI,CAAEC,OAAF,IAAcD,IAAlB;;AAEA,MAAI,CAACC,OAAL,EAAc;AACV,UAAM,IAAIC,KAAJ,CAAU,wBAAV,CAAN;AACH;;AAED,MAAI,OAAOD,OAAP,KAAmB,QAAvB,EAAiC;AAC7BA,IAAAA,OAAO,GAAG;AAAEN,MAAAA,KAAK,EAAEM;AAAT,KAAV;AACH;;AAED,MAAI,CAACA,OAAO,CAACN,KAAb,EAAoB;AAChB,UAAM,IAAIO,KAAJ,CAAU,gCAAV,CAAN;AACH;;AAED,MAAIC,iBAAiB,GAAG;AACpBC,IAAAA,IAAI,EAAE,UADc;AAEpBC,IAAAA,QAAQ,EAAE,IAFU;AAGpBC,IAAAA,IAAI,EAAE;AAHc,GAAxB;;AAMA,MAAI,CAACL,OAAO,CAACM,UAAb,EAAyB;AACrBJ,IAAAA,iBAAiB,CAACK,SAAlB,GAA8B,IAA9B;AACH;;AAEDT,EAAAA,MAAM,CAACU,IAAP,CAAY,mBAAZ,EAAiC,MAAM;AACnC,QAAI,CAACV,MAAM,CAACW,QAAP,CAAgBT,OAAO,CAACN,KAAxB,CAAL,EAAqC;AACjC,YAAM,IAAIO,KAAJ,CAAU,YAAYD,OAAO,CAACN,KAApB,GAA4B,mBAAtC,CAAN;AACH;;AAED,QAAIgB,SAAS,GAAGZ,MAAM,CAACa,MAAP,CAAcX,OAAO,CAACN,KAAtB,CAAhB;;AAEA,QAAIgB,SAAS,CAACP,IAAV,KAAmB,MAAvB,EAA+B;AAC3B,YAAM,IAAIF,KAAJ,CAAU,yDAAV,CAAN;AACH;;AAED,QAAIW,YAAY,GAAG,EAAnB;AAEAF,IAAAA,SAAS,CAACG,MAAV,CAAiBC,OAAjB,CAAyBnB,KAAK,IAAI;AAC9B,UAAIoB,SAAS,GAAGtB,oBAAoB,CAACO,OAAO,CAACN,KAAT,EAAgBC,KAAhB,CAApC;AAEAG,MAAAA,MAAM,CAACkB,QAAP,CAAgBD,SAAhB,EAA2Bb,iBAA3B;AACAU,MAAAA,YAAY,CAACjB,KAAD,CAAZ,GAAsBoB,SAAtB;AACH,KALD;AAOAjB,IAAAA,MAAM,CAACmB,UAAP,CAAkB1B,YAAlB,EAAgC;AAC5BG,MAAAA,KAAK,EAAEM,OAAO,CAACN,KADa;AAE5BkB,MAAAA;AAF4B,KAAhC,EAGG,IAHH;AAIH,GAxBD;AAyBH;;AAEDM,MAAM,CAACC,OAAP,GAAiBtB,OAAjB","sourcesContent":["\"use strict\";\n\nconst { naming } = require('@genx/july');\n\nconst FEATURE_NAME = 'stateTracking';\n\nconst FIELD_NAME_SUFFIX = 'Timestamp';\n\nfunction timestampFieldNaming(field, state) {\n    return field + naming.pascalCase(state) + FIELD_NAME_SUFFIX;\n}\n\n/**\n * A rule specifies the change of state will be tracked automatically.\n * @module EntityFeature_StateTracking\n */\n\n/**\n * Initialize the feature\n * @param {OolongEntity} entity - Entity to apply this feature\n * @param {object} options - Tracking field options\n * @property {string} options.field - State field to track\n * @property {bool} [options.reversible=false] - Specify whether the field can be set to a previous state again\n */\nfunction feature(entity, args = []) {\n    let [ options ] = args;\n    \n    if (!options) {\n        throw new Error('Missing field options!');\n    }\n\n    if (typeof options === 'string') {\n        options = { field: options };\n    }\n\n    if (!options.field) {\n        throw new Error('Missing field name in options!');\n    }\n\n    let stateSetTimestamp = {\n        type: 'datetime',\n        optional: true,\n        auto: true\n    };\n\n    if (!options.reversible) {\n        stateSetTimestamp.writeOnce = true;\n    }\n\n    entity.once('afterAddingFields', () => {\n        if (!entity.hasField(options.field)) {\n            throw new Error('Field \"' + options.field + '\" does not exist!');\n        }\n\n        let fieldInfo = entity.fields[options.field];\n\n        if (fieldInfo.type !== 'enum') {\n            throw new Error('Only enum field can be used with stateTracking feature!');\n        }\n\n        let stateMapping = {};\n\n        fieldInfo.values.forEach(state => {\n            let fieldName = timestampFieldNaming(options.field, state);\n\n            entity.addField(fieldName, stateSetTimestamp);\n            stateMapping[state] = fieldName;\n        });\n\n        entity.addFeature(FEATURE_NAME, {\n            field: options.field,\n            stateMapping\n        }, true);\n    });\n}\n\nmodule.exports = feature;"],"file":"stateTracking.js"}
"use strict";

require("source-map-support/register");

const FEATURE_NAME = 'userEditTracking';

function feature(entity, args) {
  const options = {
    userEntity: 'user.id',
    uidSource: 'state.user.id',
    trackCreate: 'createdBy',
    trackUpdate: 'updatedBy',
    revisionField: 'revision',
    addFieldsOnly: false,
    ...args[0]
  };
  const {
    userField: userFieldRef,
    uidSource,
    trackCreate,
    trackUpdate,
    revisionField,
    addFieldsOnly
  } = options;

  if (!trackCreate && !trackUpdate) {
    entity.linker.log('warn', 'Since both "trackCreate" and "trackUpdate" are disabled, the "userEditTracking" feature will not take any effect.');
    return;
  }

  const [userEntityName, userIdField] = userFieldRef.split('.');
  const userEntity = entity.getReferencedEntity(userEntityName);
  const uidField = userIdField == null ? userEntity.getEntityAttribute('$key') : userEntity.getEntityAttribute(userIdField);
  const fields = {};

  if (trackCreate) {
    const typeInfo = {
      name: trackCreate,
      type: uidField.type,
      readOnly: true,
      writeOnce: true
    };
    entity.on('afterAddingFields', () => {
      entity.addField(typeInfo.name, typeInfo);
    });
    fields['createdBy'] = trackCreate;
  }

  if (trackUpdate) {
    const typeInfo = {
      name: trackUpdate,
      type: uidField.type,
      readOnly: true
    };
    entity.on('afterAddingFields', () => {
      entity.addField(typeInfo.name, typeInfo);
      entity.addField(revisionField, {
        type: 'integer',
        readOnly: true
      });
    });
    fields['updatedBy'] = trackUpdate;
    fields['revision'] = revisionField;
  }

  if (!addFieldsOnly) {
    entity.addFeature(FEATURE_NAME, {
      fields,
      uidSource
    });
  }
}

module.exports = feature;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW5nL2VudGl0eUZlYXR1cmVzL3VzZXJFZGl0VHJhY2tpbmcuanMiXSwibmFtZXMiOlsiRkVBVFVSRV9OQU1FIiwiZmVhdHVyZSIsImVudGl0eSIsImFyZ3MiLCJvcHRpb25zIiwidXNlckVudGl0eSIsInVpZFNvdXJjZSIsInRyYWNrQ3JlYXRlIiwidHJhY2tVcGRhdGUiLCJyZXZpc2lvbkZpZWxkIiwiYWRkRmllbGRzT25seSIsInVzZXJGaWVsZCIsInVzZXJGaWVsZFJlZiIsImxpbmtlciIsImxvZyIsInVzZXJFbnRpdHlOYW1lIiwidXNlcklkRmllbGQiLCJzcGxpdCIsImdldFJlZmVyZW5jZWRFbnRpdHkiLCJ1aWRGaWVsZCIsImdldEVudGl0eUF0dHJpYnV0ZSIsImZpZWxkcyIsInR5cGVJbmZvIiwibmFtZSIsInR5cGUiLCJyZWFkT25seSIsIndyaXRlT25jZSIsIm9uIiwiYWRkRmllbGQiLCJhZGRGZWF0dXJlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxZQUFZLEdBQUcsa0JBQXJCOztBQVlBLFNBQVNDLE9BQVQsQ0FBaUJDLE1BQWpCLEVBQXlCQyxJQUF6QixFQUErQjtBQUMzQixRQUFNQyxPQUFPLEdBQUc7QUFDWkMsSUFBQUEsVUFBVSxFQUFFLFNBREE7QUFFWkMsSUFBQUEsU0FBUyxFQUFFLGVBRkM7QUFHWkMsSUFBQUEsV0FBVyxFQUFFLFdBSEQ7QUFJWkMsSUFBQUEsV0FBVyxFQUFFLFdBSkQ7QUFLWkMsSUFBQUEsYUFBYSxFQUFFLFVBTEg7QUFNWkMsSUFBQUEsYUFBYSxFQUFFLEtBTkg7QUFPWixPQUFHUCxJQUFJLENBQUMsQ0FBRDtBQVBLLEdBQWhCO0FBVUEsUUFBTTtBQUNGUSxJQUFBQSxTQUFTLEVBQUVDLFlBRFQ7QUFFRk4sSUFBQUEsU0FGRTtBQUdGQyxJQUFBQSxXQUhFO0FBSUZDLElBQUFBLFdBSkU7QUFLRkMsSUFBQUEsYUFMRTtBQU1GQyxJQUFBQTtBQU5FLE1BT0ZOLE9BUEo7O0FBU0EsTUFBSSxDQUFDRyxXQUFELElBQWdCLENBQUNDLFdBQXJCLEVBQWtDO0FBQzlCTixJQUFBQSxNQUFNLENBQUNXLE1BQVAsQ0FBY0MsR0FBZCxDQUFrQixNQUFsQixFQUEwQixtSEFBMUI7QUFDQTtBQUNIOztBQUdELFFBQU0sQ0FBRUMsY0FBRixFQUFrQkMsV0FBbEIsSUFBa0NKLFlBQVksQ0FBQ0ssS0FBYixDQUFtQixHQUFuQixDQUF4QztBQUVBLFFBQU1aLFVBQVUsR0FBR0gsTUFBTSxDQUFDZ0IsbUJBQVAsQ0FBMkJILGNBQTNCLENBQW5CO0FBQ0EsUUFBTUksUUFBUSxHQUFHSCxXQUFXLElBQUksSUFBZixHQUFzQlgsVUFBVSxDQUFDZSxrQkFBWCxDQUE4QixNQUE5QixDQUF0QixHQUE4RGYsVUFBVSxDQUFDZSxrQkFBWCxDQUE4QkosV0FBOUIsQ0FBL0U7QUFFQSxRQUFNSyxNQUFNLEdBQUcsRUFBZjs7QUFFQSxNQUFJZCxXQUFKLEVBQWlCO0FBQ2IsVUFBTWUsUUFBUSxHQUFHO0FBQ2JDLE1BQUFBLElBQUksRUFBRWhCLFdBRE87QUFFYmlCLE1BQUFBLElBQUksRUFBRUwsUUFBUSxDQUFDSyxJQUZGO0FBR2JDLE1BQUFBLFFBQVEsRUFBRSxJQUhHO0FBSWJDLE1BQUFBLFNBQVMsRUFBRTtBQUpFLEtBQWpCO0FBT0F4QixJQUFBQSxNQUFNLENBQUN5QixFQUFQLENBQVUsbUJBQVYsRUFBK0IsTUFBTTtBQUNqQ3pCLE1BQUFBLE1BQU0sQ0FBQzBCLFFBQVAsQ0FBZ0JOLFFBQVEsQ0FBQ0MsSUFBekIsRUFBK0JELFFBQS9CO0FBQ0gsS0FGRDtBQUlBRCxJQUFBQSxNQUFNLENBQUMsV0FBRCxDQUFOLEdBQXNCZCxXQUF0QjtBQUNIOztBQUVELE1BQUlDLFdBQUosRUFBaUI7QUFDYixVQUFNYyxRQUFRLEdBQUc7QUFDYkMsTUFBQUEsSUFBSSxFQUFFZixXQURPO0FBRWJnQixNQUFBQSxJQUFJLEVBQUVMLFFBQVEsQ0FBQ0ssSUFGRjtBQUdiQyxNQUFBQSxRQUFRLEVBQUU7QUFIRyxLQUFqQjtBQU1BdkIsSUFBQUEsTUFBTSxDQUFDeUIsRUFBUCxDQUFVLG1CQUFWLEVBQStCLE1BQU07QUFDakN6QixNQUFBQSxNQUFNLENBQUMwQixRQUFQLENBQWdCTixRQUFRLENBQUNDLElBQXpCLEVBQStCRCxRQUEvQjtBQUNBcEIsTUFBQUEsTUFBTSxDQUFDMEIsUUFBUCxDQUFnQm5CLGFBQWhCLEVBQStCO0FBQzNCZSxRQUFBQSxJQUFJLEVBQUUsU0FEcUI7QUFFM0JDLFFBQUFBLFFBQVEsRUFBRTtBQUZpQixPQUEvQjtBQUlILEtBTkQ7QUFRQUosSUFBQUEsTUFBTSxDQUFDLFdBQUQsQ0FBTixHQUFzQmIsV0FBdEI7QUFDQWEsSUFBQUEsTUFBTSxDQUFDLFVBQUQsQ0FBTixHQUFxQlosYUFBckI7QUFDSDs7QUFFRCxNQUFJLENBQUNDLGFBQUwsRUFBb0I7QUFDaEJSLElBQUFBLE1BQU0sQ0FBQzJCLFVBQVAsQ0FBa0I3QixZQUFsQixFQUFnQztBQUM1QnFCLE1BQUFBLE1BRDRCO0FBRTVCZixNQUFBQTtBQUY0QixLQUFoQztBQUlIO0FBQ0o7O0FBRUR3QixNQUFNLENBQUNDLE9BQVAsR0FBaUI5QixPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBGRUFUVVJFX05BTUUgPSAndXNlckVkaXRUcmFja2luZyc7XG5cbi8qKlxuICogQSBydWxlIHNwZWNpZmllcyB0aGUgZW50aXR5IHRvIGF1dG9tYXRpY2FsbHkgcmVjb3JkIHRoZSBjcmVhdGlvbiB0aW1lXG4gKiBAbW9kdWxlIEVudGl0eUZlYXR1cmVfVXNlckVkaXRUcmFja2luZ1xuICovXG5cbi8qKlxuICogSW5pdGlhbGl6ZSB0aGUgZmVhdHVyZVxuICogQHBhcmFtIHtPb2xvbmdFbnRpdHl9IGVudGl0eSAtIEVudGl0eSB0byBhcHBseSB0aGlzIGZlYXR1cmVcbiAqIEBwYXJhbSB7YXJyYXl9IG9wdGlvbnMgLSBGaWVsZCBvcHRpb25zXG4gKi9cbmZ1bmN0aW9uIGZlYXR1cmUoZW50aXR5LCBhcmdzKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgdXNlckVudGl0eTogJ3VzZXIuaWQnLFxuICAgICAgICB1aWRTb3VyY2U6ICdzdGF0ZS51c2VyLmlkJyxcbiAgICAgICAgdHJhY2tDcmVhdGU6ICdjcmVhdGVkQnknLFxuICAgICAgICB0cmFja1VwZGF0ZTogJ3VwZGF0ZWRCeScsIFxuICAgICAgICByZXZpc2lvbkZpZWxkOiAncmV2aXNpb24nLCAgICAgICBcbiAgICAgICAgYWRkRmllbGRzT25seTogZmFsc2UsXG4gICAgICAgIC4uLmFyZ3NbMF1cbiAgICB9O1xuXG4gICAgY29uc3Qge1xuICAgICAgICB1c2VyRmllbGQ6IHVzZXJGaWVsZFJlZixcbiAgICAgICAgdWlkU291cmNlLFxuICAgICAgICB0cmFja0NyZWF0ZSxcbiAgICAgICAgdHJhY2tVcGRhdGUsXG4gICAgICAgIHJldmlzaW9uRmllbGQsXG4gICAgICAgIGFkZEZpZWxkc09ubHksXG4gICAgfSA9IG9wdGlvbnM7ICAgIFxuXG4gICAgaWYgKCF0cmFja0NyZWF0ZSAmJiAhdHJhY2tVcGRhdGUpIHtcbiAgICAgICAgZW50aXR5Lmxpbmtlci5sb2coJ3dhcm4nLCAnU2luY2UgYm90aCBcInRyYWNrQ3JlYXRlXCIgYW5kIFwidHJhY2tVcGRhdGVcIiBhcmUgZGlzYWJsZWQsIHRoZSBcInVzZXJFZGl0VHJhY2tpbmdcIiBmZWF0dXJlIHdpbGwgbm90IHRha2UgYW55IGVmZmVjdC4nKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vdG9kbzogY3Jvc3Mgc2NoZWFtIHN1cHBvcnRcbiAgICBjb25zdCBbIHVzZXJFbnRpdHlOYW1lLCB1c2VySWRGaWVsZCBdID0gdXNlckZpZWxkUmVmLnNwbGl0KCcuJyk7XG5cbiAgICBjb25zdCB1c2VyRW50aXR5ID0gZW50aXR5LmdldFJlZmVyZW5jZWRFbnRpdHkodXNlckVudGl0eU5hbWUpO1xuICAgIGNvbnN0IHVpZEZpZWxkID0gdXNlcklkRmllbGQgPT0gbnVsbCA/IHVzZXJFbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKCcka2V5JykgOiB1c2VyRW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZSh1c2VySWRGaWVsZCk7XG5cbiAgICBjb25zdCBmaWVsZHMgPSB7fTtcblxuICAgIGlmICh0cmFja0NyZWF0ZSkge1xuICAgICAgICBjb25zdCB0eXBlSW5mbyA9IHtcbiAgICAgICAgICAgIG5hbWU6IHRyYWNrQ3JlYXRlLFxuICAgICAgICAgICAgdHlwZTogdWlkRmllbGQudHlwZSxcbiAgICAgICAgICAgIHJlYWRPbmx5OiB0cnVlLFxuICAgICAgICAgICAgd3JpdGVPbmNlOiB0cnVlXG4gICAgICAgIH07XG5cbiAgICAgICAgZW50aXR5Lm9uKCdhZnRlckFkZGluZ0ZpZWxkcycsICgpID0+IHtcbiAgICAgICAgICAgIGVudGl0eS5hZGRGaWVsZCh0eXBlSW5mby5uYW1lLCB0eXBlSW5mbyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZpZWxkc1snY3JlYXRlZEJ5J10gPSB0cmFja0NyZWF0ZTtcbiAgICB9XG5cbiAgICBpZiAodHJhY2tVcGRhdGUpIHtcbiAgICAgICAgY29uc3QgdHlwZUluZm8gPSB7XG4gICAgICAgICAgICBuYW1lOiB0cmFja1VwZGF0ZSxcbiAgICAgICAgICAgIHR5cGU6IHVpZEZpZWxkLnR5cGUsXG4gICAgICAgICAgICByZWFkT25seTogdHJ1ZVxuICAgICAgICB9O1xuXG4gICAgICAgIGVudGl0eS5vbignYWZ0ZXJBZGRpbmdGaWVsZHMnLCAoKSA9PiB7XG4gICAgICAgICAgICBlbnRpdHkuYWRkRmllbGQodHlwZUluZm8ubmFtZSwgdHlwZUluZm8pO1xuICAgICAgICAgICAgZW50aXR5LmFkZEZpZWxkKHJldmlzaW9uRmllbGQsIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnaW50ZWdlcicsXG4gICAgICAgICAgICAgICAgcmVhZE9ubHk6IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBmaWVsZHNbJ3VwZGF0ZWRCeSddID0gdHJhY2tVcGRhdGU7XG4gICAgICAgIGZpZWxkc1sncmV2aXNpb24nXSA9IHJldmlzaW9uRmllbGQ7XG4gICAgfVxuXG4gICAgaWYgKCFhZGRGaWVsZHNPbmx5KSB7XG4gICAgICAgIGVudGl0eS5hZGRGZWF0dXJlKEZFQVRVUkVfTkFNRSwge1xuICAgICAgICAgICAgZmllbGRzLFxuICAgICAgICAgICAgdWlkU291cmNlXG4gICAgICAgIH0pOyAgICBcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZmVhdHVyZTsiXX0=
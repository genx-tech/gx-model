"use strict";

require("source-map-support/register");

const FEATURE_NAME = 'userEditTracking';

function feature(entity, args) {
  const options = {
    userEntity: 'user.id',
    uidSource: 'state.user.id',
    trackCreate: 'createdBy',
    trackUpdate: 'updatedBy',
    revisionField: 'revision',
    addFieldsOnly: false,
    ...args[0]
  };
  const {
    userField: userFieldRef,
    uidSource,
    trackCreate,
    trackUpdate,
    revisionField,
    addFieldsOnly,
    migrationUser
  } = options;

  if (!trackCreate && !trackUpdate) {
    entity.linker.log('warn', 'Since both "trackCreate" and "trackUpdate" are disabled, the "userEditTracking" feature will not take any effect.');
    return;
  }

  const [userEntityName, userIdField] = userFieldRef.split('.');
  const userEntity = entity.getReferencedEntity(userEntityName);
  const uidField = userIdField == null ? userEntity.getEntityAttribute('$key') : userEntity.getEntityAttribute(userIdField);
  const fields = {};

  if (trackCreate) {
    fields['createdBy'] = trackCreate;
    entity.info.associations || (entity.info.associations = []);
    entity.info.associations.push({
      type: 'refersTo',
      destEntity: userEntityName,
      srcField: trackCreate,
      fieldProps: {
        readOnly: true,
        writeOnce: true
      }
    });
  }

  if (trackUpdate) {
    entity.once('afterAddingFields', () => {
      entity.addField(revisionField, {
        type: 'integer',
        readOnly: true,
        default: 0
      });
    });
    fields['updatedBy'] = trackUpdate;
    fields['revision'] = revisionField;
    entity.info.associations || (entity.info.associations = []);
    entity.info.associations.push({
      type: 'refersTo',
      destEntity: userEntityName,
      srcField: trackUpdate,
      fieldProps: {
        readOnly: true,
        optional: true
      }
    });
  }

  if (!addFieldsOnly) {
    entity.addFeature(FEATURE_NAME, {
      fields,
      uidSource,
      migrationUser
    });
  }
}

module.exports = feature;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW5nL2VudGl0eUZlYXR1cmVzL3VzZXJFZGl0VHJhY2tpbmcuanMiXSwibmFtZXMiOlsiRkVBVFVSRV9OQU1FIiwiZmVhdHVyZSIsImVudGl0eSIsImFyZ3MiLCJvcHRpb25zIiwidXNlckVudGl0eSIsInVpZFNvdXJjZSIsInRyYWNrQ3JlYXRlIiwidHJhY2tVcGRhdGUiLCJyZXZpc2lvbkZpZWxkIiwiYWRkRmllbGRzT25seSIsInVzZXJGaWVsZCIsInVzZXJGaWVsZFJlZiIsIm1pZ3JhdGlvblVzZXIiLCJsaW5rZXIiLCJsb2ciLCJ1c2VyRW50aXR5TmFtZSIsInVzZXJJZEZpZWxkIiwic3BsaXQiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwidWlkRmllbGQiLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZHMiLCJpbmZvIiwiYXNzb2NpYXRpb25zIiwicHVzaCIsInR5cGUiLCJkZXN0RW50aXR5Iiwic3JjRmllbGQiLCJmaWVsZFByb3BzIiwicmVhZE9ubHkiLCJ3cml0ZU9uY2UiLCJvbmNlIiwiYWRkRmllbGQiLCJkZWZhdWx0Iiwib3B0aW9uYWwiLCJhZGRGZWF0dXJlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxZQUFZLEdBQUcsa0JBQXJCOztBQVlBLFNBQVNDLE9BQVQsQ0FBaUJDLE1BQWpCLEVBQXlCQyxJQUF6QixFQUErQjtBQUMzQixRQUFNQyxPQUFPLEdBQUc7QUFDWkMsSUFBQUEsVUFBVSxFQUFFLFNBREE7QUFFWkMsSUFBQUEsU0FBUyxFQUFFLGVBRkM7QUFHWkMsSUFBQUEsV0FBVyxFQUFFLFdBSEQ7QUFJWkMsSUFBQUEsV0FBVyxFQUFFLFdBSkQ7QUFLWkMsSUFBQUEsYUFBYSxFQUFFLFVBTEg7QUFNWkMsSUFBQUEsYUFBYSxFQUFFLEtBTkg7QUFPWixPQUFHUCxJQUFJLENBQUMsQ0FBRDtBQVBLLEdBQWhCO0FBVUEsUUFBTTtBQUNGUSxJQUFBQSxTQUFTLEVB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aWN0XCI7XG5cbmNvbnN0IEZFQVRVUkVfTkFNRSA9ICd1c2VyRWRpdFRyYWNraW5nJztcblxuLyoqXG4gKiBBIHJ1bGUgc3BlY2lmaWVzIHRoZSBlbnRpdHkgdG8gYXV0b21hdGljYWxseSByZWNvcmQgdGhlIGNyZWF0aW9uIHRpbWVcbiAqIEBtb2R1bGUgRW50aXR5RmVhdHVyZV9Vc2VyRWRpdFRyYWNraW5nXG4gKi9cblxuLyoqXG4gKiBJbml0aWFsaXplIHRoZSBmZWF0dXJlXG4gKiBAcGFyYW0ge09vbG9uZ0VudGl0eX0gZW50aXR5IC0gRW50aXR5IHRvIGFwcGx5IHRoaXMgZmVhdHVyZVxuICogQHBhcmFtIHthcnJheX0gb3B0aW9ucyAtIEZpZWxkIG9wdGlvbnNcbiAqL1xuZnVuY3Rpb24gZmVhdHVyZShlbnRpdHksIGFyZ3MpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICB1c2VyRW50aXR5OiAndXNlci5pZCcsXG4gICAgICAgIHVpZFNvdXJjZTogJ3N0YXRlLnVzZXIuaWQnLFxuICAgICAgICB0cmFja0NyZWF0ZTogJ2NyZWF0ZWRCeScsXG4gICAgICAgIHRyYWNrVXBkYXRlOiAndXBkYXRlZEJ5JywgXG4gICAgICAgIHJldmlzaW9uRmllbGQ6ICdyZXZpc2lvbicsICAgICAgIFxuICAgICAgICBhZGRGaWVsZHNPbmx5OiBmYWxzZSxcbiAgICAgICAgLi4uYXJnc1swXVxuICAgIH07XG5cbiAgICBjb25zdCB7XG4gICAgICAgIHVzZXJGaWVsZDogdXNlckZpZWxkUmVmLFxuICAgICAgICB1aWRTb3VyY2UsXG4gICAgICAgIHRyYWNrQ3JlYXRlLFxuICAgICAgICB0cmFja1VwZGF0ZSxcbiAgICAgICAgcmV2aXNpb25GaWVsZCxcbiAgICAgICAgYWRkRmllbGRzT25seSxcbiAgICAgICAgbWlncmF0aW9uVXNlclxuICAgIH0gPSBvcHRpb25zOyAgICBcblxuICAgIGlmICghdHJhY2tDcmVhdGUgJiYgIXRyYWNrVXBkYXRlKSB7XG4gICAgICAgIGVudGl0eS5saW5rZXIubG9nKCd3YXJuJywgJ1NpbmNlIGJvdGggXCJ0cmFja0NyZWF0ZVwiIGFuZCBcInRyYWNrVXBkYXRlXCIgYXJlIGRpc2FibGVkLCB0aGUgXCJ1c2VyRWRpdFRyYWNraW5nXCIgZmVhdHVyZSB3aWxsIG5vdCB0YWtlIGFueSBlZmZlY3QuJyk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvL3RvZG86IGNyb3NzIHNjaGVhbSBzdXBwb3J0XG4gICAgY29uc3QgWyB1c2VyRW50aXR5TmFtZSwgdXNlcklkRmllbGQgXSA9IHVzZXJGaWVsZFJlZi5zcGxpdCgnLicpO1xuXG4gICAgY29uc3QgdXNlckVudGl0eSA9IGVudGl0eS5nZXRSZWZlcmVuY2VkRW50aXR5KHVzZXJFbnRpdHlOYW1lKTtcbiAgICBjb25zdCB1aWRGaWVsZCA9IHVzZXJJZEZpZWxkID09IG51bGwgPyB1c2VyRW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZSgnJGtleScpIDogdXNlckVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUodXNlcklkRmllbGQpO1xuXG4gICAgY29uc3QgZmllbGRzID0ge307XG5cbiAgICBpZiAodHJhY2tDcmVhdGUpIHtcbiAgICAgICAgZmllbGRzWydjcmVhdGVkQnknXSA9IHRyYWNrQ3JlYXRlO1xuXG4gICAgICAgIGVudGl0eS5pbmZvLmFzc29jaWF0aW9ucyB8fCAoZW50aXR5LmluZm8uYXNzb2NpYXRpb25zID0gW10pO1xuICAgICAgICBlbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMucHVzaCh7XG4gICAgICAgICAgICB0eXBlOiAncmVmZXJzVG8nLFxuICAgICAgICAgICAgZGVzdEVudGl0eTogdXNlckVudGl0eU5hbWUsXG4gICAgICAgICAgICBzcmNGaWVsZDogdHJhY2tDcmVhdGUsXG4gICAgICAgICAgICBmaWVsZFByb3BzOiB7XG4gICAgICAgICAgICAgICAgcmVhZE9ubHk6IHRydWUsXG4gICAgICAgICAgICAgICAgd3JpdGVPbmNlOiB0cnVlXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0cmFja1VwZGF0ZSkge1xuICAgICAgICBlbnRpdHkub25jZSgnYWZ0ZXJBZGRpbmdGaWVsZHMnLCAoKSA9PiB7XG4gICAgICAgICAgICBlbnRpdHkuYWRkRmllbGQocmV2aXNpb25GaWVsZCwge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdpbnRlZ2VyJyxcbiAgICAgICAgICAgICAgICByZWFkT25seTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBkZWZhdWx0OiAwXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZmllbGRzWyd1cGRhdGVkQnknXSA9IHRyYWNrVXBkYXRlO1xuICAgICAgICBmaWVsZHNbJ3JldmlzaW9uJ10gPSByZXZpc2lvbkZpZWxkO1xuXG4gICAgICAgIGVudGl0eS5pbmZvLmFzc29jaWF0aW9ucyB8fCAoZW50aXR5LmluZm8uYXNzb2NpYXRpb25zID0gW10pO1xuICAgICAgICBlbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMucHVzaCh7XG4gICAgICAgICAgICB0eXBlOiAncmVmZXJzVG8nLFxuICAgICAgICAgICAgZGVzdEVudGl0eTogdXNlckVudGl0eU5hbWUsXG4gICAgICAgICAgICBzcmNGaWVsZDogdHJhY2tVcGRhdGUsXG4gICAgICAgICAgICBmaWVsZFByb3BzOiB7XG4gICAgICAgICAgICAgICAgcmVhZE9ubHk6IHRydWUsXG4gICAgICAgICAgICAgICAgb3B0aW9uYWw6IHRydWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCFhZGRGaWVsZHNPbmx5KSB7XG4gICAgICAgIGVudGl0eS5hZGRGZWF0dXJlKEZFQVRVUkVfTkFNRSwge1xuICAgICAgICAgICAgZmllbGRzLFxuICAgICAgICAgICAgdWlkU291cmNlLFxuICAgICAgICAgICAgbWlncmF0aW9uVXNlclxuICAgICAgICB9KTsgICAgXG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGZlYXR1cmU7Il19
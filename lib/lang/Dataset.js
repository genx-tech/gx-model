"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  deepCloneField,
  Clonable,
  isDotSeparateName
} = require('./GemlUtils');

class Dataset extends Clonable {
  constructor(linker, name, gemlModule, info) {
    this.linker = linker;
    this.name = _.camelCase(name);
    this.gemlModule = gemlModule;
    this.info = info;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    if (this.info.entity) {
      let entity = this.linker.getReferencedEntity(this.gemlModule, this.info.entity);
      this.mainEntity = entity.name;
    } else {
      let dataset = this.linker.loadDataset(this.gemlModule, this.info.dataset);

      if (!dataset.linked) {
        throw new Error("Assertion failed: dataset.linked");
      }

      this.mainEntity = dataset.mainEntity;
      this.joinWith = _.cloneDeep(dataset.joinWith);
    }

    if (!_.isEmpty(this.info.joinWith)) {
      if (!this.joinWith) {
        this.joinWith = _.cloneDeep(this.info.joinWith);
      } else {
        this.joinWith = this.joinWith.concat(this.info.joinWith);
      }
    }

    this.linked = true;
    return this;
  }

  buildHierarchy(inSchema) {
    return this._flattenDataset(inSchema, this);
  }

  _flattenDataset(inSchema, dataset) {
    let hierarchy = {};
    let leftEntity = inSchema.entities[dataset.mainEntity];

    if (dataset.joinWith) {
      dataset.joinWith.forEach(joining => {
        let leftField, rightEntity, rightField;

        if (isDotSeparateName(joining.on.left)) {
          let lastPos = joining.on.left.lastIndexOf('.');
          let fieldRef = joining.on.left.substr(lastPos + 1);
          let entityRef = joining.on.left.substr(0, lastPos);

          if (entityRef === leftEntity.name) {
            leftField = leftEntity.getEntityAttribute(fieldRef);
          } else {
            throw new Error(`Unsupported syntax of left side joining field "${joining.on.left}".`);
          }
        } else {
          leftField = leftEntity.getEntityAttribute(joining.on.left);
        }

        if (joining.dataset) {
          let rightHierarchy = inSchema.getDocumentHierachy(this.gemlModule, joining.dataset);

          if (isDotSeparateName(joining.on.right)) {
            let parts = joining.on.right.split('.');

            if (parts.length > 2) {
              throw new Error('Joining a document should only referencing to a field of its main entity.');
            }

            let [entityRef, fieldRef] = parts;

            if (entityRef !== rightHierarchy.entity) {
              throw new Error(`Referenced field "${joining.on.right}" not found while linking to document "${joining.dataset}".`);
            }

            if (!!hierarchy[leftField.name]) {
              throw new Error('Duplicate joinings on the same field of the left side entity.');
            }

            rightEntity = inSchema.entities[entityRef];
            rightField = rightEntity.getEntityAttribute(fieldRef);
            hierarchy[leftField.name] = Object.assign({}, rightHierarchy, {
              linkWithField: rightField.name
            });
            return;
          }

          rightEntity = inSchema.entities[joining.dataset.mainEntity];
        } else {
          rightEntity = inSchema.entities[joining.entity];

          if (isDotSeparateName(joining.on.right)) {
            throw new Error(`Referenced field "${joining.on.right}" not found while linking to entity "${joining.entity}".`);
          }
        }

        rightField = rightEntity.getEntityAttribute(joining.on.right);

        if (!!hierarchy[leftField.name]) {
          throw new Error('Duplicate joinings on the same field of the left side entity.');
        }

        hierarchy[leftField.name] = {
          oolType: 'DocumentHierarchyNode',
          entity: rightEntity.name,
          linkWithField: rightField.name
        };
      });
    }

    return {
      oolType: 'DocumentHierarchyNode',
      entity: leftEntity.name,
      subDocuments: hierarchy
    };
  }

  clone() {
    super.clone();
    let dataset = new Dataset(this.linker, this.name, this.gemlModule, this.info);
    dataset.mainEntity = this.mainEntity;
    deepCloneField(this, dataset, 'joinWith');
    dataset.linked = true;
    return dataset;
  }

  toJSON() {
    return {
      name: this.name,
      mainEntity: this.mainEntity.toJSON(),
      joinWith: this.joinWith
    };
  }

}

module.exports = Dataset;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0RhdGFzZXQuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJkZWVwQ2xvbmVGaWVsZCIsIkNsb25hYmxlIiwiaXNEb3RTZXBhcmF0ZU5hbWUiLCJEYXRhc2V0IiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwiZ2VtbE1vZHVsZSIsImluZm8iLCJjYW1lbENhc2UiLCJsaW5rIiwibGlua2VkIiwiZW50aXR5IiwiZ2V0UmVmZXJlbmNlZEVudGl0eSIsIm1haW5FbnRpdHkiLCJkYXRhc2V0IiwibG9hZERhdGFzZXQiLCJqb2luV2l0aCIsImNsb25lRGVlcCIsImlzRW1wdHkiLCJjb25jYXQiLCJidWlsZEhpZXJhcmNoeSIsImluU2NoZW1hIiwiX2ZsYXR0ZW5EYXRhc2V0IiwiaGllcmFyY2h5IiwibGVmdEVudGl0eSIsImVudGl0aWVzIiwiZm9yRWFjaCIsImpvaW5pbmciLCJsZWZ0RmllbGQiLCJyaWdodEVudGl0eSIsInJpZ2h0RmllbGQiLCJvbiIsImxlZnQiLCJsYXN0UG9zIiwibGFzdEluZGV4T2YiLCJmaWVsZFJlZiIsInN1YnN0ciIsImVudGl0eVJlZiIsImdldEVudGl0eUF0dHJpYnV0ZSIsIkVycm9yIiwicmlnaHRIaWVyYXJjaHkiLCJnZXREb2N1bWVudEhpZXJhY2h5IiwicmlnaHQiLCJwYXJ0cyIsInNwbGl0IiwibGVuZ3RoIiwiT2JqZWN0IiwiYXNzaWduIiwibGlua1dpdGhGaWVsZCIsIm9vbFR5cGUiLCJzdWJEb2N1bWVudHMiLCJjbG9uZSIsInRvSlNPTiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsY0FBRjtBQUFrQkMsRUFBQUEsUUFBbEI7QUFBNEJDLEVBQUFBO0FBQTVCLElBQWtESCxPQUFPLENBQUMsYUFBRCxDQUEvRDs7QUFN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QU0sRUFBRWtCLFdBQVcsQ0FBQ3hCLElBRkk7QUFHeEIyQyxVQUFBQSxhQUFhLEVBQUVsQixVQUFVLENBQUN6QjtBQUhGLFNBQTVCO0FBS0gsT0FuRUQ7QUFvRUg7O0FBRUQsV0FBTztBQUNINEMsTUFBQUEsT0FBTyxFQUFFLHVCQUROO0FBRUh0QyxNQUFBQSxNQUFNLEVBQUVhLFVBQVUsQ0FBQ25CLElBRmhCO0FBR0g2QyxNQUFBQSxZQUFZLEVBQUUzQjtBQUhYLEtBQVA7QUFLSDs7QUFNRDRCLEVBQUFBLEtBQUssR0FBRztBQUNKLFVBQU1BLEtBQU47QUFFQSxRQUFJckMsT0FBTyxHQUFHLElBQUlaLE9BQUosQ0FBWSxLQUFLRSxNQUFqQixFQUF5QixLQUFLQyxJQUE5QixFQUFvQyxLQUFLQyxVQUF6QyxFQUFxRCxLQUFLQyxJQUExRCxDQUFkO0FBRUFPLElBQUFBLE9BQU8sQ0FBQ0QsVUFBUixHQUFxQixLQUFLQSxVQUExQjtBQUNBZCxJQUFBQSxjQUFjLENBQUMsSUFBRCxFQUFPZSxPQUFQLEVBQWdCLFVBQWhCLENBQWQ7QUFFQUEsSUFBQUEsT0FBTyxDQUFDSixNQUFSLEdBQWlCLElBQWpCO0FBRUEsV0FBT0ksT0FBUDtBQUNIOztBQU9Ec0MsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsV0FBTztBQUNIL0MsTUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBRFI7QUFFSFEsTUFBQUEsVUFBVSxFQUFFLEtBQUtBLFVBQUwsQ0FBZ0J1QyxNQUFoQixFQUZUO0FBR0hwQyxNQUFBQSxRQUFRLEVBQUUsS0FBS0E7QUFIWixLQUFQO0FBS0g7O0FBbEwwQjs7QUFxTC9CcUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEQsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBkZWVwQ2xvbmVGaWVsZCwgQ2xvbmFibGUsIGlzRG90U2VwYXJhdGVOYW1lIH0gPSByZXF1aXJlKCcuL0dlbWxVdGlscycpO1xuXG4vKipcbiAqIE9vbG9uZyBkYXRhc2V0IGNsYXNzLlxuICogQGNsYXNzIE9vbG9uZ0RhdGFzZXRcbiAqL1xuY2xhc3MgRGF0YXNldCBleHRlbmRzIENsb25hYmxlIHtcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7T29sb25nTGlua2VyfSBsaW5rZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIERhdGFzZXQgbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBnZW1sTW9kdWxlIC0gU291cmNlIG9vbCBtb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mbyAtIERhdGFzZXQgaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgZ2VtbE1vZHVsZSwgaW5mbykge1xuICAgICAgICAvKipcbiAgICAgICAgICogTGlua2VyIHRvIHByb2Nlc3MgdGhpcyBkb2N1bWVudFxuICAgICAgICAgKiBAbWVtYmVyIHtPb2xvbmdMaW5rZXJ9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmxpbmtlciA9IGxpbmtlcjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTmFtZSBvZiB0aGlzIGRvY3VtZW50XG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubmFtZSA9IF8uY2FtZWxDYXNlKG5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBPd25lciBvb2xvbmcgbW9kdWxlXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZ2VtbE1vZHVsZSA9IGdlbWxNb2R1bGU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJhdyBtZXRhZGF0YVxuICAgICAgICAgKiBAbWVtYmVyIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmluZm8gPSBpbmZvO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgdGhpcyBkYXRhc2V0XG4gICAgICogQHJldHVybnMge09vbG9uZ0RhdGFzZXR9XG4gICAgICovXG4gICAgbGluaygpIHtcbiAgICAgICAgcHJlOiAhdGhpcy5saW5rZWQ7XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5lbnRpdHkpIHtcbiAgICAgICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLmxpbmtlci5nZXRSZWZlcmVuY2VkRW50aXR5KHRoaXMuZ2VtbE1vZHVsZSwgdGhpcy5pbmZvLmVudGl0eSk7XG4gICAgICAgICAgICB0aGlzLm1haW5FbnRpdHkgPSBlbnRpdHkubmFtZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBkYXRhc2V0ID0gdGhpcy5saW5rZXIubG9hZERhdGFzZXQodGhpcy5nZW1sTW9kdWxlLCB0aGlzLmluZm8uZGF0YXNldCk7XG4gICAgICAgICAgICBhc3NlcnQ6IGRhdGFzZXQubGlua2VkO1xuXG4gICAgICAgICAgICB0aGlzLm1haW5FbnRpdHkgPSBkYXRhc2V0Lm1haW5FbnRpdHk7XG4gICAgICAgICAgICB0aGlzLmpvaW5XaXRoID0gXy5jbG9uZURlZXAoZGF0YXNldC5qb2luV2l0aCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5qb2luV2l0aCkpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5qb2luV2l0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuam9pbldpdGggPSBfLmNsb25lRGVlcCh0aGlzLmluZm8uam9pbldpdGgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmpvaW5XaXRoID0gdGhpcy5qb2luV2l0aC5jb25jYXQodGhpcy5pbmZvLmpvaW5XaXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZEhpZXJhcmNoeShpblNjaGVtYSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmxhdHRlbkRhdGFzZXQoaW5TY2hlbWEsIHRoaXMpO1xuICAgIH1cblxuICAgIF9mbGF0dGVuRGF0YXNldChpblNjaGVtYSwgZGF0YXNldCkge1xuICAgICAgICBsZXQgaGllcmFyY2h5ID0ge307XG4gICAgICAgIGxldCBsZWZ0RW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbZGF0YXNldC5tYWluRW50aXR5XTtcblxuICAgICAgICBpZiAoZGF0YXNldC5qb2luV2l0aCkge1xuICAgICAgICAgICAgZGF0YXNldC5qb2luV2l0aC5mb3JFYWNoKGpvaW5pbmcgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBsZWZ0RmllbGQsIHJpZ2h0RW50aXR5LCByaWdodEZpZWxkO1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzRG90U2VwYXJhdGVOYW1lKGpvaW5pbmcub24ubGVmdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGxhc3RQb3MgPSBqb2luaW5nLm9uLmxlZnQubGFzdEluZGV4T2YoJy4nKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpZWxkUmVmID0gam9pbmluZy5vbi5sZWZ0LnN1YnN0cihsYXN0UG9zKzEpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZW50aXR5UmVmID0gam9pbmluZy5vbi5sZWZ0LnN1YnN0cigwLCBsYXN0UG9zKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5UmVmID09PSBsZWZ0RW50aXR5Lm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnRGaWVsZCA9IGxlZnRFbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKGZpZWxkUmVmKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgc3ludGF4IG9mIGxlZnQgc2lkZSBqb2luaW5nIGZpZWxkIFwiJHtqb2luaW5nLm9uLmxlZnR9XCIuYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vZmllbGQgb2YgbGVmdEVudGl0eVxuICAgICAgICAgICAgICAgICAgICBsZWZ0RmllbGQgPSBsZWZ0RW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShqb2luaW5nLm9uLmxlZnQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChqb2luaW5nLmRhdGFzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJpZ2h0SGllcmFyY2h5ID0gaW5TY2hlbWEuZ2V0RG9jdW1lbnRIaWVyYWNoeSh0aGlzLmdlbWxNb2R1bGUsIGpvaW5pbmcuZGF0YXNldCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRG90U2VwYXJhdGVOYW1lKGpvaW5pbmcub24ucmlnaHQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGFydHMgPSBqb2luaW5nLm9uLnJpZ2h0LnNwbGl0KCcuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSm9pbmluZyBhIGRvY3VtZW50IHNob3VsZCBvbmx5IHJlZmVyZW5jaW5nIHRvIGEgZmllbGQgb2YgaXRzIG1haW4gZW50aXR5LicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgWyBlbnRpdHlSZWYsIGZpZWxkUmVmIF0gPSBwYXJ0cztcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eVJlZiAhPT0gcmlnaHRIaWVyYXJjaHkuZW50aXR5KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZWQgZmllbGQgXCIke2pvaW5pbmcub24ucmlnaHR9XCIgbm90IGZvdW5kIHdoaWxlIGxpbmtpbmcgdG8gZG9jdW1lbnQgXCIke2pvaW5pbmcuZGF0YXNldH1cIi5gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiAhaGllcmFyY2h5W2xlZnRGaWVsZC5uYW1lXSwgJ0R1cGxpY2F0ZSBqb2luaW5ncyBvbiB0aGUgc2FtZSBmaWVsZCBvZiB0aGUgbGVmdCBzaWRlIGVudGl0eS4nO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEVudGl0eSA9IGluU2NoZW1hLmVudGl0aWVzW2VudGl0eVJlZl07XG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEZpZWxkID0gcmlnaHRFbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKGZpZWxkUmVmKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaGllcmFyY2h5W2xlZnRGaWVsZC5uYW1lXSA9IE9iamVjdC5hc3NpZ24oe30sIHJpZ2h0SGllcmFyY2h5LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1dpdGhGaWVsZDogcmlnaHRGaWVsZC5uYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy9qb2luaW5nLm9uLnJpZ2h0IGlzIGZpZWxkIG5hbWUgb2YgdGhlIG1haW4gZW50aXR5XG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0RW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbam9pbmluZy5kYXRhc2V0Lm1haW5FbnRpdHldO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0RW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbam9pbmluZy5lbnRpdHldO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0RvdFNlcGFyYXRlTmFtZShqb2luaW5nLm9uLnJpZ2h0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2VkIGZpZWxkIFwiJHtqb2luaW5nLm9uLnJpZ2h0fVwiIG5vdCBmb3VuZCB3aGlsZSBsaW5raW5nIHRvIGVudGl0eSBcIiR7am9pbmluZy5lbnRpdHl9XCIuYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL2ZpZWxkIG9mIHJpZ2h0RW50aXR5XG4gICAgICAgICAgICAgICAgcmlnaHRGaWVsZCA9IHJpZ2h0RW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShqb2luaW5nLm9uLnJpZ2h0KTtcblxuICAgICAgICAgICAgICAgIGFzc2VydDogIWhpZXJhcmNoeVtsZWZ0RmllbGQubmFtZV0sICdEdXBsaWNhdGUgam9pbmluZ3Mgb24gdGhlIHNhbWUgZmllbGQgb2YgdGhlIGxlZnQgc2lkZSBlbnRpdHkuJztcblxuICAgICAgICAgICAgICAgIGhpZXJhcmNoeVtsZWZ0RmllbGQubmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIG9vbFR5cGU6ICdEb2N1bWVudEhpZXJhcmNoeU5vZGUnLFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IHJpZ2h0RW50aXR5Lm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGxpbmtXaXRoRmllbGQ6IHJpZ2h0RmllbGQubmFtZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBvb2xUeXBlOiAnRG9jdW1lbnRIaWVyYXJjaHlOb2RlJyxcbiAgICAgICAgICAgIGVudGl0eTogbGVmdEVudGl0eS5uYW1lLFxuICAgICAgICAgICAgc3ViRG9jdW1lbnRzOiBoaWVyYXJjaHlcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9uZSB0aGUgZG9jdW1lbnRcbiAgICAgKiBAcmV0dXJucyB7T29sb25nRGF0YXNldH1cbiAgICAgKi9cbiAgICBjbG9uZSgpIHtcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcblxuICAgICAgICBsZXQgZGF0YXNldCA9IG5ldyBEYXRhc2V0KHRoaXMubGlua2VyLCB0aGlzLm5hbWUsIHRoaXMuZ2VtbE1vZHVsZSwgdGhpcy5pbmZvKTtcblxuICAgICAgICBkYXRhc2V0Lm1haW5FbnRpdHkgPSB0aGlzLm1haW5FbnRpdHk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGRhdGFzZXQsICdqb2luV2l0aCcpO1xuXG4gICAgICAgIGRhdGFzZXQubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gZGF0YXNldDtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSB0aGUgZG9jdW1lbnQgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgICAgICBtYWluRW50aXR5OiB0aGlzLm1haW5FbnRpdHkudG9KU09OKCksXG4gICAgICAgICAgICBqb2luV2l0aDogdGhpcy5qb2luV2l0aFxuICAgICAgICB9O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEYXRhc2V0OyJdfQ==
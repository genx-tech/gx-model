"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const pluralize = require('pluralize');

class Clonable {
  constructor() {
    this.linked = false;
  }

  clone() {
    if (!this.linked) {
      throw new Error('An element becomes clonable only after being linked.');
    }
  }

}

const deepClone = value => _.cloneDeepWith(value, el => el instanceof Clonable ? el.clone() : undefined);

const deepCloneField = (src, dest, field) => {
  if (field in src) dest[field] = deepClone(src[field]);
};

const isDotSeparateName = name => name.indexOf('.') > 0;

const extractDotSeparateName = name => name.split('.');

const extractReferenceBaseName = name => extractDotSeparateName(name).pop();

const prefixNaming = (prefix, name) => {
  let leftParts = _.kebabCase(prefix).split('-');

  let rightParts = _.kebabCase(extractReferenceBaseName(name)).split('-');

  let reservedLeft, reservedRight;

  if (leftParts.length > rightParts.length) {
    reservedLeft = leftParts.splice(0, leftParts.length - rightParts.length);
    reservedRight = [];
  } else {
    reservedLeft = [];
    reservedRight = rightParts.splice(leftParts.length, rightParts.length - leftParts.length);
  }

  const combine = () => _.camelCase(reservedLeft.concat(leftParts).concat(reservedRight).join('-'));

  if (_.isEqual(leftParts, rightParts)) {
    return combine();
  }

  while (leftParts.length > 0) {
    reservedLeft.push(leftParts.shift());
    reservedRight.unshift(rightParts.pop());

    if (_.isEqual(leftParts, rightParts)) {
      break;
    }
  }

  return combine();
};

const getReferenceNameIfItIs = obj => {
  if (_.isPlainObject(obj) && obj.oolType === 'ObjectReference') {
    return extractDotSeparateName(obj.name)[0];
  }

  return undefined;
};

exports.parseReferenceInDocument = (schema, doc, ref) => {
  let parts = ref.split('.');
  let parent;
  let l = parts.length;
  let entityNode, entity, field;

  for (let i = 0; i < l; i++) {
    let p = parts[i];

    if (!entityNode) {
      if (doc.entity === p) {
        entityNode = doc;
        continue;
      }

      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (entityNode && p[0] === '$') {
      entity = schema.entities[entityNode.entity];
      let attr = entity.getEntityAttribute(p);

      if (attr instanceof Field) {
        field = attr;

        if (i !== l - 1) {
          throw new Error(`Reference by path "${ref}" not found in given document.`);
        }

        return {
          entityNode,
          entity,
          field
        };
      } else {
        parent = attr;
      }

      continue;
    }

    if (parent) {
      parent = parent[p];
    } else {
      if (i === l - 1) {
        entity = schema.entities[entityNode.entity];
        field = entity.getEntityAttribute(p);
        return {
          entityNode,
          entity,
          field
        };
      }

      entityNode = entityNode.subDocuments && entityNode.subDocuments[p];

      if (!entityNode) {
        throw new Error(`Reference by path "${ref}" not found in given document.`);
      }
    }
  }

  if (!field) {
    if (typeof parent !== 'string') {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (!entity) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    field = entity.getEntityAttribute(parent);

    if (!(field instanceof Field)) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }
  }

  return {
    entityNode,
    entity,
    field
  };
};

exports.pluralize = name => {
  let parts = _.kebabCase(name).split('-');

  let last = pluralize(parts.pop().toLowerCase());
  parts.push(last);
  return _.camelCase(parts.join('-'));
};

exports.deepClone = deepClone;
exports.deepCloneField = deepCloneField;
exports.isDotSeparateName = isDotSeparateName;
exports.extractDotSeparateName = extractDotSeparateName;
exports.extractReferenceBaseName = extractReferenceBaseName;
exports.getReferenceNameIfItIs = getReferenceNameIfItIs;

exports.schemaNaming = name => _.camelCase(name);

exports.entityNaming = name => _.camelCase(name);

exports.fieldNaming = name => _.camelCase(name);

exports.prefixNaming = prefixNaming;

exports.generateDisplayName = name => _.startCase(name);

exports.formatFields = field => Array.isArray(field) ? field.join(', ') : field;

exports.Clonable = Clonable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0dlbWxVdGlscy5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsInBsdXJhbGl6ZSIsIkNsb25hYmxlIiwibGlua2VkIiwiY2xvbmUiLCJkZWVwQ2xvbmUiLCJ2YWx1ZSIsImNsb25lRGVlcFdpdGgiLCJlbCIsInVuZGVmaW5lZCIsImRlZXBDbG9uZUZpZWxkIiwic3JjIiwiZGVzdCIsImZpZWxkIiwiaXNEb3RTZXBhcmF0ZU5hbWUiLCJuYW1lIiwiaW5kZXhPZiIsImV4dHJhY3REb3RTZXBhcmF0ZU5hbWUiLCJzcGxpdCIsImV4dHJhY3RSZWZlcmVuY2VCYXNlTmFtZSIsInBvcCIsInByZWZpeE5hbWluZyIsInByZWZpeCIsImxlZnRQYXJ0cyIsImtlYmFiQ2FzZSIsInJpZ2h0UGFydHMiLCJyZXNlcnZlZExlZnQiLCJyZXNlcnZlZFJpZ2h0IiwibGVuZ3RoIiwic3BsaWNlIiwiY29tYmluZSIsImNhbWVsQ2FzZSIsImNvbmNhdCIsImpvaW4iLCJpc0VxdWFsIiwicHVzaCIsInNoaWZ0IiwidW5zaGlmdCIsImdldFJlZmVyZW5jZU5hbWVJZkl0SXMiLCJvYmoiLCJpc1BsYWluT2JqZWN0Iiwib29sVHlwZSIsImV4cG9ydHMiLCJwYXJzZVJlZmVyZW5jZUluRG9jdW1lbnQiLCJzY2hlbWEiLCJkb2MiLCJyZWYiLCJwYXJ0cyIsInBhcmVudCIsImwiLCJlbnRpdHlOb2RlIiwiZW50aXR5IiwiaSIsInAiLCJFcnJvciIsImVudGl0aWVzIiwiYXR0ciIsImdldEVudGl0eUF0dHJpYnV0ZSIsIkZpZWxkIiwic3ViRG9jdW1lbnRzIiwibGFzdCIsInRvTG93ZXJDYXNlIiwic2NoZW1hTmFtaW5nIiwiZW50aXR5TmFtaW5nIiwiZmllbGROYW1pbmciLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwic3RhcnRDYXNlIiwiZm9ybWF0RmllbGRzIiwiQXJyYXkiLCJpc0FycmF5Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNQyxTQUFTLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQUVBLE1BQU1FLFFBQU4sQ0FBZTtBQUFBO0FBQUEsU0FDWEMsTUFEVyxHQUNGLEtBREU7QUFBQTs7QUFHWEMsRUFBQUEsS0FBSyxHQUFHO0FBQUEsU0FDSSxLQUFLRCxNQURUO0FBQUEsc0JBQ2lCLHNEQURqQjtBQUFBO0FBRVA7O0FBTFU7O0FBUWYsTUFBTUUsU0FBUyxHQUFJQyxLQUFELElBQVdQLENBQUMsQ0FBQ1EsYUFBRixDQUFnQkQsS0FBaEIsRUFBdUJFLEVBQUUsSUFBS0EsRUFBRSxZQUFZTixRQUFmLEdBQTJCTSxFQUFFLENBQUNKLEtBQUgsRUFBM0IsR0FBd0NLLFNBQXJFLENBQTdCOztBQUVBLE1BQU1DLGNBQWMsR0FBRyxDQUFDQyxHQUFELEVBQU1DLElBQU4sRUFBWUMsS0FBWixLQUFzQjtBQUN6QyxNQUFJQSxLQUFLLElBQUlGLEdBQWIsRUFBa0JDLElBQUksQ0FBQ0MsS0FBRCxDQUFKLEdBQWNSLFNBQVMsQ0FBQ00sR0FBRyxDQUFDRSxLQUFELENBQUosQ0FBdkI7QUFDckIsQ0FGRDs7QUFJQSxNQUFNQyxpQkFBaUIsR0FBSUMsSUFBRCxJQUFXQSxJQUFJLENBQUNDLE9BQUwsQ0FBYSxHQUFiLElBQW9CLENBQXpEOztBQUVBLE1BQU1DLHNCQUFzQixHQUFJRixJQUFELElBQVVBLElBQUksQ0FBQ0csS0FBTCxDQUFXLEdBQVgsQ0FBekM7O0FBRUEsTUFBTUMsd0JBQXdCLEdBQUlKLElBQUQsSUFBVUUsc0JBQXNCLENBQUNGLElBQUQsQ0FBdEIsQ0FBNkJLLEdBQTdCLEVBQTNDOztBQUVBLE1BQU1DLFlBQVksR0FBRyxDQUFDQyxNQUFELEVBQVNQLElBQVQsS0FBa0I7QUFDbkMsTUFBSVEsU0FBUyxHQUFHeEIsQ0FBQyxDQUFDeUIsU0FBRixDQUFZRixNQUFaLEVBQW9CSixLQUFwQixDQUEwQixHQUExQixDQUFoQjs7QUFDQSxNQUFJTyxVQUFVLEdBQUcxQixDQUFDLENBQUN5QixTQUFGLENBQVlMLHdCQUF3QixDQUFDSixJQUFELENBQXBDLEVBQTRDRyxLQUE1QyxDQUFrRCxHQUFsRCxDQUFqQjs7QUFFQSxNQUFJUSxZQUFKLEVBQWtCQyxhQUFsQjs7QUFFQSxNQUFJSixTQUFTLENBQUNLLE1BQVYsR0FBbUJILFVBQVUsQ0FBQ0csTUFBbEMsRUFBMEM7QUFDdENGLElBQUFBLFlBQVksR0FBR0gsU0FBUyxDQUFDTSxNQUFWLENBQWlCLENBQWpCLEVBQW9CTixTQUFTLENBQUNLLE1BQVYsR0FBbUJILFVBQVUsQ0FBQ0csTUFBbEQsQ0FBZjtBQUNBRCxJQUFBQSxhQUFhLEdBQUcsRUFBaEI7QUFDSCxHQUhELE1BR087QUFDSEQsSUFBQUEsWUFBWSxHQUFHLEVBQWY7QUFDQUMsSUFBQUEsYUFBYSxHQUFHRixVQUFVLENBQUNJLE1BQVgsQ0FBa0JOLFNBQVMsQ0FBQ0ssTUFBNUIsRUFBb0NILFVBQVUsQ0FBQ0csTUFBWCxHQUFvQkwsU0FBUyxDQUFDSyxNQUFsRSxDQUFoQjtBQUNIOztBQUVELFFBQU1FLE9BQU8sR0FBRyxNQUFNL0IsQ0FBQyxDQUFDZ0MsU0FBRixDQUFZTCxZQUFZLENBQUNNLE1BQWIsQ0FBb0JULFNBQXBCLEVBQStCUyxNQUEvQixDQUFzQ0wsYUFBdEMsRUFBcURNLElBQXJELENBQTBELEdBQTFELENBQVosQ0FBdEI7O0FBRUEsTUFBSWxDLENBQUMsQ0FBQ21DLE9BQUYsQ0FBVVgsU0FBVixFQUFxQkUsVUFBckIsQ0FBSixFQUFzQztBQUNsQyxXQUFPSyxPQUFPLEVBQWQ7QUFDSDs7QUFFRCxTQUFPUCxTQUFTLENBQUNLLE1BQVYsR0FBbUIsQ0FBMUIsRUFBNkI7QUFDekJGLElBQUFBLFlBQVksQ0FBQ1MsSUFBYixDQUFrQlosU0FBUyxDQUFDYSxLQUFWLEVBQWxCO0FBQ0FULElBQUFBLGFBQWEsQ0FBQ1UsT0FBZCxDQUFzQlosVUFBVSxDQUFDTCxHQUFYLEVBQXRCOztBQUNBLFFBQUlyQixDQUFDLENBQUNtQyxPQUFGLENBQVVYLFNBQVYsRUFBcUJFLFVBQXJCLENBQUosRUFBc0M7QUFDbEM7QUFDSDtBQUNKOztBQUVELFNBQU9LLE9BQU8sRUFBZDtBQUNILENBN0JEOztBQStCQSxNQUFNUSxzQkFBc0IsR0FBSUMsR0FBRCxJQUFTO0FBQ3BDLE1BQUl4QyxDQUFDLENBQUN5QyxhQUFGLENBQWdCRCxHQUFoQixLQUF3QkEsR0FBRyxDQUFDRSxPQUFKLEtBQWdCLGlCQUE1QyxFQUErRDtBQUMzRCxXQUFPeEIsc0JBQXNCLENBQUNzQixHQUFHLENBQUN4QixJQUFMLENBQXRCLENBQWlDLENBQWpDLENBQVA7QUFDSDs7QUFFRCxTQUFPTixTQUFQO0FBQ0gsQ0FORDs7QUFRQWlDLE9BQU8sQ0FBQ0Msd0JBQVIsR0FBbUMsQ0FBQ0MsTUFBRCxFQUFTQyxHQUFULEVBQWNDLEdBQWQsS0FBc0I7QUFDckQsTUFBSUMsS0FBSyxHQUFHRCxHQUFHLENBQUM1QixLQUFKLENBQVUsR0FBVixDQUFaO0FBQ0EsTUFBSThCLE1BQUo7QUFDQSxNQUFJQyxDQUFDLEdBQUdGLEtBQUssQ0FBQ25CLE1BQWQ7QUFDQSxNQUFJc0IsVUFBSixFQUFnQkMsTUFBaEIsRUFBd0J0QyxLQUF4Qjs7QUFFQSxPQUFLLElBQUl1QyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHSCxDQUFwQixFQUF1QkcsQ0FBQyxFQUF4QixFQUE0QjtBQUN4QixRQUFJQyxDQUFDLEdBQUdOLEtBQUssQ0FBQ0ssQ0FBRCxDQUFiOztBQUVBLFFBQUksQ0FBQ0YsVUFBTCxFQUFpQjtBQUNiLFVBQUlMLEdBQUcsQ0FBQ00sTUFBSixLQUFlRSxDQUFuQixFQUFzQjtBQUNsQkgsUUFBQUEsVUFBVSxHQUFHTCxHQUFiO0FBQ0E7QUFDSDs7QUFFRCxZQUFNLElBQUlTLEtBQUosQ0FBVyxzQkFBcUJSLEdBQUksZ0NBQXBDLENBQU47QUFDSDs7QUFFRCxRQUFJSSxVQUFVLElBQUlHLENBQUMsQ0FBQyxDQUFELENBQUQsS0FBUyxHQUEzQixFQUFnQztBQUM1QkYsTUFBQUEsTUFBTSxHQUFHUCxNQUFNLENBQUNXLFFBQVAsQ0FBZ0JMLFVBQVUsQ0FBQ0MsTUFBM0IsQ0FBVDtBQUNBLFVBQUlLLElBQUksR0FBR0wsTUFBTSxDQUFDTSxrQkFBUCxDQUEwQkosQ0FBMUIsQ0FBWDs7QUFFQSxVQUFJRyxJQUFJLFlBQVlFLEtBQXBCLEVBQTJCO0FBQ3ZCN0MsUUFBQUEsS0FBSyxHQUFHMkMsSUFBUjs7QUFDQSxZQUFJSixDQUFDLEtBQUtILENBQUMsR0FBQyxDQUFaLEVBQWU7QUFDWCxnQkFBTSxJQUFJSyxLQUFKLENBQVcsc0JBQXFCUixHQUFJLGdDQUFwQyxDQUFOO0FBQ0g7O0FBRUQsZUFBTztBQUNISSxVQUFBQSxVQURHO0FBRUhDLFVBQUFBLE1BRkc7QUFHSHRDLFVBQUFBO0FBSEcsU0FBUDtBQUtILE9BWEQsTUFXTztBQUNIbUMsUUFBQUEsTUFBTSxHQUFHUSxJQUFUO0FBQ0g7O0FBRUQ7QUFDSDs7QUFFRCxRQUFJUixNQUFKLEVBQVk7QUFDUkEsTUFBQUEsTUFBTSxHQUFHQSxNQUFNLENBQUNLLENBQUQsQ0FBZjtBQUNILEtBRkQsTUFFTztBQUNILFVBQUlELENBQUMsS0FBS0gsQ0FBQyxHQUFDLENBQVosRUFBZTtBQUVYRSxRQUFBQSxNQUFNLEdBQUdQLE1BQU0sQ0FBQ1csUUFBUCxDQUFnQkwsVUFBVSxDQUFDQyxNQUEzQixDQUFUO0FBQ0F0QyxRQUFBQSxLQUFLLEdBQUdzQyxNQUFNLENBQUNNLGtCQUFQLENBQTBCSixDQUExQixDQUFSO0FBRUEsZUFBTztBQUNISCxVQUFBQSxVQURHO0FBRUhDLFVBQUFBLE1BRkc7QUFHSHRDLFVBQUFBO0FBSEcsU0FBUDtBQUtIOztBQUVEcUMsTUFBQUEsVUFBVSxHQUFHQSxVQUFVLENBQUNTLFlBQVgsSUFBMkJULFVBQVUsQ0FBQ1MsWUFBWCxDQUF3Qk4sQ0FBeEIsQ0FBeEM7O0FBQ0EsVUFBSSxDQUFDSCxVQUFMLEVBQWlCO0FBQ2IsY0FBTSxJQUFJSSxLQUFKLENBQVcsc0JBQXFCUixHQUFJLGdDQUFwQyxDQUFOO0FBQ0g7QUFDSjtBQUNKOztBQUVELE1BQUksQ0FBQ2pDLEtBQUwsRUFBWTtBQUNSLFFBQUksT0FBT21DLE1BQVAsS0FBa0IsUUFBdEIsRUFBZ0M7QUFDNUIsWUFBTSxJQUFJTSxLQUFKLENBQVcsc0JBQXFCUixHQUFJLGdDQUFwQyxDQUFOO0FBQ0g7O0FBRUQsUUFBSSxDQUFDSyxNQUFMLEVBQWE7QUFDVCxZQUFNLElBQUlHLEtBQUosQ0FBVyxzQkFBcUJSLEdBQUksZ0NBQXBDLENBQU47QUFDSDs7QUFFRGpDLElBQUFBLEtBQUssR0FBR3NDLE1BQU0sQ0FBQ00sa0JBQVAsQ0FBMEJULE1BQTFCLENBQVI7O0FBQ0EsUUFBSSxFQUFFbkMsS0FBSyxZQUFZNkMsS0FBbkIsQ0FBSixFQUErQjtBQUMzQixZQUFNLElBQUlKLEtBQUosQ0FBVyxzQkFBcUJSLEdBQUksZ0NBQXBDLENBQU47QUFDSDtBQUNKOztBQUVELFNBQU87QUFDSEksSUFBQUEsVUFERztBQUVIQyxJQUFBQSxNQUZHO0FBR0h0QyxJQUFBQTtBQUhHLEdBQVA7QUFLSCxDQWxGRDs7QUFvRkE2QixPQUFPLENBQUN6QyxTQUFSLEdBQXFCYyxJQUFELElBQVU7QUFDMUIsTUFBSWdDLEtBQUssR0FBR2hELENBQUMsQ0FBQ3lCLFNBQUYsQ0FBWVQsSUFBWixFQUFrQkcsS0FBbEIsQ0FBd0IsR0FBeEIsQ0FBWjs7QUFDQSxNQUFJMEMsSUFBSSxHQUFHM0QsU0FBUyxDQUFDOEMsS0FBSyxDQUFDM0IsR0FBTixHQUFZeUMsV0FBWixFQUFELENBQXBCO0FBQ0FkLEVBQUFBLEtBQUssQ0FBQ1osSUFBTixDQUFXeUIsSUFBWDtBQUNBLFNBQU83RCxDQUFDLENBQUNnQyxTQUFGLENBQVlnQixLQUFLLENBQUNkLElBQU4sQ0FBVyxHQUFYLENBQVosQ0FBUDtBQUNILENBTEQ7O0FBT0FTLE9BQU8sQ0FBQ3JDLFNBQVIsR0FBb0JBLFNBQXBCO0FBQ0FxQyxPQUFPLENBQUNoQyxjQUFSLEdBQXlCQSxjQUF6QjtBQUNBZ0MsT0FBTyxDQUFDNUIsaUJBQVIsR0FBNEJBLGlCQUE1QjtBQUNBNEIsT0FBTyxDQUFDekIsc0JBQVIsR0FBaUNBLHNCQUFqQztBQUNBeUIsT0FBTyxDQUFDdkIsd0JBQVIsR0FBbUNBLHdCQUFuQztBQUNBdUIsT0FBTyxDQUFDSixzQkFBUixHQUFpQ0Esc0JBQWpDOztBQUNBSSxPQUFPLENBQUNvQixZQUFSLEdBQXVCL0MsSUFBSSxJQUFJaEIsQ0FBQyxDQUFDZ0MsU0FBRixDQUFZaEIsSUFBWixDQUEvQjs7QUFDQTJCLE9BQU8sQ0FBQ3FCLFlBQVIsR0FBdUJoRCxJQUFJLElBQUloQixDQUFDLENBQUNnQyxTQUFGLENBQVloQixJQUFaLENBQS9COztBQUNBMkIsT0FBTyxDQUFDc0IsV0FBUixHQUFzQmpELElBQUksSUFBSWhCLENBQUMsQ0FBQ2dDLFNBQUYsQ0FBWWhCLElBQVosQ0FBOUI7O0FBQ0EyQixPQUFPLENBQUNyQixZQUFSLEdBQXVCQSxZQUF2Qjs7QUFDQXFCLE9BQU8sQ0FBQ3VCLG1CQUFSLEdBQThCbEQsSUFBSSxJQUFJaEIsQ0FBQyxDQUFDbUUsU0FBRixDQUFZbkQsSUFBWixDQUF0Qzs7QUFDQTJCLE9BQU8sQ0FBQ3lCLFlBQVIsR0FBdUJ0RCxLQUFLLElBQUl1RCxLQUFLLENBQUNDLE9BQU4sQ0FBY3hELEtBQWQsSUFBdUJBLEtBQUssQ0FBQ29CLElBQU4sQ0FBVyxJQUFYLENBQXZCLEdBQTBDcEIsS0FBMUU7O0FBQ0E2QixPQUFPLENBQUN4QyxRQUFSLEdBQW1CQSxRQUFuQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBwbHVyYWxpemUgPSByZXF1aXJlKCdwbHVyYWxpemUnKTtcblxuY2xhc3MgQ2xvbmFibGUge1xuICAgIGxpbmtlZCA9IGZhbHNlO1xuXG4gICAgY2xvbmUoKSB7ICAgICAgXG4gICAgICAgIGFzc2VydDogdGhpcy5saW5rZWQsICdBbiBlbGVtZW50IGJlY29tZXMgY2xvbmFibGUgb25seSBhZnRlciBiZWluZyBsaW5rZWQuJztcbiAgICB9XG59XG5cbmNvbnN0IGRlZXBDbG9uZSA9ICh2YWx1ZSkgPT4gXy5jbG9uZURlZXBXaXRoKHZhbHVlLCBlbCA9PiAoZWwgaW5zdGFuY2VvZiBDbG9uYWJsZSkgPyBlbC5jbG9uZSgpIDogdW5kZWZpbmVkKTtcblxuY29uc3QgZGVlcENsb25lRmllbGQgPSAoc3JjLCBkZXN0LCBmaWVsZCkgPT4ge1xuICAgIGlmIChmaWVsZCBpbiBzcmMpIGRlc3RbZmllbGRdID0gZGVlcENsb25lKHNyY1tmaWVsZF0pO1xufTtcblxuY29uc3QgaXNEb3RTZXBhcmF0ZU5hbWUgPSAobmFtZSkgPT4gKG5hbWUuaW5kZXhPZignLicpID4gMCk7XG5cbmNvbnN0IGV4dHJhY3REb3RTZXBhcmF0ZU5hbWUgPSAobmFtZSkgPT4gbmFtZS5zcGxpdCgnLicpO1xuXG5jb25zdCBleHRyYWN0UmVmZXJlbmNlQmFzZU5hbWUgPSAobmFtZSkgPT4gZXh0cmFjdERvdFNlcGFyYXRlTmFtZShuYW1lKS5wb3AoKTtcblxuY29uc3QgcHJlZml4TmFtaW5nID0gKHByZWZpeCwgbmFtZSkgPT4ge1xuICAgIGxldCBsZWZ0UGFydHMgPSBfLmtlYmFiQ2FzZShwcmVmaXgpLnNwbGl0KCctJyk7XG4gICAgbGV0IHJpZ2h0UGFydHMgPSBfLmtlYmFiQ2FzZShleHRyYWN0UmVmZXJlbmNlQmFzZU5hbWUobmFtZSkpLnNwbGl0KCctJyk7XG4gICAgXG4gICAgbGV0IHJlc2VydmVkTGVmdCwgcmVzZXJ2ZWRSaWdodDtcblxuICAgIGlmIChsZWZ0UGFydHMubGVuZ3RoID4gcmlnaHRQYXJ0cy5sZW5ndGgpIHtcbiAgICAgICAgcmVzZXJ2ZWRMZWZ0ID0gbGVmdFBhcnRzLnNwbGljZSgwLCBsZWZ0UGFydHMubGVuZ3RoIC0gcmlnaHRQYXJ0cy5sZW5ndGgpO1xuICAgICAgICByZXNlcnZlZFJpZ2h0ID0gW107XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmVzZXJ2ZWRMZWZ0ID0gW107XG4gICAgICAgIHJlc2VydmVkUmlnaHQgPSByaWdodFBhcnRzLnNwbGljZShsZWZ0UGFydHMubGVuZ3RoLCByaWdodFBhcnRzLmxlbmd0aCAtIGxlZnRQYXJ0cy5sZW5ndGgpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbWJpbmUgPSAoKSA9PiBfLmNhbWVsQ2FzZShyZXNlcnZlZExlZnQuY29uY2F0KGxlZnRQYXJ0cykuY29uY2F0KHJlc2VydmVkUmlnaHQpLmpvaW4oJy0nKSk7XG5cbiAgICBpZiAoXy5pc0VxdWFsKGxlZnRQYXJ0cywgcmlnaHRQYXJ0cykpIHtcbiAgICAgICAgcmV0dXJuIGNvbWJpbmUoKTtcbiAgICB9XG4gICAgXG4gICAgd2hpbGUgKGxlZnRQYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJlc2VydmVkTGVmdC5wdXNoKGxlZnRQYXJ0cy5zaGlmdCgpKTtcbiAgICAgICAgcmVzZXJ2ZWRSaWdodC51bnNoaWZ0KHJpZ2h0UGFydHMucG9wKCkpO1xuICAgICAgICBpZiAoXy5pc0VxdWFsKGxlZnRQYXJ0cywgcmlnaHRQYXJ0cykpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfSBcblxuICAgIHJldHVybiBjb21iaW5lKCk7XG59O1xuXG5jb25zdCBnZXRSZWZlcmVuY2VOYW1lSWZJdElzID0gKG9iaikgPT4ge1xuICAgIGlmIChfLmlzUGxhaW5PYmplY3Qob2JqKSAmJiBvYmoub29sVHlwZSA9PT0gJ09iamVjdFJlZmVyZW5jZScpIHtcbiAgICAgICAgcmV0dXJuIGV4dHJhY3REb3RTZXBhcmF0ZU5hbWUob2JqLm5hbWUpWzBdO1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59O1xuXG5leHBvcnRzLnBhcnNlUmVmZXJlbmNlSW5Eb2N1bWVudCA9IChzY2hlbWEsIGRvYywgcmVmKSA9PiB7ICAgIFxuICAgIGxldCBwYXJ0cyA9IHJlZi5zcGxpdCgnLicpO1xuICAgIGxldCBwYXJlbnQ7XG4gICAgbGV0IGwgPSBwYXJ0cy5sZW5ndGg7XG4gICAgbGV0IGVudGl0eU5vZGUsIGVudGl0eSwgZmllbGQ7XG4gICAgXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgbGV0IHAgPSBwYXJ0c1tpXTtcbiAgICAgICAgXG4gICAgICAgIGlmICghZW50aXR5Tm9kZSkge1xuICAgICAgICAgICAgaWYgKGRvYy5lbnRpdHkgPT09IHApIHtcbiAgICAgICAgICAgICAgICBlbnRpdHlOb2RlID0gZG9jO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGVudGl0eU5vZGUgJiYgcFswXSA9PT0gJyQnKSB7XG4gICAgICAgICAgICBlbnRpdHkgPSBzY2hlbWEuZW50aXRpZXNbZW50aXR5Tm9kZS5lbnRpdHldO1xuICAgICAgICAgICAgbGV0IGF0dHIgPSBlbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKHApO1xuXG4gICAgICAgICAgICBpZiAoYXR0ciBpbnN0YW5jZW9mIEZpZWxkKSB7XG4gICAgICAgICAgICAgICAgZmllbGQgPSBhdHRyO1xuICAgICAgICAgICAgICAgIGlmIChpICE9PSBsLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2UgYnkgcGF0aCBcIiR7cmVmfVwiIG5vdCBmb3VuZCBpbiBnaXZlbiBkb2N1bWVudC5gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBlbnRpdHlOb2RlLFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHksXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGFyZW50ID0gYXR0cjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudFtwXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChpID09PSBsLTEpIHtcbiAgICAgICAgICAgICAgICAvL2xhc3QgcGFydFxuICAgICAgICAgICAgICAgIGVudGl0eSA9IHNjaGVtYS5lbnRpdGllc1tlbnRpdHlOb2RlLmVudGl0eV07XG4gICAgICAgICAgICAgICAgZmllbGQgPSBlbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKHApO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5Tm9kZSxcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5LFxuICAgICAgICAgICAgICAgICAgICBmaWVsZFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVudGl0eU5vZGUgPSBlbnRpdHlOb2RlLnN1YkRvY3VtZW50cyAmJiBlbnRpdHlOb2RlLnN1YkRvY3VtZW50c1twXTtcbiAgICAgICAgICAgIGlmICghZW50aXR5Tm9kZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWZpZWxkKSB7XG4gICAgICAgIGlmICh0eXBlb2YgcGFyZW50ICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2UgYnkgcGF0aCBcIiR7cmVmfVwiIG5vdCBmb3VuZCBpbiBnaXZlbiBkb2N1bWVudC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZW50aXR5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICB9XG5cbiAgICAgICAgZmllbGQgPSBlbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKHBhcmVudCk7XG4gICAgICAgIGlmICghKGZpZWxkIGluc3RhbmNlb2YgRmllbGQpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7XG4gICAgICAgIGVudGl0eU5vZGUsXG4gICAgICAgIGVudGl0eSxcbiAgICAgICAgZmllbGRcbiAgICB9O1xufTtcblxuZXhwb3J0cy5wbHVyYWxpemUgPSAobmFtZSkgPT4ge1xuICAgIGxldCBwYXJ0cyA9IF8ua2ViYWJDYXNlKG5hbWUpLnNwbGl0KCctJyk7XG4gICAgbGV0IGxhc3QgPSBwbHVyYWxpemUocGFydHMucG9wKCkudG9Mb3dlckNhc2UoKSk7XG4gICAgcGFydHMucHVzaChsYXN0KTtcbiAgICByZXR1cm4gXy5jYW1lbENhc2UocGFydHMuam9pbignLScpKTtcbn07XG5cbmV4cG9ydHMuZGVlcENsb25lID0gZGVlcENsb25lO1xuZXhwb3J0cy5kZWVwQ2xvbmVGaWVsZCA9IGRlZXBDbG9uZUZpZWxkO1xuZXhwb3J0cy5pc0RvdFNlcGFyYXRlTmFtZSA9IGlzRG90U2VwYXJhdGVOYW1lO1xuZXhwb3J0cy5leHRyYWN0RG90U2VwYXJhdGVOYW1lID0gZXh0cmFjdERvdFNlcGFyYXRlTmFtZTtcbmV4cG9ydHMuZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lID0gZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lO1xuZXhwb3J0cy5nZXRSZWZlcmVuY2VOYW1lSWZJdElzID0gZ2V0UmVmZXJlbmNlTmFtZUlmSXRJcztcbmV4cG9ydHMuc2NoZW1hTmFtaW5nID0gbmFtZSA9PiBfLmNhbWVsQ2FzZShuYW1lKTtcbmV4cG9ydHMuZW50aXR5TmFtaW5nID0gbmFtZSA9PiBfLmNhbWVsQ2FzZShuYW1lKTtcbmV4cG9ydHMuZmllbGROYW1pbmcgPSBuYW1lID0+IF8uY2FtZWxDYXNlKG5hbWUpO1xuZXhwb3J0cy5wcmVmaXhOYW1pbmcgPSBwcmVmaXhOYW1pbmc7XG5leHBvcnRzLmdlbmVyYXRlRGlzcGxheU5hbWUgPSBuYW1lID0+IF8uc3RhcnRDYXNlKG5hbWUpO1xuZXhwb3J0cy5mb3JtYXRGaWVsZHMgPSBmaWVsZCA9PiBBcnJheS5pc0FycmF5KGZpZWxkKSA/IGZpZWxkLmpvaW4oJywgJykgOiBmaWVsZDtcbmV4cG9ydHMuQ2xvbmFibGUgPSBDbG9uYWJsZTsiXX0=
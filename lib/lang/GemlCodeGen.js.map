{"version":3,"sources":["../../src/lang/GemlCodeGen.js"],"names":["_","quote","require","generateDisplayName","isNothing","isQuotedWith","KW_NAMESPACE","KW_SCHEMA","KW_ENTITIES","KW_ENTITY_AS_ALIAS","KW_TYPE_DEFINE","KW_ENTITY","KW_CODE","KW_COMMENT","KW_WITH_FEATURE","KW_FIELDS","KW_ASSOCIATIONS","KW_KEY","KW_INDEXES","Types","GemlTypes","GemlCodeGen","transform","json","options","codeGen","generate","constructor","generateObject","content","appendLine","line","arguments","length","join","indented","repeat","indent","dedent","post","obj","forOwn","v","k","generateMethod","Error","generate_namespace","namespaces","pre","Array","isArray","forEach","ns","generate_schema","schema","schemaInfo","name","entities","entityEntry","alias","entity","generate_type","types","isPlainObject","isEmpty","type","lineInfo","_translateType","generate_field_comment","entityName","colName","colNameFullSnake","trimStart","snakeCase","colNameFirstWord","colNameRest","split","result","entityNameFullSnake","trim","endsWith","generate_entity","enityName","source","comment","hasAutoId","features","feature","args","map","a","JSON","stringify","fields","field","assert","push","Builtin","has","associations","srcField","destEntity","connectedBy","key","indexes","i","indexInfo","unique","extraTypeInfo","omit","castArray","_translateArgs","modifiers","_translatePipedValue","value","oolType","Lang","VALIDATOR","_translateModifier","PROCESSOR","ACTIVATOR","f","r","_translateArg","hasOwnProperty","pipeline","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nconst { _, quote } = require('@genx/july');\nconst { generateDisplayName } = require('./GemlUtils');\nconst { isNothing, isQuotedWith } = require('../utils/lang');\n\nconst KW_NAMESPACE = 'import';\nconst KW_SCHEMA = 'schema';\nconst KW_ENTITIES = 'entities';\nconst KW_ENTITY_AS_ALIAS = 'as';\nconst KW_TYPE_DEFINE = 'type';\nconst KW_ENTITY = 'entity';\nconst KW_CODE = 'code';\nconst KW_COMMENT = '--';\nconst KW_WITH_FEATURE = 'with';\nconst KW_FIELDS = 'has';\nconst KW_ASSOCIATIONS = 'associations';\nconst KW_KEY = 'key';\nconst KW_INDEXES = 'index';\n\nconst { Types } = require('@genx/data');\nconst GemlTypes = require('./GemlTypes');\n\nclass GemlCodeGen {\n    static transform(json, options) {\n        let codeGen = new GemlCodeGen(options);\n        return codeGen.generate(json);\n    }\n\n    indented = 0;\n    content = '';\n\n    constructor(options) {\n        this.options = options;\n    }\n\n    generate(json) {\n        this.generateObject(json);\n\n        return this.content;\n    }\n\n    appendLine(line) {\n        if (line) {\n            if (arguments.length > 1) {\n                line = [ ...arguments].join(' ');\n            }\n\n            this.content += (this.indented > 0 ? _.repeat(' ', this.indented) : '') + line + '\\n';\n        } else {\n            this.content += '\\n';\n        }\n        return this;\n    }\n\n    indent() {\n        this.indented += 2;\n        return this;\n    }\n\n    dedent() {\n        this.indented -= 2;\n        return this;\n        post: this.indented >= 0, 'Unexpected indented state.';\n    }\n\n    generateObject(obj) {\n        _.forOwn(obj, (v,k) => {\n            let generateMethod = 'generate_' + k;\n\n            if (generateMethod in this) {\n                return this[generateMethod](v);\n            }\n\n            throw new Error('to be implemented, object: ' + k);\n        });\n    }\n\n    generate_namespace(namespaces) {\n        pre: {\n            Array.isArray(namespaces), 'Invalid namespaces.';\n            this.indented == 0, 'Unexpected indented state.';\n        }\n\n        if (namespaces.length > 0) {\n            this.appendLine(KW_NAMESPACE).indent();\n\n            namespaces.forEach(ns => {\n                this.appendLine(quote(ns, \"'\"));\n            });\n\n            this.dedent().appendLine();\n        }\n\n        post: this.indented == 0, 'Unexpected indented state.';\n    }\n\n    generate_schema(schema) {\n        pre: {            \n            this.indented == 0, 'Unexpected indented state.';\n        }\n\n        _.forOwn(schema, (schemaInfo, name) => {\n            this.appendLine(KW_SCHEMA, quote(name, \"'\")).indent();\n\n            if (schemaInfo.entities) {\n                this.appendLine(KW_ENTITIES).indent();\n\n                schemaInfo.entities.forEach(entityEntry => {\n                    if (entityEntry.alias) {\n                        this.appendLine(entityEntry.entity, KW_ENTITY_AS_ALIAS, entityEntry.alias);\n                    } else {\n                        this.appendLine(entityEntry.entity);\n                    }\n                });\n\n                this.dedent().appendLine();\n            }\n\n            this.dedent();\n        });        \n\n        post: this.indented == 0, 'Unexpected indented state.';\n    }\n\n    generate_type(types) {\n        pre: {\n            _.isPlainObject(types), 'Invalid types.';\n            this.indented == 0, 'Unexpected indented state.';\n        }\n\n        if (!_.isEmpty(types)) {\n            this.appendLine(KW_TYPE_DEFINE).indent();\n\n            _.forOwn(types, (type, name) => {\n                let lineInfo = [ name, ':', type.type ];\n\n                this._translateType(type, lineInfo);\n\n                this.appendLine(...lineInfo);\n            });\n\n            this.dedent().appendLine();\n        }\n\n        post: this.indented == 0, 'Unexpected indented state.';\n    }\n\n    generate_field_comment(entityName, colName) {\n        let colNameFullSnake = _.trimStart(_.snakeCase(colName), '_');\n        let  [ colNameFirstWord, colNameRest ] = colNameFullSnake.split('_', 2);\n\n        let result;\n\n        let entityNameFullSnake = _.trim(_.snakeCase(entityName), '_');\n        if (_.endsWith(entityNameFullSnake, colNameFirstWord)) {\n            result = entityNameFullSnake + '_' + colNameRest;\n        } else {\n            result = entityNameFullSnake + '_' + colNameFullSnake;\n        }\n\n        return generateDisplayName(result);\n    }\n\n    generate_entity(entities) {\n        pre: {\n            _.isPlainObject(entities), 'Invalid entities.';\n            this.indented == 0, 'Unexpected indented state.';\n        }\n\n        _.forOwn(entities, (entity, enityName) => {\n            this.appendLine(KW_ENTITY, enityName).indent();\n\n            if (entity.source) {\n                this.appendLine(KW_CODE, quote(entity.source));\n            }\n\n            this.appendLine(KW_COMMENT, quote(entity.comment || generateDisplayName(enityName)));\n\n            let hasAutoId = false;\n\n            if (!_.isEmpty(entity.features)) {\n                this.appendLine(KW_WITH_FEATURE).indent();\n\n                entity.features.forEach(feature => {\n                    if (typeof feature === 'string') {\n                        feature = { name: feature };\n                    }\n\n                    if (feature.name === 'autoId') {\n                        hasAutoId = true;\n                    }\n\n                    if (feature.args) {\n                        this.appendLine(feature.name + '(' + feature.args.map(a => JSON.stringify(a)).join(', ') + ')');\n                    } else {\n                        this.appendLine(feature.name);\n                    }\n                });\n\n                this.dedent();\n            }\n\n            if (!_.isEmpty(entity.fields)) {\n                this.appendLine().appendLine(KW_FIELDS).indent();\n\n                _.forOwn(entity.fields, (field, name) => {\n                    assert: field.type;                    \n\n                    let lineInfo = [];\n                    lineInfo.push(Types.Builtin.has(name) ? quote(name) : name);                    \n                    \n                    if (field.type !== name) {\n                        lineInfo.push(':');\n                        lineInfo.push(field.type);\n                    }                  \n\n                    this._translateType(field, lineInfo);\n\n                    lineInfo.push(KW_COMMENT + ' ' + quote(field.comment || this.generate_field_comment(enityName, name)));\n\n                    this.appendLine(...lineInfo);\n                });\n\n                this.dedent();\n            }\n\n            if (!_.isEmpty(entity.associations)) {\n                this.appendLine().appendLine(KW_ASSOCIATIONS).indent();\n\n                entity.associations.forEach(({ type, srcField, destEntity, connectedBy }) => {\n                    if (srcField) {\n                        this.appendLine(type, quote(destEntity, \"'\"), 'as', quote(srcField, \"'\"));\n                    } else if (connectedBy) {\n                        this.appendLine(type, quote(destEntity, \"'\"), 'connectedBy', quote(connectedBy, \"'\"));\n                    } else {\n                        this.appendLine(type, quote(destEntity, \"'\"));\n                    }                    \n                });\n\n                this.dedent();\n            }\n\n            if (entity.key && !hasAutoId) {\n                let key = (Array.isArray(entity.key) && entity.key.length === 1) ? entity.key[0] : entity.key;\n                if (Array.isArray(key)) {\n                    this.appendLine().appendLine(KW_KEY, '[ ' + key.join(', ') + ' ]');\n                } else {\n                    this.appendLine().appendLine(KW_KEY, key);\n                }                \n            }\n\n            if (!_.isEmpty(entity.indexes)) {\n                this.appendLine().appendLine(KW_INDEXES).indent();\n\n                entity.indexes.forEach(i => {\n                    let indexInfo = [];\n\n                    if (Array.isArray(i.fields)) {\n                        indexInfo.push('[' + i.fields.join(', ') + ']');\n                    } else {\n                        indexInfo.push(i.fields);\n                    }\n\n                    if (i.unique) {\n                        indexInfo.push('is');\n                        indexInfo.push('unique');\n                    }\n\n                    this.appendLine(...indexInfo);\n                });\n\n                this.dedent();\n            }\n\n            this.dedent();\n        });\n\n        post: this.indented == 0, 'Unexpected indented state.';\n    }\n\n    _translateType(field, lineInfo) {\n        let extraTypeInfo = _.omit(field, ['type', 'modifiers', 'name']);\n        //let typeMeta = Types[field.type];\n        _.forOwn(extraTypeInfo, (v, k) => {\n            //if (!typeMeta.qualifiers.includes(k)) {\n            //    throw new Error(`\"${k}\" is not a valid qualifier for type \"${field.type}\".`);\n            //}\n            if (k === 'comment') return;\n\n            if (typeof v === 'boolean' || isNothing(v)) {\n                if (v) {\n                    lineInfo.push(k);\n                }\n            } else {\n                v = _.castArray(v);\n                lineInfo.push(k + '(' + this._translateArgs(v) + ')');\n            }\n        });\n\n        if (field.modifiers) {\n            this._translatePipedValue(lineInfo, field);\n        }        \n    }\n\n    _translatePipedValue(lineInfo, value) {        \n        if (value.modifiers) {\n            value.modifiers.forEach(v => {\n                switch (v.oolType) {\n                    case GemlTypes.Lang.VALIDATOR:\n                    lineInfo.push('|~' + this._translateModifier(v));\n                    break;\n\n                    case GemlTypes.Lang.PROCESSOR:\n                    lineInfo.push('|>' + this._translateModifier(v));\n                    break;\n\n                    case GemlTypes.Lang.ACTIVATOR:\n                    lineInfo.push('|=' + this._translateModifier(v));\n                    break;\n\n                    default:\n                        throw new Error(`Unknown modifier type: \"${v.oolType}\"!`);\n                }                                \n            });\n        } \n    }\n\n    _translateModifier(f) {\n        let r = f.name;\n\n        if (!_.isEmpty(f.args)) {\n            r += '(';\n\n            r += this._translateArgs(f.args);\n\n            r += ')';\n        }\n\n        return r;\n    }\n\n    _translateArgs(args) {\n        return args.map(a => this._translateArg(a)).join(', ');\n    }\n\n    _translateArg(a) {\n        if (_.isPlainObject(a) && a.hasOwnProperty('oolType')) {\n            if (a.oolType === 'PipedValue') {\n                let pipeline = [ this._translateArg(a.value) ];\n\n                if (a.modifiers) {\n                    this._translatePipedValue(pipeline, a);\n                }\n\n                return pipeline.join(' ');\n            } else if (a.oolType === 'ObjectReference') {\n                return '@' + a.name;\n            } else {\n                throw new Error('Not supported oolType: ' + a.oolType);\n            }\n        } \n\n        if (typeof a === 'string' && isQuotedWith(a, '/')) return a;\n        \n        return JSON.stringify(a);\n    }\n}\n\nmodule.exports = GemlCodeGen;"],"file":"GemlCodeGen.js"}
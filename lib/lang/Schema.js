"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable,
  schemaNaming
} = require('./GemlUtils');

class Schema extends Clonable {
  constructor(linker, name, gemlModule, info, deploymentSettings) {
    super();
    this.entities = {};
    this.datasets = {};
    this.views = {};
    this.linker = linker;
    this.name = schemaNaming(name);
    this.gemlModule = gemlModule;
    this.info = info;
    this.deploymentSettings = deploymentSettings;
  }

  link() {
    this.linker.log('debug', 'Linking schema [' + this.name + '] ...');

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);
    this.info.entities || (this.info.entities = []);
    this.info.entities.forEach(entityEntry => {
      let entity = this.linker.loadEntity(this.gemlModule, entityEntry.entity);
      this.addEntity(entity);
    });

    if (!_.isEmpty(this.info.views)) {
      this.info.views.forEach(viewName => {
        this.linker.loadView(this.gemlModule, viewName);
        this.addView(view);
      });
    }

    this.linked = true;
    return this;
  }

  hasEntity(entityName) {
    return entityName in this.entities;
  }

  addEntity(entity) {
    this.entities[entity.name] = entity;
    return this;
  }

  hasView(viewName) {
    return viewName in this.views;
  }

  addView(view) {
    this.views[view.name] = view;
    return this;
  }

  getDocumentHierachy(fromModule, datasetName) {
    if (datasetName in this.datasets) {
      return this.datasets[datasetName];
    }

    let dataset = this.linker.loadDataset(fromModule, datasetName);
    return this.datasets[datasetName] = dataset.buildHierarchy(this);
  }

  getReferencedEntity(refererModule, entityName) {
    let entity = this.linker.loadEntity(refererModule, entityName);

    if (!this.hasEntity(entity.name)) {
      throw new Error(`Entity "${entity.name}" not exists in schema "${this.name}".`);
    }

    return entity;
  }

  ensureGetEntity(refererModule, entityName, newlyAdded) {
    if (this.hasEntity(entityName)) return this.entities[entityName];
    let entity = this.linker.loadEntity(refererModule, entityName, false);

    if (entity) {
      this.addEntity(entity);

      if (newlyAdded) {
        newlyAdded.push(entity.name);
        this.linker.log('debug', `New entity "${entity.name}" added by association.`);
      }
    }

    return entity;
  }

  clone() {
    super.clone();
    let schema = new Schema(this.linker, this.name, this.gemlModule, this.info, this.deploymentSettings);
    deepCloneField(this, schema, 'displayName');
    deepCloneField(this, schema, 'comment');
    deepCloneField(this, schema, 'entities');
    deepCloneField(this, schema, 'datasets');
    deepCloneField(this, schema, 'views');
    schema.linked = true;
    return schema;
  }

  toJSON() {
    return {
      name: this.name,
      displayName: this.displayName,
      comment: this.comment,
      entities: _.mapValues(this.entities, entity => entity.toJSON()),
      datasets: _.mapValues(this.datasets, dataset => dataset.toJSON()),
      views: _.mapValues(this.views, view => view.toJSON())
    };
  }

}

module.exports = Schema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL1NjaGVtYS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImdlbmVyYXRlRGlzcGxheU5hbWUiLCJkZWVwQ2xvbmVGaWVsZCIsIkNsb25hYmxlIiwic2NoZW1hTmFtaW5nIiwiU2NoZW1hIiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwiZ2VtbE1vZHVsZSIsImluZm8iLCJkZXBsb3ltZW50U2V0dGluZ3MiLCJlbnRpdGllcyIsImRhdGFzZXRzIiwidmlld3MiLCJsaW5rIiwibG9nIiwiY29tbWVudCIsImRpc3BsYXlOYW1lIiwiZm9yRWFjaCIsImVudGl0eUVudHJ5IiwiZW50aXR5IiwibG9hZEVudGl0eSIsImFkZEVudGl0eSIsImlzRW1wdHkiLCJ2aWV3TmFtZSIsImxvYWRWaWV3IiwiYWRkVmlldyIsInZpZXciLCJsaW5rZWQiLCJoYXNFbnRpdHkiLCJlbnRpdHlOYW1lIiwiaGFzVmlldyIsImdldERvY3VtZW50SGllcmFjaHkiLCJmcm9tTW9kdWxlIiwiZGF0YXNldE5hbWUiLCJkYXRhc2V0IiwibG9hZERhdGFzZXQiLCJidWlsZEhpZXJhcmNoeSIsImdldFJlZmVyZW5jZWRFbnRpdHkiLCJyZWZlcmVyTW9kdWxlIiwiRXJyb3IiLCJlbnN1cmVHZXRFbnRpdHkiLCJuZXdseUFkZGVkIiwicHVzaCIsImNsb25lIiwic2NoZW1hIiwidG9KU09OIiwibWFwVmFsdWVzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxtQkFBRjtBQUF1QkMsRUFBQUEsY0FBdkI7QUFBdUNDLEVBQUFBLFFBQXZDO0FBQWlEQyxFQUFBQTtBQUFqRCxJQUFrRUosT0FBTyxDQUFDLGFBQUQsQ0FBL0U7O0FBTUEsTUFBTUssTUFBTixTQUFxQkYsUUFBckIsQ0FBOEI7QUF5QjFC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dXRpbHMnKTtcbmNvbnN0IHsgZ2VuZXJhdGVEaXNwbGF5TmFtZSwgZGVlcENsb25lRmllbGQsIENsb25hYmxlLCBzY2hlbWFOYW1pbmcgfSA9IHJlcXVpcmUoJy4vR2VtbFV0aWxzJyk7XG5cbi8qKlxuICogT29sb25nIHNjaGVtYSBjbGFzcy5cbiAqIEBjbGFzcyBPb2xvbmdTY2hlbWFcbiAqL1xuY2xhc3MgU2NoZW1hIGV4dGVuZHMgQ2xvbmFibGUge1xuICAgIC8qKlxuICAgICAqIEVudGl0aWVzIGluIHRoaXMgc2NoZW1hLCBtYXAgb2YgPGVudGl0eU5hbWUsIGVudGl0eU9iamVjdD5cbiAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgT29sb25nRW50aXR5Pn1cbiAgICAgKi9cbiAgICBlbnRpdGllcyA9IHt9O1xuXG4gICAgLyoqXG4gICAgICogRGF0YXNldHMsIGRhdGFzZXQgPSBlbnRpdHkgKyByZWxhdGlvbnMgKyBwcm9qZWN0aW9uXG4gICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAqL1xuICAgIGRhdGFzZXRzID0ge307XG5cbiAgICAvKipcbiAgICAgKiBWaWV3cywgdmlldyA9IGRhdGFzZXQgKyBmaWx0ZXJzIFxuICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgKi9cbiAgICB2aWV3cyA9IHt9OyAgICBcblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtPb2xvbmdMaW5rZXJ9IGxpbmtlclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGdlbWxNb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgZ2VtbE1vZHVsZSwgaW5mbywgZGVwbG95bWVudFNldHRpbmdzKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgc2NoZW1hXG4gICAgICAgICAqIEBtZW1iZXIge09vbG9uZ0xpbmtlcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubGlua2VyID0gbGlua2VyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubmFtZSA9IHNjaGVtYU5hbWluZyhuYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgZ2VtbCBtb2R1bGVcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5nZW1sTW9kdWxlID0gZ2VtbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87ICAgICAgICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogRGVwbG95bWVudCBzZXR0aW5nc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRlcGxveW1lbnRTZXR0aW5ncyA9IGRlcGxveW1lbnRTZXR0aW5ncztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIHRoaXMgc2NoZW1hXG4gICAgICogQHJldHVybnMge1NjaGVtYX1cbiAgICAgKi9cbiAgICBsaW5rKCkge1xuICAgICAgICBwcmU6ICF0aGlzLmxpbmtlZDtcblxuICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2RlYnVnJywgJ0xpbmtpbmcgc2NoZW1hIFsnICsgdGhpcy5uYW1lICsgJ10gLi4uJyk7XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5jb21tZW50KSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdGhpcy5jb21tZW50ID0gdGhpcy5pbmZvLmNvbW1lbnQ7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kaXNwbGF5TmFtZSA9IGdlbmVyYXRlRGlzcGxheU5hbWUodGhpcy5uYW1lKTtcblxuICAgICAgICAvLzFzdCByb3VuZCwgZ2V0IGRpcmVjdCBvdXRwdXQgZW50aXRpZXNcbiAgICAgICAgdGhpcy5pbmZvLmVudGl0aWVzIHx8ICh0aGlzLmluZm8uZW50aXRpZXMgPSBbXSk7XG5cbiAgICAgICAgdGhpcy5pbmZvLmVudGl0aWVzLmZvckVhY2goZW50aXR5RW50cnkgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkodGhpcy5nZW1sTW9kdWxlLCBlbnRpdHlFbnRyeS5lbnRpdHkpO1xuICAgICAgICAgICAgYXNzZXJ0OiBlbnRpdHkubGlua2VkO1xuXG4gICAgICAgICAgICB0aGlzLmFkZEVudGl0eShlbnRpdHkpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8udmlld3MpKSB7XG4gICAgICAgICAgICB0aGlzLmluZm8udmlld3MuZm9yRWFjaCh2aWV3TmFtZSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5saW5rZXIubG9hZFZpZXcodGhpcy5nZW1sTW9kdWxlLCB2aWV3TmFtZSk7XG4gICAgICAgICAgICAgICAgYXNzZXJ0OiB2aWV3LmxpbmtlZDtcblxuICAgICAgICAgICAgICAgIHRoaXMuYWRkVmlldyh2aWV3KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSBlbnRpdHkgd2l0aCBnaXZlbiBuYW1lIGlzIGluIHRoZSBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZW50aXR5TmFtZVxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGhhc0VudGl0eShlbnRpdHlOYW1lKSB7XG4gICAgICAgIHJldHVybiAoZW50aXR5TmFtZSBpbiB0aGlzLmVudGl0aWVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gZW50aXR5IGludG8gdGhlIHNjaGVtYVxuICAgICAqIEBwYXJhbSB7T29sb25nRW50aXR5fSBlbnRpdHlcbiAgICAgKiBAcmV0dXJucyB7T29sb25nU2NoZW1hfVxuICAgICAqL1xuICAgIGFkZEVudGl0eShlbnRpdHkpIHtcbiAgICAgICAgcHJlOiAhdGhpcy5oYXNFbnRpdHkoZW50aXR5Lm5hbWUpLCBgRW50aXR5IG5hbWUgWyR7ZW50aXR5Lm5hbWV9XSBjb25mbGljdHMgaW4gc2NoZW1hIFske3RoaXMubmFtZX1dLmA7XG5cbiAgICAgICAgdGhpcy5lbnRpdGllc1tlbnRpdHkubmFtZV0gPSBlbnRpdHk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIHZpZXcgd2l0aCBnaXZlbiBuYW1lIGlzIGluIHRoZSBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmlld05hbWVcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNWaWV3KHZpZXdOYW1lKSB7XG4gICAgICAgIHJldHVybiAodmlld05hbWUgaW4gdGhpcy52aWV3cyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgdmlldyBpbnRvIHRoZSBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge09vbG9uZ1ZpZXd9IHZpZXcgXG4gICAgICogQHJldHVybnMge09vbG9uZ1NjaGVtYX1cbiAgICAgKi9cbiAgICBhZGRWaWV3KHZpZXcpIHtcbiAgICAgICAgcHJlOiAhdGhpcy5oYXNWaWV3KHZpZXcubmFtZSksIGBWaWV3IG5hbWUgWyR7dmlldy5uYW1lfV0gY29uZmxpY3RzIGluIHNjaGVtYSBbJHt0aGlzLm5hbWV9XS5gO1xuXG4gICAgICAgIHRoaXMudmlld3Nbdmlldy5uYW1lXSA9IHZpZXc7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgZG9jdW1lbnQgaGllcmFyY2h5XG4gICAgICogQHBhcmFtIHtvYmplY3R9IGZyb21Nb2R1bGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YXNldE5hbWVcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldERvY3VtZW50SGllcmFjaHkoZnJvbU1vZHVsZSwgZGF0YXNldE5hbWUpIHtcbiAgICAgICAgaWYgKGRhdGFzZXROYW1lIGluIHRoaXMuZGF0YXNldHMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGFzZXRzW2RhdGFzZXROYW1lXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkYXRhc2V0ID0gdGhpcy5saW5rZXIubG9hZERhdGFzZXQoZnJvbU1vZHVsZSwgZGF0YXNldE5hbWUpO1xuICAgICAgICByZXR1cm4gKHRoaXMuZGF0YXNldHNbZGF0YXNldE5hbWVdID0gZGF0YXNldC5idWlsZEhpZXJhcmNoeSh0aGlzKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSByZWZlcmVuY2VkIGVudGl0eSwgYWRkIGl0IGludG8gc2NoZW1hIGlmIG5vdCBpbiBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVmZXJlck1vZHVsZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbnRpdHlOYW1lXG4gICAgICogQHJldHVybnMge09vbG9uZ0VudGl0eX1cbiAgICAgKi9cbiAgICBnZXRSZWZlcmVuY2VkRW50aXR5KHJlZmVyZXJNb2R1bGUsIGVudGl0eU5hbWUpIHtcbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkocmVmZXJlck1vZHVsZSwgZW50aXR5TmFtZSk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmhhc0VudGl0eShlbnRpdHkubmFtZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRW50aXR5IFwiJHtlbnRpdHkubmFtZX1cIiBub3QgZXhpc3RzIGluIHNjaGVtYSBcIiR7dGhpcy5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0geyp9IHJlZmVyZXJNb2R1bGUgXG4gICAgICogQHBhcmFtIHsqfSBlbnRpdHlOYW1lIFxuICAgICAqL1xuICAgIGVuc3VyZUdldEVudGl0eShyZWZlcmVyTW9kdWxlLCBlbnRpdHlOYW1lLCBuZXdseUFkZGVkKSB7XG4gICAgICAgIGlmICh0aGlzLmhhc0VudGl0eShlbnRpdHlOYW1lKSkgcmV0dXJuIHRoaXMuZW50aXRpZXNbZW50aXR5TmFtZV07XG5cbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkocmVmZXJlck1vZHVsZSwgZW50aXR5TmFtZSwgZmFsc2UpO1xuXG4gICAgICAgIGlmIChlbnRpdHkpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRW50aXR5KGVudGl0eSk7ICAgXG5cbiAgICAgICAgICAgIGlmIChuZXdseUFkZGVkKSB7XG4gICAgICAgICAgICAgICAgbmV3bHlBZGRlZC5wdXNoKGVudGl0eS5uYW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2RlYnVnJywgYE5ldyBlbnRpdHkgXCIke2VudGl0eS5uYW1lfVwiIGFkZGVkIGJ5IGFzc29jaWF0aW9uLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9uZSB0aGUgc2NoZW1hXG4gICAgICogQHJldHVybnMge1NjaGVtYX1cbiAgICAgKi9cbiAgICBjbG9uZSgpIHtcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBzY2hlbWEgPSBuZXcgU2NoZW1hKHRoaXMubGlua2VyLCB0aGlzLm5hbWUsIHRoaXMuZ2VtbE1vZHVsZSwgdGhpcy5pbmZvLCB0aGlzLmRlcGxveW1lbnRTZXR0aW5ncyk7XG4gICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBzY2hlbWEsICdkaXNwbGF5TmFtZScpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBzY2hlbWEsICdjb21tZW50Jyk7ICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgc2NoZW1hLCAnZW50aXRpZXMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBzY2hlbWEsICdkYXRhc2V0cycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBzY2hlbWEsICd2aWV3cycpOyAgICAgICAgXG5cbiAgICAgICAgc2NoZW1hLmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHNjaGVtYTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgdGhlIHNjaGVtYSBpbnRvIGEgcGxhaW4gSlNPTiBvYmplY3RcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHRvSlNPTigpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLmRpc3BsYXlOYW1lLFxuICAgICAgICAgICAgY29tbWVudDogdGhpcy5jb21tZW50LCAgICAgICAgXG4gICAgICAgICAgICBlbnRpdGllczogXy5tYXBWYWx1ZXModGhpcy5lbnRpdGllcywgZW50aXR5ID0+IGVudGl0eS50b0pTT04oKSksICAgICAgICAgICAgXG4gICAgICAgICAgICBkYXRhc2V0czogXy5tYXBWYWx1ZXModGhpcy5kYXRhc2V0cywgZGF0YXNldCA9PiBkYXRhc2V0LnRvSlNPTigpKSwgXG4gICAgICAgICAgICB2aWV3czogXy5tYXBWYWx1ZXModGhpcy52aWV3cywgdmlldyA9PiB2aWV3LnRvSlNPTigpKSBcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU2NoZW1hOyJdfQ==
"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _
} = Util;

const {
  generateDisplayName
} = require('./OolUtils');

const {
  isNothing,
  isQuotedWith
} = require('../utils/lang');

const KW_NAMESPACE = 'import';
const KW_SCHEMA = 'schema';
const KW_ENTITIES = 'entities';
const KW_ENTITY_AS_ALIAS = 'as';
const KW_TYPE_DEFINE = 'type';
const KW_ENTITY = 'entity';
const KW_CODE = 'code';
const KW_COMMENT = '--';
const KW_WITH_FEATURE = 'with';
const KW_FIELDS = 'has';
const KW_ASSOCIATIONS = 'associations';
const KW_KEY = 'key';
const KW_INDEXES = 'index';

const {
  Types
} = require('@genx/data');

const OolTypes = require('./OolTypes');

class OolCodeGen {
  static transform(json, options) {
    let codeGen = new OolCodeGen(options);
    return codeGen.generate(json);
  }

  constructor(options) {
    this.indented = 0;
    this.content = '';
    this.options = options;
  }

  generate(json) {
    this.generateObject(json);
    return this.content;
  }

  appendLine(line) {
    if (line) {
      if (arguments.length > 1) {
        line = [...arguments].join(' ');
      }

      this.content += (this.indented > 0 ? _.repeat(' ', this.indented) : '') + line + '\n';
    } else {
      this.content += '\n';
    }

    return this;
  }

  indent() {
    this.indented += 2;
    return this;
  }

  dedent() {
    const _checkPostcondition = it => {
      if (!(this.indented >= 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    this.indented -= 2;
    return _checkPostcondition(this);
  }

  generateObject(obj) {
    _.forOwn(obj, (v, k) => {
      let generateMethod = 'generate_' + k;

      if (generateMethod in this) {
        return this[generateMethod](v);
      }

      throw new Error('to be implemented, object: ' + k);
    });
  }

  generate_namespace(namespaces) {
    const _checkPostcondition2 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!Array.isArray(namespaces)) {
      throw new Error('Invalid namespaces.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    if (namespaces.length > 0) {
      this.appendLine(KW_NAMESPACE).indent();
      namespaces.forEach(ns => {
        this.appendLine(Util.quote(ns, "'"));
      });
      this.dedent().appendLine();
    }

    _checkPostcondition2();
  }

  generate_schema(schema) {
    const _checkPostcondition3 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    _.forOwn(schema, (schemaInfo, name) => {
      this.appendLine(KW_SCHEMA, Util.quote(name, "'")).indent();

      if (schemaInfo.entities) {
        this.appendLine(KW_ENTITIES).indent();
        schemaInfo.entities.forEach(entityEntry => {
          if (entityEntry.alias) {
            this.appendLine(entityEntry.entity, KW_ENTITY_AS_ALIAS, entityEntry.alias);
          } else {
            this.appendLine(entityEntry.entity);
          }
        });
        this.dedent().appendLine();
      }

      this.dedent();
    });

    _checkPostcondition3();
  }

  generate_type(types) {
    const _checkPostcondition4 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!_.isPlainObject(types)) {
      throw new Error('Invalid types.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    if (!_.isEmpty(types)) {
      this.appendLine(KW_TYPE_DEFINE).indent();

      _.forOwn(types, (type, name) => {
        let lineInfo = [name, ':', type.type];

        this._translateType(type, lineInfo);

        this.appendLine(...lineInfo);
      });

      this.dedent().appendLine();
    }

    _checkPostcondition4();
  }

  generate_field_comment(entityName, colName) {
    let colNameFullSnake = _.trimStart(_.snakeCase(colName), '_');

    let [colNameFirstWord, colNameRest] = colNameFullSnake.split('_', 2);
    let result;

    let entityNameFullSnake = _.trim(_.snakeCase(entityName), '_');

    if (_.endsWith(entityNameFullSnake, colNameFirstWord)) {
      result = entityNameFullSnake + '_' + colNameRest;
    } else {
      result = entityNameFullSnake + '_' + colNameFullSnake;
    }

    return generateDisplayName(result);
  }

  generate_entity(entities) {
    const _checkPostcondition5 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!_.isPlainObject(entities)) {
      throw new Error('Invalid entities.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    _.forOwn(entities, (entity, enityName) => {
      this.appendLine(KW_ENTITY, enityName).indent();

      if (entity.source) {
        this.appendLine(KW_CODE, Util.quote(entity.source));
      }

      this.appendLine(KW_COMMENT, Util.quote(entity.comment || generateDisplayName(enityName)));
      let hasAutoId = false;

      if (!_.isEmpty(entity.features)) {
        this.appendLine(KW_WITH_FEATURE).indent();
        entity.features.forEach(feature => {
          if (typeof feature === 'string') {
            feature = {
              name: feature
            };
          }

          if (feature.name === 'autoId') {
            hasAutoId = true;
          }

          if (feature.args) {
            this.appendLine(feature.name + '(' + feature.args.map(a => JSON.stringify(a)).join(', ') + ')');
          } else {
            this.appendLine(feature.name);
          }
        });
        this.dedent();
      }

      if (!_.isEmpty(entity.fields)) {
        this.appendLine().appendLine(KW_FIELDS).indent();

        _.forOwn(entity.fields, (field, name) => {
          if (!field.type) {
            throw new Error("Assertion failed: field.type");
          }

          let lineInfo = [];
          lineInfo.push(Types.Builtin.has(name) ? Util.quote(name) : name);

          if (field.type !== name) {
            lineInfo.push(':');
            lineInfo.push(field.type);
          }

          this._translateType(field, lineInfo);

          lineInfo.push(KW_COMMENT + ' ' + Util.quote(field.comment || this.generate_field_comment(enityName, name)));
          this.appendLine(...lineInfo);
        });

        this.dedent();
      }

      if (!_.isEmpty(entity.associations)) {
        this.appendLine().appendLine(KW_ASSOCIATIONS).indent();
        entity.associations.forEach(({
          type,
          srcField,
          destEntity,
          connectedBy
        }) => {
          if (srcField) {
            this.appendLine(type, Util.quote(destEntity, "'"), 'as', Util.quote(srcField, "'"));
          } else if (connectedBy) {
            this.appendLine(type, Util.quote(destEntity, "'"), 'connectedBy', Util.quote(connectedBy, "'"));
          } else {
            this.appendLine(type, Util.quote(destEntity, "'"));
          }
        });
        this.dedent();
      }

      if (entity.key && !hasAutoId) {
        let key = Array.isArray(entity.key) && entity.key.length === 1 ? entity.key[0] : entity.key;

        if (Array.isArray(key)) {
          this.appendLine().appendLine(KW_KEY, '[ ' + key.join(', ') + ' ]');
        } else {
          this.appendLine().appendLine(KW_KEY, key);
        }
      }

      if (!_.isEmpty(entity.indexes)) {
        this.appendLine().appendLine(KW_INDEXES).indent();
        entity.indexes.forEach(i => {
          let indexInfo = [];

          if (Array.isArray(i.fields)) {
            indexInfo.push('[' + i.fields.join(', ') + ']');
          } else {
            indexInfo.push(i.fields);
          }

          if (i.unique) {
            indexInfo.push('is');
            indexInfo.push('unique');
          }

          this.appendLine(...indexInfo);
        });
        this.dedent();
      }

      this.dedent();
    });

    _checkPostcondition5();
  }

  _translateType(field, lineInfo) {
    let extraTypeInfo = _.omit(field, ['type', 'modifiers', 'name']);

    _.forOwn(extraTypeInfo, (v, k) => {
      if (k === 'comment') return;

      if (typeof v === 'boolean' || isNothing(v)) {
        if (v) {
          lineInfo.push(k);
        }
      } else {
        v = _.castArray(v);
        lineInfo.push(k + '(' + this._translateArgs(v) + ')');
      }
    });

    if (field.modifiers) {
      this._translatePipedValue(lineInfo, field);
    }
  }

  _translatePipedValue(lineInfo, value) {
    if (value.modifiers) {
      value.modifiers.forEach(v => {
        switch (v.oolType) {
          case OolTypes.Lang.VALIDATOR:
            lineInfo.push('|~' + this._translateModifier(v));
            break;

          case OolTypes.Lang.PROCESSOR:
            lineInfo.push('|>' + this._translateModifier(v));
            break;

          case OolTypes.Lang.ACTIVATOR:
            lineInfo.push('|=' + this._translateModifier(v));
            break;

          default:
            throw new Error(`Unknown modifier type: "${v.oolType}"!`);
        }
      });
    }
  }

  _translateModifier(f) {
    let r = f.name;

    if (!_.isEmpty(f.args)) {
      r += '(';
      r += this._translateArgs(f.args);
      r += ')';
    }

    return r;
  }

  _translateArgs(args) {
    return args.map(a => this._translateArg(a)).join(', ');
  }

  _translateArg(a) {
    if (_.isPlainObject(a) && a.hasOwnProperty('oolType')) {
      if (a.oolType === 'PipedValue') {
        let pipeline = [this._translateArg(a.value)];

        if (a.modifiers) {
          this._translatePipedValue(pipeline, a);
        }

        return pipeline.join(' ');
      } else if (a.oolType === 'ObjectReference') {
        return '@' + a.name;
      } else {
        throw new Error('Not supported oolType: ' + a.oolType);
      }
    }

    if (typeof a === 'string' && isQuotedWith(a, '/')) return a;
    return JSON.stringify(a);
  }

}

module.exports = OolCodeGen;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL09vbENvZGVHZW4uanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZ2VuZXJhdGVEaXNwbGF5TmFtZSIsImlzTm90aGluZyIsImlzUXVvdGVkV2l0aCIsIktXX05BTUVTUEFDRSIsIktXX1NDSEVNQSIsIktXX0VOVElUSUVTIiwiS1dfRU5USVRZX0FTX0FMSUFTIiwiS1dfVFlQRV9ERUZJTkUiLCJLV19FTlRJVFkiLCJLV19DT0RFIiwiS1dfQ09NTUVOVCIsIktXX1dJVEhfRkVBVFVSRSIsIktXX0ZJRUxEUyIsIktXX0FTU09DSUFUSU9OUyIsIktXX0tFWSIsIktXX0lOREVYRVMiLCJUeXBlcyIsIk9vbFR5cGVzIiwiT29sQ29kZUdlbiIsInRyYW5zZm9ybSIsImpzb24iLCJvcHRpb25zIiwiY29kZUdlbiIsImdlbmVyYXRlIiwiY29uc3RydWN0b3IiLCJpbmRlbnRlZCIsImNvbnRlbnQiLCJnZW5lcmF0ZU9iamVjdCIsImFwcGVuZExpbmUiLCJsaW5lIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiam9pbiIsInJlcGVhdCIsImluZGVudCIsImRlZGVudCIsIm9iaiIsImZvck93biIsInYiLCJrIiwiZ2VuZXJhdGVNZXRob2QiLCJFcnJvciIsImdlbmVyYXRlX25hbWVzcGFjZSIsIm5hbWVzcGFjZXMiLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwibnMiLCJxdW90ZSIsImdlbmVyYXRlX3NjaGVtYSIsInNjaGVtYSIsInNjaGVtYUluZm8iLCJuYW1lIiwiZW50aXRpZXMiLCJlbnRpdHlFbnRyeSIsImFsaWFzIiwiZW50aXR5IiwiZ2VuZXJhdGVfdHlwZSIsInR5cGVzIiwiaXNQbGFpbk9iamVjdCIsImlzRW1wdHkiLCJ0eXBlIiwibGluZUluZm8iLCJfdHJhbnNsYXRlVHlwZSIsImdlbmVyYXRlX2ZpZWxkX2NvbW1lbnQiLCJlbnRpdHlOYW1lIiwiY29sTmFtZSIsImNvbE5hbWVGdWxsU25ha2UiLCJ0cmltU3RhcnQiLCJzbmFrZUNhc2UiLCJjb2xOYW1lRmlyc3RXb3JkIiwiY29sTmFtZVJlc3QiLCJzcGxpdCIsInJlc3VsdCIsImVudGl0eU5hbWVGdWxsU25ha2UiLCJ0cmltIiwiZW5kc1dpdGgiLCJnZW5lcmF0ZV9lbnRpdHkiLCJlbml0eU5hbWUiLCJzb3VyY2UiLCJjb21tZW50IiwiaGFzQXV0b0lkIiwiZmVhdHVyZXMiLCJmZWF0dXJlIiwiYXJncyIsIm1hcCIsImEiLCJKU09OIiwic3RyaW5naWZ5IiwiZmllbGRzIiwiZmllbGQiLCJwdXNoIiwiQnVpbHRpbiIsImhhcyIsImFzc29jaWF0aW9ucyIsInNyY0ZpZWxkIiwiZGVzdEVudGl0eSIsImNvbm5lY3RlZEJ5Iiwia2V5IiwiaW5kZXhlcyIsImkiLCJpbmRleEluZm8iLCJ1bmlxdWUiLCJleHRyYVR5cGVJbmZvIiwib21pdCIsImNhc3RBcnJheSIsIl90cmFuc2xhdGVBcmdzIiwibW9kaWZpZXJzIiwiX3RyYW5zbGF0ZVBpcGVkVmFsdWUiLCJ2YWx1ZSIsIm9vbFR5cGUiLCJMYW5nIiwiVkFMSURBVE9SIiwiX3RyYW5zbGF0ZU1vZGlmaWVyIiwiUFJPQ0VTU09SIiwiQUNUSVZBVE9SIiwiZiIsInIiLCJfdHJhbnNsYXRlQXJnIiwiaGFzT3duUHJvcGVydHkiLCJwaXBlbGluZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUYsSUFBZDs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBMEJGLE9BQU8sQ0FBQyxZQUFELENBQXZDOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsU0FBRjtBQUFhQyxFQUFBQTtBQUFiLElBQThCSixPQUFPLENBQUMsZUFBRCxDQUEzQzs7QUFFQSxNQUFNSyxZQUFZLEdBQUcsUUFBckI7QUFDQSxNQUFNQyxTQUFTLEdBQUcsUUFBbEI7QUFDQSxNQUFNQyxXQUFXLEdBQUcsVUFBcEI7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxJQUEzQjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxNQUF2QjtBQUNBLE1BQU1DLFNBQVMsR0FBRyxRQUFsQjtBQUNBLE1BQU1DLE9BQU8sR0FBRyxNQUFoQjtBQUNBLE1BQU1DLFVBQVUsR0FBRyxJQUFuQjtBQUNBLE1BQU1DLGVBQWUsR0FBRyxNQUF4QjtBQUNBLE1BQU1DLFNBQVMsR0FBRyxLQUFsQjtBQUNBLE1BQU1DLGVBQWUsR0FBRyxjQUF4QjtBQUNBLE1BQU1DLE1BQU0sR0FBRyxLQUFmO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLE9BQW5COztBQUVBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFZbEIsT0FBTyxDQUFDLFlBQUQsQ0FBekI7O0FBQ0EsTUFBTW1CLFFBQVEsR0FBR25CLE9BQU8sQ0FBQyxZQUFELENBQXhCOztBQUVBLE1BQU1vQixVQUFOLENBQWlCO0FBQ2IsU0FBT0MsU0FBUCxDQUFpQkMsSUFBakIsRUFBdUJDLE9BQXZCLEVBQWdDO0FBQzVCLFFBQUlDLE9BQU8sR0FBRyxJQUFJSixVQUFKLENBQWVHLE9BQWYsQ0FBZDtBQUNBLFdBQU9DLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQkgsSUFBakIsQ0FBUDtBQUNIOztBQUtESSxFQUFBQSxXQUFXLENBQUNILE9BQUQsRUFBVTtBQUFBLFNBSHJCSSxRQUdxQixHQUhWLENBR1U7QUFBQSxTQUZyQkMsT0FFcUIsR0FGWCxFQUVXO0FBQ2pCLFNBQUtMLE9BQUwsR0FBZUEsT0FBZjtBQUNIOztBQUVERSxFQUFBQSxRQUFRLENBQUNILElBQUQsRUFBTztBQUNYLFNBQUtPLGNBQUwsQ0FBb0JQLElBQXBCO0FBRUEsV0FBTyxLQUFLTSxPQUFaO0FBQ0g7O0FBRURFLEVBQUFBLFVBQVUsQ0FBQ0MsSUFBRCxFQUFPO0FBQ2IsUUFBSUEsSUFBSixFQUFVO0FBQ04sVUFBSUMsU0FBUyxDQUFDQyxNQUFWLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3RCRixRQUFBQSxJQUFJLEdBQUcsQ0FBRSxHQUFHQyxTQUFMLEVBQWdCRSxJQUFoQixDQUFxQixHQUFyQixDQUFQO0FBQ0g7O0FBRUQsV0FBS04sT0FBTCxJQUFnQixDQUFDLEtBQUtELFFBQUwsR0FBZ0IsQ0FBaEIsR0FBb0IxQixDQUFDLENBQUNrQyxNQUFGLENBQVMsR0FBVCxFQUFjLEtBQUtSLFFBQW5CLENBQXBCLEdBQW1ELEVBQXBELElBQTBESSxJQUExRCxHQUFpRSxJQUFqRjtBQUNILEtBTkQsTUFNTztBQUNILFdBQUtILE9BQUwsSUFBZ0IsSUFBaEI7QUFDSDs7QUFDRCxXQUFPLElBQVA7QUFDSDs7QUFFRFEsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsU0FBS1QsUUFBTCxJQUFpQixDQUFqQjtBQUNBLFdBQU8sSUFBUDtBQUNIOztBQUVEVSxFQUFBQSxNQUFNLEdBQUc7QUFBQTtBQUFBLFlBR0MsS0FBS1YsUUFBTCxJQUFpQixDQUhsQjtBQUFBLHdCQUdxQiw0QkFIckI7QUFBQTs7QUFBQTtBQUFBOztBQUNMLFNBQUtBLFFBQUwsSUFBaUIsQ0FBakI7QUFDQSwrQkFBTyxJQUFQO0FBRUg7O0FBRURFLEVBQUFBLGNBQWMsQ0FBQ1MsR0FBRCxFQUFNO0FBQ2hCckMsSUFBQUEsQ0FBQyxDQUFDc0MsTUFBRixDQUFTRCxHQUFULEVBQWMsQ0FBQ0UsQ0FBRCxFQUFHQyxDQUFILEtBQVM7QUFDbkIsVUFBSUMsY0FBYyxHQUFHLGNBQWNELENBQW5DOztBQUVBLFVBQUlDLGNBQWMsSUFBSSxJQUF0QixFQUE0QjtBQUN4QixlQUFPLEtBQUtBLGNBQUwsRUFBcUJGLENBQXJCLENBQVA7QUFDSDs7QUFFRCxZQUFNLElBQUlHLEtBQUosQ0FBVSxnQ0FBZ0NGLENBQTFDLENBQU47QUFDSCxLQVJEO0FBU0g7O0FBRURHLEVBQUFBLGtCQUFrQixDQUFDQyxVQUFELEVBQWE7QUFBQTtBQUFBLFlBZ0JyQixLQUFLbEIsUUFBTCxJQUFpQixDQWhCSTtBQUFBLHdCQWdCRCw0QkFoQkM7QUFBQTs7QUFBQTtBQUFBOztBQUFBLFNBRXZCbUIsS0FBSyxDQUFDQyxPQUFOLENBQWNGLFVBQWQsQ0FGdUI7QUFBQSxzQkFFSSxxQkFGSjtBQUFBOztBQUFBLFVBR3ZCLEtBQUtsQixRQUFMLElBQWlCLENBSE07QUFBQSxzQkFHSCw0QkFIRztBQUFBOztBQU0zQixRQUFJa0IsVUFBVSxDQUFDWixNQUFYLEdBQW9CLENBQXhCLEVBQTJCO0FBQ3ZCLFdBQUtILFVBQUwsQ0FBZ0J6QixZQUFoQixFQUE4QitCLE1BQTlCO0FBRUFTLE1BQUFBLFVBQVUsQ0FBQ0csT0FBWCxDQUFtQkMsRUFBRSxJQUFJO0FBQ3JCLGFBQUtuQixVQUFMLENBQWdCL0IsSUFBSSxDQUFDbUQsS0FBTCxDQUFXRCxFQUFYLEVBQWUsR0FBZixDQUFoQjtBQUNILE9BRkQ7QUFJQSxXQUFLWixNQUFMLEdBQWNQLFVBQWQ7QUFDSDs7QUFkMEI7QUFpQjlCOztBQUVEcUIsRUFBQUEsZUFBZSxDQUFDQyxNQUFELEVBQVM7QUFBQTtBQUFBLFlBeUJkLEtBQUt6QixRQUFMLElBQWlCLENBekJIO0FBQUEsd0JBeUJNLDRCQXpCTjtBQUFBOztBQUFBO0FBQUE7O0FBQUEsVUFFaEIsS0FBS0EsUUFBTCxJQUFpQixDQUZEO0FBQUEsc0JBRUksNEJBRko7QUFBQTs7QUFLcEIxQixJQUFBQSxDQUFDLENBQUNzQyxNQUFGLENBQVNhLE1BQVQsRUFBaUIsQ0FBQ0MsVUFBRCxFQUFhQyxJQUFiLEtBQXNCO0FBQ25DLFdBQUt4QixVQUFMLENBQWdCeEIsU0FBaEIsRUFBMkJQLElBQUksQ0FBQ21ELEtBQUwsQ0FBV0ksSUFBWCxFQUFpQixHQUFqQixDQUEzQixFQUFrRGxCLE1BQWxEOztBQUVBLFVBQUlpQixVQUFVLENBQUNFLFFBQWYsRUFBeUI7QUFDckIsYUFBS3pCLFVBQUwsQ0FBZ0J2QixXQUFoQixFQUE2QjZCLE1BQTdCO0FBRUFpQixRQUFBQSxVQUFVLENBQUNFLFFBQVgsQ0FBb0JQLE9BQXBCLENBQTRCUSxXQUFXLElBQUk7QUFDdkMsY0FBSUEsV0FBVyxDQUFDQyxLQUFoQixFQUF1QjtBQUNuQixpQkFBSzNCLFVBQUwsQ0FBZ0IwQixXQUFXLENBQUNFLE1BQTVCLEVBQW9DbEQsa0JBQXBDLEVBQXdEZ0QsV0FBVyxDQUFDQyxLQUFwRTtBQUNILFdBRkQsTUFFTztBQUNILGlCQUFLM0IsVUFBTCxDQUFnQjBCLFdBQVcsQ0FBQ0UsTUFBNUI7QUFDSDtBQUNKLFNBTkQ7QUFRQSxhQUFLckIsTUFBTCxHQUFjUCxVQUFkO0FBQ0g7O0FBRUQsV0FBS08sTUFBTDtBQUNILEtBbEJEOztBQUxvQjtBQTBCdkI7O0FBRURzQixFQUFBQSxhQUFhLENBQUNDLEtBQUQsRUFBUTtBQUFBO0FBQUEsWUFvQlgsS0FBS2pDLFFBQUwsSUFBaUIsQ0FwQk47QUFBQSx3QkFvQlMsNEJBcEJUO0FBQUE7O0FBQUE7QUFBQTs7QUFBQSxTQUViMUIsQ0FBQyxDQUFDNEQsYUFBRixDQUFnQkQsS0FBaEIsQ0FGYTtBQUFBLHNCQUVXLGdCQUZYO0FBQUE7O0FBQUEsVUFHYixLQUFLakMsUUFBTCxJQUFpQixDQUhKO0FBQUEsc0JBR08sNEJBSFA7QUFBQTs7QUFNakIsUUFBSSxDQUFDMUIsQ0FBQyxDQUFDNkQsT0FBRixDQUFVRixLQUFWLENBQUwsRUFBdUI7QUFDbkIsV0FBSzlCLFVBQUwsQ0FBZ0JyQixjQUFoQixFQUFnQzJCLE1BQWhDOztBQUVBbkMsTUFBQUEsQ0FBQyxDQUFDc0MsTUFBRixDQUFTcUIsS0FBVCxFQUFnQixDQUFDRyxJQUFELEVBQU9ULElBQVAsS0FBZ0I7QUFDNUIsWUFBSVUsUUFBUSxHQUFHLENBQUVWLElBQUYsRUFBUSxHQUFSLEVBQWFTLElBQUksQ0FBQ0EsSUFBbEIsQ0FBZjs7QUFFQSxhQUFLRSxjQUFMLENBQW9CRixJQUFwQixFQUEwQkMsUUFBMUI7O0FBRUEsYUFBS2xDLFVBQUwsQ0FBZ0IsR0FBR2tDLFFBQW5CO0FBQ0gsT0FORDs7QUFRQSxXQUFLM0IsTUFBTCxHQUFjUCxVQUFkO0FBQ0g7O0FBbEJnQjtBQXFCcEI7O0FBRURvQyxFQUFBQSxzQkFBc0IsQ0FBQ0MsVUFBRCxFQUFhQyxPQUFiLEVBQXNCO0FBQ3hDLFFBQUlDLGdCQUFnQixHQUFHcEUsQ0FBQyxDQUFDcUUsU0FBRixDQUFZckUsQ0FBQyxDQUFDc0UsU0FBRixDQUFZSCxPQUFaLENBQVosRUFBa0MsR0FBbEMsQ0FBdkI7O0FBQ0EsUUFBSyxDQUFFSSxnQkFBRixFQUFvQkMsV0FBcEIsSUFBb0NKLGdCQUFnQixDQUFDSyxLQUFqQixDQUF1QixHQUF2QixFQUE0QixDQUE1QixDQUF6QztBQUVBLFFBQUlDLE1BQUo7O0FBRUEsUUFBSUMsbUJBQW1CLEdBQUczRSxDQUFDLENBQUM0RSxJQUFGLENBQU81RSxDQUFDLENBQUNzRSxTQUFGLENBQVlKLFVBQVosQ0FBUCxFQUFnQyxHQUFoQyxDQUExQjs7QUFDQSxRQUFJbEUsQ0FBQyxDQUFDNkUsUUFBRixDQUFXRixtQkFBWCxFQUFnQ0osZ0JBQWhDLENBQUosRUFBdUQ7QUFDbkRHLE1BQUFBLE1BQU0sR0FBR0MsbUJBQW1CLEdBQUcsR0FBdEIsR0FBNEJILFdBQXJDO0FBQ0gsS0FGRCxNQUVPO0FBQ0hFLE1BQUFBLE1BQU0sR0FBR0MsbUJBQW1CLEdBQUcsR0FBdEIsR0FBNEJQLGdCQUFyQztBQUNIOztBQUVELFdBQU9uRSxtQkFBbUIsQ0FBQ3lFLE1BQUQsQ0FBMUI7QUFDSDs7QUFFREksRUFBQUEsZUFBZSxDQUFDeEIsUUFBRCxFQUFXO0FBQUE7QUFBQSxZQWtIaEIsS0FBSzVCLFFBQUwsSUFBaUIsQ0FsSEQ7QUFBQSx3QkFrSEksNEJBbEhKO0FBQUE7O0FBQUE7QUFBQTs7QUFBQSxTQUVsQjFCLENBQUMsQ0FBQzRELGFBQUYsQ0FBZ0JOLFFBQWhCLENBRmtCO0FBQUEsc0JBRVMsbUJBRlQ7QUFBQTs7QUFBQSxVQUdsQixLQUFLNUIsUUFBTCxJQUFpQixDQUhDO0FBQUEsc0JBR0UsNEJBSEY7QUFBQTs7QUFNdEIxQixJQUFBQSxDQUFDLENBQUNzQyxNQUFGLENBQVNnQixRQUFULEVBQW1CLENBQUNHLE1BQUQsRUFBU3NCLFNBQVQsS0FBdUI7QUFDdEMsV0FBS2xELFVBQUwsQ0FBZ0JwQixTQUFoQixFQUEyQnNFLFNBQTNCLEVBQXNDNUMsTUFBdEM7O0FBRUEsVUFBSXNCLE1BQU0sQ0FBQ3VCLE1BQVgsRUFBbUI7QUFDZixhQUFLbkQsVUFBTCxDQUFnQm5CLE9BQWhCLEVBQXlCWixJQUFJLENBQUNtRCxLQUFMLENBQVdRLE1BQU0sQ0FBQ3VCLE1BQWxCLENBQXpCO0FBQ0g7O0FBRUQsV0FBS25ELFVBQUwsQ0FBZ0JsQixVQUFoQixFQUE0QmIsSUFBSSxDQUFDbUQsS0FBTCxDQUFXUSxNQUFNLENBQUN3QixPQUFQLElBQWtCaEYsbUJBQW1CLENBQUM4RSxTQUFELENBQWhELENBQTVCO0FBRUEsVUFBSUcsU0FBUyxHQUFHLEtBQWhCOztBQUVBLFVBQUksQ0FBQ2xGLENBQUMsQ0FBQzZELE9BQUYsQ0FBVUosTUFBTSxDQUFDMEIsUUFBakIsQ0FBTCxFQUFpQztBQUM3QixhQUFLdEQsVUFBTCxDQUFnQmpCLGVBQWhCLEVBQWlDdUIsTUFBakM7QUFFQXNCLFFBQUFBLE1BQU0sQ0FBQzBCLFFBQVAsQ0FBZ0JwQyxPQUFoQixDQUF3QnFDLE9BQU8sSUFBSTtBQUMvQixjQUFJLE9BQU9BLE9BQVAsS0FBbUIsUUFBdkIsRUFBaUM7QUFDN0JBLFlBQUFBLE9BQU8sR0FBRztBQUFFL0IsY0FBQUEsSUFBSSxFQUFFK0I7QUFBUixhQUFWO0FBQ0g7O0FBRUQsY0FBSUEsT0FBTyxDQUFDL0IsSUFBUixLQUFpQixRQUFyQixFQUErQjtBQUMzQjZCLFlBQUFBLFNBQVMsR0FBRyxJQUFaO0FBQ0g7O0FBRUQsY0FBSUUsT0FBTyxDQUFDQyxJQUFaLEVBQWtCO0FBQ2QsaUJBQUt4RCxVQUFMLENBQWdCdUQsT0FBTyxDQUFDL0IsSUFBUixHQUFlLEdBQWYsR0FBcUIrQixPQUFPLENBQUNDLElBQVIsQ0FBYUMsR0FBYixDQUFpQkMsQ0FBQyxJQUFJQyxJQUFJLENBQUNDLFNBQUwsQ0FBZUYsQ0FBZixDQUF0QixFQUF5Q3RELElBQXpDLENBQThDLElBQTlDLENBQXJCLEdBQTJFLEdBQTNGO0FBQ0gsV0FGRCxNQUVPO0FBQ0gsaUJBQUtKLFVBQUwsQ0FBZ0J1RCxPQUFPLENBQUMvQixJQUF4QjtBQUNIO0FBQ0osU0FkRDtBQWdCQSxhQUFLakIsTUFBTDtBQUNIOztBQUVELFVBQUksQ0FBQ3BDLENBQUMsQ0FBQzZELE9BQUYsQ0FBVUosTUFBTSxDQUFDaUMsTUFBakIsQ0FBTCxFQUErQjtBQUMzQixhQUFLN0QsVUFBTCxHQUFrQkEsVUFBbEIsQ0FBNkJoQixTQUE3QixFQUF3Q3NCLE1BQXhDOztBQUVBbkMsUUFBQUEsQ0FBQyxDQUFDc0MsTUFBRixDQUFTbUIsTUFBTSxDQUFDaUMsTUFBaEIsRUFBd0IsQ0FBQ0MsS0FBRCxFQUFRdEMsSUFBUixLQUFpQjtBQUFBLGVBQzdCc0MsS0FBSyxDQUFDN0IsSUFEdUI7QUFBQTtBQUFBOztBQUdyQyxjQUFJQyxRQUFRLEdBQUcsRUFBZjtBQUNBQSxVQUFBQSxRQUFRLENBQUM2QixJQUFULENBQWMzRSxLQUFLLENBQUM0RSxPQUFOLENBQWNDLEdBQWQsQ0FBa0J6QyxJQUFsQixJQUEwQnZELElBQUksQ0FBQ21ELEtBQUwsQ0FBV0ksSUFBWCxDQUExQixHQUE2Q0EsSUFBM0Q7O0FBRUEsY0FBSXNDLEtBQUssQ0FBQzdCLElBQU4sS0FBZVQsSUFBbkIsRUFBeUI7QUFDckJVLFlBQUFBLFFBQVEsQ0FBQzZCLElBQVQsQ0FBYyxHQUFkO0FBQ0E3QixZQUFBQSxRQUFRLENBQUM2QixJQUFULENBQWNELEtBQUssQ0FBQzdCLElBQXBCO0FBQ0g7O0FBRUQsZUFBS0UsY0FBTCxDQUFvQjJCLEtBQXBCLEVBQTJCNUIsUUFBM0I7O0FBRUFBLFVBQUFBLFFBQVEsQ0FBQzZCLElBQVQsQ0FBY2pGLFVBQVUsR0FBRyxHQUFiLEdBQW1CYixJQUFJLENBQUNtRCxLQUFMLENBQVcwQyxLQUFLLENBQUNWLE9BQU4sSUFBaUIsS0FBS2hCLHNCQUFMLENBQTRCYyxTQUE1QixFQUF1QzFCLElBQXZDLENBQTVCLENBQWpDO0FBRUEsZUFBS3hCLFVBQUwsQ0FBZ0IsR0FBR2tDLFFBQW5CO0FBQ0gsU0FoQkQ7O0FBa0JBLGFBQUszQixNQUFMO0FBQ0g7O0FBRUQsVUFBSSxDQUFDcEMsQ0FBQyxDQUFDNkQsT0FBRixDQUFVSixNQUFNLENBQUNzQyxZQUFqQixDQUFMLEVBQXFDO0FBQ2pDLGFBQUtsRSxVQUFMLEdBQWtCQSxVQUFsQixDQUE2QmYsZUFBN0IsRUFBOENxQixNQUE5QztBQUVBc0IsUUFBQUEsTUFBTSxDQUFDc0MsWUFBUCxDQUFvQmhELE9BQXBCLENBQTRCLENBQUM7QUFBRWUsVUFBQUEsSUFBRjtBQUFRa0MsVUFBQUEsUUFBUjtBQUFrQkMsVUFBQUEsVUFBbEI7QUFBOEJDLFVBQUFBO0FBQTlCLFNBQUQsS0FBaUQ7QUFDekUsY0FBSUYsUUFBSixFQUFjO0FBQ1YsaUJBQUtuRSxVQUFMLENBQWdCaUMsSUFBaEIsRUFBc0JoRSxJQUFJLENBQUNtRCxLQUFMLENBQVdnRCxVQUFYLEVBQXVCLEdBQXZCLENBQXRCLEVBQW1ELElBQW5ELEVBQXlEbkcsSUFBSSxDQUFDbUQsS0FBTCxDQUFXK0MsUUFBWCxFQUFxQixHQUFyQixDQUF6RDtBQUNILFdBRkQsTUFFTyxJQUFJRSxXQUFKLEVBQWlCO0FBQ3BCLGlCQUFLckUsVUFBTCxDQUFnQmlDLElBQWhCLEVBQXNCaEUsSUFBSSxDQUFDbUQsS0FBTCxDQUFXZ0QsVUFBWCxFQUF1QixHQUF2QixDQUF0QixFQUFtRCxhQUFuRCxFQUFrRW5HLElBQUksQ0FBQ21ELEtBQUwsQ0FBV2lELFdBQVgsRUFBd0IsR0FBeEIsQ0FBbEU7QUFDSCxXQUZNLE1BRUE7QUFDSCxpQkFBS3JFLFVBQUwsQ0FBZ0JpQyxJQUFoQixFQUFzQmhFLElBQUksQ0FBQ21ELEtBQUwsQ0FBV2dELFVBQVgsRUFBdUIsR0FBdkIsQ0FBdEI7QUFDSDtBQUNKLFNBUkQ7QUFVQSxhQUFLN0QsTUFBTDtBQUNIOztBQUVELFVBQUlxQixNQUFNLENBQUMwQyxHQUFQLElBQWMsQ0FBQ2pCLFNBQW5CLEVBQThCO0FBQzFCLFlBQUlpQixHQUFHLEdBQUl0RCxLQUFLLENBQUNDLE9BQU4sQ0FBY1csTUFBTSxDQUFDMEMsR0FBckIsS0FBNkIxQyxNQUFNLENBQUMwQyxHQUFQLENBQVduRSxNQUFYLEtBQXNCLENBQXBELEdBQXlEeUIsTUFBTSxDQUFDMEMsR0FBUCxDQUFXLENBQVgsQ0FBekQsR0FBeUUxQyxNQUFNLENBQUMwQyxHQUExRjs7QUFDQSxZQUFJdEQsS0FBSyxDQUFDQyxPQUFOLENBQWNxRCxHQUFkLENBQUosRUFBd0I7QUFDcEIsZUFBS3RFLFVBQUwsR0FBa0JBLFVBQWxCLENBQTZCZCxNQUE3QixFQUFxQyxPQUFPb0YsR0FBRyxDQUFDbEUsSUFBSixDQUFTLElBQVQsQ0FBUCxHQUF3QixJQUE3RDtBQUNILFNBRkQsTUFFTztBQUNILGVBQUtKLFVBQUwsR0FBa0JBLFVBQWxCLENBQTZCZCxNQUE3QixFQUFxQ29GLEdBQXJDO0FBQ0g7QUFDSjs7QUFFRCxVQUFJLENBQUNuRyxDQUFDLENBQUM2RCxPQUFGLENBQVVKLE1BQU0sQ0FBQzJDLE9BQWpCLENBQUwsRUFBZ0M7QUFDNUIsYUFBS3ZFLFVBQUwsR0FBa0JBLFVBQWxCLENBQTZCYixVQUE3QixFQUF5Q21CLE1BQXpDO0FBRUFzQixRQUFBQSxNQUFNLENBQUMyQyxPQUFQLENBQWVyRCxPQUFmLENBQXVCc0QsQ0FBQyxJQUFJO0FBQ3hCLGNBQUlDLFNBQVMsR0FBRyxFQUFoQjs7QUFFQSxjQUFJekQsS0FBSyxDQUFDQyxPQUFOLENBQWN1RCxDQUFDLENBQUNYLE1BQWhCLENBQUosRUFBNkI7QUFDekJZLFlBQUFBLFNBQVMsQ0FBQ1YsSUFBVixDQUFlLE1BQU1TLENBQUMsQ0FBQ1gsTUFBRixDQUFTekQsSUFBVCxDQUFjLElBQWQsQ0FBTixHQUE0QixHQUEzQztBQUNILFdBRkQsTUFFTztBQUNIcUUsWUFBQUEsU0FBUyxDQUFDVixJQUFWLENBQWVTLENBQUMsQ0FBQ1gsTUFBakI7QUFDSDs7QUFFRCxjQUFJVyxDQUFDLENBQUNFLE1BQU4sRUFBYztBQUNWRCxZQUFBQSxTQUFTLENBQUNWLElBQVYsQ0FBZSxJQUFmO0FBQ0FVLFlBQUFBLFNBQVMsQ0FBQ1YsSUFBVixDQUFlLFFBQWY7QUFDSDs7QUFFRCxlQUFLL0QsVUFBTCxDQUFnQixHQUFHeUUsU0FBbkI7QUFDSCxTQWZEO0FBaUJBLGFBQUtsRSxNQUFMO0FBQ0g7O0FBRUQsV0FBS0EsTUFBTDtBQUNILEtBMUdEOztBQU5zQjtBQW1IekI7O0FBRUQ0QixFQUFBQSxjQUFjLENBQUMyQixLQUFELEVBQVE1QixRQUFSLEVBQWtCO0FBQzVCLFFBQUl5QyxhQUFhLEdBQUd4RyxDQUFDLENBQUN5RyxJQUFGLENBQU9kLEtBQVAsRUFBYyxDQUFDLE1BQUQsRUFBUyxXQUFULEVBQXNCLE1BQXRCLENBQWQsQ0FBcEI7O0FBRUEzRixJQUFBQSxDQUFDLENBQUNzQyxNQUFGLENBQVNrRSxhQUFULEVBQXdCLENBQUNqRSxDQUFELEVBQUlDLENBQUosS0FBVTtBQUk5QixVQUFJQSxDQUFDLEtBQUssU0FBVixFQUFxQjs7QUFFckIsVUFBSSxPQUFPRCxDQUFQLEtBQWEsU0FBYixJQUEwQnJDLFNBQVMsQ0FBQ3FDLENBQUQsQ0FBdkMsRUFBNEM7QUFDeEMsWUFBSUEsQ0FBSixFQUFPO0FBQ0h3QixVQUFBQSxRQUFRLENBQUM2QixJQUFULENBQWNwRCxDQUFkO0FBQ0g7QUFDSixPQUpELE1BSU87QUFDSEQsUUFBQUEsQ0FBQyxHQUFHdkMsQ0FBQyxDQUFDMEcsU0FBRixDQUFZbkUsQ0FBWixDQUFKO0FBQ0F3QixRQUFBQSxRQUFRLENBQUM2QixJQUFULENBQWNwRCxDQUFDLEdBQUcsR0FBSixHQUFVLEtBQUttRSxjQUFMLENBQW9CcEUsQ0FBcEIsQ0FBVixHQUFtQyxHQUFqRDtBQUNIO0FBQ0osS0FkRDs7QUFnQkEsUUFBSW9ELEtBQUssQ0FBQ2lCLFNBQVYsRUFBcUI7QUFDakIsV0FBS0Msb0JBQUwsQ0FBMEI5QyxRQUExQixFQUFvQzRCLEtBQXBDO0FBQ0g7QUFDSjs7QUFFRGtCLEVBQUFBLG9CQUFvQixDQUFDOUMsUUFBRCxFQUFXK0MsS0FBWCxFQUFrQjtBQUNsQyxRQUFJQSxLQUFLLENBQUNGLFNBQVYsRUFBcUI7QUFDakJFLE1BQUFBLEtBQUssQ0FBQ0YsU0FBTixDQUFnQjdELE9BQWhCLENBQXdCUixDQUFDLElBQUk7QUFDekIsZ0JBQVFBLENBQUMsQ0FBQ3dFLE9BQVY7QUFDSSxlQUFLN0YsUUFBUSxDQUFDOEYsSUFBVCxDQUFjQyxTQUFuQjtBQUNBbEQsWUFBQUEsUUFBUSxDQUFDNkIsSUFBVCxDQUFjLE9BQU8sS0FBS3NCLGtCQUFMLENBQXdCM0UsQ0FBeEIsQ0FBckI7QUFDQTs7QUFFQSxlQUFLckIsUUFBUSxDQUFDOEYsSUFBVCxDQUFjRyxTQUFuQjtBQUNBcEQsWUFBQUEsUUFBUSxDQUFDNkIsSUFBVCxDQUFjLE9BQU8sS0FBS3NCLGtCQUFMLENBQXdCM0UsQ0FBeEIsQ0FBckI7QUFDQTs7QUFFQSxlQUFLckIsUUFBUSxDQUFDOEYsSUFBVCxDQUFjSSxTQUFuQjtBQUNBckQsWUFBQUEsUUFBUSxDQUFDNkIsSUFBVCxDQUFjLE9BQU8sS0FBS3NCLGtCQUFMLENBQXdCM0UsQ0FBeEIsQ0FBckI7QUFDQTs7QUFFQTtBQUNJLGtCQUFNLElBQUlHLEtBQUosQ0FBVywyQkFBMEJILENBQUMsQ0FBQ3dFLE9BQVEsSUFBL0MsQ0FBTjtBQWRSO0FBZ0JILE9BakJEO0FBa0JIO0FBQ0o7O0FBRURHLEVBQUFBLGtCQUFrQixDQUFDRyxDQUFELEVBQUk7QUFDbEIsUUFBSUMsQ0FBQyxHQUFHRCxDQUFDLENBQUNoRSxJQUFWOztBQUVBLFFBQUksQ0FBQ3JELENBQUMsQ0FBQzZELE9BQUYsQ0FBVXdELENBQUMsQ0FBQ2hDLElBQVosQ0FBTCxFQUF3QjtBQUNwQmlDLE1BQUFBLENBQUMsSUFBSSxHQUFMO0FBRUFBLE1BQUFBLENBQUMsSUFBSSxLQUFLWCxjQUFMLENBQW9CVSxDQUFDLENBQUNoQyxJQUF0QixDQUFMO0FBRUFpQyxNQUFBQSxDQUFDLElBQUksR0FBTDtBQUNIOztBQUVELFdBQU9BLENBQVA7QUFDSDs7QUFFRFgsRUFBQUEsY0FBYyxDQUFDdEIsSUFBRCxFQUFPO0FBQ2pCLFdBQU9BLElBQUksQ0FBQ0MsR0FBTCxDQUFTQyxDQUFDLElBQUksS0FBS2dDLGFBQUwsQ0FBbUJoQyxDQUFuQixDQUFkLEVBQXFDdEQsSUFBckMsQ0FBMEMsSUFBMUMsQ0FBUDtBQUNIOztBQUVEc0YsRUFBQUEsYUFBYSxDQUFDaEMsQ0FBRCxFQUFJO0FBQ2IsUUFBSXZGLENBQUMsQ0FBQzRELGFBQUYsQ0FBZ0IyQixDQUFoQixLQUFzQkEsQ0FBQyxDQUFDaUMsY0FBRixDQUFpQixTQUFqQixDQUExQixFQUF1RDtBQUNuRCxVQUFJakMsQ0FBQyxDQUFDd0IsT0FBRixLQUFjLFlBQWxCLEVBQWdDO0FBQzVCLFlBQUlVLFFBQVEsR0FBRyxDQUFFLEtBQUtGLGFBQUwsQ0FBbUJoQyxDQUFDLENBQUN1QixLQUFyQixDQUFGLENBQWY7O0FBRUEsWUFBSXZCLENBQUMsQ0FBQ3FCLFNBQU4sRUFBaUI7QUFDYixlQUFLQyxvQkFBTCxDQUEwQlksUUFBMUIsRUFBb0NsQyxDQUFwQztBQUNIOztBQUVELGVBQU9rQyxRQUFRLENBQUN4RixJQUFULENBQWMsR0FBZCxDQUFQO0FBQ0gsT0FSRCxNQVFPLElBQUlzRCxDQUFDLENBQUN3QixPQUFGLEtBQWMsaUJBQWxCLEVBQXFDO0FBQ3hDLGVBQU8sTUFBTXhCLENBQUMsQ0FBQ2xDLElBQWY7QUFDSCxPQUZNLE1BRUE7QUFDSCxjQUFNLElBQUlYLEtBQUosQ0FBVSw0QkFBNEI2QyxDQUFDLENBQUN3QixPQUF4QyxDQUFOO0FBQ0g7QUFDSjs7QUFFRCxRQUFJLE9BQU94QixDQUFQLEtBQWEsUUFBYixJQUF5QnBGLFlBQVksQ0FBQ29GLENBQUQsRUFBSSxHQUFKLENBQXpDLEVBQW1ELE9BQU9BLENBQVA7QUFFbkQsV0FBT0MsSUFBSSxDQUFDQyxTQUFMLENBQWVGLENBQWYsQ0FBUDtBQUNIOztBQXZWWTs7QUEwVmpCbUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCeEcsVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8gfSA9IFV0aWw7XG5jb25zdCB7IGdlbmVyYXRlRGlzcGxheU5hbWUgfSA9IHJlcXVpcmUoJy4vT29sVXRpbHMnKTtcbmNvbnN0IHsgaXNOb3RoaW5nLCBpc1F1b3RlZFdpdGggfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcblxuY29uc3QgS1dfTkFNRVNQQUNFID0gJ2ltcG9ydCc7XG5jb25zdCBLV19TQ0hFTUEgPSAnc2NoZW1hJztcbmNvbnN0IEtXX0VOVElUSUVTID0gJ2VudGl0aWVzJztcbmNvbnN0IEtXX0VOVElUWV9BU19BTElBUyA9ICdhcyc7XG5jb25zdCBLV19UWVBFX0RFRklORSA9ICd0eXBlJztcbmNvbnN0IEtXX0VOVElUWSA9ICdlbnRpdHknO1xuY29uc3QgS1dfQ09ERSA9ICdjb2RlJztcbmNvbnN0IEtXX0NPTU1FTlQgPSAnLS0nO1xuY29uc3QgS1dfV0lUSF9GRUFUVVJFID0gJ3dpdGgnO1xuY29uc3QgS1dfRklFTERTID0gJ2hhcyc7XG5jb25zdCBLV19BU1NPQ0lBVElPTlMgPSAnYXNzb2NpYXRpb25zJztcbmNvbnN0IEtXX0tFWSA9ICdrZXknO1xuY29uc3QgS1dfSU5ERVhFUyA9ICdpbmRleCc7XG5cbmNvbnN0IHsgVHlwZXMgfSA9IHJlcXVpcmUoJ0BnZW54L2RhdGEnKTtcbmNvbnN0IE9vbFR5cGVzID0gcmVxdWlyZSgnLi9Pb2xUeXBlcycpO1xuXG5jbGFzcyBPb2xDb2RlR2VuIHtcbiAgICBzdGF0aWMgdHJhbnNmb3JtKGpzb24sIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGNvZGVHZW4gPSBuZXcgT29sQ29kZUdlbihvcHRpb25zKTtcbiAgICAgICAgcmV0dXJuIGNvZGVHZW4uZ2VuZXJhdGUoanNvbik7XG4gICAgfVxuXG4gICAgaW5kZW50ZWQgPSAwO1xuICAgIGNvbnRlbnQgPSAnJztcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICB9XG5cbiAgICBnZW5lcmF0ZShqc29uKSB7XG4gICAgICAgIHRoaXMuZ2VuZXJhdGVPYmplY3QoanNvbik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudDtcbiAgICB9XG5cbiAgICBhcHBlbmRMaW5lKGxpbmUpIHtcbiAgICAgICAgaWYgKGxpbmUpIHtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGxpbmUgPSBbIC4uLmFyZ3VtZW50c10uam9pbignICcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQgKz0gKHRoaXMuaW5kZW50ZWQgPiAwID8gXy5yZXBlYXQoJyAnLCB0aGlzLmluZGVudGVkKSA6ICcnKSArIGxpbmUgKyAnXFxuJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudCArPSAnXFxuJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBpbmRlbnQoKSB7XG4gICAgICAgIHRoaXMuaW5kZW50ZWQgKz0gMjtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZGVkZW50KCkge1xuICAgICAgICB0aGlzLmluZGVudGVkIC09IDI7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID49IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVPYmplY3Qob2JqKSB7XG4gICAgICAgIF8uZm9yT3duKG9iaiwgKHYsaykgPT4ge1xuICAgICAgICAgICAgbGV0IGdlbmVyYXRlTWV0aG9kID0gJ2dlbmVyYXRlXycgKyBrO1xuXG4gICAgICAgICAgICBpZiAoZ2VuZXJhdGVNZXRob2QgaW4gdGhpcykge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2dlbmVyYXRlTWV0aG9kXSh2KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0byBiZSBpbXBsZW1lbnRlZCwgb2JqZWN0OiAnICsgayk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdlbmVyYXRlX25hbWVzcGFjZShuYW1lc3BhY2VzKSB7XG4gICAgICAgIHByZToge1xuICAgICAgICAgICAgQXJyYXkuaXNBcnJheShuYW1lc3BhY2VzKSwgJ0ludmFsaWQgbmFtZXNwYWNlcy4nO1xuICAgICAgICAgICAgdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5hbWVzcGFjZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX05BTUVTUEFDRSkuaW5kZW50KCk7XG5cbiAgICAgICAgICAgIG5hbWVzcGFjZXMuZm9yRWFjaChucyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKFV0aWwucXVvdGUobnMsIFwiJ1wiKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5kZWRlbnQoKS5hcHBlbmRMaW5lKCk7XG4gICAgICAgIH1cblxuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVfc2NoZW1hKHNjaGVtYSkge1xuICAgICAgICBwcmU6IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICAgICAgfVxuXG4gICAgICAgIF8uZm9yT3duKHNjaGVtYSwgKHNjaGVtYUluZm8sIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19TQ0hFTUEsIFV0aWwucXVvdGUobmFtZSwgXCInXCIpKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgaWYgKHNjaGVtYUluZm8uZW50aXRpZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfRU5USVRJRVMpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgc2NoZW1hSW5mby5lbnRpdGllcy5mb3JFYWNoKGVudGl0eUVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eUVudHJ5LmFsaWFzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoZW50aXR5RW50cnkuZW50aXR5LCBLV19FTlRJVFlfQVNfQUxJQVMsIGVudGl0eUVudHJ5LmFsaWFzKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShlbnRpdHlFbnRyeS5lbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmRlZGVudCgpLmFwcGVuZExpbmUoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVfdHlwZSh0eXBlcykge1xuICAgICAgICBwcmU6IHtcbiAgICAgICAgICAgIF8uaXNQbGFpbk9iamVjdCh0eXBlcyksICdJbnZhbGlkIHR5cGVzLic7XG4gICAgICAgICAgICB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0eXBlcykpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19UWVBFX0RFRklORSkuaW5kZW50KCk7XG5cbiAgICAgICAgICAgIF8uZm9yT3duKHR5cGVzLCAodHlwZSwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBsaW5lSW5mbyA9IFsgbmFtZSwgJzonLCB0eXBlLnR5cGUgXTtcblxuICAgICAgICAgICAgICAgIHRoaXMuX3RyYW5zbGF0ZVR5cGUodHlwZSwgbGluZUluZm8pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKC4uLmxpbmVJbmZvKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLmRlZGVudCgpLmFwcGVuZExpbmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBvc3Q6IHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICB9XG5cbiAgICBnZW5lcmF0ZV9maWVsZF9jb21tZW50KGVudGl0eU5hbWUsIGNvbE5hbWUpIHtcbiAgICAgICAgbGV0IGNvbE5hbWVGdWxsU25ha2UgPSBfLnRyaW1TdGFydChfLnNuYWtlQ2FzZShjb2xOYW1lKSwgJ18nKTtcbiAgICAgICAgbGV0ICBbIGNvbE5hbWVGaXJzdFdvcmQsIGNvbE5hbWVSZXN0IF0gPSBjb2xOYW1lRnVsbFNuYWtlLnNwbGl0KCdfJywgMik7XG5cbiAgICAgICAgbGV0IHJlc3VsdDtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZUZ1bGxTbmFrZSA9IF8udHJpbShfLnNuYWtlQ2FzZShlbnRpdHlOYW1lKSwgJ18nKTtcbiAgICAgICAgaWYgKF8uZW5kc1dpdGgoZW50aXR5TmFtZUZ1bGxTbmFrZSwgY29sTmFtZUZpcnN0V29yZCkpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGVudGl0eU5hbWVGdWxsU25ha2UgKyAnXycgKyBjb2xOYW1lUmVzdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGVudGl0eU5hbWVGdWxsU25ha2UgKyAnXycgKyBjb2xOYW1lRnVsbFNuYWtlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGdlbmVyYXRlRGlzcGxheU5hbWUocmVzdWx0KTtcbiAgICB9XG5cbiAgICBnZW5lcmF0ZV9lbnRpdHkoZW50aXRpZXMpIHtcbiAgICAgICAgcHJlOiB7XG4gICAgICAgICAgICBfLmlzUGxhaW5PYmplY3QoZW50aXRpZXMpLCAnSW52YWxpZCBlbnRpdGllcy4nO1xuICAgICAgICAgICAgdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgICAgICB9XG5cbiAgICAgICAgXy5mb3JPd24oZW50aXRpZXMsIChlbnRpdHksIGVuaXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX0VOVElUWSwgZW5pdHlOYW1lKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgaWYgKGVudGl0eS5zb3VyY2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfQ09ERSwgVXRpbC5xdW90ZShlbnRpdHkuc291cmNlKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19DT01NRU5ULCBVdGlsLnF1b3RlKGVudGl0eS5jb21tZW50IHx8IGdlbmVyYXRlRGlzcGxheU5hbWUoZW5pdHlOYW1lKSkpO1xuXG4gICAgICAgICAgICBsZXQgaGFzQXV0b0lkID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5mZWF0dXJlcykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfV0lUSF9GRUFUVVJFKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgICAgIGVudGl0eS5mZWF0dXJlcy5mb3JFYWNoKGZlYXR1cmUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZlYXR1cmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlID0geyBuYW1lOiBmZWF0dXJlIH07XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoZmVhdHVyZS5uYW1lID09PSAnYXV0b0lkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFzQXV0b0lkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmZWF0dXJlLmFyZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShmZWF0dXJlLm5hbWUgKyAnKCcgKyBmZWF0dXJlLmFyZ3MubWFwKGEgPT4gSlNPTi5zdHJpbmdpZnkoYSkpLmpvaW4oJywgJykgKyAnKScpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKGZlYXR1cmUubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5maWVsZHMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19GSUVMRFMpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgXy5mb3JPd24oZW50aXR5LmZpZWxkcywgKGZpZWxkLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogZmllbGQudHlwZTsgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBsaW5lSW5mbyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKFR5cGVzLkJ1aWx0aW4uaGFzKG5hbWUpID8gVXRpbC5xdW90ZShuYW1lKSA6IG5hbWUpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQudHlwZSAhPT0gbmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaCgnOicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaChmaWVsZC50eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RyYW5zbGF0ZVR5cGUoZmllbGQsIGxpbmVJbmZvKTtcblxuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKEtXX0NPTU1FTlQgKyAnICcgKyBVdGlsLnF1b3RlKGZpZWxkLmNvbW1lbnQgfHwgdGhpcy5nZW5lcmF0ZV9maWVsZF9jb21tZW50KGVuaXR5TmFtZSwgbmFtZSkpKTtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoLi4ubGluZUluZm8pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmFzc29jaWF0aW9ucykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoKS5hcHBlbmRMaW5lKEtXX0FTU09DSUFUSU9OUykuaW5kZW50KCk7XG5cbiAgICAgICAgICAgICAgICBlbnRpdHkuYXNzb2NpYXRpb25zLmZvckVhY2goKHsgdHlwZSwgc3JjRmllbGQsIGRlc3RFbnRpdHksIGNvbm5lY3RlZEJ5IH0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNyY0ZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUodHlwZSwgVXRpbC5xdW90ZShkZXN0RW50aXR5LCBcIidcIiksICdhcycsIFV0aWwucXVvdGUoc3JjRmllbGQsIFwiJ1wiKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29ubmVjdGVkQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSh0eXBlLCBVdGlsLnF1b3RlKGRlc3RFbnRpdHksIFwiJ1wiKSwgJ2Nvbm5lY3RlZEJ5JywgVXRpbC5xdW90ZShjb25uZWN0ZWRCeSwgXCInXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSh0eXBlLCBVdGlsLnF1b3RlKGRlc3RFbnRpdHksIFwiJ1wiKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGVudGl0eS5rZXkgJiYgIWhhc0F1dG9JZCkge1xuICAgICAgICAgICAgICAgIGxldCBrZXkgPSAoQXJyYXkuaXNBcnJheShlbnRpdHkua2V5KSAmJiBlbnRpdHkua2V5Lmxlbmd0aCA9PT0gMSkgPyBlbnRpdHkua2V5WzBdIDogZW50aXR5LmtleTtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSgpLmFwcGVuZExpbmUoS1dfS0VZLCAnWyAnICsga2V5LmpvaW4oJywgJykgKyAnIF0nKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoKS5hcHBlbmRMaW5lKEtXX0tFWSwga2V5KTtcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShlbnRpdHkuaW5kZXhlcykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoKS5hcHBlbmRMaW5lKEtXX0lOREVYRVMpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgZW50aXR5LmluZGV4ZXMuZm9yRWFjaChpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGluZGV4SW5mbyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGkuZmllbGRzKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhJbmZvLnB1c2goJ1snICsgaS5maWVsZHMuam9pbignLCAnKSArICddJyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleEluZm8ucHVzaChpLmZpZWxkcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoaS51bmlxdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4SW5mby5wdXNoKCdpcycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhJbmZvLnB1c2goJ3VuaXF1ZScpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKC4uLmluZGV4SW5mbyk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmRlZGVudCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmRlZGVudCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZVR5cGUoZmllbGQsIGxpbmVJbmZvKSB7XG4gICAgICAgIGxldCBleHRyYVR5cGVJbmZvID0gXy5vbWl0KGZpZWxkLCBbJ3R5cGUnLCAnbW9kaWZpZXJzJywgJ25hbWUnXSk7XG4gICAgICAgIC8vbGV0IHR5cGVNZXRhID0gVHlwZXNbZmllbGQudHlwZV07XG4gICAgICAgIF8uZm9yT3duKGV4dHJhVHlwZUluZm8sICh2LCBrKSA9PiB7XG4gICAgICAgICAgICAvL2lmICghdHlwZU1ldGEucXVhbGlmaWVycy5pbmNsdWRlcyhrKSkge1xuICAgICAgICAgICAgLy8gICAgdGhyb3cgbmV3IEVycm9yKGBcIiR7a31cIiBpcyBub3QgYSB2YWxpZCBxdWFsaWZpZXIgZm9yIHR5cGUgXCIke2ZpZWxkLnR5cGV9XCIuYCk7XG4gICAgICAgICAgICAvL31cbiAgICAgICAgICAgIGlmIChrID09PSAnY29tbWVudCcpIHJldHVybjtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAnYm9vbGVhbicgfHwgaXNOb3RoaW5nKHYpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHYpIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaChrKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHYgPSBfLmNhc3RBcnJheSh2KTtcbiAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKGsgKyAnKCcgKyB0aGlzLl90cmFuc2xhdGVBcmdzKHYpICsgJyknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGZpZWxkLm1vZGlmaWVycykge1xuICAgICAgICAgICAgdGhpcy5fdHJhbnNsYXRlUGlwZWRWYWx1ZShsaW5lSW5mbywgZmllbGQpO1xuICAgICAgICB9ICAgICAgICBcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlUGlwZWRWYWx1ZShsaW5lSW5mbywgdmFsdWUpIHsgICAgICAgIFxuICAgICAgICBpZiAodmFsdWUubW9kaWZpZXJzKSB7XG4gICAgICAgICAgICB2YWx1ZS5tb2RpZmllcnMuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHYub29sVHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIE9vbFR5cGVzLkxhbmcuVkFMSURBVE9SOlxuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKCd8ficgKyB0aGlzLl90cmFuc2xhdGVNb2RpZmllcih2KSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgT29sVHlwZXMuTGFuZy5QUk9DRVNTT1I6XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goJ3w+JyArIHRoaXMuX3RyYW5zbGF0ZU1vZGlmaWVyKHYpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FzZSBPb2xUeXBlcy5MYW5nLkFDVElWQVRPUjpcbiAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaCgnfD0nICsgdGhpcy5fdHJhbnNsYXRlTW9kaWZpZXIodikpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIG1vZGlmaWVyIHR5cGU6IFwiJHt2Lm9vbFR5cGV9XCIhYCk7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlTW9kaWZpZXIoZikge1xuICAgICAgICBsZXQgciA9IGYubmFtZTtcblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShmLmFyZ3MpKSB7XG4gICAgICAgICAgICByICs9ICcoJztcblxuICAgICAgICAgICAgciArPSB0aGlzLl90cmFuc2xhdGVBcmdzKGYuYXJncyk7XG5cbiAgICAgICAgICAgIHIgKz0gJyknO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHI7XG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZUFyZ3MoYXJncykge1xuICAgICAgICByZXR1cm4gYXJncy5tYXAoYSA9PiB0aGlzLl90cmFuc2xhdGVBcmcoYSkpLmpvaW4oJywgJyk7XG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZUFyZyhhKSB7XG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QoYSkgJiYgYS5oYXNPd25Qcm9wZXJ0eSgnb29sVHlwZScpKSB7XG4gICAgICAgICAgICBpZiAoYS5vb2xUeXBlID09PSAnUGlwZWRWYWx1ZScpIHtcbiAgICAgICAgICAgICAgICBsZXQgcGlwZWxpbmUgPSBbIHRoaXMuX3RyYW5zbGF0ZUFyZyhhLnZhbHVlKSBdO1xuXG4gICAgICAgICAgICAgICAgaWYgKGEubW9kaWZpZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RyYW5zbGF0ZVBpcGVkVmFsdWUocGlwZWxpbmUsIGEpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBwaXBlbGluZS5qb2luKCcgJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGEub29sVHlwZSA9PT0gJ09iamVjdFJlZmVyZW5jZScpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ0AnICsgYS5uYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBzdXBwb3J0ZWQgb29sVHlwZTogJyArIGEub29sVHlwZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gXG5cbiAgICAgICAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJyAmJiBpc1F1b3RlZFdpdGgoYSwgJy8nKSkgcmV0dXJuIGE7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE9vbENvZGVHZW47Il19
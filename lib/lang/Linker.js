"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob
} = require('rk-utils');

const {
  Types
} = require('@genx/data');

const Oolong = require('./grammar/geml');

const OolongParser = Oolong.parser;

const GemlTypes = require('./GemlTypes');

const Entity = require('./Entity');

const Schema = require('./Schema');

const View = require('./View');

const Dataset = require('./Dataset');

const deepFreeze = require('deep-freeze');

const ELEMENT_CLASS_MAP = {
  [GemlTypes.Element.ENTITY]: Entity,
  [GemlTypes.Element.VIEW]: View,
  [GemlTypes.Element.DATASET]: Dataset
};
const GEML_SOURCE_EXT = '.geml';
const BUILTINS_PATH = path.resolve(__dirname, 'builtins');

class Linker {
  static getGemlFiles(sourceDir, useJsonSource, recursive) {
    let pattern = '*' + GEML_SOURCE_EXT;

    if (useJsonSource) {
      pattern += '.json';
    }

    if (recursive) {
      pattern = '**/' + pattern;
    }

    return glob.sync(path.join(sourceDir, pattern), {
      nodir: true
    });
  }

  constructor(app, context) {
    this.app = app;
    this.sourcePath = context.gemlPath;
    this.useJsonSource = context.useJsonSource;
    this.saveIntermediate = context.saveIntermediate;
    this.schemaDeployment = context.schemas;
    this.schemas = {};
    this._gemlModules = {};
    this._elementsCache = {};
    this._mapOfReferenceToModuleId = new Map();
  }

  log(...args) {
    this.app.log(...args);
  }

  isModuleLoaded(moduleId) {
    return moduleId in this._gemlModules;
  }

  getModuleById(moduleId) {
    return this._gemlModules[moduleId];
  }

  link(entryFileName) {
    let entryModule = this.loadModule(entryFileName);

    if (!entryModule) {
      throw new Error(`Cannot resolve file "${entryFileName}".`);
    }

    if (_.isEmpty(entryModule.schema)) {
      throw new Error('No schema defined in entry file.');
    }

    _.forOwn(entryModule.schema, (schemaInfo, schemaName) => {
      let deploymentSettings = this.schemaDeployment[schemaName];
      let schema = new Schema(this, schemaName, entryModule, schemaInfo, deploymentSettings);
      schema.link();

      if (this.schemas.hasOwnProperty(schemaName)) {
        throw new Error(`Duplicate schema: "${schemaName}".`);
      }

      this.schemas[schemaName] = schema;

      if (this.saveIntermediate) {
        let jsFile = path.resolve(this.sourcePath, entryFileName + '-linked.json');
        fs.writeFileSync(jsFile, JSON.stringify(schema.toJSON(), null, 4));
      }
    });
  }

  loadModule(modulePath) {
    modulePath = path.resolve(this.sourcePath, modulePath);
    let id = this.getModuleIdByPath(modulePath);

    if (this.isModuleLoaded(id)) {
      return this.getModuleById(id);
    }

    if (!fs.existsSync(modulePath)) {
      return undefined;
    }

    let gemlModule = this._compile(modulePath);

    return this._gemlModules[id] = gemlModule;
  }

  trackBackType(gemlModule, info) {
    if (Types.Builtin.has(info.type)) {
      return info;
    }

    let baseInfo = this.loadElement(gemlModule, GemlTypes.Element.TYPE, info.type, true);

    if (!Types.Builtin.has(baseInfo.type)) {
      let ownerModule = baseInfo.gemlModule;
      let rootTypeInfo = this.trackBackType(ownerModule, baseInfo);
      ownerModule.type[baseInfo.type] = rootTypeInfo;
      baseInfo = rootTypeInfo;
    }

    let derivedInfo = { ..._.cloneDeep(_.omit(baseInfo, ['gemlModule', 'modifiers'])),
      ..._.omit(info, ['gemlModule', 'type', 'modifiers'])
    };

    if (baseInfo.modifiers || info.modifiers) {
      derivedInfo.modifiers = [...(baseInfo.modifiers || []), ...(info.modifiers || [])];
    }

    if (!derivedInfo.subClass) {
      derivedInfo.subClass = [];
    }

    derivedInfo.subClass.push(info.type);
    return derivedInfo;
  }

  translateOolValue(gemlModule, value) {
    if (_.isPlainObject(value)) {
      if (value.oolType === GemlTypes.Lang.CONST_REF) {
        let refedValue = this.loadElement(gemlModule, GemlTypes.Element.CONST, value.name, true);
        let uniqueId = this.getElementUniqueId(gemlModule, GemlTypes.Element.CONST, value.name);
        let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
        return this.translateOolValue(ownerModule, refedValue);
      } else if (value.oolType) {
        throw new Error(`todo: translateOolValue with type: ${value.oolType}`);
      }

      return _.mapValues(value, v => this.translateOolValue(gemlModule, v));
    }

    if (Array.isArray(value)) {
      return value.map(v => this.translateOolValue(gemlModule, v));
    }

    return value;
  }

  getModuleIdByPath(modulePath) {
    let isBuiltinEntity = _.startsWith(modulePath, BUILTINS_PATH);

    return isBuiltinEntity ? path.relative(BUILTINS_PATH, modulePath) : './' + path.relative(this.sourcePath, modulePath);
  }

  getElementUniqueId(refererModule, elementType, elementName) {
    return elementType + ':' + elementName + '<-' + refererModule.id;
  }

  loadEntity(refererModule, elementName, throwOnMissing = true) {
    let entity = this.loadElement(refererModule, GemlTypes.Element.ENTITY, elementName, throwOnMissing);

    if (entity && _.isEmpty(entity.fields) && _.isEmpty(entity.info.associations)) {
      throw new Error(`Entity "${elementName}" has no any fields defined.`);
    }

    return entity;
  }

  loadType(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.TYPE, elementName, throwOnMissing);
  }

  loadDataset(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.DATASET, elementName, throwOnMissing);
  }

  loadView(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.VIEW, elementName, throwOnMissing);
  }

  loadElement(refererModule, elementType, elementName, throwOnMissing) {
    let uniqueId = this.getElementUniqueId(refererModule, elementType, elementName);

    if (uniqueId in this._elementsCache) {
      return this._elementsCache[uniqueId];
    }

    let targetModule;

    if (elementType in refererModule && elementName in refererModule[elementType]) {
      targetModule = refererModule;
    } else {
      let index = _.findLastIndex(refererModule.namespace, modulePath => {
        targetModule = this.loadModule(modulePath);
        return targetModule && targetModule[elementType] && elementName in targetModule[elementType];
      });

      if (index === -1) {
        if (throwOnMissing) {
          throw new Error(`${elementType} "${elementName}" not found in imported namespaces. Referer: ${refererModule.id}`);
        }

        return undefined;
      }
    }

    let elementSelfId = elementType + ':' + elementName + '@' + targetModule.id;

    if (elementSelfId in this._elementsCache) {
      return this._elementsCache[uniqueId] = this._elementsCache[elementSelfId];
    }

    this._mapOfReferenceToModuleId.set(uniqueId, targetModule.id);

    let elementInfo = targetModule[elementType][elementName];
    let element;

    if (elementType in ELEMENT_CLASS_MAP) {
      let ElementClass = ELEMENT_CLASS_MAP[elementType];
      element = new ElementClass(this, elementName, targetModule, elementInfo);
      element.link();
    } else {
      if (elementType === GemlTypes.Element.TYPE) {
        element = { ...elementInfo,
          gemlModule: targetModule
        };
      } else {
        element = elementInfo;
      }
    }

    this._elementsCache[elementSelfId] = element;
    this._elementsCache[uniqueId] = element;
    return element;
  }

  _compile(oolFile) {
    let jsFile;

    if (oolFile.endsWith('.json')) {
      jsFile = oolFile;
      oolFile = oolFile.substr(0, oolFile.length - 5);
    } else {
      jsFile = oolFile + '.json';
    }

    let ool, searchExt;

    if (this.useJsonSource) {
      if (!fs.existsSync(jsFile)) {
        throw new Error(`"useJsonSource" enabeld but json file "${jsFile}" not found.`);
      }

      ool = fs.readJsonSync(jsFile);
      searchExt = GEML_SOURCE_EXT + '.json';
    } else {
      try {
        ool = OolongParser.parse(fs.readFileSync(oolFile, 'utf8'));
      } catch (error) {
        throw new Error(`Failed to compile "${oolFile}".\n${error.message || error}`);
      }

      if (!ool) {
        throw new Error('Unknown error occurred while compiling.');
      }

      searchExt = GEML_SOURCE_EXT;
    }

    let baseName = path.basename(oolFile, GEML_SOURCE_EXT);
    let namespace = [];
    let currentPath = path.dirname(oolFile);

    function expandNs(namespaces, ns, recursive) {
      let stats = fs.statSync(ns);

      if (stats.isFile() && ns.endsWith(searchExt)) {
        namespaces.push(ns);
        return;
      }

      if (stats.isDirectory() && recursive) {
        let files = fs.readdirSync(ns);
        files.forEach(f => expandNs(namespaces, path.join(ns, f), true));
      }
    }

    if (ool.namespace) {
      ool.namespace.forEach(ns => {
        let p;

        if (ns.startsWith('<builtins>/')) {
          ns = path.join(BUILTINS_PATH, ns.substr(11));
        } else if (ns.startsWith('<source>/')) {
          ns = path.join(this.sourcePath, ns.substr(9));
        }

        if (ns.endsWith('/*')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 2));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), false));
        } else if (ns.endsWith('/**')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 3));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), true));
        } else {
          namespace.push(path.resolve(currentPath, _.endsWith(ns, GEML_SOURCE_EXT) ? ns : ns + GEML_SOURCE_EXT));
        }
      });
    }

    ool.namespace = namespace;
    ool.id = this.getModuleIdByPath(oolFile);
    ool.name = baseName;

    if (!this.useJsonSource && this.saveIntermediate) {
      fs.writeFileSync(jsFile, JSON.stringify(ool, null, 4));
    }

    return ool;
  }

}

module.exports = Linker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0xpbmtlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJUeXBlcyIsIk9vbG9uZyIsIk9vbG9uZ1BhcnNlciIsInBhcnNlciIsIkdlbWxUeXBlcyIsIkVudGl0eSIsIlNjaGVtYSIsIlZpZXciLCJEYXRhc2V0IiwiZGVlcEZyZWV6ZSIsIkVMRU1FTlRfQ0xBU1NfTUFQIiwiRWxlbWVudCIsIkVOVElUWSIsIlZJRVciLCJEQVRBU0VUIiwiR0VNTF9TT1VSQ0VfRVhUIiwiQlVJTFRJTlNfUEFUSCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJMaW5rZXIiLCJnZXRHZW1sRmlsZXMiLCJzb3VyY2VEaXIiLCJ1c2VKc29uU291cmNlIiwicmVjdXJzaXZlIiwicGF0dGVybiIsInN5bmMiLCJqb2luIiwibm9kaXIiLCJjb25zdHJ1Y3RvciIsImFwcCIsImNvbnRleHQiLCJzb3VyY2VQYXRoIiwiZ2VtbFBhdGgiLCJzYXZlSW50ZXJtZWRpYXRlIiwic2NoZW1hRGVwbG95bWVudCIsInNjaGVtYXMiLCJfZ2VtbE1vZHVsZXMiLCJfZWxlbWVudHNDYWNoZSIsIl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQiLCJNYXAiLCJsb2ciLCJhcmdzIiwiaXNNb2R1bGVMb2FkZWQiLCJtb2R1bGVJZCIsImdldE1vZHVsZUJ5SWQiLCJsaW5rIiwiZW50cnlGaWxlTmFtZSIsImVudHJ5TW9kdWxlIiwibG9hZE1vZHVsZSIsIkVycm9yIiwiaXNFbXB0eSIsInNjaGVtYSIsImZvck93biIsInNjaGVtYUluZm8iLCJzY2hlbWFOYW1lIiwiZGVwbG95bWVudFNldHRpbmdzIiwiaGFzT3duUHJvcGVydHkiLCJqc0ZpbGUiLCJ3cml0ZUZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsInRvSlNPTiIsIm1vZHVsZVBhdGgiLCJpZCIsImdldE1vZHVsZUlkQnlQYXRoIiwiZXhpc3RzU3luYyIsInVuZGVmaW5lZCIsImdlbWxNb2R1bGUiLCJfY29tcGlsZSIsInRyYWNrQmFja1R5cGUiLCJpbmZvIiwiQnVpbHRpbiIsImhhcyIsInR5cGUiLCJiYXNlSW5mbyIsImxvYWRFbGVtZW50IiwiVFlQRSIsIm93bmVyTW9kdWxlIiwicm9vdFR5cGVJbmZvIiwiZGVyaXZlZEluZm8iLCJjbG9uZURlZXAiLCJvbWl0IiwibW9kaWZpZXJzIiwic3ViQ2xhc3MiLCJwdXNoIiwidHJhbnNsYXRlT29sVmFsdWUiLCJ2YWx1ZSIsImlzUGxhaW5PYmplY3QiLCJvb2xUeXBlIiwiTGFuZyIsIkNPTlNUX1JFRiIsInJlZmVkVmFsdWUiLCJDT05TVCIsIm5hbWUiLCJ1bmlxdWVJZCIsImdldEVsZW1lbnRVbmlxdWVJZCIsImdldCIsIm1hcFZhbHVlcyIsInYiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJpc0J1aWx0aW5FbnRpdHkiLCJzdGFydHNXaXRoIiwicmVsYXRpdmUiLCJyZWZlcmVyTW9kdWxlIiwiZWxlbWVudFR5cGUiLCJlbGVtZW50TmFtZSIsImxvYWRFbnRpdHkiLCJ0aHJvd09uTWlzc2luZyIsImVudGl0eSIsImZpZWxkcyIsImFzc29jaWF0aW9ucyIsImxvYWRUeXBlIiwibG9hZERhdGFzZXQiLCJsb2FkVmlldyIsInRhcmdldE1vZHVsZSIsImluZGV4IiwiZmluZExhc3RJbmRleCIsIm5hbWVzcGFjZSIsImVsZW1lbnRTZWxmSWQiLCJzZXQiLCJlbGVtZW50SW5mbyIsImVsZW1lbnQiLCJFbGVtZW50Q2xhc3MiLCJvb2xGaWxlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJvb2wiLCJzZWFyY2hFeHQiLCJyZWFkSnNvblN5bmMiLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsImVycm9yIiwibWVzc2FnZSIsImJhc2VOYW1lIiwiYmFzZW5hbWUiLCJjdXJyZW50UGF0aCIsImRpcm5hbWUiLCJleHBhbmROcyIsIm5hbWVzcGFjZXMiLCJucyIsInN0YXRzIiwic3RhdFN5bmMiLCJpc0ZpbGUiLCJpc0RpcmVjdG9yeSIsImZpbGVz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QUEvYlE7O0FBa2NidUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEksTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IFR5cGVzIH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJyk7XG5cbmNvbnN0IE9vbG9uZyA9IHJlcXVpcmUoJy4vZ3JhbW1hci9nZW1sJyk7XG5jb25zdCBPb2xvbmdQYXJzZXIgPSBPb2xvbmcucGFyc2VyO1xuY29uc3QgR2VtbFR5cGVzID0gcmVxdWlyZSgnLi9HZW1sVHlwZXMnKTtcbmNvbnN0IEVudGl0eSA9IHJlcXVpcmUoJy4vRW50aXR5Jyk7XG5jb25zdCBTY2hlbWEgPSByZXF1aXJlKCcuL1NjaGVtYScpO1xuY29uc3QgVmlldyA9IHJlcXVpcmUoJy4vVmlldycpO1xuY29uc3QgRGF0YXNldCA9IHJlcXVpcmUoJy4vRGF0YXNldCcpO1xuY29uc3QgZGVlcEZyZWV6ZSA9IHJlcXVpcmUoJ2RlZXAtZnJlZXplJyk7XG5cbmNvbnN0IEVMRU1FTlRfQ0xBU1NfTUFQID0ge1xuICAgIFtHZW1sVHlwZXMuRWxlbWVudC5FTlRJVFldOiBFbnRpdHksXG4gICAgW0dlbWxUeXBlcy5FbGVtZW50LlZJRVddOiBWaWV3LFxuICAgIFtHZW1sVHlwZXMuRWxlbWVudC5EQVRBU0VUXTogRGF0YXNldCxcbn07XG5cbmNvbnN0IEdFTUxfU09VUkNFX0VYVCA9ICcuZ2VtbCc7XG5jb25zdCBCVUlMVElOU19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2J1aWx0aW5zJyk7XG5cbi8qKlxuICogTGlua2VyIG9mIGdlbWxcbiAqIEBjbGFzcyBHZW1sTGlua2VyXG4gKi9cbmNsYXNzIExpbmtlciB7XG4gICAgc3RhdGljIGdldEdlbWxGaWxlcyhzb3VyY2VEaXIsIHVzZUpzb25Tb3VyY2UsIHJlY3Vyc2l2ZSkge1xuICAgICAgICBsZXQgcGF0dGVybiA9ICcqJyArIEdFTUxfU09VUkNFX0VYVDtcblxuICAgICAgICBpZiAodXNlSnNvblNvdXJjZSkge1xuICAgICAgICAgICAgcGF0dGVybiArPSAnLmpzb24nO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgcGF0dGVybiA9ICcqKi8nICsgcGF0dGVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBnbG9iLnN5bmMocGF0aC5qb2luKHNvdXJjZURpciwgcGF0dGVybiksIHtub2RpcjogdHJ1ZX0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7U2VydmljZUNvbnRhaW5lcn0gYXBwIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuZ2VtbFBhdGggLSBHZW1sIHNvdXJjZSBmaWxlcyBwYXRoICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb250ZXh0LnVzZUpzb25Tb3VyY2U9ZmFsc2VdIC0gVXNlIC5qc29uIGludGVybWVkaWF0ZSBzb3VyY2UgZmlsZSBpbnN0ZWFkIG9mIC5vb2xcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb250ZXh0LnNhdmVJbnRlcm1lZGlhdGU9ZmFsc2VdIC0gU2F2ZSBpbnRlcm1lZGlhdGUgc291cmNlIGZpbGUgd2hpbGUgbGlua2luZ1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGFwcCwgY29udGV4dCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogQXBwXG4gICAgICAgICAqIEBtZW1iZXIge1NlcnZpY2VDb250YWluZXJ9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogR2VtbCBzb3VyY2UgZmlsZXMgcGF0aFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNvdXJjZVBhdGggPSBjb250ZXh0LmdlbWxQYXRoO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBVc2UganNvbiBvciBvbHNcbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMudXNlSnNvblNvdXJjZSA9IGNvbnRleHQudXNlSnNvblNvdXJjZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogU2F2ZSBpbnRlcm1lZGlhdGUgZmlsZXNcbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2F2ZUludGVybWVkaWF0ZSA9IGNvbnRleHQuc2F2ZUludGVybWVkaWF0ZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogU2NoZW1hIGRlcGxveW1lbnQgc2V0dGluZ3NcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zY2hlbWFEZXBsb3ltZW50ID0gY29udGV4dC5zY2hlbWFzO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMaW5rZWQgc2NoZW1hc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgU2NoZW1hPn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2NoZW1hcyA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBQYXJzZWQgb29sb25nIGZpbGVzLCBwYXRoID0+IG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9nZW1sTW9kdWxlcyA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFbGVtZW50IGNhY2hlLCBtYXAgb2YgPHJlZmVyZW5jZUlkLCBlbGVtZW50PiBhbmQgPHNlbGZJZCwgZWxlbWVudD5cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSBcbiAgICAgICAgICogQHByaXZhdGVcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2VsZW1lbnRzQ2FjaGUgPSB7fTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTWFwIG9mIDxyZWZlcmVuY2VJZCwgbW9kdWxlSWQ+XG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICogQHByaXZhdGVcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZCA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXcml0ZSBsb2dcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGV2ZWxcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbZGF0YV1cbiAgICAgKi9cbiAgICBsb2coLi4uYXJncykge1xuICAgICAgICB0aGlzLmFwcC5sb2coLi4uYXJncyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIG1vZHVsZSBpcyBsb2FkZWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlSWRcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBpc01vZHVsZUxvYWRlZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gKG1vZHVsZUlkIGluIHRoaXMuX2dlbWxNb2R1bGVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBsb2FkZWQgb29sb25lIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVJZFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0TW9kdWxlQnlJZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2VtbE1vZHVsZXNbbW9kdWxlSWRdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgb29sb25nIGZpbGVzXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVudHJ5RmlsZU5hbWVcbiAgICAgKi9cbiAgICBsaW5rKGVudHJ5RmlsZU5hbWUpIHtcbiAgICAgICAgLy9jb21waWxlIGVudHJ5IGZpbGUgICAgICAgIFxuICAgICAgICBsZXQgZW50cnlNb2R1bGUgPSB0aGlzLmxvYWRNb2R1bGUoZW50cnlGaWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFlbnRyeU1vZHVsZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcmVzb2x2ZSBmaWxlIFwiJHtlbnRyeUZpbGVOYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKF8uaXNFbXB0eShlbnRyeU1vZHVsZS5zY2hlbWEpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNjaGVtYSBkZWZpbmVkIGluIGVudHJ5IGZpbGUuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBfLmZvck93bihlbnRyeU1vZHVsZS5zY2hlbWEsIChzY2hlbWFJbmZvLCBzY2hlbWFOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgZGVwbG95bWVudFNldHRpbmdzID0gdGhpcy5zY2hlbWFEZXBsb3ltZW50W3NjaGVtYU5hbWVdO1xuICAgICAgICAgICAgLy9hc3NlcnQ6IGRlcGxveW1lbnRTZXR0aW5ncywgYFwiZGVwbG95bWVudFNldHRpbmdzXCIgb2Ygc2NoZW1hIFske3NjaGVtYU5hbWV9XSBub3QgZm91bmQuYDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHNjaGVtYSA9IG5ldyBTY2hlbWEodGhpcywgc2NoZW1hTmFtZSwgZW50cnlNb2R1bGUsIHNjaGVtYUluZm8sIGRlcGxveW1lbnRTZXR0aW5ncyk7XG4gICAgICAgICAgICBzY2hlbWEubGluaygpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zY2hlbWFzLmhhc093blByb3BlcnR5KHNjaGVtYU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgc2NoZW1hOiBcIiR7c2NoZW1hTmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2NoZW1hc1tzY2hlbWFOYW1lXSA9IHNjaGVtYTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuc2F2ZUludGVybWVkaWF0ZSkge1xuICAgICAgICAgICAgICAgIGxldCBqc0ZpbGUgPSBwYXRoLnJlc29sdmUodGhpcy5zb3VyY2VQYXRoLCBlbnRyeUZpbGVOYW1lICsgJy1saW5rZWQuanNvbicpO1xuICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoanNGaWxlLCBKU09OLnN0cmluZ2lmeShzY2hlbWEudG9KU09OKCksIG51bGwsIDQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGEgb29sb25nIG1vZHVsZSwgcmV0dXJuIHVuZGVmaW5lZCBpZiBub3QgZXhpc3RcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlUGF0aFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIGxvYWRNb2R1bGUobW9kdWxlUGF0aCkgeyAgICAgICAgXG4gICAgICAgIG1vZHVsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5zb3VyY2VQYXRoLCBtb2R1bGVQYXRoKTtcblxuICAgICAgICBsZXQgaWQgPSB0aGlzLmdldE1vZHVsZUlkQnlQYXRoKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzTW9kdWxlTG9hZGVkKGlkKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kdWxlQnlJZChpZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMobW9kdWxlUGF0aCkpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgbGV0IGdlbWxNb2R1bGUgPSB0aGlzLl9jb21waWxlKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIHJldHVybiAodGhpcy5fZ2VtbE1vZHVsZXNbaWRdID0gZ2VtbE1vZHVsZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhY2sgYmFjayB0aGUgdHlwZSBkZXJpdmVkIGNoYWluLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBnZW1sTW9kdWxlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGluZm9cbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHRyYWNrQmFja1R5cGUoZ2VtbE1vZHVsZSwgaW5mbykge1xuICAgICAgICBpZiAoVHlwZXMuQnVpbHRpbi5oYXMoaW5mby50eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGluZm87XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYmFzZUluZm8gPSB0aGlzLmxvYWRFbGVtZW50KGdlbWxNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LlRZUEUsIGluZm8udHlwZSwgdHJ1ZSk7XG5cbiAgICAgICAgaWYgKCFUeXBlcy5CdWlsdGluLmhhcyhiYXNlSW5mby50eXBlKSkge1xuICAgICAgICAgICAgLy90aGUgYmFzZSB0eXBlIGlzIG5vdCBhIGJ1aWx0aW4gdHlwZVxuICAgICAgICAgICAgbGV0IG93bmVyTW9kdWxlID0gYmFzZUluZm8uZ2VtbE1vZHVsZTsgIFxuXG4gICAgICAgICAgICBsZXQgcm9vdFR5cGVJbmZvID0gdGhpcy50cmFja0JhY2tUeXBlKG93bmVyTW9kdWxlLCBiYXNlSW5mbyk7XG4gICAgICAgICAgICBvd25lck1vZHVsZS50eXBlW2Jhc2VJbmZvLnR5cGVdID0gcm9vdFR5cGVJbmZvO1xuICAgICAgICAgICAgYmFzZUluZm8gPSByb290VHlwZUluZm87XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZGVyaXZlZEluZm8gPSB7IC4uLl8uY2xvbmVEZWVwKF8ub21pdChiYXNlSW5mbywgWydnZW1sTW9kdWxlJywgJ21vZGlmaWVycyddKSksIC4uLl8ub21pdChpbmZvLCBbJ2dlbWxNb2R1bGUnLCAndHlwZScsICdtb2RpZmllcnMnXSl9O1xuICAgICAgICBpZiAoYmFzZUluZm8ubW9kaWZpZXJzIHx8IGluZm8ubW9kaWZpZXJzKSB7XG4gICAgICAgICAgICBkZXJpdmVkSW5mby5tb2RpZmllcnMgPSBbIC4uLihiYXNlSW5mby5tb2RpZmllcnMgfHwgW10pLCAuLi4oaW5mby5tb2RpZmllcnMgfHwgW10pIF07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWRlcml2ZWRJbmZvLnN1YkNsYXNzKSB7XG4gICAgICAgICAgICBkZXJpdmVkSW5mby5zdWJDbGFzcyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGRlcml2ZWRJbmZvLnN1YkNsYXNzLnB1c2goaW5mby50eXBlKTtcbiAgICAgICAgcmV0dXJuIGRlcml2ZWRJbmZvO1xuICAgIH0gICAgXG4gICAgXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGFuIHZhbHVlIGJ5IGluZmVycmluZyBhbGwgdGhlIHJlZmVyZW5jZXMuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGdlbWxNb2R1bGUgXG4gICAgICogQHBhcmFtIHsqfSB2YWx1ZSBcbiAgICAgKiBAcmV0dXJucyB7Kn0gLSBUcmFuc2xhdGVkIHZhbHVlLlxuICAgICAqL1xuICAgIHRyYW5zbGF0ZU9vbFZhbHVlKGdlbWxNb2R1bGUsIHZhbHVlKSB7XG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QodmFsdWUpKSB7XG4gICAgICAgICAgICBpZiAodmFsdWUub29sVHlwZSA9PT0gR2VtbFR5cGVzLkxhbmcuQ09OU1RfUkVGKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCByZWZlZFZhbHVlID0gdGhpcy5sb2FkRWxlbWVudChnZW1sTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5DT05TVCwgdmFsdWUubmFtZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgbGV0IHVuaXF1ZUlkID0gdGhpcy5nZXRFbGVtZW50VW5pcXVlSWQoZ2VtbE1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuQ09OU1QsIHZhbHVlLm5hbWUpO1xuICAgICAgICAgICAgICAgIGxldCBvd25lck1vZHVsZSA9IHRoaXMuZ2V0TW9kdWxlQnlJZCh0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuZ2V0KHVuaXF1ZUlkKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT29sVmFsdWUob3duZXJNb2R1bGUsIHJlZmVkVmFsdWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5vb2xUeXBlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0b2RvOiB0cmFuc2xhdGVPb2xWYWx1ZSB3aXRoIHR5cGU6ICR7dmFsdWUub29sVHlwZX1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gXy5tYXBWYWx1ZXModmFsdWUsIHYgPT4gdGhpcy50cmFuc2xhdGVPb2xWYWx1ZShnZW1sTW9kdWxlLCB2KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5tYXAodiA9PiB0aGlzLnRyYW5zbGF0ZU9vbFZhbHVlKGdlbWxNb2R1bGUsIHYpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIHVuaXF1ZSBtb2R1bGUgaWQgYnkgc291cmNlIGZpbGUgcGF0aC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlUGF0aCAtIFRoZSBwYXRoIG9mIGFuIG9vbG9uZyBzb3VyY2UgZmlsZS5cbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIFRoZSBtb2R1bGUgaWQuXG4gICAgICovXG4gICAgZ2V0TW9kdWxlSWRCeVBhdGgobW9kdWxlUGF0aCkgeyAgICAgICAgXG4gICAgICAgIGxldCBpc0J1aWx0aW5FbnRpdHkgPSBfLnN0YXJ0c1dpdGgobW9kdWxlUGF0aCwgQlVJTFRJTlNfUEFUSCk7ICAgICAgXG4gICAgICAgIHJldHVybiBpc0J1aWx0aW5FbnRpdHkgPyBcbiAgICAgICAgICAgIHBhdGgucmVsYXRpdmUoQlVJTFRJTlNfUEFUSCwgbW9kdWxlUGF0aCkgOiBcbiAgICAgICAgICAgICcuLycgKyBwYXRoLnJlbGF0aXZlKHRoaXMuc291cmNlUGF0aCwgbW9kdWxlUGF0aCk7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIHVuaXF1ZSBuYW1lIG9mIGFuIGVsZW1lbnQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlZmVyZXJNb2R1bGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnRUeXBlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50TmFtZSBcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIFRoZSB1bmlxdWUgbmFtZSBvZiBhbiBlbGVtZW50LlxuICAgICAqL1xuICAgIGdldEVsZW1lbnRVbmlxdWVJZChyZWZlcmVyTW9kdWxlLCBlbGVtZW50VHlwZSwgZWxlbWVudE5hbWUpIHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlICsgJzonICsgZWxlbWVudE5hbWUgKyAnPC0nICsgcmVmZXJlck1vZHVsZS5pZDtcbiAgICB9XG5cbiAgICBsb2FkRW50aXR5KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuRU5USVRZLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuXG4gICAgICAgIGlmIChlbnRpdHkgJiYgXy5pc0VtcHR5KGVudGl0eS5maWVsZHMpICYmIF8uaXNFbXB0eShlbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVudGl0eSBcIiR7ZWxlbWVudE5hbWV9XCIgaGFzIG5vIGFueSBmaWVsZHMgZGVmaW5lZC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuXG4gICAgbG9hZFR5cGUocmVmZXJlck1vZHVsZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nID0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5UWVBFLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuICAgIH1cblxuICAgIGxvYWREYXRhc2V0KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuREFUQVNFVCwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKTtcbiAgICB9XG5cbiAgICBsb2FkVmlldyhyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcgPSB0cnVlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRFbGVtZW50KHJlZmVyZXJNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LlZJRVcsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhbiBlbGVtZW50IGJhc2VkIG9uIHRoZSBuYW1lc3BhY2UgY2hhaW4uXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlZmVyZXJNb2R1bGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnRUeXBlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50TmFtZSBcbiAgICAgKi9cbiAgICBsb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBlbGVtZW50VHlwZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKSB7XG4gICAgICAgIC8vIHRoZSBlbGVtZW50IGlkIHdpdGggdHlwZSwgc2hvdWxkIGJlIHVuaXF1ZSBhbW9uZyB0aGUgd2hvbGUgc2NoZW1hXG4gICAgICAgIGxldCB1bmlxdWVJZCA9IHRoaXMuZ2V0RWxlbWVudFVuaXF1ZUlkKHJlZmVyZXJNb2R1bGUsIGVsZW1lbnRUeXBlLCBlbGVtZW50TmFtZSk7XG5cbiAgICAgICAgLy8gdGhlIGVsZW1lbnQgaWQgKyByZWZlcmVyXG4gICAgICAgIGlmICh1bmlxdWVJZCBpbiB0aGlzLl9lbGVtZW50c0NhY2hlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdGFyZ2V0TW9kdWxlOyAgICAgICAgXG5cbiAgICAgICAgaWYgKGVsZW1lbnRUeXBlIGluIHJlZmVyZXJNb2R1bGUgJiYgZWxlbWVudE5hbWUgaW4gcmVmZXJlck1vZHVsZVtlbGVtZW50VHlwZV0pIHtcbiAgICAgICAgICAgIC8vIHNlZSBpZiBpdCBleGlzdHMgaW4gdGhlIHNhbWUgbW9kdWxlICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB0YXJnZXRNb2R1bGUgPSByZWZlcmVyTW9kdWxlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gc2VhcmNoIHJldmVyc2VseSBieSB0aGUgbmFtZXNwYWNlc1xuICAgICAgICAgICAgLy90aGlzLmxvZygndmVyYm9zZScsIGBTZWFyY2hpbmcgJHtlbGVtZW50VHlwZX0gXCIke2VsZW1lbnROYW1lfVwiIGZyb20gXCIke3JlZmVyZXJNb2R1bGUuaWR9XCIgLi4uYCk7XG5cbiAgICAgICAgICAgIGxldCBpbmRleCA9IF8uZmluZExhc3RJbmRleChyZWZlcmVyTW9kdWxlLm5hbWVzcGFjZSwgbW9kdWxlUGF0aCA9PiB7XG4gICAgICAgICAgICAgICAgLy90aGlzLmxvZygnZGVidWcnLCBgTG9va2luZyBmb3IgJHtlbGVtZW50VHlwZX0gXCIke2VsZW1lbnROYW1lfVwiIGluIFwiJHttb2R1bGVQYXRofVwiIC4uLmApO1xuXG4gICAgICAgICAgICAgICAgdGFyZ2V0TW9kdWxlID0gdGhpcy5sb2FkTW9kdWxlKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldE1vZHVsZSAmJiB0YXJnZXRNb2R1bGVbZWxlbWVudFR5cGVdICYmIChlbGVtZW50TmFtZSBpbiB0YXJnZXRNb2R1bGVbZWxlbWVudFR5cGVdKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7ICAgXG4gICAgICAgICAgICAgICAgaWYgKHRocm93T25NaXNzaW5nKSB7ICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZWxlbWVudFR5cGV9IFwiJHtlbGVtZW50TmFtZX1cIiBub3QgZm91bmQgaW4gaW1wb3J0ZWQgbmFtZXNwYWNlcy4gUmVmZXJlcjogJHtyZWZlcmVyTW9kdWxlLmlkfWApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZWxlbWVudFNlbGZJZCA9IGVsZW1lbnRUeXBlICsgJzonICsgZWxlbWVudE5hbWUgKyAnQCcgKyB0YXJnZXRNb2R1bGUuaWQ7XG4gICAgICAgIGlmIChlbGVtZW50U2VsZklkIGluIHRoaXMuX2VsZW1lbnRzQ2FjaGUpIHtcbiAgICAgICAgICAgIC8vIGFscmVhZHkgaW5pdGlhbGl6ZWQgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiAodGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF0gPSB0aGlzLl9lbGVtZW50c0NhY2hlW2VsZW1lbnRTZWxmSWRdKTtcbiAgICAgICAgfVxuICAgICAgIFxuICAgICAgICB0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuc2V0KHVuaXF1ZUlkLCB0YXJnZXRNb2R1bGUuaWQpO1xuXG4gICAgICAgIC8vIHJldHJpZXZlIHRoZSBjb21waWxlZCBpbmZvXG4gICAgICAgIGxldCBlbGVtZW50SW5mbyA9IHRhcmdldE1vZHVsZVtlbGVtZW50VHlwZV1bZWxlbWVudE5hbWVdO1xuICAgICAgICBsZXQgZWxlbWVudDtcblxuICAgICAgICBpZiAoZWxlbWVudFR5cGUgaW4gRUxFTUVOVF9DTEFTU19NQVApIHtcbiAgICAgICAgICAgIC8vIGVsZW1lbnQgbmVlZCBsaW5raW5nXG4gICAgICAgICAgICBsZXQgRWxlbWVudENsYXNzID0gRUxFTUVOVF9DTEFTU19NQVBbZWxlbWVudFR5cGVdOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBlbGVtZW50ID0gbmV3IEVsZW1lbnRDbGFzcyh0aGlzLCBlbGVtZW50TmFtZSwgdGFyZ2V0TW9kdWxlLCBlbGVtZW50SW5mbyk7ICAgXG4gICAgICAgICAgICBlbGVtZW50LmxpbmsoKTsgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gR2VtbFR5cGVzLkVsZW1lbnQuVFlQRSkge1xuICAgICAgICAgICAgICAgIGVsZW1lbnQgPSB7XG4gICAgICAgICAgICAgICAgICAgIC4uLmVsZW1lbnRJbmZvLFxuICAgICAgICAgICAgICAgICAgICBnZW1sTW9kdWxlOiB0YXJnZXRNb2R1bGVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudEluZm87XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9lbGVtZW50c0NhY2hlW2VsZW1lbnRTZWxmSWRdID0gZWxlbWVudDtcbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF0gPSBlbGVtZW50O1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgfVxuXG4gICAgX2NvbXBpbGUob29sRmlsZSkge1xuICAgICAgICBsZXQganNGaWxlO1xuICAgICAgICBcbiAgICAgICAgaWYgKG9vbEZpbGUuZW5kc1dpdGgoJy5qc29uJykpIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGU7XG4gICAgICAgICAgICBvb2xGaWxlID0gb29sRmlsZS5zdWJzdHIoMCwgb29sRmlsZS5sZW5ndGggLSA1KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGUgKyAnLmpzb24nO1xuICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IG9vbCwgc2VhcmNoRXh0O1xuXG4gICAgICAgIGlmICh0aGlzLnVzZUpzb25Tb3VyY2UpIHtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhqc0ZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcInVzZUpzb25Tb3VyY2VcIiBlbmFiZWxkIGJ1dCBqc29uIGZpbGUgXCIke2pzRmlsZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG9vbCA9IGZzLnJlYWRKc29uU3luYyhqc0ZpbGUpO1xuICAgICAgICAgICAgc2VhcmNoRXh0ID0gR0VNTF9TT1VSQ0VfRVhUICsgJy5qc29uJztcbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgLy90aGlzLmxvZygnZGVidWcnLCAnQ29tcGlsaW5nICcgKyBvb2xGaWxlICsgJyAuLi4nKTsgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG9vbCA9IE9vbG9uZ1BhcnNlci5wYXJzZShmcy5yZWFkRmlsZVN5bmMob29sRmlsZSwgJ3V0ZjgnKSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbXBpbGUgXCIkeyBvb2xGaWxlIH1cIi5cXG4keyBlcnJvci5tZXNzYWdlIHx8IGVycm9yIH1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIW9vbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlcnJvciBvY2N1cnJlZCB3aGlsZSBjb21waWxpbmcuJyk7XG4gICAgICAgICAgICB9ICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBzZWFyY2hFeHQgPSBHRU1MX1NPVVJDRV9FWFQ7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYmFzZU5hbWUgPSBwYXRoLmJhc2VuYW1lKG9vbEZpbGUsIEdFTUxfU09VUkNFX0VYVCk7XG5cbiAgICAgICAgbGV0IG5hbWVzcGFjZSA9IFtdO1xuXG4gICAgICAgIGxldCBjdXJyZW50UGF0aCA9IHBhdGguZGlybmFtZShvb2xGaWxlKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogXG4gICAgICAgICAqIEBwYXJhbSB7Kn0gbmFtZXNwYWNlcyAtIFNlYXJjaGluZyBwYXRoXG4gICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBucyAtIEltcG9ydCBsaW5lXG4gICAgICAgICAqIEBwYXJhbSB7Kn0gcmVjdXJzaXZlIFxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gZXhwYW5kTnMobmFtZXNwYWNlcywgbnMsIHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgbGV0IHN0YXRzID0gZnMuc3RhdFN5bmMobnMpO1xuXG4gICAgICAgICAgICAvL2ltcG9ydCAnL3BhdGgvdXNlci5vb2wnXG4gICAgICAgICAgICBpZiAoc3RhdHMuaXNGaWxlKCkgJiYgbnMuZW5kc1dpdGgoc2VhcmNoRXh0KSkge1xuICAgICAgICAgICAgICAgIG5hbWVzcGFjZXMucHVzaChucyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSAmJiByZWN1cnNpdmUpIHtcbiAgICAgICAgICAgICAgICAvL3Jlc3Vyc2l2ZSBleHBhbmQgc3ViLWRpcmVjdG9yeVxuICAgICAgICAgICAgICAgIGxldCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKG5zKTtcbiAgICAgICAgICAgICAgICBmaWxlcy5mb3JFYWNoKGYgPT4gZXhwYW5kTnMobmFtZXNwYWNlcywgcGF0aC5qb2luKG5zLCBmKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9vbC5uYW1lc3BhY2UpIHtcbiAgICAgICAgICAgIG9vbC5uYW1lc3BhY2UuZm9yRWFjaChucyA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHA7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKG5zLnN0YXJ0c1dpdGgoJzxidWlsdGlucz4vJykpIHtcbiAgICAgICAgICAgICAgICAgICAgbnMgPSBwYXRoLmpvaW4oQlVJTFRJTlNfUEFUSCwgbnMuc3Vic3RyKDExKSk7ICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChucy5zdGFydHNXaXRoKCc8c291cmNlPi8nKSkge1xuICAgICAgICAgICAgICAgICAgICBucyA9IHBhdGguam9pbih0aGlzLnNvdXJjZVBhdGgsIG5zLnN1YnN0cig5KSk7ICAgXG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgaWYgKG5zLmVuZHNXaXRoKCcvKicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHAgPSBwYXRoLnJlc29sdmUoY3VycmVudFBhdGgsIG5zLnN1YnN0cigwLCBucy5sZW5ndGggLSAyKSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKHApO1xuICAgICAgICAgICAgICAgICAgICBmaWxlcy5mb3JFYWNoKGYgPT4gZXhwYW5kTnMobmFtZXNwYWNlLCBwYXRoLmpvaW4ocCwgZiksIGZhbHNlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChucy5lbmRzV2l0aCgnLyoqJykpIHtcbiAgICAgICAgICAgICAgICAgICAgcCA9IHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgbnMuc3Vic3RyKDAsIG5zLmxlbmd0aCAtIDMpKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVzID0gZnMucmVhZGRpclN5bmMocCk7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZiA9PiBleHBhbmROcyhuYW1lc3BhY2UsIHBhdGguam9pbihwLCBmKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZS5wdXNoKHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgXy5lbmRzV2l0aChucywgR0VNTF9TT1VSQ0VfRVhUKSA/IG5zIDogbnMgKyBHRU1MX1NPVVJDRV9FWFQpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9vbC5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7XG5cbiAgICAgICAgb29sLmlkID0gdGhpcy5nZXRNb2R1bGVJZEJ5UGF0aChvb2xGaWxlKTsgICAgICAgIFxuICAgICAgICBvb2wubmFtZSA9IGJhc2VOYW1lOyAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmICghdGhpcy51c2VKc29uU291cmNlICYmIHRoaXMuc2F2ZUludGVybWVkaWF0ZSkgeyAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGpzRmlsZSwgSlNPTi5zdHJpbmdpZnkob29sLCBudWxsLCA0KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb29sO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBMaW5rZXI7Il19
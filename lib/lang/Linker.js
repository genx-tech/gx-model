"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob
} = require('rk-utils');

const {
  Types
} = require('@genx/data');

const Oolong = require('./grammar/geml');

const OolongParser = Oolong.parser;

const GemlTypes = require('./GemlTypes');

const Entity = require('./Entity');

const Schema = require('./Schema');

const View = require('./View');

const Dataset = require('./Dataset');

const ELEMENT_CLASS_MAP = {
  [GemlTypes.Element.ENTITY]: Entity,
  [GemlTypes.Element.VIEW]: View,
  [GemlTypes.Element.DATASET]: Dataset
};
const GEML_SOURCE_EXT = '.geml';
const BUILTINS_PATH = path.resolve(__dirname, 'builtins');

class Linker {
  static getGemlFiles(sourceDir, useJsonSource, recursive) {
    let pattern = '*' + GEML_SOURCE_EXT;

    if (useJsonSource) {
      pattern += '.json';
    }

    if (recursive) {
      pattern = '**/' + pattern;
    }

    return glob.sync(path.join(sourceDir, pattern), {
      nodir: true
    });
  }

  constructor(app, context) {
    this.app = app;
    this.sourcePath = context.gemlPath;
    this.useJsonSource = context.useJsonSource;
    this.saveIntermediate = context.saveIntermediate;
    this.schemaDeployment = context.schemas;
    this.schemas = {};
    this._gemlModules = {};
    this._elementsCache = {};
    this._mapOfReferenceToModuleId = new Map();
  }

  log(...args) {
    this.app.log(...args);
  }

  isModuleLoaded(moduleId) {
    return moduleId in this._gemlModules;
  }

  getModuleById(moduleId) {
    return this._gemlModules[moduleId];
  }

  link(entryFileName) {
    let entryModule = this.loadModule(entryFileName);

    if (!entryModule) {
      throw new Error(`Cannot resolve file "${entryFileName}".`);
    }

    if (_.isEmpty(entryModule.schema)) {
      throw new Error('No schema defined in entry file.');
    }

    _.forOwn(entryModule.schema, (schemaInfo, schemaName) => {
      let deploymentSettings = this.schemaDeployment[schemaName];
      let schema = new Schema(this, schemaName, entryModule, schemaInfo, deploymentSettings);
      schema.link();

      if (this.schemas.hasOwnProperty(schemaName)) {
        throw new Error(`Duplicate schema: "${schemaName}".`);
      }

      this.schemas[schemaName] = schema;

      if (this.saveIntermediate) {
        let jsFile = path.resolve(this.sourcePath, entryFileName + '-linked.json');
        fs.writeFileSync(jsFile, JSON.stringify(schema.toJSON(), null, 4));
      }
    });
  }

  loadModule(modulePath) {
    modulePath = path.resolve(this.sourcePath, modulePath);
    let id = this.getModuleIdByPath(modulePath);

    if (this.isModuleLoaded(id)) {
      return this.getModuleById(id);
    }

    if (!fs.existsSync(modulePath)) {
      return undefined;
    }

    let gemlModule = this._compile(modulePath);

    return this._gemlModules[id] = gemlModule;
  }

  trackBackType(gemlModule, info) {
    if (Types.Builtin.has(info.type)) {
      return info;
    }

    let baseInfo = this.loadElement(gemlModule, GemlTypes.Element.TYPE, info.type, true);

    if (!Types.Builtin.has(baseInfo.type)) {
      let ownerModule = baseInfo.gemlModule;
      let rootTypeInfo = this.trackBackType(ownerModule, baseInfo);
      ownerModule.type[baseInfo.type] = rootTypeInfo;
      baseInfo = rootTypeInfo;
    }

    let derivedInfo = { ..._.cloneDeep(_.omit(baseInfo, ['gemlModule', 'modifiers'])),
      ..._.omit(info, ['gemlModule', 'type', 'modifiers'])
    };

    if (baseInfo.modifiers || info.modifiers) {
      derivedInfo.modifiers = [...(baseInfo.modifiers || []), ...(info.modifiers || [])];
    }

    if (!derivedInfo.subClass) {
      derivedInfo.subClass = [];
    }

    derivedInfo.subClass.push(info.type);
    return derivedInfo;
  }

  translateOolValue(gemlModule, value) {
    if (_.isPlainObject(value)) {
      if (value.oolType === GemlTypes.Lang.CONST_REF) {
        let refedValue = this.loadElement(gemlModule, GemlTypes.Element.CONST, value.name, true);
        let uniqueId = this.getElementUniqueId(gemlModule, GemlTypes.Element.CONST, value.name);
        let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
        return this.translateOolValue(ownerModule, refedValue);
      } else if (value.oolType) {
        throw new Error(`todo: translateOolValue with type: ${value.oolType}`);
      }

      return _.mapValues(value, v => this.translateOolValue(gemlModule, v));
    }

    if (Array.isArray(value)) {
      return value.map(v => this.translateOolValue(gemlModule, v));
    }

    return value;
  }

  getModuleIdByPath(modulePath) {
    let isBuiltinEntity = _.startsWith(modulePath, BUILTINS_PATH);

    return isBuiltinEntity ? path.relative(BUILTINS_PATH, modulePath) : './' + path.relative(this.sourcePath, modulePath);
  }

  getElementUniqueId(refererModule, elementType, elementName) {
    return elementType + ':' + elementName + '<-' + refererModule.id;
  }

  loadEntity(refererModule, elementName, throwOnMissing = true) {
    let entity = this.loadElement(refererModule, GemlTypes.Element.ENTITY, elementName, throwOnMissing);

    if (entity && _.isEmpty(entity.fields) && _.isEmpty(entity.info.associations)) {
      throw new Error(`Entity "${elementName}" has no any fields defined.`);
    }

    return entity;
  }

  loadType(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.TYPE, elementName, throwOnMissing);
  }

  loadDataset(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.DATASET, elementName, throwOnMissing);
  }

  loadView(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.VIEW, elementName, throwOnMissing);
  }

  loadElement(refererModule, elementType, elementName, throwOnMissing) {
    let uniqueId = this.getElementUniqueId(refererModule, elementType, elementName);

    if (uniqueId in this._elementsCache) {
      return this._elementsCache[uniqueId];
    }

    let targetModule;

    if (elementType in refererModule && elementName in refererModule[elementType]) {
      targetModule = refererModule;
    } else {
      let index = _.findLastIndex(refererModule.namespace, modulePath => {
        targetModule = this.loadModule(modulePath);
        return targetModule && targetModule[elementType] && elementName in targetModule[elementType];
      });

      if (index === -1) {
        if (throwOnMissing) {
          throw new Error(`${elementType} "${elementName}" not found in imported namespaces. Referer: ${refererModule.id}`);
        }

        return undefined;
      }
    }

    let elementSelfId = elementType + ':' + elementName + '@' + targetModule.id;

    if (elementSelfId in this._elementsCache) {
      return this._elementsCache[uniqueId] = this._elementsCache[elementSelfId];
    }

    this._mapOfReferenceToModuleId.set(uniqueId, targetModule.id);

    let elementInfo = targetModule[elementType][elementName];
    let element;

    if (elementType in ELEMENT_CLASS_MAP) {
      let ElementClass = ELEMENT_CLASS_MAP[elementType];
      element = new ElementClass(this, elementName, targetModule, Object.freeze(elementInfo));
      element.link();
    } else {
      if (elementType === GemlTypes.Element.TYPE) {
        elementInfo.gemlModule = targetModule;
      }

      element = Object.freeze(elementInfo);
    }

    this._elementsCache[elementSelfId] = element;
    this._elementsCache[uniqueId] = element;
    return element;
  }

  _compile(oolFile) {
    let jsFile;

    if (oolFile.endsWith('.json')) {
      jsFile = oolFile;
      oolFile = oolFile.substr(0, oolFile.length - 5);
    } else {
      jsFile = oolFile + '.json';
    }

    let ool, searchExt;

    if (this.useJsonSource) {
      if (!fs.existsSync(jsFile)) {
        throw new Error(`"useJsonSource" enabeld but json file "${jsFile}" not found.`);
      }

      ool = fs.readJsonSync(jsFile);
      searchExt = GEML_SOURCE_EXT + '.json';
    } else {
      try {
        ool = OolongParser.parse(fs.readFileSync(oolFile, 'utf8'));
      } catch (error) {
        throw new Error(`Failed to compile "${oolFile}".\n${error.message || error}`);
      }

      if (!ool) {
        throw new Error('Unknown error occurred while compiling.');
      }

      searchExt = GEML_SOURCE_EXT;
    }

    let baseName = path.basename(oolFile, GEML_SOURCE_EXT);
    let namespace = [];
    let currentPath = path.dirname(oolFile);

    function expandNs(namespaces, ns, recursive) {
      let stats = fs.statSync(ns);

      if (stats.isFile() && ns.endsWith(searchExt)) {
        namespaces.push(ns);
        return;
      }

      if (stats.isDirectory() && recursive) {
        let files = fs.readdirSync(ns);
        files.forEach(f => expandNs(namespaces, path.join(ns, f), true));
      }
    }

    if (ool.namespace) {
      ool.namespace.forEach(ns => {
        let p;

        if (ns.startsWith('<builtins>/')) {
          ns = path.join(BUILTINS_PATH, ns.substr(11));
        } else if (ns.startsWith('<source>/')) {
          ns = path.join(this.sourcePath, ns.substr(9));
        }

        if (ns.endsWith('/*')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 2));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), false));
        } else if (ns.endsWith('/**')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 3));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), true));
        } else {
          namespace.push(path.resolve(currentPath, _.endsWith(ns, GEML_SOURCE_EXT) ? ns : ns + GEML_SOURCE_EXT));
        }
      });
    }

    ool.namespace = namespace;
    ool.id = this.getModuleIdByPath(oolFile);
    ool.name = baseName;

    if (!this.useJsonSource && this.saveIntermediate) {
      fs.writeFileSync(jsFile, JSON.stringify(ool, null, 4));
    }

    return ool;
  }

}

module.exports = Linker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0xpbmtlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJUeXBlcyIsIk9vbG9uZyIsIk9vbG9uZ1BhcnNlciIsInBhcnNlciIsIkdlbWxUeXBlcyIsIkVudGl0eSIsIlNjaGVtYSIsIlZpZXciLCJEYXRhc2V0IiwiRUxFTUVOVF9DTEFTU19NQVAiLCJFbGVtZW50IiwiRU5USVRZIiwiVklFVyIsIkRBVEFTRVQiLCJHRU1MX1NPVVJDRV9FWFQiLCJCVUlMVElOU19QQVRIIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIkxpbmtlciIsImdldEdlbWxGaWxlcyIsInNvdXJjZURpciIsInVzZUpzb25Tb3VyY2UiLCJyZWN1cnNpdmUiLCJwYXR0ZXJuIiwic3luYyIsImpvaW4iLCJub2RpciIsImNvbnN0cnVjdG9yIiwiYXBwIiwiY29udGV4dCIsInNvdXJjZVBhdGgiLCJnZW1sUGF0aCIsInNhdmVJbnRlcm1lZGlhdGUiLCJzY2hlbWFEZXBsb3ltZW50Iiwic2NoZW1hcyIsIl9nZW1sTW9kdWxlcyIsIl9lbGVtZW50c0NhY2hlIiwiX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZCIsIk1hcCIsImxvZyIsImFyZ3MiLCJpc01vZHVsZUxvYWRlZCIsIm1vZHVsZUlkIiwiZ2V0TW9kdWxlQnlJZCIsImxpbmsiLCJlbnRyeUZpbGVOYW1lIiwiZW50cnlNb2R1bGUiLCJsb2FkTW9kdWxlIiwiRXJyb3IiLCJpc0VtcHR5Iiwic2NoZW1hIiwiZm9yT3duIiwic2NoZW1hSW5mbyIsInNjaGVtYU5hbWUiLCJkZXBsb3ltZW50U2V0dGluZ3MiLCJoYXNPd25Qcm9wZXJ0eSIsImpzRmlsZSIsIndyaXRlRmlsZVN5bmMiLCJKU09OIiwic3RyaW5naWZ5IiwidG9KU09OIiwibW9kdWxlUGF0aCIsImlkIiwiZ2V0TW9kdWxlSWRCeVBhdGgiLCJleGlzdHNTeW5jIiwidW5kZWZpbmVkIiwiZ2VtbE1vZHVsZSIsIl9jb21waWxlIiwidHJhY2tCYWNrVHlwZSIsImluZm8iLCJCdWlsdGluIiwiaGFzIiwidHlwZSIsImJhc2VJbmZvIiwibG9hZEVsZW1lbnQiLCJUWVBFIiwib3duZXJNb2R1bGUiLCJyb290VHlwZUluZm8iLCJkZXJpdmVkSW5mbyIsImNsb25lRGVlcCIsIm9taXQiLCJtb2RpZmllcnMiLCJzdWJDbGFzcyIsInB1c2giLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsInZhbHVlIiwiaXNQbGFpbk9iamVjdCIsIm9vbFR5cGUiLCJMYW5nIiwiQ09OU1RfUkVGIiwicmVmZWRWYWx1ZSIsIkNPTlNUIiwibmFtZSIsInVuaXF1ZUlkIiwiZ2V0RWxlbWVudFVuaXF1ZUlkIiwiZ2V0IiwibWFwVmFsdWVzIiwidiIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsImlzQnVpbHRpbkVudGl0eSIsInN0YXJ0c1dpdGgiLCJyZWxhdGl2ZSIsInJlZmVyZXJNb2R1bGUiLCJlbGVtZW50VHlwZSIsImVsZW1lbnROYW1lIiwibG9hZEVudGl0eSIsInRocm93T25NaXNzaW5nIiwiZW50aXR5IiwiZmllbGRzIiwiYXNzb2NpYXRpb25zIiwibG9hZFR5cGUiLCJsb2FkRGF0YXNldCIsImxvYWRWaWV3IiwidGFyZ2V0TW9kdWxlIiwiaW5kZXgiLCJmaW5kTGFzdEluZGV4IiwibmFtZXNwYWNlIiwiZWxlbWVudFNlbGZJZCIsInNldCIsImVsZW1lbnRJbmZvIiwiZWxlbWVudCIsIkVsZW1lbnRDbGFzcyIsIk9iamVjdCIsImZyZWV6ZSIsIm9vbEZpbGUiLCJlbmRzV2l0aCIsInN1YnN0ciIsImxlbmd0aCIsIm9vbCIsInNlYXJjaEV4dCIsInJlYWRKc29uU3luYyIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiZXJyb3IiLCJtZXNzYWdlIiwiYmFzZU5hbWUiLCJiYXNlbmFtZSIsImN1cnJlbnRQYXRoIiwiZGlybmFtZSIsImV4cGFuZE5zIiwibmFtZXNwYWNlcyIsIm5zIiwic3RhdHMiLCJzdGF0U3luYyIsImlzRmlsZSIsImlzRGlyZWN0b3J5Iiwi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UCxHQUFpQnhJLE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBnbG9iIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBUeXBlcyB9ID0gcmVxdWlyZSgnQGdlbngvZGF0YScpO1xuXG5jb25zdCBPb2xvbmcgPSByZXF1aXJlKCcuL2dyYW1tYXIvZ2VtbCcpO1xuY29uc3QgT29sb25nUGFyc2VyID0gT29sb25nLnBhcnNlcjtcbmNvbnN0IEdlbWxUeXBlcyA9IHJlcXVpcmUoJy4vR2VtbFR5cGVzJyk7XG5jb25zdCBFbnRpdHkgPSByZXF1aXJlKCcuL0VudGl0eScpO1xuY29uc3QgU2NoZW1hID0gcmVxdWlyZSgnLi9TY2hlbWEnKTtcbmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuL1ZpZXcnKTtcbmNvbnN0IERhdGFzZXQgPSByZXF1aXJlKCcuL0RhdGFzZXQnKTtcblxuY29uc3QgRUxFTUVOVF9DTEFTU19NQVAgPSB7XG4gICAgW0dlbWxUeXBlcy5FbGVtZW50LkVOVElUWV06IEVudGl0eSxcbiAgICBbR2VtbFR5cGVzLkVsZW1lbnQuVklFV106IFZpZXcsXG4gICAgW0dlbWxUeXBlcy5FbGVtZW50LkRBVEFTRVRdOiBEYXRhc2V0LFxufTtcblxuY29uc3QgR0VNTF9TT1VSQ0VfRVhUID0gJy5nZW1sJztcbmNvbnN0IEJVSUxUSU5TX1BBVEggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnYnVpbHRpbnMnKTtcblxuLyoqXG4gKiBMaW5rZXIgb2YgZ2VtbFxuICogQGNsYXNzIEdlbWxMaW5rZXJcbiAqL1xuY2xhc3MgTGlua2VyIHtcbiAgICBzdGF0aWMgZ2V0R2VtbEZpbGVzKHNvdXJjZURpciwgdXNlSnNvblNvdXJjZSwgcmVjdXJzaXZlKSB7XG4gICAgICAgIGxldCBwYXR0ZXJuID0gJyonICsgR0VNTF9TT1VSQ0VfRVhUO1xuXG4gICAgICAgIGlmICh1c2VKc29uU291cmNlKSB7XG4gICAgICAgICAgICBwYXR0ZXJuICs9ICcuanNvbic7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVjdXJzaXZlKSB7XG4gICAgICAgICAgICBwYXR0ZXJuID0gJyoqLycgKyBwYXR0ZXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGdsb2Iuc3luYyhwYXRoLmpvaW4oc291cmNlRGlyLCBwYXR0ZXJuKSwge25vZGlyOiB0cnVlfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtTZXJ2aWNlQ29udGFpbmVyfSBhcHAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5nZW1sUGF0aCAtIEdlbWwgc291cmNlIGZpbGVzIHBhdGggICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NvbnRleHQudXNlSnNvblNvdXJjZT1mYWxzZV0gLSBVc2UgLmpzb24gaW50ZXJtZWRpYXRlIHNvdXJjZSBmaWxlIGluc3RlYWQgb2YgLm9vbFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NvbnRleHQuc2F2ZUludGVybWVkaWF0ZT1mYWxzZV0gLSBTYXZlIGludGVybWVkaWF0ZSBzb3VyY2UgZmlsZSB3aGlsZSBsaW5raW5nXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoYXBwLCBjb250ZXh0KSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBcHBcbiAgICAgICAgICogQG1lbWJlciB7U2VydmljZUNvbnRhaW5lcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBHZW1sIHNvdXJjZSBmaWxlcyBwYXRoXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc291cmNlUGF0aCA9IGNvbnRleHQuZ2VtbFBhdGg7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVzZSBqc29uIG9yIG9sc1xuICAgICAgICAgKiBAbWVtYmVyIHtib29sfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy51c2VKc29uU291cmNlID0gY29udGV4dC51c2VKc29uU291cmNlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBTYXZlIGludGVybWVkaWF0ZSBmaWxlc1xuICAgICAgICAgKiBAbWVtYmVyIHtib29sfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zYXZlSW50ZXJtZWRpYXRlID0gY29udGV4dC5zYXZlSW50ZXJtZWRpYXRlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBTY2hlbWEgZGVwbG95bWVudCBzZXR0aW5nc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNjaGVtYURlcGxveW1lbnQgPSBjb250ZXh0LnNjaGVtYXM7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlZCBzY2hlbWFzXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdC48c3RyaW5nLCBTY2hlbWE+fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zY2hlbWFzID0ge307XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFBhcnNlZCBvb2xvbmcgZmlsZXMsIHBhdGggPT4gbW9kdWxlXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICogQHByaXZhdGVcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2dlbWxNb2R1bGVzID0ge307XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVsZW1lbnQgY2FjaGUsIG1hcCBvZiA8cmVmZXJlbmNlSWQsIGVsZW1lbnQ+IGFuZCA8c2VsZklkLCBlbGVtZW50PlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9IFxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZSA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNYXAgb2YgPHJlZmVyZW5jZUlkLCBtb2R1bGVJZD5cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fbWFwT2ZSZWZlcmVuY2VUb01vZHVsZUlkID0gbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdyaXRlIGxvZ1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsZXZlbFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtkYXRhXVxuICAgICAqL1xuICAgIGxvZyguLi5hcmdzKSB7XG4gICAgICAgIHRoaXMuYXBwLmxvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIGEgbW9kdWxlIGlzIGxvYWRlZFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVJZFxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGlzTW9kdWxlTG9hZGVkKG1vZHVsZUlkKSB7XG4gICAgICAgIHJldHVybiAobW9kdWxlSWQgaW4gdGhpcy5fZ2VtbE1vZHVsZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIGxvYWRlZCBvb2xvbmUgbW9kdWxlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZUlkXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICBnZXRNb2R1bGVCeUlkKG1vZHVsZUlkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZW1sTW9kdWxlc1ttb2R1bGVJZF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgbGlua2luZyBvb2xvbmcgZmlsZXNcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZW50cnlGaWxlTmFtZVxuICAgICAqL1xuICAgIGxpbmsoZW50cnlGaWxlTmFtZSkge1xuICAgICAgICAvL2NvbXBpbGUgZW50cnkgZmlsZSAgICAgICAgXG4gICAgICAgIGxldCBlbnRyeU1vZHVsZSA9IHRoaXMubG9hZE1vZHVsZShlbnRyeUZpbGVOYW1lKTtcblxuICAgICAgICBpZiAoIWVudHJ5TW9kdWxlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCByZXNvbHZlIGZpbGUgXCIke2VudHJ5RmlsZU5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXy5pc0VtcHR5KGVudHJ5TW9kdWxlLnNjaGVtYSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2NoZW1hIGRlZmluZWQgaW4gZW50cnkgZmlsZS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIF8uZm9yT3duKGVudHJ5TW9kdWxlLnNjaGVtYSwgKHNjaGVtYUluZm8sIHNjaGVtYU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBkZXBsb3ltZW50U2V0dGluZ3MgPSB0aGlzLnNjaGVtYURlcGxveW1lbnRbc2NoZW1hTmFtZV07XG4gICAgICAgICAgICAvL2Fzc2VydDogZGVwbG95bWVudFNldHRpbmdzLCBgXCJkZXBsb3ltZW50U2V0dGluZ3NcIiBvZiBzY2hlbWEgWyR7c2NoZW1hTmFtZX1dIG5vdCBmb3VuZC5gO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgc2NoZW1hID0gbmV3IFNjaGVtYSh0aGlzLCBzY2hlbWFOYW1lLCBlbnRyeU1vZHVsZSwgc2NoZW1hSW5mbywgZGVwbG95bWVudFNldHRpbmdzKTtcbiAgICAgICAgICAgIHNjaGVtYS5saW5rKCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYXMuaGFzT3duUHJvcGVydHkoc2NoZW1hTmFtZSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBzY2hlbWE6IFwiJHtzY2hlbWFOYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zY2hlbWFzW3NjaGVtYU5hbWVdID0gc2NoZW1hO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zYXZlSW50ZXJtZWRpYXRlKSB7XG4gICAgICAgICAgICAgICAgbGV0IGpzRmlsZSA9IHBhdGgucmVzb2x2ZSh0aGlzLnNvdXJjZVBhdGgsIGVudHJ5RmlsZU5hbWUgKyAnLWxpbmtlZC5qc29uJyk7XG4gICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhqc0ZpbGUsIEpTT04uc3RyaW5naWZ5KHNjaGVtYS50b0pTT04oKSwgbnVsbCwgNCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvYWQgYSBvb2xvbmcgbW9kdWxlLCByZXR1cm4gdW5kZWZpbmVkIGlmIG5vdCBleGlzdFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVQYXRoXG4gICAgICogQHJldHVybnMgeyp9XG4gICAgICovXG4gICAgbG9hZE1vZHVsZShtb2R1bGVQYXRoKSB7ICAgICAgICBcbiAgICAgICAgbW9kdWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnNvdXJjZVBhdGgsIG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIGxldCBpZCA9IHRoaXMuZ2V0TW9kdWxlSWRCeVBhdGgobW9kdWxlUGF0aCk7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNNb2R1bGVMb2FkZWQoaWQpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRNb2R1bGVCeUlkKGlkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2R1bGVQYXRoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICBsZXQgZ2VtbE1vZHVsZSA9IHRoaXMuX2NvbXBpbGUobW9kdWxlUGF0aCk7XG5cbiAgICAgICAgcmV0dXJuICh0aGlzLl9nZW1sTW9kdWxlc1tpZF0gPSBnZW1sTW9kdWxlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFjayBiYWNrIHRoZSB0eXBlIGRlcml2ZWQgY2hhaW4uXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGdlbWxNb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mb1xuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgdHJhY2tCYWNrVHlwZShnZW1sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIGlmIChUeXBlcy5CdWlsdGluLmhhcyhpbmZvLnR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gaW5mbztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBiYXNlSW5mbyA9IHRoaXMubG9hZEVsZW1lbnQoZ2VtbE1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuVFlQRSwgaW5mby50eXBlLCB0cnVlKTtcblxuICAgICAgICBpZiAoIVR5cGVzLkJ1aWx0aW4uaGFzKGJhc2VJbmZvLnR5cGUpKSB7XG4gICAgICAgICAgICAvL3RoZSBiYXNlIHR5cGUgaXMgbm90IGEgYnVpbHRpbiB0eXBlXG4gICAgICAgICAgICBsZXQgb3duZXJNb2R1bGUgPSBiYXNlSW5mby5nZW1sTW9kdWxlOyAgXG5cbiAgICAgICAgICAgIGxldCByb290VHlwZUluZm8gPSB0aGlzLnRyYWNrQmFja1R5cGUob3duZXJNb2R1bGUsIGJhc2VJbmZvKTtcbiAgICAgICAgICAgIG93bmVyTW9kdWxlLnR5cGVbYmFzZUluZm8udHlwZV0gPSByb290VHlwZUluZm87XG4gICAgICAgICAgICBiYXNlSW5mbyA9IHJvb3RUeXBlSW5mbztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkZXJpdmVkSW5mbyA9IHsgLi4uXy5jbG9uZURlZXAoXy5vbWl0KGJhc2VJbmZvLCBbJ2dlbWxNb2R1bGUnLCAnbW9kaWZpZXJzJ10pKSwgLi4uXy5vbWl0KGluZm8sIFsnZ2VtbE1vZHVsZScsICd0eXBlJywgJ21vZGlmaWVycyddKX07XG4gICAgICAgIGlmIChiYXNlSW5mby5tb2RpZmllcnMgfHwgaW5mby5tb2RpZmllcnMpIHtcbiAgICAgICAgICAgIGRlcml2ZWRJbmZvLm1vZGlmaWVycyA9IFsgLi4uKGJhc2VJbmZvLm1vZGlmaWVycyB8fCBbXSksIC4uLihpbmZvLm1vZGlmaWVycyB8fCBbXSkgXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZGVyaXZlZEluZm8uc3ViQ2xhc3MpIHtcbiAgICAgICAgICAgIGRlcml2ZWRJbmZvLnN1YkNsYXNzID0gW107XG4gICAgICAgIH1cbiAgICAgICAgZGVyaXZlZEluZm8uc3ViQ2xhc3MucHVzaChpbmZvLnR5cGUpO1xuICAgICAgICByZXR1cm4gZGVyaXZlZEluZm87XG4gICAgfSAgICBcbiAgICBcbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgYW4gdmFsdWUgYnkgaW5mZXJyaW5nIGFsbCB0aGUgcmVmZXJlbmNlcy5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZ2VtbE1vZHVsZSBcbiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFxuICAgICAqIEByZXR1cm5zIHsqfSAtIFRyYW5zbGF0ZWQgdmFsdWUuXG4gICAgICovXG4gICAgdHJhbnNsYXRlT29sVmFsdWUoZ2VtbE1vZHVsZSwgdmFsdWUpIHtcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS5vb2xUeXBlID09PSBHZW1sVHlwZXMuTGFuZy5DT05TVF9SRUYpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHJlZmVkVmFsdWUgPSB0aGlzLmxvYWRFbGVtZW50KGdlbWxNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LkNPTlNULCB2YWx1ZS5uYW1lLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBsZXQgdW5pcXVlSWQgPSB0aGlzLmdldEVsZW1lbnRVbmlxdWVJZChnZW1sTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5DT05TVCwgdmFsdWUubmFtZSk7XG4gICAgICAgICAgICAgICAgbGV0IG93bmVyTW9kdWxlID0gdGhpcy5nZXRNb2R1bGVCeUlkKHRoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZC5nZXQodW5pcXVlSWQpKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGVPb2xWYWx1ZShvd25lck1vZHVsZSwgcmVmZWRWYWx1ZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm9vbFR5cGUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRvZG86IHRyYW5zbGF0ZU9vbFZhbHVlIHdpdGggdHlwZTogJHt2YWx1ZS5vb2xUeXBlfWApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBfLm1hcFZhbHVlcyh2YWx1ZSwgdiA9PiB0aGlzLnRyYW5zbGF0ZU9vbFZhbHVlKGdlbWxNb2R1bGUsIHYpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh2ID0+IHRoaXMudHJhbnNsYXRlT29sVmFsdWUoZ2VtbE1vZHVsZSwgdikpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgdW5pcXVlIG1vZHVsZSBpZCBieSBzb3VyY2UgZmlsZSBwYXRoLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVQYXRoIC0gVGhlIHBhdGggb2YgYW4gb29sb25nIHNvdXJjZSBmaWxlLlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IC0gVGhlIG1vZHVsZSBpZC5cbiAgICAgKi9cbiAgICBnZXRNb2R1bGVJZEJ5UGF0aChtb2R1bGVQYXRoKSB7ICAgICAgICBcbiAgICAgICAgbGV0IGlzQnVpbHRpbkVudGl0eSA9IF8uc3RhcnRzV2l0aChtb2R1bGVQYXRoLCBCVUlMVElOU19QQVRIKTsgICAgICBcbiAgICAgICAgcmV0dXJuIGlzQnVpbHRpbkVudGl0eSA/IFxuICAgICAgICAgICAgcGF0aC5yZWxhdGl2ZShCVUlMVElOU19QQVRILCBtb2R1bGVQYXRoKSA6IFxuICAgICAgICAgICAgJy4vJyArIHBhdGgucmVsYXRpdmUodGhpcy5zb3VyY2VQYXRoLCBtb2R1bGVQYXRoKTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgdW5pcXVlIG5hbWUgb2YgYW4gZWxlbWVudC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVmZXJlck1vZHVsZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudFR5cGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnROYW1lIFxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IC0gVGhlIHVuaXF1ZSBuYW1lIG9mIGFuIGVsZW1lbnQuXG4gICAgICovXG4gICAgZ2V0RWxlbWVudFVuaXF1ZUlkKHJlZmVyZXJNb2R1bGUsIGVsZW1lbnRUeXBlLCBlbGVtZW50TmFtZSkge1xuICAgICAgICByZXR1cm4gZWxlbWVudFR5cGUgKyAnOicgKyBlbGVtZW50TmFtZSArICc8LScgKyByZWZlcmVyTW9kdWxlLmlkO1xuICAgIH1cblxuICAgIGxvYWRFbnRpdHkocmVmZXJlck1vZHVsZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nID0gdHJ1ZSkge1xuICAgICAgICBsZXQgZW50aXR5ID0gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5FTlRJVFksIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyk7XG5cbiAgICAgICAgaWYgKGVudGl0eSAmJiBfLmlzRW1wdHkoZW50aXR5LmZpZWxkcykgJiYgXy5pc0VtcHR5KGVudGl0eS5pbmZvLmFzc29jaWF0aW9ucykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRW50aXR5IFwiJHtlbGVtZW50TmFtZX1cIiBoYXMgbm8gYW55IGZpZWxkcyBkZWZpbmVkLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG5cbiAgICBsb2FkVHlwZShyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcgPSB0cnVlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRFbGVtZW50KHJlZmVyZXJNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LlRZUEUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyk7XG4gICAgfVxuXG4gICAgbG9hZERhdGFzZXQocmVmZXJlck1vZHVsZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nID0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5EQVRBU0VULCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuICAgIH1cblxuICAgIGxvYWRWaWV3KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuVklFVywgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGFuIGVsZW1lbnQgYmFzZWQgb24gdGhlIG5hbWVzcGFjZSBjaGFpbi5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVmZXJlck1vZHVsZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudFR5cGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnROYW1lIFxuICAgICAqL1xuICAgIGxvYWRFbGVtZW50KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnRUeXBlLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpIHtcbiAgICAgICAgLy8gdGhlIGVsZW1lbnQgaWQgd2l0aCB0eXBlLCBzaG91bGQgYmUgdW5pcXVlIGFtb25nIHRoZSB3aG9sZSBzY2hlbWFcbiAgICAgICAgbGV0IHVuaXF1ZUlkID0gdGhpcy5nZXRFbGVtZW50VW5pcXVlSWQocmVmZXJlck1vZHVsZSwgZWxlbWVudFR5cGUsIGVsZW1lbnROYW1lKTtcblxuICAgICAgICAvLyB0aGUgZWxlbWVudCBpZCArIHJlZmVyZXJcbiAgICAgICAgaWYgKHVuaXF1ZUlkIGluIHRoaXMuX2VsZW1lbnRzQ2FjaGUpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGVtZW50c0NhY2hlW3VuaXF1ZUlkXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0YXJnZXRNb2R1bGU7ICAgICAgICBcblxuICAgICAgICBpZiAoZWxlbWVudFR5cGUgaW4gcmVmZXJlck1vZHVsZSAmJiBlbGVtZW50TmFtZSBpbiByZWZlcmVyTW9kdWxlW2VsZW1lbnRUeXBlXSkge1xuICAgICAgICAgICAgLy8gc2VlIGlmIGl0IGV4aXN0cyBpbiB0aGUgc2FtZSBtb2R1bGUgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHRhcmdldE1vZHVsZSA9IHJlZmVyZXJNb2R1bGU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBzZWFyY2ggcmV2ZXJzZWx5IGJ5IHRoZSBuYW1lc3BhY2VzXG4gICAgICAgICAgICAvL3RoaXMubG9nKCd2ZXJib3NlJywgYFNlYXJjaGluZyAke2VsZW1lbnRUeXBlfSBcIiR7ZWxlbWVudE5hbWV9XCIgZnJvbSBcIiR7cmVmZXJlck1vZHVsZS5pZH1cIiAuLi5gKTtcblxuICAgICAgICAgICAgbGV0IGluZGV4ID0gXy5maW5kTGFzdEluZGV4KHJlZmVyZXJNb2R1bGUubmFtZXNwYWNlLCBtb2R1bGVQYXRoID0+IHtcbiAgICAgICAgICAgICAgICAvL3RoaXMubG9nKCdkZWJ1ZycsIGBMb29raW5nIGZvciAke2VsZW1lbnRUeXBlfSBcIiR7ZWxlbWVudE5hbWV9XCIgaW4gXCIke21vZHVsZVBhdGh9XCIgLi4uYCk7XG5cbiAgICAgICAgICAgICAgICB0YXJnZXRNb2R1bGUgPSB0aGlzLmxvYWRNb2R1bGUobW9kdWxlUGF0aCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0TW9kdWxlICYmIHRhcmdldE1vZHVsZVtlbGVtZW50VHlwZV0gJiYgKGVsZW1lbnROYW1lIGluIHRhcmdldE1vZHVsZVtlbGVtZW50VHlwZV0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsgICBcbiAgICAgICAgICAgICAgICBpZiAodGhyb3dPbk1pc3NpbmcpIHsgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtlbGVtZW50VHlwZX0gXCIke2VsZW1lbnROYW1lfVwiIG5vdCBmb3VuZCBpbiBpbXBvcnRlZCBuYW1lc3BhY2VzLiBSZWZlcmVyOiAke3JlZmVyZXJNb2R1bGUuaWR9YCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBlbGVtZW50U2VsZklkID0gZWxlbWVudFR5cGUgKyAnOicgKyBlbGVtZW50TmFtZSArICdAJyArIHRhcmdldE1vZHVsZS5pZDtcbiAgICAgICAgaWYgKGVsZW1lbnRTZWxmSWQgaW4gdGhpcy5fZWxlbWVudHNDYWNoZSkge1xuICAgICAgICAgICAgLy8gYWxyZWFkeSBpbml0aWFsaXplZCAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuICh0aGlzLl9lbGVtZW50c0NhY2hlW3VuaXF1ZUlkXSA9IHRoaXMuX2VsZW1lbnRzQ2FjaGVbZWxlbWVudFNlbGZJZF0pO1xuICAgICAgICB9XG4gICAgICAgXG4gICAgICAgIHRoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZC5zZXQodW5pcXVlSWQsIHRhcmdldE1vZHVsZS5pZCk7XG5cbiAgICAgICAgLy8gcmV0cmlldmUgdGhlIGNvbXBpbGVkIGluZm9cbiAgICAgICAgbGV0IGVsZW1lbnRJbmZvID0gdGFyZ2V0TW9kdWxlW2VsZW1lbnRUeXBlXVtlbGVtZW50TmFtZV07XG4gICAgICAgIGxldCBlbGVtZW50O1xuXG4gICAgICAgIGlmIChlbGVtZW50VHlwZSBpbiBFTEVNRU5UX0NMQVNTX01BUCkge1xuICAgICAgICAgICAgLy8gZWxlbWVudCBuZWVkIGxpbmtpbmdcbiAgICAgICAgICAgIGxldCBFbGVtZW50Q2xhc3MgPSBFTEVNRU5UX0NMQVNTX01BUFtlbGVtZW50VHlwZV07XG4gICAgICAgICAgICBlbGVtZW50ID0gbmV3IEVsZW1lbnRDbGFzcyh0aGlzLCBlbGVtZW50TmFtZSwgdGFyZ2V0TW9kdWxlLCBPYmplY3QuZnJlZXplKGVsZW1lbnRJbmZvKSk7ICAgXG4gICAgICAgICAgICBlbGVtZW50LmxpbmsoKTsgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gR2VtbFR5cGVzLkVsZW1lbnQuVFlQRSkge1xuICAgICAgICAgICAgICAgIGVsZW1lbnRJbmZvLmdlbWxNb2R1bGUgPSB0YXJnZXRNb2R1bGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGVsZW1lbnQgPSBPYmplY3QuZnJlZXplKGVsZW1lbnRJbmZvKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2VsZW1lbnRzQ2FjaGVbZWxlbWVudFNlbGZJZF0gPSBlbGVtZW50O1xuICAgICAgICB0aGlzLl9lbGVtZW50c0NhY2hlW3VuaXF1ZUlkXSA9IGVsZW1lbnQ7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICB9XG5cbiAgICBfY29tcGlsZShvb2xGaWxlKSB7XG4gICAgICAgIGxldCBqc0ZpbGU7XG4gICAgICAgIFxuICAgICAgICBpZiAob29sRmlsZS5lbmRzV2l0aCgnLmpzb24nKSkge1xuICAgICAgICAgICAganNGaWxlID0gb29sRmlsZTtcbiAgICAgICAgICAgIG9vbEZpbGUgPSBvb2xGaWxlLnN1YnN0cigwLCBvb2xGaWxlLmxlbmd0aCAtIDUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAganNGaWxlID0gb29sRmlsZSArICcuanNvbic7XG4gICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBsZXQgb29sLCBzZWFyY2hFeHQ7XG5cbiAgICAgICAgaWYgKHRoaXMudXNlSnNvblNvdXJjZSkge1xuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGpzRmlsZSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFwidXNlSnNvblNvdXJjZVwiIGVuYWJlbGQgYnV0IGpzb24gZmlsZSBcIiR7anNGaWxlfVwiIG5vdCBmb3VuZC5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgb29sID0gZnMucmVhZEpzb25TeW5jKGpzRmlsZSk7XG4gICAgICAgICAgICBzZWFyY2hFeHQgPSBHRU1MX1NPVVJDRV9FWFQgKyAnLmpzb24nO1xuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAvL3RoaXMubG9nKCdkZWJ1ZycsICdDb21waWxpbmcgJyArIG9vbEZpbGUgKyAnIC4uLicpOyAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgb29sID0gT29sb25nUGFyc2VyLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhvb2xGaWxlLCAndXRmOCcpKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY29tcGlsZSBcIiR7IG9vbEZpbGUgfVwiLlxcbiR7IGVycm9yLm1lc3NhZ2UgfHwgZXJyb3IgfWApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghb29sKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVycm9yIG9jY3VycmVkIHdoaWxlIGNvbXBpbGluZy4nKTtcbiAgICAgICAgICAgIH0gICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHNlYXJjaEV4dCA9IEdFTUxfU09VUkNFX0VYVDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBiYXNlTmFtZSA9IHBhdGguYmFzZW5hbWUob29sRmlsZSwgR0VNTF9TT1VSQ0VfRVhUKTtcblxuICAgICAgICBsZXQgbmFtZXNwYWNlID0gW107XG5cbiAgICAgICAgbGV0IGN1cnJlbnRQYXRoID0gcGF0aC5kaXJuYW1lKG9vbEZpbGUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBcbiAgICAgICAgICogQHBhcmFtIHsqfSBuYW1lc3BhY2VzIC0gU2VhcmNoaW5nIHBhdGhcbiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5zIC0gSW1wb3J0IGxpbmVcbiAgICAgICAgICogQHBhcmFtIHsqfSByZWN1cnNpdmUgXG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiBleHBhbmROcyhuYW1lc3BhY2VzLCBucywgcmVjdXJzaXZlKSB7XG4gICAgICAgICAgICBsZXQgc3RhdHMgPSBmcy5zdGF0U3luYyhucyk7XG5cbiAgICAgICAgICAgIC8vaW1wb3J0ICcvcGF0aC91c2VyLm9vbCdcbiAgICAgICAgICAgIGlmIChzdGF0cy5pc0ZpbGUoKSAmJiBucy5lbmRzV2l0aChzZWFyY2hFeHQpKSB7XG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlcy5wdXNoKG5zKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpICYmIHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgICAgIC8vcmVzdXJzaXZlIGV4cGFuZCBzdWItZGlyZWN0b3J5XG4gICAgICAgICAgICAgICAgbGV0IGZpbGVzID0gZnMucmVhZGRpclN5bmMobnMpO1xuICAgICAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZiA9PiBleHBhbmROcyhuYW1lc3BhY2VzLCBwYXRoLmpvaW4obnMsIGYpLCB0cnVlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob29sLm5hbWVzcGFjZSkge1xuICAgICAgICAgICAgb29sLm5hbWVzcGFjZS5mb3JFYWNoKG5zID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAobnMuc3RhcnRzV2l0aCgnPGJ1aWx0aW5zPi8nKSkge1xuICAgICAgICAgICAgICAgICAgICBucyA9IHBhdGguam9pbihCVUlMVElOU19QQVRILCBucy5zdWJzdHIoMTEpKTsgICBcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5zLnN0YXJ0c1dpdGgoJzxzb3VyY2U+LycpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5zID0gcGF0aC5qb2luKHRoaXMuc291cmNlUGF0aCwgbnMuc3Vic3RyKDkpKTsgICBcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICBpZiAobnMuZW5kc1dpdGgoJy8qJykpIHtcbiAgICAgICAgICAgICAgICAgICAgcCA9IHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgbnMuc3Vic3RyKDAsIG5zLmxlbmd0aCAtIDIpKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVzID0gZnMucmVhZGRpclN5bmMocCk7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZiA9PiBleHBhbmROcyhuYW1lc3BhY2UsIHBhdGguam9pbihwLCBmKSwgZmFsc2UpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5zLmVuZHNXaXRoKCcvKionKSkge1xuICAgICAgICAgICAgICAgICAgICBwID0gcGF0aC5yZXNvbHZlKGN1cnJlbnRQYXRoLCBucy5zdWJzdHIoMCwgbnMubGVuZ3RoIC0gMykpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhwKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsZXMuZm9yRWFjaChmID0+IGV4cGFuZE5zKG5hbWVzcGFjZSwgcGF0aC5qb2luKHAsIGYpLCB0cnVlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlLnB1c2gocGF0aC5yZXNvbHZlKGN1cnJlbnRQYXRoLCBfLmVuZHNXaXRoKG5zLCBHRU1MX1NPVVJDRV9FWFQpID8gbnMgOiBucyArIEdFTUxfU09VUkNFX0VYVCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgb29sLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTtcblxuICAgICAgICBvb2wuaWQgPSB0aGlzLmdldE1vZHVsZUlkQnlQYXRoKG9vbEZpbGUpOyAgICAgICAgXG4gICAgICAgIG9vbC5uYW1lID0gYmFzZU5hbWU7ICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKCF0aGlzLnVzZUpzb25Tb3VyY2UgJiYgdGhpcy5zYXZlSW50ZXJtZWRpYXRlKSB7ICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoanNGaWxlLCBKU09OLnN0cmluZ2lmeShvb2wsIG51bGwsIDQpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvb2w7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IExpbmtlcjsiXX0=
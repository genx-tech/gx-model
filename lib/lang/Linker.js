"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob
} = require('rk-utils');

const {
  Types
} = require('@genx/data');

const Oolong = require('./grammar/geml');

const OolongParser = Oolong.parser;

const GemlTypes = require('./GemlTypes');

const Entity = require('./Entity');

const Schema = require('./Schema');

const View = require('./View');

const Dataset = require('./Dataset');

const deepFreeze = require('deep-freeze');

const ELEMENT_CLASS_MAP = {
  [GemlTypes.Element.ENTITY]: Entity,
  [GemlTypes.Element.VIEW]: View,
  [GemlTypes.Element.DATASET]: Dataset
};
const GEML_SOURCE_EXT = '.geml';
const BUILTINS_PATH = path.resolve(__dirname, 'builtins');

class Linker {
  static getGemlFiles(sourceDir, useJsonSource, recursive) {
    let pattern = '*' + GEML_SOURCE_EXT;

    if (useJsonSource) {
      pattern += '.json';
    }

    if (recursive) {
      pattern = '**/' + pattern;
    }

    return glob.sync(path.join(sourceDir, pattern), {
      nodir: true
    });
  }

  constructor(app, context) {
    this.app = app;
    this.sourcePath = context.gemlPath;
    this.useJsonSource = context.useJsonSource;
    this.saveIntermediate = context.saveIntermediate;
    this.schemaDeployment = context.schemas;
    this.schemas = {};
    this._gemlModules = {};
    this._elementsCache = {};
    this._mapOfReferenceToModuleId = new Map();
  }

  log(...args) {
    this.app.log(...args);
  }

  isModuleLoaded(moduleId) {
    return moduleId in this._gemlModules;
  }

  getModuleById(moduleId) {
    return this._gemlModules[moduleId];
  }

  link(entryFileName) {
    let entryModule = this.loadModule(entryFileName);

    if (!entryModule) {
      throw new Error(`Cannot resolve file "${entryFileName}".`);
    }

    if (_.isEmpty(entryModule.schema)) {
      throw new Error('No schema defined in entry file.');
    }

    _.forOwn(entryModule.schema, (schemaInfo, schemaName) => {
      let deploymentSettings = this.schemaDeployment[schemaName];
      let schema = new Schema(this, schemaName, entryModule, schemaInfo, deploymentSettings);
      schema.link();

      if (this.schemas.hasOwnProperty(schemaName)) {
        throw new Error(`Duplicate schema: "${schemaName}".`);
      }

      this.schemas[schemaName] = schema;

      if (this.saveIntermediate) {
        let jsFile = path.resolve(this.sourcePath, entryFileName + '-linked.json');
        fs.writeFileSync(jsFile, JSON.stringify(schema.toJSON(), null, 4));
      }
    });
  }

  loadModule(modulePath) {
    modulePath = path.resolve(this.sourcePath, modulePath);
    let id = this.getModuleIdByPath(modulePath);

    if (this.isModuleLoaded(id)) {
      return this.getModuleById(id);
    }

    if (!fs.existsSync(modulePath)) {
      return undefined;
    }

    let gemlModule = this._compile(modulePath);

    return this._gemlModules[id] = gemlModule;
  }

  trackBackType(gemlModule, info) {
    if (Types.Builtin.has(info.type)) {
      return info;
    }

    let baseInfo = this.loadElement(gemlModule, GemlTypes.Element.TYPE, info.type, true);

    if (!Types.Builtin.has(baseInfo.type)) {
      let ownerModule = baseInfo.gemlModule;
      let rootTypeInfo = this.trackBackType(ownerModule, baseInfo);
      ownerModule.type[baseInfo.type] = rootTypeInfo;
      baseInfo = rootTypeInfo;
    }

    let derivedInfo = { ..._.cloneDeep(_.omit(baseInfo, ['gemlModule', 'modifiers'])),
      ..._.omit(info, ['gemlModule', 'type', 'modifiers'])
    };

    if (baseInfo.modifiers || info.modifiers) {
      derivedInfo.modifiers = [...(baseInfo.modifiers || []), ...(info.modifiers || [])];
    }

    if (!derivedInfo.subClass) {
      derivedInfo.subClass = [];
    }

    derivedInfo.subClass.push(info.type);
    return derivedInfo;
  }

  translateOolValue(gemlModule, value) {
    if (_.isPlainObject(value)) {
      if (value.oolType === GemlTypes.Lang.CONST_REF) {
        let refedValue = this.loadElement(gemlModule, GemlTypes.Element.CONST, value.name, true);
        let uniqueId = this.getElementUniqueId(gemlModule, GemlTypes.Element.CONST, value.name);
        let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
        return this.translateOolValue(ownerModule, refedValue);
      } else if (value.oolType) {
        throw new Error(`todo: translateOolValue with type: ${value.oolType}`);
      }

      return _.mapValues(value, v => this.translateOolValue(gemlModule, v));
    }

    if (Array.isArray(value)) {
      return value.map(v => this.translateOolValue(gemlModule, v));
    }

    return value;
  }

  getModuleIdByPath(modulePath) {
    let isBuiltinEntity = _.startsWith(modulePath, BUILTINS_PATH);

    return isBuiltinEntity ? path.relative(BUILTINS_PATH, modulePath) : './' + path.relative(this.sourcePath, modulePath);
  }

  getElementUniqueId(refererModule, elementType, elementName) {
    return elementType + ':' + elementName + '<-' + refererModule.id;
  }

  loadEntity(refererModule, elementName, throwOnMissing = true) {
    let entity = this.loadElement(refererModule, GemlTypes.Element.ENTITY, elementName, throwOnMissing);

    if (entity && _.isEmpty(entity.fields) && _.isEmpty(entity.info.associations)) {
      throw new Error(`Entity "${elementName}" has no any fields defined.`);
    }

    return entity;
  }

  loadType(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.TYPE, elementName, throwOnMissing);
  }

  loadDataset(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.DATASET, elementName, throwOnMissing);
  }

  loadView(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.VIEW, elementName, throwOnMissing);
  }

  loadElement(refererModule, elementType, elementName, throwOnMissing) {
    let uniqueId = this.getElementUniqueId(refererModule, elementType, elementName);

    if (uniqueId in this._elementsCache) {
      return this._elementsCache[uniqueId];
    }

    let targetModule;

    if (elementType in refererModule && elementName in refererModule[elementType]) {
      targetModule = refererModule;
    } else {
      let index = _.findLastIndex(refererModule.namespace, modulePath => {
        targetModule = this.loadModule(modulePath);
        return targetModule && targetModule[elementType] && elementName in targetModule[elementType];
      });

      if (index === -1) {
        if (throwOnMissing) {
          throw new Error(`${elementType} "${elementName}" not found in imported namespaces. Referer: ${refererModule.id}`);
        }

        return undefined;
      }
    }

    let elementSelfId = elementType + ':' + elementName + '@' + targetModule.id;

    if (elementSelfId in this._elementsCache) {
      return this._elementsCache[uniqueId] = this._elementsCache[elementSelfId];
    }

    this._mapOfReferenceToModuleId.set(uniqueId, targetModule.id);

    let elementInfo = targetModule[elementType][elementName];
    let element;

    if (elementType in ELEMENT_CLASS_MAP) {
      let ElementClass = ELEMENT_CLASS_MAP[elementType];
      element = new ElementClass(this, elementName, targetModule, elementInfo);
      element.link();
    } else {
      if (elementType === GemlTypes.Element.TYPE) {
        element = { ...elementInfo,
          gemlModule: targetModule
        };
      } else {
        element = elementInfo;
      }
    }

    this._elementsCache[elementSelfId] = element;
    this._elementsCache[uniqueId] = element;
    return element;
  }

  _compile(oolFile) {
    let jsFile;

    if (oolFile.endsWith('.json')) {
      jsFile = oolFile;
      oolFile = oolFile.substr(0, oolFile.length - 5);
    } else {
      jsFile = oolFile + '.json';
    }

    let ool, searchExt;

    if (this.useJsonSource) {
      if (!fs.existsSync(jsFile)) {
        throw new Error(`"useJsonSource" enabeld but json file "${jsFile}" not found.`);
      }

      ool = fs.readJsonSync(jsFile);
      searchExt = GEML_SOURCE_EXT + '.json';
    } else {
      try {
        ool = OolongParser.parse(fs.readFileSync(oolFile, 'utf8'));
      } catch (error) {
        throw error;
      }

      if (!ool) {
        throw new Error('Unknown error occurred while compiling.');
      }

      searchExt = GEML_SOURCE_EXT;
    }

    let baseName = path.basename(oolFile, GEML_SOURCE_EXT);
    let namespace = [];
    let currentPath = path.dirname(oolFile);

    function expandNs(namespaces, ns, recursive) {
      let stats = fs.statSync(ns);

      if (stats.isFile() && ns.endsWith(searchExt)) {
        namespaces.push(ns);
        return;
      }

      if (stats.isDirectory() && recursive) {
        let files = fs.readdirSync(ns);
        files.forEach(f => expandNs(namespaces, path.join(ns, f), true));
      }
    }

    if (ool.namespace) {
      ool.namespace.forEach(ns => {
        let p;

        if (ns.startsWith('<builtins>/')) {
          ns = path.join(BUILTINS_PATH, ns.substr(11));
        } else if (ns.startsWith('<source>/')) {
          ns = path.join(this.sourcePath, ns.substr(9));
        }

        if (ns.endsWith('/*')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 2));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), false));
        } else if (ns.endsWith('/**')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 3));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), true));
        } else {
          namespace.push(path.resolve(currentPath, _.endsWith(ns, GEML_SOURCE_EXT) ? ns : ns + GEML_SOURCE_EXT));
        }
      });
    }

    ool.namespace = namespace;
    ool.id = this.getModuleIdByPath(oolFile);
    ool.name = baseName;

    if (!this.useJsonSource && this.saveIntermediate) {
      fs.writeFileSync(jsFile, JSON.stringify(ool, null, 4));
    }

    return ool;
  }

}

module.exports = Linker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0xpbmtlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJUeXBlcyIsIk9vbG9uZyIsIk9vbG9uZ1BhcnNlciIsInBhcnNlciIsIkdlbWxUeXBlcyIsIkVudGl0eSIsIlNjaGVtYSIsIlZpZXciLCJEYXRhc2V0IiwiZGVlcEZyZWV6ZSIsIkVMRU1FTlRfQ0xBU1NfTUFQIiwiRWxlbWVudCIsIkVOVElUWSIsIlZJRVciLCJEQVRBU0VUIiwiR0VNTF9TT1VSQ0VfRVhUIiwiQlVJTFRJTlNfUEFUSCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJMaW5rZXIiLCJnZXRHZW1sRmlsZXMiLCJzb3VyY2VEaXIiLCJ1c2VKc29uU291cmNlIiwicmVjdXJzaXZlIiwicGF0dGVybiIsInN5bmMiLCJqb2luIiwibm9kaXIiLCJjb25zdHJ1Y3RvciIsImFwcCIsImNvbnRleHQiLCJzb3VyY2VQYXRoIiwiZ2VtbFBhdGgiLCJzYXZlSW50ZXJtZWRpYXRlIiwic2NoZW1hRGVwbG95bWVudCIsInNjaGVtYXMiLCJfZ2VtbE1vZHVsZXMiLCJfZWxlbWVudHNDYWNoZSIsIl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQiLCJNYXAiLCJsb2ciLCJhcmdzIiwiaXNNb2R1bGVMb2FkZWQiLCJtb2R1bGVJZCIsImdldE1vZHVsZUJ5SWQiLCJsaW5rIiwiZW50cnlGaWxlTmFtZSIsImVudHJ5TW9kdWxlIiwibG9hZE1vZHVsZSIsIkVycm9yIiwiaXNFbXB0eSIsInNjaGVtYSIsImZvck93biIsInNjaGVtYUluZm8iLCJzY2hlbWFOYW1lIiwiZGVwbG95bWVudFNldHRpbmdzIiwiaGFzT3duUHJvcGVydHkiLCJqc0ZpbGUiLCJ3cml0ZUZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsInRvSlNPTiIsIm1vZHVsZVBhdGgiLCJpZCIsImdldE1vZHVsZUlkQnlQYXRoIiwiZXhpc3RzU3luYyIsInVuZGVmaW5lZCIsImdlbWxNb2R1bGUiLCJfY29tcGlsZSIsInRyYWNrQmFja1R5cGUiLCJpbmZvIiwiQnVpbHRpbiIsImhhcyIsInR5cGUiLCJiYXNlSW5mbyIsImxvYWRFbGVtZW50IiwiVFlQRSIsIm93bmVyTW9kdWxlIiwicm9vdFR5cGVJbmZvIiwiZGVyaXZlZEluZm8iLCJjbG9uZURlZXAiLCJvbWl0IiwibW9kaWZpZXJzIiwic3ViQ2xhc3MiLCJwdXNoIiwidHJhbnNsYXRlT29sVmFsdWUiLCJ2YWx1ZSIsImlzUGxhaW5PYmplY3QiLCJvb2xUeXBlIiwiTGFuZyIsIkNPTlNUX1JFRiIsInJlZmVkVmFsdWUiLCJDT05TVCIsIm5hbWUiLCJ1bmlxdWVJZCIsImdldEVsZW1lbnRVbmlxdWVJZCIsImdldCIsIm1hcFZhbHVlcyIsInYiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJpc0J1aWx0aW5FbnRpdHkiLCJzdGFydHNXaXRoIiwicmVsYXRpdmUiLCJyZWZlcmVyTW9kdWxlIiwiZWxlbWVudFR5cGUiLCJlbGVtZW50TmFtZSIsImxvYWRFbnRpdHkiLCJ0aHJvd09uTWlzc2luZyIsImVudGl0eSIsImZpZWxkcyIsImFzc29jaWF0aW9ucyIsImxvYWRUeXBlIiwibG9hZERhdGFzZXQiLCJsb2FkVmlldyIsInRhcmdldE1vZHVsZSIsImluZGV4IiwiZmluZExhc3RJbmRleCIsIm5hbWVzcGFjZSIsImVsZW1lbnRTZWxmSWQiLCJzZXQiLCJlbGVtZW50SW5mbyIsImVsZW1lbnQiLCJFbGVtZW50Q2xhc3MiLCJvb2xGaWxlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJvb2wiLCJzZWFyY2hFeHQiLCJyZWFkSnNvblN5bmMiLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsImVycm9yIiwiYmFzZU5hbWUiLCJiYXNlbmFtZSIsImN1cnJlbnRQYXRoIiwiZGlybmFtZSIsImV4cGFuZE5zIiwibmFtZXNwYWNlcyIsIm5zIiwic3RhdHMiLCJzdGF0U3luYyIsImlzRmlsZSIsImlzRGlyZWN0b3J5IiwiZmlsZXMiLCJyZWFkZGly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Y29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IFR5cGVzIH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJyk7XG5cbmNvbnN0IE9vbG9uZyA9IHJlcXVpcmUoJy4vZ3JhbW1hci9nZW1sJyk7XG5jb25zdCBPb2xvbmdQYXJzZXIgPSBPb2xvbmcucGFyc2VyO1xuY29uc3QgR2VtbFR5cGVzID0gcmVxdWlyZSgnLi9HZW1sVHlwZXMnKTtcbmNvbnN0IEVudGl0eSA9IHJlcXVpcmUoJy4vRW50aXR5Jyk7XG5jb25zdCBTY2hlbWEgPSByZXF1aXJlKCcuL1NjaGVtYScpO1xuY29uc3QgVmlldyA9IHJlcXVpcmUoJy4vVmlldycpO1xuY29uc3QgRGF0YXNldCA9IHJlcXVpcmUoJy4vRGF0YXNldCcpO1xuY29uc3QgZGVlcEZyZWV6ZSA9IHJlcXVpcmUoJ2RlZXAtZnJlZXplJyk7XG5cbmNvbnN0IEVMRU1FTlRfQ0xBU1NfTUFQID0ge1xuICAgIFtHZW1sVHlwZXMuRWxlbWVudC5FTlRJVFldOiBFbnRpdHksXG4gICAgW0dlbWxUeXBlcy5FbGVtZW50LlZJRVddOiBWaWV3LFxuICAgIFtHZW1sVHlwZXMuRWxlbWVudC5EQVRBU0VUXTogRGF0YXNldCxcbn07XG5cbmNvbnN0IEdFTUxfU09VUkNFX0VYVCA9ICcuZ2VtbCc7XG5jb25zdCBCVUlMVElOU19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2J1aWx0aW5zJyk7XG5cbi8qKlxuICogTGlua2VyIG9mIGdlbWxcbiAqIEBjbGFzcyBHZW1sTGlua2VyXG4gKi9cbmNsYXNzIExpbmtlciB7XG4gICAgc3RhdGljIGdldEdlbWxGaWxlcyhzb3VyY2VEaXIsIHVzZUpzb25Tb3VyY2UsIHJlY3Vyc2l2ZSkge1xuICAgICAgICBsZXQgcGF0dGVybiA9ICcqJyArIEdFTUxfU09VUkNFX0VYVDtcblxuICAgICAgICBpZiAodXNlSnNvblNvdXJjZSkge1xuICAgICAgICAgICAgcGF0dGVybiArPSAnLmpzb24nO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgcGF0dGVybiA9ICcqKi8nICsgcGF0dGVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBnbG9iLnN5bmMocGF0aC5qb2luKHNvdXJjZURpciwgcGF0dGVybiksIHtub2RpcjogdHJ1ZX0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7U2VydmljZUNvbnRhaW5lcn0gYXBwIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuZ2VtbFBhdGggLSBHZW1sIHNvdXJjZSBmaWxlcyBwYXRoICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb250ZXh0LnVzZUpzb25Tb3VyY2U9ZmFsc2VdIC0gVXNlIC5qc29uIGludGVybWVkaWF0ZSBzb3VyY2UgZmlsZSBpbnN0ZWFkIG9mIC5vb2xcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb250ZXh0LnNhdmVJbnRlcm1lZGlhdGU9ZmFsc2VdIC0gU2F2ZSBpbnRlcm1lZGlhdGUgc291cmNlIGZpbGUgd2hpbGUgbGlua2luZ1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGFwcCwgY29udGV4dCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogQXBwXG4gICAgICAgICAqIEBtZW1iZXIge1NlcnZpY2VDb250YWluZXJ9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogR2VtbCBzb3VyY2UgZmlsZXMgcGF0aFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNvdXJjZVBhdGggPSBjb250ZXh0LmdlbWxQYXRoO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBVc2UganNvbiBvciBvbHNcbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMudXNlSnNvblNvdXJjZSA9IGNvbnRleHQudXNlSnNvblNvdXJjZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogU2F2ZSBpbnRlcm1lZGlhdGUgZmlsZXNcbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2F2ZUludGVybWVkaWF0ZSA9IGNvbnRleHQuc2F2ZUludGVybWVkaWF0ZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogU2NoZW1hIGRlcGxveW1lbnQgc2V0dGluZ3NcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zY2hlbWFEZXBsb3ltZW50ID0gY29udGV4dC5zY2hlbWFzO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMaW5rZWQgc2NoZW1hc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgU2NoZW1hPn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2NoZW1hcyA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBQYXJzZWQgb29sb25nIGZpbGVzLCBwYXRoID0+IG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9nZW1sTW9kdWxlcyA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFbGVtZW50IGNhY2hlLCBtYXAgb2YgPHJlZmVyZW5jZUlkLCBlbGVtZW50PiBhbmQgPHNlbGZJZCwgZWxlbWVudD5cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSBcbiAgICAgICAgICogQHByaXZhdGVcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2VsZW1lbnRzQ2FjaGUgPSB7fTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTWFwIG9mIDxyZWZlcmVuY2VJZCwgbW9kdWxlSWQ+XG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICogQHByaXZhdGVcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZCA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXcml0ZSBsb2dcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGV2ZWxcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbZGF0YV1cbiAgICAgKi9cbiAgICBsb2coLi4uYXJncykge1xuICAgICAgICB0aGlzLmFwcC5sb2coLi4uYXJncyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIG1vZHVsZSBpcyBsb2FkZWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlSWRcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBpc01vZHVsZUxvYWRlZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gKG1vZHVsZUlkIGluIHRoaXMuX2dlbWxNb2R1bGVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBsb2FkZWQgb29sb25lIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVJZFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0TW9kdWxlQnlJZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2VtbE1vZHVsZXNbbW9kdWxlSWRdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgb29sb25nIGZpbGVzXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVudHJ5RmlsZU5hbWVcbiAgICAgKi9cbiAgICBsaW5rKGVudHJ5RmlsZU5hbWUpIHtcbiAgICAgICAgLy9jb21waWxlIGVudHJ5IGZpbGUgICAgICAgIFxuICAgICAgICBsZXQgZW50cnlNb2R1bGUgPSB0aGlzLmxvYWRNb2R1bGUoZW50cnlGaWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFlbnRyeU1vZHVsZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcmVzb2x2ZSBmaWxlIFwiJHtlbnRyeUZpbGVOYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKF8uaXNFbXB0eShlbnRyeU1vZHVsZS5zY2hlbWEpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNjaGVtYSBkZWZpbmVkIGluIGVudHJ5IGZpbGUuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBfLmZvck93bihlbnRyeU1vZHVsZS5zY2hlbWEsIChzY2hlbWFJbmZvLCBzY2hlbWFOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgZGVwbG95bWVudFNldHRpbmdzID0gdGhpcy5zY2hlbWFEZXBsb3ltZW50W3NjaGVtYU5hbWVdO1xuICAgICAgICAgICAgLy9hc3NlcnQ6IGRlcGxveW1lbnRTZXR0aW5ncywgYFwiZGVwbG95bWVudFNldHRpbmdzXCIgb2Ygc2NoZW1hIFske3NjaGVtYU5hbWV9XSBub3QgZm91bmQuYDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHNjaGVtYSA9IG5ldyBTY2hlbWEodGhpcywgc2NoZW1hTmFtZSwgZW50cnlNb2R1bGUsIHNjaGVtYUluZm8sIGRlcGxveW1lbnRTZXR0aW5ncyk7XG4gICAgICAgICAgICBzY2hlbWEubGluaygpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zY2hlbWFzLmhhc093blByb3BlcnR5KHNjaGVtYU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgc2NoZW1hOiBcIiR7c2NoZW1hTmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2NoZW1hc1tzY2hlbWFOYW1lXSA9IHNjaGVtYTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuc2F2ZUludGVybWVkaWF0ZSkge1xuICAgICAgICAgICAgICAgIGxldCBqc0ZpbGUgPSBwYXRoLnJlc29sdmUodGhpcy5zb3VyY2VQYXRoLCBlbnRyeUZpbGVOYW1lICsgJy1saW5rZWQuanNvbicpO1xuICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoanNGaWxlLCBKU09OLnN0cmluZ2lmeShzY2hlbWEudG9KU09OKCksIG51bGwsIDQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGEgb29sb25nIG1vZHVsZSwgcmV0dXJuIHVuZGVmaW5lZCBpZiBub3QgZXhpc3RcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlUGF0aFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIGxvYWRNb2R1bGUobW9kdWxlUGF0aCkgeyAgICAgICAgXG4gICAgICAgIG1vZHVsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5zb3VyY2VQYXRoLCBtb2R1bGVQYXRoKTtcblxuICAgICAgICBsZXQgaWQgPSB0aGlzLmdldE1vZHVsZUlkQnlQYXRoKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzTW9kdWxlTG9hZGVkKGlkKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kdWxlQnlJZChpZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMobW9kdWxlUGF0aCkpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgbGV0IGdlbWxNb2R1bGUgPSB0aGlzLl9jb21waWxlKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIHJldHVybiAodGhpcy5fZ2VtbE1vZHVsZXNbaWRdID0gZ2VtbE1vZHVsZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhY2sgYmFjayB0aGUgdHlwZSBkZXJpdmVkIGNoYWluLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBnZW1sTW9kdWxlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGluZm9cbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHRyYWNrQmFja1R5cGUoZ2VtbE1vZHVsZSwgaW5mbykge1xuICAgICAgICBpZiAoVHlwZXMuQnVpbHRpbi5oYXMoaW5mby50eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGluZm87XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYmFzZUluZm8gPSB0aGlzLmxvYWRFbGVtZW50KGdlbWxNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LlRZUEUsIGluZm8udHlwZSwgdHJ1ZSk7XG5cbiAgICAgICAgaWYgKCFUeXBlcy5CdWlsdGluLmhhcyhiYXNlSW5mby50eXBlKSkge1xuICAgICAgICAgICAgLy90aGUgYmFzZSB0eXBlIGlzIG5vdCBhIGJ1aWx0aW4gdHlwZVxuICAgICAgICAgICAgbGV0IG93bmVyTW9kdWxlID0gYmFzZUluZm8uZ2VtbE1vZHVsZTsgIFxuXG4gICAgICAgICAgICBsZXQgcm9vdFR5cGVJbmZvID0gdGhpcy50cmFja0JhY2tUeXBlKG93bmVyTW9kdWxlLCBiYXNlSW5mbyk7XG4gICAgICAgICAgICBvd25lck1vZHVsZS50eXBlW2Jhc2VJbmZvLnR5cGVdID0gcm9vdFR5cGVJbmZvO1xuICAgICAgICAgICAgYmFzZUluZm8gPSByb290VHlwZUluZm87XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZGVyaXZlZEluZm8gPSB7IC4uLl8uY2xvbmVEZWVwKF8ub21pdChiYXNlSW5mbywgWydnZW1sTW9kdWxlJywgJ21vZGlmaWVycyddKSksIC4uLl8ub21pdChpbmZvLCBbJ2dlbWxNb2R1bGUnLCAndHlwZScsICdtb2RpZmllcnMnXSl9O1xuICAgICAgICBpZiAoYmFzZUluZm8ubW9kaWZpZXJzIHx8IGluZm8ubW9kaWZpZXJzKSB7XG4gICAgICAgICAgICBkZXJpdmVkSW5mby5tb2RpZmllcnMgPSBbIC4uLihiYXNlSW5mby5tb2RpZmllcnMgfHwgW10pLCAuLi4oaW5mby5tb2RpZmllcnMgfHwgW10pIF07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWRlcml2ZWRJbmZvLnN1YkNsYXNzKSB7XG4gICAgICAgICAgICBkZXJpdmVkSW5mby5zdWJDbGFzcyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGRlcml2ZWRJbmZvLnN1YkNsYXNzLnB1c2goaW5mby50eXBlKTtcbiAgICAgICAgcmV0dXJuIGRlcml2ZWRJbmZvO1xuICAgIH0gICAgXG4gICAgXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGFuIHZhbHVlIGJ5IGluZmVycmluZyBhbGwgdGhlIHJlZmVyZW5jZXMuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGdlbWxNb2R1bGUgXG4gICAgICogQHBhcmFtIHsqfSB2YWx1ZSBcbiAgICAgKiBAcmV0dXJucyB7Kn0gLSBUcmFuc2xhdGVkIHZhbHVlLlxuICAgICAqL1xuICAgIHRyYW5zbGF0ZU9vbFZhbHVlKGdlbWxNb2R1bGUsIHZhbHVlKSB7XG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QodmFsdWUpKSB7XG4gICAgICAgICAgICBpZiAodmFsdWUub29sVHlwZSA9PT0gR2VtbFR5cGVzLkxhbmcuQ09OU1RfUkVGKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCByZWZlZFZhbHVlID0gdGhpcy5sb2FkRWxlbWVudChnZW1sTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5DT05TVCwgdmFsdWUubmFtZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgbGV0IHVuaXF1ZUlkID0gdGhpcy5nZXRFbGVtZW50VW5pcXVlSWQoZ2VtbE1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuQ09OU1QsIHZhbHVlLm5hbWUpO1xuICAgICAgICAgICAgICAgIGxldCBvd25lck1vZHVsZSA9IHRoaXMuZ2V0TW9kdWxlQnlJZCh0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuZ2V0KHVuaXF1ZUlkKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT29sVmFsdWUob3duZXJNb2R1bGUsIHJlZmVkVmFsdWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5vb2xUeXBlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0b2RvOiB0cmFuc2xhdGVPb2xWYWx1ZSB3aXRoIHR5cGU6ICR7dmFsdWUub29sVHlwZX1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gXy5tYXBWYWx1ZXModmFsdWUsIHYgPT4gdGhpcy50cmFuc2xhdGVPb2xWYWx1ZShnZW1sTW9kdWxlLCB2KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5tYXAodiA9PiB0aGlzLnRyYW5zbGF0ZU9vbFZhbHVlKGdlbWxNb2R1bGUsIHYpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIHVuaXF1ZSBtb2R1bGUgaWQgYnkgc291cmNlIGZpbGUgcGF0aC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlUGF0aCAtIFRoZSBwYXRoIG9mIGFuIG9vbG9uZyBzb3VyY2UgZmlsZS5cbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIFRoZSBtb2R1bGUgaWQuXG4gICAgICovXG4gICAgZ2V0TW9kdWxlSWRCeVBhdGgobW9kdWxlUGF0aCkgeyAgICAgICAgXG4gICAgICAgIGxldCBpc0J1aWx0aW5FbnRpdHkgPSBfLnN0YXJ0c1dpdGgobW9kdWxlUGF0aCwgQlVJTFRJTlNfUEFUSCk7ICAgICAgXG4gICAgICAgIHJldHVybiBpc0J1aWx0aW5FbnRpdHkgPyBcbiAgICAgICAgICAgIHBhdGgucmVsYXRpdmUoQlVJTFRJTlNfUEFUSCwgbW9kdWxlUGF0aCkgOiBcbiAgICAgICAgICAgICcuLycgKyBwYXRoLnJlbGF0aXZlKHRoaXMuc291cmNlUGF0aCwgbW9kdWxlUGF0aCk7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIHVuaXF1ZSBuYW1lIG9mIGFuIGVsZW1lbnQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlZmVyZXJNb2R1bGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnRUeXBlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50TmFtZSBcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIFRoZSB1bmlxdWUgbmFtZSBvZiBhbiBlbGVtZW50LlxuICAgICAqL1xuICAgIGdldEVsZW1lbnRVbmlxdWVJZChyZWZlcmVyTW9kdWxlLCBlbGVtZW50VHlwZSwgZWxlbWVudE5hbWUpIHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlICsgJzonICsgZWxlbWVudE5hbWUgKyAnPC0nICsgcmVmZXJlck1vZHVsZS5pZDtcbiAgICB9XG5cbiAgICBsb2FkRW50aXR5KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuRU5USVRZLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuXG4gICAgICAgIGlmIChlbnRpdHkgJiYgXy5pc0VtcHR5KGVudGl0eS5maWVsZHMpICYmIF8uaXNFbXB0eShlbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVudGl0eSBcIiR7ZWxlbWVudE5hbWV9XCIgaGFzIG5vIGFueSBmaWVsZHMgZGVmaW5lZC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuXG4gICAgbG9hZFR5cGUocmVmZXJlck1vZHVsZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nID0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5UWVBFLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuICAgIH1cblxuICAgIGxvYWREYXRhc2V0KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuREFUQVNFVCwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKTtcbiAgICB9XG5cbiAgICBsb2FkVmlldyhyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcgPSB0cnVlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRFbGVtZW50KHJlZmVyZXJNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LlZJRVcsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhbiBlbGVtZW50IGJhc2VkIG9uIHRoZSBuYW1lc3BhY2UgY2hhaW4uXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlZmVyZXJNb2R1bGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnRUeXBlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50TmFtZSBcbiAgICAgKi9cbiAgICBsb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBlbGVtZW50VHlwZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKSB7XG4gICAgICAgIC8vIHRoZSBlbGVtZW50IGlkIHdpdGggdHlwZSwgc2hvdWxkIGJlIHVuaXF1ZSBhbW9uZyB0aGUgd2hvbGUgc2NoZW1hXG4gICAgICAgIGxldCB1bmlxdWVJZCA9IHRoaXMuZ2V0RWxlbWVudFVuaXF1ZUlkKHJlZmVyZXJNb2R1bGUsIGVsZW1lbnRUeXBlLCBlbGVtZW50TmFtZSk7XG5cbiAgICAgICAgLy8gdGhlIGVsZW1lbnQgaWQgKyByZWZlcmVyXG4gICAgICAgIGlmICh1bmlxdWVJZCBpbiB0aGlzLl9lbGVtZW50c0NhY2hlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdGFyZ2V0TW9kdWxlOyAgICAgICAgXG5cbiAgICAgICAgaWYgKGVsZW1lbnRUeXBlIGluIHJlZmVyZXJNb2R1bGUgJiYgZWxlbWVudE5hbWUgaW4gcmVmZXJlck1vZHVsZVtlbGVtZW50VHlwZV0pIHtcbiAgICAgICAgICAgIC8vIHNlZSBpZiBpdCBleGlzdHMgaW4gdGhlIHNhbWUgbW9kdWxlICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB0YXJnZXRNb2R1bGUgPSByZWZlcmVyTW9kdWxlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gc2VhcmNoIHJldmVyc2VseSBieSB0aGUgbmFtZXNwYWNlc1xuICAgICAgICAgICAgLy90aGlzLmxvZygndmVyYm9zZScsIGBTZWFyY2hpbmcgJHtlbGVtZW50VHlwZX0gXCIke2VsZW1lbnROYW1lfVwiIGZyb20gXCIke3JlZmVyZXJNb2R1bGUuaWR9XCIgLi4uYCk7XG5cbiAgICAgICAgICAgIGxldCBpbmRleCA9IF8uZmluZExhc3RJbmRleChyZWZlcmVyTW9kdWxlLm5hbWVzcGFjZSwgbW9kdWxlUGF0aCA9PiB7XG4gICAgICAgICAgICAgICAgLy90aGlzLmxvZygnZGVidWcnLCBgTG9va2luZyBmb3IgJHtlbGVtZW50VHlwZX0gXCIke2VsZW1lbnROYW1lfVwiIGluIFwiJHttb2R1bGVQYXRofVwiIC4uLmApO1xuXG4gICAgICAgICAgICAgICAgdGFyZ2V0TW9kdWxlID0gdGhpcy5sb2FkTW9kdWxlKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldE1vZHVsZSAmJiB0YXJnZXRNb2R1bGVbZWxlbWVudFR5cGVdICYmIChlbGVtZW50TmFtZSBpbiB0YXJnZXRNb2R1bGVbZWxlbWVudFR5cGVdKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7ICAgXG4gICAgICAgICAgICAgICAgaWYgKHRocm93T25NaXNzaW5nKSB7ICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZWxlbWVudFR5cGV9IFwiJHtlbGVtZW50TmFtZX1cIiBub3QgZm91bmQgaW4gaW1wb3J0ZWQgbmFtZXNwYWNlcy4gUmVmZXJlcjogJHtyZWZlcmVyTW9kdWxlLmlkfWApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZWxlbWVudFNlbGZJZCA9IGVsZW1lbnRUeXBlICsgJzonICsgZWxlbWVudE5hbWUgKyAnQCcgKyB0YXJnZXRNb2R1bGUuaWQ7XG4gICAgICAgIGlmIChlbGVtZW50U2VsZklkIGluIHRoaXMuX2VsZW1lbnRzQ2FjaGUpIHtcbiAgICAgICAgICAgIC8vIGFscmVhZHkgaW5pdGlhbGl6ZWQgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiAodGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF0gPSB0aGlzLl9lbGVtZW50c0NhY2hlW2VsZW1lbnRTZWxmSWRdKTtcbiAgICAgICAgfVxuICAgICAgIFxuICAgICAgICB0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuc2V0KHVuaXF1ZUlkLCB0YXJnZXRNb2R1bGUuaWQpO1xuXG4gICAgICAgIC8vIHJldHJpZXZlIHRoZSBjb21waWxlZCBpbmZvXG4gICAgICAgIGxldCBlbGVtZW50SW5mbyA9IHRhcmdldE1vZHVsZVtlbGVtZW50VHlwZV1bZWxlbWVudE5hbWVdO1xuICAgICAgICBsZXQgZWxlbWVudDtcblxuICAgICAgICBpZiAoZWxlbWVudFR5cGUgaW4gRUxFTUVOVF9DTEFTU19NQVApIHtcbiAgICAgICAgICAgIC8vIGVsZW1lbnQgbmVlZCBsaW5raW5nXG4gICAgICAgICAgICBsZXQgRWxlbWVudENsYXNzID0gRUxFTUVOVF9DTEFTU19NQVBbZWxlbWVudFR5cGVdOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBlbGVtZW50ID0gbmV3IEVsZW1lbnRDbGFzcyh0aGlzLCBlbGVtZW50TmFtZSwgdGFyZ2V0TW9kdWxlLCBlbGVtZW50SW5mbyk7ICAgXG4gICAgICAgICAgICBlbGVtZW50LmxpbmsoKTsgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gR2VtbFR5cGVzLkVsZW1lbnQuVFlQRSkge1xuICAgICAgICAgICAgICAgIGVsZW1lbnQgPSB7XG4gICAgICAgICAgICAgICAgICAgIC4uLmVsZW1lbnRJbmZvLFxuICAgICAgICAgICAgICAgICAgICBnZW1sTW9kdWxlOiB0YXJnZXRNb2R1bGVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudEluZm87XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9lbGVtZW50c0NhY2hlW2VsZW1lbnRTZWxmSWRdID0gZWxlbWVudDtcbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF0gPSBlbGVtZW50O1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgfVxuXG4gICAgX2NvbXBpbGUob29sRmlsZSkge1xuICAgICAgICBsZXQganNGaWxlO1xuICAgICAgICBcbiAgICAgICAgaWYgKG9vbEZpbGUuZW5kc1dpdGgoJy5qc29uJykpIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGU7XG4gICAgICAgICAgICBvb2xGaWxlID0gb29sRmlsZS5zdWJzdHIoMCwgb29sRmlsZS5sZW5ndGggLSA1KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGUgKyAnLmpzb24nO1xuICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IG9vbCwgc2VhcmNoRXh0O1xuXG4gICAgICAgIGlmICh0aGlzLnVzZUpzb25Tb3VyY2UpIHtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhqc0ZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcInVzZUpzb25Tb3VyY2VcIiBlbmFiZWxkIGJ1dCBqc29uIGZpbGUgXCIke2pzRmlsZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG9vbCA9IGZzLnJlYWRKc29uU3luYyhqc0ZpbGUpO1xuICAgICAgICAgICAgc2VhcmNoRXh0ID0gR0VNTF9TT1VSQ0VfRVhUICsgJy5qc29uJztcbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgLy90aGlzLmxvZygnZGVidWcnLCAnQ29tcGlsaW5nICcgKyBvb2xGaWxlICsgJyAuLi4nKTsgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG9vbCA9IE9vbG9uZ1BhcnNlci5wYXJzZShmcy5yZWFkRmlsZVN5bmMob29sRmlsZSwgJ3V0ZjgnKSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY29tcGlsZSBcIiR7IG9vbEZpbGUgfVwiLlxcbiR7IGVycm9yLm1lc3NhZ2UgfHwgZXJyb3IgfWApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghb29sKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVycm9yIG9jY3VycmVkIHdoaWxlIGNvbXBpbGluZy4nKTtcbiAgICAgICAgICAgIH0gICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHNlYXJjaEV4dCA9IEdFTUxfU09VUkNFX0VYVDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBiYXNlTmFtZSA9IHBhdGguYmFzZW5hbWUob29sRmlsZSwgR0VNTF9TT1VSQ0VfRVhUKTtcblxuICAgICAgICBsZXQgbmFtZXNwYWNlID0gW107XG5cbiAgICAgICAgbGV0IGN1cnJlbnRQYXRoID0gcGF0aC5kaXJuYW1lKG9vbEZpbGUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBcbiAgICAgICAgICogQHBhcmFtIHsqfSBuYW1lc3BhY2VzIC0gU2VhcmNoaW5nIHBhdGhcbiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5zIC0gSW1wb3J0IGxpbmVcbiAgICAgICAgICogQHBhcmFtIHsqfSByZWN1cnNpdmUgXG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiBleHBhbmROcyhuYW1lc3BhY2VzLCBucywgcmVjdXJzaXZlKSB7XG4gICAgICAgICAgICBsZXQgc3RhdHMgPSBmcy5zdGF0U3luYyhucyk7XG5cbiAgICAgICAgICAgIC8vaW1wb3J0ICcvcGF0aC91c2VyLm9vbCdcbiAgICAgICAgICAgIGlmIChzdGF0cy5pc0ZpbGUoKSAmJiBucy5lbmRzV2l0aChzZWFyY2hFeHQpKSB7XG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlcy5wdXNoKG5zKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpICYmIHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgICAgIC8vcmVzdXJzaXZlIGV4cGFuZCBzdWItZGlyZWN0b3J5XG4gICAgICAgICAgICAgICAgbGV0IGZpbGVzID0gZnMucmVhZGRpclN5bmMobnMpO1xuICAgICAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZiA9PiBleHBhbmROcyhuYW1lc3BhY2VzLCBwYXRoLmpvaW4obnMsIGYpLCB0cnVlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob29sLm5hbWVzcGFjZSkge1xuICAgICAgICAgICAgb29sLm5hbWVzcGFjZS5mb3JFYWNoKG5zID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAobnMuc3RhcnRzV2l0aCgnPGJ1aWx0aW5zPi8nKSkge1xuICAgICAgICAgICAgICAgICAgICBucyA9IHBhdGguam9pbihCVUlMVElOU19QQVRILCBucy5zdWJzdHIoMTEpKTsgICBcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5zLnN0YXJ0c1dpdGgoJzxzb3VyY2U+LycpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5zID0gcGF0aC5qb2luKHRoaXMuc291cmNlUGF0aCwgbnMuc3Vic3RyKDkpKTsgICBcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICBpZiAobnMuZW5kc1dpdGgoJy8qJykpIHtcbiAgICAgICAgICAgICAgICAgICAgcCA9IHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgbnMuc3Vic3RyKDAsIG5zLmxlbmd0aCAtIDIpKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVzID0gZnMucmVhZGRpclN5bmMocCk7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZiA9PiBleHBhbmROcyhuYW1lc3BhY2UsIHBhdGguam9pbihwLCBmKSwgZmFsc2UpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5zLmVuZHNXaXRoKCcvKionKSkge1xuICAgICAgICAgICAgICAgICAgICBwID0gcGF0aC5yZXNvbHZlKGN1cnJlbnRQYXRoLCBucy5zdWJzdHIoMCwgbnMubGVuZ3RoIC0gMykpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhwKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsZXMuZm9yRWFjaChmID0+IGV4cGFuZE5zKG5hbWVzcGFjZSwgcGF0aC5qb2luKHAsIGYpLCB0cnVlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlLnB1c2gocGF0aC5yZXNvbHZlKGN1cnJlbnRQYXRoLCBfLmVuZHNXaXRoKG5zLCBHRU1MX1NPVVJDRV9FWFQpID8gbnMgOiBucyArIEdFTUxfU09VUkNFX0VYVCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgb29sLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTtcblxuICAgICAgICBvb2wuaWQgPSB0aGlzLmdldE1vZHVsZUlkQnlQYXRoKG9vbEZpbGUpOyAgICAgICAgXG4gICAgICAgIG9vbC5uYW1lID0gYmFzZU5hbWU7ICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKCF0aGlzLnVzZUpzb25Tb3VyY2UgJiYgdGhpcy5zYXZlSW50ZXJtZWRpYXRlKSB7ICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoanNGaWxlLCBKU09OLnN0cmluZ2lmeShvb2wsIG51bGwsIDQpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvb2w7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IExpbmtlcjsiXX0=
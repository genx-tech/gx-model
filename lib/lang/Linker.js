"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob
} = require('rk-utils');

const {
  Types
} = require('@genx/data');

const Oolong = require('./grammar/geml');

const OolongParser = Oolong.parser;

const GemlTypes = require('./GemlTypes');

const Entity = require('./Entity');

const Schema = require('./Schema');

const View = require('./View');

const Dataset = require('./Dataset');

const ELEMENT_CLASS_MAP = {
  [GemlTypes.Element.ENTITY]: Entity,
  [GemlTypes.Element.VIEW]: View,
  [GemlTypes.Element.DATASET]: Dataset
};
const GEML_SOURCE_EXT = '.geml';
const BUILTINS_PATH = path.resolve(__dirname, 'builtins');

class Linker {
  static getGemlFiles(sourceDir, useJsonSource, recursive) {
    let pattern = '*' + GEML_SOURCE_EXT;

    if (useJsonSource) {
      pattern += '.json';
    }

    if (recursive) {
      pattern = '**/' + pattern;
    }

    return glob.sync(path.join(sourceDir, pattern), {
      nodir: true
    });
  }

  constructor(app, context) {
    this.app = app;
    this.sourcePath = context.gemlPath;
    this.useJsonSource = context.useJsonSource;
    this.saveIntermediate = context.saveIntermediate;
    this.schemaDeployment = context.schemas;
    this.schemas = {};
    this._gemlModules = {};
    this._elementsCache = {};
    this._mapOfReferenceToModuleId = new Map();
  }

  log(...args) {
    this.app.log(...args);
  }

  isModuleLoaded(moduleId) {
    return moduleId in this._gemlModules;
  }

  getModuleById(moduleId) {
    return this._gemlModules[moduleId];
  }

  link(entryFileName) {
    let entryModule = this.loadModule(entryFileName);

    if (!entryModule) {
      throw new Error(`Cannot resolve file "${entryFileName}".`);
    }

    if (_.isEmpty(entryModule.schema)) {
      throw new Error('No schema defined in entry file.');
    }

    _.forOwn(entryModule.schema, (schemaInfo, schemaName) => {
      let deploymentSettings = this.schemaDeployment[schemaName];
      let schema = new Schema(this, schemaName, entryModule, schemaInfo, deploymentSettings);
      schema.link();

      if (this.schemas.hasOwnProperty(schemaName)) {
        throw new Error(`Duplicate schema: "${schemaName}".`);
      }

      this.schemas[schemaName] = schema;

      if (this.saveIntermediate) {
        let jsFile = path.resolve(this.sourcePath, entryFileName + '-linked.json');
        fs.writeFileSync(jsFile, JSON.stringify(schema.toJSON(), null, 4));
      }
    });
  }

  loadModule(modulePath) {
    modulePath = path.resolve(this.sourcePath, modulePath);
    let id = this.getModuleIdByPath(modulePath);

    if (this.isModuleLoaded(id)) {
      return this.getModuleById(id);
    }

    if (!fs.existsSync(modulePath)) {
      return undefined;
    }

    let gemlModule = this._compile(modulePath);

    return this._gemlModules[id] = gemlModule;
  }

  trackBackType(gemlModule, info) {
    if (Types.Builtin.has(info.type)) {
      return info;
    }

    let baseInfo = this.loadElement(gemlModule, GemlTypes.Element.TYPE, info.type, true);

    if (!Types.Builtin.has(baseInfo.type)) {
      let ownerModule = baseInfo.gemlModule;
      let rootTypeInfo = this.trackBackType(ownerModule, baseInfo);
      ownerModule.type[baseInfo.type] = rootTypeInfo;
      baseInfo = rootTypeInfo;
    }

    let derivedInfo = { ..._.cloneDeep(_.omit(baseInfo, ['gemlModule', 'modifiers'])),
      ..._.omit(info, ['gemlModule', 'type', 'modifiers'])
    };

    if (baseInfo.modifiers || info.modifiers) {
      derivedInfo.modifiers = [...(baseInfo.modifiers || []), ...(info.modifiers || [])];
    }

    if (!derivedInfo.subClass) {
      derivedInfo.subClass = [];
    }

    derivedInfo.subClass.push(info.type);
    return derivedInfo;
  }

  translateOolValue(gemlModule, value) {
    if (_.isPlainObject(value)) {
      if (value.oolType === GemlTypes.Lang.CONST_REF) {
        let refedValue = this.loadElement(gemlModule, GemlTypes.Element.CONST, value.name, true);
        let uniqueId = this.getElementUniqueId(gemlModule, GemlTypes.Element.CONST, value.name);
        let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
        return this.translateOolValue(ownerModule, refedValue);
      } else if (value.oolType) {
        throw new Error(`todo: translateOolValue with type: ${value.oolType}`);
      }

      return _.mapValues(value, v => this.translateOolValue(gemlModule, v));
    }

    if (Array.isArray(value)) {
      return value.map(v => this.translateOolValue(gemlModule, v));
    }

    return value;
  }

  getModuleIdByPath(modulePath) {
    let isBuiltinEntity = _.startsWith(modulePath, BUILTINS_PATH);

    return isBuiltinEntity ? path.relative(BUILTINS_PATH, modulePath) : './' + path.relative(this.sourcePath, modulePath);
  }

  getElementUniqueId(refererModule, elementType, elementName) {
    return elementType + ':' + elementName + '<-' + refererModule.id;
  }

  loadEntity(refererModule, elementName, throwOnMissing = true) {
    let entity = this.loadElement(refererModule, GemlTypes.Element.ENTITY, elementName, throwOnMissing);

    if (entity && _.isEmpty(entity.fields) && _.isEmpty(entity.info.associations)) {
      throw new Error(`Entity "${elementName}" has no any fields defined.`);
    }

    return entity;
  }

  loadType(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.TYPE, elementName, throwOnMissing);
  }

  loadDataset(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.DATASET, elementName, throwOnMissing);
  }

  loadView(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, GemlTypes.Element.VIEW, elementName, throwOnMissing);
  }

  loadElement(refererModule, elementType, elementName, throwOnMissing) {
    let uniqueId = this.getElementUniqueId(refererModule, elementType, elementName);

    if (uniqueId in this._elementsCache) {
      return this._elementsCache[uniqueId];
    }

    let targetModule;

    if (elementType in refererModule && elementName in refererModule[elementType]) {
      targetModule = refererModule;
    } else {
      let index = _.findLastIndex(refererModule.namespace, modulePath => {
        targetModule = this.loadModule(modulePath);
        return targetModule && targetModule[elementType] && elementName in targetModule[elementType];
      });

      if (index === -1) {
        if (throwOnMissing) {
          throw new Error(`${elementType} "${elementName}" not found in imported namespaces. Referer: ${refererModule.id}`);
        }

        return undefined;
      }
    }

    let elementSelfId = elementType + ':' + elementName + '@' + targetModule.id;

    if (elementSelfId in this._elementsCache) {
      return this._elementsCache[uniqueId] = this._elementsCache[elementSelfId];
    }

    this._mapOfReferenceToModuleId.set(uniqueId, targetModule.id);

    let elementInfo = targetModule[elementType][elementName];
    let element;

    if (elementType in ELEMENT_CLASS_MAP) {
      let ElementClass = ELEMENT_CLASS_MAP[elementType];
      element = new ElementClass(this, elementName, targetModule, elementInfo);
      element.link();
    } else {
      if (elementType === GemlTypes.Element.TYPE) {
        element = { ...elementInfo,
          gemlModule: targetModule
        };
      } else {
        element = elementInfo;
      }
    }

    this._elementsCache[elementSelfId] = element;
    this._elementsCache[uniqueId] = element;
    return element;
  }

  _compile(oolFile) {
    let jsFile;

    if (oolFile.endsWith('.json')) {
      jsFile = oolFile;
      oolFile = oolFile.substr(0, oolFile.length - 5);
    } else {
      jsFile = oolFile + '.json';
    }

    let ool, searchExt;

    if (this.useJsonSource) {
      if (!fs.existsSync(jsFile)) {
        throw new Error(`"useJsonSource" enabeld but json file "${jsFile}" not found.`);
      }

      ool = fs.readJsonSync(jsFile);
      searchExt = GEML_SOURCE_EXT + '.json';
    } else {
      try {
        ool = OolongParser.parse(fs.readFileSync(oolFile, 'utf8'));
      } catch (error) {
        throw error;
      }

      if (!ool) {
        throw new Error('Unknown error occurred while compiling.');
      }

      searchExt = GEML_SOURCE_EXT;
    }

    let baseName = path.basename(oolFile, GEML_SOURCE_EXT);
    let namespace = [];
    let currentPath = path.dirname(oolFile);

    function expandNs(namespaces, ns, recursive) {
      let stats = fs.statSync(ns);

      if (stats.isFile() && ns.endsWith(searchExt)) {
        namespaces.push(ns);
        return;
      }

      if (stats.isDirectory() && recursive) {
        let files = fs.readdirSync(ns);
        files.forEach(f => expandNs(namespaces, path.join(ns, f), true));
      }
    }

    if (ool.namespace) {
      ool.namespace.forEach(ns => {
        let p;

        if (ns.startsWith('<builtins>/')) {
          ns = path.join(BUILTINS_PATH, ns.substr(11));
        } else if (ns.startsWith('<source>/')) {
          ns = path.join(this.sourcePath, ns.substr(9));
        }

        if (ns.endsWith('/*')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 2));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), false));
        } else if (ns.endsWith('/**')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 3));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), true));
        } else {
          namespace.push(path.resolve(currentPath, _.endsWith(ns, GEML_SOURCE_EXT) ? ns : ns + GEML_SOURCE_EXT));
        }
      });
    }

    ool.namespace = namespace;
    ool.id = this.getModuleIdByPath(oolFile);
    ool.name = baseName;

    if (!this.useJsonSource && this.saveIntermediate) {
      fs.writeFileSync(jsFile, JSON.stringify(ool, null, 4));
    }

    return ool;
  }

}

module.exports = Linker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0xpbmtlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJUeXBlcyIsIk9vbG9uZyIsIk9vbG9uZ1BhcnNlciIsInBhcnNlciIsIkdlbWxUeXBlcyIsIkVudGl0eSIsIlNjaGVtYSIsIlZpZXciLCJEYXRhc2V0IiwiRUxFTUVOVF9DTEFTU19NQVAiLCJFbGVtZW50IiwiRU5USVRZIiwiVklFVyIsIkRBVEFTRVQiLCJHRU1MX1NPVVJDRV9FWFQiLCJCVUlMVElOU19QQVRIIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIkxpbmtlciIsImdldEdlbWxGaWxlcyIsInNvdXJjZURpciIsInVzZUpzb25Tb3VyY2UiLCJyZWN1cnNpdmUiLCJwYXR0ZXJuIiwic3luYyIsImpvaW4iLCJub2RpciIsImNvbnN0cnVjdG9yIiwiYXBwIiwiY29udGV4dCIsInNvdXJjZVBhdGgiLCJnZW1sUGF0aCIsInNhdmVJbnRlcm1lZGlhdGUiLCJzY2hlbWFEZXBsb3ltZW50Iiwic2NoZW1hcyIsIl9nZW1sTW9kdWxlcyIsIl9lbGVtZW50c0NhY2hlIiwiX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZCIsIk1hcCIsImxvZyIsImFyZ3MiLCJpc01vZHVsZUxvYWRlZCIsIm1vZHVsZUlkIiwiZ2V0TW9kdWxlQnlJZCIsImxpbmsiLCJlbnRyeUZpbGVOYW1lIiwiZW50cnlNb2R1bGUiLCJsb2FkTW9kdWxlIiwiRXJyb3IiLCJpc0VtcHR5Iiwic2NoZW1hIiwiZm9yT3duIiwic2NoZW1hSW5mbyIsInNjaGVtYU5hbWUiLCJkZXBsb3ltZW50U2V0dGluZ3MiLCJoYXNPd25Qcm9wZXJ0eSIsImpzRmlsZSIsIndyaXRlRmlsZVN5bmMiLCJKU09OIiwic3RyaW5naWZ5IiwidG9KU09OIiwibW9kdWxlUGF0aCIsImlkIiwiZ2V0TW9kdWxlSWRCeVBhdGgiLCJleGlzdHNTeW5jIiwidW5kZWZpbmVkIiwiZ2VtbE1vZHVsZSIsIl9jb21waWxlIiwidHJhY2tCYWNrVHlwZSIsImluZm8iLCJCdWlsdGluIiwiaGFzIiwidHlwZSIsImJhc2VJbmZvIiwibG9hZEVsZW1lbnQiLCJUWVBFIiwib3duZXJNb2R1bGUiLCJyb290VHlwZUluZm8iLCJkZXJpdmVkSW5mbyIsImNsb25lRGVlcCIsIm9taXQiLCJtb2RpZmllcnMiLCJzdWJDbGFzcyIsInB1c2giLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsInZhbHVlIiwiaXNQbGFpbk9iamVjdCIsIm9vbFR5cGUiLCJMYW5nIiwiQ09OU1RfUkVGIiwicmVmZWRWYWx1ZSIsIkNPTlNUIiwibmFtZSIsInVuaXF1ZUlkIiwiZ2V0RWxlbWVudFVuaXF1ZUlkIiwiZ2V0IiwibWFwVmFsdWVzIiwidiIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsImlzQnVpbHRpbkVudGl0eSIsInN0YXJ0c1dpdGgiLCJyZWxhdGl2ZSIsInJlZmVyZXJNb2R1bGUiLCJlbGVtZW50VHlwZSIsImVsZW1lbnROYW1lIiwibG9hZEVudGl0eSIsInRocm93T25NaXNzaW5nIiwiZW50aXR5IiwiZmllbGRzIiwiYXNzb2NpYXRpb25zIiwibG9hZFR5cGUiLCJsb2FkRGF0YXNldCIsImxvYWRWaWV3IiwidGFyZ2V0TW9kdWxlIiwiaW5kZXgiLCJmaW5kTGFzdEluZGV4IiwibmFtZXNwYWNlIiwiZWxlbWVudFNlbGZJZCIsInNldCIsImVsZW1lbnRJbmZvIiwiZWxlbWVudCIsIkVsZW1lbnRDbGFzcyIsIm9vbEZpbGUiLCJlbmRzV2l0aCIsInN1YnN0ciIsImxlbmd0aCIsIm9vbCIsInNlYXJjaEV4dCIsInJlYWRKc29uU3luYyIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiZXJyb3IiLCJiYXNlTmFtZSIsImJhc2VuYW1lIiwiY3VycmVudFBhdGgiLCJkaXJuYW1lIiwiZXhwYW5kTnMiLCJuYW1lc3BhY2VzIiwibnMiLCJzdGF0cyIsInN0YXRTeW5jIiwiaXNGaWxlIiwiaXNEaXJlY3RvcnkiLCJmaWxlcyIsInJlYWRkaXJTeW5jIiwiZm9yRWFj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QUUsQ0FBQ2IsTUFBSCxHQUFZLENBQXpCLENBQTFCLENBQUo7QUFDQSxjQUFJa0IsS0FBSyxHQUFHbkosRUFBRSxDQUFDb0osV0FBSCxDQUFlRyxDQUFmLENBQVo7QUFDQUosVUFBQUEsS0FBSyxDQUFDRSxPQUFOLENBQWNDLENBQUMsSUFBSVYsUUFBUSxDQUFDcEIsU0FBRCxFQUFZM0gsSUFBSSxDQUFDOEIsSUFBTCxDQUFVNEgsQ0FBVixFQUFhRCxDQUFiLENBQVosRUFBNkIsSUFBN0IsQ0FBM0I7QUFDSCxTQUpNLE1BSUE7QUFDSDlCLFVBQUFBLFNBQVMsQ0FBQ25DLElBQVYsQ0FBZXhGLElBQUksQ0FBQ3FCLE9BQUwsQ0FBYXdILFdBQWIsRUFBMEIzSSxDQUFDLENBQUNnSSxRQUFGLENBQVdlLEVBQVgsRUFBZTlILGVBQWYsSUFBa0M4SCxFQUFsQyxHQUF1Q0EsRUFBRSxHQUFHOUgsZUFBdEUsQ0FBZjtBQUNIO0FBQ0osT0FwQkQ7QUFxQkg7O0FBRURrSCxJQUFBQSxHQUFHLENBQUNWLFNBQUosR0FBZ0JBLFNBQWhCO0FBRUFVLElBQUFBLEdBQUcsQ0FBQ2xFLEVBQUosR0FBUyxLQUFLQyxpQkFBTCxDQUF1QjZELE9BQXZCLENBQVQ7QUFDQUksSUFBQUEsR0FBRyxDQUFDcEMsSUFBSixHQUFXMEMsUUFBWDs7QUFFQSxRQUFJLENBQUMsS0FBS2pILGFBQU4sSUFBdUIsS0FBS1csZ0JBQWhDLEVBQWtEO0FBQzlDbEMsTUFBQUEsRUFBRSxDQUFDMkQsYUFBSCxDQUFpQkQsTUFBakIsRUFBeUJFLElBQUksQ0FBQ0MsU0FBTCxDQUFlcUUsR0FBZixFQUFvQixJQUFwQixFQUEwQixDQUExQixDQUF6QjtBQUNIOztBQUVELFdBQU9BLEdBQVA7QUFDSDs7QUFoY1E7O0FBbWNic0IsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckksTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IFR5cGVzIH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJyk7XG5cbmNvbnN0IE9vbG9uZyA9IHJlcXVpcmUoJy4vZ3JhbW1hci9nZW1sJyk7XG5jb25zdCBPb2xvbmdQYXJzZXIgPSBPb2xvbmcucGFyc2VyO1xuY29uc3QgR2VtbFR5cGVzID0gcmVxdWlyZSgnLi9HZW1sVHlwZXMnKTtcbmNvbnN0IEVudGl0eSA9IHJlcXVpcmUoJy4vRW50aXR5Jyk7XG5jb25zdCBTY2hlbWEgPSByZXF1aXJlKCcuL1NjaGVtYScpO1xuY29uc3QgVmlldyA9IHJlcXVpcmUoJy4vVmlldycpO1xuY29uc3QgRGF0YXNldCA9IHJlcXVpcmUoJy4vRGF0YXNldCcpO1xuXG5jb25zdCBFTEVNRU5UX0NMQVNTX01BUCA9IHtcbiAgICBbR2VtbFR5cGVzLkVsZW1lbnQuRU5USVRZXTogRW50aXR5LFxuICAgIFtHZW1sVHlwZXMuRWxlbWVudC5WSUVXXTogVmlldyxcbiAgICBbR2VtbFR5cGVzLkVsZW1lbnQuREFUQVNFVF06IERhdGFzZXQsXG59O1xuXG5jb25zdCBHRU1MX1NPVVJDRV9FWFQgPSAnLmdlbWwnO1xuY29uc3QgQlVJTFRJTlNfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdidWlsdGlucycpO1xuXG4vKipcbiAqIExpbmtlciBvZiBnZW1sXG4gKiBAY2xhc3MgR2VtbExpbmtlclxuICovXG5jbGFzcyBMaW5rZXIge1xuICAgIHN0YXRpYyBnZXRHZW1sRmlsZXMoc291cmNlRGlyLCB1c2VKc29uU291cmNlLCByZWN1cnNpdmUpIHtcbiAgICAgICAgbGV0IHBhdHRlcm4gPSAnKicgKyBHRU1MX1NPVVJDRV9FWFQ7XG5cbiAgICAgICAgaWYgKHVzZUpzb25Tb3VyY2UpIHtcbiAgICAgICAgICAgIHBhdHRlcm4gKz0gJy5qc29uJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZWN1cnNpdmUpIHtcbiAgICAgICAgICAgIHBhdHRlcm4gPSAnKiovJyArIHBhdHRlcm47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZ2xvYi5zeW5jKHBhdGguam9pbihzb3VyY2VEaXIsIHBhdHRlcm4pLCB7bm9kaXI6IHRydWV9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge1NlcnZpY2VDb250YWluZXJ9IGFwcCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LmdlbWxQYXRoIC0gR2VtbCBzb3VyY2UgZmlsZXMgcGF0aCAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY29udGV4dC51c2VKc29uU291cmNlPWZhbHNlXSAtIFVzZSAuanNvbiBpbnRlcm1lZGlhdGUgc291cmNlIGZpbGUgaW5zdGVhZCBvZiAub29sXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY29udGV4dC5zYXZlSW50ZXJtZWRpYXRlPWZhbHNlXSAtIFNhdmUgaW50ZXJtZWRpYXRlIHNvdXJjZSBmaWxlIHdoaWxlIGxpbmtpbmdcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihhcHAsIGNvbnRleHQpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcFxuICAgICAgICAgKiBAbWVtYmVyIHtTZXJ2aWNlQ29udGFpbmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEdlbWwgc291cmNlIGZpbGVzIHBhdGhcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zb3VyY2VQYXRoID0gY29udGV4dC5nZW1sUGF0aDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogVXNlIGpzb24gb3Igb2xzXG4gICAgICAgICAqIEBtZW1iZXIge2Jvb2x9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnVzZUpzb25Tb3VyY2UgPSBjb250ZXh0LnVzZUpzb25Tb3VyY2U7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFNhdmUgaW50ZXJtZWRpYXRlIGZpbGVzXG4gICAgICAgICAqIEBtZW1iZXIge2Jvb2x9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNhdmVJbnRlcm1lZGlhdGUgPSBjb250ZXh0LnNhdmVJbnRlcm1lZGlhdGU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFNjaGVtYSBkZXBsb3ltZW50IHNldHRpbmdzXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2NoZW1hRGVwbG95bWVudCA9IGNvbnRleHQuc2NoZW1hcztcblxuICAgICAgICAvKipcbiAgICAgICAgICogTGlua2VkIHNjaGVtYXNcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0LjxzdHJpbmcsIFNjaGVtYT59XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNjaGVtYXMgPSB7fTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUGFyc2VkIG9vbG9uZyBmaWxlcywgcGF0aCA9PiBtb2R1bGVcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZ2VtbE1vZHVsZXMgPSB7fTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRWxlbWVudCBjYWNoZSwgbWFwIG9mIDxyZWZlcmVuY2VJZCwgZWxlbWVudD4gYW5kIDxzZWxmSWQsIGVsZW1lbnQ+XG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gXG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9lbGVtZW50c0NhY2hlID0ge307XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE1hcCBvZiA8cmVmZXJlbmNlSWQsIG1vZHVsZUlkPlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQgPSBuZXcgTWFwKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogV3JpdGUgbG9nXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGxldmVsXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1lc3NhZ2VcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW2RhdGFdXG4gICAgICovXG4gICAgbG9nKC4uLmFyZ3MpIHtcbiAgICAgICAgdGhpcy5hcHAubG9nKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSBtb2R1bGUgaXMgbG9hZGVkXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZUlkXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaXNNb2R1bGVMb2FkZWQobW9kdWxlSWQpIHtcbiAgICAgICAgcmV0dXJuIChtb2R1bGVJZCBpbiB0aGlzLl9nZW1sTW9kdWxlcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgbG9hZGVkIG9vbG9uZSBtb2R1bGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlSWRcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldE1vZHVsZUJ5SWQobW9kdWxlSWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dlbWxNb2R1bGVzW21vZHVsZUlkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIG9vbG9uZyBmaWxlc1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbnRyeUZpbGVOYW1lXG4gICAgICovXG4gICAgbGluayhlbnRyeUZpbGVOYW1lKSB7XG4gICAgICAgIC8vY29tcGlsZSBlbnRyeSBmaWxlICAgICAgICBcbiAgICAgICAgbGV0IGVudHJ5TW9kdWxlID0gdGhpcy5sb2FkTW9kdWxlKGVudHJ5RmlsZU5hbWUpO1xuXG4gICAgICAgIGlmICghZW50cnlNb2R1bGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHJlc29sdmUgZmlsZSBcIiR7ZW50cnlGaWxlTmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChfLmlzRW1wdHkoZW50cnlNb2R1bGUuc2NoZW1hKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzY2hlbWEgZGVmaW5lZCBpbiBlbnRyeSBmaWxlLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgXy5mb3JPd24oZW50cnlNb2R1bGUuc2NoZW1hLCAoc2NoZW1hSW5mbywgc2NoZW1hTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGRlcGxveW1lbnRTZXR0aW5ncyA9IHRoaXMuc2NoZW1hRGVwbG95bWVudFtzY2hlbWFOYW1lXTtcbiAgICAgICAgICAgIC8vYXNzZXJ0OiBkZXBsb3ltZW50U2V0dGluZ3MsIGBcImRlcGxveW1lbnRTZXR0aW5nc1wiIG9mIHNjaGVtYSBbJHtzY2hlbWFOYW1lfV0gbm90IGZvdW5kLmA7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBzY2hlbWEgPSBuZXcgU2NoZW1hKHRoaXMsIHNjaGVtYU5hbWUsIGVudHJ5TW9kdWxlLCBzY2hlbWFJbmZvLCBkZXBsb3ltZW50U2V0dGluZ3MpO1xuICAgICAgICAgICAgc2NoZW1hLmxpbmsoKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hcy5oYXNPd25Qcm9wZXJ0eShzY2hlbWFOYW1lKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIHNjaGVtYTogXCIke3NjaGVtYU5hbWV9XCIuYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNjaGVtYXNbc2NoZW1hTmFtZV0gPSBzY2hlbWE7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnNhdmVJbnRlcm1lZGlhdGUpIHtcbiAgICAgICAgICAgICAgICBsZXQganNGaWxlID0gcGF0aC5yZXNvbHZlKHRoaXMuc291cmNlUGF0aCwgZW50cnlGaWxlTmFtZSArICctbGlua2VkLmpzb24nKTtcbiAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGpzRmlsZSwgSlNPTi5zdHJpbmdpZnkoc2NoZW1hLnRvSlNPTigpLCBudWxsLCA0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhIG9vbG9uZyBtb2R1bGUsIHJldHVybiB1bmRlZmluZWQgaWYgbm90IGV4aXN0XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZVBhdGhcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBsb2FkTW9kdWxlKG1vZHVsZVBhdGgpIHsgICAgICAgIFxuICAgICAgICBtb2R1bGVQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuc291cmNlUGF0aCwgbW9kdWxlUGF0aCk7XG5cbiAgICAgICAgbGV0IGlkID0gdGhpcy5nZXRNb2R1bGVJZEJ5UGF0aChtb2R1bGVQYXRoKTtcblxuICAgICAgICBpZiAodGhpcy5pc01vZHVsZUxvYWRlZChpZCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldE1vZHVsZUJ5SWQoaWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKG1vZHVsZVBhdGgpKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIGxldCBnZW1sTW9kdWxlID0gdGhpcy5fY29tcGlsZShtb2R1bGVQYXRoKTtcblxuICAgICAgICByZXR1cm4gKHRoaXMuX2dlbWxNb2R1bGVzW2lkXSA9IGdlbWxNb2R1bGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYWNrIGJhY2sgdGhlIHR5cGUgZGVyaXZlZCBjaGFpbi5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZ2VtbE1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0cmFja0JhY2tUeXBlKGdlbWxNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgaWYgKFR5cGVzLkJ1aWx0aW4uaGFzKGluZm8udHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBpbmZvO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJhc2VJbmZvID0gdGhpcy5sb2FkRWxlbWVudChnZW1sTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5UWVBFLCBpbmZvLnR5cGUsIHRydWUpO1xuXG4gICAgICAgIGlmICghVHlwZXMuQnVpbHRpbi5oYXMoYmFzZUluZm8udHlwZSkpIHtcbiAgICAgICAgICAgIC8vdGhlIGJhc2UgdHlwZSBpcyBub3QgYSBidWlsdGluIHR5cGVcbiAgICAgICAgICAgIGxldCBvd25lck1vZHVsZSA9IGJhc2VJbmZvLmdlbWxNb2R1bGU7ICBcblxuICAgICAgICAgICAgbGV0IHJvb3RUeXBlSW5mbyA9IHRoaXMudHJhY2tCYWNrVHlwZShvd25lck1vZHVsZSwgYmFzZUluZm8pO1xuICAgICAgICAgICAgb3duZXJNb2R1bGUudHlwZVtiYXNlSW5mby50eXBlXSA9IHJvb3RUeXBlSW5mbztcbiAgICAgICAgICAgIGJhc2VJbmZvID0gcm9vdFR5cGVJbmZvO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGRlcml2ZWRJbmZvID0geyAuLi5fLmNsb25lRGVlcChfLm9taXQoYmFzZUluZm8sIFsnZ2VtbE1vZHVsZScsICdtb2RpZmllcnMnXSkpLCAuLi5fLm9taXQoaW5mbywgWydnZW1sTW9kdWxlJywgJ3R5cGUnLCAnbW9kaWZpZXJzJ10pfTtcbiAgICAgICAgaWYgKGJhc2VJbmZvLm1vZGlmaWVycyB8fCBpbmZvLm1vZGlmaWVycykge1xuICAgICAgICAgICAgZGVyaXZlZEluZm8ubW9kaWZpZXJzID0gWyAuLi4oYmFzZUluZm8ubW9kaWZpZXJzIHx8IFtdKSwgLi4uKGluZm8ubW9kaWZpZXJzIHx8IFtdKSBdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFkZXJpdmVkSW5mby5zdWJDbGFzcykge1xuICAgICAgICAgICAgZGVyaXZlZEluZm8uc3ViQ2xhc3MgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICBkZXJpdmVkSW5mby5zdWJDbGFzcy5wdXNoKGluZm8udHlwZSk7XG4gICAgICAgIHJldHVybiBkZXJpdmVkSW5mbztcbiAgICB9ICAgIFxuICAgIFxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSBhbiB2YWx1ZSBieSBpbmZlcnJpbmcgYWxsIHRoZSByZWZlcmVuY2VzLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBnZW1sTW9kdWxlIFxuICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgXG4gICAgICogQHJldHVybnMgeyp9IC0gVHJhbnNsYXRlZCB2YWx1ZS5cbiAgICAgKi9cbiAgICB0cmFuc2xhdGVPb2xWYWx1ZShnZW1sTW9kdWxlLCB2YWx1ZSkge1xuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICAgICAgaWYgKHZhbHVlLm9vbFR5cGUgPT09IEdlbWxUeXBlcy5MYW5nLkNPTlNUX1JFRikgeyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgcmVmZWRWYWx1ZSA9IHRoaXMubG9hZEVsZW1lbnQoZ2VtbE1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuQ09OU1QsIHZhbHVlLm5hbWUsIHRydWUpO1xuICAgICAgICAgICAgICAgIGxldCB1bmlxdWVJZCA9IHRoaXMuZ2V0RWxlbWVudFVuaXF1ZUlkKGdlbWxNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LkNPTlNULCB2YWx1ZS5uYW1lKTtcbiAgICAgICAgICAgICAgICBsZXQgb3duZXJNb2R1bGUgPSB0aGlzLmdldE1vZHVsZUJ5SWQodGhpcy5fbWFwT2ZSZWZlcmVuY2VUb01vZHVsZUlkLmdldCh1bmlxdWVJZCkpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZU9vbFZhbHVlKG93bmVyTW9kdWxlLCByZWZlZFZhbHVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUub29sVHlwZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdG9kbzogdHJhbnNsYXRlT29sVmFsdWUgd2l0aCB0eXBlOiAke3ZhbHVlLm9vbFR5cGV9YClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIF8ubWFwVmFsdWVzKHZhbHVlLCB2ID0+IHRoaXMudHJhbnNsYXRlT29sVmFsdWUoZ2VtbE1vZHVsZSwgdikpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUubWFwKHYgPT4gdGhpcy50cmFuc2xhdGVPb2xWYWx1ZShnZW1sTW9kdWxlLCB2KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSB1bmlxdWUgbW9kdWxlIGlkIGJ5IHNvdXJjZSBmaWxlIHBhdGguXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZVBhdGggLSBUaGUgcGF0aCBvZiBhbiBvb2xvbmcgc291cmNlIGZpbGUuXG4gICAgICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgbW9kdWxlIGlkLlxuICAgICAqL1xuICAgIGdldE1vZHVsZUlkQnlQYXRoKG1vZHVsZVBhdGgpIHsgICAgICAgIFxuICAgICAgICBsZXQgaXNCdWlsdGluRW50aXR5ID0gXy5zdGFydHNXaXRoKG1vZHVsZVBhdGgsIEJVSUxUSU5TX1BBVEgpOyAgICAgIFxuICAgICAgICByZXR1cm4gaXNCdWlsdGluRW50aXR5ID8gXG4gICAgICAgICAgICBwYXRoLnJlbGF0aXZlKEJVSUxUSU5TX1BBVEgsIG1vZHVsZVBhdGgpIDogXG4gICAgICAgICAgICAnLi8nICsgcGF0aC5yZWxhdGl2ZSh0aGlzLnNvdXJjZVBhdGgsIG1vZHVsZVBhdGgpOyAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSB1bmlxdWUgbmFtZSBvZiBhbiBlbGVtZW50LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWZlcmVyTW9kdWxlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50VHlwZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudE5hbWUgXG4gICAgICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgdW5pcXVlIG5hbWUgb2YgYW4gZWxlbWVudC5cbiAgICAgKi9cbiAgICBnZXRFbGVtZW50VW5pcXVlSWQocmVmZXJlck1vZHVsZSwgZWxlbWVudFR5cGUsIGVsZW1lbnROYW1lKSB7XG4gICAgICAgIHJldHVybiBlbGVtZW50VHlwZSArICc6JyArIGVsZW1lbnROYW1lICsgJzwtJyArIHJlZmVyZXJNb2R1bGUuaWQ7XG4gICAgfVxuXG4gICAgbG9hZEVudGl0eShyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcgPSB0cnVlKSB7XG4gICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLmxvYWRFbGVtZW50KHJlZmVyZXJNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LkVOVElUWSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKTtcblxuICAgICAgICBpZiAoZW50aXR5ICYmIF8uaXNFbXB0eShlbnRpdHkuZmllbGRzKSAmJiBfLmlzRW1wdHkoZW50aXR5LmluZm8uYXNzb2NpYXRpb25zKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFbnRpdHkgXCIke2VsZW1lbnROYW1lfVwiIGhhcyBubyBhbnkgZmllbGRzIGRlZmluZWQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cblxuICAgIGxvYWRUeXBlKHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgR2VtbFR5cGVzLkVsZW1lbnQuVFlQRSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKTtcbiAgICB9XG5cbiAgICBsb2FkRGF0YXNldChyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcgPSB0cnVlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRFbGVtZW50KHJlZmVyZXJNb2R1bGUsIEdlbWxUeXBlcy5FbGVtZW50LkRBVEFTRVQsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyk7XG4gICAgfVxuXG4gICAgbG9hZFZpZXcocmVmZXJlck1vZHVsZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nID0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBHZW1sVHlwZXMuRWxlbWVudC5WSUVXLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvYWQgYW4gZWxlbWVudCBiYXNlZCBvbiB0aGUgbmFtZXNwYWNlIGNoYWluLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWZlcmVyTW9kdWxlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50VHlwZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudE5hbWUgXG4gICAgICovXG4gICAgbG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgZWxlbWVudFR5cGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZykge1xuICAgICAgICAvLyB0aGUgZWxlbWVudCBpZCB3aXRoIHR5cGUsIHNob3VsZCBiZSB1bmlxdWUgYW1vbmcgdGhlIHdob2xlIHNjaGVtYVxuICAgICAgICBsZXQgdW5pcXVlSWQgPSB0aGlzLmdldEVsZW1lbnRVbmlxdWVJZChyZWZlcmVyTW9kdWxlLCBlbGVtZW50VHlwZSwgZWxlbWVudE5hbWUpO1xuXG4gICAgICAgIC8vIHRoZSBlbGVtZW50IGlkICsgcmVmZXJlclxuICAgICAgICBpZiAodW5pcXVlSWQgaW4gdGhpcy5fZWxlbWVudHNDYWNoZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRzQ2FjaGVbdW5pcXVlSWRdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHRhcmdldE1vZHVsZTsgICAgICAgIFxuXG4gICAgICAgIGlmIChlbGVtZW50VHlwZSBpbiByZWZlcmVyTW9kdWxlICYmIGVsZW1lbnROYW1lIGluIHJlZmVyZXJNb2R1bGVbZWxlbWVudFR5cGVdKSB7XG4gICAgICAgICAgICAvLyBzZWUgaWYgaXQgZXhpc3RzIGluIHRoZSBzYW1lIG1vZHVsZSAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgdGFyZ2V0TW9kdWxlID0gcmVmZXJlck1vZHVsZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIHNlYXJjaCByZXZlcnNlbHkgYnkgdGhlIG5hbWVzcGFjZXNcbiAgICAgICAgICAgIC8vdGhpcy5sb2coJ3ZlcmJvc2UnLCBgU2VhcmNoaW5nICR7ZWxlbWVudFR5cGV9IFwiJHtlbGVtZW50TmFtZX1cIiBmcm9tIFwiJHtyZWZlcmVyTW9kdWxlLmlkfVwiIC4uLmApO1xuXG4gICAgICAgICAgICBsZXQgaW5kZXggPSBfLmZpbmRMYXN0SW5kZXgocmVmZXJlck1vZHVsZS5uYW1lc3BhY2UsIG1vZHVsZVBhdGggPT4ge1xuICAgICAgICAgICAgICAgIC8vdGhpcy5sb2coJ2RlYnVnJywgYExvb2tpbmcgZm9yICR7ZWxlbWVudFR5cGV9IFwiJHtlbGVtZW50TmFtZX1cIiBpbiBcIiR7bW9kdWxlUGF0aH1cIiAuLi5gKTtcblxuICAgICAgICAgICAgICAgIHRhcmdldE1vZHVsZSA9IHRoaXMubG9hZE1vZHVsZShtb2R1bGVQYXRoKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRNb2R1bGUgJiYgdGFyZ2V0TW9kdWxlW2VsZW1lbnRUeXBlXSAmJiAoZWxlbWVudE5hbWUgaW4gdGFyZ2V0TW9kdWxlW2VsZW1lbnRUeXBlXSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkgeyAgIFxuICAgICAgICAgICAgICAgIGlmICh0aHJvd09uTWlzc2luZykgeyAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2VsZW1lbnRUeXBlfSBcIiR7ZWxlbWVudE5hbWV9XCIgbm90IGZvdW5kIGluIGltcG9ydGVkIG5hbWVzcGFjZXMuIFJlZmVyZXI6ICR7cmVmZXJlck1vZHVsZS5pZH1gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGVsZW1lbnRTZWxmSWQgPSBlbGVtZW50VHlwZSArICc6JyArIGVsZW1lbnROYW1lICsgJ0AnICsgdGFyZ2V0TW9kdWxlLmlkO1xuICAgICAgICBpZiAoZWxlbWVudFNlbGZJZCBpbiB0aGlzLl9lbGVtZW50c0NhY2hlKSB7XG4gICAgICAgICAgICAvLyBhbHJlYWR5IGluaXRpYWxpemVkICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuX2VsZW1lbnRzQ2FjaGVbdW5pcXVlSWRdID0gdGhpcy5fZWxlbWVudHNDYWNoZVtlbGVtZW50U2VsZklkXSk7XG4gICAgICAgIH1cbiAgICAgICBcbiAgICAgICAgdGhpcy5fbWFwT2ZSZWZlcmVuY2VUb01vZHVsZUlkLnNldCh1bmlxdWVJZCwgdGFyZ2V0TW9kdWxlLmlkKTtcblxuICAgICAgICAvLyByZXRyaWV2ZSB0aGUgY29tcGlsZWQgaW5mb1xuICAgICAgICBsZXQgZWxlbWVudEluZm8gPSB0YXJnZXRNb2R1bGVbZWxlbWVudFR5cGVdW2VsZW1lbnROYW1lXTtcbiAgICAgICAgbGV0IGVsZW1lbnQ7XG5cbiAgICAgICAgaWYgKGVsZW1lbnRUeXBlIGluIEVMRU1FTlRfQ0xBU1NfTUFQKSB7XG4gICAgICAgICAgICAvLyBlbGVtZW50IG5lZWQgbGlua2luZ1xuICAgICAgICAgICAgbGV0IEVsZW1lbnRDbGFzcyA9IEVMRU1FTlRfQ0xBU1NfTUFQW2VsZW1lbnRUeXBlXTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgZWxlbWVudCA9IG5ldyBFbGVtZW50Q2xhc3ModGhpcywgZWxlbWVudE5hbWUsIHRhcmdldE1vZHVsZSwgZWxlbWVudEluZm8pOyAgIFxuICAgICAgICAgICAgZWxlbWVudC5saW5rKCk7ICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUgPT09IEdlbWxUeXBlcy5FbGVtZW50LlRZUEUpIHtcbiAgICAgICAgICAgICAgICBlbGVtZW50ID0ge1xuICAgICAgICAgICAgICAgICAgICAuLi5lbGVtZW50SW5mbyxcbiAgICAgICAgICAgICAgICAgICAgZ2VtbE1vZHVsZTogdGFyZ2V0TW9kdWxlXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnRJbmZvO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZVtlbGVtZW50U2VsZklkXSA9IGVsZW1lbnQ7XG4gICAgICAgIHRoaXMuX2VsZW1lbnRzQ2FjaGVbdW5pcXVlSWRdID0gZWxlbWVudDtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBlbGVtZW50O1xuICAgIH1cblxuICAgIF9jb21waWxlKG9vbEZpbGUpIHtcbiAgICAgICAgbGV0IGpzRmlsZTtcbiAgICAgICAgXG4gICAgICAgIGlmIChvb2xGaWxlLmVuZHNXaXRoKCcuanNvbicpKSB7XG4gICAgICAgICAgICBqc0ZpbGUgPSBvb2xGaWxlO1xuICAgICAgICAgICAgb29sRmlsZSA9IG9vbEZpbGUuc3Vic3RyKDAsIG9vbEZpbGUubGVuZ3RoIC0gNSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBqc0ZpbGUgPSBvb2xGaWxlICsgJy5qc29uJztcbiAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGxldCBvb2wsIHNlYXJjaEV4dDtcblxuICAgICAgICBpZiAodGhpcy51c2VKc29uU291cmNlKSB7XG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoanNGaWxlKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgXCJ1c2VKc29uU291cmNlXCIgZW5hYmVsZCBidXQganNvbiBmaWxlIFwiJHtqc0ZpbGV9XCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvb2wgPSBmcy5yZWFkSnNvblN5bmMoanNGaWxlKTtcbiAgICAgICAgICAgIHNlYXJjaEV4dCA9IEdFTUxfU09VUkNFX0VYVCArICcuanNvbic7XG4gICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgIC8vdGhpcy5sb2coJ2RlYnVnJywgJ0NvbXBpbGluZyAnICsgb29sRmlsZSArICcgLi4uJyk7ICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBvb2wgPSBPb2xvbmdQYXJzZXIucGFyc2UoZnMucmVhZEZpbGVTeW5jKG9vbEZpbGUsICd1dGY4JykpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbXBpbGUgXCIkeyBvb2xGaWxlIH1cIi5cXG4keyBlcnJvci5tZXNzYWdlIHx8IGVycm9yIH1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIW9vbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlcnJvciBvY2N1cnJlZCB3aGlsZSBjb21waWxpbmcuJyk7XG4gICAgICAgICAgICB9ICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBzZWFyY2hFeHQgPSBHRU1MX1NPVVJDRV9FWFQ7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYmFzZU5hbWUgPSBwYXRoLmJhc2VuYW1lKG9vbEZpbGUsIEdFTUxfU09VUkNFX0VYVCk7XG5cbiAgICAgICAgbGV0IG5hbWVzcGFjZSA9IFtdO1xuXG4gICAgICAgIGxldCBjdXJyZW50UGF0aCA9IHBhdGguZGlybmFtZShvb2xGaWxlKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogXG4gICAgICAgICAqIEBwYXJhbSB7Kn0gbmFtZXNwYWNlcyAtIFNlYXJjaGluZyBwYXRoXG4gICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBucyAtIEltcG9ydCBsaW5lXG4gICAgICAgICAqIEBwYXJhbSB7Kn0gcmVjdXJzaXZlIFxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gZXhwYW5kTnMobmFtZXNwYWNlcywgbnMsIHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgbGV0IHN0YXRzID0gZnMuc3RhdFN5bmMobnMpO1xuXG4gICAgICAgICAgICAvL2ltcG9ydCAnL3BhdGgvdXNlci5vb2wnXG4gICAgICAgICAgICBpZiAoc3RhdHMuaXNGaWxlKCkgJiYgbnMuZW5kc1dpdGgoc2VhcmNoRXh0KSkge1xuICAgICAgICAgICAgICAgIG5hbWVzcGFjZXMucHVzaChucyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSAmJiByZWN1cnNpdmUpIHtcbiAgICAgICAgICAgICAgICAvL3Jlc3Vyc2l2ZSBleHBhbmQgc3ViLWRpcmVjdG9yeVxuICAgICAgICAgICAgICAgIGxldCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKG5zKTtcbiAgICAgICAgICAgICAgICBmaWxlcy5mb3JFYWNoKGYgPT4gZXhwYW5kTnMobmFtZXNwYWNlcywgcGF0aC5qb2luKG5zLCBmKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9vbC5uYW1lc3BhY2UpIHtcbiAgICAgICAgICAgIG9vbC5uYW1lc3BhY2UuZm9yRWFjaChucyA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHA7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKG5zLnN0YXJ0c1dpdGgoJzxidWlsdGlucz4vJykpIHtcbiAgICAgICAgICAgICAgICAgICAgbnMgPSBwYXRoLmpvaW4oQlVJTFRJTlNfUEFUSCwgbnMuc3Vic3RyKDExKSk7ICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChucy5zdGFydHNXaXRoKCc8c291cmNlPi8nKSkge1xuICAgICAgICAgICAgICAgICAgICBucyA9IHBhdGguam9pbih0aGlzLnNvdXJjZVBhdGgsIG5zLnN1YnN0cig5KSk7ICAgXG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgaWYgKG5zLmVuZHNXaXRoKCcvKicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHAgPSBwYXRoLnJlc29sdmUoY3VycmVudFBhdGgsIG5zLnN1YnN0cigwLCBucy5sZW5ndGggLSAyKSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKHApO1xuICAgICAgICAgICAgICAgICAgICBmaWxlcy5mb3JFYWNoKGYgPT4gZXhwYW5kTnMobmFtZXNwYWNlLCBwYXRoLmpvaW4ocCwgZiksIGZhbHNlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChucy5lbmRzV2l0aCgnLyoqJykpIHtcbiAgICAgICAgICAgICAgICAgICAgcCA9IHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgbnMuc3Vic3RyKDAsIG5zLmxlbmd0aCAtIDMpKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVzID0gZnMucmVhZGRpclN5bmMocCk7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZiA9PiBleHBhbmROcyhuYW1lc3BhY2UsIHBhdGguam9pbihwLCBmKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZS5wdXNoKHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgXy5lbmRzV2l0aChucywgR0VNTF9TT1VSQ0VfRVhUKSA/IG5zIDogbnMgKyBHRU1MX1NPVVJDRV9FWFQpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9vbC5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7XG5cbiAgICAgICAgb29sLmlkID0gdGhpcy5nZXRNb2R1bGVJZEJ5UGF0aChvb2xGaWxlKTsgICAgICAgIFxuICAgICAgICBvb2wubmFtZSA9IGJhc2VOYW1lOyAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmICghdGhpcy51c2VKc29uU291cmNlICYmIHRoaXMuc2F2ZUludGVybWVkaWF0ZSkgeyAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGpzRmlsZSwgSlNPTi5zdHJpbmdpZnkob29sLCBudWxsLCA0KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb29sO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBMaW5rZXI7Il19
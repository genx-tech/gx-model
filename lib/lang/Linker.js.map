{"version":3,"sources":["../../src/lang/Linker.js"],"names":["path","require","_","arrayToObject","fs","glob","Types","Geml","GemlParser","parser","GemlTypes","Entity","Schema","View","Dataset","ELEMENT_CLASS_MAP","Element","ENTITY","VIEW","DATASET","GEML_SOURCE_EXT","BUILTINS_PATH","resolve","__dirname","Linker","getGemlFiles","sourceDir","useJsonSource","recursive","pattern","sync","join","nodir","constructor","app","context","sourcePath","gemlPath","saveIntermediate","schemas","dependencies","_gemlModules","_elementsCache","_mapOfReferenceToModuleId","entityOverride","Set","log","args","isModuleLoaded","moduleId","getModuleById","link","entryFileName","entryModule","loadModule","Error","isEmpty","overrides","entities","map","item","entity","schema","forOwn","schemaInfo","schemaName","hasOwnProperty","jsFile","writeFileSync","JSON","stringify","toJSON","modulePath","packageName","id","getModuleIdByPath","existsSync","undefined","gemlModule","_compile","getTypeInfo","name","location","type","trackBackType","info","Builtin","has","baseInfo","loadElement","TYPE","backupBaseInfo","ownerModule","rootTypeInfo","derivedInfo","cloneDeep","omit","modifiers","subClass","push","translateOolValue","value","isPlainObject","oolType","Lang","CONST_REF","refedValue","CONST","uniqueId","getElementUniqueId","mapValues","v","Array","isArray","isBuiltinEntity","startsWith","relative","refererModule","elementType","elementName","loadEntity","throwOnMissing","loadType","loadDataset","loadView","targetModule","index","findLastIndex","namespace","elementSelfId","elementInfo","element","console","ElementClass","oolFile","endsWith","substr","length","ool","searchExt","readJsonSync","parse","readFileSync","error","message","baseName","basename","currentPath","dirname","expandNs","namespaces","ns","stats","statSync","isFile","isDirectory","files","readdirSync","forEach","f","p","packageSep","indexOf","substring","pkgPath","module","exports"],"mappings":"AAAA;;;;AAEA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;AAAEC,EAAAA,CAAF;AAAKC,EAAAA;AAAL,IAAuBF,OAAO,CAAC,YAAD,CAApC;;AACA,MAAM;AAAEG,EAAAA,EAAF;AAAMC,EAAAA;AAAN,IAAeJ,OAAO,CAAC,WAAD,CAA5B;;AACA,MAAM;AAAEK,EAAAA;AAAF,IAAYL,OAAO,CAAC,YAAD,CAAzB;;AAEA,MAAMM,IAAI,GAAGN,OAAO,CAAC,gBAAD,CAApB;;AACA,MAAMO,UAAU,GAAGD,IAAI,CAACE,MAAxB;;AACA,MAAMC,SAAS,GAAGT,OAAO,CAAC,aAAD,CAAzB;;AACA,MAAMU,MAAM,GAAGV,OAAO,CAAC,UAAD,CAAtB;;AACA,MAAMW,MAAM,GAAGX,OAAO,CAAC,UAAD,CAAtB;;AACA,MAAMY,IAAI,GAAGZ,OAAO,CAAC,QAAD,CAApB;;AACA,MAAMa,OAAO,GAAGb,OAAO,CAAC,WAAD,CAAvB;;AAEA,MAAMc,iBAAiB,GAAG;AACtB,GAACL,SAAS,CAACM,OAAV,CAAkBC,MAAnB,GAA4BN,MADN;AAEtB,GAACD,SAAS,CAACM,OAAV,CAAkBE,IAAnB,GAA0BL,IAFJ;AAGtB,GAACH,SAAS,CAACM,OAAV,CAAkBG,OAAnB,GAA6BL;AAHP,CAA1B;AAMA,MAAMM,eAAe,GAAG,OAAxB;AACA,MAAMC,aAAa,GAAGrB,IAAI,CAACsB,OAAL,CAAaC,SAAb,EAAwB,UAAxB,CAAtB;;AAMA,MAAMC,MAAN,CAAa;AACU,SAAZC,YAAY,CAACC,SAAD,EAAYC,aAAZ,EAA2BC,SAA3B,EAAsC;AACrD,QAAIC,OAAO,GAAG,MAAMT,eAApB;;AAEA,QAAIO,aAAJ,EAAmB;AACfE,MAAAA,OAAO,IAAI,OAAX;AACH;;AAED,QAAID,SAAJ,EAAe;AACXC,MAAAA,OAAO,GAAG,QAAQA,OAAlB;AACH;;AAED,WAAOxB,IAAI,CAACyB,IAAL,CAAU9B,IAAI,CAAC+B,IAAL,CAAUL,SAAV,EAAqBG,OAArB,CAAV,EAAyC;AAACG,MAAAA,KAAK,EAAE;AAAR,KAAzC,CAAP;AACH;;AASDC,EAAAA,WAAW,CAACC,GAAD,EAAMC,OAAN,EAAe;AAKtB,SAAKD,GAAL,GAAWA,GAAX;AAMA,SAAKE,UAAL,GAAkBD,OAAO,CAACE,QAA1B;AAMA,SAAKV,aAAL,GAAqBQ,OAAO,CAACR,aAA7B;AAMA,SAAKW,gBAAL,GAAwBH,OAAO,CAACG,gBAAhC;AAMA,SAAKC,OAAL,GAAe,EAAf;AAMA,SAAKC,YAAL,GAAoBL,OAAO,CAACK,YAAR,IAAwB,EAA5C;AAOA,SAAKC,YAAL,GAAoB,EAApB;AAOA,SAAKC,cAAL,GAAsB,EAAtB;AAOA,SAAKC,yBAAL,GAAiC,EAAjC;AAKA,SAAKC,cAAL,GAAsB,IAAIC,GAAJ,EAAtB;AACH;;AAQDC,EAAAA,GAAG,CAAC,GAAGC,IAAJ,EAAU;AACT,SAAKb,GAAL,CAASY,GAAT,CAAa,GAAGC,IAAhB;AACH;;AAODC,EAAAA,cAAc,CAACC,QAAD,EAAW;AACrB,WAAQA,QAAQ,IAAI,KAAKR,YAAzB;AACH;;AAODS,EAAAA,aAAa,CAACD,QAAD,EAAW;AACpB,WAAO,KAAKR,YAAL,CAAkBQ,QAAlB,CAAP;AACH;;AAMDE,EAAAA,IAAI,CAACC,aAAD,EAAgB;AAAA;;AAEhB,QAAIC,WAAW,GAAG,KAAKC,UAAL,CAAgBF,aAAhB,CAAlB;;AAEA,QAAI,CAACC,WAAL,EAAkB;AACd,YAAM,IAAIE,KAAJ,CAAW,wBAAuBH,aAAc,IAAhD,CAAN;AACH;;AAGD,QAAI,CAAClD,CAAC,CAACsD,OAAF,0BAAUH,WAAW,CAACI,SAAtB,0DAAU,sBAAuBC,QAAjC,CAAL,EAAiD;AAC7C,WAAKd,cAAL,GAAsB,IAAIC,GAAJ,CAAQQ,WAAW,CAACI,SAAZ,CAAsBC,QAAtB,CAA+BC,GAA/B,CAAmCC,IAAI,IAAIA,IAAI,CAACC,MAAhD,CAAR,CAAtB;AACH;;AAED,QAAI3D,CAAC,CAACsD,OAAF,CAAUH,WAAW,CAACS,MAAtB,CAAJ,EAAmC;AAC/B,YAAM,IAAIP,KAAJ,CAAU,kCAAV,CAAN;AACH;;AAEDrD,IAAAA,CAAC,CAAC6D,MAAF,CAASV,WAAW,CAACS,MAArB,EAA6B,CAACE,UAAD,EAAaC,UAAb,KAA4B;AACrD,UAAIH,MAAM,GAAG,IAAIlD,MAAJ,CAAW,IAAX,EAAiBqD,UAAjB,EAA6BZ,WAA7B,EAA0CW,UAA1C,CAAb;AACAF,MAAAA,MAAM,CAACX,IAAP;;AAEA,UAAI,KAAKZ,OAAL,CAAa2B,cAAb,CAA4BD,UAA5B,CAAJ,EAA6C;AACzC,cAAM,IAAIV,KAAJ,CAAW,sBAAqBU,UAAW,IAA3C,CAAN;AACH;;AACD,WAAK1B,OAAL,CAAa0B,UAAb,IAA2BH,MAA3B;;AAEA,UAAI,KAAKxB,gBAAT,EAA2B;AACvB,YAAI6B,MAAM,GAAGnE,IAAI,CAACsB,OAAL,CAAa,KAAKc,UAAlB,EAA8BgB,aAAa,GAAG,cAA9C,CAAb;AACAhD,QAAAA,EAAE,CAACgE,aAAH,CAAiBD,MAAjB,EAAyBE,IAAI,CAACC,SAAL,CAAeR,MAAM,CAACS,MAAP,EAAf,EAAgC,IAAhC,EAAsC,CAAtC,CAAzB;AACH;AACJ,KAbD;AAcH;;AAODjB,EAAAA,UAAU,CAACkB,UAAD,EAAaC,WAAb,EAA0B;AAChCD,IAAAA,UAAU,GAAGxE,IAAI,CAACsB,OAAL,CAAa,KAAKc,UAAlB,EAA8BoC,UAA9B,CAAb;AAEA,QAAIE,EAAE,GAAG,KAAKC,iBAAL,CAAuBH,UAAvB,CAAT;;AAEA,QAAI,KAAKxB,cAAL,CAAoB0B,EAApB,CAAJ,EAA6B;AACzB,aAAO,KAAKxB,aAAL,CAAmBwB,EAAnB,CAAP;AACH;;AAED,QAAI,CAACtE,EAAE,CAACwE,UAAH,CAAcJ,UAAd,CAAL,EAAgC;AAC5B,aAAOK,SAAP;AACH;;AAED,QAAIC,UAAU,GAAG,KAAKC,QAAL,CAAcP,UAAd,EAA0BC,WAA1B,CAAjB;;AAEA,WAAQ,KAAKhC,YAAL,CAAkBiC,EAAlB,IAAwBI,UAAhC;AACH;;AAEDE,EAAAA,WAAW,CAACC,IAAD,EAAOC,QAAP,EAAiB;AACxB,UAAMJ,UAAU,GAAG,KAAK5B,aAAL,CAAmBgC,QAAnB,CAAnB;AACA,WAAOJ,UAAU,CAACK,IAAX,CAAgBF,IAAhB,CAAP;AACH;;AAQDG,EAAAA,aAAa,CAACN,UAAD,EAAaO,IAAb,EAAmB;AAC5B,QAAI/E,KAAK,CAACgF,OAAN,CAAcC,GAAd,CAAkBF,IAAI,CAACF,IAAvB,CAAJ,EAAkC;AAC9B,aAAO,CAAEE,IAAF,CAAP;AACH;;AAED,QAAIG,QAAQ,GAAG,KAAKC,WAAL,CAAiBX,UAAjB,EAA6BpE,SAAS,CAACM,OAAV,CAAkB0E,IAA/C,EAAqDL,IAAI,CAACF,IAA1D,EAAgE,IAAhE,CAAf;AACA,QAAIQ,cAAc,GAAGH,QAAQ,CAACL,IAAT,KAAkBE,IAAI,CAACF,IAAvB,GAA8BK,QAA9B,GAAyC,IAA9D;;AAEA,QAAI,CAAClF,KAAK,CAACgF,OAAN,CAAcC,GAAd,CAAkBC,QAAQ,CAACL,IAA3B,CAAL,EAAuC;AAEnC,UAAIS,WAAW,GAAGJ,QAAQ,CAACV,UAA3B;AAEA,UAAI,CAAEe,YAAF,IAAmB,KAAKT,aAAL,CAAmBQ,WAAnB,EAAgCJ,QAAhC,CAAvB;AAEAI,MAAAA,WAAW,CAACT,IAAZ,CAAiBK,QAAQ,CAACL,IAA1B,IAAkCU,YAAlC;AACAL,MAAAA,QAAQ,GAAGK,YAAX;AACH,KARD,MAQO;AACHF,MAAAA,cAAc,GAAG,IAAjB;AACH;;AAED,QAAIG,WAAW,GAAG,EAAE,GAAG5F,CAAC,CAAC6F,SAAF,CAAY7F,CAAC,CAAC8F,IAAF,CAAOR,QAAP,EAAiB,CAAC,YAAD,EAAe,WAAf,CAAjB,CAAZ,CAAL;AAAiE,SAAGtF,CAAC,CAAC8F,IAAF,CAAOX,IAAP,EAAa,CAAC,YAAD,EAAe,MAAf,EAAuB,WAAvB,CAAb;AAApE,KAAlB;;AACA,QAAIG,QAAQ,CAACS,SAAT,IAAsBZ,IAAI,CAACY,SAA/B,EAA0C;AACtCH,MAAAA,WAAW,CAACG,SAAZ,GAAwB,CAAE,IAAIT,QAAQ,CAACS,SAAT,IAAsB,EAA1B,CAAF,EAAiC,IAAIZ,IAAI,CAACY,SAAL,IAAkB,EAAtB,CAAjC,CAAxB;AACH;;AAED,QAAI,CAACH,WAAW,CAACI,QAAjB,EAA2B;AACvBJ,MAAAA,WAAW,CAACI,QAAZ,GAAuB,EAAvB;AACH;;AACDJ,IAAAA,WAAW,CAACI,QAAZ,CAAqBC,IAArB,CAA0Bd,IAAI,CAACF,IAA/B;AACA,WAAO,CAAEW,WAAF,EAAeH,cAAf,CAAP;AACH;;AAQDS,EAAAA,iBAAiB,CAACtB,UAAD,EAAauB,KAAb,EAAoB;AACjC,QAAInG,CAAC,CAACoG,aAAF,CAAgBD,KAAhB,CAAJ,EAA4B;AACxB,UAAIA,KAAK,CAACE,OAAN,KAAkB7F,SAAS,CAAC8F,IAAV,CAAeC,SAArC,EAAgD;AAC5C,YAAIC,UAAU,GAAG,KAAKjB,WAAL,CAAiBX,UAAjB,EAA6BpE,SAAS,CAACM,OAAV,CAAkB2F,KAA/C,EAAsDN,KAAK,CAACpB,IAA5D,EAAkE,IAAlE,CAAjB;AACA,YAAI2B,QAAQ,GAAG,KAAKC,kBAAL,CAAwB/B,UAAxB,EAAoCpE,SAAS,CAACM,OAAV,CAAkB2F,KAAtD,EAA6DN,KAAK,CAACpB,IAAnE,CAAf;AACA,YAAIW,WAAW,GAAG,KAAK1C,aAAL,CAAmB,KAAKP,yBAAL,CAA+BiE,QAA/B,CAAnB,CAAlB;AACA,eAAO,KAAKR,iBAAL,CAAuBR,WAAvB,EAAoCc,UAApC,CAAP;AACH,OALD,MAKO,IAAIL,KAAK,CAACE,OAAV,EAAmB;AACtB,cAAM,IAAIhD,KAAJ,CAAW,sCAAqC8C,KAAK,CAACE,OAAQ,EAA9D,CAAN;AACH;;AAED,aAAOrG,CAAC,CAAC4G,SAAF,CAAYT,KAAZ,EAAmBU,CAAC,IAAI,KAAKX,iBAAL,CAAuBtB,UAAvB,EAAmCiC,CAAnC,CAAxB,CAAP;AACH;;AAED,QAAIC,KAAK,CAACC,OAAN,CAAcZ,KAAd,CAAJ,EAA0B;AACtB,aAAOA,KAAK,CAAC1C,GAAN,CAAUoD,CAAC,IAAI,KAAKX,iBAAL,CAAuBtB,UAAvB,EAAmCiC,CAAnC,CAAf,CAAP;AACH;;AAED,WAAOV,KAAP;AACH;;AAOD1B,EAAAA,iBAAiB,CAACH,UAAD,EAAa;AAC1B,QAAI0C,eAAe,GAAGhH,CAAC,CAACiH,UAAF,CAAa3C,UAAb,EAAyBnD,aAAzB,CAAtB;;AACA,WAAO6F,eAAe,GAClBlH,IAAI,CAACoH,QAAL,CAAc/F,aAAd,EAA6BmD,UAA7B,CADkB,GAElB,OAAOxE,IAAI,CAACoH,QAAL,CAAc,KAAKhF,UAAnB,EAA+BoC,UAA/B,CAFX;AAGH;;AASDqC,EAAAA,kBAAkB,CAACQ,aAAD,EAAgBC,WAAhB,EAA6BC,WAA7B,EAA0C;AACxD,WAAOD,WAAW,GAAG,GAAd,GAAoBC,WAApB,GAAkC,IAAlC,GAAyCF,aAAa,CAAC3C,EAA9D;AACH;;AAED8C,EAAAA,UAAU,CAACH,aAAD,EAAgBE,WAAhB,EAA6BE,cAAc,GAAG,IAA9C,EAAoD;AAC1D,WAAO,KAAKhC,WAAL,CAAiB4B,aAAjB,EAAgC3G,SAAS,CAACM,OAAV,CAAkBC,MAAlD,EAA0DsG,WAA1D,EAAuEE,cAAvE,CAAP;AACH;;AAEDC,EAAAA,QAAQ,CAACL,aAAD,EAAgBE,WAAhB,EAA6BE,cAAc,GAAG,IAA9C,EAAoD;AACxD,WAAO,KAAKhC,WAAL,CAAiB4B,aAAjB,EAAgC3G,SAAS,CAACM,OAAV,CAAkB0E,IAAlD,EAAwD6B,WAAxD,EAAqEE,cAArE,CAAP;AACH;;AAEDE,EAAAA,WAAW,CAACN,aAAD,EAAgBE,WAAhB,EAA6BE,cAAc,GAAG,IAA9C,EAAoD;AAC3D,WAAO,KAAKhC,WAAL,CAAiB4B,aAAjB,EAAgC3G,SAAS,CAACM,OAAV,CAAkBG,OAAlD,EAA2DoG,WAA3D,EAAwEE,cAAxE,CAAP;AACH;;AAEDG,EAAAA,QAAQ,CAACP,aAAD,EAAgBE,WAAhB,EAA6BE,cAAc,GAAG,IAA9C,EAAoD;AACxD,WAAO,KAAKhC,WAAL,CAAiB4B,aAAjB,EAAgC3G,SAAS,CAACM,OAAV,CAAkBE,IAAlD,EAAwDqG,WAAxD,EAAqEE,cAArE,CAAP;AACH;;AAQDhC,EAAAA,WAAW,CAAC4B,aAAD,EAAgBC,WAAhB,EAA6BC,WAA7B,EAA0CE,cAA1C,EAA0D;AAEjE,QAAIb,QAAQ,GAAG,KAAKC,kBAAL,CAAwBQ,aAAxB,EAAuCC,WAAvC,EAAoDC,WAApD,CAAf;;AAGA,QAAIX,QAAQ,IAAI,KAAKlE,cAArB,EAAqC;AACjC,aAAO,KAAKA,cAAL,CAAoBkE,QAApB,CAAP;AACH;;AAED,QAAIiB,YAAJ;;AAEA,QAAIP,WAAW,IAAID,aAAf,IAAgCE,WAAW,IAAIF,aAAa,CAACC,WAAD,CAAhE,EAA+E;AAE3EO,MAAAA,YAAY,GAAGR,aAAf;AACH,KAHD,MAGO;AAIH,UAAIS,KAAK,GAAG5H,CAAC,CAAC6H,aAAF,CAAgBV,aAAa,CAACW,SAA9B,EAAyCxD,UAAU,IAAI;AAE/D,YAAIC,WAAJ;;AAEA,YAAIuC,KAAK,CAACC,OAAN,CAAczC,UAAd,CAAJ,EAA+B;AAC3BC,UAAAA,WAAW,GAAGD,UAAU,CAAC,CAAD,CAAxB;AACAA,UAAAA,UAAU,GAAGA,UAAU,CAAC,CAAD,CAAvB;AACH;;AAEDqD,QAAAA,YAAY,GAAG,KAAKvE,UAAL,CAAgBkB,UAAhB,EAA4BC,WAA5B,CAAf;;AACA,YAAI,CAACoD,YAAL,EAAmB;AACf,iBAAOhD,SAAP;AACH;;AAED,eAAOgD,YAAY,CAACP,WAAD,CAAZ,IAA8BC,WAAW,IAAIM,YAAY,CAACP,WAAD,CAAhE;AACH,OAfW,CAAZ;;AAiBA,UAAIQ,KAAK,KAAK,CAAC,CAAf,EAAkB;AACd,YAAIL,cAAJ,EAAoB;AAChB,gBAAM,IAAIlE,KAAJ,CAAW,GAAE+D,WAAY,KAAIC,WAAY,gDAA+CF,aAAa,CAAC3C,EAAG,EAAzG,CAAN;AACH;;AAED,eAAOG,SAAP;AACH;AACJ;;AAED,QAAIoD,aAAa,GAAGX,WAAW,GAAG,GAAd,GAAoBC,WAApB,GAAkC,GAAlC,GAAwCM,YAAY,CAACnD,EAAzE;;AACA,QAAIuD,aAAa,IAAI,KAAKvF,cAA1B,EAA0C;AAEtC,aAAQ,KAAKA,cAAL,CAAoBkE,QAApB,IAAgC,KAAKlE,cAAL,CAAoBuF,aAApB,CAAxC;AACH;;AAED,SAAKtF,yBAAL,CAA+BiE,QAA/B,IAA2CiB,YAAY,CAACnD,EAAxD;AAGA,QAAIwD,WAAW,GAAGL,YAAY,CAACP,WAAD,CAAZ,CAA0BC,WAA1B,CAAlB;AACA,QAAIY,OAAJ;;AAEA,QAAIb,WAAW,KAAK5G,SAAS,CAACM,OAAV,CAAkBC,MAAlC,IAA4C,KAAK2B,cAAL,CAAoB2C,GAApB,CAAwBgC,WAAxB,CAAhD,EAAsF;AAClFa,MAAAA,OAAO,CAACtF,GAAR,CAAY,uCAAZ,EAAqDyE,WAArD;AACA,WAAK9B,WAAL;AACH;;AAED,QAAI6B,WAAW,IAAIvG,iBAAnB,EAAsC;AAElC,UAAIsH,YAAY,GAAGtH,iBAAiB,CAACuG,WAAD,CAApC;AAEAa,MAAAA,OAAO,GAAG,IAAIE,YAAJ,CAAiB,IAAjB,EAAuBd,WAAvB,EAAoCM,YAApC,EAAkDK,WAAlD,CAAV;AACAC,MAAAA,OAAO,CAAChF,IAAR;AACH,KAND,MAMO;AACH,UAAImE,WAAW,KAAK5G,SAAS,CAACM,OAAV,CAAkB0E,IAAtC,EAA4C;AACxCyC,QAAAA,OAAO,GAAG,EACN,GAAGD,WADG;AAENpD,UAAAA,UAAU,EAAE+C;AAFN,SAAV;AAIH,OALD,MAKO;AACHM,QAAAA,OAAO,GAAGD,WAAV;AACH;AACJ;;AAED,SAAKxF,cAAL,CAAoBuF,aAApB,IAAqCE,OAArC;AACA,SAAKzF,cAAL,CAAoBkE,QAApB,IAAgCuB,OAAhC;AAEA,WAAOA,OAAP;AACH;;AAEDpD,EAAAA,QAAQ,CAACuD,OAAD,EAAU7D,WAAV,EAAuB;AAC3B,QAAIN,MAAJ;;AAEA,QAAImE,OAAO,CAACC,QAAR,CAAiB,OAAjB,CAAJ,EAA+B;AAC3BpE,MAAAA,MAAM,GAAGmE,OAAT;AACAA,MAAAA,OAAO,GAAGA,OAAO,CAACE,MAAR,CAAe,CAAf,EAAkBF,OAAO,CAACG,MAAR,GAAiB,CAAnC,CAAV;AACH,KAHD,MAGO;AACHtE,MAAAA,MAAM,GAAGmE,OAAO,GAAG,OAAnB;AACH;;AAED,QAAII,GAAJ,EAASC,SAAT;;AAEA,QAAI,KAAKhH,aAAT,EAAwB;AACpB,UAAI,CAACvB,EAAE,CAACwE,UAAH,CAAcT,MAAd,CAAL,EAA4B;AACxB,cAAM,IAAIZ,KAAJ,CAAW,0CAAyCY,MAAO,cAA3D,CAAN;AACH;;AAEDuE,MAAAA,GAAG,GAAGtI,EAAE,CAACwI,YAAH,CAAgBzE,MAAhB,CAAN;AACAwE,MAAAA,SAAS,GAAGvH,eAAe,GAAG,OAA9B;AACH,KAPD,MAOO;AACH,UAAI;AACAsH,QAAAA,GAAG,GAAGlI,UAAU,CAACqI,KAAX,CAAiBzI,EAAE,CAAC0I,YAAH,CAAgBR,OAAhB,EAAyB,MAAzB,CAAjB,CAAN;AACH,OAFD,CAEE,OAAOS,KAAP,EAAc;AACZ,cAAM,IAAIxF,KAAJ,CAAW,sBAAsB+E,OAAS,OAAOS,KAAK,CAACC,OAAN,IAAiBD,KAAO,EAAzE,CAAN;AACH;;AAED,UAAI,CAACL,GAAL,EAAU;AACN,cAAM,IAAInF,KAAJ,CAAU,6CAA6C+E,OAAvD,CAAN;AACH;;AAEDK,MAAAA,SAAS,GAAGvH,eAAZ;AACH;;AAED,QAAI6H,QAAQ,GAAGjJ,IAAI,CAACkJ,QAAL,CAAcZ,OAAd,EAAuBlH,eAAvB,CAAf;AAEA,QAAI4G,SAAS,GAAG,EAAhB;AAEA,QAAImB,WAAW,GAAGnJ,IAAI,CAACoJ,OAAL,CAAad,OAAb,CAAlB;;AAQA,aAASe,QAAT,CAAkBC,UAAlB,EAA8BC,EAA9B,EAAkC3H,SAAlC,EAA6C6C,WAA7C,EAA0D;AACtD,UAAI+E,KAAK,GAAGpJ,EAAE,CAACqJ,QAAH,CAAYF,EAAZ,CAAZ;;AAGA,UAAIC,KAAK,CAACE,MAAN,MAAkBH,EAAE,CAAChB,QAAH,CAAYI,SAAZ,CAAtB,EAA8C;AAC1C,YAAIlE,WAAJ,EAAiB;AACb6E,UAAAA,UAAU,CAACnD,IAAX,CAAgB,CAACoD,EAAD,EAAK9E,WAAL,CAAhB;AACH,SAFD,MAEO;AACH6E,UAAAA,UAAU,CAACnD,IAAX,CAAgBoD,EAAhB;AACH;;AAED;AACH;;AAED,UAAIC,KAAK,CAACG,WAAN,MAAuB/H,SAA3B,EAAsC;AAElC,YAAIgI,KAAK,GAAGxJ,EAAE,CAACyJ,WAAH,CAAeN,EAAf,CAAZ;AACAK,QAAAA,KAAK,CAACE,OAAN,CAAcC,CAAC,IAAIV,QAAQ,CAACC,UAAD,EAAatJ,IAAI,CAAC+B,IAAL,CAAUwH,EAAV,EAAcQ,CAAd,CAAb,EAA+B,IAA/B,EAAqCtF,WAArC,CAA3B;AACH;AACJ;;AAED,QAAIiE,GAAG,CAACV,SAAR,EAAmB;AACfU,MAAAA,GAAG,CAACV,SAAJ,CAAc8B,OAAd,CAAsBP,EAAE,IAAI;AACxB,YAAIS,CAAJ;AACA,YAAIvF,WAAJ;AAEA,cAAMwF,UAAU,GAAGV,EAAE,CAACW,OAAH,CAAW,GAAX,CAAnB;;AACA,YAAID,UAAU,GAAG,CAAjB,EAAoB;AAEhBxF,UAAAA,WAAW,GAAG8E,EAAE,CAACY,SAAH,CAAa,CAAb,EAAgBF,UAAhB,CAAd;AACA,gBAAMG,OAAO,GAAG,KAAK5H,YAAL,CAAkBiC,WAAlB,CAAhB;;AAEA,cAAI2F,OAAO,IAAI,IAAf,EAAqB;AACjB,kBAAM,IAAI7G,KAAJ,CAAW,YAAWkB,WAAY,gEAA+D6D,OAAQ,EAAzG,CAAN;AACH;;AAEDiB,UAAAA,EAAE,GAAGvJ,IAAI,CAAC+B,IAAL,CAAUqI,OAAV,EAAmBb,EAAE,CAACY,SAAH,CAAaF,UAAU,GAAC,CAAxB,CAAnB,CAAL;AACH;;AAED,YAAIV,EAAE,CAAChB,QAAH,CAAY,IAAZ,CAAJ,EAAuB;AACnByB,UAAAA,CAAC,GAAGhK,IAAI,CAACsB,OAAL,CAAa6H,WAAb,EAA0BI,EAAE,CAACf,MAAH,CAAU,CAAV,EAAae,EAAE,CAACd,MAAH,GAAY,CAAzB,CAA1B,CAAJ;AACA,cAAImB,KAAK,GAAGxJ,EAAE,CAACyJ,WAAH,CAAeG,CAAf,CAAZ;AACAJ,UAAAA,KAAK,CAACE,OAAN,CAAcC,CAAC,IAAIV,QAAQ,CAACrB,SAAD,EAAYhI,IAAI,CAAC+B,IAAL,CAAUiI,CAAV,EAAaD,CAAb,CAAZ,EAA6B,KAA7B,EAAoCtF,WAApC,CAA3B;AACH,SAJD,MAIO,IAAI8E,EAAE,CAAChB,QAAH,CAAY,KAAZ,CAAJ,EAAwB;AAC3ByB,UAAAA,CAAC,GAAGhK,IAAI,CAACsB,OAAL,CAAa6H,WAAb,EAA0BI,EAAE,CAACf,MAAH,CAAU,CAAV,EAAae,EAAE,CAACd,MAAH,GAAY,CAAzB,CAA1B,CAAJ;AACA,cAAImB,KAAK,GAAGxJ,EAAE,CAACyJ,WAAH,CAAeG,CAAf,CAAZ;AACAJ,UAAAA,KAAK,CAACE,OAAN,CAAcC,CAAC,IAAIV,QAAQ,CAACrB,SAAD,EAAYhI,IAAI,CAAC+B,IAAL,CAAUiI,CAAV,EAAaD,CAAb,CAAZ,EAA6B,IAA7B,EAAmCtF,WAAnC,CAA3B;AACH,SAJM,MAIA;AACH8E,UAAAA,EAAE,GAAGvJ,IAAI,CAACsB,OAAL,CAAa6H,WAAb,EAA0BjJ,CAAC,CAACqI,QAAF,CAAWgB,EAAX,EAAenI,eAAf,IAAkCmI,EAAlC,GAAuCA,EAAE,GAAGnI,eAAtE,CAAL;;AACA,cAAIqD,WAAJ,EAAiB;AACbuD,YAAAA,SAAS,CAAC7B,IAAV,CAAe,CAACoD,EAAD,EAAK9E,WAAL,CAAf;AACH,WAFD,MAEO;AACHuD,YAAAA,SAAS,CAAC7B,IAAV,CAAeoD,EAAf;AACH;AACJ;AACJ,OAjCD;AAkCH;;AAEDb,IAAAA,GAAG,CAACV,SAAJ,GAAgBA,SAAhB;AAEAU,IAAAA,GAAG,CAAChE,EAAJ,GAAS,KAAKC,iBAAL,CAAuB2D,OAAvB,CAAT;;AACA,QAAI7D,WAAJ,EAAiB;AACbiE,MAAAA,GAAG,CAACjE,WAAJ,GAAkBA,WAAlB;AACH;;AACDiE,IAAAA,GAAG,CAACzD,IAAJ,GAAWgE,QAAX;;AAEA,QAAI,CAAC,KAAKtH,aAAN,IAAuB,KAAKW,gBAAhC,EAAkD;AAC9ClC,MAAAA,EAAE,CAACgE,aAAH,CAAiBD,MAAjB,EAAyBE,IAAI,CAACC,SAAL,CAAeoE,GAAf,EAAoB,IAApB,EAA0B,CAA1B,CAAzB;AACH;;AAED,WAAOA,GAAP;AACH;;AAzeQ;;AA4eb2B,MAAM,CAACC,OAAP,GAAiB9I,MAAjB","sourcesContent":["\"use strict\";\n\nconst path = require('path');\nconst { _, arrayToObject } = require('@genx/july');\nconst { fs, glob } = require('@genx/sys');\nconst { Types } = require('@genx/data');\n\nconst Geml = require('./grammar/geml');\nconst GemlParser = Geml.parser;\nconst GemlTypes = require('./GemlTypes');\nconst Entity = require('./Entity');\nconst Schema = require('./Schema');\nconst View = require('./View');\nconst Dataset = require('./Dataset');\n\nconst ELEMENT_CLASS_MAP = {\n    [GemlTypes.Element.ENTITY]: Entity,\n    [GemlTypes.Element.VIEW]: View,\n    [GemlTypes.Element.DATASET]: Dataset,\n};\n\nconst GEML_SOURCE_EXT = '.geml';\nconst BUILTINS_PATH = path.resolve(__dirname, 'builtins');\n\n/**\n * Linker of geml\n * @class GemlLinker\n */\nclass Linker {\n    static getGemlFiles(sourceDir, useJsonSource, recursive) {\n        let pattern = '*' + GEML_SOURCE_EXT;\n\n        if (useJsonSource) {\n            pattern += '.json';\n        }\n\n        if (recursive) {\n            pattern = '**/' + pattern;\n        }\n\n        return glob.sync(path.join(sourceDir, pattern), {nodir: true});\n    }\n\n    /**\n     * @param {ServiceContainer} app \n     * @param {object} context\n     * @property {string} context.gemlPath - Geml source files path     \n     * @property {bool} [context.useJsonSource=false] - Use .json intermediate source file instead of .ool\n     * @property {bool} [context.saveIntermediate=false] - Save intermediate source file while linking\n     */\n    constructor(app, context) {\n        /**\n         * App\n         * @member {ServiceContainer}\n         */\n        this.app = app;\n\n        /**\n         * Geml source files path\n         * @member {string}\n         */\n        this.sourcePath = context.gemlPath;\n\n        /**\n         * Use json or ols\n         * @member {bool}\n         */\n        this.useJsonSource = context.useJsonSource;\n\n        /**\n         * Save intermediate files\n         * @member {bool}\n         */\n        this.saveIntermediate = context.saveIntermediate;\n\n        /**\n         * Linked schemas\n         * @member {object.<string, Schema>}\n         */\n        this.schemas = {};\n\n        /**\n         * Dependent packages\n         * @member {object.<string, string>}\n         */\n        this.dependencies = context.dependencies ?? {};\n\n        /**\n         * Parsed oolong files, path => module\n         * @member {object}\n         * @private\n         */\n        this._gemlModules = {};\n\n        /**\n         * Element cache, map of <referenceId, element> and <selfId, element>\n         * @member {object} \n         * @private\n         */\n        this._elementsCache = {};\n\n        /**\n         * Map of <referenceId, moduleId>\n         * @member {object}\n         * @private\n         */\n        this._mapOfReferenceToModuleId = {};\n\n        /**\n         * Set of entitties to be overrided\n         */\n        this.entityOverride = new Set();\n    }\n\n    /**\n     * Write log\n     * @param {string} level\n     * @param {string} message\n     * @param {object} [data]\n     */\n    log(...args) {\n        this.app.log(...args);\n    }\n\n    /**\n     * Check whether a module is loaded\n     * @param {string} moduleId\n     * @returns {boolean}\n     */\n    isModuleLoaded(moduleId) {\n        return (moduleId in this._gemlModules);\n    }\n\n    /**\n     * Get a loaded oolone module\n     * @param {string} moduleId\n     * @returns {object}\n     */\n    getModuleById(moduleId) {\n        return this._gemlModules[moduleId];\n    }\n\n    /**\n     * Start linking oolong files\n     * @param {string} entryFileName\n     */\n    link(entryFileName) {\n        // compile entry file        \n        let entryModule = this.loadModule(entryFileName);\n\n        if (!entryModule) {\n            throw new Error(`Cannot resolve file \"${entryFileName}\".`);\n        }\n\n        // see if there is customization rules\n        if (!_.isEmpty(entryModule.overrides?.entities)) {\n            this.entityOverride = new Set(entryModule.overrides.entities.map(item => item.entity)); \n        }\n\n        if (_.isEmpty(entryModule.schema)) {\n            throw new Error('No schema defined in entry file.');\n        }\n\n        _.forOwn(entryModule.schema, (schemaInfo, schemaName) => {            \n            let schema = new Schema(this, schemaName, entryModule, schemaInfo);\n            schema.link();\n\n            if (this.schemas.hasOwnProperty(schemaName)) {\n                throw new Error(`Duplicate schema: \"${schemaName}\".`);\n            }\n            this.schemas[schemaName] = schema;\n\n            if (this.saveIntermediate) {\n                let jsFile = path.resolve(this.sourcePath, entryFileName + '-linked.json');\n                fs.writeFileSync(jsFile, JSON.stringify(schema.toJSON(), null, 4));\n            }\n        });     \n    }\n\n    /**\n     * Load a oolong module, return undefined if not exist\n     * @param {string} modulePath\n     * @returns {*}\n     */\n    loadModule(modulePath, packageName) {        \n        modulePath = path.resolve(this.sourcePath, modulePath);\n\n        let id = this.getModuleIdByPath(modulePath);\n\n        if (this.isModuleLoaded(id)) {\n            return this.getModuleById(id);\n        }\n\n        if (!fs.existsSync(modulePath)) {\n            return undefined;\n        }       \n\n        let gemlModule = this._compile(modulePath, packageName);\n\n        return (this._gemlModules[id] = gemlModule);\n    }\n\n    getTypeInfo(name, location) {\n        const gemlModule = this.getModuleById(location);\n        return gemlModule.type[name];\n    }\n\n    /**\n     * Track back the type derived chain.\n     * @param {object} gemlModule\n     * @param {object} info\n     * @returns {Array} [ derivedInfo, baseInfo ]\n     */\n    trackBackType(gemlModule, info) {\n        if (Types.Builtin.has(info.type)) {\n            return [ info ];\n        }\n\n        let baseInfo = this.loadElement(gemlModule, GemlTypes.Element.TYPE, info.type, true);\n        let backupBaseInfo = baseInfo.type !== info.type ? baseInfo : null;\n\n        if (!Types.Builtin.has(baseInfo.type)) {\n            //the base type is not a builtin type\n            let ownerModule = baseInfo.gemlModule;  \n\n            let [ rootTypeInfo ] = this.trackBackType(ownerModule, baseInfo);\n\n            ownerModule.type[baseInfo.type] = rootTypeInfo;\n            baseInfo = rootTypeInfo;            \n        } else {\n            backupBaseInfo = null;\n        }\n\n        let derivedInfo = { ..._.cloneDeep(_.omit(baseInfo, ['gemlModule', 'modifiers'])), ..._.omit(info, ['gemlModule', 'type', 'modifiers'])};\n        if (baseInfo.modifiers || info.modifiers) {\n            derivedInfo.modifiers = [ ...(baseInfo.modifiers || []), ...(info.modifiers || []) ];\n        }\n\n        if (!derivedInfo.subClass) {\n            derivedInfo.subClass = [];\n        }\n        derivedInfo.subClass.push(info.type);\n        return [ derivedInfo, backupBaseInfo ];\n    }    \n    \n    /**\n     * Translate an value by inferring all the references.\n     * @param {object} gemlModule \n     * @param {*} value \n     * @returns {*} - Translated value.\n     */\n    translateOolValue(gemlModule, value) {\n        if (_.isPlainObject(value)) {\n            if (value.oolType === GemlTypes.Lang.CONST_REF) {                \n                let refedValue = this.loadElement(gemlModule, GemlTypes.Element.CONST, value.name, true);\n                let uniqueId = this.getElementUniqueId(gemlModule, GemlTypes.Element.CONST, value.name);\n                let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId[uniqueId]);\n                return this.translateOolValue(ownerModule, refedValue);\n            } else if (value.oolType) {\n                throw new Error(`todo: translateOolValue with type: ${value.oolType}`)\n            }\n\n            return _.mapValues(value, v => this.translateOolValue(gemlModule, v));\n        }\n\n        if (Array.isArray(value)) {\n            return value.map(v => this.translateOolValue(gemlModule, v));\n        }\n\n        return value;\n    }\n\n    /**\n     * Get the unique module id by source file path.\n     * @param {string} modulePath - The path of an oolong source file.\n     * @returns {string} - The module id.\n     */\n    getModuleIdByPath(modulePath) {        \n        let isBuiltinEntity = _.startsWith(modulePath, BUILTINS_PATH);      \n        return isBuiltinEntity ? \n            path.relative(BUILTINS_PATH, modulePath) : \n            './' + path.relative(this.sourcePath, modulePath);  \n    }\n\n    /**\n     * Get the unique name of an element.\n     * @param {object} refererModule \n     * @param {string} elementType \n     * @param {string} elementName \n     * @returns {string} - The unique name of an element.\n     */\n    getElementUniqueId(refererModule, elementType, elementName) {\n        return elementType + ':' + elementName + '<-' + refererModule.id;\n    }\n\n    loadEntity(refererModule, elementName, throwOnMissing = true) {\n        return this.loadElement(refererModule, GemlTypes.Element.ENTITY, elementName, throwOnMissing);        \n    }\n\n    loadType(refererModule, elementName, throwOnMissing = true) {\n        return this.loadElement(refererModule, GemlTypes.Element.TYPE, elementName, throwOnMissing);\n    }\n\n    loadDataset(refererModule, elementName, throwOnMissing = true) {\n        return this.loadElement(refererModule, GemlTypes.Element.DATASET, elementName, throwOnMissing);\n    }\n\n    loadView(refererModule, elementName, throwOnMissing = true) {\n        return this.loadElement(refererModule, GemlTypes.Element.VIEW, elementName, throwOnMissing);\n    }\n\n    /**\n     * Load an element based on the namespace chain.\n     * @param {object} refererModule \n     * @param {string} elementType \n     * @param {string} elementName \n     */\n    loadElement(refererModule, elementType, elementName, throwOnMissing) {\n        // the element id with type, should be unique among the whole schema\n        let uniqueId = this.getElementUniqueId(refererModule, elementType, elementName);\n\n        // the element id + referer\n        if (uniqueId in this._elementsCache) {\n            return this._elementsCache[uniqueId];\n        }\n\n        let targetModule;        \n\n        if (elementType in refererModule && elementName in refererModule[elementType]) {\n            // see if it exists in the same module                        \n            targetModule = refererModule;\n        } else {\n            // search reversely by the namespaces\n            //this.log('verbose', `Searching ${elementType} \"${elementName}\" from \"${refererModule.id}\" ...`);\n\n            let index = _.findLastIndex(refererModule.namespace, modulePath => {\n                //this.log('debug', `Looking for ${elementType} \"${elementName}\" in \"${modulePath}\" ...`);\n                let packageName;\n\n                if (Array.isArray(modulePath)) {\n                    packageName = modulePath[1]; \n                    modulePath = modulePath[0];     \n                }\n                \n                targetModule = this.loadModule(modulePath, packageName);\n                if (!targetModule) {\n                    return undefined;\n                }\n      \n                return targetModule[elementType] && (elementName in targetModule[elementType]);                \n            });\n\n            if (index === -1) {   \n                if (throwOnMissing) {             \n                    throw new Error(`${elementType} \"${elementName}\" not found in imported namespaces. Referer: ${refererModule.id}`);\n                }\n\n                return undefined;\n            }\n        }\n\n        let elementSelfId = elementType + ':' + elementName + '@' + targetModule.id;\n        if (elementSelfId in this._elementsCache) {\n            // already initialized            \n            return (this._elementsCache[uniqueId] = this._elementsCache[elementSelfId]);\n        }\n       \n        this._mapOfReferenceToModuleId[uniqueId] = targetModule.id;\n\n        // retrieve the compiled info\n        let elementInfo = targetModule[elementType][elementName];\n        let element;\n\n        if (elementType === GemlTypes.Element.ENTITY && this.entityOverride.has(elementName)) {    \n            console.log('overrides ---------------------------', elementName);\n            this.loadElement()\n        }\n\n        if (elementType in ELEMENT_CLASS_MAP) {\n            // element need linking\n            let ElementClass = ELEMENT_CLASS_MAP[elementType];            \n\n            element = new ElementClass(this, elementName, targetModule, elementInfo);   \n            element.link();             \n        } else {\n            if (elementType === GemlTypes.Element.TYPE) {\n                element = {\n                    ...elementInfo,\n                    gemlModule: targetModule\n                };\n            } else {\n                element = elementInfo;\n            }            \n        }\n\n        this._elementsCache[elementSelfId] = element;\n        this._elementsCache[uniqueId] = element;\n        \n        return element;\n    }\n\n    _compile(oolFile, packageName) {\n        let jsFile;\n        \n        if (oolFile.endsWith('.json')) {\n            jsFile = oolFile;\n            oolFile = oolFile.substr(0, oolFile.length - 5);\n        } else {\n            jsFile = oolFile + '.json';\n        }                \n        \n        let ool, searchExt;\n\n        if (this.useJsonSource) {\n            if (!fs.existsSync(jsFile)) {\n                throw new Error(`\"useJsonSource\" enabeld but json file \"${jsFile}\" not found.`);\n            }\n\n            ool = fs.readJsonSync(jsFile);\n            searchExt = GEML_SOURCE_EXT + '.json';\n        } else {\n            try {\n                ool = GemlParser.parse(fs.readFileSync(oolFile, 'utf8'));\n            } catch (error) {\n                throw new Error(`Failed to compile \"${ oolFile }\".\\n${ error.message || error }`)\n            }\n\n            if (!ool) {\n                throw new Error('Unknown error occurred while compiling: ' + oolFile);\n            }       \n            \n            searchExt = GEML_SOURCE_EXT;\n        }\n\n        let baseName = path.basename(oolFile, GEML_SOURCE_EXT);\n\n        let namespace = [];\n\n        let currentPath = path.dirname(oolFile);\n\n        /**\n         * \n         * @param {*} namespaces - Searching path\n         * @param {string} ns - Import line\n         * @param {*} recursive \n         */\n        function expandNs(namespaces, ns, recursive, packageName) {\n            let stats = fs.statSync(ns);\n\n            //import '/path/user.ool'\n            if (stats.isFile() && ns.endsWith(searchExt)) {\n                if (packageName) {\n                    namespaces.push([ns, packageName]);\n                } else {\n                    namespaces.push(ns);\n                }\n                \n                return;\n            }\n\n            if (stats.isDirectory() && recursive) {\n                //resursive expand sub-directory\n                let files = fs.readdirSync(ns);\n                files.forEach(f => expandNs(namespaces, path.join(ns, f), true, packageName));\n            }\n        }\n\n        if (ool.namespace) {\n            ool.namespace.forEach(ns => {\n                let p;\n                let packageName;\n\n                const packageSep = ns.indexOf(':');\n                if (packageSep > 0) {\n                    //reference to a package\n                    packageName = ns.substring(0, packageSep);\n                    const pkgPath = this.dependencies[packageName];\n\n                    if (pkgPath == null) {\n                        throw new Error(`Package \"${packageName}\" not found in geml dependencies settings. Failed to compile ${oolFile}`);\n                    }     \n                    \n                    ns = path.join(pkgPath, ns.substring(packageSep+1));\n                }\n\n                if (ns.endsWith('/*')) {\n                    p = path.resolve(currentPath, ns.substr(0, ns.length - 2));\n                    let files = fs.readdirSync(p);\n                    files.forEach(f => expandNs(namespace, path.join(p, f), false, packageName));\n                } else if (ns.endsWith('/**')) {\n                    p = path.resolve(currentPath, ns.substr(0, ns.length - 3));\n                    let files = fs.readdirSync(p);\n                    files.forEach(f => expandNs(namespace, path.join(p, f), true, packageName));\n                } else {\n                    ns = path.resolve(currentPath, _.endsWith(ns, GEML_SOURCE_EXT) ? ns : ns + GEML_SOURCE_EXT);\n                    if (packageName) {\n                        namespace.push([ns, packageName]);\n                    } else {\n                        namespace.push(ns);\n                    }                    \n                }\n            });\n        }\n\n        ool.namespace = namespace;\n\n        ool.id = this.getModuleIdByPath(oolFile);        \n        if (packageName) {\n            ool.packageName = packageName;\n        }\n        ool.name = baseName;       \n        \n        if (!this.useJsonSource && this.saveIntermediate) {                 \n            fs.writeFileSync(jsFile, JSON.stringify(ool, null, 4));\n        }\n\n        return ool;\n    }\n}\n\nmodule.exports = Linker;"],"file":"Linker.js"}
{"version":3,"sources":["../../src/lang/View.js"],"names":["_","require","generateDisplayName","deepCloneField","Clonable","Dataset","View","constructor","linker","name","gemlModule","info","link","pre","linked","dataset","loadDoc","assert","entity","mainEntity","getReferencedEntity","isList","isEmpty","accept","params","concat","selectBy","groupBy","orderBy","skip","isPlainObject","Object","assign","limit","inferTypeInfo","inSchema","inferredParams","forEach","param","GemlUtils","isMemberAccess","type","entityName","fieldName","split","hasEntity","Error","entities","field","getEntityAttribute","push","omit","toPlainObject","typeInfo","baseInfo","trackBackType","getDocumentHierarchy","getDocumentHierachy","clone","view","toJSON","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nconst { _ } = require('@genx/july');\nconst { generateDisplayName, deepCloneField, Clonable } = require('./GemlUtils');\n\nconst Dataset = require('./Dataset');\n\n/**\n * Geml view class.\n * @class View\n */\nclass View extends Clonable {\n\n    isList = false;\n\n    /**          \n     * @param {Linker} linker\n     * @param {string} name - View name\n     * @param {object} gemlModule - Source ool module\n     * @param {object} info - View info\n     */\n    constructor(linker, name, gemlModule, info) {\n        /**\n         * Linker to process this view\n         * @member {Linker}\n         */\n        this.linker = linker;\n\n        /**\n         * Name of this view\n         * @member {string}\n         */\n        this.name = name;\n\n        /**\n         * Owner geml module\n         * @member {object}\n         */\n        this.gemlModule = gemlModule;\n\n        /**\n         * Raw metadata\n         * @member {Object}\n         */\n        this.info = info;        \n    }\n\n    /**\n     * Start linking this view\n     * @returns {View}\n     */\n    link() {\n        pre: !this.linked;\n\n        if (this.info.dataset) {\n            this.dataset = this.linker.loadDoc(this.gemlModule, this.info.dataset);\n        } else {\n            assert: this.info.entity, 'Invalid view syntax!';\n            \n            let mainEntity = this.linker.getReferencedEntity(this.gemlModule, this.info.entity);\n            \n            this.dataset = new Dataset(this.linker, mainEntity.name, this.gemlModule, { mainEntity: mainEntity.name });\n            this.dataset.link();\n        }\n\n        if (this.info.isList) {\n            this.isList = true;\n        }\n\n        if (!_.isEmpty(this.info.accept)) {\n            this.params = this.info.accept.concat();\n        }\n\n        if (!_.isEmpty(this.info.selectBy)) {\n            this.selectBy = this.info.selectBy.concat();\n        }\n\n        if (!_.isEmpty(this.info.groupBy)) {\n            this.groupBy = this.info.groupBy.concat();\n        }\n\n        if (!_.isEmpty(this.info.orderBy)) {\n            this.orderBy = this.info.orderBy.concat();\n        }\n\n        if (this.info.skip) {\n            this.skip = _.isPlainObject(this.info.skip) ? Object.assign({}, this.info.skip) : this.info.skip;\n        }\n\n        if (this.info.limit) {\n            this.limit = _.isPlainObject(this.info.limit) ? Object.assign({}, this.info.limit) : this.info.limit;\n        }\n\n        this.linked = true;\n\n        return this;\n    }\n\n    inferTypeInfo(inSchema) {\n        if (!_.isEmpty(this.params)) {\n            let inferredParams = [];\n\n            this.params.forEach(param => {\n                if (GemlUtils.isMemberAccess(param.type)) {\n                    let [ entityName, fieldName ] = param.type.split('.');\n\n                    if (!inSchema.hasEntity(entityName)) {\n                        throw new Error(`Parameter \"${param.name}\" references to an entity \"${entityName}\" which is not belong to the schema.`);\n                    }\n\n                    let entity = inSchema.entities[entityName];\n                    //console.dir(entity.toJSON(), {depth: 8, colors: true});\n\n                    let field = entity.getEntityAttribute(fieldName);\n                    inferredParams.push(Object.assign(_.omit(_.toPlainObject(field), ['isReference', 'optional', 'displayName']), {name: param.name}));\n                } else {\n                    const [ typeInfo, baseInfo ] = this.linker.trackBackType(this.gemlModule, param);\n                    inferredParams.push(typeInfo);\n                }\n            });\n\n            this.params = inferredParams;\n        }\n    }\n\n    getDocumentHierarchy(inSchema) {\n        return inSchema.getDocumentHierachy(this.gemlModule, this.dataset.name);\n    }\n\n    /**\n     * Clone the view     \n     * @returns {View}\n     */\n    clone() {\n        super.clone();\n        \n        let view = new View(this.linker, this.name, this.gemlModule, this.info);\n\n        deepCloneField(this, view, 'dataset');\n        deepCloneField(this, view, 'params');\n        deepCloneField(this, view, 'selectBy');\n        deepCloneField(this, view, 'groupBy');\n        deepCloneField(this, view, 'orderBy');\n        deepCloneField(this, view, 'skip');\n        deepCloneField(this, view, 'limit');\n\n        view.isList = this.isList;\n        view.linked = true;\n\n        return view;\n    }\n    \n    /**\n     * Translate the view into a plain JSON object\n     * @returns {object}\n     */\n    toJSON() {\n        return {            \n            name: this.name,\n            dataset: this.dataset.toJSON(),\n            isList: this.isList,\n            params: this.params,\n            selectBy: this.selectBy,\n            groupBy: this.groupBy,\n            orderBy: this.orderBy,\n            skip: this.skip,\n            limit: this.limit\n        };\n    }\n}\n\nmodule.exports = View;"],"file":"View.js"}
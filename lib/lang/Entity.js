"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  deepClone,
  Clonable,
  entityNaming
} = require('./GemlUtils');

const Field = require('./Field');

const {
  Types: {
    FunctionalQualifiers
  }
} = require('@genx/data');

class Entity extends Clonable {
  constructor(linker, name, gemlModule, info) {
    super();
    this.fields = {};
    this._events = new EventEmitter();
    this.linker = linker;
    this.name = entityNaming(name);
    this.gemlModule = gemlModule;
    this.info = info;
  }

  once(eventName, listener) {
    return this._events.once(eventName, listener);
  }

  link() {
    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.code) {
      this.code = this.info.code || this.name;
    }

    if (this.info.base) {
      let baseClasses = _.castArray(this.info.base);

      baseClasses.reverse().forEach(base => {
        let baseEntity = this.linker.loadEntity(this.gemlModule, base);

        this._inherit(baseEntity);
      });
      this.baseClasses = baseClasses;
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn;

        try {
          fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));
        } catch (err) {
          if (err.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Unknow feature "${featureName}" reference in entity "${this.name}"`);
          }
        }

        fn(this, this.linker.translateOolValue(this.gemlModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    if (this.info.inputs) {
      this.inputs = this.info.inputs;
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.gemlModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = field;

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          if (Array.isArray(this.key)) {
            throw new Error('Combination key not support for accesor "$key".');
          }

          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, props) {
    if (!this.associations) {
      this.associations = {};
    }

    if (name in this.associations) {
      throw new Error(`Association "${name}" already exists in entity "${this.name}". Props: ` + JSON.stringify(props));
    }

    this.associations[name] = props;
  }

  addAssocField(name, destEntity, destField, extraProps) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField.toJSON(), FunctionalQualifiers);

    Object.assign(destFieldInfo, extraProps);
    this.addField(name, destFieldInfo);
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.gemlModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. An entity can only have one "${name}" feature only.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  hasFeature(name) {
    return this.features && name in this.features;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferencedEntity(entityName) {
    return this.linker.loadEntity(this.gemlModule, entityName);
  }

  getReferenceTo(entityName, includes, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (includes) {
        if (_.find(includes, (value, prop) => typeof value === 'function' ? !value(assoc[prop]) : !_.isEqual(assoc[prop], value))) return false;
      }

      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
        if (excludes.props && _.find(excludes.props, prop => assoc[prop])) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.gemlModule, this.info);
    deepCloneField(this, entity, 'code');
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'inputs');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      code: this.code,
      displayName: this.displayName,
      comment: this.comment,
      ...(this.baseClasses ? {
        baseClasses: this.baseClasses
      } : {}),
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    let overrideInfo = {};

    if (baseEntity.baseClasses) {
      let baseClasses = baseEntity.baseClasses;

      if (this.baseClasses) {
        this.baseClasses = _.uniq(baseClasses.concat(this.baseClasses));
      } else {
        this.baseClasses = baseClasses.concat();
      }
    }

    if (!_.isEmpty(baseEntity.info.features)) {
      let baseFeatures = _.cloneDeep(baseEntity.info.features);

      if (this.info.features) {
        overrideInfo.features = baseFeatures.concat(this.info.features);
      } else {
        overrideInfo.features = baseFeatures;
      }
    }

    if (!_.isEmpty(baseEntity.info.fields)) {
      let fields = _.cloneDeep(baseEntity.info.fields);

      overrideInfo.fields = { ...fields,
        ...this.info.fields
      };
    }

    if (baseEntity.info.key) {
      overrideInfo.key = baseEntity.info.key;
    }

    if (baseEntity.info.indexes) {
      let indexes = _.cloneDeep(baseEntity.info.indexes);

      if (this.info.indexes) {
        indexes = indexes.concat(this.info.indexes);
      }

      overrideInfo.indexes = indexes;
    }

    if (baseEntity.info.associations) {
      let assocs = _.cloneDeep(baseEntity.info.associations);

      assocs = assocs.map(assoc => {
        if (assoc.destEntity === baseEntity.name) {
          return { ...assoc,
            destEntity: this.name
          };
        }

        return assoc;
      });

      if (this.info.associations) {
        assocs = assocs.concat(this.info.associations);
      }

      overrideInfo.associations = assocs;
    }

    if (baseEntity.inputs) {
      overrideInfo.inputs = { ...baseEntity.inputs,
        ...this.info.inputs
      };
    }

    if (!_.isEmpty(overrideInfo)) {
      this.info = { ...this.info,
        ...overrideInfo
      };
    }
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJkZWVwQ2xvbmUiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsIkZpZWxkIiwiVHlwZXMiLCJGdW5jdGlvbmFsUXVhbGlmaWVycyIsIkVudGl0eSIsImNvbnN0cnVjdG9yIiwibGlua2VyIiwibmFtZSIsImdlbWxNb2R1bGUiLCJpbmZvIiwiZmllbGRzIiwiX2V2ZW50cyIsIm9uY2UiLCJldmVudE5hbWUiLCJsaXN0ZW5lciIsImxpbmsiLCJsb2ciLCJjb2RlIiwiYmFzZSIsImJhc2VDbGFzc2VzIiwiY2FzdEFycmF5IiwicmV2ZXJzZSIsImZvckVhY2giLCJiYXNlRW50aXR5IiwibG9hZEVudGl0eSIsIl9pbmhlcml0IiwiY29tbWVudCIsImRpc3BsYXlOYW1lIiwiZW1pdCIsImZlYXR1cmVzIiwiZmVhdHVyZSIsImZlYXR1cmVOYW1lIiwiZm4iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZXJyIiwiRXJyb3IiLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsImFyZ3MiLCJlYWNoIiwiZmllbGRJbmZvIiwiZmllbGROYW1lIiwiYWRkRmllbGQiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJpbnB1dHMiLCJpc0VtcHR5IiwiaW50ZXJmYWNlcyIsImNsb25lRGVlcCIsImZvck93biIsImludGYiLCJhY2NlcHQiLCJtYXAiLCJwYXJhbSIsInRyYWNrQmFja1R5cGUiLCJsaW5rZWQiLCJoYXNJbmRleE9uIiwiY29uY2F0Iiwic29ydCIsImZpbmRJbmRleCIsImluZGV4ZXMiLCJpbmRleCIsImYiLCJpZHgiLCJhZGRJbmRleGVzIiwiYWRkSW5kZXgiLCJmaWVsZCIsIm5vcm1hbGl6ZWRGaWVsZCIsImhhc0ZpZWxkIiwiam9pbiIsInB1c2giLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZElkIiwidG9rZW4iLCJzdWJzdHIiLCJldmVyeSIsImFkZEFzc29jaWF0aW9uIiwicHJvcHMiLCJhc3NvY2lhdGlvbnMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWRkQXNzb2NGaWVsZCIsImRlc3RFbnRpdHkiLCJkZXN0RmllbGQiLCJleHRyYVByb3BzIiwibG9jYWxGaWVsZCIsImRlc3RGaWVsZEluZm8iLCJvbWl0IiwidG9KU09OIiwiT2JqZWN0IiwiYXNzaWduIiwicmF3SW5mbyIsImNsb25lIiwiZnVsbFJhd0luZm8iLCJhZGRGZWF0dXJlIiwiYWxsb3dNdWx0aXBsZSIsImhhc0ZlYXR1cmUiLCJzZXRLZXkiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwiZW50aXR5TmFtZSIsImdldFJlZmVyZW5jZVRvIiwiaW5jbHVkZXMiLCJleGNsdWRlcyIsImZpbmQiLCJhc3NvYyIsInZhbHVlIiwicHJvcCIsImlzRXF1YWwiLCJhc3NvY2lhdGlvbiIsInR5cGUiLCJpbmRleE9mIiwidHlwZXMiLCJnZXRLZXlGaWVsZCIsImtmIiwiZW50aXR5IiwibWFwVmFsdWVzIiwib3ZlcnJpZGVJbmZvIiwidW5pcSIsImJhc2VGZWF0dXJlcyIsImFzc29jcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUE1Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUVBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFRRixPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUEsU0FBdkM7QUFBa0RDLEVBQUFBLFFBQWxEO0FBQTREQyxFQUFBQTtBQUE1RCxJQUE2RVAsT0FBTyxDQUFDLGFBQUQsQ0FBMUY7O0FBRUEsTUFBTVEsS0FBSyxHQUFHUixPQUFPLENBQUMsU0FBRCxD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SUFBSTtBQUN6QixZQUFJQSxLQUFLLENBQUN0QixVQUFOLEtBQXFCN0QsVUFBVSxDQUFDaEIsSUFBcEMsRUFBMEM7QUFDdEMsaUJBQU8sRUFDSCxHQUFHbUcsS0FEQTtBQUVIdEIsWUFBQUEsVUFBVSxFQUFFLEtBQUs3RTtBQUZkLFdBQVA7QUFJSDs7QUFFRCxlQUFPbUcsS0FBUDtBQUNILE9BVFEsQ0FBVDs7QUFXQSxVQUFJLEtBQUtqRyxJQUFMLENBQVV1RSxZQUFkLEVBQTRCO0FBQ3hCeUMsUUFBQUEsTUFBTSxHQUFHQSxNQUFNLENBQUM5RCxNQUFQLENBQWMsS0FBS2xELElBQUwsQ0FBVXVFLFlBQXhCLENBQVQ7QUFDSDs7QUFFRHNDLE1BQUFBLFlBQVksQ0FBQ3RDLFlBQWIsR0FBNEJ5QyxNQUE1QjtBQUNIOztBQUVELFFBQUlsRyxVQUFVLENBQUN3QixNQUFmLEVBQXVCO0FBQ25CdUUsTUFBQUEsWUFBWSxDQUFDdkUsTUFBYixHQUFzQixFQUFFLEdBQUd4QixVQUFVLENBQUN3QixNQUFoQjtBQUF3QixXQUFHLEtBQUt0QyxJQUFMLENBQVVzQztBQUFyQyxPQUF0QjtBQUNIOztBQUVELFFBQUksQ0FBQ3BELENBQUMsQ0FBQ3FELE9BQUYsQ0FBVXNFLFlBQVYsQ0FBTCxFQUE4QjtBQUMxQixXQUFLN0csSUFBTCxHQUFZLEVBQUUsR0FBRyxLQUFLQSxJQUFWO0FBQWdCLFdBQUc2RztBQUFuQixPQUFaO0FBQ0g7QUFDSjs7QUE3akJ5Qjs7QUFna0I5QkksTUFBTSxDQUFDQyxPQUFQLEdBQWlCdkgsTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IGdlbmVyYXRlRGlzcGxheU5hbWUsIGRlZXBDbG9uZUZpZWxkLCBkZWVwQ2xvbmUsIENsb25hYmxlLCBlbnRpdHlOYW1pbmcgfSA9IHJlcXVpcmUoJy4vR2VtbFV0aWxzJyk7XG5cbmNvbnN0IEZpZWxkID0gcmVxdWlyZSgnLi9GaWVsZCcpO1xuY29uc3QgeyBUeXBlczogeyBGdW5jdGlvbmFsUXVhbGlmaWVycyB9IH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJyk7XG5cbi8qKlxuICogRW50aXR5IGV2ZW50IGxpc3RlbmVyXG4gKiBAY2FsbGJhY2sgT29sb25nRW50aXR5LmV2ZW50TGlzdGVuZXJcbiAqIHJldHVybnMgeyp9XG4gKi9cblxuLyoqXG4gKiBPb2xvbmcgZW50aXR5XG4gKiBAY2xhc3MgT29sb25nRW50aXR5XG4gKi9cbmNsYXNzIEVudGl0eSBleHRlbmRzIENsb25hYmxlIHtcbiAgICAvKipcbiAgICAgKiBGaWVsZHMgb2YgdGhlIGVudGl0eSwgbWFwIG9mIDxmaWVsZE5hbWUsIGZpZWxkT2JqZWN0PlxuICAgICAqIEBtZW1iZXIge29iamVjdC48c3RyaW5nLCBPb2xvbmdGaWVsZD59XG4gICAgICovXG4gICAgZmllbGRzID0ge307XG5cbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7TGlua2VyfSBsaW5rZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7Kn0gZ2VtbE1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobGlua2VyLCBuYW1lLCBnZW1sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cblxuICAgICAgICB0aGlzLl9ldmVudHMgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge09vbG9uZ0xpbmtlcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubGlua2VyID0gbGlua2VyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubmFtZSA9IGVudGl0eU5hbWluZyhuYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgZ2VtbCBtb2R1bGVcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5nZW1sTW9kdWxlID0gZ2VtbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMaXN0ZW4gb24gYW4gZXZlbnRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lXG4gICAgICogQHBhcmFtIHtPb2xvbmdFbnRpdHkuZXZlbnRMaXN0ZW5lcn0gbGlzdGVuZXJcbiAgICAgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfVxuICAgICAqL1xuICAgIG9uY2UoZXZlbnROYW1lLCBsaXN0ZW5lcikge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXZlbnRzLm9uY2UoZXZlbnROYW1lLCBsaXN0ZW5lcik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgbGlua2luZyB0aGlzIGVudGl0eVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgbGluaygpIHtcbiAgICAgICAgcHJlOiAhdGhpcy5saW5rZWQ7XG5cbiAgICAgICAgLy8xLmluaGVyaXQgZnJvbSBiYXNlIGVudGl0eSBpZiBhbnlcbiAgICAgICAgLy8yLmluaXRpYWxpemUgZmVhdHVyZXNcbiAgICAgICAgLy8zLmFkZCBmaWVsZHMgICAgICAgIFxuICAgICAgICAvLzQuYXBpXG5cbiAgICAgICAgLy9pbmRleGVzIHdpbGwgcHJvY2Vzc2VkIGFmdGVyIHByb2Nlc3NpbmcgZm9yZWlnbiByZWxhdGlvbnNoaXBcblxuICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2RlYnVnJywgJ0xpbmtpbmcgZW50aXR5IFsnICsgdGhpcy5uYW1lICsgJ10gLi4uJyk7XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5jb2RlKSB7XG4gICAgICAgICAgICB0aGlzLmNvZGUgPSB0aGlzLmluZm8uY29kZSB8fCB0aGlzLm5hbWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbmZvLmJhc2UpIHtcbiAgICAgICAgICAgIC8vaW5oZXJpdCBmaWVsZHMsIHByb2Nlc3NlZCBmZWF0dXJlcywga2V5IGFuZCBpbmRleGVzXG4gICAgICAgICAgICBsZXQgYmFzZUNsYXNzZXMgPSBfLmNhc3RBcnJheSh0aGlzLmluZm8uYmFzZSk7XG4gICAgICAgICAgICBiYXNlQ2xhc3Nlcy5yZXZlcnNlKCkuZm9yRWFjaChiYXNlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYmFzZUVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkodGhpcy5nZW1sTW9kdWxlLCBiYXNlKTtcbiAgICAgICAgICAgICAgICBhc3NlcnQ6IGJhc2VFbnRpdHkubGlua2VkO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5faW5oZXJpdChiYXNlRW50aXR5KTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICB0aGlzLmJhc2VDbGFzc2VzID0gYmFzZUNsYXNzZXM7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvbW1lbnQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbW1lbnQgPSB0aGlzLmluZm8uY29tbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRpc3BsYXlOYW1lID0gZ2VuZXJhdGVEaXNwbGF5TmFtZSh0aGlzLm5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2ZlYXR1cmVzTWl4aW5nSW5cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdmZWF0dXJlc01peGluZ0luJyk7XG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBpZiAodGhpcy5pbmZvLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICB0aGlzLmluZm8uZmVhdHVyZXMuZm9yRWFjaChmZWF0dXJlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZU5hbWU7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZlYXR1cmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVOYW1lID0gZmVhdHVyZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlTmFtZSA9IGZlYXR1cmUubmFtZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgZm47XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgZm4gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGAuL2VudGl0eUZlYXR1cmVzLyR7ZmVhdHVyZU5hbWV9LmpzYCkpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09ICdNT0RVTEVfTk9UX0ZPVU5EJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3cgZmVhdHVyZSBcIiR7ZmVhdHVyZU5hbWV9XCIgcmVmZXJlbmNlIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm4odGhpcywgdGhpcy5saW5rZXIudHJhbnNsYXRlT29sVmFsdWUodGhpcy5nZW1sTW9kdWxlLCBmZWF0dXJlLmFyZ3MpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYmVmb3JlQWRkaW5nRmllbGRzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYmVmb3JlQWRkaW5nRmllbGRzJyk7XG5cbiAgICAgICAgLy8gcHJvY2VzcyBmaWVsZHNcbiAgICAgICAgaWYgKHRoaXMuaW5mby5maWVsZHMpIHtcbiAgICAgICAgICAgIF8uZWFjaCh0aGlzLmluZm8uZmllbGRzLCAoZmllbGRJbmZvLCBmaWVsZE5hbWUpID0+IHRoaXMuYWRkRmllbGQoZmllbGROYW1lLCBmaWVsZEluZm8pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2FmdGVyQWRkaW5nRmllbGRzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYWZ0ZXJBZGRpbmdGaWVsZHMnKTsgICBcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmtleSkge1xuICAgICAgICAgICAgdGhpcy5rZXkgPSB0aGlzLmluZm8ua2V5O1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmtleSkgJiYgdGhpcy5rZXkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5rZXkgPSB0aGlzLmtleVswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uaW5wdXRzKSB7XG4gICAgICAgICAgICB0aGlzLmlucHV0cyA9IHRoaXMuaW5mby5pbnB1dHM7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNiZWZvcmVBZGRpbmdJbnRlcmZhY2VzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYmVmb3JlQWRkaW5nSW50ZXJmYWNlcycpOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uaW50ZXJmYWNlcykpIHtcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlcyA9IF8uY2xvbmVEZWVwKHRoaXMuaW5mby5pbnRlcmZhY2VzKTtcblxuICAgICAgICAgICAgXy5mb3JPd24odGhpcy5pbnRlcmZhY2VzLCAoaW50ZikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGludGYuYWNjZXB0KSkge1xuICAgICAgICAgICAgICAgICAgICBpbnRmLmFjY2VwdCA9IF8ubWFwKGludGYuYWNjZXB0LCBwYXJhbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLmdlbWxNb2R1bGUsIHBhcmFtKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNhZnRlckFkZGluZ0ludGVyZmFjZXNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdhZnRlckFkZGluZ0ludGVyZmFjZXMnKTsgICAgICAgIFxuXG4gICAgICAgIHRoaXMubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIHRoZSBlbnRpdHkgaGFzIGFuIGluZGV4IG9uIHRoZSBnaXZlbiBmaWVsZHNcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBmaWVsZHNcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNJbmRleE9uKGZpZWxkcykge1xuICAgICAgICBmaWVsZHMgPSBmaWVsZHMuY29uY2F0KCk7XG4gICAgICAgIGZpZWxkcy5zb3J0KCk7XG5cbiAgICAgICAgcmV0dXJuIF8uZmluZEluZGV4KHRoaXMuaW5kZXhlcywgaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBfLmZpbmRJbmRleChpbmRleC5maWVsZHMsIChmLCBpZHgpID0+IChmaWVsZHMubGVuZ3RoIDw9IGlkeCB8fCBmaWVsZHNbaWR4XSAhPT0gZikpID09PSAtMTtcbiAgICAgICAgICAgIH0pICE9IC0xO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbGwgaW5kZXhlc1xuICAgICAqL1xuICAgIGFkZEluZGV4ZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMuaW5mby5pbmRleGVzLCBpbmRleCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRJbmRleChpbmRleCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBpbmRleFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmRleFxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGluZGV4LmZpZWxkcyAtIEZpZWxkcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IGluZGV4LnVuaXF1ZSAtIEZsYWcgb2YgdW5pcXVlbmVzcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEluZGV4KGluZGV4KSB7XG4gICAgICAgIGlmICghdGhpcy5pbmRleGVzKSB7XG4gICAgICAgICAgICB0aGlzLmluZGV4ZXMgPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGluZGV4ID0gXy5jbG9uZURlZXAoaW5kZXgpO1xuXG4gICAgICAgIGFzc2VydDogaW5kZXguZmllbGRzO1xuXG4gICAgICAgIGlmICghXy5pc0FycmF5KGluZGV4LmZpZWxkcykpIHtcbiAgICAgICAgICAgIGluZGV4LmZpZWxkcyA9IFsgaW5kZXguZmllbGRzIF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmllbGRzID0gaW5kZXguZmllbGRzOyBcblxuICAgICAgICBpbmRleC5maWVsZHMgPSBfLm1hcChmaWVsZHMsIGZpZWxkID0+IHtcblxuICAgICAgICAgICAgbGV0IG5vcm1hbGl6ZWRGaWVsZCA9IGZpZWxkOy8vXy5jYW1lbENhc2UoZmllbGQpO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMuaGFzRmllbGQobm9ybWFsaXplZEZpZWxkKSkge1xuXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbmRleCByZWZlcmVuY2VzIG5vbi1leGlzdCBmaWVsZDogJHtmaWVsZH0sIGVudGl0eTogJHt0aGlzLm5hbWV9LmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gbm9ybWFsaXplZEZpZWxkO1xuICAgICAgICB9KTtcblxuICAgICAgICBpbmRleC5maWVsZHMuc29ydCgpO1xuXG4gICAgICAgIGlmICh0aGlzLmhhc0luZGV4T24oaW5kZXguZmllbGRzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbmRleCBvbiBbJHtpbmRleC5maWVsZHMuam9pbignLCAnKX1dIGFscmVhZHkgZXhpc3QgaW4gZW50aXR5IFske3RoaXMubmFtZX1dLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5pbmRleGVzLnB1c2goaW5kZXgpO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIGZpZWxkIG9iamVjdCBieSBmaWVsZCBuYW1lIG9yIGVudGl0eSBtZXRhIGFjY2Vzb3IgKGUuZy4gJGtleSwgJGZlYXR1cmUpLlxuICAgICAqIEBwYXJhbSBmaWVsZElkXG4gICAgICogQHJldHVybnMge09vbG9uZ0ZpZWxkfVxuICAgICAqL1xuICAgIGdldEVudGl0eUF0dHJpYnV0ZShmaWVsZElkKSB7XG4gICAgICAgIGlmIChmaWVsZElkWzBdID09PSAnJCcpIHtcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IGZpZWxkSWQuc3Vic3RyKDEpO1xuXG4gICAgICAgICAgICBzd2l0Y2ggKHRva2VuKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBcImtleVwiOlxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tYmluYXRpb24ga2V5IG5vdCBzdXBwb3J0IGZvciBhY2Nlc29yIFwiJGtleVwiLicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkc1t0aGlzLmtleV07XG5cbiAgICAgICAgICAgICAgICBjYXNlICdmZWF0dXJlJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXM7XG5cbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGVkIGFjY2Vzc29yIFwiJHt0b2tlbn1cIiBub3Qgc3VwcG9ydGVkIWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0ZpZWxkKGZpZWxkSWQpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBcIiR7ZmllbGRJZH1cIiBub3QgZXhpc3RzIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiLmApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkc1tmaWVsZElkXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGVudGl0eSBoYXMgYSBmaWVsZCB3aXRoIGdpdmVuIG5hbWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGhhc0ZpZWxkKG5hbWUpIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBfLmV2ZXJ5KG5hbWUsIGZuID0+IHRoaXMuaGFzRmllbGQoZm4pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuYW1lIGluIHRoaXMuZmllbGRzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhc3NvY2lhdGlvbiwgZGJtcy1zcGVjaWZpY1xuICAgICAqIEBwYXJhbSB7Kn0gbmFtZSBcbiAgICAgKiBAcGFyYW0geyp9IHByb3BzIFxuICAgICAqIEBleGFtcGxlXG4gICAgICogZS5nLiBteXNxbFxuICAgICAqICBlbnRpdHkgLSBBc3NvY2lhdGVkIGVudGl0eSBuYW1lXG4gICAgICogIGpvaW4gLSBKb2luIHR5cGUsIGUuZy4gSU5ORVIsIExFRlQsIFJJR0hULCBPVVRFUlxuICAgICAqICBleGNsdWRlIC0gRXhjbHVkZSBpbiBvdXRwdXQgY29sdW1uc1xuICAgICAqICBhbGlhcyAtIEFsaWFzIFxuICAgICAqICBvbiAtIE9uIGNvbmRpdGlvbnNcbiAgICAgKiAgZGF0YXNldCAtIFN1YiBxdWVyeVxuICAgICAqICBhc3NvY3MgLSBDaGlsZCBhc3NvY2lhdGlvbnNcbiAgICAgKiAgb3B0aW9uYWwgLSBPcHRpb25hbFxuICAgICAqICAnZGVmYXVsdCcgLSBEZWZhdWx0IHZhbHVlXG4gICAgICogIGxpc3QgLSBJcyBhIGxpc3RcbiAgICAgKi9cbiAgICBhZGRBc3NvY2lhdGlvbihuYW1lLCBwcm9wcykge1xuICAgICAgICBpZiAoIXRoaXMuYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICB0aGlzLmFzc29jaWF0aW9ucyA9IHt9O1xuICAgICAgICB9ICAgIFxuXG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMuYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEFzc29jaWF0aW9uIFwiJHtuYW1lfVwiIGFscmVhZHkgZXhpc3RzIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiLiBQcm9wczogYCArIEpTT04uc3RyaW5naWZ5KHByb3BzKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFzc29jaWF0aW9uc1tuYW1lXSA9IHByb3BzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGFzc29jaWF0aW9uIGZpZWxkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtPb2xvbmdFbnRpdHl9IGRlc3RFbnRpdHlcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0ZpZWxkfSBkZXN0RmllbGRcbiAgICAgKi9cbiAgICBhZGRBc3NvY0ZpZWxkKG5hbWUsIGRlc3RFbnRpdHksIGRlc3RGaWVsZCwgZXh0cmFQcm9wcykge1xuICAgICAgICBsZXQgbG9jYWxGaWVsZCA9IHRoaXMuZmllbGRzW25hbWVdO1xuXG4gICAgICAgIGlmIChsb2NhbEZpZWxkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIFwiJHtuYW1lfVwiIGFscmVhZHkgZXhpc3RzIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGRlc3RGaWVsZEluZm8gPSBfLm9taXQoZGVzdEZpZWxkLnRvSlNPTigpLCBGdW5jdGlvbmFsUXVhbGlmaWVycyk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oZGVzdEZpZWxkSW5mbywgZXh0cmFQcm9wcyk7ICAgICAgIFxuXG4gICAgICAgIHRoaXMuYWRkRmllbGQobmFtZSwgZGVzdEZpZWxkSW5mbyk7ICAgIFxuICAgICAgICAvL3RoaXMuZmllbGRzW25hbWVdLmRpc3BsYXlOYW1lID0gZmllbGROYW1pbmcocHJlZml4TmFtaW5nKGRlc3RFbnRpdHkubmFtZSwgZGVzdEZpZWxkLm5hbWUpKTsgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmaWVsZCBpbnRvIHRoZSBlbnRpdHlcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByYXdJbmZvXG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRGaWVsZChuYW1lLCByYXdJbmZvKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMuaGFzRmllbGQobmFtZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgbmFtZSBbJHtuYW1lfV0gY29uZmxpY3RzIGluIGVudGl0eSBbJHt0aGlzLm5hbWV9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFzc2VydDogcmF3SW5mby50eXBlO1xuXG4gICAgICAgIGxldCBmaWVsZDtcblxuICAgICAgICBpZiAocmF3SW5mbyBpbnN0YW5jZW9mIEZpZWxkKSB7XG4gICAgICAgICAgICBmaWVsZCA9IHJhd0luZm8uY2xvbmUoKTtcbiAgICAgICAgICAgIGZpZWxkLm5hbWUgPSBuYW1lOyAvLyB0b2RvOiBkaXNwbGF5TmFtZVxuICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGZ1bGxSYXdJbmZvID0gdGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLmdlbWxNb2R1bGUsIHJhd0luZm8pOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBmaWVsZCA9IG5ldyBGaWVsZChuYW1lLCBmdWxsUmF3SW5mbyk7XG4gICAgICAgICAgICBmaWVsZC5saW5rKCk7XG4gICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLmZpZWxkc1tuYW1lXSA9IGZpZWxkO1xuXG4gICAgICAgIGlmICghdGhpcy5rZXkpIHtcbiAgICAgICAgICAgIC8vbWFrZSB0aGUgZmlyc3QgZmllbGQgYXMgdGhlIGRlZmF1bHQga2V5XG4gICAgICAgICAgICB0aGlzLmtleSA9IG5hbWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmZWF0dXJlIGludG8gdGhlIGVudGl0eSwgZS5nLiBhdXRvIGluY3JlbWVudCBpZFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtib29sfSBbYWxsb3dNdWx0aXBsZT1mYWxzZV0gLSBBbGxvdyBtdWx0aXBsZSBvY2N1cnJlbmNlXG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRGZWF0dXJlKG5hbWUsIGZlYXR1cmUsIGFsbG93TXVsdGlwbGUpIHtcbiAgICAgICAgaWYgKCF0aGlzLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzID0ge307XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYWxsb3dNdWx0aXBsZSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmZlYXR1cmVzW25hbWVdKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXSA9IFtdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdLnB1c2goZmVhdHVyZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobmFtZSBpbiB0aGlzLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgZmVhdHVyZSBmb3VuZDogJHtuYW1lfS4gQW4gZW50aXR5IGNhbiBvbmx5IGhhdmUgb25lIFwiJHtuYW1lfVwiIGZlYXR1cmUgb25seS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXSA9IGZlYXR1cmU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBoYXNGZWF0dXJlKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXMgJiYgKG5hbWUgaW4gdGhpcy5mZWF0dXJlcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0IGtleSBuYW1lXG4gICAgICogQHBhcmFtIHtzdHJpbmd8YXJyYXkuPHN0cmluZz59IG5hbWUgLSBGaWVsZCBuYW1lIHRvIGJlIHVzZWQgYXMgdGhlIGtleVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgc2V0S2V5KG5hbWUpIHtcbiAgICAgICAgdGhpcy5rZXkgPSBuYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBnZXRSZWZlcmVuY2VkRW50aXR5KGVudGl0eU5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGlua2VyLmxvYWRFbnRpdHkodGhpcy5nZW1sTW9kdWxlLCBlbnRpdHlOYW1lKTsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgYXNzb2NpYXRpb24gaW5mbyBpZiB0aGVyZSBpcyBjb25uZWN0aW9uIHRvIHRoZSBnaXZlbiBkZXN0aW5hdGlvbiBlbnRpdHkuXG4gICAgICovXG4gICAgZ2V0UmVmZXJlbmNlVG8oZW50aXR5TmFtZSwgaW5jbHVkZXMsIGV4Y2x1ZGVzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmluZm8uYXNzb2NpYXRpb25zICYmIF8uZmluZChcbiAgICAgICAgICAgIHRoaXMuaW5mby5hc3NvY2lhdGlvbnMsIGFzc29jID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uZmluZChpbmNsdWRlcywgKHZhbHVlLCBwcm9wKSA9PiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyAhdmFsdWUoYXNzb2NbcHJvcF0pIDogIV8uaXNFcXVhbChhc3NvY1twcm9wXSwgdmFsdWUpKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMuYXNzb2NpYXRpb24gJiYgYXNzb2MgPT09IGV4Y2x1ZGVzLmFzc29jaWF0aW9uKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy50eXBlICYmIGFzc29jLnR5cGUgPT09IGV4Y2x1ZGVzLnR5cGUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLmFzc29jaWF0aW9ucyAmJiBleGNsdWRlcy5hc3NvY2lhdGlvbnMuaW5kZXhPZihhc3NvYykgPiAtMSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMudHlwZXMgJiYgZXhjbHVkZXMudHlwZXMuaW5kZXhPZihhc3NvYy50eXBlKSA+IC0xKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5wcm9wcyAmJiBfLmZpbmQoZXhjbHVkZXMucHJvcHMsIHByb3AgPT4gYXNzb2NbcHJvcF0pKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jLmRlc3RFbnRpdHkgPT09IGVudGl0eU5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGtleSBmaWVsZCBcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBnZXRLZXlGaWVsZCgpIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodGhpcy5rZXkpID8gdGhpcy5rZXkubWFwKGtmID0+IHRoaXMuZmllbGRzW2tmXSkgOiB0aGlzLmZpZWxkc1t0aGlzLmtleV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvbmUgdGhlIGVudGl0eVxuICAgICAqIEBwYXJhbSB7TWFwfSBbc3RhY2tdIC0gUmVmZXJlbmNlIHN0YWNrIHRvIGF2b2lkIHJlY3VycmVuY2UgY29weVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgY2xvbmUoKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcblxuICAgICAgICBsZXQgZW50aXR5ID0gbmV3IEVudGl0eSh0aGlzLmxpbmtlciwgdGhpcy5uYW1lLCB0aGlzLmdlbWxNb2R1bGUsIHRoaXMuaW5mbyk7ICAgICAgICBcblxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdjb2RlJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2Rpc3BsYXlOYW1lJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2NvbW1lbnQnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZmVhdHVyZXMnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZmllbGRzJyk7ICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdhc3NvY2lhdGlvbnMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdrZXknKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbmRleGVzJyk7ICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbnB1dHMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbnRlcmZhY2VzJyk7XG5cbiAgICAgICAgZW50aXR5LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG4gXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIHRoZSBlbnRpdHkgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsICAgICBcbiAgICAgICAgICAgIGNvZGU6IHRoaXMuY29kZSwgICAgICAgICAgICBcbiAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLmRpc3BsYXlOYW1lLFxuICAgICAgICAgICAgY29tbWVudDogdGhpcy5jb21tZW50LCAgICAgICAgICAgIFxuICAgICAgICAgICAgLi4uKHRoaXMuYmFzZUNsYXNzZXMgPyB7IGJhc2VDbGFzc2VzOiB0aGlzLmJhc2VDbGFzc2VzIH0gOiB7fSksXG4gICAgICAgICAgICBmZWF0dXJlczogdGhpcy5mZWF0dXJlcywgICAgICAgICAgICBcbiAgICAgICAgICAgIGZpZWxkczogXy5tYXBWYWx1ZXModGhpcy5maWVsZHMsIGZpZWxkID0+IGZpZWxkLnRvSlNPTigpKSxcbiAgICAgICAgICAgIGFzc29jaWF0aW9uczogdGhpcy5hc3NvY2lhdGlvbnMsXG4gICAgICAgICAgICBrZXk6IHRoaXMua2V5LFxuICAgICAgICAgICAgaW5kZXhlczogdGhpcy5pbmRleGVzXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2luaGVyaXQoYmFzZUVudGl0eSkgeyAgXG4gICAgICAgIGxldCBvdmVycmlkZUluZm8gPSB7fTtcblxuICAgICAgICBpZiAoYmFzZUVudGl0eS5iYXNlQ2xhc3Nlcykge1xuICAgICAgICAgICAgbGV0IGJhc2VDbGFzc2VzID0gYmFzZUVudGl0eS5iYXNlQ2xhc3NlcztcblxuICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUNsYXNzZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2VDbGFzc2VzID0gXy51bmlxKGJhc2VDbGFzc2VzLmNvbmNhdCh0aGlzLmJhc2VDbGFzc2VzKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzZXMgPSBiYXNlQ2xhc3Nlcy5jb25jYXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGJhc2VFbnRpdHkuaW5mby5mZWF0dXJlcykpIHtcbiAgICAgICAgICAgIGxldCBiYXNlRmVhdHVyZXMgPSBfLmNsb25lRGVlcChiYXNlRW50aXR5LmluZm8uZmVhdHVyZXMpOyAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHRoaXMuaW5mby5mZWF0dXJlcykge1xuICAgICAgICAgICAgICAgIG92ZXJyaWRlSW5mby5mZWF0dXJlcyA9IGJhc2VGZWF0dXJlcy5jb25jYXQodGhpcy5pbmZvLmZlYXR1cmVzKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmZlYXR1cmVzID0gYmFzZUZlYXR1cmVzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGJhc2VFbnRpdHkuaW5mby5maWVsZHMpKSB7XG4gICAgICAgICAgICBsZXQgZmllbGRzID0gXy5jbG9uZURlZXAoYmFzZUVudGl0eS5pbmZvLmZpZWxkcyk7XG4gICAgICAgICAgICBvdmVycmlkZUluZm8uZmllbGRzID0geyAuLi5maWVsZHMsIC4uLnRoaXMuaW5mby5maWVsZHMgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5mby5rZXkpIHtcbiAgICAgICAgICAgIG92ZXJyaWRlSW5mby5rZXkgPSBiYXNlRW50aXR5LmluZm8ua2V5O1xuICAgICAgICB9ICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoYmFzZUVudGl0eS5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgIGxldCBpbmRleGVzID0gXy5jbG9uZURlZXAoYmFzZUVudGl0eS5pbmZvLmluZGV4ZXMpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgICAgICBpbmRleGVzID0gaW5kZXhlcy5jb25jYXQodGhpcy5pbmZvLmluZGV4ZXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvdmVycmlkZUluZm8uaW5kZXhlcyA9IGluZGV4ZXM7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmluZm8uYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICBsZXQgYXNzb2NzID0gXy5jbG9uZURlZXAoYmFzZUVudGl0eS5pbmZvLmFzc29jaWF0aW9ucyk7XG5cbiAgICAgICAgICAgIGFzc29jcyA9IGFzc29jcy5tYXAoYXNzb2MgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhc3NvYy5kZXN0RW50aXR5ID09PSBiYXNlRW50aXR5Lm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmFzc29jLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzdEVudGl0eTogdGhpcy5uYW1lXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jO1xuICAgICAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3MgPSBhc3NvY3MuY29uY2F0KHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpO1xuICAgICAgICAgICAgfSAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmFzc29jaWF0aW9ucyA9IGFzc29jcztcbiAgICAgICAgfSAgICAgXG5cbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5wdXRzKSB7XG4gICAgICAgICAgICBvdmVycmlkZUluZm8uaW5wdXRzID0geyAuLi5iYXNlRW50aXR5LmlucHV0cywgLi4udGhpcy5pbmZvLmlucHV0cyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkob3ZlcnJpZGVJbmZvKSkgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmluZm8gPSB7IC4uLnRoaXMuaW5mbywgLi4ub3ZlcnJpZGVJbmZvIH07XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRW50aXR5OyJdfQ==
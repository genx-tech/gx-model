"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  deepClone,
  Clonable,
  entityNaming
} = require('./GemlUtils');

const Field = require('./Field');

const {
  Types: {
    FunctionalQualifiers
  }
} = require('@genx/data');

class Entity extends Clonable {
  constructor(linker, name, gemlModule, info) {
    super();
    this.fields = {};
    this._events = new EventEmitter();
    this.linker = linker;
    this.name = entityNaming(name);
    this.gemlModule = gemlModule;
    this.info = info;
  }

  once(eventName, listener) {
    return this._events.once(eventName, listener);
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.code) {
      this.code = this.info.code || this.name;
    }

    if (this.info.base) {
      let baseClasses = _.castArray(this.info.base);

      baseClasses.reverse().forEach(base => {
        let baseEntity = this.linker.loadEntity(this.gemlModule, base);

        if (!baseEntity.linked) {
          throw new Error("Assertion failed: baseEntity.linked");
        }

        this._inherit(baseEntity);
      });
      this.baseClasses = baseClasses;
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn;

        try {
          fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));
        } catch (err) {
          if (err.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Unknow feature "${featureName}" reference in entity "${this.name}"`);
          }
        }

        fn(this, this.linker.translateOolValue(this.gemlModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.gemlModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!index.fields) {
      throw new Error("Assertion failed: index.fields");
    }

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = _.camelCase(field);

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          if (Array.isArray(this.key)) {
            throw new Error('Combination key not support for accesor "$key".');
          }

          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, props) {
    if (!this.associations) {
      this.associations = {};
    }

    if (name in this.associations) {
      throw new Error(`Association "${name}" already exists in entity "${this.name}". Props: ` + JSON.stringify(props));
    }

    this.associations[name] = props;
  }

  addAssocField(name, destEntity, destField, extraProps) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField.toJSON(), FunctionalQualifiers);

    Object.assign(destFieldInfo, extraProps);
    this.addField(name, destFieldInfo);
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    if (!rawInfo.type) {
      throw new Error("Assertion failed: rawInfo.type");
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.gemlModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. An entity can only have one "${name}" feature only.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  hasFeature(name) {
    return this.features && name in this.features;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferencedEntity(entityName) {
    return this.linker.loadEntity(this.gemlModule, entityName);
  }

  getReferenceTo(entityName, includes, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (includes) {
        if (_.find(includes, (value, prop) => typeof value === 'function' ? !value(assoc[prop]) : !_.isEqual(assoc[prop], value))) return false;
      }

      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
        if (excludes.props && _.find(excludes.props, prop => assoc[prop])) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.gemlModule, this.info);
    deepCloneField(this, entity, 'code');
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      code: this.code,
      displayName: this.displayName,
      comment: this.comment,
      ...(this.baseClasses ? {
        baseClasses: this.baseClasses
      } : {}),
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    let overrideInfo = {};

    if (baseEntity.baseClasses) {
      let baseClasses = baseEntity.baseClasses;

      if (this.baseClasses) {
        this.baseClasses = _.uniq(baseClasses.concat(this.baseClasses));
      } else {
        this.baseClasses = baseClasses.concat();
      }
    }

    if (!_.isEmpty(baseEntity.info.features)) {
      let baseFeatures = _.cloneDeep(baseEntity.info.features);

      if (this.info.features) {
        overrideInfo.features = baseFeatures.concat(this.info.features);
      } else {
        overrideInfo.features = baseFeatures;
      }
    }

    if (!_.isEmpty(baseEntity.info.fields)) {
      let fields = _.cloneDeep(baseEntity.info.fields);

      overrideInfo.fields = { ...fields,
        ...this.info.fields
      };
    }

    if (baseEntity.info.key) {
      overrideInfo.key = baseEntity.info.key;
    }

    if (baseEntity.info.indexes) {
      let indexes = _.cloneDeep(baseEntity.info.indexes);

      if (this.info.indexes) {
        indexes = indexes.concat(this.info.indexes);
      }

      overrideInfo.indexes = indexes;
    }

    if (baseEntity.info.associations) {
      let assocs = _.cloneDeep(baseEntity.info.associations);

      assocs = assocs.map(assoc => {
        if (assoc.destEntity === baseEntity.name) {
          return { ...assoc,
            destEntity: this.name
          };
        }

        return assoc;
      });

      if (this.info.associations) {
        assocs = assocs.concat(this.info.associations);
      }

      overrideInfo.associations = assocs;
    }

    if (!_.isEmpty(overrideInfo)) {
      this.info = { ...this.info,
        ...overrideInfo
      };
    }
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJkZWVwQ2xvbmUiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsIkZpZWxkIiwiVHlwZXMiLCJGdW5jdGlvbmFsUXVhbGlmaWVycyIsIkVudGl0eSIsImNvbnN0cnVjdG9yIiwibGlua2VyIiwibmFtZSIsImdlbWxNb2R1bGUiLCJpbmZvIiwiZmllbGRzIiwiX2V2ZW50cyIsIm9uY2UiLCJldmVudE5hbWUiLCJsaXN0ZW5lciIsImxpbmsiLCJsaW5rZWQiLCJsb2ciLCJjb2RlIiwiYmFzZSIsImJhc2VDbGFzc2VzIiwiY2FzdEFycmF5IiwicmV2ZXJzZSIsImZvckVhY2giLCJiYXNlRW50aXR5IiwibG9hZEVudGl0eSIsIl9pbmhlcml0IiwiY29tbWVudCIsImRpc3BsYXlOYW1lIiwiZW1pdCIsImZlYXR1cmVzIiwiZmVhdHVyZSIsImZlYXR1cmVOYW1lIiwiZm4iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZXJyIiwiRXJyb3IiLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsImFyZ3MiLCJlYWNoIiwiZmllbGRJbmZvIiwiZmllbGROYW1lIiwiYWRkRmllbGQiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJpc0VtcHR5IiwiaW50ZXJmYWNlcyIsImNsb25lRGVlcCIsImZvck93biIsImludGYiLCJhY2NlcHQiLCJtYXAiLCJwYXJhbSIsInRyYWNrQmFja1R5cGUiLCJoYXNJbmRleE9uIiwiY29uY2F0Iiwic29ydCIsImZpbmRJbmRleCIsImluZGV4ZXMiLCJpbmRleCIsImYiLCJpZHgiLCJhZGRJbmRleGVzIiwiYWRkSW5kZXgiLCJmaWVsZCIsIm5vcm1hbGl6ZWRGaWVsZCIsImNhbWVsQ2FzZSIsImhhc0ZpZWxkIiwiam9pbiIsInB1c2giLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZElkIiwidG9rZW4iLCJzdWJzdHIiLCJldmVyeSIsImFkZEFzc29jaWF0aW9uIiwicHJvcHMiLCJhc3NvY2lhdGlvbnMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWRkQXNzb2NGaWVsZCIsImRlc3RFbnRpdHkiLCJkZXN0RmllbGQiLCJleHRyYVByb3BzIiwibG9jYWxGaWVsZCIsImRlc3RGaWVsZEluZm8iLCJvbWl0IiwidG9KU09OIiwiT2JqZWN0IiwiYXNzaWduIiwicmF3SW5mbyIsInR5cGUiLCJjbG9uZSIsImZ1bGxSYXdJbmZvIiwiYWRkRmVhdHVyZSIsImFsbG93TXVsdGlwbGUiLCJoYXNGZWF0dXJlIiwic2V0S2V5IiwiZ2V0UmVmZXJlbmNlZEVudGl0eSIsImVudGl0eU5hbWUiLCJnZXRSZWZlcmVuY2VUbyIsImluY2x1ZGVzIiwiZXhjbHVkZXMiLCJmaW5kIiwiYXNzb2MiLCJ2YWx1ZSIsInByb3AiLCJpc0VxdWFsIiwiYXNzb2NpYXRpb24iLCJpbmRleE9mIiwidHlwZXMiLCJnZXRLZXlGaWVsZCIsImtmIiwiZW50aXR5IiwibWFwVmFsdWVzIiwib3ZlcnJpZGVJbmZvIiwidW5pcSIsImJhc2VGZWF0dXJlcyIsImFzc29jcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUE1Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUVBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFRRixPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUEsU0FBdkM7QUFBa0RDLEVBQUFBLFFBQWxEO0FBQTREQyxFQUFBQTtBQUE1RCxJQUE2RVAsT0FBTyxDQUFDLGFBQUQsQ0FBMUY7O0FBRUEsTUFBTVEsS0FBSyxHQUFHUixPQUFPLENBQUMsU0FB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LE1BQU0sR0FBR0EsTUFBTSxDQUFDbkUsR0FBUCxDQUFXcUQsS0FBSyxJQUFJO0FBQ3pCLFlBQUlBLEtBQUssQ0FBQ3ZCLFVBQU4sS0FBcUI1RCxVQUFVLENBQUNqQixJQUFwQyxFQUEwQztBQUN0QyxpQkFBTyxFQUNILEdBQUdvRyxLQURBO0FBRUh2QixZQUFBQSxVQUFVLEVBQUUsS0FBSzdFO0FBRmQsV0FBUDtBQUlIOztBQUVELGVBQU9vRyxLQUFQO0FBQ0gsT0FUUSxDQUFUOztBQVdBLFVBQUksS0FBS2xHLElBQUwsQ0FBVXVFLFlBQWQsRUFBNEI7QUFDeEJ5QyxRQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQy9ELE1BQVAsQ0FBYyxLQUFLakQsSUFBTCxDQUFVdUUsWUFBeEIsQ0FBVDtBQUNIOztBQUVEc0MsTUFBQUEsWUFBWSxDQUFDdEMsWUFBYixHQUE0QnlDLE1BQTVCO0FBQ0g7O0FBRUQsUUFBSSxDQUFDOUgsQ0FBQyxDQUFDcUQsT0FBRixDQUFVc0UsWUFBVixDQUFMLEVBQThCO0FBQzFCLFdBQUs3RyxJQUFMLEdBQVksRUFBRSxHQUFHLEtBQUtBLElBQVY7QUFBZ0IsV0FBRzZHO0FBQW5CLE9BQVo7QUFDSDtBQUNKOztBQXBqQnlCOztBQXVqQjlCSSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ2SCxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgZ2VuZXJhdGVEaXNwbGF5TmFtZSwgZGVlcENsb25lRmllbGQsIGRlZXBDbG9uZSwgQ2xvbmFibGUsIGVudGl0eU5hbWluZyB9ID0gcmVxdWlyZSgnLi9HZW1sVXRpbHMnKTtcblxuY29uc3QgRmllbGQgPSByZXF1aXJlKCcuL0ZpZWxkJyk7XG5jb25zdCB7IFR5cGVzOiB7IEZ1bmN0aW9uYWxRdWFsaWZpZXJzIH0gfSA9IHJlcXVpcmUoJ0BnZW54L2RhdGEnKTtcblxuLyoqXG4gKiBFbnRpdHkgZXZlbnQgbGlzdGVuZXJcbiAqIEBjYWxsYmFjayBPb2xvbmdFbnRpdHkuZXZlbnRMaXN0ZW5lclxuICogcmV0dXJucyB7Kn1cbiAqL1xuXG4vKipcbiAqIE9vbG9uZyBlbnRpdHlcbiAqIEBjbGFzcyBPb2xvbmdFbnRpdHlcbiAqL1xuY2xhc3MgRW50aXR5IGV4dGVuZHMgQ2xvbmFibGUge1xuICAgIC8qKlxuICAgICAqIEZpZWxkcyBvZiB0aGUgZW50aXR5LCBtYXAgb2YgPGZpZWxkTmFtZSwgZmllbGRPYmplY3Q+XG4gICAgICogQG1lbWJlciB7b2JqZWN0LjxzdHJpbmcsIE9vbG9uZ0ZpZWxkPn1cbiAgICAgKi9cbiAgICBmaWVsZHMgPSB7fTtcblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtMaW5rZXJ9IGxpbmtlclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBnZW1sTW9kdWxlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGluZm9cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihsaW5rZXIsIG5hbWUsIGdlbWxNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuXG4gICAgICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTGlua2VyIHRvIHByb2Nlc3MgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7T29sb25nTGlua2VyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gZW50aXR5TmFtaW5nKG5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBPd25lciBnZW1sIG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmdlbWxNb2R1bGUgPSBnZW1sTW9kdWxlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSYXcgbWV0YWRhdGFcbiAgICAgICAgICogQG1lbWJlciB7T2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5pbmZvID0gaW5mbzsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExpc3RlbiBvbiBhbiBldmVudFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0VudGl0eS5ldmVudExpc3RlbmVyfSBsaXN0ZW5lclxuICAgICAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9XG4gICAgICovXG4gICAgb25jZShldmVudE5hbWUsIGxpc3RlbmVyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9ldmVudHMub25jZShldmVudE5hbWUsIGxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIHRoaXMgZW50aXR5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBsaW5rKCkge1xuICAgICAgICBwcmU6ICF0aGlzLmxpbmtlZDtcblxuICAgICAgICAvLzEuaW5oZXJpdCBmcm9tIGJhc2UgZW50aXR5IGlmIGFueVxuICAgICAgICAvLzIuaW5pdGlhbGl6ZSBmZWF0dXJlc1xuICAgICAgICAvLzMuYWRkIGZpZWxkcyAgICAgICAgXG4gICAgICAgIC8vNC5hcGlcblxuICAgICAgICAvL2luZGV4ZXMgd2lsbCBwcm9jZXNzZWQgYWZ0ZXIgcHJvY2Vzc2luZyBmb3JlaWduIHJlbGF0aW9uc2hpcFxuXG4gICAgICAgIHRoaXMubGlua2VyLmxvZygnZGVidWcnLCAnTGlua2luZyBlbnRpdHkgWycgKyB0aGlzLm5hbWUgKyAnXSAuLi4nKTtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvZGUpIHtcbiAgICAgICAgICAgIHRoaXMuY29kZSA9IHRoaXMuaW5mby5jb2RlIHx8IHRoaXMubmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uYmFzZSkge1xuICAgICAgICAgICAgLy9pbmhlcml0IGZpZWxkcywgcHJvY2Vzc2VkIGZlYXR1cmVzLCBrZXkgYW5kIGluZGV4ZXNcbiAgICAgICAgICAgIGxldCBiYXNlQ2xhc3NlcyA9IF8uY2FzdEFycmF5KHRoaXMuaW5mby5iYXNlKTtcbiAgICAgICAgICAgIGJhc2VDbGFzc2VzLnJldmVyc2UoKS5mb3JFYWNoKGJhc2UgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBiYXNlRW50aXR5ID0gdGhpcy5saW5rZXIubG9hZEVudGl0eSh0aGlzLmdlbWxNb2R1bGUsIGJhc2UpO1xuICAgICAgICAgICAgICAgIGFzc2VydDogYmFzZUVudGl0eS5saW5rZWQ7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9pbmhlcml0KGJhc2VFbnRpdHkpO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzZXMgPSBiYXNlQ2xhc3NlcztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uY29tbWVudCkge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIHRoaXMuY29tbWVudCA9IHRoaXMuaW5mby5jb21tZW50O1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGlzcGxheU5hbWUgPSBnZW5lcmF0ZURpc3BsYXlOYW1lKHRoaXMubmFtZSk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjZmVhdHVyZXNNaXhpbmdJblxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2ZlYXR1cmVzTWl4aW5nSW4nKTtcblxuICAgICAgICAvLyBsb2FkIGZlYXR1cmVzXG4gICAgICAgIGlmICh0aGlzLmluZm8uZmVhdHVyZXMpIHtcbiAgICAgICAgICAgIHRoaXMuaW5mby5mZWF0dXJlcy5mb3JFYWNoKGZlYXR1cmUgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBmZWF0dXJlTmFtZTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZmVhdHVyZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZU5hbWUgPSBmZWF0dXJlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVOYW1lID0gZmVhdHVyZS5uYW1lO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBmbjtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBmbiA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgYC4vZW50aXR5RmVhdHVyZXMvJHtmZWF0dXJlTmFtZX0uanNgKSk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ01PRFVMRV9OT1RfRk9VTkQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vdyBmZWF0dXJlIFwiJHtmZWF0dXJlTmFtZX1cIiByZWZlcmVuY2UgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmbih0aGlzLCB0aGlzLmxpbmtlci50cmFuc2xhdGVPb2xWYWx1ZSh0aGlzLmdlbWxNb2R1bGUsIGZlYXR1cmUuYXJncykpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNiZWZvcmVBZGRpbmdGaWVsZHNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdiZWZvcmVBZGRpbmdGaWVsZHMnKTtcblxuICAgICAgICAvLyBwcm9jZXNzIGZpZWxkc1xuICAgICAgICBpZiAodGhpcy5pbmZvLmZpZWxkcykge1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMuaW5mby5maWVsZHMsIChmaWVsZEluZm8sIGZpZWxkTmFtZSkgPT4gdGhpcy5hZGRGaWVsZChmaWVsZE5hbWUsIGZpZWxkSW5mbykpO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYWZ0ZXJBZGRpbmdGaWVsZHNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdhZnRlckFkZGluZ0ZpZWxkcycpOyAgIFxuXG4gICAgICAgIGlmICh0aGlzLmluZm8ua2V5KSB7XG4gICAgICAgICAgICB0aGlzLmtleSA9IHRoaXMuaW5mby5rZXk7XG5cbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMua2V5KSAmJiB0aGlzLmtleS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmtleSA9IHRoaXMua2V5WzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYmVmb3JlQWRkaW5nSW50ZXJmYWNlc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2JlZm9yZUFkZGluZ0ludGVyZmFjZXMnKTsgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5pbmZvLmludGVyZmFjZXMpKSB7XG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZXMgPSBfLmNsb25lRGVlcCh0aGlzLmluZm8uaW50ZXJmYWNlcyk7XG5cbiAgICAgICAgICAgIF8uZm9yT3duKHRoaXMuaW50ZXJmYWNlcywgKGludGYpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShpbnRmLmFjY2VwdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaW50Zi5hY2NlcHQgPSBfLm1hcChpbnRmLmFjY2VwdCwgcGFyYW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGlua2VyLnRyYWNrQmFja1R5cGUodGhpcy5nZW1sTW9kdWxlLCBwYXJhbSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYWZ0ZXJBZGRpbmdJbnRlcmZhY2VzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYWZ0ZXJBZGRpbmdJbnRlcmZhY2VzJyk7ICAgICAgICBcblxuICAgICAgICB0aGlzLmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciB0aGUgZW50aXR5IGhhcyBhbiBpbmRleCBvbiB0aGUgZ2l2ZW4gZmllbGRzXG4gICAgICogQHBhcmFtIHthcnJheX0gZmllbGRzXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzSW5kZXhPbihmaWVsZHMpIHtcbiAgICAgICAgZmllbGRzID0gZmllbGRzLmNvbmNhdCgpO1xuICAgICAgICBmaWVsZHMuc29ydCgpO1xuXG4gICAgICAgIHJldHVybiBfLmZpbmRJbmRleCh0aGlzLmluZGV4ZXMsIGluZGV4ID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gXy5maW5kSW5kZXgoaW5kZXguZmllbGRzLCAoZiwgaWR4KSA9PiAoZmllbGRzLmxlbmd0aCA8PSBpZHggfHwgZmllbGRzW2lkeF0gIT09IGYpKSA9PT0gLTE7XG4gICAgICAgICAgICB9KSAhPSAtMTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYWxsIGluZGV4ZXNcbiAgICAgKi9cbiAgICBhZGRJbmRleGVzKCkge1xuICAgICAgICBpZiAodGhpcy5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgIF8uZWFjaCh0aGlzLmluZm8uaW5kZXhlcywgaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkSW5kZXgoaW5kZXgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gaW5kZXhcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5kZXhcbiAgICAgKiBAcHJvcGVydHkge2FycmF5fSBpbmRleC5maWVsZHMgLSBGaWVsZHMgb2YgdGhlIGluZGV4XG4gICAgICogQHByb3BlcnR5IHtib29sfSBpbmRleC51bmlxdWUgLSBGbGFnIG9mIHVuaXF1ZW5lc3Mgb2YgdGhlIGluZGV4XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRJbmRleChpbmRleCkge1xuICAgICAgICBpZiAoIXRoaXMuaW5kZXhlcykge1xuICAgICAgICAgICAgdGhpcy5pbmRleGVzID0gW107XG4gICAgICAgIH1cblxuICAgICAgICBpbmRleCA9IF8uY2xvbmVEZWVwKGluZGV4KTtcblxuICAgICAgICBhc3NlcnQ6IGluZGV4LmZpZWxkcztcblxuICAgICAgICBpZiAoIV8uaXNBcnJheShpbmRleC5maWVsZHMpKSB7XG4gICAgICAgICAgICBpbmRleC5maWVsZHMgPSBbIGluZGV4LmZpZWxkcyBdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZpZWxkcyA9IGluZGV4LmZpZWxkczsgXG5cbiAgICAgICAgaW5kZXguZmllbGRzID0gXy5tYXAoZmllbGRzLCBmaWVsZCA9PiB7XG5cbiAgICAgICAgICAgIGxldCBub3JtYWxpemVkRmllbGQgPSBfLmNhbWVsQ2FzZShmaWVsZCk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNGaWVsZChub3JtYWxpemVkRmllbGQpKSB7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluZGV4IHJlZmVyZW5jZXMgbm9uLWV4aXN0IGZpZWxkOiAke2ZpZWxkfSwgZW50aXR5OiAke3RoaXMubmFtZX0uYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBub3JtYWxpemVkRmllbGQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGluZGV4LmZpZWxkcy5zb3J0KCk7XG5cbiAgICAgICAgaWYgKHRoaXMuaGFzSW5kZXhPbihpbmRleC5maWVsZHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluZGV4IG9uIFske2luZGV4LmZpZWxkcy5qb2luKCcsICcpfV0gYWxyZWFkeSBleGlzdCBpbiBlbnRpdHkgWyR7dGhpcy5uYW1lfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmluZGV4ZXMucHVzaChpbmRleCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgZmllbGQgb2JqZWN0IGJ5IGZpZWxkIG5hbWUgb3IgZW50aXR5IG1ldGEgYWNjZXNvciAoZS5nLiAka2V5LCAkZmVhdHVyZSkuXG4gICAgICogQHBhcmFtIGZpZWxkSWRcbiAgICAgKiBAcmV0dXJucyB7T29sb25nRmllbGR9XG4gICAgICovXG4gICAgZ2V0RW50aXR5QXR0cmlidXRlKGZpZWxkSWQpIHtcbiAgICAgICAgaWYgKGZpZWxkSWRbMF0gPT09ICckJykge1xuICAgICAgICAgICAgbGV0IHRva2VuID0gZmllbGRJZC5zdWJzdHIoMSk7XG5cbiAgICAgICAgICAgIHN3aXRjaCAodG9rZW4pIHtcbiAgICAgICAgICAgICAgICBjYXNlIFwia2V5XCI6XG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMua2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21iaW5hdGlvbiBrZXkgbm90IHN1cHBvcnQgZm9yIGFjY2Vzb3IgXCIka2V5XCIuJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRzW3RoaXMua2V5XTtcblxuICAgICAgICAgICAgICAgIGNhc2UgJ2ZlYXR1cmUnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcztcblxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZWQgYWNjZXNzb3IgXCIke3Rva2VufVwiIG5vdCBzdXBwb3J0ZWQhYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaGFzRmllbGQoZmllbGRJZCkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIFwiJHtmaWVsZElkfVwiIG5vdCBleGlzdHMgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCIuYClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRzW2ZpZWxkSWRdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciB0aGUgZW50aXR5IGhhcyBhIGZpZWxkIHdpdGggZ2l2ZW4gbmFtZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzRmllbGQobmFtZSkge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIF8uZXZlcnkobmFtZSwgZm4gPT4gdGhpcy5oYXNGaWVsZChmbikpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5maWVsZHM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGFzc29jaWF0aW9uLCBkYm1zLXNwZWNpZmljXG4gICAgICogQHBhcmFtIHsqfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7Kn0gcHJvcHMgXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBlLmcuIG15c3FsXG4gICAgICogIGVudGl0eSAtIEFzc29jaWF0ZWQgZW50aXR5IG5hbWVcbiAgICAgKiAgam9pbiAtIEpvaW4gdHlwZSwgZS5nLiBJTk5FUiwgTEVGVCwgUklHSFQsIE9VVEVSXG4gICAgICogIGV4Y2x1ZGUgLSBFeGNsdWRlIGluIG91dHB1dCBjb2x1bW5zXG4gICAgICogIGFsaWFzIC0gQWxpYXMgXG4gICAgICogIG9uIC0gT24gY29uZGl0aW9uc1xuICAgICAqICBkYXRhc2V0IC0gU3ViIHF1ZXJ5XG4gICAgICogIGFzc29jcyAtIENoaWxkIGFzc29jaWF0aW9uc1xuICAgICAqICBvcHRpb25hbCAtIE9wdGlvbmFsXG4gICAgICogICdkZWZhdWx0JyAtIERlZmF1bHQgdmFsdWVcbiAgICAgKiAgbGlzdCAtIElzIGEgbGlzdFxuICAgICAqL1xuICAgIGFkZEFzc29jaWF0aW9uKG5hbWUsIHByb3BzKSB7XG4gICAgICAgIGlmICghdGhpcy5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMuYXNzb2NpYXRpb25zID0ge307XG4gICAgICAgIH0gICAgXG5cbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQXNzb2NpYXRpb24gXCIke25hbWV9XCIgYWxyZWFkeSBleGlzdHMgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCIuIFByb3BzOiBgICsgSlNPTi5zdHJpbmdpZnkocHJvcHMpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYXNzb2NpYXRpb25zW25hbWVdID0gcHJvcHM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgYXNzb2NpYXRpb24gZmllbGQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0VudGl0eX0gZGVzdEVudGl0eVxuICAgICAqIEBwYXJhbSB7T29sb25nRmllbGR9IGRlc3RGaWVsZFxuICAgICAqL1xuICAgIGFkZEFzc29jRmllbGQobmFtZSwgZGVzdEVudGl0eSwgZGVzdEZpZWxkLCBleHRyYVByb3BzKSB7XG4gICAgICAgIGxldCBsb2NhbEZpZWxkID0gdGhpcy5maWVsZHNbbmFtZV07XG5cbiAgICAgICAgaWYgKGxvY2FsRmllbGQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgXCIke25hbWV9XCIgYWxyZWFkeSBleGlzdHMgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZGVzdEZpZWxkSW5mbyA9IF8ub21pdChkZXN0RmllbGQudG9KU09OKCksIEZ1bmN0aW9uYWxRdWFsaWZpZXJzKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihkZXN0RmllbGRJbmZvLCBleHRyYVByb3BzKTsgICAgICAgXG5cbiAgICAgICAgdGhpcy5hZGRGaWVsZChuYW1lLCBkZXN0RmllbGRJbmZvKTsgICAgXG4gICAgICAgIC8vdGhpcy5maWVsZHNbbmFtZV0uZGlzcGxheU5hbWUgPSBmaWVsZE5hbWluZyhwcmVmaXhOYW1pbmcoZGVzdEVudGl0eS5uYW1lLCBkZXN0RmllbGQubmFtZSkpOyAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGZpZWxkIGludG8gdGhlIGVudGl0eVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJhd0luZm9cbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEZpZWxkKG5hbWUsIHJhd0luZm8pIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5oYXNGaWVsZChuYW1lKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBuYW1lIFske25hbWV9XSBjb25mbGljdHMgaW4gZW50aXR5IFske3RoaXMubmFtZX1dLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgYXNzZXJ0OiByYXdJbmZvLnR5cGU7XG5cbiAgICAgICAgbGV0IGZpZWxkO1xuXG4gICAgICAgIGlmIChyYXdJbmZvIGluc3RhbmNlb2YgRmllbGQpIHtcbiAgICAgICAgICAgIGZpZWxkID0gcmF3SW5mby5jbG9uZSgpO1xuICAgICAgICAgICAgZmllbGQubmFtZSA9IG5hbWU7IC8vIHRvZG86IGRpc3BsYXlOYW1lXG4gICAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZnVsbFJhd0luZm8gPSB0aGlzLmxpbmtlci50cmFja0JhY2tUeXBlKHRoaXMuZ2VtbE1vZHVsZSwgcmF3SW5mbyk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGZpZWxkID0gbmV3IEZpZWxkKG5hbWUsIGZ1bGxSYXdJbmZvKTtcbiAgICAgICAgICAgIGZpZWxkLmxpbmsoKTtcbiAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuZmllbGRzW25hbWVdID0gZmllbGQ7XG5cbiAgICAgICAgaWYgKCF0aGlzLmtleSkge1xuICAgICAgICAgICAgLy9tYWtlIHRoZSBmaXJzdCBmaWVsZCBhcyB0aGUgZGVmYXVsdCBrZXlcbiAgICAgICAgICAgIHRoaXMua2V5ID0gbmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGZlYXR1cmUgaW50byB0aGUgZW50aXR5LCBlLmcuIGF1dG8gaW5jcmVtZW50IGlkXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge2Jvb2x9IFthbGxvd011bHRpcGxlPWZhbHNlXSAtIEFsbG93IG11bHRpcGxlIG9jY3VycmVuY2VcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEZlYXR1cmUobmFtZSwgZmVhdHVyZSwgYWxsb3dNdWx0aXBsZSkge1xuICAgICAgICBpZiAoIXRoaXMuZmVhdHVyZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhbGxvd011bHRpcGxlKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZmVhdHVyZXNbbmFtZV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdID0gW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0ucHVzaChmZWF0dXJlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChuYW1lIGluIHRoaXMuZmVhdHVyZXMpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBmZWF0dXJlIGZvdW5kOiAke25hbWV9LiBBbiBlbnRpdHkgY2FuIG9ubHkgaGF2ZSBvbmUgXCIke25hbWV9XCIgZmVhdHVyZSBvbmx5LmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdID0gZmVhdHVyZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGhhc0ZlYXR1cmUobmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcyAmJiAobmFtZSBpbiB0aGlzLmZlYXR1cmVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQga2V5IG5hbWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ3xhcnJheS48c3RyaW5nPn0gbmFtZSAtIEZpZWxkIG5hbWUgdG8gYmUgdXNlZCBhcyB0aGUga2V5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBzZXRLZXkobmFtZSkge1xuICAgICAgICB0aGlzLmtleSA9IG5hbWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGdldFJlZmVyZW5jZWRFbnRpdHkoZW50aXR5TmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5saW5rZXIubG9hZEVudGl0eSh0aGlzLmdlbWxNb2R1bGUsIGVudGl0eU5hbWUpOyAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBhc3NvY2lhdGlvbiBpbmZvIGlmIHRoZXJlIGlzIGNvbm5lY3Rpb24gdG8gdGhlIGdpdmVuIGRlc3RpbmF0aW9uIGVudGl0eS5cbiAgICAgKi9cbiAgICBnZXRSZWZlcmVuY2VUbyhlbnRpdHlOYW1lLCBpbmNsdWRlcywgZXhjbHVkZXMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5mby5hc3NvY2lhdGlvbnMgJiYgXy5maW5kKFxuICAgICAgICAgICAgdGhpcy5pbmZvLmFzc29jaWF0aW9ucywgYXNzb2MgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXy5maW5kKGluY2x1ZGVzLCAodmFsdWUsIHByb3ApID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyA/ICF2YWx1ZShhc3NvY1twcm9wXSkgOiAhXy5pc0VxdWFsKGFzc29jW3Byb3BdLCB2YWx1ZSkpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5hc3NvY2lhdGlvbiAmJiBhc3NvYyA9PT0gZXhjbHVkZXMuYXNzb2NpYXRpb24pIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLnR5cGUgJiYgYXNzb2MudHlwZSA9PT0gZXhjbHVkZXMudHlwZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMuYXNzb2NpYXRpb25zICYmIGV4Y2x1ZGVzLmFzc29jaWF0aW9ucy5pbmRleE9mKGFzc29jKSA+IC0xKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy50eXBlcyAmJiBleGNsdWRlcy50eXBlcy5pbmRleE9mKGFzc29jLnR5cGUpID4gLTEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLnByb3BzICYmIF8uZmluZChleGNsdWRlcy5wcm9wcywgcHJvcCA9PiBhc3NvY1twcm9wXSkpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXNzb2MuZGVzdEVudGl0eSA9PT0gZW50aXR5TmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQga2V5IGZpZWxkIFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIGdldEtleUZpZWxkKCkge1xuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh0aGlzLmtleSkgPyB0aGlzLmtleS5tYXAoa2YgPT4gdGhpcy5maWVsZHNba2ZdKSA6IHRoaXMuZmllbGRzW3RoaXMua2V5XTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9uZSB0aGUgZW50aXR5XG4gICAgICogQHBhcmFtIHtNYXB9IFtzdGFja10gLSBSZWZlcmVuY2Ugc3RhY2sgdG8gYXZvaWQgcmVjdXJyZW5jZSBjb3B5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBjbG9uZSgpIHsgICAgICAgIFxuICAgICAgICBzdXBlci5jbG9uZSgpO1xuXG4gICAgICAgIGxldCBlbnRpdHkgPSBuZXcgRW50aXR5KHRoaXMubGlua2VyLCB0aGlzLm5hbWUsIHRoaXMuZ2VtbE1vZHVsZSwgdGhpcy5pbmZvKTsgICAgICAgIFxuXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2NvZGUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZGlzcGxheU5hbWUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnY29tbWVudCcpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmZWF0dXJlcycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmaWVsZHMnKTsgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2Fzc29jaWF0aW9ucycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2tleScpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2luZGV4ZXMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbnRlcmZhY2VzJyk7XG5cbiAgICAgICAgZW50aXR5LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG4gXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIHRoZSBlbnRpdHkgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsICAgICBcbiAgICAgICAgICAgIGNvZGU6IHRoaXMuY29kZSwgICAgICAgICAgICBcbiAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLmRpc3BsYXlOYW1lLFxuICAgICAgICAgICAgY29tbWVudDogdGhpcy5jb21tZW50LCAgICAgICAgICAgIFxuICAgICAgICAgICAgLi4uKHRoaXMuYmFzZUNsYXNzZXMgPyB7IGJhc2VDbGFzc2VzOiB0aGlzLmJhc2VDbGFzc2VzIH0gOiB7fSksXG4gICAgICAgICAgICBmZWF0dXJlczogdGhpcy5mZWF0dXJlcywgICAgICAgICAgICBcbiAgICAgICAgICAgIGZpZWxkczogXy5tYXBWYWx1ZXModGhpcy5maWVsZHMsIGZpZWxkID0+IGZpZWxkLnRvSlNPTigpKSxcbiAgICAgICAgICAgIGFzc29jaWF0aW9uczogdGhpcy5hc3NvY2lhdGlvbnMsXG4gICAgICAgICAgICBrZXk6IHRoaXMua2V5LFxuICAgICAgICAgICAgaW5kZXhlczogdGhpcy5pbmRleGVzXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2luaGVyaXQoYmFzZUVudGl0eSkgeyAgXG4gICAgICAgIGxldCBvdmVycmlkZUluZm8gPSB7fTtcblxuICAgICAgICBpZiAoYmFzZUVudGl0eS5iYXNlQ2xhc3Nlcykge1xuICAgICAgICAgICAgbGV0IGJhc2VDbGFzc2VzID0gYmFzZUVudGl0eS5iYXNlQ2xhc3NlcztcblxuICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUNsYXNzZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2VDbGFzc2VzID0gXy51bmlxKGJhc2VDbGFzc2VzLmNvbmNhdCh0aGlzLmJhc2VDbGFzc2VzKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzZXMgPSBiYXNlQ2xhc3Nlcy5jb25jYXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGJhc2VFbnRpdHkuaW5mby5mZWF0dXJlcykpIHtcbiAgICAgICAgICAgIGxldCBiYXNlRmVhdHVyZXMgPSBfLmNsb25lRGVlcChiYXNlRW50aXR5LmluZm8uZmVhdHVyZXMpOyAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHRoaXMuaW5mby5mZWF0dXJlcykge1xuICAgICAgICAgICAgICAgIG92ZXJyaWRlSW5mby5mZWF0dXJlcyA9IGJhc2VGZWF0dXJlcy5jb25jYXQodGhpcy5pbmZvLmZlYXR1cmVzKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmZlYXR1cmVzID0gYmFzZUZlYXR1cmVzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGJhc2VFbnRpdHkuaW5mby5maWVsZHMpKSB7XG4gICAgICAgICAgICBsZXQgZmllbGRzID0gXy5jbG9uZURlZXAoYmFzZUVudGl0eS5pbmZvLmZpZWxkcyk7XG4gICAgICAgICAgICBvdmVycmlkZUluZm8uZmllbGRzID0geyAuLi5maWVsZHMsIC4uLnRoaXMuaW5mby5maWVsZHMgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5mby5rZXkpIHtcbiAgICAgICAgICAgIG92ZXJyaWRlSW5mby5rZXkgPSBiYXNlRW50aXR5LmluZm8ua2V5O1xuICAgICAgICB9ICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoYmFzZUVudGl0eS5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgIGxldCBpbmRleGVzID0gXy5jbG9uZURlZXAoYmFzZUVudGl0eS5pbmZvLmluZGV4ZXMpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgICAgICBpbmRleGVzID0gaW5kZXhlcy5jb25jYXQodGhpcy5pbmZvLmluZGV4ZXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvdmVycmlkZUluZm8uaW5kZXhlcyA9IGluZGV4ZXM7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmluZm8uYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICBsZXQgYXNzb2NzID0gXy5jbG9uZURlZXAoYmFzZUVudGl0eS5pbmZvLmFzc29jaWF0aW9ucyk7XG5cbiAgICAgICAgICAgIGFzc29jcyA9IGFzc29jcy5tYXAoYXNzb2MgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhc3NvYy5kZXN0RW50aXR5ID09PSBiYXNlRW50aXR5Lm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmFzc29jLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzdEVudGl0eTogdGhpcy5uYW1lXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jO1xuICAgICAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3MgPSBhc3NvY3MuY29uY2F0KHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpO1xuICAgICAgICAgICAgfSAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmFzc29jaWF0aW9ucyA9IGFzc29jcztcbiAgICAgICAgfSAgICAgXG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkob3ZlcnJpZGVJbmZvKSkgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmluZm8gPSB7IC4uLnRoaXMuaW5mbywgLi4ub3ZlcnJpZGVJbmZvIH07XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRW50aXR5OyJdfQ==
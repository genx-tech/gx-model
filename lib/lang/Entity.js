"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  deepClone,
  Clonable,
  entityNaming
} = require('./OolUtils');

const Field = require('./Field');

const {
  Types: {
    FunctionalQualifiers
  }
} = require('@genx/data');

class Entity extends Clonable {
  constructor(linker, name, oolModule, info) {
    super();
    this._events = new EventEmitter();
    this.fields = {};
    this.linker = linker;
    this.name = entityNaming(name);
    this.oolModule = oolModule;
    this.info = info;
  }

  on(eventName, listener) {
    return this._events.on(eventName, listener);
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.code) {
      this.code = this.info.code || this.name;
    }

    if (this.info.base) {
      let baseClasses = _.castArray(this.info.base);

      baseClasses.forEach(base => {
        let baseEntity = this.linker.loadEntity(this.oolModule, base);

        if (!baseEntity.linked) {
          throw new Error("Assertion failed: baseEntity.linked");
        }

        this._inherit(baseEntity);
      });
      this.baseClasses = baseClasses;
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn;

        try {
          fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));
        } catch (err) {
          if (err.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Unknow feature "${featureName}" reference in entity "${this.name}"`);
          }
        }

        fn(this, this.linker.translateOolValue(this.oolModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.oolModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!index.fields) {
      throw new Error("Assertion failed: index.fields");
    }

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = _.camelCase(field);

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          if (Array.isArray(this.key)) {
            throw new Error('Combination key not support for accesor "$key".');
          }

          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, props) {
    if (!this.associations) {
      this.associations = {};
    }

    if (name in this.associations) {
      throw new Error(`Association "${name}" already exists in entity "${this.name}". Props: ` + JSON.stringify(props));
    }

    this.associations[name] = props;
  }

  addAssocField(name, destEntity, destField, extraProps) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField.toJSON(), FunctionalQualifiers);

    Object.assign(destFieldInfo, extraProps);
    this.addField(name, destFieldInfo);
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    if (!rawInfo.type) {
      throw new Error("Assertion failed: rawInfo.type");
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.oolModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (feature.name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. Turn on allowMultiple to enable multiple occurrence of a feature.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  hasFeature(name) {
    return this.features && name in this.features;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferencedEntity(entityName) {
    return this.linker.loadEntity(this.oolModule, entityName);
  }

  getReferenceTo(entityName, includes, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (includes) {
        if (_.find(includes, (value, prop) => typeof value === 'function' ? !value(assoc[prop]) : !_.isEqual(assoc[prop], value))) return false;
      }

      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
        if (excludes.props && _.find(excludes.props, prop => assoc[prop])) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.oolModule, this.info);
    deepCloneField(this, entity, 'code');
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      code: this.code,
      displayName: this.displayName,
      comment: this.comment,
      ...(this.baseClasses ? {
        baseClasses: this.baseClasses
      } : {}),
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    let overrideInfo = {};

    if (baseEntity.baseClasses) {
      let baseClasses = baseEntity.baseClasses;

      if (this.baseClasses) {
        this.baseClasses = _.uniq(baseClasses.concat(this.baseClasses));
      } else {
        this.baseClasses = baseClasses.concat();
      }
    }

    if (baseEntity.features) {
      let baseFeatures = deepClone(baseEntity.features);
      this.features = { ...this.features,
        ...baseFeatures
      };
    }

    if (baseEntity.fields) {
      let fields = deepClone(baseEntity.fields);
      this.fields = { ...this.fields,
        ...fields
      };
    }

    deepCloneField(baseEntity, this, 'key');

    if (baseEntity.info.indexes) {
      let indexes = deepClone(baseEntity.info.indexes);

      if (this.info.indexes) {
        indexes = indexes.concat(this.info.indexes);
      }

      overrideInfo.indexes = indexes;
    }

    if (baseEntity.info.associations) {
      let assocs = deepClone(baseEntity.info.associations);
      assocs = assocs.map(assoc => {
        if (assoc.destEntity === baseEntity.name) {
          return { ...assoc,
            destEntity: this.name
          };
        }

        return assoc;
      });

      if (this.info.associations) {
        assocs = assocs.concat(this.info.associations);
      }

      overrideInfo.associations = assocs;
    }

    if (!_.isEmpty(overrideInfo)) {
      this.info = Object.freeze({ ...this.info,
        ...overrideInfo
      });
    }
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJkZWVwQ2xvbmUiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsIkZpZWxkIiwiVHlwZXMiLCJGdW5jdGlvbmFsUXVhbGlmaWVycyIsIkVudGl0eSIsImNvbnN0cnVjdG9yIiwibGlua2VyIiwibmFtZSIsIm9vbE1vZHVsZSIsImluZm8iLCJfZXZlbnRzIiwiZmllbGRzIiwib24iLCJldmVudE5hbWUiLCJsaXN0ZW5lciIsImxpbmsiLCJsaW5rZWQiLCJsb2ciLCJjb2RlIiwiYmFzZSIsImJhc2VDbGFzc2VzIiwiY2FzdEFycmF5IiwiZm9yRWFjaCIsImJhc2VFbnRpdHkiLCJsb2FkRW50aXR5IiwiX2luaGVyaXQiLCJjb21tZW50IiwiZGlzcGxheU5hbWUiLCJlbWl0IiwiZmVhdHVyZXMiLCJmZWF0dXJlIiwiZmVhdHVyZU5hbWUiLCJmbiIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJlcnIiLCJFcnJvciIsInRyYW5zbGF0ZU9vbFZhbHVlIiwiYXJncyIsImVhY2giLCJmaWVsZEluZm8iLCJmaWVsZE5hbWUiLCJhZGRGaWVsZCIsImtleSIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsImlzRW1wdHkiLCJpbnRlcmZhY2VzIiwiY2xvbmVEZWVwIiwiZm9yT3duIiwiaW50ZiIsImFjY2VwdCIsIm1hcCIsInBhcmFtIiwidHJhY2tCYWNrVHlwZSIsImhhc0luZGV4T24iLCJjb25jYXQiLCJzb3J0IiwiZmluZEluZGV4IiwiaW5kZXhlcyIsImluZGV4IiwiZiIsImlkeCIsImFkZEluZGV4ZXMiLCJhZGRJbmRleCIsImZpZWxkIiwibm9ybWFsaXplZEZpZWxkIiwiY2FtZWxDYXNlIiwiaGFzRmllbGQiLCJqb2luIiwicHVzaCIsImdldEVudGl0eUF0dHJpYnV0ZSIsImZpZWxkSWQiLCJ0b2tlbiIsInN1YnN0ciIsImV2ZXJ5IiwiYWRkQXNzb2NpYXRpb24iLCJwcm9wcyIsImFzc29jaWF0aW9ucyIsIkpTT04iLCJzdHJpbmdpZnkiLCJhZGRBc3NvY0ZpZWxkIiwiZGVzdEVudGl0eSIsImRlc3RGaWVsZCIsImV4dHJhUHJvcHMiLCJsb2NhbEZpZWxkIiwiZGVzdEZpZWxkSW5mbyIsIm9taXQiLCJ0b0pTT04iLCJPYmplY3QiLCJhc3NpZ24iLCJyYXdJbmZvIiwidHlwZSIsImNsb25lIiwiZnVsbFJhd0luZm8iLCJhZGRGZWF0dXJlIiwiYWxsb3dNdWx0aXBsZSIsImhhc0ZlYXR1cmUiLCJzZXRLZXkiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwiZW50aXR5TmFtZSIsImdldFJlZmVyZW5jZVRvIiwiaW5jbHVkZXMiLCJleGNsdWRlcyIsImZpbmQiLCJhc3NvYyIsInZhbHVlIiwicHJvcCIsImlzRXF1YWwiLCJhc3NvY2lhdGlvbiIsImluZGV4T2YiLCJ0eXBlcyIsImdldEtleUZpZWxkIiwia2YiLCJlbnRpdHkiLCJtYXBWYWx1ZXMiLCJvdmVycmlkZUluZm8iLCJ1bmlxIiwiYmFzZUZlYXR1cmVzIiwiYXNzb2NzIiwiZnJlZXplIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxZQUFZLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQTVCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBRUEsTUFBTTtBQUFFRSxFQUFBQTtBQUFGLElBQVFGLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsbUJBQUY7QUFBdUJDLEVBQUFBLGNBQXZCO0FBQXVDQyxFQUFBQSxTQUF2QztBQUFrREMsRUFBQUEsUUFBbEQ7QUFBNERDLEVBQUFBO0FBQTVELElBQTZFUCxPQUFPLENBQUMsWUFBRCxDQUExRjs7QUFFQSxNQUFNUSxLQUFLLEdBQUdSLE9BQU8sQ0FBQyxTQUFELENB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QUM3SCxDQUFDLENBQUNvRCxPQUFGLENBQVVzRSxZQUFWLENBQUwsRUFBOEI7QUFDMUIsV0FBSzVHLElBQUwsR0FBWWlGLE1BQU0sQ0FBQytCLE1BQVAsQ0FBYyxFQUFFLEdBQUcsS0FBS2hILElBQVY7QUFBZ0IsV0FBRzRHO0FBQW5CLE9BQWQsQ0FBWjtBQUNIO0FBQ0o7O0FBNWlCeUI7O0FBK2lCOUJLLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZILE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBnZW5lcmF0ZURpc3BsYXlOYW1lLCBkZWVwQ2xvbmVGaWVsZCwgZGVlcENsb25lLCBDbG9uYWJsZSwgZW50aXR5TmFtaW5nIH0gPSByZXF1aXJlKCcuL09vbFV0aWxzJyk7XG5cbmNvbnN0IEZpZWxkID0gcmVxdWlyZSgnLi9GaWVsZCcpO1xuY29uc3QgeyBUeXBlczogeyBGdW5jdGlvbmFsUXVhbGlmaWVycyB9IH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJyk7XG5cbi8qKlxuICogRW50aXR5IGV2ZW50IGxpc3RlbmVyXG4gKiBAY2FsbGJhY2sgT29sb25nRW50aXR5LmV2ZW50TGlzdGVuZXJcbiAqIHJldHVybnMgeyp9XG4gKi9cblxuLyoqXG4gKiBPb2xvbmcgZW50aXR5XG4gKiBAY2xhc3MgT29sb25nRW50aXR5XG4gKi9cbmNsYXNzIEVudGl0eSBleHRlbmRzIENsb25hYmxlIHtcbiAgICBfZXZlbnRzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgLyoqXG4gICAgICogRmllbGRzIG9mIHRoZSBlbnRpdHksIG1hcCBvZiA8ZmllbGROYW1lLCBmaWVsZE9iamVjdD5cbiAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgT29sb25nRmllbGQ+fVxuICAgICAqL1xuICAgIGZpZWxkcyA9IHt9O1xuXG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge0xpbmtlcn0gbGlua2VyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IG9vbE1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobGlua2VyLCBuYW1lLCBvb2xNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTGlua2VyIHRvIHByb2Nlc3MgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7T29sb25nTGlua2VyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gZW50aXR5TmFtaW5nKG5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBPd25lciBvb2xvbmcgbW9kdWxlXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub29sTW9kdWxlID0gb29sTW9kdWxlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSYXcgbWV0YWRhdGFcbiAgICAgICAgICogQG1lbWJlciB7T2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5pbmZvID0gaW5mbzsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExpc3RlbiBvbiBhbiBldmVudFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0VudGl0eS5ldmVudExpc3RlbmVyfSBsaXN0ZW5lclxuICAgICAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9XG4gICAgICovXG4gICAgb24oZXZlbnROYW1lLCBsaXN0ZW5lcikge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXZlbnRzLm9uKGV2ZW50TmFtZSwgbGlzdGVuZXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgdGhpcyBlbnRpdHlcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGxpbmsoKSB7XG4gICAgICAgIHByZTogIXRoaXMubGlua2VkO1xuXG4gICAgICAgIC8vMS5pbmhlcml0IGZyb20gYmFzZSBlbnRpdHkgaWYgYW55XG4gICAgICAgIC8vMi5pbml0aWFsaXplIGZlYXR1cmVzXG4gICAgICAgIC8vMy5hZGQgZmllbGRzICAgICAgICBcbiAgICAgICAgLy80LmFwaVxuXG4gICAgICAgIC8vaW5kZXhlcyB3aWxsIHByb2Nlc3NlZCBhZnRlciBwcm9jZXNzaW5nIGZvcmVpZ24gcmVsYXRpb25zaGlwXG5cbiAgICAgICAgdGhpcy5saW5rZXIubG9nKCdkZWJ1ZycsICdMaW5raW5nIGVudGl0eSBbJyArIHRoaXMubmFtZSArICddIC4uLicpO1xuXG4gICAgICAgIGlmICh0aGlzLmluZm8uY29kZSkge1xuICAgICAgICAgICAgdGhpcy5jb2RlID0gdGhpcy5pbmZvLmNvZGUgfHwgdGhpcy5uYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5iYXNlKSB7XG4gICAgICAgICAgICAvL2luaGVyaXQgZmllbGRzLCBwcm9jZXNzZWQgZmVhdHVyZXMsIGtleSBhbmQgaW5kZXhlc1xuICAgICAgICAgICAgbGV0IGJhc2VDbGFzc2VzID0gXy5jYXN0QXJyYXkodGhpcy5pbmZvLmJhc2UpO1xuICAgICAgICAgICAgYmFzZUNsYXNzZXMuZm9yRWFjaChiYXNlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYmFzZUVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkodGhpcy5vb2xNb2R1bGUsIGJhc2UpO1xuICAgICAgICAgICAgICAgIGFzc2VydDogYmFzZUVudGl0eS5saW5rZWQ7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9pbmhlcml0KGJhc2VFbnRpdHkpO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzZXMgPSBiYXNlQ2xhc3NlcztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uY29tbWVudCkge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIHRoaXMuY29tbWVudCA9IHRoaXMuaW5mby5jb21tZW50O1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGlzcGxheU5hbWUgPSBnZW5lcmF0ZURpc3BsYXlOYW1lKHRoaXMubmFtZSk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjZmVhdHVyZXNNaXhpbmdJblxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2ZlYXR1cmVzTWl4aW5nSW4nKTtcblxuICAgICAgICAvLyBsb2FkIGZlYXR1cmVzXG4gICAgICAgIGlmICh0aGlzLmluZm8uZmVhdHVyZXMpIHtcbiAgICAgICAgICAgIHRoaXMuaW5mby5mZWF0dXJlcy5mb3JFYWNoKGZlYXR1cmUgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBmZWF0dXJlTmFtZTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZmVhdHVyZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZU5hbWUgPSBmZWF0dXJlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVOYW1lID0gZmVhdHVyZS5uYW1lO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBmbjtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBmbiA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgYC4vZW50aXR5RmVhdHVyZXMvJHtmZWF0dXJlTmFtZX0uanNgKSk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ01PRFVMRV9OT1RfRk9VTkQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vdyBmZWF0dXJlIFwiJHtmZWF0dXJlTmFtZX1cIiByZWZlcmVuY2UgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmbih0aGlzLCB0aGlzLmxpbmtlci50cmFuc2xhdGVPb2xWYWx1ZSh0aGlzLm9vbE1vZHVsZSwgZmVhdHVyZS5hcmdzKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2JlZm9yZUFkZGluZ0ZpZWxkc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2JlZm9yZUFkZGluZ0ZpZWxkcycpO1xuXG4gICAgICAgIC8vIHByb2Nlc3MgZmllbGRzXG4gICAgICAgIGlmICh0aGlzLmluZm8uZmllbGRzKSB7XG4gICAgICAgICAgICBfLmVhY2godGhpcy5pbmZvLmZpZWxkcywgKGZpZWxkSW5mbywgZmllbGROYW1lKSA9PiB0aGlzLmFkZEZpZWxkKGZpZWxkTmFtZSwgZmllbGRJbmZvKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNhZnRlckFkZGluZ0ZpZWxkc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2FmdGVyQWRkaW5nRmllbGRzJyk7ICAgXG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5rZXkpIHtcbiAgICAgICAgICAgIHRoaXMua2V5ID0gdGhpcy5pbmZvLmtleTtcblxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5rZXkpICYmIHRoaXMua2V5Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHRoaXMua2V5ID0gdGhpcy5rZXlbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNiZWZvcmVBZGRpbmdJbnRlcmZhY2VzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYmVmb3JlQWRkaW5nSW50ZXJmYWNlcycpOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uaW50ZXJmYWNlcykpIHtcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlcyA9IF8uY2xvbmVEZWVwKHRoaXMuaW5mby5pbnRlcmZhY2VzKTtcblxuICAgICAgICAgICAgXy5mb3JPd24odGhpcy5pbnRlcmZhY2VzLCAoaW50ZikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGludGYuYWNjZXB0KSkge1xuICAgICAgICAgICAgICAgICAgICBpbnRmLmFjY2VwdCA9IF8ubWFwKGludGYuYWNjZXB0LCBwYXJhbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLm9vbE1vZHVsZSwgcGFyYW0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2FmdGVyQWRkaW5nSW50ZXJmYWNlc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2FmdGVyQWRkaW5nSW50ZXJmYWNlcycpOyAgICAgICAgXG5cbiAgICAgICAgdGhpcy5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGVudGl0eSBoYXMgYW4gaW5kZXggb24gdGhlIGdpdmVuIGZpZWxkc1xuICAgICAqIEBwYXJhbSB7YXJyYXl9IGZpZWxkc1xuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGhhc0luZGV4T24oZmllbGRzKSB7XG4gICAgICAgIGZpZWxkcyA9IGZpZWxkcy5jb25jYXQoKTtcbiAgICAgICAgZmllbGRzLnNvcnQoKTtcblxuICAgICAgICByZXR1cm4gXy5maW5kSW5kZXgodGhpcy5pbmRleGVzLCBpbmRleCA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIF8uZmluZEluZGV4KGluZGV4LmZpZWxkcywgKGYsIGlkeCkgPT4gKGZpZWxkcy5sZW5ndGggPD0gaWR4IHx8IGZpZWxkc1tpZHhdICE9PSBmKSkgPT09IC0xO1xuICAgICAgICAgICAgfSkgIT0gLTE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGFsbCBpbmRleGVzXG4gICAgICovXG4gICAgYWRkSW5kZXhlcygpIHtcbiAgICAgICAgaWYgKHRoaXMuaW5mby5pbmRleGVzKSB7XG4gICAgICAgICAgICBfLmVhY2godGhpcy5pbmZvLmluZGV4ZXMsIGluZGV4ID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEluZGV4KGluZGV4KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGFuIGluZGV4XG4gICAgICogQHBhcmFtIHtvYmplY3R9IGluZGV4XG4gICAgICogQHByb3BlcnR5IHthcnJheX0gaW5kZXguZmllbGRzIC0gRmllbGRzIG9mIHRoZSBpbmRleFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gaW5kZXgudW5pcXVlIC0gRmxhZyBvZiB1bmlxdWVuZXNzIG9mIHRoZSBpbmRleFxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgYWRkSW5kZXgoaW5kZXgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmluZGV4ZXMpIHtcbiAgICAgICAgICAgIHRoaXMuaW5kZXhlcyA9IFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgaW5kZXggPSBfLmNsb25lRGVlcChpbmRleCk7XG5cbiAgICAgICAgYXNzZXJ0OiBpbmRleC5maWVsZHM7XG5cbiAgICAgICAgaWYgKCFfLmlzQXJyYXkoaW5kZXguZmllbGRzKSkge1xuICAgICAgICAgICAgaW5kZXguZmllbGRzID0gWyBpbmRleC5maWVsZHMgXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmaWVsZHMgPSBpbmRleC5maWVsZHM7IFxuXG4gICAgICAgIGluZGV4LmZpZWxkcyA9IF8ubWFwKGZpZWxkcywgZmllbGQgPT4ge1xuXG4gICAgICAgICAgICBsZXQgbm9ybWFsaXplZEZpZWxkID0gXy5jYW1lbENhc2UoZmllbGQpO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMuaGFzRmllbGQobm9ybWFsaXplZEZpZWxkKSkge1xuXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbmRleCByZWZlcmVuY2VzIG5vbi1leGlzdCBmaWVsZDogJHtmaWVsZH0sIGVudGl0eTogJHt0aGlzLm5hbWV9LmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gbm9ybWFsaXplZEZpZWxkO1xuICAgICAgICB9KTtcblxuICAgICAgICBpbmRleC5maWVsZHMuc29ydCgpO1xuXG4gICAgICAgIGlmICh0aGlzLmhhc0luZGV4T24oaW5kZXguZmllbGRzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbmRleCBvbiBbJHtpbmRleC5maWVsZHMuam9pbignLCAnKX1dIGFscmVhZHkgZXhpc3QgaW4gZW50aXR5IFske3RoaXMubmFtZX1dLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5pbmRleGVzLnB1c2goaW5kZXgpO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIGZpZWxkIG9iamVjdCBieSBmaWVsZCBuYW1lIG9yIGVudGl0eSBtZXRhIGFjY2Vzb3IgKGUuZy4gJGtleSwgJGZlYXR1cmUpLlxuICAgICAqIEBwYXJhbSBmaWVsZElkXG4gICAgICogQHJldHVybnMge09vbG9uZ0ZpZWxkfVxuICAgICAqL1xuICAgIGdldEVudGl0eUF0dHJpYnV0ZShmaWVsZElkKSB7XG4gICAgICAgIGlmIChmaWVsZElkWzBdID09PSAnJCcpIHtcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IGZpZWxkSWQuc3Vic3RyKDEpO1xuXG4gICAgICAgICAgICBzd2l0Y2ggKHRva2VuKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBcImtleVwiOlxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tYmluYXRpb24ga2V5IG5vdCBzdXBwb3J0IGZvciBhY2Nlc29yIFwiJGtleVwiLicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkc1t0aGlzLmtleV07XG5cbiAgICAgICAgICAgICAgICBjYXNlICdmZWF0dXJlJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXM7XG5cbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGVkIGFjY2Vzc29yIFwiJHt0b2tlbn1cIiBub3Qgc3VwcG9ydGVkIWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0ZpZWxkKGZpZWxkSWQpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBcIiR7ZmllbGRJZH1cIiBub3QgZXhpc3RzIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiLmApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkc1tmaWVsZElkXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGVudGl0eSBoYXMgYSBmaWVsZCB3aXRoIGdpdmVuIG5hbWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGhhc0ZpZWxkKG5hbWUpIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBfLmV2ZXJ5KG5hbWUsIGZuID0+IHRoaXMuaGFzRmllbGQoZm4pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuYW1lIGluIHRoaXMuZmllbGRzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhc3NvY2lhdGlvbiwgZGJtcy1zcGVjaWZpY1xuICAgICAqIEBwYXJhbSB7Kn0gbmFtZSBcbiAgICAgKiBAcGFyYW0geyp9IHByb3BzIFxuICAgICAqIEBleGFtcGxlXG4gICAgICogZS5nLiBteXNxbFxuICAgICAqICBlbnRpdHkgLSBBc3NvY2lhdGVkIGVudGl0eSBuYW1lXG4gICAgICogIGpvaW4gLSBKb2luIHR5cGUsIGUuZy4gSU5ORVIsIExFRlQsIFJJR0hULCBPVVRFUlxuICAgICAqICBleGNsdWRlIC0gRXhjbHVkZSBpbiBvdXRwdXQgY29sdW1uc1xuICAgICAqICBhbGlhcyAtIEFsaWFzIFxuICAgICAqICBvbiAtIE9uIGNvbmRpdGlvbnNcbiAgICAgKiAgZGF0YXNldCAtIFN1YiBxdWVyeVxuICAgICAqICBhc3NvY3MgLSBDaGlsZCBhc3NvY2lhdGlvbnNcbiAgICAgKiAgb3B0aW9uYWwgLSBPcHRpb25hbFxuICAgICAqICAnZGVmYXVsdCcgLSBEZWZhdWx0IHZhbHVlXG4gICAgICogIGxpc3QgLSBJcyBhIGxpc3RcbiAgICAgKi9cbiAgICBhZGRBc3NvY2lhdGlvbihuYW1lLCBwcm9wcykge1xuICAgICAgICBpZiAoIXRoaXMuYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICB0aGlzLmFzc29jaWF0aW9ucyA9IHt9O1xuICAgICAgICB9ICAgIFxuXG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMuYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEFzc29jaWF0aW9uIFwiJHtuYW1lfVwiIGFscmVhZHkgZXhpc3RzIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiLiBQcm9wczogYCArIEpTT04uc3RyaW5naWZ5KHByb3BzKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFzc29jaWF0aW9uc1tuYW1lXSA9IHByb3BzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGFzc29jaWF0aW9uIGZpZWxkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtPb2xvbmdFbnRpdHl9IGRlc3RFbnRpdHlcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0ZpZWxkfSBkZXN0RmllbGRcbiAgICAgKi9cbiAgICBhZGRBc3NvY0ZpZWxkKG5hbWUsIGRlc3RFbnRpdHksIGRlc3RGaWVsZCwgZXh0cmFQcm9wcykge1xuICAgICAgICBsZXQgbG9jYWxGaWVsZCA9IHRoaXMuZmllbGRzW25hbWVdO1xuXG4gICAgICAgIGlmIChsb2NhbEZpZWxkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIFwiJHtuYW1lfVwiIGFscmVhZHkgZXhpc3RzIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGRlc3RGaWVsZEluZm8gPSBfLm9taXQoZGVzdEZpZWxkLnRvSlNPTigpLCBGdW5jdGlvbmFsUXVhbGlmaWVycyk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oZGVzdEZpZWxkSW5mbywgZXh0cmFQcm9wcyk7ICAgICAgIFxuXG4gICAgICAgIHRoaXMuYWRkRmllbGQobmFtZSwgZGVzdEZpZWxkSW5mbyk7ICAgIFxuICAgICAgICAvL3RoaXMuZmllbGRzW25hbWVdLmRpc3BsYXlOYW1lID0gZmllbGROYW1pbmcocHJlZml4TmFtaW5nKGRlc3RFbnRpdHkubmFtZSwgZGVzdEZpZWxkLm5hbWUpKTsgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmaWVsZCBpbnRvIHRoZSBlbnRpdHlcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByYXdJbmZvXG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRGaWVsZChuYW1lLCByYXdJbmZvKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMuaGFzRmllbGQobmFtZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgbmFtZSBbJHtuYW1lfV0gY29uZmxpY3RzIGluIGVudGl0eSBbJHt0aGlzLm5hbWV9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFzc2VydDogcmF3SW5mby50eXBlO1xuXG4gICAgICAgIGxldCBmaWVsZDtcblxuICAgICAgICBpZiAocmF3SW5mbyBpbnN0YW5jZW9mIEZpZWxkKSB7XG4gICAgICAgICAgICBmaWVsZCA9IHJhd0luZm8uY2xvbmUoKTtcbiAgICAgICAgICAgIGZpZWxkLm5hbWUgPSBuYW1lOyAvLyB0b2RvOiBkaXNwbGF5TmFtZVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IGZ1bGxSYXdJbmZvID0gdGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLm9vbE1vZHVsZSwgcmF3SW5mbyk7XG5cbiAgICAgICAgICAgIGZpZWxkID0gbmV3IEZpZWxkKG5hbWUsIGZ1bGxSYXdJbmZvKTtcbiAgICAgICAgICAgIGZpZWxkLmxpbmsoKTtcbiAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuZmllbGRzW25hbWVdID0gZmllbGQ7XG5cbiAgICAgICAgaWYgKCF0aGlzLmtleSkge1xuICAgICAgICAgICAgLy9tYWtlIHRoZSBmaXJzdCBmaWVsZCBhcyB0aGUgZGVmYXVsdCBrZXlcbiAgICAgICAgICAgIHRoaXMua2V5ID0gbmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGZlYXR1cmUgaW50byB0aGUgZW50aXR5LCBlLmcuIGF1dG8gaW5jcmVtZW50IGlkXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge2Jvb2x9IFthbGxvd011bHRpcGxlPWZhbHNlXSAtIEFsbG93IG11bHRpcGxlIG9jY3VycmVuY2VcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEZlYXR1cmUobmFtZSwgZmVhdHVyZSwgYWxsb3dNdWx0aXBsZSkge1xuICAgICAgICBpZiAoIXRoaXMuZmVhdHVyZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhbGxvd011bHRpcGxlKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZmVhdHVyZXNbbmFtZV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdID0gW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0ucHVzaChmZWF0dXJlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChmZWF0dXJlLm5hbWUgaW4gdGhpcy5mZWF0dXJlcykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIGZlYXR1cmUgZm91bmQ6ICR7bmFtZX0uIFR1cm4gb24gYWxsb3dNdWx0aXBsZSB0byBlbmFibGUgbXVsdGlwbGUgb2NjdXJyZW5jZSBvZiBhIGZlYXR1cmUuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0gPSBmZWF0dXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgaGFzRmVhdHVyZShuYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzICYmIChuYW1lIGluIHRoaXMuZmVhdHVyZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldCBrZXkgbmFtZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfGFycmF5LjxzdHJpbmc+fSBuYW1lIC0gRmllbGQgbmFtZSB0byBiZSB1c2VkIGFzIHRoZSBrZXlcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIHNldEtleShuYW1lKSB7XG4gICAgICAgIHRoaXMua2V5ID0gbmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZ2V0UmVmZXJlbmNlZEVudGl0eShlbnRpdHlOYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxpbmtlci5sb2FkRW50aXR5KHRoaXMub29sTW9kdWxlLCBlbnRpdHlOYW1lKTsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgYXNzb2NpYXRpb24gaW5mbyBpZiB0aGVyZSBpcyBjb25uZWN0aW9uIHRvIHRoZSBnaXZlbiBkZXN0aW5hdGlvbiBlbnRpdHkuXG4gICAgICovXG4gICAgZ2V0UmVmZXJlbmNlVG8oZW50aXR5TmFtZSwgaW5jbHVkZXMsIGV4Y2x1ZGVzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmluZm8uYXNzb2NpYXRpb25zICYmIF8uZmluZChcbiAgICAgICAgICAgIHRoaXMuaW5mby5hc3NvY2lhdGlvbnMsIGFzc29jID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uZmluZChpbmNsdWRlcywgKHZhbHVlLCBwcm9wKSA9PiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyAhdmFsdWUoYXNzb2NbcHJvcF0pIDogIV8uaXNFcXVhbChhc3NvY1twcm9wXSwgdmFsdWUpKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMuYXNzb2NpYXRpb24gJiYgYXNzb2MgPT09IGV4Y2x1ZGVzLmFzc29jaWF0aW9uKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy50eXBlICYmIGFzc29jLnR5cGUgPT09IGV4Y2x1ZGVzLnR5cGUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLmFzc29jaWF0aW9ucyAmJiBleGNsdWRlcy5hc3NvY2lhdGlvbnMuaW5kZXhPZihhc3NvYykgPiAtMSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMudHlwZXMgJiYgZXhjbHVkZXMudHlwZXMuaW5kZXhPZihhc3NvYy50eXBlKSA+IC0xKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5wcm9wcyAmJiBfLmZpbmQoZXhjbHVkZXMucHJvcHMsIHByb3AgPT4gYXNzb2NbcHJvcF0pKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jLmRlc3RFbnRpdHkgPT09IGVudGl0eU5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGtleSBmaWVsZCBcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBnZXRLZXlGaWVsZCgpIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodGhpcy5rZXkpID8gdGhpcy5rZXkubWFwKGtmID0+IHRoaXMuZmllbGRzW2tmXSkgOiB0aGlzLmZpZWxkc1t0aGlzLmtleV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvbmUgdGhlIGVudGl0eVxuICAgICAqIEBwYXJhbSB7TWFwfSBbc3RhY2tdIC0gUmVmZXJlbmNlIHN0YWNrIHRvIGF2b2lkIHJlY3VycmVuY2UgY29weVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgY2xvbmUoKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcblxuICAgICAgICBsZXQgZW50aXR5ID0gbmV3IEVudGl0eSh0aGlzLmxpbmtlciwgdGhpcy5uYW1lLCB0aGlzLm9vbE1vZHVsZSwgdGhpcy5pbmZvKTsgICAgICAgIFxuXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2NvZGUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZGlzcGxheU5hbWUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnY29tbWVudCcpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmZWF0dXJlcycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmaWVsZHMnKTsgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2Fzc29jaWF0aW9ucycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2tleScpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2luZGV4ZXMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbnRlcmZhY2VzJyk7XG5cbiAgICAgICAgZW50aXR5LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG4gXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIHRoZSBlbnRpdHkgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsICAgICBcbiAgICAgICAgICAgIGNvZGU6IHRoaXMuY29kZSwgICAgICAgICAgICBcbiAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLmRpc3BsYXlOYW1lLFxuICAgICAgICAgICAgY29tbWVudDogdGhpcy5jb21tZW50LCAgICAgICAgICAgIFxuICAgICAgICAgICAgLi4uKHRoaXMuYmFzZUNsYXNzZXMgPyB7IGJhc2VDbGFzc2VzOiB0aGlzLmJhc2VDbGFzc2VzIH0gOiB7fSksXG4gICAgICAgICAgICBmZWF0dXJlczogdGhpcy5mZWF0dXJlcywgICAgICAgICAgICBcbiAgICAgICAgICAgIGZpZWxkczogXy5tYXBWYWx1ZXModGhpcy5maWVsZHMsIGZpZWxkID0+IGZpZWxkLnRvSlNPTigpKSxcbiAgICAgICAgICAgIGFzc29jaWF0aW9uczogdGhpcy5hc3NvY2lhdGlvbnMsXG4gICAgICAgICAgICBrZXk6IHRoaXMua2V5LFxuICAgICAgICAgICAgaW5kZXhlczogdGhpcy5pbmRleGVzXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2luaGVyaXQoYmFzZUVudGl0eSkgeyAgXG4gICAgICAgIGxldCBvdmVycmlkZUluZm8gPSB7fTtcblxuICAgICAgICBpZiAoYmFzZUVudGl0eS5iYXNlQ2xhc3Nlcykge1xuICAgICAgICAgICAgbGV0IGJhc2VDbGFzc2VzID0gYmFzZUVudGl0eS5iYXNlQ2xhc3NlcztcblxuICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUNsYXNzZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2VDbGFzc2VzID0gXy51bmlxKGJhc2VDbGFzc2VzLmNvbmNhdCh0aGlzLmJhc2VDbGFzc2VzKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzZXMgPSBiYXNlQ2xhc3Nlcy5jb25jYXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmZlYXR1cmVzKSB7XG4gICAgICAgICAgICBsZXQgYmFzZUZlYXR1cmVzID0gZGVlcENsb25lKGJhc2VFbnRpdHkuZmVhdHVyZXMpO1xuICAgICAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHsgLi4udGhpcy5mZWF0dXJlcywgLi4uYmFzZUZlYXR1cmVzIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYmFzZUVudGl0eS5maWVsZHMpIHtcbiAgICAgICAgICAgIGxldCBmaWVsZHMgPSBkZWVwQ2xvbmUoYmFzZUVudGl0eS5maWVsZHMpO1xuICAgICAgICAgICAgdGhpcy5maWVsZHMgPSB7IC4uLnRoaXMuZmllbGRzLCAuLi5maWVsZHMgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQoYmFzZUVudGl0eSwgdGhpcywgJ2tleScpOyAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5mby5pbmRleGVzKSB7XG4gICAgICAgICAgICBsZXQgaW5kZXhlcyA9IGRlZXBDbG9uZShiYXNlRW50aXR5LmluZm8uaW5kZXhlcyk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgICAgIGluZGV4ZXMgPSBpbmRleGVzLmNvbmNhdCh0aGlzLmluZm8uaW5kZXhlcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG92ZXJyaWRlSW5mby5pbmRleGVzID0gaW5kZXhlcztcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIGxldCBhc3NvY3MgPSBkZWVwQ2xvbmUoYmFzZUVudGl0eS5pbmZvLmFzc29jaWF0aW9ucyk7XG5cbiAgICAgICAgICAgIGFzc29jcyA9IGFzc29jcy5tYXAoYXNzb2MgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhc3NvYy5kZXN0RW50aXR5ID09PSBiYXNlRW50aXR5Lm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmFzc29jLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzdEVudGl0eTogdGhpcy5uYW1lXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jO1xuICAgICAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3MgPSBhc3NvY3MuY29uY2F0KHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpO1xuICAgICAgICAgICAgfSAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmFzc29jaWF0aW9ucyA9IGFzc29jcztcbiAgICAgICAgfSAgICAgXG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkob3ZlcnJpZGVJbmZvKSkgeyAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmluZm8gPSBPYmplY3QuZnJlZXplKHsgLi4udGhpcy5pbmZvLCAuLi5vdmVycmlkZUluZm8gfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRW50aXR5OyJdfQ==
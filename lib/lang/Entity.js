"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  deepClone,
  Clonable,
  entityNaming
} = require('./GemlUtils');

const Field = require('./Field');

const {
  Types: {
    FunctionalQualifiers
  }
} = require('@genx/data');

class Entity extends Clonable {
  constructor(linker, name, gemlModule, info) {
    super();
    this.fields = {};
    this._events = new EventEmitter();
    this.linker = linker;
    this.name = entityNaming(name);
    this.gemlModule = gemlModule;
    this.info = info;
  }

  once(eventName, listener) {
    return this._events.once(eventName, listener);
  }

  link() {
    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.code) {
      this.code = this.info.code || this.name;
    }

    if (this.info.base) {
      let baseClasses = _.castArray(this.info.base);

      baseClasses.reverse().forEach(base => {
        let baseEntity = this.linker.loadEntity(this.gemlModule, base);

        this._inherit(baseEntity);
      });
      this.baseClasses = baseClasses;
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn;

        try {
          fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));
        } catch (err) {
          if (err.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Unknow feature "${featureName}" reference in entity "${this.name}"`);
          }
        }

        fn(this, this.linker.translateOolValue(this.gemlModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.gemlModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = _.camelCase(field);

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          if (Array.isArray(this.key)) {
            throw new Error('Combination key not support for accesor "$key".');
          }

          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, props) {
    if (!this.associations) {
      this.associations = {};
    }

    if (name in this.associations) {
      throw new Error(`Association "${name}" already exists in entity "${this.name}". Props: ` + JSON.stringify(props));
    }

    this.associations[name] = props;
  }

  addAssocField(name, destEntity, destField, extraProps) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField.toJSON(), FunctionalQualifiers);

    Object.assign(destFieldInfo, extraProps);
    this.addField(name, destFieldInfo);
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.gemlModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. An entity can only have one "${name}" feature only.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  hasFeature(name) {
    return this.features && name in this.features;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferencedEntity(entityName) {
    return this.linker.loadEntity(this.gemlModule, entityName);
  }

  getReferenceTo(entityName, includes, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (includes) {
        if (_.find(includes, (value, prop) => typeof value === 'function' ? !value(assoc[prop]) : !_.isEqual(assoc[prop], value))) return false;
      }

      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
        if (excludes.props && _.find(excludes.props, prop => assoc[prop])) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.gemlModule, this.info);
    deepCloneField(this, entity, 'code');
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      code: this.code,
      displayName: this.displayName,
      comment: this.comment,
      ...(this.baseClasses ? {
        baseClasses: this.baseClasses
      } : {}),
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    let overrideInfo = {};

    if (baseEntity.baseClasses) {
      let baseClasses = baseEntity.baseClasses;

      if (this.baseClasses) {
        this.baseClasses = _.uniq(baseClasses.concat(this.baseClasses));
      } else {
        this.baseClasses = baseClasses.concat();
      }
    }

    if (!_.isEmpty(baseEntity.info.features)) {
      let baseFeatures = _.cloneDeep(baseEntity.info.features);

      if (this.info.features) {
        overrideInfo.features = baseFeatures.concat(this.info.features);
      } else {
        overrideInfo.features = baseFeatures;
      }
    }

    if (!_.isEmpty(baseEntity.info.fields)) {
      let fields = _.cloneDeep(baseEntity.info.fields);

      overrideInfo.fields = { ...fields,
        ...this.info.fields
      };
    }

    if (baseEntity.info.key) {
      overrideInfo.key = baseEntity.info.key;
    }

    if (baseEntity.info.indexes) {
      let indexes = _.cloneDeep(baseEntity.info.indexes);

      if (this.info.indexes) {
        indexes = indexes.concat(this.info.indexes);
      }

      overrideInfo.indexes = indexes;
    }

    if (baseEntity.info.associations) {
      let assocs = _.cloneDeep(baseEntity.info.associations);

      assocs = assocs.map(assoc => {
        if (assoc.destEntity === baseEntity.name) {
          return { ...assoc,
            destEntity: this.name
          };
        }

        return assoc;
      });

      if (this.info.associations) {
        assocs = assocs.concat(this.info.associations);
      }

      overrideInfo.associations = assocs;
    }

    if (!_.isEmpty(overrideInfo)) {
      this.info = { ...this.info,
        ...overrideInfo
      };
    }
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJkZWVwQ2xvbmUiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsIkZpZWxkIiwiVHlwZXMiLCJGdW5jdGlvbmFsUXVhbGlmaWVycyIsIkVudGl0eSIsImNvbnN0cnVjdG9yIiwibGlua2VyIiwibmFtZSIsImdlbWxNb2R1bGUiLCJpbmZvIiwiZmllbGRzIiwiX2V2ZW50cyIsIm9uY2UiLCJldmVudE5hbWUiLCJsaXN0ZW5lciIsImxpbmsiLCJsb2ciLCJjb2RlIiwiYmFzZSIsImJhc2VDbGFzc2VzIiwiY2FzdEFycmF5IiwicmV2ZXJzZSIsImZvckVhY2giLCJiYXNlRW50aXR5IiwibG9hZEVudGl0eSIsIl9pbmhlcml0IiwiY29tbWVudCIsImRpc3BsYXlOYW1lIiwiZW1pdCIsImZlYXR1cmVzIiwiZmVhdHVyZSIsImZlYXR1cmVOYW1lIiwiZm4iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZXJyIiwiRXJyb3IiLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsImFyZ3MiLCJlYWNoIiwiZmllbGRJbmZvIiwiZmllbGROYW1lIiwiYWRkRmllbGQiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJpc0VtcHR5IiwiaW50ZXJmYWNlcyIsImNsb25lRGVlcCIsImZvck93biIsImludGYiLCJhY2NlcHQiLCJtYXAiLCJwYXJhbSIsInRyYWNrQmFja1R5cGUiLCJsaW5rZWQiLCJoYXNJbmRleE9uIiwiY29uY2F0Iiwic29ydCIsImZpbmRJbmRleCIsImluZGV4ZXMiLCJpbmRleCIsImYiLCJpZHgiLCJhZGRJbmRleGVzIiwiYWRkSW5kZXgiLCJmaWVsZCIsIm5vcm1hbGl6ZWRGaWVsZCIsImNhbWVsQ2FzZSIsImhhc0ZpZWxkIiwiam9pbiIsInB1c2giLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZElkIiwidG9rZW4iLCJzdWJzdHIiLCJldmVyeSIsImFkZEFzc29jaWF0aW9uIiwicHJvcHMiLCJhc3NvY2lhdGlvbnMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWRkQXNzb2NGaWVsZCIsImRlc3RFbnRpdHkiLCJkZXN0RmllbGQiLCJleHRyYVByb3BzIiwibG9jYWxGaWVsZCIsImRlc3RGaWVsZEluZm8iLCJvbWl0IiwidG9KU09OIiwiT2JqZWN0IiwiYXNzaWduIiwicmF3SW5mbyIsImNsb25lIiwiZnVsbFJhd0luZm8iLCJhZGRGZWF0dXJlIiwiYWxsb3dNdWx0aXBsZSIsImhhc0ZlYXR1cmUiLCJzZXRLZXkiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwiZW50aXR5TmFtZSIsImdldFJlZmVyZW5jZVRvIiwiaW5jbHVkZXMiLCJleGNsdWRlcyIsImZpbmQiLCJhc3NvYyIsInZhbHVlIiwicHJvcCIsImlzRXF1YWwiLCJhc3NvY2lhdGlvbiIsInR5cGUiLCJpbmRleE9mIiwidHlwZXMiLCJnZXRLZXlGaWVsZCIsImtmIiwiZW50aXR5IiwibWFwVmFsdWVzIiwib3ZlcnJpZGVJbmZvIiwidW5pcSIsImJhc2VGZWF0dXJlcyIsImFzc29jcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUE1Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUVBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFRRixPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUEsU0FBdkM7QUFBa0RDLEVBQUFBLFFBQWxEO0FBQTREQyxFQUFBQTtBQUE1RCxJQUE2RVAsT0FBTyxDQUFDLGFBQUQsQ0FBMUY7O0FBRUEsTUFBTVEsS0FBSyxHQUFHUixPQUFPLENBQUMsU0FB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RSxLQUFLN0U7QUFGZCxXQUFQO0FBSUg7O0FBRUQsZUFBT21HLEtBQVA7QUFDSCxPQVRRLENBQVQ7O0FBV0EsVUFBSSxLQUFLakcsSUFBTCxDQUFVdUUsWUFBZCxFQUE0QjtBQUN4QnlDLFFBQUFBLE1BQU0sR0FBR0EsTUFBTSxDQUFDL0QsTUFBUCxDQUFjLEtBQUtqRCxJQUFMLENBQVV1RSxZQUF4QixDQUFUO0FBQ0g7O0FBRURzQyxNQUFBQSxZQUFZLENBQUN0QyxZQUFiLEdBQTRCeUMsTUFBNUI7QUFDSDs7QUFFRCxRQUFJLENBQUM5SCxDQUFDLENBQUNvRCxPQUFGLENBQVV1RSxZQUFWLENBQUwsRUFBOEI7QUFDMUIsV0FBSzdHLElBQUwsR0FBWSxFQUFFLEdBQUcsS0FBS0EsSUFBVjtBQUFnQixXQUFHNkc7QUFBbkIsT0FBWjtBQUNIO0FBQ0o7O0FBcGpCeUI7O0FBdWpCOUJJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZILE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBnZW5lcmF0ZURpc3BsYXlOYW1lLCBkZWVwQ2xvbmVGaWVsZCwgZGVlcENsb25lLCBDbG9uYWJsZSwgZW50aXR5TmFtaW5nIH0gPSByZXF1aXJlKCcuL0dlbWxVdGlscycpO1xuXG5jb25zdCBGaWVsZCA9IHJlcXVpcmUoJy4vRmllbGQnKTtcbmNvbnN0IHsgVHlwZXM6IHsgRnVuY3Rpb25hbFF1YWxpZmllcnMgfSB9ID0gcmVxdWlyZSgnQGdlbngvZGF0YScpO1xuXG4vKipcbiAqIEVudGl0eSBldmVudCBsaXN0ZW5lclxuICogQGNhbGxiYWNrIE9vbG9uZ0VudGl0eS5ldmVudExpc3RlbmVyXG4gKiByZXR1cm5zIHsqfVxuICovXG5cbi8qKlxuICogT29sb25nIGVudGl0eVxuICogQGNsYXNzIE9vbG9uZ0VudGl0eVxuICovXG5jbGFzcyBFbnRpdHkgZXh0ZW5kcyBDbG9uYWJsZSB7XG4gICAgLyoqXG4gICAgICogRmllbGRzIG9mIHRoZSBlbnRpdHksIG1hcCBvZiA8ZmllbGROYW1lLCBmaWVsZE9iamVjdD5cbiAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgT29sb25nRmllbGQ+fVxuICAgICAqL1xuICAgIGZpZWxkcyA9IHt9O1xuXG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge0xpbmtlcn0gbGlua2VyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IGdlbWxNb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgZ2VtbE1vZHVsZSwgaW5mbykge1xuICAgICAgICBzdXBlcigpO1xuXG5cbiAgICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMaW5rZXIgdG8gcHJvY2VzcyB0aGlzIGVudGl0eVxuICAgICAgICAgKiBAbWVtYmVyIHtPb2xvbmdMaW5rZXJ9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmxpbmtlciA9IGxpbmtlcjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTmFtZSBvZiB0aGlzIGVudGl0eVxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm5hbWUgPSBlbnRpdHlOYW1pbmcobmFtZSk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE93bmVyIGdlbWwgbW9kdWxlXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZ2VtbE1vZHVsZSA9IGdlbWxNb2R1bGU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJhdyBtZXRhZGF0YVxuICAgICAgICAgKiBAbWVtYmVyIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmluZm8gPSBpbmZvOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTGlzdGVuIG9uIGFuIGV2ZW50XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZVxuICAgICAqIEBwYXJhbSB7T29sb25nRW50aXR5LmV2ZW50TGlzdGVuZXJ9IGxpc3RlbmVyXG4gICAgICogQHJldHVybnMge0V2ZW50RW1pdHRlcn1cbiAgICAgKi9cbiAgICBvbmNlKGV2ZW50TmFtZSwgbGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50cy5vbmNlKGV2ZW50TmFtZSwgbGlzdGVuZXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgdGhpcyBlbnRpdHlcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGxpbmsoKSB7XG4gICAgICAgIHByZTogIXRoaXMubGlua2VkO1xuXG4gICAgICAgIC8vMS5pbmhlcml0IGZyb20gYmFzZSBlbnRpdHkgaWYgYW55XG4gICAgICAgIC8vMi5pbml0aWFsaXplIGZlYXR1cmVzXG4gICAgICAgIC8vMy5hZGQgZmllbGRzICAgICAgICBcbiAgICAgICAgLy80LmFwaVxuXG4gICAgICAgIC8vaW5kZXhlcyB3aWxsIHByb2Nlc3NlZCBhZnRlciBwcm9jZXNzaW5nIGZvcmVpZ24gcmVsYXRpb25zaGlwXG5cbiAgICAgICAgdGhpcy5saW5rZXIubG9nKCdkZWJ1ZycsICdMaW5raW5nIGVudGl0eSBbJyArIHRoaXMubmFtZSArICddIC4uLicpO1xuXG4gICAgICAgIGlmICh0aGlzLmluZm8uY29kZSkge1xuICAgICAgICAgICAgdGhpcy5jb2RlID0gdGhpcy5pbmZvLmNvZGUgfHwgdGhpcy5uYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5iYXNlKSB7XG4gICAgICAgICAgICAvL2luaGVyaXQgZmllbGRzLCBwcm9jZXNzZWQgZmVhdHVyZXMsIGtleSBhbmQgaW5kZXhlc1xuICAgICAgICAgICAgbGV0IGJhc2VDbGFzc2VzID0gXy5jYXN0QXJyYXkodGhpcy5pbmZvLmJhc2UpO1xuICAgICAgICAgICAgYmFzZUNsYXNzZXMucmV2ZXJzZSgpLmZvckVhY2goYmFzZSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGJhc2VFbnRpdHkgPSB0aGlzLmxpbmtlci5sb2FkRW50aXR5KHRoaXMuZ2VtbE1vZHVsZSwgYmFzZSk7XG4gICAgICAgICAgICAgICAgYXNzZXJ0OiBiYXNlRW50aXR5LmxpbmtlZDtcblxuICAgICAgICAgICAgICAgIHRoaXMuX2luaGVyaXQoYmFzZUVudGl0eSk7XG4gICAgICAgICAgICB9KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgdGhpcy5iYXNlQ2xhc3NlcyA9IGJhc2VDbGFzc2VzO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5jb21tZW50KSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdGhpcy5jb21tZW50ID0gdGhpcy5pbmZvLmNvbW1lbnQ7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kaXNwbGF5TmFtZSA9IGdlbmVyYXRlRGlzcGxheU5hbWUodGhpcy5uYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNmZWF0dXJlc01peGluZ0luXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnZmVhdHVyZXNNaXhpbmdJbicpO1xuXG4gICAgICAgIC8vIGxvYWQgZmVhdHVyZXNcbiAgICAgICAgaWYgKHRoaXMuaW5mby5mZWF0dXJlcykge1xuICAgICAgICAgICAgdGhpcy5pbmZvLmZlYXR1cmVzLmZvckVhY2goZmVhdHVyZSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVOYW1lO1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmZWF0dXJlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlTmFtZSA9IGZlYXR1cmU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZU5hbWUgPSBmZWF0dXJlLm5hbWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGZuO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGZuID0gcmVxdWlyZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBgLi9lbnRpdHlGZWF0dXJlcy8ke2ZlYXR1cmVOYW1lfS5qc2ApKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSAnTU9EVUxFX05PVF9GT1VORCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93IGZlYXR1cmUgXCIke2ZlYXR1cmVOYW1lfVwiIHJlZmVyZW5jZSBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cImApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZuKHRoaXMsIHRoaXMubGlua2VyLnRyYW5zbGF0ZU9vbFZhbHVlKHRoaXMuZ2VtbE1vZHVsZSwgZmVhdHVyZS5hcmdzKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2JlZm9yZUFkZGluZ0ZpZWxkc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2JlZm9yZUFkZGluZ0ZpZWxkcycpO1xuXG4gICAgICAgIC8vIHByb2Nlc3MgZmllbGRzXG4gICAgICAgIGlmICh0aGlzLmluZm8uZmllbGRzKSB7XG4gICAgICAgICAgICBfLmVhY2godGhpcy5pbmZvLmZpZWxkcywgKGZpZWxkSW5mbywgZmllbGROYW1lKSA9PiB0aGlzLmFkZEZpZWxkKGZpZWxkTmFtZSwgZmllbGRJbmZvKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNhZnRlckFkZGluZ0ZpZWxkc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2FmdGVyQWRkaW5nRmllbGRzJyk7ICAgXG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5rZXkpIHtcbiAgICAgICAgICAgIHRoaXMua2V5ID0gdGhpcy5pbmZvLmtleTtcblxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5rZXkpICYmIHRoaXMua2V5Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHRoaXMua2V5ID0gdGhpcy5rZXlbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNiZWZvcmVBZGRpbmdJbnRlcmZhY2VzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYmVmb3JlQWRkaW5nSW50ZXJmYWNlcycpOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uaW50ZXJmYWNlcykpIHtcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlcyA9IF8uY2xvbmVEZWVwKHRoaXMuaW5mby5pbnRlcmZhY2VzKTtcblxuICAgICAgICAgICAgXy5mb3JPd24odGhpcy5pbnRlcmZhY2VzLCAoaW50ZikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGludGYuYWNjZXB0KSkge1xuICAgICAgICAgICAgICAgICAgICBpbnRmLmFjY2VwdCA9IF8ubWFwKGludGYuYWNjZXB0LCBwYXJhbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLmdlbWxNb2R1bGUsIHBhcmFtKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNhZnRlckFkZGluZ0ludGVyZmFjZXNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdhZnRlckFkZGluZ0ludGVyZmFjZXMnKTsgICAgICAgIFxuXG4gICAgICAgIHRoaXMubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIHRoZSBlbnRpdHkgaGFzIGFuIGluZGV4IG9uIHRoZSBnaXZlbiBmaWVsZHNcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBmaWVsZHNcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNJbmRleE9uKGZpZWxkcykge1xuICAgICAgICBmaWVsZHMgPSBmaWVsZHMuY29uY2F0KCk7XG4gICAgICAgIGZpZWxkcy5zb3J0KCk7XG5cbiAgICAgICAgcmV0dXJuIF8uZmluZEluZGV4KHRoaXMuaW5kZXhlcywgaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBfLmZpbmRJbmRleChpbmRleC5maWVsZHMsIChmLCBpZHgpID0+IChmaWVsZHMubGVuZ3RoIDw9IGlkeCB8fCBmaWVsZHNbaWR4XSAhPT0gZikpID09PSAtMTtcbiAgICAgICAgICAgIH0pICE9IC0xO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbGwgaW5kZXhlc1xuICAgICAqL1xuICAgIGFkZEluZGV4ZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMuaW5mby5pbmRleGVzLCBpbmRleCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRJbmRleChpbmRleCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBpbmRleFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmRleFxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGluZGV4LmZpZWxkcyAtIEZpZWxkcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IGluZGV4LnVuaXF1ZSAtIEZsYWcgb2YgdW5pcXVlbmVzcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEluZGV4KGluZGV4KSB7XG4gICAgICAgIGlmICghdGhpcy5pbmRleGVzKSB7XG4gICAgICAgICAgICB0aGlzLmluZGV4ZXMgPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGluZGV4ID0gXy5jbG9uZURlZXAoaW5kZXgpO1xuXG4gICAgICAgIGFzc2VydDogaW5kZXguZmllbGRzO1xuXG4gICAgICAgIGlmICghXy5pc0FycmF5KGluZGV4LmZpZWxkcykpIHtcbiAgICAgICAgICAgIGluZGV4LmZpZWxkcyA9IFsgaW5kZXguZmllbGRzIF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmllbGRzID0gaW5kZXguZmllbGRzOyBcblxuICAgICAgICBpbmRleC5maWVsZHMgPSBfLm1hcChmaWVsZHMsIGZpZWxkID0+IHtcblxuICAgICAgICAgICAgbGV0IG5vcm1hbGl6ZWRGaWVsZCA9IF8uY2FtZWxDYXNlKGZpZWxkKTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0ZpZWxkKG5vcm1hbGl6ZWRGaWVsZCkpIHtcblxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5kZXggcmVmZXJlbmNlcyBub24tZXhpc3QgZmllbGQ6ICR7ZmllbGR9LCBlbnRpdHk6ICR7dGhpcy5uYW1lfS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRGaWVsZDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaW5kZXguZmllbGRzLnNvcnQoKTtcblxuICAgICAgICBpZiAodGhpcy5oYXNJbmRleE9uKGluZGV4LmZpZWxkcykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5kZXggb24gWyR7aW5kZXguZmllbGRzLmpvaW4oJywgJyl9XSBhbHJlYWR5IGV4aXN0IGluIGVudGl0eSBbJHt0aGlzLm5hbWV9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuaW5kZXhlcy5wdXNoKGluZGV4KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBmaWVsZCBvYmplY3QgYnkgZmllbGQgbmFtZSBvciBlbnRpdHkgbWV0YSBhY2Nlc29yIChlLmcuICRrZXksICRmZWF0dXJlKS5cbiAgICAgKiBAcGFyYW0gZmllbGRJZFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdGaWVsZH1cbiAgICAgKi9cbiAgICBnZXRFbnRpdHlBdHRyaWJ1dGUoZmllbGRJZCkge1xuICAgICAgICBpZiAoZmllbGRJZFswXSA9PT0gJyQnKSB7XG4gICAgICAgICAgICBsZXQgdG9rZW4gPSBmaWVsZElkLnN1YnN0cigxKTtcblxuICAgICAgICAgICAgc3dpdGNoICh0b2tlbikge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJrZXlcIjpcbiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5rZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbWJpbmF0aW9uIGtleSBub3Qgc3VwcG9ydCBmb3IgYWNjZXNvciBcIiRrZXlcIi4nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZHNbdGhpcy5rZXldO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAnZmVhdHVyZSc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzO1xuXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlZCBhY2Nlc3NvciBcIiR7dG9rZW59XCIgbm90IHN1cHBvcnRlZCFgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNGaWVsZChmaWVsZElkKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgXCIke2ZpZWxkSWR9XCIgbm90IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi5gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZHNbZmllbGRJZF07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIHRoZSBlbnRpdHkgaGFzIGEgZmllbGQgd2l0aCBnaXZlbiBuYW1lXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNGaWVsZChuYW1lKSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gXy5ldmVyeShuYW1lLCBmbiA9PiB0aGlzLmhhc0ZpZWxkKGZuKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmFtZSBpbiB0aGlzLmZpZWxkcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYXNzb2NpYXRpb24sIGRibXMtc3BlY2lmaWNcbiAgICAgKiBAcGFyYW0geyp9IG5hbWUgXG4gICAgICogQHBhcmFtIHsqfSBwcm9wcyBcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGUuZy4gbXlzcWxcbiAgICAgKiAgZW50aXR5IC0gQXNzb2NpYXRlZCBlbnRpdHkgbmFtZVxuICAgICAqICBqb2luIC0gSm9pbiB0eXBlLCBlLmcuIElOTkVSLCBMRUZULCBSSUdIVCwgT1VURVJcbiAgICAgKiAgZXhjbHVkZSAtIEV4Y2x1ZGUgaW4gb3V0cHV0IGNvbHVtbnNcbiAgICAgKiAgYWxpYXMgLSBBbGlhcyBcbiAgICAgKiAgb24gLSBPbiBjb25kaXRpb25zXG4gICAgICogIGRhdGFzZXQgLSBTdWIgcXVlcnlcbiAgICAgKiAgYXNzb2NzIC0gQ2hpbGQgYXNzb2NpYXRpb25zXG4gICAgICogIG9wdGlvbmFsIC0gT3B0aW9uYWxcbiAgICAgKiAgJ2RlZmF1bHQnIC0gRGVmYXVsdCB2YWx1ZVxuICAgICAqICBsaXN0IC0gSXMgYSBsaXN0XG4gICAgICovXG4gICAgYWRkQXNzb2NpYXRpb24obmFtZSwgcHJvcHMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5hc3NvY2lhdGlvbnMgPSB7fTtcbiAgICAgICAgfSAgICBcblxuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBc3NvY2lhdGlvbiBcIiR7bmFtZX1cIiBhbHJlYWR5IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi4gUHJvcHM6IGAgKyBKU09OLnN0cmluZ2lmeShwcm9wcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5hc3NvY2lhdGlvbnNbbmFtZV0gPSBwcm9wcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBhc3NvY2lhdGlvbiBmaWVsZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7T29sb25nRW50aXR5fSBkZXN0RW50aXR5XG4gICAgICogQHBhcmFtIHtPb2xvbmdGaWVsZH0gZGVzdEZpZWxkXG4gICAgICovXG4gICAgYWRkQXNzb2NGaWVsZChuYW1lLCBkZXN0RW50aXR5LCBkZXN0RmllbGQsIGV4dHJhUHJvcHMpIHtcbiAgICAgICAgbGV0IGxvY2FsRmllbGQgPSB0aGlzLmZpZWxkc1tuYW1lXTtcblxuICAgICAgICBpZiAobG9jYWxGaWVsZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBcIiR7bmFtZX1cIiBhbHJlYWR5IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkZXN0RmllbGRJbmZvID0gXy5vbWl0KGRlc3RGaWVsZC50b0pTT04oKSwgRnVuY3Rpb25hbFF1YWxpZmllcnMpO1xuICAgICAgICBPYmplY3QuYXNzaWduKGRlc3RGaWVsZEluZm8sIGV4dHJhUHJvcHMpOyAgICAgICBcblxuICAgICAgICB0aGlzLmFkZEZpZWxkKG5hbWUsIGRlc3RGaWVsZEluZm8pOyAgICBcbiAgICAgICAgLy90aGlzLmZpZWxkc1tuYW1lXS5kaXNwbGF5TmFtZSA9IGZpZWxkTmFtaW5nKHByZWZpeE5hbWluZyhkZXN0RW50aXR5Lm5hbWUsIGRlc3RGaWVsZC5uYW1lKSk7ICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgZmllbGQgaW50byB0aGUgZW50aXR5XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmF3SW5mb1xuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgYWRkRmllbGQobmFtZSwgcmF3SW5mbykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLmhhc0ZpZWxkKG5hbWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIG5hbWUgWyR7bmFtZX1dIGNvbmZsaWN0cyBpbiBlbnRpdHkgWyR7dGhpcy5uYW1lfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICBhc3NlcnQ6IHJhd0luZm8udHlwZTtcblxuICAgICAgICBsZXQgZmllbGQ7XG5cbiAgICAgICAgaWYgKHJhd0luZm8gaW5zdGFuY2VvZiBGaWVsZCkge1xuICAgICAgICAgICAgZmllbGQgPSByYXdJbmZvLmNsb25lKCk7XG4gICAgICAgICAgICBmaWVsZC5uYW1lID0gbmFtZTsgLy8gdG9kbzogZGlzcGxheU5hbWVcbiAgICAgICAgfSBlbHNlIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBmdWxsUmF3SW5mbyA9IHRoaXMubGlua2VyLnRyYWNrQmFja1R5cGUodGhpcy5nZW1sTW9kdWxlLCByYXdJbmZvKTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgZmllbGQgPSBuZXcgRmllbGQobmFtZSwgZnVsbFJhd0luZm8pO1xuICAgICAgICAgICAgZmllbGQubGluaygpO1xuICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5maWVsZHNbbmFtZV0gPSBmaWVsZDtcblxuICAgICAgICBpZiAoIXRoaXMua2V5KSB7XG4gICAgICAgICAgICAvL21ha2UgdGhlIGZpcnN0IGZpZWxkIGFzIHRoZSBkZWZhdWx0IGtleVxuICAgICAgICAgICAgdGhpcy5rZXkgPSBuYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgZmVhdHVyZSBpbnRvIHRoZSBlbnRpdHksIGUuZy4gYXV0byBpbmNyZW1lbnQgaWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7Kn0gZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7Ym9vbH0gW2FsbG93TXVsdGlwbGU9ZmFsc2VdIC0gQWxsb3cgbXVsdGlwbGUgb2NjdXJyZW5jZVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgYWRkRmVhdHVyZShuYW1lLCBmZWF0dXJlLCBhbGxvd011bHRpcGxlKSB7XG4gICAgICAgIGlmICghdGhpcy5mZWF0dXJlcykge1xuICAgICAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFsbG93TXVsdGlwbGUpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5mZWF0dXJlc1tuYW1lXSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0gPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXS5wdXNoKGZlYXR1cmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5mZWF0dXJlcykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIGZlYXR1cmUgZm91bmQ6ICR7bmFtZX0uIEFuIGVudGl0eSBjYW4gb25seSBoYXZlIG9uZSBcIiR7bmFtZX1cIiBmZWF0dXJlIG9ubHkuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0gPSBmZWF0dXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgaGFzRmVhdHVyZShuYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzICYmIChuYW1lIGluIHRoaXMuZmVhdHVyZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldCBrZXkgbmFtZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfGFycmF5LjxzdHJpbmc+fSBuYW1lIC0gRmllbGQgbmFtZSB0byBiZSB1c2VkIGFzIHRoZSBrZXlcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIHNldEtleShuYW1lKSB7XG4gICAgICAgIHRoaXMua2V5ID0gbmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZ2V0UmVmZXJlbmNlZEVudGl0eShlbnRpdHlOYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxpbmtlci5sb2FkRW50aXR5KHRoaXMuZ2VtbE1vZHVsZSwgZW50aXR5TmFtZSk7ICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIGFzc29jaWF0aW9uIGluZm8gaWYgdGhlcmUgaXMgY29ubmVjdGlvbiB0byB0aGUgZ2l2ZW4gZGVzdGluYXRpb24gZW50aXR5LlxuICAgICAqL1xuICAgIGdldFJlZmVyZW5jZVRvKGVudGl0eU5hbWUsIGluY2x1ZGVzLCBleGNsdWRlcykge1xuICAgICAgICByZXR1cm4gdGhpcy5pbmZvLmFzc29jaWF0aW9ucyAmJiBfLmZpbmQoXG4gICAgICAgICAgICB0aGlzLmluZm8uYXNzb2NpYXRpb25zLCBhc3NvYyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmZpbmQoaW5jbHVkZXMsICh2YWx1ZSwgcHJvcCkgPT4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nID8gIXZhbHVlKGFzc29jW3Byb3BdKSA6ICFfLmlzRXF1YWwoYXNzb2NbcHJvcF0sIHZhbHVlKSkpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLmFzc29jaWF0aW9uICYmIGFzc29jID09PSBleGNsdWRlcy5hc3NvY2lhdGlvbikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMudHlwZSAmJiBhc3NvYy50eXBlID09PSBleGNsdWRlcy50eXBlKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5hc3NvY2lhdGlvbnMgJiYgZXhjbHVkZXMuYXNzb2NpYXRpb25zLmluZGV4T2YoYXNzb2MpID4gLTEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLnR5cGVzICYmIGV4Y2x1ZGVzLnR5cGVzLmluZGV4T2YoYXNzb2MudHlwZSkgPiAtMSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMucHJvcHMgJiYgXy5maW5kKGV4Y2x1ZGVzLnByb3BzLCBwcm9wID0+IGFzc29jW3Byb3BdKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBhc3NvYy5kZXN0RW50aXR5ID09PSBlbnRpdHlOYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBrZXkgZmllbGQgXG4gICAgICogQHJldHVybnMgeyp9XG4gICAgICovXG4gICAgZ2V0S2V5RmllbGQoKSB7XG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHRoaXMua2V5KSA/IHRoaXMua2V5Lm1hcChrZiA9PiB0aGlzLmZpZWxkc1trZl0pIDogdGhpcy5maWVsZHNbdGhpcy5rZXldO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb25lIHRoZSBlbnRpdHlcbiAgICAgKiBAcGFyYW0ge01hcH0gW3N0YWNrXSAtIFJlZmVyZW5jZSBzdGFjayB0byBhdm9pZCByZWN1cnJlbmNlIGNvcHlcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGNsb25lKCkgeyAgICAgICAgXG4gICAgICAgIHN1cGVyLmNsb25lKCk7XG5cbiAgICAgICAgbGV0IGVudGl0eSA9IG5ldyBFbnRpdHkodGhpcy5saW5rZXIsIHRoaXMubmFtZSwgdGhpcy5nZW1sTW9kdWxlLCB0aGlzLmluZm8pOyAgICAgICAgXG5cbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnY29kZScpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdkaXNwbGF5TmFtZScpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdjb21tZW50Jyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2ZlYXR1cmVzJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2ZpZWxkcycpOyAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnYXNzb2NpYXRpb25zJyk7ICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAna2V5Jyk7ICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnaW5kZXhlcycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2ludGVyZmFjZXMnKTtcblxuICAgICAgICBlbnRpdHkubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cbiBcbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgdGhlIGVudGl0eSBpbnRvIGEgcGxhaW4gSlNPTiBvYmplY3RcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHRvSlNPTigpIHtcbiAgICAgICAgcmV0dXJuIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSwgICAgIFxuICAgICAgICAgICAgY29kZTogdGhpcy5jb2RlLCAgICAgICAgICAgIFxuICAgICAgICAgICAgZGlzcGxheU5hbWU6IHRoaXMuZGlzcGxheU5hbWUsXG4gICAgICAgICAgICBjb21tZW50OiB0aGlzLmNvbW1lbnQsICAgICAgICAgICAgXG4gICAgICAgICAgICAuLi4odGhpcy5iYXNlQ2xhc3NlcyA/IHsgYmFzZUNsYXNzZXM6IHRoaXMuYmFzZUNsYXNzZXMgfSA6IHt9KSxcbiAgICAgICAgICAgIGZlYXR1cmVzOiB0aGlzLmZlYXR1cmVzLCAgICAgICAgICAgIFxuICAgICAgICAgICAgZmllbGRzOiBfLm1hcFZhbHVlcyh0aGlzLmZpZWxkcywgZmllbGQgPT4gZmllbGQudG9KU09OKCkpLFxuICAgICAgICAgICAgYXNzb2NpYXRpb25zOiB0aGlzLmFzc29jaWF0aW9ucyxcbiAgICAgICAgICAgIGtleTogdGhpcy5rZXksXG4gICAgICAgICAgICBpbmRleGVzOiB0aGlzLmluZGV4ZXNcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfaW5oZXJpdChiYXNlRW50aXR5KSB7ICBcbiAgICAgICAgbGV0IG92ZXJyaWRlSW5mbyA9IHt9O1xuXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmJhc2VDbGFzc2VzKSB7XG4gICAgICAgICAgICBsZXQgYmFzZUNsYXNzZXMgPSBiYXNlRW50aXR5LmJhc2VDbGFzc2VzO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5iYXNlQ2xhc3Nlcykge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzZXMgPSBfLnVuaXEoYmFzZUNsYXNzZXMuY29uY2F0KHRoaXMuYmFzZUNsYXNzZXMpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlQ2xhc3NlcyA9IGJhc2VDbGFzc2VzLmNvbmNhdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoYmFzZUVudGl0eS5pbmZvLmZlYXR1cmVzKSkge1xuICAgICAgICAgICAgbGV0IGJhc2VGZWF0dXJlcyA9IF8uY2xvbmVEZWVwKGJhc2VFbnRpdHkuaW5mby5mZWF0dXJlcyk7ICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAodGhpcy5pbmZvLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmZlYXR1cmVzID0gYmFzZUZlYXR1cmVzLmNvbmNhdCh0aGlzLmluZm8uZmVhdHVyZXMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvdmVycmlkZUluZm8uZmVhdHVyZXMgPSBiYXNlRmVhdHVyZXM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoYmFzZUVudGl0eS5pbmZvLmZpZWxkcykpIHtcbiAgICAgICAgICAgIGxldCBmaWVsZHMgPSBfLmNsb25lRGVlcChiYXNlRW50aXR5LmluZm8uZmllbGRzKTtcbiAgICAgICAgICAgIG92ZXJyaWRlSW5mby5maWVsZHMgPSB7IC4uLmZpZWxkcywgLi4udGhpcy5pbmZvLmZpZWxkcyB9O1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoYmFzZUVudGl0eS5pbmZvLmtleSkge1xuICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmtleSA9IGJhc2VFbnRpdHkuaW5mby5rZXk7XG4gICAgICAgIH0gICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgbGV0IGluZGV4ZXMgPSBfLmNsb25lRGVlcChiYXNlRW50aXR5LmluZm8uaW5kZXhlcyk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgICAgIGluZGV4ZXMgPSBpbmRleGVzLmNvbmNhdCh0aGlzLmluZm8uaW5kZXhlcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG92ZXJyaWRlSW5mby5pbmRleGVzID0gaW5kZXhlcztcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIGxldCBhc3NvY3MgPSBfLmNsb25lRGVlcChiYXNlRW50aXR5LmluZm8uYXNzb2NpYXRpb25zKTtcblxuICAgICAgICAgICAgYXNzb2NzID0gYXNzb2NzLm1hcChhc3NvYyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGFzc29jLmRlc3RFbnRpdHkgPT09IGJhc2VFbnRpdHkubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uYXNzb2MsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXN0RW50aXR5OiB0aGlzLm5hbWVcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXNzb2M7XG4gICAgICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAodGhpcy5pbmZvLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgIGFzc29jcyA9IGFzc29jcy5jb25jYXQodGhpcy5pbmZvLmFzc29jaWF0aW9ucyk7XG4gICAgICAgICAgICB9ICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBvdmVycmlkZUluZm8uYXNzb2NpYXRpb25zID0gYXNzb2NzO1xuICAgICAgICB9ICAgICBcblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShvdmVycmlkZUluZm8pKSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuaW5mbyA9IHsgLi4udGhpcy5pbmZvLCAuLi5vdmVycmlkZUluZm8gfTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBFbnRpdHk7Il19
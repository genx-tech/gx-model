"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  deepClone,
  Clonable,
  entityNaming
} = require('./GemlUtils');

const Field = require('./Field');

const {
  Types: {
    FunctionalQualifiers
  }
} = require('@genx/data');

class Entity extends Clonable {
  constructor(linker, name, gemlModule, info) {
    super();
    this._events = new EventEmitter();
    this.fields = {};
    this.linker = linker;
    this.name = entityNaming(name);
    this.gemlModule = gemlModule;
    this.info = info;
  }

  on(eventName, listener) {
    return this._events.on(eventName, listener);
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.code) {
      this.code = this.info.code || this.name;
    }

    if (this.info.base) {
      let baseClasses = _.castArray(this.info.base);

      baseClasses.forEach(base => {
        let baseEntity = this.linker.loadEntity(this.gemlModule, base);

        if (!baseEntity.linked) {
          throw new Error("Assertion failed: baseEntity.linked");
        }

        this._inherit(baseEntity);
      });
      this.baseClasses = baseClasses;
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn;

        try {
          fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));
        } catch (err) {
          if (err.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Unknow feature "${featureName}" reference in entity "${this.name}"`);
          }
        }

        fn(this, this.linker.translateOolValue(this.gemlModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.gemlModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!index.fields) {
      throw new Error("Assertion failed: index.fields");
    }

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = _.camelCase(field);

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          if (Array.isArray(this.key)) {
            throw new Error('Combination key not support for accesor "$key".');
          }

          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, props) {
    if (!this.associations) {
      this.associations = {};
    }

    if (name in this.associations) {
      throw new Error(`Association "${name}" already exists in entity "${this.name}". Props: ` + JSON.stringify(props));
    }

    this.associations[name] = props;
  }

  addAssocField(name, destEntity, destField, extraProps) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField.toJSON(), FunctionalQualifiers);

    Object.assign(destFieldInfo, extraProps);
    this.addField(name, destFieldInfo);
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    if (!rawInfo.type) {
      throw new Error("Assertion failed: rawInfo.type");
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.gemlModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (feature.name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. Turn on allowMultiple to enable multiple occurrence of a feature.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  hasFeature(name) {
    return this.features && name in this.features;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferencedEntity(entityName) {
    return this.linker.loadEntity(this.gemlModule, entityName);
  }

  getReferenceTo(entityName, includes, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (includes) {
        if (_.find(includes, (value, prop) => typeof value === 'function' ? !value(assoc[prop]) : !_.isEqual(assoc[prop], value))) return false;
      }

      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
        if (excludes.props && _.find(excludes.props, prop => assoc[prop])) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.gemlModule, this.info);
    deepCloneField(this, entity, 'code');
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      code: this.code,
      displayName: this.displayName,
      comment: this.comment,
      ...(this.baseClasses ? {
        baseClasses: this.baseClasses
      } : {}),
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    let overrideInfo = {};

    if (baseEntity.baseClasses) {
      let baseClasses = baseEntity.baseClasses;

      if (this.baseClasses) {
        this.baseClasses = _.uniq(baseClasses.concat(this.baseClasses));
      } else {
        this.baseClasses = baseClasses.concat();
      }
    }

    if (baseEntity.features) {
      let baseFeatures = deepClone(baseEntity.features);
      this.features = { ...this.features,
        ...baseFeatures
      };
    }

    if (baseEntity.fields) {
      let fields = deepClone(baseEntity.fields);
      this.fields = { ...this.fields,
        ...fields
      };
    }

    deepCloneField(baseEntity, this, 'key');

    if (baseEntity.info.indexes) {
      let indexes = deepClone(baseEntity.info.indexes);

      if (this.info.indexes) {
        indexes = indexes.concat(this.info.indexes);
      }

      overrideInfo.indexes = indexes;
    }

    if (baseEntity.info.associations) {
      let assocs = deepClone(baseEntity.info.associations);
      assocs = assocs.map(assoc => {
        if (assoc.destEntity === baseEntity.name) {
          return { ...assoc,
            destEntity: this.name
          };
        }

        return assoc;
      });

      if (this.info.associations) {
        assocs = assocs.concat(this.info.associations);
      }

      overrideInfo.associations = assocs;
    }

    if (!_.isEmpty(overrideInfo)) {
      this.info = Object.freeze({ ...this.info,
        ...overrideInfo
      });
    }
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJkZWVwQ2xvbmUiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsIkZpZWxkIiwiVHlwZXMiLCJGdW5jdGlvbmFsUXVhbGlmaWVycyIsIkVudGl0eSIsImNvbnN0cnVjdG9yIiwibGlua2VyIiwibmFtZSIsImdlbWxNb2R1bGUiLCJpbmZvIiwiX2V2ZW50cyIsImZpZWxkcyIsIm9uIiwiZXZlbnROYW1lIiwibGlzdGVuZXIiLCJsaW5rIiwibGlua2VkIiwibG9nIiwiY29kZSIsImJhc2UiLCJiYXNlQ2xhc3NlcyIsImNhc3RBcnJheSIsImZvckVhY2giLCJiYXNlRW50aXR5IiwibG9hZEVudGl0eSIsIl9pbmhlcml0IiwiY29tbWVudCIsImRpc3BsYXlOYW1lIiwiZW1pdCIsImZlYXR1cmVzIiwiZmVhdHVyZSIsImZlYXR1cmVOYW1lIiwiZm4iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZXJyIiwiRXJyb3IiLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsImFyZ3MiLCJlYWNoIiwiZmllbGRJbmZvIiwiZmllbGROYW1lIiwiYWRkRmllbGQiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJpc0VtcHR5IiwiaW50ZXJmYWNlcyIsImNsb25lRGVlcCIsImZvck93biIsImludGYiLCJhY2NlcHQiLCJtYXAiLCJwYXJhbSIsInRyYWNrQmFja1R5cGUiLCJoYXNJbmRleE9uIiwiY29uY2F0Iiwic29ydCIsImZpbmRJbmRleCIsImluZGV4ZXMiLCJpbmRleCIsImYiLCJpZHgiLCJhZGRJbmRleGVzIiwiYWRkSW5kZXgiLCJmaWVsZCIsIm5vcm1hbGl6ZWRGaWVsZCIsImNhbWVsQ2FzZSIsImhhc0ZpZWxkIiwiam9pbiIsInB1c2giLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZElkIiwidG9rZW4iLCJzdWJzdHIiLCJldmVyeSIsImFkZEFzc29jaWF0aW9uIiwicHJvcHMiLCJhc3NvY2lhdGlvbnMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWRkQXNzb2NGaWVsZCIsImRlc3RFbnRpdHkiLCJkZXN0RmllbGQiLCJleHRyYVByb3BzIiwibG9jYWxGaWVsZCIsImRlc3RGaWVsZEluZm8iLCJvbWl0IiwidG9KU09OIiwiT2JqZWN0IiwiYXNzaWduIiwicmF3SW5mbyIsInR5cGUiLCJjbG9uZSIsImZ1bGxSYXdJbmZvIiwiYWRkRmVhdHVyZSIsImFsbG93TXVsdGlwbGUiLCJoYXNGZWF0dXJlIiwic2V0S2V5IiwiZ2V0UmVmZXJlbmNlZEVudGl0eSIsImVudGl0eU5hbWUiLCJnZXRSZWZlcmVuY2VUbyIsImluY2x1ZGVzIiwiZXhjbHVkZXMiLCJmaW5kIiwiYXNzb2MiLCJ2YWx1ZSIsInByb3AiLCJpc0VxdWFsIiwiYXNzb2NpYXRpb24iLCJpbmRleE9mIiwidHlwZXMiLCJnZXRLZXlGaWVsZCIsImtmIiwiZW50aXR5IiwibWFwVmFsdWVzIiwib3ZlcnJpZGVJbmZvIiwidW5pcSIsImJhc2VGZWF0dXJlcyIsImFzc29jcyIsImZyZWV6ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUE1Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUVBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFRRixPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUEsU0FBdkM7QUFBa0RDLEVBQUFBLFFBQWxEO0FBQTREQyxFQUFBQTtBQUE1RCxJQUE2RVAsT0FBTyxDQUFDLGFBQUQsQ0FBMUY7O0FBRUEsTUFBTVEsS0FBSyxHQUFHUixPQUFPLENBQUMsU0FBRCxD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QUFDN0gsQ0FBQyxDQUFDb0QsT0FBRixDQUFVc0UsWUFBVixDQUFMLEVBQThCO0FBQzFCLFdBQUs1RyxJQUFMLEdBQVlpRixNQUFNLENBQUMrQixNQUFQLENBQWMsRUFBRSxHQUFHLEtBQUtoSCxJQUFWO0FBQWdCLFdBQUc0RztBQUFuQixPQUFkLENBQVo7QUFDSDtBQUNKOztBQTVpQnlCOztBQStpQjlCSyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ2SCxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgZ2VuZXJhdGVEaXNwbGF5TmFtZSwgZGVlcENsb25lRmllbGQsIGRlZXBDbG9uZSwgQ2xvbmFibGUsIGVudGl0eU5hbWluZyB9ID0gcmVxdWlyZSgnLi9HZW1sVXRpbHMnKTtcblxuY29uc3QgRmllbGQgPSByZXF1aXJlKCcuL0ZpZWxkJyk7XG5jb25zdCB7IFR5cGVzOiB7IEZ1bmN0aW9uYWxRdWFsaWZpZXJzIH0gfSA9IHJlcXVpcmUoJ0BnZW54L2RhdGEnKTtcblxuLyoqXG4gKiBFbnRpdHkgZXZlbnQgbGlzdGVuZXJcbiAqIEBjYWxsYmFjayBPb2xvbmdFbnRpdHkuZXZlbnRMaXN0ZW5lclxuICogcmV0dXJucyB7Kn1cbiAqL1xuXG4vKipcbiAqIE9vbG9uZyBlbnRpdHlcbiAqIEBjbGFzcyBPb2xvbmdFbnRpdHlcbiAqL1xuY2xhc3MgRW50aXR5IGV4dGVuZHMgQ2xvbmFibGUge1xuICAgIF9ldmVudHMgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgICAvKipcbiAgICAgKiBGaWVsZHMgb2YgdGhlIGVudGl0eSwgbWFwIG9mIDxmaWVsZE5hbWUsIGZpZWxkT2JqZWN0PlxuICAgICAqIEBtZW1iZXIge29iamVjdC48c3RyaW5nLCBPb2xvbmdGaWVsZD59XG4gICAgICovXG4gICAgZmllbGRzID0ge307XG5cbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7TGlua2VyfSBsaW5rZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7Kn0gZ2VtbE1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobGlua2VyLCBuYW1lLCBnZW1sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge09vbG9uZ0xpbmtlcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubGlua2VyID0gbGlua2VyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubmFtZSA9IGVudGl0eU5hbWluZyhuYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgZ2VtbCBtb2R1bGVcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5nZW1sTW9kdWxlID0gZ2VtbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMaXN0ZW4gb24gYW4gZXZlbnRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lXG4gICAgICogQHBhcmFtIHtPb2xvbmdFbnRpdHkuZXZlbnRMaXN0ZW5lcn0gbGlzdGVuZXJcbiAgICAgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfVxuICAgICAqL1xuICAgIG9uKGV2ZW50TmFtZSwgbGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50cy5vbihldmVudE5hbWUsIGxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIHRoaXMgZW50aXR5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBsaW5rKCkge1xuICAgICAgICBwcmU6ICF0aGlzLmxpbmtlZDtcblxuICAgICAgICAvLzEuaW5oZXJpdCBmcm9tIGJhc2UgZW50aXR5IGlmIGFueVxuICAgICAgICAvLzIuaW5pdGlhbGl6ZSBmZWF0dXJlc1xuICAgICAgICAvLzMuYWRkIGZpZWxkcyAgICAgICAgXG4gICAgICAgIC8vNC5hcGlcblxuICAgICAgICAvL2luZGV4ZXMgd2lsbCBwcm9jZXNzZWQgYWZ0ZXIgcHJvY2Vzc2luZyBmb3JlaWduIHJlbGF0aW9uc2hpcFxuXG4gICAgICAgIHRoaXMubGlua2VyLmxvZygnZGVidWcnLCAnTGlua2luZyBlbnRpdHkgWycgKyB0aGlzLm5hbWUgKyAnXSAuLi4nKTtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvZGUpIHtcbiAgICAgICAgICAgIHRoaXMuY29kZSA9IHRoaXMuaW5mby5jb2RlIHx8IHRoaXMubmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uYmFzZSkge1xuICAgICAgICAgICAgLy9pbmhlcml0IGZpZWxkcywgcHJvY2Vzc2VkIGZlYXR1cmVzLCBrZXkgYW5kIGluZGV4ZXNcbiAgICAgICAgICAgIGxldCBiYXNlQ2xhc3NlcyA9IF8uY2FzdEFycmF5KHRoaXMuaW5mby5iYXNlKTtcbiAgICAgICAgICAgIGJhc2VDbGFzc2VzLmZvckVhY2goYmFzZSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGJhc2VFbnRpdHkgPSB0aGlzLmxpbmtlci5sb2FkRW50aXR5KHRoaXMuZ2VtbE1vZHVsZSwgYmFzZSk7XG4gICAgICAgICAgICAgICAgYXNzZXJ0OiBiYXNlRW50aXR5LmxpbmtlZDtcblxuICAgICAgICAgICAgICAgIHRoaXMuX2luaGVyaXQoYmFzZUVudGl0eSk7XG4gICAgICAgICAgICB9KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgdGhpcy5iYXNlQ2xhc3NlcyA9IGJhc2VDbGFzc2VzO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5jb21tZW50KSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdGhpcy5jb21tZW50ID0gdGhpcy5pbmZvLmNvbW1lbnQ7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kaXNwbGF5TmFtZSA9IGdlbmVyYXRlRGlzcGxheU5hbWUodGhpcy5uYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNmZWF0dXJlc01peGluZ0luXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnZmVhdHVyZXNNaXhpbmdJbicpO1xuXG4gICAgICAgIC8vIGxvYWQgZmVhdHVyZXNcbiAgICAgICAgaWYgKHRoaXMuaW5mby5mZWF0dXJlcykge1xuICAgICAgICAgICAgdGhpcy5pbmZvLmZlYXR1cmVzLmZvckVhY2goZmVhdHVyZSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVOYW1lO1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmZWF0dXJlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlTmFtZSA9IGZlYXR1cmU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZU5hbWUgPSBmZWF0dXJlLm5hbWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGZuO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGZuID0gcmVxdWlyZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBgLi9lbnRpdHlGZWF0dXJlcy8ke2ZlYXR1cmVOYW1lfS5qc2ApKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSAnTU9EVUxFX05PVF9GT1VORCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93IGZlYXR1cmUgXCIke2ZlYXR1cmVOYW1lfVwiIHJlZmVyZW5jZSBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cImApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZuKHRoaXMsIHRoaXMubGlua2VyLnRyYW5zbGF0ZU9vbFZhbHVlKHRoaXMuZ2VtbE1vZHVsZSwgZmVhdHVyZS5hcmdzKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2JlZm9yZUFkZGluZ0ZpZWxkc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2JlZm9yZUFkZGluZ0ZpZWxkcycpO1xuXG4gICAgICAgIC8vIHByb2Nlc3MgZmllbGRzXG4gICAgICAgIGlmICh0aGlzLmluZm8uZmllbGRzKSB7XG4gICAgICAgICAgICBfLmVhY2godGhpcy5pbmZvLmZpZWxkcywgKGZpZWxkSW5mbywgZmllbGROYW1lKSA9PiB0aGlzLmFkZEZpZWxkKGZpZWxkTmFtZSwgZmllbGRJbmZvKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNhZnRlckFkZGluZ0ZpZWxkc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2FmdGVyQWRkaW5nRmllbGRzJyk7ICAgXG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5rZXkpIHtcbiAgICAgICAgICAgIHRoaXMua2V5ID0gdGhpcy5pbmZvLmtleTtcblxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5rZXkpICYmIHRoaXMua2V5Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHRoaXMua2V5ID0gdGhpcy5rZXlbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNiZWZvcmVBZGRpbmdJbnRlcmZhY2VzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYmVmb3JlQWRkaW5nSW50ZXJmYWNlcycpOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uaW50ZXJmYWNlcykpIHtcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlcyA9IF8uY2xvbmVEZWVwKHRoaXMuaW5mby5pbnRlcmZhY2VzKTtcblxuICAgICAgICAgICAgXy5mb3JPd24odGhpcy5pbnRlcmZhY2VzLCAoaW50ZikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGludGYuYWNjZXB0KSkge1xuICAgICAgICAgICAgICAgICAgICBpbnRmLmFjY2VwdCA9IF8ubWFwKGludGYuYWNjZXB0LCBwYXJhbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLmdlbWxNb2R1bGUsIHBhcmFtKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNhZnRlckFkZGluZ0ludGVyZmFjZXNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdhZnRlckFkZGluZ0ludGVyZmFjZXMnKTsgICAgICAgIFxuXG4gICAgICAgIHRoaXMubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIHRoZSBlbnRpdHkgaGFzIGFuIGluZGV4IG9uIHRoZSBnaXZlbiBmaWVsZHNcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBmaWVsZHNcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNJbmRleE9uKGZpZWxkcykge1xuICAgICAgICBmaWVsZHMgPSBmaWVsZHMuY29uY2F0KCk7XG4gICAgICAgIGZpZWxkcy5zb3J0KCk7XG5cbiAgICAgICAgcmV0dXJuIF8uZmluZEluZGV4KHRoaXMuaW5kZXhlcywgaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBfLmZpbmRJbmRleChpbmRleC5maWVsZHMsIChmLCBpZHgpID0+IChmaWVsZHMubGVuZ3RoIDw9IGlkeCB8fCBmaWVsZHNbaWR4XSAhPT0gZikpID09PSAtMTtcbiAgICAgICAgICAgIH0pICE9IC0xO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbGwgaW5kZXhlc1xuICAgICAqL1xuICAgIGFkZEluZGV4ZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMuaW5mby5pbmRleGVzLCBpbmRleCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRJbmRleChpbmRleCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBpbmRleFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmRleFxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGluZGV4LmZpZWxkcyAtIEZpZWxkcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IGluZGV4LnVuaXF1ZSAtIEZsYWcgb2YgdW5pcXVlbmVzcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEluZGV4KGluZGV4KSB7XG4gICAgICAgIGlmICghdGhpcy5pbmRleGVzKSB7XG4gICAgICAgICAgICB0aGlzLmluZGV4ZXMgPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGluZGV4ID0gXy5jbG9uZURlZXAoaW5kZXgpO1xuXG4gICAgICAgIGFzc2VydDogaW5kZXguZmllbGRzO1xuXG4gICAgICAgIGlmICghXy5pc0FycmF5KGluZGV4LmZpZWxkcykpIHtcbiAgICAgICAgICAgIGluZGV4LmZpZWxkcyA9IFsgaW5kZXguZmllbGRzIF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmllbGRzID0gaW5kZXguZmllbGRzOyBcblxuICAgICAgICBpbmRleC5maWVsZHMgPSBfLm1hcChmaWVsZHMsIGZpZWxkID0+IHtcblxuICAgICAgICAgICAgbGV0IG5vcm1hbGl6ZWRGaWVsZCA9IF8uY2FtZWxDYXNlKGZpZWxkKTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0ZpZWxkKG5vcm1hbGl6ZWRGaWVsZCkpIHtcblxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5kZXggcmVmZXJlbmNlcyBub24tZXhpc3QgZmllbGQ6ICR7ZmllbGR9LCBlbnRpdHk6ICR7dGhpcy5uYW1lfS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRGaWVsZDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaW5kZXguZmllbGRzLnNvcnQoKTtcblxuICAgICAgICBpZiAodGhpcy5oYXNJbmRleE9uKGluZGV4LmZpZWxkcykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5kZXggb24gWyR7aW5kZXguZmllbGRzLmpvaW4oJywgJyl9XSBhbHJlYWR5IGV4aXN0IGluIGVudGl0eSBbJHt0aGlzLm5hbWV9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuaW5kZXhlcy5wdXNoKGluZGV4KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBmaWVsZCBvYmplY3QgYnkgZmllbGQgbmFtZSBvciBlbnRpdHkgbWV0YSBhY2Nlc29yIChlLmcuICRrZXksICRmZWF0dXJlKS5cbiAgICAgKiBAcGFyYW0gZmllbGRJZFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdGaWVsZH1cbiAgICAgKi9cbiAgICBnZXRFbnRpdHlBdHRyaWJ1dGUoZmllbGRJZCkge1xuICAgICAgICBpZiAoZmllbGRJZFswXSA9PT0gJyQnKSB7XG4gICAgICAgICAgICBsZXQgdG9rZW4gPSBmaWVsZElkLnN1YnN0cigxKTtcblxuICAgICAgICAgICAgc3dpdGNoICh0b2tlbikge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJrZXlcIjpcbiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5rZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbWJpbmF0aW9uIGtleSBub3Qgc3VwcG9ydCBmb3IgYWNjZXNvciBcIiRrZXlcIi4nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZHNbdGhpcy5rZXldO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAnZmVhdHVyZSc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzO1xuXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlZCBhY2Nlc3NvciBcIiR7dG9rZW59XCIgbm90IHN1cHBvcnRlZCFgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNGaWVsZChmaWVsZElkKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgXCIke2ZpZWxkSWR9XCIgbm90IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi5gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZHNbZmllbGRJZF07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIHRoZSBlbnRpdHkgaGFzIGEgZmllbGQgd2l0aCBnaXZlbiBuYW1lXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNGaWVsZChuYW1lKSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gXy5ldmVyeShuYW1lLCBmbiA9PiB0aGlzLmhhc0ZpZWxkKGZuKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmFtZSBpbiB0aGlzLmZpZWxkcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYXNzb2NpYXRpb24sIGRibXMtc3BlY2lmaWNcbiAgICAgKiBAcGFyYW0geyp9IG5hbWUgXG4gICAgICogQHBhcmFtIHsqfSBwcm9wcyBcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGUuZy4gbXlzcWxcbiAgICAgKiAgZW50aXR5IC0gQXNzb2NpYXRlZCBlbnRpdHkgbmFtZVxuICAgICAqICBqb2luIC0gSm9pbiB0eXBlLCBlLmcuIElOTkVSLCBMRUZULCBSSUdIVCwgT1VURVJcbiAgICAgKiAgZXhjbHVkZSAtIEV4Y2x1ZGUgaW4gb3V0cHV0IGNvbHVtbnNcbiAgICAgKiAgYWxpYXMgLSBBbGlhcyBcbiAgICAgKiAgb24gLSBPbiBjb25kaXRpb25zXG4gICAgICogIGRhdGFzZXQgLSBTdWIgcXVlcnlcbiAgICAgKiAgYXNzb2NzIC0gQ2hpbGQgYXNzb2NpYXRpb25zXG4gICAgICogIG9wdGlvbmFsIC0gT3B0aW9uYWxcbiAgICAgKiAgJ2RlZmF1bHQnIC0gRGVmYXVsdCB2YWx1ZVxuICAgICAqICBsaXN0IC0gSXMgYSBsaXN0XG4gICAgICovXG4gICAgYWRkQXNzb2NpYXRpb24obmFtZSwgcHJvcHMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5hc3NvY2lhdGlvbnMgPSB7fTtcbiAgICAgICAgfSAgICBcblxuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBc3NvY2lhdGlvbiBcIiR7bmFtZX1cIiBhbHJlYWR5IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi4gUHJvcHM6IGAgKyBKU09OLnN0cmluZ2lmeShwcm9wcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5hc3NvY2lhdGlvbnNbbmFtZV0gPSBwcm9wcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBhc3NvY2lhdGlvbiBmaWVsZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7T29sb25nRW50aXR5fSBkZXN0RW50aXR5XG4gICAgICogQHBhcmFtIHtPb2xvbmdGaWVsZH0gZGVzdEZpZWxkXG4gICAgICovXG4gICAgYWRkQXNzb2NGaWVsZChuYW1lLCBkZXN0RW50aXR5LCBkZXN0RmllbGQsIGV4dHJhUHJvcHMpIHtcbiAgICAgICAgbGV0IGxvY2FsRmllbGQgPSB0aGlzLmZpZWxkc1tuYW1lXTtcblxuICAgICAgICBpZiAobG9jYWxGaWVsZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBcIiR7bmFtZX1cIiBhbHJlYWR5IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkZXN0RmllbGRJbmZvID0gXy5vbWl0KGRlc3RGaWVsZC50b0pTT04oKSwgRnVuY3Rpb25hbFF1YWxpZmllcnMpO1xuICAgICAgICBPYmplY3QuYXNzaWduKGRlc3RGaWVsZEluZm8sIGV4dHJhUHJvcHMpOyAgICAgICBcblxuICAgICAgICB0aGlzLmFkZEZpZWxkKG5hbWUsIGRlc3RGaWVsZEluZm8pOyAgICBcbiAgICAgICAgLy90aGlzLmZpZWxkc1tuYW1lXS5kaXNwbGF5TmFtZSA9IGZpZWxkTmFtaW5nKHByZWZpeE5hbWluZyhkZXN0RW50aXR5Lm5hbWUsIGRlc3RGaWVsZC5uYW1lKSk7ICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgZmllbGQgaW50byB0aGUgZW50aXR5XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmF3SW5mb1xuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgYWRkRmllbGQobmFtZSwgcmF3SW5mbykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLmhhc0ZpZWxkKG5hbWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIG5hbWUgWyR7bmFtZX1dIGNvbmZsaWN0cyBpbiBlbnRpdHkgWyR7dGhpcy5uYW1lfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICBhc3NlcnQ6IHJhd0luZm8udHlwZTtcblxuICAgICAgICBsZXQgZmllbGQ7XG5cbiAgICAgICAgaWYgKHJhd0luZm8gaW5zdGFuY2VvZiBGaWVsZCkge1xuICAgICAgICAgICAgZmllbGQgPSByYXdJbmZvLmNsb25lKCk7XG4gICAgICAgICAgICBmaWVsZC5uYW1lID0gbmFtZTsgLy8gdG9kbzogZGlzcGxheU5hbWVcbiAgICAgICAgfSBlbHNlIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBmdWxsUmF3SW5mbyA9IHRoaXMubGlua2VyLnRyYWNrQmFja1R5cGUodGhpcy5nZW1sTW9kdWxlLCByYXdJbmZvKTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgZmllbGQgPSBuZXcgRmllbGQobmFtZSwgZnVsbFJhd0luZm8pO1xuICAgICAgICAgICAgZmllbGQubGluaygpO1xuICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5maWVsZHNbbmFtZV0gPSBmaWVsZDtcblxuICAgICAgICBpZiAoIXRoaXMua2V5KSB7XG4gICAgICAgICAgICAvL21ha2UgdGhlIGZpcnN0IGZpZWxkIGFzIHRoZSBkZWZhdWx0IGtleVxuICAgICAgICAgICAgdGhpcy5rZXkgPSBuYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgZmVhdHVyZSBpbnRvIHRoZSBlbnRpdHksIGUuZy4gYXV0byBpbmNyZW1lbnQgaWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7Kn0gZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7Ym9vbH0gW2FsbG93TXVsdGlwbGU9ZmFsc2VdIC0gQWxsb3cgbXVsdGlwbGUgb2NjdXJyZW5jZVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgYWRkRmVhdHVyZShuYW1lLCBmZWF0dXJlLCBhbGxvd011bHRpcGxlKSB7XG4gICAgICAgIGlmICghdGhpcy5mZWF0dXJlcykge1xuICAgICAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFsbG93TXVsdGlwbGUpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5mZWF0dXJlc1tuYW1lXSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0gPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXS5wdXNoKGZlYXR1cmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGZlYXR1cmUubmFtZSBpbiB0aGlzLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgZmVhdHVyZSBmb3VuZDogJHtuYW1lfS4gVHVybiBvbiBhbGxvd011bHRpcGxlIHRvIGVuYWJsZSBtdWx0aXBsZSBvY2N1cnJlbmNlIG9mIGEgZmVhdHVyZS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXSA9IGZlYXR1cmU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBoYXNGZWF0dXJlKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXMgJiYgKG5hbWUgaW4gdGhpcy5mZWF0dXJlcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0IGtleSBuYW1lXG4gICAgICogQHBhcmFtIHtzdHJpbmd8YXJyYXkuPHN0cmluZz59IG5hbWUgLSBGaWVsZCBuYW1lIHRvIGJlIHVzZWQgYXMgdGhlIGtleVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgc2V0S2V5KG5hbWUpIHtcbiAgICAgICAgdGhpcy5rZXkgPSBuYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBnZXRSZWZlcmVuY2VkRW50aXR5KGVudGl0eU5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGlua2VyLmxvYWRFbnRpdHkodGhpcy5nZW1sTW9kdWxlLCBlbnRpdHlOYW1lKTsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgYXNzb2NpYXRpb24gaW5mbyBpZiB0aGVyZSBpcyBjb25uZWN0aW9uIHRvIHRoZSBnaXZlbiBkZXN0aW5hdGlvbiBlbnRpdHkuXG4gICAgICovXG4gICAgZ2V0UmVmZXJlbmNlVG8oZW50aXR5TmFtZSwgaW5jbHVkZXMsIGV4Y2x1ZGVzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmluZm8uYXNzb2NpYXRpb25zICYmIF8uZmluZChcbiAgICAgICAgICAgIHRoaXMuaW5mby5hc3NvY2lhdGlvbnMsIGFzc29jID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uZmluZChpbmNsdWRlcywgKHZhbHVlLCBwcm9wKSA9PiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyAhdmFsdWUoYXNzb2NbcHJvcF0pIDogIV8uaXNFcXVhbChhc3NvY1twcm9wXSwgdmFsdWUpKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMuYXNzb2NpYXRpb24gJiYgYXNzb2MgPT09IGV4Y2x1ZGVzLmFzc29jaWF0aW9uKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy50eXBlICYmIGFzc29jLnR5cGUgPT09IGV4Y2x1ZGVzLnR5cGUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLmFzc29jaWF0aW9ucyAmJiBleGNsdWRlcy5hc3NvY2lhdGlvbnMuaW5kZXhPZihhc3NvYykgPiAtMSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMudHlwZXMgJiYgZXhjbHVkZXMudHlwZXMuaW5kZXhPZihhc3NvYy50eXBlKSA+IC0xKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5wcm9wcyAmJiBfLmZpbmQoZXhjbHVkZXMucHJvcHMsIHByb3AgPT4gYXNzb2NbcHJvcF0pKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jLmRlc3RFbnRpdHkgPT09IGVudGl0eU5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGtleSBmaWVsZCBcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBnZXRLZXlGaWVsZCgpIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodGhpcy5rZXkpID8gdGhpcy5rZXkubWFwKGtmID0+IHRoaXMuZmllbGRzW2tmXSkgOiB0aGlzLmZpZWxkc1t0aGlzLmtleV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvbmUgdGhlIGVudGl0eVxuICAgICAqIEBwYXJhbSB7TWFwfSBbc3RhY2tdIC0gUmVmZXJlbmNlIHN0YWNrIHRvIGF2b2lkIHJlY3VycmVuY2UgY29weVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgY2xvbmUoKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcblxuICAgICAgICBsZXQgZW50aXR5ID0gbmV3IEVudGl0eSh0aGlzLmxpbmtlciwgdGhpcy5uYW1lLCB0aGlzLmdlbWxNb2R1bGUsIHRoaXMuaW5mbyk7ICAgICAgICBcblxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdjb2RlJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2Rpc3BsYXlOYW1lJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2NvbW1lbnQnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZmVhdHVyZXMnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZmllbGRzJyk7ICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdhc3NvY2lhdGlvbnMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdrZXknKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbmRleGVzJyk7ICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnaW50ZXJmYWNlcycpO1xuXG4gICAgICAgIGVudGl0eS5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuIFxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSB0aGUgZW50aXR5IGludG8gYSBwbGFpbiBKU09OIG9iamVjdFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgdG9KU09OKCkge1xuICAgICAgICByZXR1cm4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbmFtZTogdGhpcy5uYW1lLCAgICAgXG4gICAgICAgICAgICBjb2RlOiB0aGlzLmNvZGUsICAgICAgICAgICAgXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogdGhpcy5kaXNwbGF5TmFtZSxcbiAgICAgICAgICAgIGNvbW1lbnQ6IHRoaXMuY29tbWVudCwgICAgICAgICAgICBcbiAgICAgICAgICAgIC4uLih0aGlzLmJhc2VDbGFzc2VzID8geyBiYXNlQ2xhc3NlczogdGhpcy5iYXNlQ2xhc3NlcyB9IDoge30pLFxuICAgICAgICAgICAgZmVhdHVyZXM6IHRoaXMuZmVhdHVyZXMsICAgICAgICAgICAgXG4gICAgICAgICAgICBmaWVsZHM6IF8ubWFwVmFsdWVzKHRoaXMuZmllbGRzLCBmaWVsZCA9PiBmaWVsZC50b0pTT04oKSksXG4gICAgICAgICAgICBhc3NvY2lhdGlvbnM6IHRoaXMuYXNzb2NpYXRpb25zLFxuICAgICAgICAgICAga2V5OiB0aGlzLmtleSxcbiAgICAgICAgICAgIGluZGV4ZXM6IHRoaXMuaW5kZXhlc1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIF9pbmhlcml0KGJhc2VFbnRpdHkpIHsgIFxuICAgICAgICBsZXQgb3ZlcnJpZGVJbmZvID0ge307XG5cbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuYmFzZUNsYXNzZXMpIHtcbiAgICAgICAgICAgIGxldCBiYXNlQ2xhc3NlcyA9IGJhc2VFbnRpdHkuYmFzZUNsYXNzZXM7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmJhc2VDbGFzc2VzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlQ2xhc3NlcyA9IF8udW5pcShiYXNlQ2xhc3Nlcy5jb25jYXQodGhpcy5iYXNlQ2xhc3NlcykpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2VDbGFzc2VzID0gYmFzZUNsYXNzZXMuY29uY2F0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYmFzZUVudGl0eS5mZWF0dXJlcykge1xuICAgICAgICAgICAgbGV0IGJhc2VGZWF0dXJlcyA9IGRlZXBDbG9uZShiYXNlRW50aXR5LmZlYXR1cmVzKTtcbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXMgPSB7IC4uLnRoaXMuZmVhdHVyZXMsIC4uLmJhc2VGZWF0dXJlcyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuZmllbGRzKSB7XG4gICAgICAgICAgICBsZXQgZmllbGRzID0gZGVlcENsb25lKGJhc2VFbnRpdHkuZmllbGRzKTtcbiAgICAgICAgICAgIHRoaXMuZmllbGRzID0geyAuLi50aGlzLmZpZWxkcywgLi4uZmllbGRzIH07XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKGJhc2VFbnRpdHksIHRoaXMsICdrZXknKTsgICAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgbGV0IGluZGV4ZXMgPSBkZWVwQ2xvbmUoYmFzZUVudGl0eS5pbmZvLmluZGV4ZXMpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgICAgICBpbmRleGVzID0gaW5kZXhlcy5jb25jYXQodGhpcy5pbmZvLmluZGV4ZXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvdmVycmlkZUluZm8uaW5kZXhlcyA9IGluZGV4ZXM7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmluZm8uYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICBsZXQgYXNzb2NzID0gZGVlcENsb25lKGJhc2VFbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMpO1xuXG4gICAgICAgICAgICBhc3NvY3MgPSBhc3NvY3MubWFwKGFzc29jID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYXNzb2MuZGVzdEVudGl0eSA9PT0gYmFzZUVudGl0eS5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5hc3NvYyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RFbnRpdHk6IHRoaXMubmFtZVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBhc3NvYztcbiAgICAgICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgICAgIGlmICh0aGlzLmluZm8uYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgYXNzb2NzID0gYXNzb2NzLmNvbmNhdCh0aGlzLmluZm8uYXNzb2NpYXRpb25zKTtcbiAgICAgICAgICAgIH0gICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIG92ZXJyaWRlSW5mby5hc3NvY2lhdGlvbnMgPSBhc3NvY3M7XG4gICAgICAgIH0gICAgIFxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KG92ZXJyaWRlSW5mbykpIHsgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5pbmZvID0gT2JqZWN0LmZyZWV6ZSh7IC4uLnRoaXMuaW5mbywgLi4ub3ZlcnJpZGVJbmZvIH0pO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEVudGl0eTsiXX0=
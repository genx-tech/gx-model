{"version":3,"sources":["../../src/commands/init.js"],"names":["path","require","_","eachAsync_","fs","throwIfFileNotExist","getSchemaConnectors","copyFileFromTemplate_","npmInstall_","gxDataPkg","gxModelPkg","module","exports","app","context","log","name","schemaName","commandLine","option","workingPath","configFile","join","existsSync","Error","config","readJson","settings","geml","gemlPath","modelPath","scriptPath","manifestPath","writeJson","spaces","ensureDir","schemaSource","resolve","__dirname","entitySource","schemaFile","entityFile","copyFile"],"mappings":"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","sourcesContent":["const path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst { throwIfFileNotExist, getSchemaConnectors } = require('../utils/helpers');\nconst copyFileFromTemplate_ = require('../utils/copyFileFromTemplate_');\nconst npmInstall_ = require('../utils/npmInstall_');\n\nconst gxDataPkg = 'genx-tech/gx-data#v2';\nconst gxModelPkg = 'genx-tech/gx-model#v2';\n\n/**\n * Build database scripts and entity models from oolong files.\n * @param {ServiceContainer} app\n * @param {object} context \n * @property {string} context.gemlPath\n * @property {string} context.modelPath         \n * @property {string} context.scriptPath\n * @property {string} context.manifestPath\n * @property {bool} context.useJsonSource\n * @property {bool} context.saveIntermediate\n * @property {object} context.schemas   \n * @returns {Promise}\n */\nmodule.exports = async (app, context) => {\n    app.log('verbose', `${app.name} init`);\n\n    const schemaName = app.commandLine.option('schema');\n\n    let workingPath = app.workingPath;\n\n    let configFile = path.join(workingPath, 'conf', `app.default.json`);\n    if (!fs.existsSync(configFile)) {\n        configFile = path.join(workingPath, 'conf', `server.default.json`);\n        if (!fs.existsSync(configFile)) {\n            throw new Error('Either \"conf/app.default.json\" or \"conf/server.default.json\" not found.');\n        }\n    }    \n\n    const config = await fs.readJson(configFile);\n    if (config.settings?.geml) {\n        throw new Error(`\"geml\" setting has already exist in ${configFile}`);\n    }\n\n    config.settings = {\n        ...config.settings,\n        geml: {\n            gemlPath: \"geml\",\n            modelPath: \"src/models\",\n            scriptPath: \"src/scripts\",\n            manifestPath: \"manifests\"\n        }\n    };\n\n    await fs.writeJson(configFile, config, { spaces: 4 });\n    app.log('info', `\"geml\" setting is added into ${configFile}`);\n\n    const gemlPath = path.join(workingPath, 'geml', 'entities');\n    await fs.ensureDir(gemlPath);\n\n    const schemaSource = path.resolve(__dirname, 'init/sample.geml');\n    const entitySource = path.resolve(__dirname, 'init/test.geml');\n\n    const schemaFile = path.join(workingPath, 'geml', `${schemaName}.geml`);\n    const entityFile = path.join(workingPath, 'geml', 'entities', 'test.geml');\n\n    await copyFileFromTemplate_(schemaSource, schemaFile, { schemaName });\n    app.log('info', `Created ${schemaFile}`);\n\n    await fs.copyFile(entitySource, entityFile);\n    app.log('info', `Created ${entityFile}`);\n\n    await npmInstall_(app, workingPath, [gxDataPkg]);\n    await npmInstall_(app, workingPath, ['-D', gxModelPkg]);    \n};\n"],"file":"init.js"}
{"version":3,"file":"init.js","names":["path","require","fs","copyFileFromTemplate_","npmInstall_","gxDataPkg","gxModelPkg","module","exports","app","context","log","name","schemaName","commandLine","option","workingPath","configFile","join","existsSync","Error","config","readJson","settings","geml","gemlPath","modelPath","scriptPath","manifestPath","writeJson","spaces","ensureDir","schemaSource","resolve","__dirname","entitySource","schemaFile","entityFile","copyFile"],"sources":["../../src/commands/init.js"],"sourcesContent":["const path = require('path');\nconst { fs } = require('@genx/sys');\nconst copyFileFromTemplate_ = require('../utils/copyFileFromTemplate_');\nconst npmInstall_ = require('../utils/npmInstall_');\n\nconst gxDataPkg = 'genx-tech/gx-data#v2';\nconst gxModelPkg = 'genx-tech/gx-model#v2';\n\n/**\n * Build database scripts and entity models from oolong files.\n * @param {ServiceContainer} app\n * @param {object} context \n * @property {string} context.gemlPath\n * @property {string} context.modelPath         \n * @property {string} context.scriptPath\n * @property {string} context.manifestPath\n * @property {bool} context.useJsonSource\n * @property {bool} context.saveIntermediate\n * @property {object} context.schemas   \n * @returns {Promise}\n */\nmodule.exports = async (app, context) => {\n    app.log('verbose', `${app.name} init`);\n\n    const schemaName = app.commandLine.option('schema');\n\n    let workingPath = app.workingPath;\n\n    let configFile = path.join(workingPath, 'conf', `app.default.json`);\n    if (!fs.existsSync(configFile)) {\n        configFile = path.join(workingPath, 'conf', `server.default.json`);\n        if (!fs.existsSync(configFile)) {\n            throw new Error('Either \"conf/app.default.json\" or \"conf/server.default.json\" not found.');\n        }\n    }    \n\n    const config = await fs.readJson(configFile);\n    if (config.settings?.geml) {\n        throw new Error(`\"geml\" setting has already exist in ${configFile}`);\n    }\n\n    config.settings = {\n        ...config.settings,\n        geml: {\n            gemlPath: \"geml\",\n            modelPath: \"src/models\",\n            scriptPath: \"src/scripts\",\n            manifestPath: \"manifests\"\n        }\n    };\n\n    await fs.writeJson(configFile, config, { spaces: 4 });\n    app.log('info', `\"geml\" setting is added into ${configFile}`);\n\n    const gemlPath = path.join(workingPath, 'geml', 'entities');\n    await fs.ensureDir(gemlPath);\n\n    const schemaSource = path.resolve(__dirname, 'init/sample.geml');\n    const entitySource = path.resolve(__dirname, 'init/test.geml');\n\n    const schemaFile = path.join(workingPath, 'geml', `${schemaName}.geml`);\n    const entityFile = path.join(workingPath, 'geml', 'entities', 'test.geml');\n\n    await copyFileFromTemplate_(schemaSource, schemaFile, { schemaName });\n    app.log('info', `Created ${schemaFile}`);\n\n    await fs.copyFile(entitySource, entityFile);\n    app.log('info', `Created ${entityFile}`);\n\n    await npmInstall_(app, workingPath, [gxDataPkg]);\n    await npmInstall_(app, workingPath, ['-D', gxModelPkg]);    \n};\n"],"mappings":"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"}
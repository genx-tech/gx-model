{"version":3,"file":"connect.js","names":["_","eachAsync_","get","set","require","fs","npmInstall_","dependencies","module","exports","app","context","log","name","schemaName","option","dataSourceType","dataSourceName","connection","config","readJson","configFullPath","dsConfig","Error","logStatement","writeJson","spaces","workingPath"],"sources":["../../src/commands/connect.js"],"sourcesContent":["const { _, eachAsync_, get, set } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst npmInstall_ = require('../utils/npmInstall_');\n\nconst dependencies = {\n    \"mysql\": [ \"mysql2\" ],\n    \"mongodb\": [ \"mongodb\" ],\n    \"rabbitmq\": [ \"amqplib\" ],\n};\n\n/**\n * Build database scripts and entity models from oolong files.\n * @param {ServiceContainer} app\n * @param {object} context \n * @property {string} context.gemlPath\n * @property {string} context.modelPath         \n * @property {string} context.scriptPath\n * @property {string} context.manifestPath\n * @property {bool} context.useJsonSource\n * @property {bool} context.saveIntermediate\n * @property {object} context.schemas   \n * @returns {Promise}\n */\nmodule.exports = async (app, context) => {\n    app.log('verbose', `${app.name} connect`);\n\n    const schemaName = app.option('schema');\n    const dataSourceType = app.option('dbms');\n    const dataSourceName = app.option('ds');\n    const connection = app.option('conn');  \n    \n    const config = await fs.readJson(context.configFullPath);\n    const dsConfig = get(config, ['dataSource', dataSourceType, dataSourceName]);\n    if (dsConfig != null) {\n        throw new Error(`Data source \"${dataSourceType}.${dataSourceName}\" already exists.`);\n    }\n\n    set(config, ['dataSource', dataSourceType, dataSourceName], {\n        connection,\n        logStatement: true\n    });    \n\n    set(config, ['settings', 'geml', 'schemas', schemaName, \"dataSource\"], `${dataSourceType}.${dataSourceName}`);\n    await fs.writeJson(context.configFullPath, config, { spaces: 4 });\n    app.log('info', `Data source for schema \"${schemaName}\" is added into ${context.configFullPath}`);\n\n    await npmInstall_(app, app.workingPath, dependencies[dataSourceType]);\n};\n"],"mappings":";;;;AAAA,MAAM;EAAEA,CAAF;EAAKC,UAAL;EAAiBC,GAAjB;EAAsBC;AAAtB,IAA8BC,OAAO,CAAC,YAAD,CAA3C;;AACA,MAAM;EAAEC;AAAF,IAASD,OAAO,CAAC,WAAD,CAAtB;;AACA,MAAME,WAAW,GAAGF,OAAO,CAAC,sBAAD,CAA3B;;AAEA,MAAMG,YAAY,GAAG;EACjB,SAAS,CAAE,QAAF,CADQ;EAEjB,WAAW,CAAE,SAAF,CAFM;EAGjB,YAAY,CAAE,SAAF;AAHK,CAArB;;AAmBAC,MAAM,CAACC,OAAP,GAAiB,OAAOC,GAAP,EAAYC,OAAZ,KAAwB;EACrCD,GAAG,CAACE,GAAJ,CAAQ,SAAR,EAAoB,GAAEF,GAAG,CAACG,IAAK,UAA/B;EAEA,MAAMC,UAAU,GAAGJ,GAAG,CAACK,MAAJ,CAAW,QAAX,CAAnB;EACA,MAAMC,cAAc,GAAGN,GAAG,CAACK,MAAJ,CAAW,MAAX,CAAvB;EACA,MAAME,cAAc,GAAGP,GAAG,CAACK,MAAJ,CAAW,IAAX,CAAvB;EACA,MAAMG,UAAU,GAAGR,GAAG,CAACK,MAAJ,CAAW,MAAX,CAAnB;EAEA,MAAMI,MAAM,GAAG,MAAMd,EAAE,CAACe,QAAH,CAAYT,OAAO,CAACU,cAApB,CAArB;EACA,MAAMC,QAAQ,GAAGpB,GAAG,CAACiB,MAAD,EAAS,CAAC,YAAD,EAAeH,cAAf,EAA+BC,cAA/B,CAAT,CAApB;;EACA,IAAIK,QAAQ,IAAI,IAAhB,EAAsB;IAClB,MAAM,IAAIC,KAAJ,CAAW,gBAAeP,cAAe,IAAGC,cAAe,mBAA3D,CAAN;EACH;;EAEDd,GAAG,CAACgB,MAAD,EAAS,CAAC,YAAD,EAAeH,cAAf,EAA+BC,cAA/B,CAAT,EAAyD;IACxDC,UADwD;IAExDM,YAAY,EAAE;EAF0C,CAAzD,CAAH;EAKArB,GAAG,CAACgB,MAAD,EAAS,CAAC,UAAD,EAAa,MAAb,EAAqB,SAArB,EAAgCL,UAAhC,EAA4C,YAA5C,CAAT,EAAqE,GAAEE,cAAe,IAAGC,cAAe,EAAxG,CAAH;EACA,MAAMZ,EAAE,CAACoB,SAAH,CAAad,OAAO,CAACU,cAArB,EAAqCF,MAArC,EAA6C;IAAEO,MAAM,EAAE;EAAV,CAA7C,CAAN;EACAhB,GAAG,CAACE,GAAJ,CAAQ,MAAR,EAAiB,2BAA0BE,UAAW,mBAAkBH,OAAO,CAACU,cAAe,EAA/F;EAEA,MAAMf,WAAW,CAACI,GAAD,EAAMA,GAAG,CAACiB,WAAV,EAAuBpB,YAAY,CAACS,cAAD,CAAnC,CAAjB;AACH,CAxBD"}
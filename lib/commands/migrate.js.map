{"version":3,"file":"migrate.js","names":["_","eachAsync_","require","throwIfFileNotExist","importDataFiles","module","exports","app","context","log","name","modelPath","scriptPath","reset","option","Object","keys","schemas","reverse","schemaName","db","Migrator","driver","migrator","reset_","schemaConfig","create_","extraOptions"],"sources":["../../src/commands/migrate.js"],"sourcesContent":["const { _, eachAsync_ } = require('@genx/july');\nconst { throwIfFileNotExist, importDataFiles } = require('../utils/helpers');\n\n/**\n * Build database scripts and entity models from oolong files.\n * @param {ServiceContainer} app\n * @param {object} context \n * @property {string} context.gemlPath\n * @property {string} context.modelPath         \n * @property {string} context.scriptPath\n * @property {string} context.manifestPath\n * @property {bool} context.useJsonSource\n * @property {bool} context.saveIntermediate\n * @property {object} context.schemas   \n * @returns {Promise}\n */\nmodule.exports = async (app, context) => {\n    app.log('verbose', `${app.name} migrate`);\n\n    throwIfFileNotExist(\"modelPath\", context.modelPath);\n    throwIfFileNotExist(\"scriptPath\", context.scriptPath);\n\n    let reset = app.option('reset');\n\n    if (reset) {\n        await eachAsync_(Object.keys(context.schemas).reverse(), async (schemaName) => {            \n            const db = app.db(schemaName);\n    \n            const Migrator = require(`../migration/${db.driver}`);\n            const migrator = new Migrator(app, context, db);\n\n            await migrator.reset_();    \n        });\n    }\n\n    return eachAsync_(context.schemas, async (schemaConfig, schemaName) => {\n        const db = app.db(schemaName);        \n    \n        const Migrator = require(`../migration/${db.driver}`);\n        const migrator = new Migrator(app, context, db);\n\n        await migrator.create_(schemaConfig.extraOptions);      \n\n        await importDataFiles(migrator, '_init');  \n    });\n};\n"],"mappings":";;;;AAAA,MAAM;EAAEA,CAAF;EAAKC;AAAL,IAAoBC,OAAO,CAAC,YAAD,CAAjC;;AACA,MAAM;EAAEC,mBAAF;EAAuBC;AAAvB,IAA2CF,OAAO,CAAC,kBAAD,CAAxD;;AAeAG,MAAM,CAACC,OAAP,GAAiB,OAAOC,GAAP,EAAYC,OAAZ,KAAwB;EACrCD,GAAG,CAACE,GAAJ,CAAQ,SAAR,EAAoB,GAAEF,GAAG,CAACG,IAAK,UAA/B;EAEAP,mBAAmB,CAAC,WAAD,EAAcK,OAAO,CAACG,SAAtB,CAAnB;EACAR,mBAAmB,CAAC,YAAD,EAAeK,OAAO,CAACI,UAAvB,CAAnB;EAEA,IAAIC,KAAK,GAAGN,GAAG,CAACO,MAAJ,CAAW,OAAX,CAAZ;;EAEA,IAAID,KAAJ,EAAW;IACP,MAAMZ,UAAU,CAACc,MAAM,CAACC,IAAP,CAAYR,OAAO,CAACS,OAApB,EAA6BC,OAA7B,EAAD,EAAyC,MAAOC,UAAP,IAAsB;MAC3E,MAAMC,EAAE,GAAGb,GAAG,CAACa,EAAJ,CAAOD,UAAP,CAAX;;MAEA,MAAME,QAAQ,GAAGnB,OAAO,CAAE,gBAAekB,EAAE,CAACE,MAAO,EAA3B,CAAxB;;MACA,MAAMC,QAAQ,GAAG,IAAIF,QAAJ,CAAad,GAAb,EAAkBC,OAAlB,EAA2BY,EAA3B,CAAjB;MAEA,MAAMG,QAAQ,CAACC,MAAT,EAAN;IACH,CAPe,CAAhB;EAQH;;EAED,OAAOvB,UAAU,CAACO,OAAO,CAACS,OAAT,EAAkB,OAAOQ,YAAP,EAAqBN,UAArB,KAAoC;IACnE,MAAMC,EAAE,GAAGb,GAAG,CAACa,EAAJ,CAAOD,UAAP,CAAX;;IAEA,MAAME,QAAQ,GAAGnB,OAAO,CAAE,gBAAekB,EAAE,CAACE,MAAO,EAA3B,CAAxB;;IACA,MAAMC,QAAQ,GAAG,IAAIF,QAAJ,CAAad,GAAb,EAAkBC,OAAlB,EAA2BY,EAA3B,CAAjB;IAEA,MAAMG,QAAQ,CAACG,OAAT,CAAiBD,YAAY,CAACE,YAA9B,CAAN;IAEA,MAAMvB,eAAe,CAACmB,QAAD,EAAW,OAAX,CAArB;EACH,CATgB,CAAjB;AAUH,CA7BD"}
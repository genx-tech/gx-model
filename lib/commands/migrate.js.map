{"version":3,"sources":["../../src/commands/migrate.js"],"names":["_","eachAsync_","require","throwIfFileNotExist","importDataFiles","module","exports","app","context","log","name","modelPath","scriptPath","reset","option","Object","keys","schemas","reverse","schemaName","db","Migrator","driver","migrator","reset_","schemaConfig","create_","extraOptions"],"mappings":";;;;AAAA,MAAM;AAAEA,EAAAA,CAAF;AAAKC,EAAAA;AAAL,IAAoBC,OAAO,CAAC,YAAD,CAAjC;;AACA,MAAM;AAAEC,EAAAA,mBAAF;AAAuBC,EAAAA;AAAvB,IAA2CF,OAAO,CAAC,kBAAD,CAAxD;;AAeAG,MAAM,CAACC,OAAP,GAAiB,OAAOC,GAAP,EAAYC,OAAZ,KAAwB;AACrCD,EAAAA,GAAG,CAACE,GAAJ,CAAQ,SAAR,EAAoB,GAAEF,GAAG,CAACG,IAAK,UAA/B;AAEAP,EAAAA,mBAAmB,CAAC,WAAD,EAAcK,OAAO,CAACG,SAAtB,CAAnB;AACAR,EAAAA,mBAAmB,CAAC,YAAD,EAAeK,OAAO,CAACI,UAAvB,CAAnB;AAEA,MAAIC,KAAK,GAAGN,GAAG,CAACO,MAAJ,CAAW,OAAX,CAAZ;;AAEA,MAAID,KAAJ,EAAW;AACP,UAAMZ,UAAU,CAACc,MAAM,CAACC,IAAP,CAAYR,OAAO,CAACS,OAApB,EAA6BC,OAA7B,EAAD,EAAyC,MAAOC,UAAP,IAAsB;AAC3E,YAAMC,EAAE,GAAGb,GAAG,CAACa,EAAJ,CAAOD,UAAP,CAAX;;AAEA,YAAME,QAAQ,GAAGnB,OAAO,CAAE,gBAAekB,EAAE,CAACE,MAAO,EAA3B,CAAxB;;AACA,YAAMC,QAAQ,GAAG,IAAIF,QAAJ,CAAad,GAAb,EAAkBC,OAAlB,EAA2BY,EAA3B,CAAjB;AAEA,YAAMG,QAAQ,CAACC,MAAT,EAAN;AACH,KAPe,CAAhB;AAQH;;AAED,SAAOvB,UAAU,CAACO,OAAO,CAACS,OAAT,EAAkB,OAAOQ,YAAP,EAAqBN,UAArB,KAAoC;AACnE,UAAMC,EAAE,GAAGb,GAAG,CAACa,EAAJ,CAAOD,UAAP,CAAX;;AAEA,UAAME,QAAQ,GAAGnB,OAAO,CAAE,gBAAekB,EAAE,CAACE,MAAO,EAA3B,CAAxB;;AACA,UAAMC,QAAQ,GAAG,IAAIF,QAAJ,CAAad,GAAb,EAAkBC,OAAlB,EAA2BY,EAA3B,CAAjB;AAEA,UAAMG,QAAQ,CAACG,OAAT,CAAiBD,YAAY,CAACE,YAA9B,CAAN;AAEA,UAAMvB,eAAe,CAACmB,QAAD,EAAW,OAAX,CAArB;AACH,GATgB,CAAjB;AAUH,CA7BD","sourcesContent":["const { _, eachAsync_ } = require('@genx/july');\nconst { throwIfFileNotExist, importDataFiles } = require('../utils/helpers');\n\n/**\n * Build database scripts and entity models from oolong files.\n * @param {ServiceContainer} app\n * @param {object} context \n * @property {string} context.gemlPath\n * @property {string} context.modelPath         \n * @property {string} context.scriptPath\n * @property {string} context.manifestPath\n * @property {bool} context.useJsonSource\n * @property {bool} context.saveIntermediate\n * @property {object} context.schemas   \n * @returns {Promise}\n */\nmodule.exports = async (app, context) => {\n    app.log('verbose', `${app.name} migrate`);\n\n    throwIfFileNotExist(\"modelPath\", context.modelPath);\n    throwIfFileNotExist(\"scriptPath\", context.scriptPath);\n\n    let reset = app.option('reset');\n\n    if (reset) {\n        await eachAsync_(Object.keys(context.schemas).reverse(), async (schemaName) => {            \n            const db = app.db(schemaName);\n    \n            const Migrator = require(`../migration/${db.driver}`);\n            const migrator = new Migrator(app, context, db);\n\n            await migrator.reset_();    \n        });\n    }\n\n    return eachAsync_(context.schemas, async (schemaConfig, schemaName) => {\n        const db = app.db(schemaName);        \n    \n        const Migrator = require(`../migration/${db.driver}`);\n        const migrator = new Migrator(app, context, db);\n\n        await migrator.create_(schemaConfig.extraOptions);      \n\n        await importDataFiles(migrator, '_init');  \n    });\n};\n"],"file":"migrate.js"}
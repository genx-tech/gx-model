{"version":3,"sources":["../../src/commands/export.js"],"names":["path","require","_","eachAsync_","fs","throwIfFileNotExist","getDateNamedDir","module","exports","app","context","log","name","gemlPath","schemaName","option","override","db","basePath","join","manifestPath","exportOutput","undefined","Migrator","connector","driver","migrator","export","Error","exportFilePath","resolve","options","configPath","readJsonSync","Array","isArray","all","exportFile","exportConfig","items","export_","concat","writeIndexFile"],"mappings":";;;;AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;AAAEC,EAAAA,CAAF;AAAKC,EAAAA;AAAL,IAAoBF,OAAO,CAAC,YAAD,CAAjC;;AACA,MAAM;AAAEG,EAAAA;AAAF,IAASH,OAAO,CAAC,WAAD,CAAtB;;AACA,MAAM;AAAEI,EAAAA,mBAAF;AAAuBC,EAAAA;AAAvB,IAA2CL,OAAO,CAAC,kBAAD,CAAxD;;AAgBAM,MAAM,CAACC,OAAP,GAAiB,OAAOC,GAAP,EAAYC,OAAZ,KAAwB;AACrCD,EAAAA,GAAG,CAACE,GAAJ,CAAQ,SAAR,EAAoB,GAAEF,GAAG,CAACG,IAAK,SAA/B;AAEAP,EAAAA,mBAAmB,CAAC,UAAD,EAAaK,OAAO,CAACG,QAArB,CAAnB;AAEA,MAAIC,UAAU,GAAGL,GAAG,CAACM,MAAJ,CAAW,QAAX,CAAjB;AACA,MAAIC,QAAQ,GAAGP,GAAG,CAACM,MAAJ,CAAW,UAAX,CAAf;AAEA,MAAIE,EAAE,GAAGR,GAAG,CAACQ,EAAJ,CAAOH,UAAP,CAAT;AAEA,MAAII,QAAQ,GAAGlB,IAAI,CAACmB,IAAL,CAAUT,OAAO,CAACU,YAAlB,EAAgC,QAAhC,CAAf;AAEA,MAAIC,YAAY,GAAGf,eAAe,CAACY,QAAD,EAAWI,SAAX,EAAsBN,QAAtB,CAAlC;;AAEA,QAAMO,QAAQ,GAAGtB,OAAO,CAAE,gBAAegB,EAAE,CAACO,SAAH,CAAaC,MAAO,EAArC,CAAxB;;AACA,QAAMC,QAAQ,GAAG,IAAIH,QAAJ,CAAad,GAAb,EAAkBC,OAAlB,EAA2BO,EAA3B,CAAjB;;AAEA,MAAI,CAACP,OAAO,CAACiB,MAAb,EAAqB;AACjB,UAAM,IAAIC,KAAJ,CAAU,uCAAV,CAAN;AACH;;AAED,MAAI,OAAOlB,OAAO,CAACiB,MAAf,KAA0B,QAA9B,EAAwC;AACpC,UAAME,cAAc,GAAG7B,IAAI,CAAC8B,OAAL,CAAarB,GAAG,CAACsB,OAAJ,CAAYC,UAAzB,EAAqCtB,OAAO,CAACiB,MAA7C,CAAvB;AACAjB,IAAAA,OAAO,CAACiB,MAAR,GAAiBvB,EAAE,CAAC6B,YAAH,CAAgBJ,cAAhB,EAAgC,MAAhC,CAAjB;AACH,GAHD,MAGO,IAAIK,KAAK,CAACC,OAAN,CAAczB,OAAO,CAACiB,MAAtB,CAAJ,EAAmC;AACtC,QAAIS,GAAG,GAAG,EAAV;AAEA,UAAMjC,UAAU,CAACO,OAAO,CAACiB,MAAT,EAAiB,MAAOU,UAAP,IAAsB;AACnD,YAAMR,cAAc,GAAG7B,IAAI,CAAC8B,OAAL,CAAarB,GAAG,CAACsB,OAAJ,CAAYC,UAAzB,EAAqCK,UAArC,CAAvB;AACA,YAAMC,YAAY,GAAGlC,EAAE,CAAC6B,YAAH,CAAgBJ,cAAhB,EAAgC,MAAhC,CAArB;AACA,YAAMU,KAAK,GAAG,MAAMb,QAAQ,CAACc,OAAT,CAAiBF,YAAjB,EAA+BjB,YAA/B,EAA6C,IAA7C,CAApB;AACAe,MAAAA,GAAG,GAAGA,GAAG,CAACK,MAAJ,CAAWF,KAAX,CAAN;AACH,KALe,CAAhB;AAOAb,IAAAA,QAAQ,CAACgB,cAAT,CAAwBrB,YAAxB,EAAsCe,GAAtC;AAEA,WAAOA,GAAP;AACH;;AAED,SAAOV,QAAQ,CAACc,OAAT,CAAiB9B,OAAO,CAACiB,MAAzB,EAAiCN,YAAjC,CAAP;AACH,CAxCD","sourcesContent":["const path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst { throwIfFileNotExist, getDateNamedDir } = require('../utils/helpers');\n\n/**\n * Build database scripts and entity models from oolong files.\n * @param {ServiceContainer} app\n * @param {object} context \n * @property {string} context.gemlPath\n * @property {string} context.modelPath         \n * @property {string} context.scriptPath\n * @property {string} context.manifestPath\n * @property {bool} context.useJsonSource\n * @property {bool} context.saveIntermediate\n * @property {object} context.schemas   \n * @property {object} context.export   \n * @returns {Promise}\n */\nmodule.exports = async (app, context) => {\n    app.log('verbose', `${app.name} export`);\n\n    throwIfFileNotExist(\"gemlPath\", context.gemlPath);\n\n    let schemaName = app.option('schema');\n    let override = app.option('override');\n\n    let db = app.db(schemaName);\n    \n    let basePath = path.join(context.manifestPath, 'export');\n\n    let exportOutput = getDateNamedDir(basePath, undefined, override);   \n\n    const Migrator = require(`../migration/${db.connector.driver}`);\n    const migrator = new Migrator(app, context, db);\n\n    if (!context.export) {\n        throw new Error('Config \"geml.export\" for is required.');\n    }\n\n    if (typeof context.export === \"string\") {\n        const exportFilePath = path.resolve(app.options.configPath, context.export);\n        context.export = fs.readJsonSync(exportFilePath, \"utf8\");\n    } else if (Array.isArray(context.export)) {\n        let all = [];\n        \n        await eachAsync_(context.export, async (exportFile) => {\n            const exportFilePath = path.resolve(app.options.configPath, exportFile);\n            const exportConfig = fs.readJsonSync(exportFilePath, \"utf8\");\n            const items = await migrator.export_(exportConfig, exportOutput, true); \n            all = all.concat(items);\n        });\n\n        migrator.writeIndexFile(exportOutput, all);\n\n        return all;\n    }\n\n    return migrator.export_(context.export, exportOutput);     \n};\n"],"file":"export.js"}
{"version":3,"file":"AppInitiator.js","names":["path","require","_","text","fs","ServiceContainer","Validators","validateObjectBySchema","moduleApi","checkModule","fromPath","name","requireFrom","createRequire","ensureEndsWith","sep","basePath","resolve","paths","find","existsSync","join","err","AppInitiator","constructor","context","app","cwd","run","command","gemlConfig","configFile","commandLine","option","configFullPath","Error","extName","extname","configName","basename","configPath","dirname","envAware","endsWith","substring","length","featuresPath","allowFeatures","Array","isArray","container","workingPath","disableEnvAwareConfig","allowedFeatures","replaceLogger","logger","start_","once","stopper","push","stop_","config","settings","geml","isEmpty","gemlPath","modelPath","scriptPath","manifestPath","useJsonSource","saveIntermediate","type","default","optional","schemas","dependencies","options","toAbsolutePath","load_","useDb","mapValues","pkgPath","pkgRoot","pathExistsSync","pkgDefaultConfig","pkgGemlPath","pkgConfig","readJsonSync","cmdMethod_","error","process","exit","module","exports"],"sources":["../src/AppInitiator.js"],"sourcesContent":["const path = require(\"path\");\nconst { _, text } = require(\"@genx/july\");\nconst { fs } = require(\"@genx/sys\");\nconst { ServiceContainer } = require(\"@genx/app\");\nconst {\n    Validators: { validateObjectBySchema },\n} = require(\"@genx/data\");\n\nconst moduleApi = require('module');\n\nconst checkModule = (fromPath, name) => {\n    try {\n        const requireFrom = moduleApi.createRequire(\n            text.ensureEndsWith(fromPath, path.sep)\n        );\n\n        const basePath = requireFrom.resolve.paths(name).find(basePath => fs.existsSync(path.join(basePath, name)));\n        return path.join(basePath, name);\n    } catch (err) {\n        return false;\n    }\n};\n\nclass AppInitiator {\n    constructor(context) {\n        this.app = context.app;\n        this.cwd = context.cwd;\n    }\n\n    async run(command) {\n        let gemlConfig;\n\n        if (command !== \"init\") {\n            let configFile = this.app.commandLine.option(\"config\");\n            let configFullPath;\n\n            if (configFile) {\n                configFullPath = path.resolve(this.cwd, configFile);\n\n                if (!fs.existsSync(configFullPath)) {\n                    throw new Error(`Config \"${configFile}\" not found!`);\n                }\n            } else {\n                configFullPath = path.resolve(this.cwd, \"conf/app.default.json\");\n\n                if (!fs.existsSync(configFullPath)) {\n                    configFullPath = path.resolve(this.cwd, \"conf/server.default.json\");\n                    if (!fs.existsSync(configFullPath)) {\n                        throw new Error('Either \"conf/app.default.json\" or \"conf/server.default.json\" not found.');\n                    }\n                }\n            }\n\n            let extName = path.extname(configFullPath);\n            if (extName !== \".json\") {\n                throw new Error(\"Only supports JSON config.\");\n            }\n\n            let configName = path.basename(configFullPath, extName);\n            let configPath = path.dirname(configFullPath);\n            let envAware = false;\n\n            if (configName.endsWith(\".default\")) {\n                envAware = true;\n                configName = configName.substring(0, configName.length - 8);\n            }\n\n            const featuresPath = this.app.commandLine.option(\"features-path\");\n\n            let allowFeatures = this.app.commandLine.option(\"allow\");\n            if (allowFeatures && !Array.isArray(allowFeatures)) {\n                allowFeatures = [allowFeatures];\n            }\n\n            this.container = new ServiceContainer(this.app.name, {\n                workingPath: this.cwd,\n                configPath,\n                configName,\n                featuresPath,\n                disableEnvAwareConfig: !envAware,\n                allowedFeatures: [\n                    \"configByHostname\",\n                    \"devConfigByGitUser\",\n                    \"appLogger\",\n                    \"loggers\",\n                    \"settings\",\n                    \"timezone\",\n                    \"version\",\n                    \"dataSource\",\n                    \"env\",\n                    \"featureRegistry\",\n                    ...(allowFeatures ?? [])\n                ],\n            });\n\n            this.container.replaceLogger(this.app.logger);\n\n            await this.container.start_();\n\n            this.app.once(\"stopping\", (stopper) => {\n                stopper.push(\n                    (async () => {\n                        await this.container.stop_();\n                    })()\n                );\n            });\n\n            this.container.option = (name) => {\n                return this.app.commandLine.option(name);\n            };\n\n            let config = this.container.settings.geml;\n            if (_.isEmpty(config)) {\n                throw new Error(\"Empty geml config!\");\n            }\n\n            let { gemlPath, modelPath, scriptPath, manifestPath, useJsonSource, saveIntermediate } =\n                validateObjectBySchema(config, {\n                    gemlPath: { type: \"text\", default: \"geml\" },\n                    modelPath: { type: \"text\", default: \"src/models\" },\n                    scriptPath: { type: \"text\", default: \"src/scripts\" },\n                    manifestPath: { type: \"text\", optional: true },\n                    useJsonSource: { type: \"boolean\", optional: true, default: false },\n                    saveIntermediate: { type: \"boolean\", optional: true, default: false },\n                    schemas: {\n                        type: \"object\",\n                        optional: true,\n                    },\n                    dependencies: {\n                        type: \"object\",\n                        optional: true,\n                    },\n                });\n\n            this.container.options.modelPath = modelPath;\n\n            gemlPath = this.container.toAbsolutePath(gemlPath);\n            modelPath = this.container.toAbsolutePath(modelPath);\n            scriptPath = this.container.toAbsolutePath(scriptPath);\n            manifestPath = manifestPath && this.container.toAbsolutePath(manifestPath);\n\n            gemlConfig = {\n                ...config,\n                gemlPath,\n                modelPath,\n                scriptPath,\n                manifestPath,\n                useJsonSource,\n                saveIntermediate,\n                configFullPath,\n            };\n\n            if (!_.isEmpty(gemlConfig.schemas)) {\n                const { load_: useDb } = require(\"@genx/app/lib/features/useDb\");\n                await useDb(this.container, gemlConfig.schemas);\n            }\n\n            if (!_.isEmpty(gemlConfig.dependencies)) {\n                gemlConfig.dependencies = _.mapValues(gemlConfig.dependencies, (pkgPath) => {\n                    let pkgRoot = this.container.toAbsolutePath(pkgPath);\n                    if (!fs.pathExistsSync(pkgRoot)) {\n                        pkgRoot = checkModule(this.container.workingPath, pkgPath);\n                        if (!pkgRoot) {\n                            throw new Error(`Dependency package \"${pkgPath}\" not found.`);\n                        }\n                    }\n\n                    const pkgDefaultConfig = path.resolve(pkgRoot, \"conf/app.default.config\");\n\n                    let pkgGemlPath;\n\n                    if (fs.existsSync(pkgDefaultConfig)) {\n                        const pkgConfig = fs.readJsonSync(pkgDefaultConfig);\n                        pkgGemlPath = pkgConfig.settings?.geml?.gemlPath;\n                    }\n\n                    return path.join(pkgRoot, pkgGemlPath || \"geml\");\n                });\n            }\n        } else {\n            this.container = this.app;\n        }\n\n        let cmdMethod_ = require(\"./commands/\" + command);\n\n        try {\n            await cmdMethod_(this.container, gemlConfig);\n        } catch (error) {\n            throw error;\n            //this.app.log('error', error.message);\n            process.exit(1);\n        }\n    }\n}\n\nmodule.exports = AppInitiator;\n"],"mappings":"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"}
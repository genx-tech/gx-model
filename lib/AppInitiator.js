"use strict";

require("source-map-support/register");

const path = require('path');

const {
  fs,
  _
} = require('rk-utils');

const {
  ServiceContainer
} = require('@genx/app');

const {
  Validators: {
    validateObjectBySchema
  }
} = require('@genx/data');

class AppInitiator {
  constructor(context) {
    this.app = context.app;
    this.cwd = context.cwd;
  }

  async run(command) {
    let configFile = this.app.commandLine.option('config') || 'geml.json';
    let configFullPath = path.resolve(this.cwd, configFile);

    if (!fs.existsSync(configFullPath)) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('GemlCore', {
      workingPath: this.cwd,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['configByHostname', 'devConfigByGitUser', 'appLogger', 'loggers', 'settings', 'timezone', 'version', 'dataSource', 'env']
    });
    this.container.replaceLogger(this.app.logger);
    await this.container.start_();
    this.app.once('stopping', stopper => {
      stopper.push((async () => {
        await this.container.stop_();
      })());
    });

    this.container.option = name => {
      return this.app.commandLine.option(name);
    };

    let config = this.container.settings.geml;

    if (_.isEmpty(config)) {
      throw new Error('Empty geml config!');
    }

    let {
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    } = validateObjectBySchema(config, {
      'gemlPath': {
        type: 'text',
        default: 'geml'
      },
      'modelPath': {
        type: 'text',
        default: 'src/models'
      },
      'scriptPath': {
        type: 'text',
        default: 'src/scripts'
      },
      'manifestPath': {
        type: 'text',
        default: 'manifests'
      },
      'useJsonSource': {
        type: 'boolean',
        default: false
      },
      'saveIntermediate': {
        type: 'boolean',
        default: false
      }
    });
    this.container.options.modelPath = modelPath;
    gemlPath = this.container.toAbsolutePath(gemlPath);
    modelPath = this.container.toAbsolutePath(modelPath);
    scriptPath = this.container.toAbsolutePath(scriptPath);
    manifestPath = this.container.toAbsolutePath(manifestPath);
    let gemlConfig = { ...config,
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    };

    if (!_.isEmpty(gemlConfig.schemas)) {
      const {
        load_: useDb
      } = require('@genx/app/lib/features/useDb');

      await useDb(this.container, gemlConfig.schemas);
    }

    let cmdMethod_ = require('./commands/' + command);

    try {
      await cmdMethod_(this.container, gemlConfig);
    } catch (error) {
      throw error;
      this.app.logError(error);
      process.exit(1);
    }
  }

}

module.exports = AppInitiator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBJbml0aWF0b3IuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJmcyIsIl8iLCJTZXJ2aWNlQ29udGFpbmVyIiwiVmFsaWRhdG9ycyIsInZhbGlkYXRlT2JqZWN0QnlTY2hlbWEiLCJBcHBJbml0aWF0b3IiLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJhcHAiLCJjd2QiLCJydW4iLCJjb21tYW5kIiwiY29uZmlnRmlsZSIsImNvbW1hbmRMaW5lIiwib3B0aW9uIiwiY29uZmlnRnVsbFBhdGgiLCJyZXNvbHZlIiwiZXhpc3RzU3luYyIsIkVycm9yIiwiZXh0TmFtZSIsImV4dG5hbWUiLCJjb25maWdOYW1lIiwiYmFzZW5hbWUiLCJjb25maWdQYXRoIiwiZGlybmFtZSIsImVudkF3YXJlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJjb250YWluZXIiLCJ3b3JraW5nUGF0aCIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImFsbG93ZWRGZWF0dXJlcyIsInJlcGxhY2VMb2dnZXIiLCJsb2dnZXIiLCJzdGFydF8iLCJvbmNlIiwic3RvcHBlciIsInB1c2giLCJzdG9wXyIsIm5hbWUiLCJjb25maWciLCJzZXR0aW5ncyIsImdlbWwiLCJpc0VtcHR5IiwiZ2VtbFBhdGgiLCJtb2RlbFBhdGgiLCJzY3JpcHRQYXRoIiwibWFuaWZlc3RQYXRoIiwidXNlSnNvblNvdXJjZSIsInNhdmVJbnRlcm1lZGlhdGUiLCJ0eXBlIiwiZGVmYXVsdCIsIm9wdGlvbnMiLCJ0b0Fic29sdXRlUGF0aCIsImdlbWxDb25maWciLCJzY2hlbWFzIiwibG9hZF8iLCJ1c2VEYiIsImNtZE1ldGhvZF8iLCJlcnJvciIsImxvZ0Vycm9yIiwicHJvY2VzcyIsImV4aXQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLEVB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LENBQVo7QUFDQUMsSUFBQUEsVUFBVSxHQUFHLEtBQUtsQixTQUFMLENBQWV5QixjQUFmLENBQThCUCxVQUE5QixDQUFiO0FBQ0FDLElBQUFBLFlBQVksR0FBRyxLQUFLbkIsU0FBTCxDQUFleUIsY0FBZixDQUE4Qk4sWUFBOUIsQ0FBZjtBQUVBLFFBQUlPLFVBQVUsR0FBRyxFQUNiLEdBQUdkLE1BRFU7QUFFYkksTUFBQUEsUUFGYTtBQUdiQyxNQUFBQSxTQUhhO0FBSWJDLE1BQUFBLFVBSmE7QUFLYkMsTUFBQUEsWUFMYTtBQU1iQyxNQUFBQSxhQU5hO0FBT2JDLE1BQUFBO0FBUGEsS0FBakI7O0FBVUEsUUFBSSxDQUFDakQsQ0FBQyxDQUFDMkMsT0FBRixDQUFVVyxVQUFVLENBQUNDLE9BQXJCLENBQUwsRUFBb0M7QUFDaEMsWUFBTTtBQUFFQyxRQUFBQSxLQUFLLEVBQUVDO0FBQVQsVUFBbUIzRCxPQUFPLENBQUMsOEJBQUQsQ0FBaEM7O0FBQ0EsWUFBTTJELEtBQUssQ0FBQyxLQUFLN0IsU0FBTixFQUFpQjBCLFVBQVUsQ0FBQ0MsT0FBNUIsQ0FBWDtBQUNIOztBQUVELFFBQUlHLFVBQVUsR0FBRzVELE9BQU8sQ0FBQyxnQkFBZ0JZLE9BQWpCLENBQXhCOztBQUVBLFFBQUk7QUFDQSxZQUFNZ0QsVUFBVSxDQUFDLEtBQUs5QixTQUFOLEVBQWlCMEIsVUFBakIsQ0FBaEI7QUFDSCxLQUZELENBRUUsT0FBT0ssS0FBUCxFQUFjO0FBRVIsWUFBTUEsS0FBTjtBQUdKLFdBQUtwRCxHQUFMLENBQVNxRCxRQUFULENBQWtCRCxLQUFsQjtBQUNBRSxNQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FBYSxDQUFiO0FBQ0g7QUFDSjs7QUFuSGM7O0FBc0huQkMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCNUQsWUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBmcywgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgU2VydmljZUNvbnRhaW5lciB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5jb25zdCB7IFZhbGlkYXRvcnM6IHsgdmFsaWRhdGVPYmplY3RCeVNjaGVtYSB9IH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJylcblxuY2xhc3MgQXBwSW5pdGlhdG9yIHtcbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7XG4gICAgICAgIHRoaXMuYXBwID0gY29udGV4dC5hcHA7XG4gICAgICAgIHRoaXMuY3dkID0gY29udGV4dC5jd2Q7XG4gICAgfVxuXG4gICAgYXN5bmMgcnVuKGNvbW1hbmQpIHsgICAgICAgIFxuICAgICAgICBsZXQgY29uZmlnRmlsZSA9IHRoaXMuYXBwLmNvbW1hbmRMaW5lLm9wdGlvbignY29uZmlnJykgfHwgJ2dlbWwuanNvbic7ICAgICAgICAgICAgICAgIFxuICAgICAgICBsZXQgY29uZmlnRnVsbFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5jd2QsIGNvbmZpZ0ZpbGUpO1xuXG4gICAgICAgIGlmICghKGZzLmV4aXN0c1N5bmMoY29uZmlnRnVsbFBhdGgpKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgXCIke2NvbmZpZ0ZpbGV9XCIgbm90IGZvdW5kIWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV4dE5hbWUgPSBwYXRoLmV4dG5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBpZiAoZXh0TmFtZSAhPT0gJy5qc29uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IHN1cHBvcnRzIEpTT04gY29uZmlnLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbmZpZ05hbWUgPSBwYXRoLmJhc2VuYW1lKGNvbmZpZ0Z1bGxQYXRoLCBleHROYW1lKTtcbiAgICAgICAgbGV0IGNvbmZpZ1BhdGggPSBwYXRoLmRpcm5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBsZXQgZW52QXdhcmUgPSBmYWxzZTtcblxuICAgICAgICBpZiAoY29uZmlnTmFtZS5lbmRzV2l0aCgnLmRlZmF1bHQnKSkge1xuICAgICAgICAgICAgZW52QXdhcmUgPSB0cnVlO1xuICAgICAgICAgICAgY29uZmlnTmFtZSA9IGNvbmZpZ05hbWUuc3Vic3RyKDAsIGNvbmZpZ05hbWUubGVuZ3RoIC0gOCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyBTZXJ2aWNlQ29udGFpbmVyKCdHZW1sQ29yZScsIHtcbiAgICAgICAgICAgIHdvcmtpbmdQYXRoOiB0aGlzLmN3ZCxcbiAgICAgICAgICAgIGNvbmZpZ1BhdGgsXG4gICAgICAgICAgICBjb25maWdOYW1lLCAgICAgICAgICAgIFxuICAgICAgICAgICAgZGlzYWJsZUVudkF3YXJlQ29uZmlnOiAhZW52QXdhcmUsXG4gICAgICAgICAgICBhbGxvd2VkRmVhdHVyZXM6IFtcbiAgICAgICAgICAgICAgICAnY29uZmlnQnlIb3N0bmFtZScsICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnZGV2Q29uZmlnQnlHaXRVc2VyJywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ2FwcExvZ2dlcicsXG4gICAgICAgICAgICAgICAgJ2xvZ2dlcnMnLCAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdzZXR0aW5ncycsXG4gICAgICAgICAgICAgICAgJ3RpbWV6b25lJyxcbiAgICAgICAgICAgICAgICAndmVyc2lvbicsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdkYXRhU291cmNlJyxcbiAgICAgICAgICAgICAgICAnZW52J1xuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5yZXBsYWNlTG9nZ2VyKHRoaXMuYXBwLmxvZ2dlcik7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5jb250YWluZXIuc3RhcnRfKCk7XG5cbiAgICAgICAgdGhpcy5hcHAub25jZSgnc3RvcHBpbmcnLCBzdG9wcGVyID0+IHtcbiAgICAgICAgICAgIHN0b3BwZXIucHVzaCgoYXN5bmMgKCkgPT4geyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNvbnRhaW5lci5zdG9wXygpO1xuICAgICAgICAgICAgfSkoKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY29udGFpbmVyLm9wdGlvbiA9IChuYW1lKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hcHAuY29tbWFuZExpbmUub3B0aW9uKG5hbWUpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBjb25maWcgPSB0aGlzLmNvbnRhaW5lci5zZXR0aW5ncy5nZW1sO1xuICAgICAgICBpZiAoXy5pc0VtcHR5KGNvbmZpZykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRW1wdHkgZ2VtbCBjb25maWchJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgeyBcbiAgICAgICAgICAgIGdlbWxQYXRoLCBcbiAgICAgICAgICAgIG1vZGVsUGF0aCwgXG4gICAgICAgICAgICBzY3JpcHRQYXRoLFxuICAgICAgICAgICAgbWFuaWZlc3RQYXRoLFxuICAgICAgICAgICAgdXNlSnNvblNvdXJjZSxcbiAgICAgICAgICAgIHNhdmVJbnRlcm1lZGlhdGUgXG4gICAgICAgIH0gPSB2YWxpZGF0ZU9iamVjdEJ5U2NoZW1hKGNvbmZpZywge1xuICAgICAgICAgICAgJ2dlbWxQYXRoJzogeyB0eXBlOiAndGV4dCcsIGRlZmF1bHQ6ICdnZW1sJyB9LFxuICAgICAgICAgICAgJ21vZGVsUGF0aCc6IHsgdHlwZTogJ3RleHQnLCBkZWZhdWx0OiAnc3JjL21vZGVscycgfSxcbiAgICAgICAgICAgICdzY3JpcHRQYXRoJzogeyB0eXBlOiAndGV4dCcsIGRlZmF1bHQ6ICdzcmMvc2NyaXB0cycgfSxcbiAgICAgICAgICAgICdtYW5pZmVzdFBhdGgnOiB7IHR5cGU6ICd0ZXh0JywgZGVmYXVsdDogJ21hbmlmZXN0cycgfSxcbiAgICAgICAgICAgICd1c2VKc29uU291cmNlJzogeyB0eXBlOiAnYm9vbGVhbicsIGRlZmF1bHQ6IGZhbHNlIH0sXG4gICAgICAgICAgICAnc2F2ZUludGVybWVkaWF0ZSc6IHsgdHlwZTogJ2Jvb2xlYW4nLCBkZWZhdWx0OiBmYWxzZSB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY29udGFpbmVyLm9wdGlvbnMubW9kZWxQYXRoID0gbW9kZWxQYXRoO1xuICAgICAgICBcbiAgICAgICAgZ2VtbFBhdGggPSB0aGlzLmNvbnRhaW5lci50b0Fic29sdXRlUGF0aChnZW1sUGF0aCk7ICAgIFxuICAgICAgICBtb2RlbFBhdGggPSB0aGlzLmNvbnRhaW5lci50b0Fic29sdXRlUGF0aChtb2RlbFBhdGgpO1xuICAgICAgICBzY3JpcHRQYXRoID0gdGhpcy5jb250YWluZXIudG9BYnNvbHV0ZVBhdGgoc2NyaXB0UGF0aCk7XG4gICAgICAgIG1hbmlmZXN0UGF0aCA9IHRoaXMuY29udGFpbmVyLnRvQWJzb2x1dGVQYXRoKG1hbmlmZXN0UGF0aCk7XG4gICAgICAgIFxuICAgICAgICBsZXQgZ2VtbENvbmZpZyA9IHsgXG4gICAgICAgICAgICAuLi5jb25maWcsXG4gICAgICAgICAgICBnZW1sUGF0aCwgXG4gICAgICAgICAgICBtb2RlbFBhdGgsIFxuICAgICAgICAgICAgc2NyaXB0UGF0aCxcbiAgICAgICAgICAgIG1hbmlmZXN0UGF0aCxcbiAgICAgICAgICAgIHVzZUpzb25Tb3VyY2UsXG4gICAgICAgICAgICBzYXZlSW50ZXJtZWRpYXRlICBcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShnZW1sQ29uZmlnLnNjaGVtYXMpKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCB7IGxvYWRfOiB1c2VEYiB9ID0gcmVxdWlyZSgnQGdlbngvYXBwL2xpYi9mZWF0dXJlcy91c2VEYicpO1xuICAgICAgICAgICAgYXdhaXQgdXNlRGIodGhpcy5jb250YWluZXIsIGdlbWxDb25maWcuc2NoZW1hcyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY21kTWV0aG9kXyA9IHJlcXVpcmUoJy4vY29tbWFuZHMvJyArIGNvbW1hbmQpOyAgICAgICAgXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGNtZE1ldGhvZF8odGhpcy5jb250YWluZXIsIGdlbWxDb25maWcpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZGV2OiB7XG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZ0Vycm9yKGVycm9yKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfSAgICAgICAgXG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEFwcEluaXRpYXRvcjsiXX0=
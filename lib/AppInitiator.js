"use strict";

require("source-map-support/register");

const path = require('path');

const {
  fs,
  _
} = require('rk-utils');

const {
  ServiceContainer
} = require('@genx/app');

const {
  Validators: {
    validateObjectBySchema
  }
} = require('@genx/data');

class AppInitiator {
  constructor(context) {
    this.app = context.app;
    this.cwd = context.cwd;
  }

  async run(command) {
    let configFile = this.app.commandLine.option('config') || 'geml.json';
    let configFullPath = path.resolve(this.cwd, configFile);

    if (!fs.existsSync(configFullPath)) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('GemlCore', {
      workingPath: this.cwd,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['configByHostname', 'devConfigByGitUser', 'appLogger', 'loggers', 'settings', 'timezone', 'version', 'dataSource', 'env']
    });
    this.container.replaceLogger(this.app.logger);
    await this.container.start_();
    this.app.on('stopping', stopper => {
      stopper.push((async () => {
        await this.container.stop_();
      })());
    });

    this.container.option = name => {
      return this.app.commandLine.option(name);
    };

    let config = this.container.settings.geml;

    if (_.isEmpty(config)) {
      throw new Error('Empty geml config!');
    }

    let {
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    } = validateObjectBySchema(config, {
      'gemlPath': {
        type: 'text',
        default: 'geml'
      },
      'modelPath': {
        type: 'text',
        default: 'src/models'
      },
      'scriptPath': {
        type: 'text',
        default: 'src/scripts'
      },
      'manifestPath': {
        type: 'text',
        default: 'manifests'
      },
      'useJsonSource': {
        type: 'boolean',
        default: false
      },
      'saveIntermediate': {
        type: 'boolean',
        default: false
      }
    });
    this.container.options.modelPath = modelPath;
    gemlPath = this.container.toAbsolutePath(gemlPath);
    modelPath = this.container.toAbsolutePath(modelPath);
    scriptPath = this.container.toAbsolutePath(scriptPath);
    manifestPath = this.container.toAbsolutePath(manifestPath);
    let gemlConfig = { ...config,
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    };

    if (!_.isEmpty(gemlConfig.schemas)) {
      const {
        load_: useDb
      } = require('@genx/app/lib/features/useDb');

      await useDb(this.container, gemlConfig.schemas);
    }

    let cmdMethod_ = require('./commands/' + command);

    await cmdMethod_(this.container, gemlConfig);
  }

}

module.exports = AppInitiator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBJbml0aWF0b3IuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJmcyIsIl8iLCJTZXJ2aWNlQ29udGFpbmVyIiwiVmFsaWRhdG9ycyIsInZhbGlkYXRlT2JqZWN0QnlTY2hlbWEiLCJBcHBJbml0aWF0b3IiLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJhcHAiLCJjd2QiLCJydW4iLCJjb21tYW5kIiwiY29uZmlnRmlsZSIsImNvbW1hbmRMaW5lIiwib3B0aW9uIiwiY29uZmlnRnVsbFBhdGgiLCJyZXNvbHZlIiwiZXhpc3RzU3luYyIsIkVycm9yIiwiZXh0TmFtZSIsImV4dG5hbWUiLCJjb25maWdOYW1lIiwiYmFzZW5hbWUiLCJjb25maWdQYXRoIiwiZGlybmFtZSIsImVudkF3YXJlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJjb250YWluZXIiLCJ3b3JraW5nUGF0aCIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImFsbG93ZWRGZWF0dXJlcyIsInJlcGxhY2VMb2dnZXIiLCJsb2dnZXIiLCJzdGFydF8iLCJvbiIsInN0b3BwZXIiLCJwdXNoIiwic3RvcF8iLCJuYW1lIiwiY29uZmlnIiwic2V0dGluZ3MiLCJnZW1sIiwiaXNFbXB0eSIsImdlbWxQYXRoIiwibW9kZWxQYXRoIiwic2NyaXB0UGF0aCIsIm1hbmlmZXN0UGF0aCIsInVzZUpzb25Tb3VyY2UiLCJzYXZlSW50ZXJtZWRpYXRlIiwidHlwZSIsImRlZmF1bHQiLCJvcHRpb25zIiwidG9BYnNvbHV0ZVBhdGgiLCJnZW1sQ29uZmlnIiwic2NoZW1hcyIsImxvYWRfIiwidXNlRGIiLCJjbWRNZXRob2RfIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxFQUFGO0FBQU1DLEVBQUFBO0FBQU4sSUFBWUYsT0FBTyxDQUFDLFVB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TCxDQUFleUIsY0FBZixDQUE4QlAsVUFBOUIsQ0FBYjtBQUNBQyxJQUFBQSxZQUFZLEdBQUcsS0FBS25CLFNBQUwsQ0FBZXlCLGNBQWYsQ0FBOEJOLFlBQTlCLENBQWY7QUFFQSxRQUFJTyxVQUFVLEdBQUcsRUFDYixHQUFHZCxNQURVO0FBRWJJLE1BQUFBLFFBRmE7QUFHYkMsTUFBQUEsU0FIYTtBQUliQyxNQUFBQSxVQUphO0FBS2JDLE1BQUFBLFlBTGE7QUFNYkMsTUFBQUEsYUFOYTtBQU9iQyxNQUFBQTtBQVBhLEtBQWpCOztBQVVBLFFBQUksQ0FBQ2pELENBQUMsQ0FBQzJDLE9BQUYsQ0FBVVcsVUFBVSxDQUFDQyxPQUFyQixDQUFMLEVBQW9DO0FBQ2hDLFlBQU07QUFBRUMsUUFBQUEsS0FBSyxFQUFFQztBQUFULFVBQW1CM0QsT0FBTyxDQUFDLDhCQUFELENBQWhDOztBQUNBLFlBQU0yRCxLQUFLLENBQUMsS0FBSzdCLFNBQU4sRUFBaUIwQixVQUFVLENBQUNDLE9BQTVCLENBQVg7QUFDSDs7QUFFRCxRQUFJRyxVQUFVLEdBQUc1RCxPQUFPLENBQUMsZ0JBQWdCWSxPQUFqQixDQUF4Qjs7QUFDQSxVQUFNZ0QsVUFBVSxDQUFDLEtBQUs5QixTQUFOLEVBQWlCMEIsVUFBakIsQ0FBaEI7QUFDSDs7QUF6R2M7O0FBNEduQkssTUFBTSxDQUFDQyxPQUFQLEdBQWlCeEQsWUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBmcywgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgU2VydmljZUNvbnRhaW5lciB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5jb25zdCB7IFZhbGlkYXRvcnM6IHsgdmFsaWRhdGVPYmplY3RCeVNjaGVtYSB9IH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJylcblxuY2xhc3MgQXBwSW5pdGlhdG9yIHtcbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7XG4gICAgICAgIHRoaXMuYXBwID0gY29udGV4dC5hcHA7XG4gICAgICAgIHRoaXMuY3dkID0gY29udGV4dC5jd2Q7XG4gICAgfVxuXG4gICAgYXN5bmMgcnVuKGNvbW1hbmQpIHsgICAgICAgIFxuICAgICAgICBsZXQgY29uZmlnRmlsZSA9IHRoaXMuYXBwLmNvbW1hbmRMaW5lLm9wdGlvbignY29uZmlnJykgfHwgJ2dlbWwuanNvbic7ICAgICAgICAgICAgICAgIFxuICAgICAgICBsZXQgY29uZmlnRnVsbFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5jd2QsIGNvbmZpZ0ZpbGUpO1xuXG4gICAgICAgIGlmICghKGZzLmV4aXN0c1N5bmMoY29uZmlnRnVsbFBhdGgpKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgXCIke2NvbmZpZ0ZpbGV9XCIgbm90IGZvdW5kIWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV4dE5hbWUgPSBwYXRoLmV4dG5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBpZiAoZXh0TmFtZSAhPT0gJy5qc29uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IHN1cHBvcnRzIEpTT04gY29uZmlnLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbmZpZ05hbWUgPSBwYXRoLmJhc2VuYW1lKGNvbmZpZ0Z1bGxQYXRoLCBleHROYW1lKTtcbiAgICAgICAgbGV0IGNvbmZpZ1BhdGggPSBwYXRoLmRpcm5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBsZXQgZW52QXdhcmUgPSBmYWxzZTtcblxuICAgICAgICBpZiAoY29uZmlnTmFtZS5lbmRzV2l0aCgnLmRlZmF1bHQnKSkge1xuICAgICAgICAgICAgZW52QXdhcmUgPSB0cnVlO1xuICAgICAgICAgICAgY29uZmlnTmFtZSA9IGNvbmZpZ05hbWUuc3Vic3RyKDAsIGNvbmZpZ05hbWUubGVuZ3RoIC0gOCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyBTZXJ2aWNlQ29udGFpbmVyKCdHZW1sQ29yZScsIHtcbiAgICAgICAgICAgIHdvcmtpbmdQYXRoOiB0aGlzLmN3ZCxcbiAgICAgICAgICAgIGNvbmZpZ1BhdGgsXG4gICAgICAgICAgICBjb25maWdOYW1lLCAgICAgICAgICAgIFxuICAgICAgICAgICAgZGlzYWJsZUVudkF3YXJlQ29uZmlnOiAhZW52QXdhcmUsXG4gICAgICAgICAgICBhbGxvd2VkRmVhdHVyZXM6IFtcbiAgICAgICAgICAgICAgICAnY29uZmlnQnlIb3N0bmFtZScsICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnZGV2Q29uZmlnQnlHaXRVc2VyJywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ2FwcExvZ2dlcicsXG4gICAgICAgICAgICAgICAgJ2xvZ2dlcnMnLCAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdzZXR0aW5ncycsXG4gICAgICAgICAgICAgICAgJ3RpbWV6b25lJyxcbiAgICAgICAgICAgICAgICAndmVyc2lvbicsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdkYXRhU291cmNlJyxcbiAgICAgICAgICAgICAgICAnZW52J1xuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5yZXBsYWNlTG9nZ2VyKHRoaXMuYXBwLmxvZ2dlcik7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5jb250YWluZXIuc3RhcnRfKCk7XG5cbiAgICAgICAgdGhpcy5hcHAub24oJ3N0b3BwaW5nJywgc3RvcHBlciA9PiB7XG4gICAgICAgICAgICBzdG9wcGVyLnB1c2goKGFzeW5jICgpID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jb250YWluZXIuc3RvcF8oKTtcbiAgICAgICAgICAgIH0pKCkpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5vcHRpb24gPSAobmFtZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXBwLmNvbW1hbmRMaW5lLm9wdGlvbihuYW1lKTtcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgY29uZmlnID0gdGhpcy5jb250YWluZXIuc2V0dGluZ3MuZ2VtbDtcbiAgICAgICAgaWYgKF8uaXNFbXB0eShjb25maWcpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VtcHR5IGdlbWwgY29uZmlnIScpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHsgXG4gICAgICAgICAgICBnZW1sUGF0aCwgXG4gICAgICAgICAgICBtb2RlbFBhdGgsIFxuICAgICAgICAgICAgc2NyaXB0UGF0aCxcbiAgICAgICAgICAgIG1hbmlmZXN0UGF0aCxcbiAgICAgICAgICAgIHVzZUpzb25Tb3VyY2UsXG4gICAgICAgICAgICBzYXZlSW50ZXJtZWRpYXRlIFxuICAgICAgICB9ID0gdmFsaWRhdGVPYmplY3RCeVNjaGVtYShjb25maWcsIHtcbiAgICAgICAgICAgICdnZW1sUGF0aCc6IHsgdHlwZTogJ3RleHQnLCBkZWZhdWx0OiAnZ2VtbCcgfSxcbiAgICAgICAgICAgICdtb2RlbFBhdGgnOiB7IHR5cGU6ICd0ZXh0JywgZGVmYXVsdDogJ3NyYy9tb2RlbHMnIH0sXG4gICAgICAgICAgICAnc2NyaXB0UGF0aCc6IHsgdHlwZTogJ3RleHQnLCBkZWZhdWx0OiAnc3JjL3NjcmlwdHMnIH0sXG4gICAgICAgICAgICAnbWFuaWZlc3RQYXRoJzogeyB0eXBlOiAndGV4dCcsIGRlZmF1bHQ6ICdtYW5pZmVzdHMnIH0sXG4gICAgICAgICAgICAndXNlSnNvblNvdXJjZSc6IHsgdHlwZTogJ2Jvb2xlYW4nLCBkZWZhdWx0OiBmYWxzZSB9LFxuICAgICAgICAgICAgJ3NhdmVJbnRlcm1lZGlhdGUnOiB7IHR5cGU6ICdib29sZWFuJywgZGVmYXVsdDogZmFsc2UgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5vcHRpb25zLm1vZGVsUGF0aCA9IG1vZGVsUGF0aDtcbiAgICAgICAgXG4gICAgICAgIGdlbWxQYXRoID0gdGhpcy5jb250YWluZXIudG9BYnNvbHV0ZVBhdGgoZ2VtbFBhdGgpOyAgICBcbiAgICAgICAgbW9kZWxQYXRoID0gdGhpcy5jb250YWluZXIudG9BYnNvbHV0ZVBhdGgobW9kZWxQYXRoKTtcbiAgICAgICAgc2NyaXB0UGF0aCA9IHRoaXMuY29udGFpbmVyLnRvQWJzb2x1dGVQYXRoKHNjcmlwdFBhdGgpO1xuICAgICAgICBtYW5pZmVzdFBhdGggPSB0aGlzLmNvbnRhaW5lci50b0Fic29sdXRlUGF0aChtYW5pZmVzdFBhdGgpO1xuICAgICAgICBcbiAgICAgICAgbGV0IGdlbWxDb25maWcgPSB7IFxuICAgICAgICAgICAgLi4uY29uZmlnLFxuICAgICAgICAgICAgZ2VtbFBhdGgsIFxuICAgICAgICAgICAgbW9kZWxQYXRoLCBcbiAgICAgICAgICAgIHNjcmlwdFBhdGgsXG4gICAgICAgICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICAgICAgc2F2ZUludGVybWVkaWF0ZSAgXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoZ2VtbENvbmZpZy5zY2hlbWFzKSkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgeyBsb2FkXzogdXNlRGIgfSA9IHJlcXVpcmUoJ0BnZW54L2FwcC9saWIvZmVhdHVyZXMvdXNlRGInKTtcbiAgICAgICAgICAgIGF3YWl0IHVzZURiKHRoaXMuY29udGFpbmVyLCBnZW1sQ29uZmlnLnNjaGVtYXMpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNtZE1ldGhvZF8gPSByZXF1aXJlKCcuL2NvbW1hbmRzLycgKyBjb21tYW5kKTsgICAgICAgIFxuICAgICAgICBhd2FpdCBjbWRNZXRob2RfKHRoaXMuY29udGFpbmVyLCBnZW1sQ29uZmlnKTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQXBwSW5pdGlhdG9yOyJdfQ==
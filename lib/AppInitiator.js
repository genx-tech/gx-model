"use strict";

require("source-map-support/register");

const path = require('path');

const {
  fs,
  _
} = require('rk-utils');

const {
  ServiceContainer
} = require('@genx/app');

const {
  Validators: {
    validateObjectBySchema
  }
} = require('@genx/data');

class AppInitiator {
  constructor(context) {
    this.app = context.app;
    this.cwd = context.cwd;
  }

  async run(command) {
    let configFile = this.app.commandLine.option('config') || 'geml.json';
    let configFullPath = path.resolve(this.cwd, configFile);

    if (!fs.existsSync(configFullPath)) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('GemlCore', {
      workingPath: this.cwd,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['configByHostname', 'devConfigByGitUser', 'appLogger', 'loggers', 'settings', 'timezone', 'version', 'dataSource', 'env']
    });
    this.container.replaceLogger(this.app.logger);
    await this.container.start_();
    this.app.on('stopping', stopper => {
      stopper.push((async () => {
        await this.container.stop_();
      })());
    });

    this.container.option = name => {
      return this.app.commandLine.option(name);
    };

    let config = this.container.settings.geml;

    if (_.isEmpty(config)) {
      throw new Error('Empty geml config!');
    }

    let {
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    } = validateObjectBySchema(config, {
      'gemlPath': {
        type: 'text',
        default: 'geml'
      },
      'modelPath': {
        type: 'text',
        default: 'src/models'
      },
      'scriptPath': {
        type: 'text',
        default: 'src/scripts'
      },
      'manifestPath': {
        type: 'text',
        default: 'manifest'
      },
      'useJsonSource': {
        type: 'boolean',
        default: false
      },
      'saveIntermediate': {
        type: 'boolean',
        default: false
      }
    });
    this.container.options.modelsPath = modelPath;
    gemlPath = this.container.toAbsolutePath(gemlPath);
    modelPath = this.container.toAbsolutePath(modelPath);
    scriptPath = this.container.toAbsolutePath(scriptPath);
    manifestPath = this.container.toAbsolutePath(manifestPath);
    let gemlConfig = { ...config,
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    };

    if (!_.isEmpty(gemlConfig.schemas)) {
      const {
        load_: useDb
      } = require('@genx/app/lib/features/useDb');

      await useDb(this.container, gemlConfig.schemas);
    }

    let cmdMethod_ = require('./commands/' + command);

    await cmdMethod_(this.container, gemlConfig);
  }

}

module.exports = AppInitiator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBJbml0aWF0b3IuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJmcyIsIl8iLCJTZXJ2aWNlQ29udGFpbmVyIiwiVmFsaWRhdG9ycyIsInZhbGlkYXRlT2JqZWN0QnlTY2hlbWEiLCJBcHBJbml0aWF0b3IiLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJhcHAiLCJjd2QiLCJydW4iLCJjb21tYW5kIiwiY29uZmlnRmlsZSIsImNvbW1hbmRMaW5lIiwib3B0aW9uIiwiY29uZmlnRnVsbFBhdGgiLCJyZXNvbHZlIiwiZXhpc3RzU3luYyIsIkVycm9yIiwiZXh0TmFtZSIsImV4dG5hbWUiLCJjb25maWdOYW1lIiwiYmFzZW5hbWUiLCJjb25maWdQYXRoIiwiZGlybmFtZSIsImVudkF3YXJlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJjb250YWluZXIiLCJ3b3JraW5nUGF0aCIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImFsbG93ZWRGZWF0dXJlcyIsInJlcGxhY2VMb2dnZXIiLCJsb2dnZXIiLCJzdGFydF8iLCJvbiIsInN0b3BwZXIiLCJwdXNoIiwic3RvcF8iLCJuYW1lIiwiY29uZmlnIiwic2V0dGluZ3MiLCJnZW1sIiwiaXNFbXB0eSIsImdlbWxQYXRoIiwibW9kZWxQYXRoIiwic2NyaXB0UGF0aCIsIm1hbmlmZXN0UGF0aCIsInVzZUpzb25Tb3VyY2UiLCJzYXZlSW50ZXJtZWRpYXRlIiwidHlwZSIsImRlZmF1bHQiLCJvcHRpb25zIiwibW9kZWxzUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiZ2VtbENvbmZpZyIsInNjaGVtYXMiLCJsb2FkXyIsInVzZURiIiwiY21kTWV0aG9kXyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsRUFBRjtBQUFNQyxFQUFBQTtBQUFOLElBQVlG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QUcsS0FBS2xCLFNBQUwsQ0FBZTBCLGNBQWYsQ0FBOEJSLFVBQTlCLENBQWI7QUFDQUMsSUFBQUEsWUFBWSxHQUFHLEtBQUtuQixTQUFMLENBQWUwQixjQUFmLENBQThCUCxZQUE5QixDQUFmO0FBRUEsUUFBSVEsVUFBVSxHQUFHLEVBQ2IsR0FBR2YsTUFEVTtBQUViSSxNQUFBQSxRQUZhO0FBR2JDLE1BQUFBLFNBSGE7QUFJYkMsTUFBQUEsVUFKYTtBQUtiQyxNQUFBQSxZQUxhO0FBTWJDLE1BQUFBLGFBTmE7QUFPYkMsTUFBQUE7QUFQYSxLQUFqQjs7QUFVQSxRQUFJLENBQUNqRCxDQUFDLENBQUMyQyxPQUFGLENBQVVZLFVBQVUsQ0FBQ0MsT0FBckIsQ0FBTCxFQUFvQztBQUNoQyxZQUFNO0FBQUVDLFFBQUFBLEtBQUssRUFBRUM7QUFBVCxVQUFtQjVELE9BQU8sQ0FBQyw4QkFBRCxDQUFoQzs7QUFDQSxZQUFNNEQsS0FBSyxDQUFDLEtBQUs5QixTQUFOLEVBQWlCMkIsVUFBVSxDQUFDQyxPQUE1QixDQUFYO0FBQ0g7O0FBRUQsUUFBSUcsVUFBVSxHQUFHN0QsT0FBTyxDQUFDLGdCQUFnQlksT0FBakIsQ0FBeEI7O0FBQ0EsVUFBTWlELFVBQVUsQ0FBQyxLQUFLL0IsU0FBTixFQUFpQjJCLFVBQWpCLENBQWhCO0FBQ0g7O0FBekdjOztBQTRHbkJLLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnpELFlBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgZnMsIF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IFNlcnZpY2VDb250YWluZXIgfSA9IHJlcXVpcmUoJ0BnZW54L2FwcCcpO1xuY29uc3QgeyBWYWxpZGF0b3JzOiB7IHZhbGlkYXRlT2JqZWN0QnlTY2hlbWEgfSB9ID0gcmVxdWlyZSgnQGdlbngvZGF0YScpXG5cbmNsYXNzIEFwcEluaXRpYXRvciB7XG4gICAgY29uc3RydWN0b3IoY29udGV4dCkge1xuICAgICAgICB0aGlzLmFwcCA9IGNvbnRleHQuYXBwO1xuICAgICAgICB0aGlzLmN3ZCA9IGNvbnRleHQuY3dkO1xuICAgIH1cblxuICAgIGFzeW5jIHJ1bihjb21tYW5kKSB7ICAgICAgICBcbiAgICAgICAgbGV0IGNvbmZpZ0ZpbGUgPSB0aGlzLmFwcC5jb21tYW5kTGluZS5vcHRpb24oJ2NvbmZpZycpIHx8ICdnZW1sLmpzb24nOyAgICAgICAgICAgICAgICBcbiAgICAgICAgbGV0IGNvbmZpZ0Z1bGxQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuY3dkLCBjb25maWdGaWxlKTtcblxuICAgICAgICBpZiAoIShmcy5leGlzdHNTeW5jKGNvbmZpZ0Z1bGxQYXRoKSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29uZmlnIFwiJHtjb25maWdGaWxlfVwiIG5vdCBmb3VuZCFgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBleHROYW1lID0gcGF0aC5leHRuYW1lKGNvbmZpZ0Z1bGxQYXRoKTtcbiAgICAgICAgaWYgKGV4dE5hbWUgIT09ICcuanNvbicpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignT25seSBzdXBwb3J0cyBKU09OIGNvbmZpZy4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb25maWdOYW1lID0gcGF0aC5iYXNlbmFtZShjb25maWdGdWxsUGF0aCwgZXh0TmFtZSk7XG4gICAgICAgIGxldCBjb25maWdQYXRoID0gcGF0aC5kaXJuYW1lKGNvbmZpZ0Z1bGxQYXRoKTtcbiAgICAgICAgbGV0IGVudkF3YXJlID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKGNvbmZpZ05hbWUuZW5kc1dpdGgoJy5kZWZhdWx0JykpIHtcbiAgICAgICAgICAgIGVudkF3YXJlID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbmZpZ05hbWUgPSBjb25maWdOYW1lLnN1YnN0cigwLCBjb25maWdOYW1lLmxlbmd0aCAtIDgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgU2VydmljZUNvbnRhaW5lcignR2VtbENvcmUnLCB7XG4gICAgICAgICAgICB3b3JraW5nUGF0aDogdGhpcy5jd2QsXG4gICAgICAgICAgICBjb25maWdQYXRoLFxuICAgICAgICAgICAgY29uZmlnTmFtZSwgICAgICAgICAgICBcbiAgICAgICAgICAgIGRpc2FibGVFbnZBd2FyZUNvbmZpZzogIWVudkF3YXJlLFxuICAgICAgICAgICAgYWxsb3dlZEZlYXR1cmVzOiBbXG4gICAgICAgICAgICAgICAgJ2NvbmZpZ0J5SG9zdG5hbWUnLCAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ2RldkNvbmZpZ0J5R2l0VXNlcicsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdhcHBMb2dnZXInLFxuICAgICAgICAgICAgICAgICdsb2dnZXJzJywgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnc2V0dGluZ3MnLFxuICAgICAgICAgICAgICAgICd0aW1lem9uZScsXG4gICAgICAgICAgICAgICAgJ3ZlcnNpb24nLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnZGF0YVNvdXJjZScsXG4gICAgICAgICAgICAgICAgJ2VudidcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5jb250YWluZXIucmVwbGFjZUxvZ2dlcih0aGlzLmFwcC5sb2dnZXIpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuY29udGFpbmVyLnN0YXJ0XygpO1xuXG4gICAgICAgIHRoaXMuYXBwLm9uKCdzdG9wcGluZycsIHN0b3BwZXIgPT4ge1xuICAgICAgICAgICAgc3RvcHBlci5wdXNoKChhc3luYyAoKSA9PiB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY29udGFpbmVyLnN0b3BfKCk7XG4gICAgICAgICAgICB9KSgpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5jb250YWluZXIub3B0aW9uID0gKG5hbWUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFwcC5jb21tYW5kTGluZS5vcHRpb24obmFtZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGNvbmZpZyA9IHRoaXMuY29udGFpbmVyLnNldHRpbmdzLmdlbWw7XG4gICAgICAgIGlmIChfLmlzRW1wdHkoY29uZmlnKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXB0eSBnZW1sIGNvbmZpZyEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB7IFxuICAgICAgICAgICAgZ2VtbFBhdGgsIFxuICAgICAgICAgICAgbW9kZWxQYXRoLCBcbiAgICAgICAgICAgIHNjcmlwdFBhdGgsXG4gICAgICAgICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICAgICAgc2F2ZUludGVybWVkaWF0ZSBcbiAgICAgICAgfSA9IHZhbGlkYXRlT2JqZWN0QnlTY2hlbWEoY29uZmlnLCB7XG4gICAgICAgICAgICAnZ2VtbFBhdGgnOiB7IHR5cGU6ICd0ZXh0JywgZGVmYXVsdDogJ2dlbWwnIH0sXG4gICAgICAgICAgICAnbW9kZWxQYXRoJzogeyB0eXBlOiAndGV4dCcsIGRlZmF1bHQ6ICdzcmMvbW9kZWxzJyB9LFxuICAgICAgICAgICAgJ3NjcmlwdFBhdGgnOiB7IHR5cGU6ICd0ZXh0JywgZGVmYXVsdDogJ3NyYy9zY3JpcHRzJyB9LFxuICAgICAgICAgICAgJ21hbmlmZXN0UGF0aCc6IHsgdHlwZTogJ3RleHQnLCBkZWZhdWx0OiAnbWFuaWZlc3QnIH0sXG4gICAgICAgICAgICAndXNlSnNvblNvdXJjZSc6IHsgdHlwZTogJ2Jvb2xlYW4nLCBkZWZhdWx0OiBmYWxzZSB9LFxuICAgICAgICAgICAgJ3NhdmVJbnRlcm1lZGlhdGUnOiB7IHR5cGU6ICdib29sZWFuJywgZGVmYXVsdDogZmFsc2UgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5vcHRpb25zLm1vZGVsc1BhdGggPSBtb2RlbFBhdGg7XG4gICAgICAgIFxuICAgICAgICBnZW1sUGF0aCA9IHRoaXMuY29udGFpbmVyLnRvQWJzb2x1dGVQYXRoKGdlbWxQYXRoKTsgICAgXG4gICAgICAgIG1vZGVsUGF0aCA9IHRoaXMuY29udGFpbmVyLnRvQWJzb2x1dGVQYXRoKG1vZGVsUGF0aCk7XG4gICAgICAgIHNjcmlwdFBhdGggPSB0aGlzLmNvbnRhaW5lci50b0Fic29sdXRlUGF0aChzY3JpcHRQYXRoKTtcbiAgICAgICAgbWFuaWZlc3RQYXRoID0gdGhpcy5jb250YWluZXIudG9BYnNvbHV0ZVBhdGgobWFuaWZlc3RQYXRoKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBnZW1sQ29uZmlnID0geyBcbiAgICAgICAgICAgIC4uLmNvbmZpZyxcbiAgICAgICAgICAgIGdlbWxQYXRoLCBcbiAgICAgICAgICAgIG1vZGVsUGF0aCwgXG4gICAgICAgICAgICBzY3JpcHRQYXRoLFxuICAgICAgICAgICAgbWFuaWZlc3RQYXRoLFxuICAgICAgICAgICAgdXNlSnNvblNvdXJjZSxcbiAgICAgICAgICAgIHNhdmVJbnRlcm1lZGlhdGUgIFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGdlbWxDb25maWcuc2NoZW1hcykpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHsgbG9hZF86IHVzZURiIH0gPSByZXF1aXJlKCdAZ2VueC9hcHAvbGliL2ZlYXR1cmVzL3VzZURiJyk7XG4gICAgICAgICAgICBhd2FpdCB1c2VEYih0aGlzLmNvbnRhaW5lciwgZ2VtbENvbmZpZy5zY2hlbWFzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjbWRNZXRob2RfID0gcmVxdWlyZSgnLi9jb21tYW5kcy8nICsgY29tbWFuZCk7ICAgICAgICBcbiAgICAgICAgYXdhaXQgY21kTWV0aG9kXyh0aGlzLmNvbnRhaW5lciwgZ2VtbENvbmZpZyk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEFwcEluaXRpYXRvcjtcblxuXG5cbi8qXG5leHBvcnRzLm1pZ3JhdGUgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgbWlncmF0ZScpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IG1vZGVsRGlyICA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLm1vZGVsRGlyJyk7XG4gICAgaWYgKCFtb2RlbERpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLm1vZGVsRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IGdlbWxTb3VyY2VEaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5nZW1sU291cmNlRGlyJyk7XG4gICAgaWYgKCFnZW1sU291cmNlRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZ2VtbFNvdXJjZURpclwiIG5vdCBmb3VuZCBpbiBvb2xvbmcgY29uZmlnLicpO1xuICAgIH1cblxuICAgIGxldCBzY3JpcHRTb3VyY2VEaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY3JpcHRTb3VyY2VEaXInKTtcbiAgICBpZiAoIXNjcmlwdFNvdXJjZURpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLnNjcmlwdFNvdXJjZURpclwiIG5vdCBmb3VuZCBpbiBvb2xvbmcgY29uZmlnLicpO1xuICAgIH1cblxuICAgIGxldCBtb2RlbFBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChtb2RlbERpcik7ICAgIFxuICAgIGxldCBkc2xTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoZ2VtbFNvdXJjZURpcik7ICAgIFxuICAgIGxldCBzY3JpcHRTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoc2NyaXB0U291cmNlRGlyKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2RlbFBhdGgpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgTW9kZWwgZGlyZWN0b3J5IFwiJHttb2RlbFBhdGh9XCIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkc2xTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERTTCBzb3VyY2UgZGlyZWN0b3J5IFwiJHtkc2xTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2NyaXB0U291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEYXRhYmFzZSBzY3JpcHRzIGRpcmVjdG9yeSBcIiR7c2NyaXB0U291cmNlUGF0aH1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgbGV0IHVzZUpzb25Tb3VyY2UgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy51c2VKc29uU291cmNlJywgZmFsc2UpO1xuXG4gICAgcmV0dXJuIGNvcmUuYXBpLm1pZ3JhdGVfKHtcbiAgICAgICAgYXBwTW9kdWxlOiBjb3JlLmNvbnRhaW5lcixcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIG1vZGVsUGF0aCxcbiAgICAgICAgZHNsU291cmNlUGF0aCwgICAgICAgIFxuICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLFxuICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiBjb3JlLnNjaGVtYURlcGxveW1lbnRcbiAgICB9LCBjb3JlLm9wdGlvbigncmVzZXQnKSk7XG59O1xuXG5leHBvcnRzLmRhdGFzZXQgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgZGF0YXNldCcpO1xuXG4gICAgbGV0IGRhdGFzZXQgPSBhd2FpdCBjb3JlLmdldERhdGFzZXRfKCk7XG4gICAgXG4gICAgY29yZS5hcHAubG9nKCdpbmZvJywgJ0F2YWlsYWJsZSBkYXRhc2V0OiBcXG4nICsgZGF0YXNldC5qb2luKCdcXG4nKSArICdcXG4nKTtcbn1cblxuZXhwb3J0cy5pbXBvcnQgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgaW1wb3J0Jyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgbW9kZWxEaXIgID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxEaXInKTtcbiAgICBpZiAoIW1vZGVsRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgc2NyaXB0U291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0U291cmNlRGlyJyk7XG4gICAgaWYgKCFzY3JpcHRTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5zY3JpcHRTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG4gICAgXG4gICAgbGV0IG1vZGVsUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1vZGVsRGlyKTsgICAgXG4gICAgbGV0IHNjcmlwdFNvdXJjZVBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChzY3JpcHRTb3VyY2VEaXIpO1xuXG4gICAgbGV0IHNjaGVtYSA9IGNvcmUub3B0aW9uKCdzY2hlbWEnKTsgICAgXG4gICAgbGV0IGRhdGFzZXQgPSBjb3JlLm9wdGlvbignZGF0YXNldCcpOyAgICBcblxuICAgIHJldHVybiBjb3JlLmFwaS5pbXBvcnRfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsICAgICAgICBcbiAgICAgICAgbW9kZWxQYXRoLFxuICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLCAgICAgICAgXG4gICAgICAgIHNjaGVtYURlcGxveW1lbnQ6IGNvcmUuc2NoZW1hRGVwbG95bWVudFxuICAgIH0sIHNjaGVtYSwgZGF0YXNldCk7XG59XG5cbmV4cG9ydHMucmV2ZXJzZSA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyByZXZlcnNlJyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgZHNsUmV2ZXJzZU91dHB1dERpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLmRzbFJldmVyc2VPdXRwdXREaXInKTtcbiAgICBpZiAoIWRzbFJldmVyc2VPdXRwdXREaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5kc2xSZXZlcnNlT3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG91dHB1dERpciA9IGNvcmUuZ2V0UmV2ZXJzZU91dHB1dERpcihjb3JlLmFwcC50b0Fic29sdXRlUGF0aChkc2xSZXZlcnNlT3V0cHV0RGlyKSk7XG5cbiAgICAvL3RvZG86IHJlbG9jYXRpb24sIGFuZCBkZWVwIGNvcHkgY29ubmVjdGlvbiBvcHRpb25zXG4gICAgbGV0IGNvbm4gPSBjb3JlLm9wdGlvbignY29ubicpO1xuICAgIGxldCBbIGRyaXZlciBdID0gZXh0cmFjdERyaXZlckFuZENvbm5lY3Rvck5hbWUoY29ubik7XG4gICAgbGV0IGNvbm5PcHRpb25zID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdkYXRhU291cmNlLicgKyBjb25uKTtcbiAgICBhc3NlcnQ6IGNvbm5PcHRpb25zOyAgICBcblxuICAgIGlmICh0eXBlb2YgY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPSByZXF1aXJlKGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcykpO1xuICAgIH0gXG5cbiAgICBhc3NlcnQ6ICFjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgfHwgXy5pc1BsYWluT2JqZWN0KGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyk7XG5cbiAgICByZXR1cm4gY29yZS5hcGkucmV2ZXJzZV8oeyBcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFJldmVyc2VPdXRwdXRQYXRoOiBvdXRwdXREaXIsXG4gICAgICAgIGRyaXZlcixcbiAgICAgICAgY29ubk9wdGlvbnNcbiAgICB9KTtcbn07XG5cbmV4cG9ydHMuZXhwb3J0ID0gYXN5bmMgKGNvcmUpID0+IHtcbiAgICBjb3JlLmFwcC5sb2coJ3ZlcmJvc2UnLCAnb29sb25nIHJldmVyc2UnKTtcblxuICAgIGxldCBvb2xvbmdDb25maWcgPSBjb3JlLm9vbG9uZ0NvbmZpZztcblxuICAgIGxldCBkYXRhRXhwb3J0RGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuZGF0YUV4cG9ydERpcicpO1xuICAgIGlmICghZGF0YUV4cG9ydERpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLmRhdGFFeHBvcnREaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgb3V0cHV0RGlyID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoZGF0YUV4cG9ydERpcik7XG5cbiAgICAvL3RvZG86IHJlbG9jYXRpb24sIGFuZCBkZWVwIGNvcHkgY29ubmVjdGlvbiBvcHRpb25zXG4gICAgbGV0IGNvbm4gPSBjb3JlLm9wdGlvbignY29ubicpO1xuICAgIGxldCBbIGRyaXZlciBdID0gZXh0cmFjdERyaXZlckFuZENvbm5lY3Rvck5hbWUoY29ubik7XG4gICAgbGV0IGNvbm5PcHRpb25zID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdkYXRhU291cmNlLicgKyBjb25uKTtcbiAgICBhc3NlcnQ6IGNvbm5PcHRpb25zOyAgICBcblxuICAgIGlmICh0eXBlb2YgY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPSByZXF1aXJlKGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcykpO1xuICAgIH0gXG5cbiAgICBhc3NlcnQ6ICFjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgfHwgXy5pc1BsYWluT2JqZWN0KGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyk7XG5cbiAgICByZXR1cm4gY29yZS5hcGkucmV2ZXJzZV8oeyBcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFJldmVyc2VPdXRwdXRQYXRoOiBvdXRwdXREaXIsXG4gICAgICAgIGRyaXZlcixcbiAgICAgICAgY29ubk9wdGlvbnNcbiAgICB9KTtcbn07XG5cbmV4cG9ydHMubGlzdFZhbGlkYXRvcnMgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgbGlzdFZhbGlkYXRvcnMnKTtcblxuICAgIGxldCBsaXN0ID0gY29yZS5hcGkuZ2V0VmFsaWRhdG9yTGlzdCgpO1xuXG4gICAgY29yZS5hcHAubG9nKCdpbmZvJywgJ0F2YWlsYWJsZSB2YWxpZGF0b3JzOiBcXG4nICsgbGlzdC5qb2luKCdcXG4nKSArICdcXG4nKTtcbn0qLyJdfQ==
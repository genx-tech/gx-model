"use strict";

require("source-map-support/register");

const path = require('path');

const {
  fs,
  _
} = require('rk-utils');

const {
  ServiceContainer
} = require('@genx/app');

const {
  Validators: {
    validateObjectBySchema
  }
} = require('@genx/data');

class AppInitiator {
  constructor(context) {
    this.app = context.app;
    this.cwd = context.cwd;
  }

  async run(command) {
    let configFile = this.app.commandLine.option('config') || 'geml.json';
    let configFullPath = path.resolve(this.cwd, configFile);

    if (!fs.existsSync(configFullPath)) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('GemlCore', {
      workingPath: this.cwd,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['configByHostname', 'devConfigByGitUser', 'appLogger', 'loggers', 'settings', 'timezone', 'version', 'dataSource']
    });
    this.container.replaceLogger(this.app.logger);
    await this.container.start_();
    let config = this.container.settings.geml;

    if (_.isEmpty(config)) {
      throw new Error('Empty geml config!');
    }

    let {
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    } = validateObjectBySchema(config, {
      'gemlPath': {
        type: 'text',
        default: 'geml'
      },
      'modelPath': {
        type: 'text',
        default: 'src/models'
      },
      'scriptPath': {
        type: 'text',
        default: 'src/scripts'
      },
      'manifestPath': {
        type: 'text',
        default: 'manifest'
      },
      'useJsonSource': {
        type: 'boolean',
        default: false
      },
      'saveIntermediate': {
        type: 'boolean',
        default: false
      }
    });
    gemlPath = this.container.toAbsolutePath(gemlPath);
    modelPath = this.container.toAbsolutePath(modelPath);
    scriptPath = this.container.toAbsolutePath(scriptPath);
    manifestPath = this.container.toAbsolutePath(manifestPath);
    let gemlConfig = { ...config,
      gemlPath,
      modelPath,
      scriptPath,
      manifestPath,
      useJsonSource,
      saveIntermediate
    };

    let cmdMethod_ = require('./commands/' + command);

    await cmdMethod_(this.container, gemlConfig);
  }

}

module.exports = AppInitiator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBJbml0aWF0b3IuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJmcyIsIl8iLCJTZXJ2aWNlQ29udGFpbmVyIiwiVmFsaWRhdG9ycyIsInZhbGlkYXRlT2JqZWN0QnlTY2hlbWEiLCJBcHBJbml0aWF0b3IiLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJhcHAiLCJjd2QiLCJydW4iLCJjb21tYW5kIiwiY29uZmlnRmlsZSIsImNvbW1hbmRMaW5lIiwib3B0aW9uIiwiY29uZmlnRnVsbFBhdGgiLCJyZXNvbHZlIiwiZXhpc3RzU3luYyIsIkVycm9yIiwiZXh0TmFtZSIsImV4dG5hbWUiLCJjb25maWdOYW1lIiwiYmFzZW5hbWUiLCJjb25maWdQYXRoIiwiZGlybmFtZSIsImVudkF3YXJlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJjb250YWluZXIiLCJ3b3JraW5nUGF0aCIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImFsbG93ZWRGZWF0dXJlcyIsInJlcGxhY2VMb2dnZXIiLCJsb2dnZXIiLCJzdGFydF8iLCJjb25maWciLCJzZXR0aW5ncyIsImdlbWwiLCJpc0VtcHR5IiwiZ2VtbFBhdGgiLCJtb2RlbFBhdGgiLCJzY3JpcHRQYXRoIiwibWFuaWZlc3RQYXRoIiwidXNlSnNvblNvdXJjZSIsInNhdmVJbnRlcm1lZGlhdGUiLCJ0eXBlIiwiZGVmYXVsdCIsInRvQWJzb2x1dGVQYXRoIiwiZ2VtbENvbmZpZyIsImNtZE1ldGhvZF8iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLEVBQUY7QUFBTUMsRUFBQUE7QUFBTixJQUFZRixPQUFPLENBQUMsVUFBRCxDQUF6Qjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBdUJILE9BQU8sQ0FBQyxXQUFELENBQXBDOztBQUNBLE1BQU07QUFBRUksRUFBQUEsVUFBVSxFQUFFO0FBQUVDLElBQUFBO0FBQUY7QUFBZCxJQUE2Q0wsT0FBTyxDQUFDLFlBQUQsQ0FBMUQ7O0FBRUEsTUFBTU0sWUFBTixDQUFtQjtBQUNmQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBVTtBQUNqQixTQUFLQyxHQUFMLEdBQVdELE9BQU8sQ0FBQ0MsR0FBbkI7QUFDQSxTQUFLQyxHQUFMLEdBQVdGLE9BQU8sQ0FBQ0UsR0FBbkI7QUFDSDs7QUFFRCxRQUFNQyxHQUFOLENBQVVDLE9BQVYsRUFBbUI7QUFDZixRQUFJQyxVQUFVLEdBQUcsS0FBS0osR0FBTCxDQUFTSyxXQUFULENBQXFCQyxNQUFyQixDQUE0QixRQUE1QixLQUF5QyxXQUExRDtBQUNBLFFBQUlDLGNBQWMsR0FBR2pCLElBQUksQ0FBQ2tCLE9BQUwsQ0FBYSxLQUFLUCxHQUFsQixFQUF1QkcsVUFBdkIsQ0FBckI7O0FBRUEsUUFBSSxDQUFFWixFQUFFLENBQUNpQixVQUFILENBQWNGLGNBQWQsQ0FBTixFQUFzQztBQUNsQyxZQUFNLElBQUlHLEtBQUosQ0FBVyxXQUFVTixVQUFXLGNBQWhDLENBQU47QUFDSDs7QUFFRCxRQUFJTyxPQUFPLEdBQUdyQixJQUFJLENBQUNzQixPQUFMLENBQWFMLGNBQWIsQ0FBZDs7QUFDQSxRQUFJSSxPQUFPLEtBQUssT0FBaEIsRUFBeUI7QUFDckIsWUFBTSxJQUFJRCxLQUFKLENBQVUsNEJBQVYsQ0FBTjtBQUNIOztBQUVELFFBQUlHLFVBQVUsR0FBR3ZCLElBQUksQ0FBQ3dCLFFBQUwsQ0FBY1AsY0FBZCxFQUE4QkksT0FBOUIsQ0FBakI7QUFDQSxRQUFJSSxVQUFVLEdBQUd6QixJQUFJLENBQUMwQixPQUFMLENBQWFULGNBQWIsQ0FBakI7QUFDQSxRQUFJVSxRQUFRLEdBQUcsS0FBZjs7QUFFQSxRQUFJSixVQUFVLENBQUNLLFFBQVgsQ0FBb0IsVUFBcEIsQ0FBSixFQUFxQztBQUNqQ0QsTUFBQUEsUUFBUSxHQUFHLElBQVg7QUFDQUosTUFBQUEsVUFBVSxHQUFHQSxVQUFVLENBQUNNLE1BQVgsQ0FBa0IsQ0FBbEIsRUFBcUJOLFVBQVUsQ0FBQ08sTUFBWCxHQUFvQixDQUF6QyxDQUFiO0FBQ0g7O0FBRUQsU0FBS0MsU0FBTCxHQUFpQixJQUFJM0IsZ0JBQUosQ0FBcUIsVUFBckIsRUFBaUM7QUFDOUM0QixNQUFBQSxXQUFXLEVBQUUsS0FBS3JCLEdBRDRCO0FBRTlDYyxNQUFBQSxVQUY4QztBQUc5Q0YsTUFBQUEsVUFIOEM7QUFJOUNVLE1BQUFBLHFCQUFxQixFQUFFLENBQUNOLFFBSnNCO0FBSzlDTyxNQUFBQSxlQUFlLEVBQUUsQ0FDYixrQkFEYSxFQUViLG9CQUZhLEVBR2IsV0FIYSxFQUliLFNBSmEsRUFLYixVQUxhLEVBTWIsVUFOYSxFQU9iLFNBUGEsRUFRYixZQVJhO0FBTDZCLEtBQWpDLENBQWpCO0FBaUJBLFNBQUtILFNBQUwsQ0FBZUksYUFBZixDQUE2QixLQUFLekIsR0FBTCxDQUFTMEIsTUFBdEM7QUFFQSxVQUFNLEtBQUtMLFNBQUwsQ0FBZU0sTUFBZixFQUFOO0FBRUEsUUFBSUMsTUFBTSxHQUFHLEtBQUtQLFNBQUwsQ0FBZVEsUUFBZixDQUF3QkMsSUFBckM7O0FBQ0EsUUFBSXJDLENBQUMsQ0FBQ3NDLE9BQUYsQ0FBVUgsTUFBVixDQUFKLEVBQXVCO0FBQ25CLFlBQU0sSUFBSWxCLEtBQUosQ0FBVSxvQkFBVixDQUFOO0FBQ0g7O0FBRUQsUUFBSTtBQUNBc0IsTUFBQUEsUUFEQTtBQUVBQyxNQUFBQSxTQUZBO0FBR0FDLE1BQUFBLFVBSEE7QUFJQUMsTUFBQUEsWUFKQTtBQUtBQyxNQUFBQSxhQUxBO0FBTUFDLE1BQUFBO0FBTkEsUUFPQXpDLHNCQUFzQixDQUFDZ0MsTUFBRCxFQUFTO0FBQy9CLGtCQUFZO0FBQUVVLFFBQUFBLElBQUksRUFBRSxNQUFSO0FBQWdCQyxRQUFBQSxPQUFPLEVBQUU7QUFBekIsT0FEbUI7QUFFL0IsbUJBQWE7QUFBRUQsUUFBQUEsSUFBSSxFQUFFLE1BQVI7QUFBZ0JDLFFBQUFBLE9BQU8sRUFBRTtBQUF6QixPQUZrQjtBQUcvQixvQkFBYztBQUFFRCxRQUFBQSxJQUFJLEVBQUUsTUFBUjtBQUFnQkMsUUFBQUEsT0FBTyxFQUFFO0FBQXpCLE9BSGlCO0FBSS9CLHNCQUFnQjtBQUFFRCxRQUFBQSxJQUFJLEVBQUUsTUFBUjtBQUFnQkMsUUFBQUEsT0FBTyxFQUFFO0FBQXpCLE9BSmU7QUFLL0IsdUJBQWlCO0FBQUVELFFBQUFBLElBQUksRUFBRSxTQUFSO0FBQW1CQyxRQUFBQSxPQUFPLEVBQUU7QUFBNUIsT0FMYztBQU0vQiwwQkFBb0I7QUFBRUQsUUFBQUEsSUFBSSxFQUFFLFNBQVI7QUFBbUJDLFFBQUFBLE9BQU8sRUFBRTtBQUE1QjtBQU5XLEtBQVQsQ0FQMUI7QUFnQkFQLElBQUFBLFFBQVEsR0FBRyxLQUFLWCxTQUFMLENBQWVtQixjQUFmLENBQThCUixRQUE5QixDQUFYO0FBQ0FDLElBQUFBLFNBQVMsR0FBRyxLQUFLWixTQUFMLENBQWVtQixjQUFmLENBQThCUCxTQUE5QixDQUFaO0FBQ0FDLElBQUFBLFVBQVUsR0FBRyxLQUFLYixTQUFMLENBQWVtQixjQUFmLENBQThCTixVQUE5QixDQUFiO0FBQ0FDLElBQUFBLFlBQVksR0FBRyxLQUFLZCxTQUFMLENBQWVtQixjQUFmLENBQThCTCxZQUE5QixDQUFmO0FBRUEsUUFBSU0sVUFBVSxHQUFHLEVBQ2IsR0FBR2IsTUFEVTtBQUViSSxNQUFBQSxRQUZhO0FBR2JDLE1BQUFBLFNBSGE7QUFJYkMsTUFBQUEsVUFKYTtBQUtiQyxNQUFBQSxZQUxhO0FBTWJDLE1BQUFBLGFBTmE7QUFPYkMsTUFBQUE7QUFQYSxLQUFqQjs7QUFVQSxRQUFJSyxVQUFVLEdBQUduRCxPQUFPLENBQUMsZ0JBQWdCWSxPQUFqQixDQUF4Qjs7QUFDQSxVQUFNdUMsVUFBVSxDQUFDLEtBQUtyQixTQUFOLEVBQWlCb0IsVUFBakIsQ0FBaEI7QUFDSDs7QUF2RmM7O0FBMEZuQkUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCL0MsWUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBmcywgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgU2VydmljZUNvbnRhaW5lciB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5jb25zdCB7IFZhbGlkYXRvcnM6IHsgdmFsaWRhdGVPYmplY3RCeVNjaGVtYSB9IH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJylcblxuY2xhc3MgQXBwSW5pdGlhdG9yIHtcbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7XG4gICAgICAgIHRoaXMuYXBwID0gY29udGV4dC5hcHA7XG4gICAgICAgIHRoaXMuY3dkID0gY29udGV4dC5jd2Q7XG4gICAgfVxuXG4gICAgYXN5bmMgcnVuKGNvbW1hbmQpIHsgICAgICAgIFxuICAgICAgICBsZXQgY29uZmlnRmlsZSA9IHRoaXMuYXBwLmNvbW1hbmRMaW5lLm9wdGlvbignY29uZmlnJykgfHwgJ2dlbWwuanNvbic7ICAgICAgICAgICAgICAgIFxuICAgICAgICBsZXQgY29uZmlnRnVsbFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5jd2QsIGNvbmZpZ0ZpbGUpO1xuXG4gICAgICAgIGlmICghKGZzLmV4aXN0c1N5bmMoY29uZmlnRnVsbFBhdGgpKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgXCIke2NvbmZpZ0ZpbGV9XCIgbm90IGZvdW5kIWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV4dE5hbWUgPSBwYXRoLmV4dG5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBpZiAoZXh0TmFtZSAhPT0gJy5qc29uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IHN1cHBvcnRzIEpTT04gY29uZmlnLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbmZpZ05hbWUgPSBwYXRoLmJhc2VuYW1lKGNvbmZpZ0Z1bGxQYXRoLCBleHROYW1lKTtcbiAgICAgICAgbGV0IGNvbmZpZ1BhdGggPSBwYXRoLmRpcm5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBsZXQgZW52QXdhcmUgPSBmYWxzZTtcblxuICAgICAgICBpZiAoY29uZmlnTmFtZS5lbmRzV2l0aCgnLmRlZmF1bHQnKSkge1xuICAgICAgICAgICAgZW52QXdhcmUgPSB0cnVlO1xuICAgICAgICAgICAgY29uZmlnTmFtZSA9IGNvbmZpZ05hbWUuc3Vic3RyKDAsIGNvbmZpZ05hbWUubGVuZ3RoIC0gOCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyBTZXJ2aWNlQ29udGFpbmVyKCdHZW1sQ29yZScsIHtcbiAgICAgICAgICAgIHdvcmtpbmdQYXRoOiB0aGlzLmN3ZCxcbiAgICAgICAgICAgIGNvbmZpZ1BhdGgsXG4gICAgICAgICAgICBjb25maWdOYW1lLCAgICAgICAgICAgIFxuICAgICAgICAgICAgZGlzYWJsZUVudkF3YXJlQ29uZmlnOiAhZW52QXdhcmUsXG4gICAgICAgICAgICBhbGxvd2VkRmVhdHVyZXM6IFtcbiAgICAgICAgICAgICAgICAnY29uZmlnQnlIb3N0bmFtZScsICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnZGV2Q29uZmlnQnlHaXRVc2VyJywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ2FwcExvZ2dlcicsXG4gICAgICAgICAgICAgICAgJ2xvZ2dlcnMnLCAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdzZXR0aW5ncycsXG4gICAgICAgICAgICAgICAgJ3RpbWV6b25lJyxcbiAgICAgICAgICAgICAgICAndmVyc2lvbicsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdkYXRhU291cmNlJ1xuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5yZXBsYWNlTG9nZ2VyKHRoaXMuYXBwLmxvZ2dlcik7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5jb250YWluZXIuc3RhcnRfKCk7XG5cbiAgICAgICAgbGV0IGNvbmZpZyA9IHRoaXMuY29udGFpbmVyLnNldHRpbmdzLmdlbWw7XG4gICAgICAgIGlmIChfLmlzRW1wdHkoY29uZmlnKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXB0eSBnZW1sIGNvbmZpZyEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB7IFxuICAgICAgICAgICAgZ2VtbFBhdGgsIFxuICAgICAgICAgICAgbW9kZWxQYXRoLCBcbiAgICAgICAgICAgIHNjcmlwdFBhdGgsXG4gICAgICAgICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICAgICAgc2F2ZUludGVybWVkaWF0ZSBcbiAgICAgICAgfSA9IHZhbGlkYXRlT2JqZWN0QnlTY2hlbWEoY29uZmlnLCB7XG4gICAgICAgICAgICAnZ2VtbFBhdGgnOiB7IHR5cGU6ICd0ZXh0JywgZGVmYXVsdDogJ2dlbWwnIH0sXG4gICAgICAgICAgICAnbW9kZWxQYXRoJzogeyB0eXBlOiAndGV4dCcsIGRlZmF1bHQ6ICdzcmMvbW9kZWxzJyB9LFxuICAgICAgICAgICAgJ3NjcmlwdFBhdGgnOiB7IHR5cGU6ICd0ZXh0JywgZGVmYXVsdDogJ3NyYy9zY3JpcHRzJyB9LFxuICAgICAgICAgICAgJ21hbmlmZXN0UGF0aCc6IHsgdHlwZTogJ3RleHQnLCBkZWZhdWx0OiAnbWFuaWZlc3QnIH0sXG4gICAgICAgICAgICAndXNlSnNvblNvdXJjZSc6IHsgdHlwZTogJ2Jvb2xlYW4nLCBkZWZhdWx0OiBmYWxzZSB9LFxuICAgICAgICAgICAgJ3NhdmVJbnRlcm1lZGlhdGUnOiB7IHR5cGU6ICdib29sZWFuJywgZGVmYXVsdDogZmFsc2UgfVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGdlbWxQYXRoID0gdGhpcy5jb250YWluZXIudG9BYnNvbHV0ZVBhdGgoZ2VtbFBhdGgpOyAgICBcbiAgICAgICAgbW9kZWxQYXRoID0gdGhpcy5jb250YWluZXIudG9BYnNvbHV0ZVBhdGgobW9kZWxQYXRoKTtcbiAgICAgICAgc2NyaXB0UGF0aCA9IHRoaXMuY29udGFpbmVyLnRvQWJzb2x1dGVQYXRoKHNjcmlwdFBhdGgpO1xuICAgICAgICBtYW5pZmVzdFBhdGggPSB0aGlzLmNvbnRhaW5lci50b0Fic29sdXRlUGF0aChtYW5pZmVzdFBhdGgpO1xuICAgICAgICBcbiAgICAgICAgbGV0IGdlbWxDb25maWcgPSB7IFxuICAgICAgICAgICAgLi4uY29uZmlnLFxuICAgICAgICAgICAgZ2VtbFBhdGgsIFxuICAgICAgICAgICAgbW9kZWxQYXRoLCBcbiAgICAgICAgICAgIHNjcmlwdFBhdGgsXG4gICAgICAgICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICAgICAgc2F2ZUludGVybWVkaWF0ZSAgXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGNtZE1ldGhvZF8gPSByZXF1aXJlKCcuL2NvbW1hbmRzLycgKyBjb21tYW5kKTsgICAgICAgIFxuICAgICAgICBhd2FpdCBjbWRNZXRob2RfKHRoaXMuY29udGFpbmVyLCBnZW1sQ29uZmlnKTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQXBwSW5pdGlhdG9yO1xuXG5cblxuLypcbmV4cG9ydHMubWlncmF0ZSA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBtaWdyYXRlJyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgbW9kZWxEaXIgID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxEaXInKTtcbiAgICBpZiAoIW1vZGVsRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgZ2VtbFNvdXJjZURpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLmdlbWxTb3VyY2VEaXInKTtcbiAgICBpZiAoIWdlbWxTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5nZW1sU291cmNlRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IHNjcmlwdFNvdXJjZURpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnNjcmlwdFNvdXJjZURpcicpO1xuICAgIGlmICghc2NyaXB0U291cmNlRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuc2NyaXB0U291cmNlRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG1vZGVsUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1vZGVsRGlyKTsgICAgXG4gICAgbGV0IGRzbFNvdXJjZVBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChnZW1sU291cmNlRGlyKTsgICAgXG4gICAgbGV0IHNjcmlwdFNvdXJjZVBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChzY3JpcHRTb3VyY2VEaXIpO1xuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKG1vZGVsUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBNb2RlbCBkaXJlY3RvcnkgXCIke21vZGVsUGF0aH1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGRzbFNvdXJjZVBhdGgpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgRFNMIHNvdXJjZSBkaXJlY3RvcnkgXCIke2RzbFNvdXJjZVBhdGh9XCIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhzY3JpcHRTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERhdGFiYXNlIHNjcmlwdHMgZGlyZWN0b3J5IFwiJHtzY3JpcHRTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBsZXQgdXNlSnNvblNvdXJjZSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnVzZUpzb25Tb3VyY2UnLCBmYWxzZSk7XG5cbiAgICByZXR1cm4gY29yZS5hcGkubWlncmF0ZV8oe1xuICAgICAgICBhcHBNb2R1bGU6IGNvcmUuY29udGFpbmVyLFxuICAgICAgICBsb2dnZXI6IGNvcmUuYXBwLmxvZ2dlcixcbiAgICAgICAgbW9kZWxQYXRoLFxuICAgICAgICBkc2xTb3VyY2VQYXRoLCAgICAgICAgXG4gICAgICAgIHNjcmlwdFNvdXJjZVBhdGgsXG4gICAgICAgIHVzZUpzb25Tb3VyY2UsXG4gICAgICAgIHNjaGVtYURlcGxveW1lbnQ6IGNvcmUuc2NoZW1hRGVwbG95bWVudFxuICAgIH0sIGNvcmUub3B0aW9uKCdyZXNldCcpKTtcbn07XG5cbmV4cG9ydHMuZGF0YXNldCA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBkYXRhc2V0Jyk7XG5cbiAgICBsZXQgZGF0YXNldCA9IGF3YWl0IGNvcmUuZ2V0RGF0YXNldF8oKTtcbiAgICBcbiAgICBjb3JlLmFwcC5sb2coJ2luZm8nLCAnQXZhaWxhYmxlIGRhdGFzZXQ6IFxcbicgKyBkYXRhc2V0LmpvaW4oJ1xcbicpICsgJ1xcbicpO1xufVxuXG5leHBvcnRzLmltcG9ydCA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBpbXBvcnQnKTtcblxuICAgIGxldCBvb2xvbmdDb25maWcgPSBjb3JlLm9vbG9uZ0NvbmZpZztcblxuICAgIGxldCBtb2RlbERpciAgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5tb2RlbERpcicpO1xuICAgIGlmICghbW9kZWxEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5tb2RlbERpclwiIG5vdCBmb3VuZCBpbiBvb2xvbmcgY29uZmlnLicpO1xuICAgIH1cblxuICAgIGxldCBzY3JpcHRTb3VyY2VEaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY3JpcHRTb3VyY2VEaXInKTtcbiAgICBpZiAoIXNjcmlwdFNvdXJjZURpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLnNjcmlwdFNvdXJjZURpclwiIG5vdCBmb3VuZCBpbiBvb2xvbmcgY29uZmlnLicpO1xuICAgIH1cbiAgICBcbiAgICBsZXQgbW9kZWxQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgobW9kZWxEaXIpOyAgICBcbiAgICBsZXQgc2NyaXB0U291cmNlUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKHNjcmlwdFNvdXJjZURpcik7XG5cbiAgICBsZXQgc2NoZW1hID0gY29yZS5vcHRpb24oJ3NjaGVtYScpOyAgICBcbiAgICBsZXQgZGF0YXNldCA9IGNvcmUub3B0aW9uKCdkYXRhc2V0Jyk7ICAgIFxuXG4gICAgcmV0dXJuIGNvcmUuYXBpLmltcG9ydF8oe1xuICAgICAgICBsb2dnZXI6IGNvcmUuYXBwLmxvZ2dlciwgICAgICAgIFxuICAgICAgICBtb2RlbFBhdGgsXG4gICAgICAgIHNjcmlwdFNvdXJjZVBhdGgsICAgICAgICBcbiAgICAgICAgc2NoZW1hRGVwbG95bWVudDogY29yZS5zY2hlbWFEZXBsb3ltZW50XG4gICAgfSwgc2NoZW1hLCBkYXRhc2V0KTtcbn1cblxuZXhwb3J0cy5yZXZlcnNlID0gYXN5bmMgKGNvcmUpID0+IHtcbiAgICBjb3JlLmFwcC5sb2coJ3ZlcmJvc2UnLCAnb29sb25nIHJldmVyc2UnKTtcblxuICAgIGxldCBvb2xvbmdDb25maWcgPSBjb3JlLm9vbG9uZ0NvbmZpZztcblxuICAgIGxldCBkc2xSZXZlcnNlT3V0cHV0RGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuZHNsUmV2ZXJzZU91dHB1dERpcicpO1xuICAgIGlmICghZHNsUmV2ZXJzZU91dHB1dERpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLmRzbFJldmVyc2VPdXRwdXREaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgb3V0cHV0RGlyID0gY29yZS5nZXRSZXZlcnNlT3V0cHV0RGlyKGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGRzbFJldmVyc2VPdXRwdXREaXIpKTtcblxuICAgIC8vdG9kbzogcmVsb2NhdGlvbiwgYW5kIGRlZXAgY29weSBjb25uZWN0aW9uIG9wdGlvbnNcbiAgICBsZXQgY29ubiA9IGNvcmUub3B0aW9uKCdjb25uJyk7XG4gICAgbGV0IFsgZHJpdmVyIF0gPSBleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZShjb25uKTtcbiAgICBsZXQgY29ubk9wdGlvbnMgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ2RhdGFTb3VyY2UuJyArIGNvbm4pO1xuICAgIGFzc2VydDogY29ubk9wdGlvbnM7ICAgIFxuXG4gICAgaWYgKHR5cGVvZiBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyA9IHJlcXVpcmUoY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzKSk7XG4gICAgfSBcblxuICAgIGFzc2VydDogIWNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyB8fCBfLmlzUGxhaW5PYmplY3QoY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzKTtcblxuICAgIHJldHVybiBjb3JlLmFwaS5yZXZlcnNlXyh7IFxuICAgICAgICBsb2dnZXI6IGNvcmUuYXBwLmxvZ2dlcixcbiAgICAgICAgZHNsUmV2ZXJzZU91dHB1dFBhdGg6IG91dHB1dERpcixcbiAgICAgICAgZHJpdmVyLFxuICAgICAgICBjb25uT3B0aW9uc1xuICAgIH0pO1xufTtcblxuZXhwb3J0cy5leHBvcnQgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgcmV2ZXJzZScpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IGRhdGFFeHBvcnREaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5kYXRhRXhwb3J0RGlyJyk7XG4gICAgaWYgKCFkYXRhRXhwb3J0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZGF0YUV4cG9ydERpclwiIG5vdCBmb3VuZCBpbiBvb2xvbmcgY29uZmlnLicpO1xuICAgIH1cblxuICAgIGxldCBvdXRwdXREaXIgPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChkYXRhRXhwb3J0RGlyKTtcblxuICAgIC8vdG9kbzogcmVsb2NhdGlvbiwgYW5kIGRlZXAgY29weSBjb25uZWN0aW9uIG9wdGlvbnNcbiAgICBsZXQgY29ubiA9IGNvcmUub3B0aW9uKCdjb25uJyk7XG4gICAgbGV0IFsgZHJpdmVyIF0gPSBleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZShjb25uKTtcbiAgICBsZXQgY29ubk9wdGlvbnMgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ2RhdGFTb3VyY2UuJyArIGNvbm4pO1xuICAgIGFzc2VydDogY29ubk9wdGlvbnM7ICAgIFxuXG4gICAgaWYgKHR5cGVvZiBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyA9IHJlcXVpcmUoY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzKSk7XG4gICAgfSBcblxuICAgIGFzc2VydDogIWNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyB8fCBfLmlzUGxhaW5PYmplY3QoY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzKTtcblxuICAgIHJldHVybiBjb3JlLmFwaS5yZXZlcnNlXyh7IFxuICAgICAgICBsb2dnZXI6IGNvcmUuYXBwLmxvZ2dlcixcbiAgICAgICAgZHNsUmV2ZXJzZU91dHB1dFBhdGg6IG91dHB1dERpcixcbiAgICAgICAgZHJpdmVyLFxuICAgICAgICBjb25uT3B0aW9uc1xuICAgIH0pO1xufTtcblxuZXhwb3J0cy5saXN0VmFsaWRhdG9ycyA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBsaXN0VmFsaWRhdG9ycycpO1xuXG4gICAgbGV0IGxpc3QgPSBjb3JlLmFwaS5nZXRWYWxpZGF0b3JMaXN0KCk7XG5cbiAgICBjb3JlLmFwcC5sb2coJ2luZm8nLCAnQXZhaWxhYmxlIHZhbGlkYXRvcnM6IFxcbicgKyBsaXN0LmpvaW4oJ1xcbicpICsgJ1xcbicpO1xufSovIl19